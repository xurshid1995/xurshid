{% extends "base.html" %}

{% block title %}Transfer - Dokon Boshqaruv Tizimi{% endblock %}

{% block extra_css %}
<style>
    /* Transfer sahifasi stillari */
    .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .btn-success {
        background-color: #28a745;
        border-color: #28a745;
    }
    
    .btn-success:hover {
        background-color: #218838;
        border-color: #1e7e34;
    }
    
    .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .transfer-list-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .transfer-list-table th,
    .transfer-list-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
    }
    
    .transfer-list-table th {
        font-weight: 600;
        white-space: nowrap;
    }
    
    .transfer-list-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .btn-sm {
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        margin-right: 5px;
    }
    
    .btn-success-sm {
        background-color: #28a745;
        color: white;
    }
    
    .btn-danger-sm {
        background-color: #dc3545;
        color: white;
    }
    
    .btn-success-sm:hover {
        background-color: #218838;
    }
    
    .btn-danger-sm:hover {
        background-color: #c82333;
    }
    
    @media (max-width: 768px) {
        .transfer-list-table {
            font-size: 12px;
        }
        
        .transfer-list-table th,
        .transfer-list-table td {
            padding: 8px 4px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <h1>üîÑ Transfer Sahifasi</h1>
    <a href="{{ url_for('transfer_old') }}?new=true" class="btn btn-success">
        <i class="fas fa-exchange-alt"></i> Yangi Transfer
    </a>
</div>

<!-- Tasdiqlanmagan Transferlar -->
<div class="card" style="margin-bottom: 20px;">
    <div class="card-body" style="padding: 15px;">
        <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #333;">‚è≥ Tasdiqlanmagan Transferlar</h3>
        <div style="overflow-x: auto;">
            <table class="table transfer-list-table" id="pendingTransfersTable">
                <thead>
                    <tr>
                        <th style="color: white; background: #5DADE2;">Qayerdan</th>
                        <th style="color: white; background: #5DADE2;">Qayerga</th>
                        <th style="color: white; background: #5DADE2;">Yaratilgan vaqti</th>
                        <th style="color: white; background: #5DADE2;">Nechta mahsulot</th>
                        <th style="color: white; background: #5DADE2;">Foydalanuvchi</th>
                        <th style="color: white; background: #5DADE2;">Amallar</th>
                    </tr>
                </thead>
                <tbody id="pendingTransfersBody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                            üì≠ Tasdiqlanmagan transferlar yo'q
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Transfer Tarixi -->
<div class="card">
    <div class="card-body" style="padding: 15px;">
        <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #333;">üìã Transfer Tarixi</h3>
        <div style="margin-bottom: 15px;">
            <input type="text" id="historySearch" class="form-control" placeholder="üîç Transfer tarixidan qidirish..." style="padding: 10px; border: 2px solid #ddd; border-radius: 4px;">
        </div>
        <div style="overflow-x: auto;">
            <table class="table transfer-list-table" id="transferHistoryTable">
                <thead>
                    <tr>
                        <th style="color: white; background: #5DADE2;">Sana</th>
                        <th style="color: white; background: #5DADE2;">Qayerdan</th>
                        <th style="color: white; background: #5DADE2;">Qayerga</th>
                        <th style="color: white; background: #5DADE2;">Mahsulotlar</th>
                        <th style="color: white; background: #5DADE2;">Miqdor</th>
                        <th style="color: white; background: #5DADE2;">Foydalanuvchi</th>
                    </tr>
                </thead>
                <tbody id="transferHistoryBody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                            ‚è≥ Yuklanmoqda...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Session ma'lumotlari
    const userRole = '{{ session.get("role", "") }}';
    const userTransferLocations = {{ session.get("transfer_locations", []) | tojson }};
    const userAllowedLocations = {{ session.get("allowed_locations", []) | tojson }};
    
    // User'ning ruxsati bor joylashuvlarni olish
    const userLocations = userTransferLocations.length > 0 ? userTransferLocations : userAllowedLocations;
    
    // Pending transfer uchun ruxsat tekshirish
    function canManageTransfer(fromLocationType, fromLocationId, toLocationType, toLocationId) {
        // Admin barcha transferlarni boshqarishi mumkin
        if (userRole === 'admin') {
            return true;
        }
        
        // Agar joylashuvlar bo'sh bo'lsa - ruxsat yo'q
        if (!userLocations || userLocations.length === 0) {
            return false;
        }
        
        // FROM yoki TO location da ruxsat borligini tekshirish
        for (let loc of userLocations) {
            // Yangi format: {id: 1, type: 'warehouse'}
            if (typeof loc === 'object') {
                if ((loc.id === fromLocationId && loc.type === fromLocationType) ||
                    (loc.id === toLocationId && loc.type === toLocationType)) {
                    return true;
                }
            }
            // Eski format: integer id
            else if (typeof loc === 'number') {
                if (loc === fromLocationId || loc === toLocationId) {
                    return true;
                }
            }
        }
        
        return false;
    }
    
    // Tasdiqlanmagan transferlarni yuklash
    async function loadPendingTransfers() {
        try {
            const response = await fetch('/api/all-pending-transfers');
            const data = await response.json();
            
            const tbody = document.getElementById('pendingTransfersBody');
            
            if (data.pending_transfers && data.pending_transfers.length > 0) {
                tbody.innerHTML = data.pending_transfers.map(pending => {
                    const createdDate = new Date(pending.created_at);
                    const formattedDate = createdDate.toLocaleString('uz-UZ', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const productCount = pending.items.length;
                    
                    // Location ID larni olish
                    const fromLocationId = pending.from_location_id;
                    const fromLocationType = pending.from_location_type;
                    const toLocationId = pending.to_location_id;
                    const toLocationType = pending.to_location_type;
                    
                    // Ruxsat tekshirish
                    const hasPermission = canManageTransfer(fromLocationType, fromLocationId, toLocationType, toLocationId);
                    
                    // Tugmalar
                    let actionButtons = '';
                    if (hasPermission) {
                        actionButtons = `
                            <a href="/transfer_old?id=${pending.id}" 
                               class="btn-sm btn-success-sm">
                                ‚úèÔ∏è Tahrirlash
                            </a>
                            <button class="btn-sm btn-danger-sm" 
                                    onclick="deletePendingTransfer(${pending.id}); return false;" 
                                    style="margin-left: 5px;">
                                üóëÔ∏è O'chirish
                            </button>
                        `;
                    } else {
                        actionButtons = `
                            <span style="color: #999; font-size: 0.9em;">üîí Ruxsat yo'q</span>
                        `;
                    }
                    
                    return `
                        <tr>
                            <td>${pending.from_location}</td>
                            <td>${pending.to_location}</td>
                            <td style="white-space: nowrap;">${formattedDate}</td>
                            <td style="text-align: center;">
                                <span style="background: #007bff; color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600;">${productCount}</span>
                            </td>
                            <td>${pending.user_name}</td>
                            <td>
                                ${actionButtons}
                            </td>
                        </tr>
                    `;
                }).join('');
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                            üì≠ Tasdiqlanmagan transferlar yo'q
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Tasdiqlanmagan transferlarni yuklashda xatolik:', error);
        }
    }
    
    // Pending transferni o'chirish
    async function deletePendingTransfer(pendingId) {
        if (!confirm('Bu transferni o\'chirmoqchimisiz?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/pending-transfer/${pendingId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                alert('‚úÖ Transfer o\'chirildi');
                await loadPendingTransfers(); // Jadvalni yangilash
            } else {
                // Xatolik xabarini olish
                const errorData = await response.json().catch(() => ({}));
                const errorMsg = errorData.error || 'Transferni o\'chirishda xatolik';
                
                // Permission xatoligi uchun aniq xabar
                if (response.status === 403) {
                    alert('‚ùå Sizga bu transferni o\'chirish uchun ruxsat yo\'q');
                } else {
                    alert('‚ùå ' + errorMsg);
                }
            }
        } catch (error) {
            console.error('Transferni o\'chirishda xatolik:', error);
            alert('‚ùå Transferni o\'chirishda xatolik');
        }
    }
    
    // Transfer tarixini yuklash
    async function loadTransferHistory() {
        try {
            const response = await fetch('/api/transfer-history');
            const data = await response.json();
            
            const tbody = document.getElementById('transferHistoryBody');
            
            if (data.transfers && data.transfers.length > 0) {
                tbody.innerHTML = data.transfers.map(transfer => {
                    const date = new Date(transfer.created_at);
                    const formattedDate = date.toLocaleString('uz-UZ', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const products = transfer.products.map(p => p.name).join('<br>');
                    const quantities = transfer.products.map(p => p.quantity).join('<br>');
                    
                    return `
                        <tr>
                            <td style="white-space: nowrap;">${formattedDate}</td>
                            <td>${transfer.from_location}</td>
                            <td>${transfer.to_location}</td>
                            <td>${products}</td>
                            <td>${quantities}</td>
                            <td>${transfer.user_name}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                            üì≠ Transfer tarixi bo'sh
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Transfer tarixini yuklashda xatolik:', error);
            document.getElementById('transferHistoryBody').innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px; color: #dc3545;">
                        ‚ùå Xatolik yuz berdi
                    </td>
                </tr>
            `;
        }
    }
    
    // Qidiruv funksiyasi - qisman so'zlar bilan
    document.getElementById('historySearch')?.addEventListener('input', function(e) {
        const searchText = e.target.value.toLowerCase().trim();
        const rows = document.querySelectorAll('#transferHistoryTable tbody tr');
        
        if (!searchText) {
            // Qidiruv bo'sh bo'lsa, barcha qatorlarni ko'rsatish
            rows.forEach(row => row.style.display = '');
            return;
        }
        
        // Qidiruv so'zlarini bo'laklarga ajratish
        const searchWords = searchText.split(/\s+/).filter(word => word.length > 0);
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            // Barcha so'zlar matnda bo'lishi kerak
            const matches = searchWords.every(word => text.includes(word));
            row.style.display = matches ? '' : 'none';
        });
    });
    
    // Sahifa yuklanganda ma'lumotlarni yuklash
    document.addEventListener('DOMContentLoaded', function() {
        loadPendingTransfers();
        loadTransferHistory();
        
        // Har 10 soniyada tasdiqlanmagan transferlarni yangilab turish
        setInterval(loadPendingTransfers, 10000);
        
        // Har 30 soniyada tarixni yangilab turish
        setInterval(loadTransferHistory, 30000);
    });
    
</script>
{% endblock %}
