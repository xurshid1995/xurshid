{% extends "base.html" %}

{% block title %}Transfer - Dokon Boshqaruv Tizimi{% endblock %}

{% block extra_css %}
<style>
    /* Transfer sahifasi stillari */
    .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .btn-success {
        background-color: #28a745;
        border-color: #28a745;
    }
    
    .btn-success:hover {
        background-color: #218838;
        border-color: #1e7e34;
    }
    
    .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .transfer-list-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .transfer-list-table th,
    .transfer-list-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
    }
    
    .transfer-list-table th {
        font-weight: 600;
        white-space: nowrap;
    }
    
    .transfer-list-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .btn-sm {
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        margin-right: 5px;
    }
    
    .btn-success-sm {
        background-color: #28a745;
        color: white;
    }
    
    .btn-danger-sm {
        background-color: #dc3545;
        color: white;
    }
    
    .btn-success-sm:hover {
        background-color: #218838;
    }
    
    .btn-danger-sm:hover {
        background-color: #c82333;
    }
    
    @media (max-width: 768px) {
        .transfer-list-table {
            font-size: 12px;
        }
        
        .transfer-list-table th,
        .transfer-list-table td {
            padding: 8px 4px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <h1>üîÑ Transfer Sahifasi</h1>
    <a href="{{ url_for('transfer_old') }}?new=true" class="btn btn-success">
        <i class="fas fa-exchange-alt"></i> Yangi Transfer
    </a>
</div>

<!-- Tasdiqlanmagan Transferlar -->
<div class="card" style="margin-bottom: 20px;">
    <div class="card-body" style="padding: 15px;">
        <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #333;">‚è≥ Tasdiqlanmagan Transferlar</h3>
        <div style="overflow-x: auto;">
            <table class="table transfer-list-table" id="pendingTransfersTable">
                <thead>
                    <tr>
                        <th style="color: white; background: #007bff;">Qayerdan</th>
                        <th style="color: white; background: #007bff;">Qayerga</th>
                        <th style="color: white; background: #007bff;">Yaratilgan vaqti</th>
                        <th style="color: white; background: #007bff;">Nechta mahsulot</th>
                        <th style="color: white; background: #007bff;">Foydalanuvchi</th>
                        <th style="color: white; background: #007bff;">Amallar</th>
                    </tr>
                </thead>
                <tbody id="pendingTransfersBody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                            üì≠ Tasdiqlanmagan transferlar yo'q
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Transfer Tarixi -->
<div class="card">
    <div class="card-body" style="padding: 15px;">
        <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #333;">üìã Transfer Tarixi</h3>
        <div style="margin-bottom: 15px;">
            <input type="text" id="historySearch" class="form-control" placeholder="üîç Transfer tarixidan qidirish..." style="padding: 10px; border: 2px solid #ddd; border-radius: 4px;">
        </div>
        <div style="overflow-x: auto;">
            <table class="table transfer-list-table" id="transferHistoryTable">
                <thead>
                    <tr>
                        <th style="color: white; background: #007bff;">Sana</th>
                        <th style="color: white; background: #007bff;">Qayerdan</th>
                        <th style="color: white; background: #007bff;">Qayerga</th>
                        <th style="color: white; background: #007bff;">Mahsulotlar</th>
                        <th style="color: white; background: #007bff;">Foydalanuvchi</th>
                    </tr>
                </thead>
                <tbody id="transferHistoryBody">
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px; color: #666;">
                            ‚è≥ Yuklanmoqda...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Tasdiqlanmagan transferlarni yuklash
    async function loadPendingTransfers() {
        try {
            const response = await fetch('/api/all-pending-transfers');
            const data = await response.json();
            
            const tbody = document.getElementById('pendingTransfersBody');
            
            if (data.pending_transfers && data.pending_transfers.length > 0) {
                tbody.innerHTML = data.pending_transfers.map(pending => {
                    const createdDate = new Date(pending.created_at);
                    const formattedDate = createdDate.toLocaleString('uz-UZ', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const productCount = pending.items.length;
                    const isOwnTransfer = pending.user_name === '{{ session.get("username") }}';
                    
                    const deleteButton = isOwnTransfer 
                        ? '<button class="btn-sm btn-danger-sm" onclick="deletePendingTransfer(' + pending.id + '); return false;" style="margin-left: 5px;">üóëÔ∏è O\'chirish</button>'
                        : '';
                    
                    return `
                        <tr>
                            <td>${pending.from_location}</td>
                            <td>${pending.to_location}</td>
                            <td style="white-space: nowrap;">${formattedDate}</td>
                            <td style="text-align: center;">
                                <span style="background: #007bff; color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600;">${productCount}</span>
                            </td>
                            <td>${pending.user_name}</td>
                            <td>
                                <a href="${isOwnTransfer ? '/transfer_old?id=' + pending.id : '#'}" 
                                   class="btn-sm btn-success-sm" 
                                   ${!isOwnTransfer ? 'onclick="alert(\'Faqat o\\\'z transferingizni tahrirlashingiz mumkin\'); return false;"' : ''}>
                                    ‚úèÔ∏è Tahrirlash
                                </a>
                                ${deleteButton}
                            </td>
                        </tr>
                    `;
                }).join('');
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                            üì≠ Tasdiqlanmagan transferlar yo'q
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Tasdiqlanmagan transferlarni yuklashda xatolik:', error);
        }
    }
    
    // Pending transferni o'chirish
    async function deletePendingTransfer(pendingId) {
        if (!confirm('Bu transferni o\'chirmoqchimisiz?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/pending-transfer/${pendingId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                alert('‚úÖ Transfer o\'chirildi');
                await loadPendingTransfers(); // Jadvalni yangilash
            } else {
                alert('‚ùå Transferni o\'chirishda xatolik');
            }
        } catch (error) {
            console.error('Transferni o\'chirishda xatolik:', error);
            alert('‚ùå Transferni o\'chirishda xatolik');
        }
    }
    
    // Transfer tarixini yuklash
    async function loadTransferHistory() {
        try {
            const response = await fetch('/api/transfer-history');
            const data = await response.json();
            
            const tbody = document.getElementById('transferHistoryBody');
            
            if (data.transfers && data.transfers.length > 0) {
                tbody.innerHTML = data.transfers.map(transfer => {
                    const date = new Date(transfer.created_at);
                    const formattedDate = date.toLocaleString('uz-UZ', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const products = transfer.products.map(p => 
                        `${p.name} (${p.quantity})`
                    ).join('<br>');
                    
                    return `
                        <tr>
                            <td style="white-space: nowrap;">${formattedDate}</td>
                            <td>${transfer.from_location}</td>
                            <td>${transfer.to_location}</td>
                            <td>${products}</td>
                            <td>${transfer.user_name}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px; color: #666;">
                            üì≠ Transfer tarixi bo'sh
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Transfer tarixini yuklashda xatolik:', error);
            document.getElementById('transferHistoryBody').innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px; color: #dc3545;">
                        ‚ùå Xatolik yuz berdi
                    </td>
                </tr>
            `;
        }
    }
    
    // Qidiruv funksiyasi
    document.getElementById('historySearch')?.addEventListener('input', function(e) {
        const searchText = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#transferHistoryTable tbody tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchText) ? '' : 'none';
        });
    });
    
    // Sahifa yuklanganda ma'lumotlarni yuklash
    document.addEventListener('DOMContentLoaded', function() {
        loadPendingTransfers();
        loadTransferHistory();
        
        // Har 10 soniyada tasdiqlanmagan transferlarni yangilab turish
        setInterval(loadPendingTransfers, 10000);
        
        // Har 30 soniyada tarixni yangilab turish
        setInterval(loadTransferHistory, 30000);
    });
    
</script>
{% endblock %}
