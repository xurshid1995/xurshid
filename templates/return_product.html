{% extends "base_with_sidebar.html" %}

{% block title %}Mahsulotni Qaytarish - DOKON{% endblock %}

{% block content %}
<div class="container" style="max-width: 1400px; margin: 0 auto; padding: 20px;">
    <div class="page-header" style="margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
        <div>
            <h1 style="color: #333; font-size: 28px; margin: 0;">
                <span style="font-size: 32px;">‚Ü©Ô∏è</span> Mahsulotni Qaytarish
            </h1>
        </div>
        <div style="min-width: 300px;">
            <label style="display: block; margin-bottom: 5px; color: #666; font-weight: 500; font-size: 14px;">üìç Qaytarish joyi:</label>
            <select id="returnLocationSelect" onchange="handleLocationChange()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px; background: white; cursor: pointer;">
                <option value="">Joylashuvni tanlang...</option>
            </select>
        </div>
    </div>

    <!-- Mahsulot qidirish -->
    <div class="search-section" style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="margin-bottom: 15px; color: #333;">üîç Mahsulotni qidirish</h3>
        <div style="display: flex; gap: 10px; align-items: end;">
            <div style="flex: 1; position: relative;">
                <label style="display: block; margin-bottom: 5px; color: #666; font-weight: 500;">Mahsulot nomi yoki barkodi:</label>
                <input type="text" id="productSearchInput" placeholder="Avval joylashuvni tanlang..." 
                       autocomplete="off"
                       disabled
                       oninput="searchProducts()"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px;">
                <div id="productSuggestions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.1);"></div>
            </div>
        </div>
    </div>

    <!-- Tanlangan mahsulot ma'lumoti -->
    <div id="selectedProductInfo" style="display: none; background: #e3f2fd; border-radius: 8px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <strong style="font-size: 16px; color: #1976d2;">Tanlangan mahsulot:</strong>
                <span id="selectedProductName" style="margin-left: 10px; font-size: 16px; color: #333;"></span>
            </div>
            <button onclick="clearProductSelection()" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                ‚úï Bekor qilish
            </button>
        </div>
    </div>

    <!-- Mahsulot bor savdolar jadvali -->
    <div id="recentSalesSection" style="display: none; background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="margin-bottom: 15px; color: #333;">üìä Bu mahsulot bor savdolar</h3>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                        <th style="padding: 12px; text-align: left; font-weight: 600;">ID</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Mijoz</th>
                        <th style="padding: 12px; text-align: center; font-weight: 600;">Sana</th>
                        <th style="padding: 12px; text-align: center; font-weight: 600;">Miqdor</th>
                        <th style="padding: 12px; text-align: right; font-weight: 600;">Narx</th>
                        <th style="padding: 12px; text-align: right; font-weight: 600;">Summa</th>
                        <th style="padding: 12px; text-align: center; font-weight: 600;">Holat</th>
                        <th style="padding: 12px; text-align: center; font-weight: 600;">Amal</th>
                    </tr>
                </thead>
                <tbody id="recentSalesTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Savdo ma'lumotlari -->
    <div id="saleDetails" style="display: none;">
        <div class="sale-info" style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-bottom: 15px; color: #333;">üìã Savdo ma'lumotlari</h3>
            <div id="saleInfoContent"></div>
        </div>

        <!-- Mahsulotlar ro'yxati -->
        <div class="products-section" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-bottom: 15px; color: #333;">üì¶ Mahsulotlar</h3>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 12px; text-align: left; font-weight: 600;">Mahsulot</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Sotilgan miqdor</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600;">Narx</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600;">Jami</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Qaytarish miqdori</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Amal</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #dee2e6; text-align: right;">
                <button onclick="confirmReturn()" id="returnBtn" style="padding: 12px 40px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: 600;">
                    ‚úÖ Qaytarishni tasdiqlash
                </button>
            </div>
        </div>
    </div>

    <!-- Xabarlar -->
    <div id="messageDiv" style="margin-top: 20px;"></div>
</div>

<style>
    .container input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .container button:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .container button:active {
        transform: translateY(0);
    }

    .return-input {
        width: 80px;
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-align: center;
        font-size: 14px;
    }

    .return-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }

    .info-item {
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
    }

    .info-label {
        color: #666;
        font-size: 13px;
        margin-bottom: 4px;
    }

    .info-value {
        color: #333;
        font-size: 16px;
        font-weight: 600;
    }

    .alert {
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 15px;
    }

    .alert-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    .alert-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .alert-warning {
        background: #fff3cd;
        border: 1px solid #ffeeba;
        color: #856404;
    }
</style>

<script>
    let currentSale = null;
    let returnItems = [];
    let selectedProduct = null;
    let productsCache = [];
    let searchTimeout = null;
    let returnLocationId = null;
    let returnLocationType = null;

    // Sahifa yuklanganda joylashuvlarni yuklash
    document.addEventListener('DOMContentLoaded', function() {
        loadLocations();
    });

    // Joylashuvlarni yuklash
    async function loadLocations() {
        try {
            const response = await fetch('/api/locations');
            const locations = await response.json();

            console.log('Joylashuvlar yuklandi:', locations);

            const locationSelect = document.getElementById('returnLocationSelect');
            let html = '<option value="">Joylashuvni tanlang...</option>';

            // Joylashuvlarni guruhlash
            const stores = locations.filter(loc => loc.type === 'store');
            const warehouses = locations.filter(loc => loc.type === 'warehouse');

            // Do'konlar
            if (stores && stores.length > 0) {
                html += '<optgroup label="üè¨ Do\'konlar">';
                stores.forEach(store => {
                    html += `<option value="store_${store.id}">üè¨ ${store.name}</option>`;
                });
                html += '</optgroup>';
            }

            // Omborlar
            if (warehouses && warehouses.length > 0) {
                html += '<optgroup label="üè≠ Omborlar">';
                warehouses.forEach(warehouse => {
                    html += `<option value="warehouse_${warehouse.id}">üè≠ ${warehouse.name}</option>`;
                });
                html += '</optgroup>';
            }

            locationSelect.innerHTML = html;
            console.log('Joylashuvlar dropdown\'ga qo\'shildi');
        } catch (error) {
            console.error('Joylashuvlarni yuklashda xatolik:', error);
            showMessage('‚ùå Joylashuvlarni yuklashda xatolik!', 'error');
        }
    }

    // Joylashuv o'zgarganda
    function handleLocationChange() {
        const locationSelect = document.getElementById('returnLocationSelect');
        const selectedValue = locationSelect.value;

        if (!selectedValue) {
            returnLocationId = null;
            returnLocationType = null;
            // Mahsulot qidirishni tozalash
            document.getElementById('productSearchInput').value = '';
            document.getElementById('productSearchInput').disabled = true;
            document.getElementById('productSearchInput').placeholder = 'Avval joylashuvni tanlang...';
            clearProductSelection();
            return;
        }

        const parts = selectedValue.split('_');
        returnLocationType = parts[0];
        returnLocationId = parseInt(parts[1]);

        // Mahsulot qidirishni yoqish
        document.getElementById('productSearchInput').disabled = false;
        document.getElementById('productSearchInput').placeholder = 'Mahsulot nomini kiriting...';

        console.log('Joylashuv tanlandi:', returnLocationType, returnLocationId);
    }

    // Mahsulotlarni qidirish
    async function searchProducts() {
        const searchTerm = document.getElementById('productSearchInput').value.trim();
        
        if (searchTerm.length < 2) {
            document.getElementById('productSuggestions').style.display = 'none';
            return;
        }

        // Joylashuv tanlanganligini tekshirish
        if (!returnLocationId || !returnLocationType) {
            showMessage('‚ö†Ô∏è Avval qaytarish joyini tanlang!', 'warning');
            document.getElementById('productSuggestions').style.display = 'none';
            return;
        }

        // Debounce: 300ms kutish
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
            try {
                // Joylashuv parametrlarini qo'shish
                const url = `/api/products?search=${encodeURIComponent(searchTerm)}&limit=20&location_type=${returnLocationType}&location_id=${returnLocationId}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.products) {
                    displayProductSuggestions(data.products);
                }
            } catch (error) {
                console.error('Mahsulotlarni qidirishda xatolik:', error);
            }
        }, 300);
    }

    function displayProductSuggestions(products) {
        const suggestionsDiv = document.getElementById('productSuggestions');
        
        if (products.length === 0) {
            suggestionsDiv.innerHTML = '<div style="padding: 15px; text-align: center; color: #666;">Mahsulot topilmadi</div>';
            suggestionsDiv.style.display = 'block';
            return;
        }

        let html = '';
        products.forEach(product => {
            html += `
                <div onclick="selectProduct(${product.id}, '${product.name.replace(/'/g, "\\'")}', '${product.barcode || ''}')" 
                     style="padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s;"
                     onmouseover="this.style.background='#f8f9fa'" 
                     onmouseout="this.style.background='white'">
                    <div style="font-weight: 600; color: #333;">${product.name}</div>
                    ${product.barcode ? `<div style="font-size: 12px; color: #666; margin-top: 4px;">Barkod: ${product.barcode}</div>` : ''}
                </div>
            `;
        });

        suggestionsDiv.innerHTML = html;
        suggestionsDiv.style.display = 'block';
    }

    async function selectProduct(productId, productName, barcode) {
        selectedProduct = { id: productId, name: productName, barcode: barcode };
        
        // Input va suggestions'ni yashirish
        document.getElementById('productSearchInput').value = productName;
        document.getElementById('productSuggestions').style.display = 'none';
        
        // Tanlangan mahsulot ma'lumotini ko'rsatish
        document.getElementById('selectedProductName').textContent = productName;
        document.getElementById('selectedProductInfo').style.display = 'block';
        
        // Bu mahsulot bor savdolarni yuklash
        await loadSalesByProduct(productId);
    }

    function clearProductSelection() {
        selectedProduct = null;
        document.getElementById('productSearchInput').value = '';
        document.getElementById('selectedProductInfo').style.display = 'none';
        document.getElementById('recentSalesSection').style.display = 'none';
        document.getElementById('saleDetails').style.display = 'none';
    }

    async function loadSalesByProduct(productId) {
        try {
            const response = await fetch(`/api/sales-by-product/${productId}`);
            const data = await response.json();

            if (!data.success || !data.sales) {
                showMessage('‚ùå Bu mahsulot bor savdolar topilmadi!', 'warning');
                return;
            }

            const salesTableBody = document.getElementById('recentSalesTableBody');
            let html = '';

            if (data.sales.length === 0) {
                html = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #666;">Bu mahsulot hech bir savdoda ishtirok etmagan</td></tr>';
            } else {
                data.sales.forEach(sale => {
                    const saleDate = new Date(sale.created_at).toLocaleString('uz-UZ', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const statusBadge = getPaymentStatusBadge(sale.payment_status);

                    html += `
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 12px; font-weight: 600;">#${sale.id}</td>
                            <td style="padding: 12px;">${sale.customer_name}</td>
                            <td style="padding: 12px; text-align: center;">${saleDate}</td>
                            <td style="padding: 12px; text-align: center; font-weight: 600;">${sale.product_quantity}</td>
                            <td style="padding: 12px; text-align: right;">$${sale.product_price.toFixed(2)}</td>
                            <td style="padding: 12px; text-align: right; font-weight: 600;">$${sale.total_usd.toFixed(2)}</td>
                            <td style="padding: 12px; text-align: center;">${statusBadge}</td>
                            <td style="padding: 12px; text-align: center;">
                                <button onclick="selectSaleForReturn(${sale.id}, ${sale.product_quantity})" 
                                        style="padding: 6px 15px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                    Qaytarish
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }

            salesTableBody.innerHTML = html;
            document.getElementById('recentSalesSection').style.display = 'block';

        } catch (error) {
            console.error('Xatolik:', error);
            showMessage('‚ùå Server bilan bog\'lanishda xatolik!', 'error');
        }
    }

    async function selectSaleForReturn(saleId, productQuantity) {
        try {
            const response = await fetch(`/api/sales/${saleId}`);
            const data = await response.json();

            if (!data.success) {
                showMessage('‚ùå Savdo topilmadi!', 'error');
                return;
            }

            currentSale = data.sale;
            
            // Faqat tanlangan mahsulotni ko'rsatish
            displaySaleDetailsForProduct(productQuantity);
            document.getElementById('saleDetails').style.display = 'block';
            
        } catch (error) {
            console.error('Xatolik:', error);
            showMessage('‚ùå Server bilan bog\'lanishda xatolik!', 'error');
        }
    }

    function displaySaleDetailsForProduct(productQuantity) {
        // Savdo ma'lumotlarini ko'rsatish
        const saleDate = new Date(currentSale.sale_date).toLocaleString('uz-UZ');
        const infoHtml = `
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Savdo ID:</div>
                    <div class="info-value">#${currentSale.id}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Mijoz:</div>
                    <div class="info-value">${currentSale.customer_name || 'Noma\'lum'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Sana:</div>
                    <div class="info-value">${saleDate}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">To'lov holati:</div>
                    <div class="info-value">${getPaymentStatusText(currentSale.payment_status)}</div>
                </div>
            </div>
        `;
        document.getElementById('saleInfoContent').innerHTML = infoHtml;

        // Faqat tanlangan mahsulotni ko'rsatish
        let productsHtml = '';
        returnItems = [];

        const item = currentSale.items.find(i => i.product_id === selectedProduct.id);
        if (item) {
            returnItems.push({
                product_id: item.product_id,
                product_name: item.product_name,
                sold_quantity: item.quantity,
                unit_price: item.unit_price,
                return_quantity: 0
            });

            const totalPrice = (item.quantity * item.unit_price).toFixed(2);
            productsHtml = `
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 12px;">${item.product_name}</td>
                    <td style="padding: 12px; text-align: center; font-weight: 600;">${item.quantity}</td>
                    <td style="padding: 12px; text-align: right;">$${item.unit_price.toFixed(2)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600;">$${totalPrice}</td>
                    <td style="padding: 12px; text-align: center;">
                        <input type="number" 
                               class="return-input" 
                               id="return_0"
                               min="0" 
                               max="${item.quantity}" 
                               value="0"
                               onchange="updateReturnQuantity(0, this.value)">
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <button onclick="setFullReturn(0)" 
                                style="padding: 6px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                            Hammasi
                        </button>
                    </td>
                </tr>
            `;
        }

        document.getElementById('productsTableBody').innerHTML = productsHtml;
    }

    // Click tashqarisiga bosilganda suggestions yopish
    document.addEventListener('click', function(e) {
        const searchInput = document.getElementById('productSearchInput');
        const suggestions = document.getElementById('productSuggestions');
        if (e.target !== searchInput && !suggestions.contains(e.target)) {
            suggestions.style.display = 'none';
        }
    });

    function getPaymentStatusBadge(status) {
        const badges = {
            'paid': '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚úÖ To\'langan</span>',
            'partial': '<span style="background: #ffc107; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚ö†Ô∏è Qisman</span>',
            'pending': '<span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚è≥ Kutilmoqda</span>',
            'debt': '<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">üí≥ Qarzda</span>'
        };
        return badges[status] || status;
    }

    async function searchSale() {
        const saleId = document.getElementById('saleIdInput').value;
        if (!saleId) {
            showMessage('‚ö†Ô∏è Savdo ID ni kiriting!', 'warning');
            return;
        }

        try {
            const response = await fetch(`/api/sales/${saleId}`);
            const data = await response.json();

            if (!data.success) {
                showMessage('‚ùå Savdo topilmadi!', 'error');
                return;
            }

            currentSale = data.sale;
            displaySaleDetails();
            document.getElementById('saleDetails').style.display = 'block';
            showMessage('‚úÖ Savdo muvaffaqiyatli yuklandi!', 'success');
        } catch (error) {
            console.error('Xatolik:', error);
            showMessage('‚ùå Server bilan bog\'lanishda xatolik!', 'error');
        }
    }

    function displaySaleDetails() {
        // Savdo ma'lumotlarini ko'rsatish
        const saleDate = new Date(currentSale.sale_date).toLocaleString('uz-UZ');
        const infoHtml = `
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Savdo ID:</div>
                    <div class="info-value">#${currentSale.id}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Mijoz:</div>
                    <div class="info-value">${currentSale.customer_name || 'Noma\'lum'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Sana:</div>
                    <div class="info-value">${saleDate}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">To'lov holati:</div>
                    <div class="info-value">${getPaymentStatusText(currentSale.payment_status)}</div>
                </div>
            </div>
        `;
        document.getElementById('saleInfoContent').innerHTML = infoHtml;

        // Mahsulotlarni ko'rsatish
        let productsHtml = '';
        returnItems = [];

        currentSale.items.forEach((item, index) => {
            returnItems.push({
                product_id: item.product_id,
                product_name: item.product_name,
                sold_quantity: item.quantity,
                unit_price: item.unit_price,
                return_quantity: 0
            });

            const totalPrice = (item.quantity * item.unit_price).toFixed(2);
            productsHtml += `
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 12px;">${item.product_name}</td>
                    <td style="padding: 12px; text-align: center; font-weight: 600;">${item.quantity}</td>
                    <td style="padding: 12px; text-align: right;">$${item.unit_price.toFixed(2)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600;">$${totalPrice}</td>
                    <td style="padding: 12px; text-align: center;">
                        <input type="number" 
                               class="return-input" 
                               id="return_${index}"
                               min="0" 
                               max="${item.quantity}" 
                               value="0"
                               onchange="updateReturnQuantity(${index}, this.value)">
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <button onclick="setFullReturn(${index})" 
                                style="padding: 6px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                            Hammasi
                        </button>
                    </td>
                </tr>
            `;
        });

        document.getElementById('productsTableBody').innerHTML = productsHtml;
    }

    function updateReturnQuantity(index, quantity) {
        const qty = parseInt(quantity) || 0;
        const maxQty = returnItems[index].sold_quantity;
        
        if (qty > maxQty) {
            showMessage(`‚ö†Ô∏è Qaytarish miqdori sotilgan miqdordan oshmasligi kerak! (Max: ${maxQty})`, 'warning');
            document.getElementById(`return_${index}`).value = maxQty;
            returnItems[index].return_quantity = maxQty;
        } else {
            returnItems[index].return_quantity = qty;
        }
    }

    function setFullReturn(index) {
        const maxQty = returnItems[index].sold_quantity;
        document.getElementById(`return_${index}`).value = maxQty;
        returnItems[index].return_quantity = maxQty;
    }

    async function confirmReturn() {
        // Joylashuvni tekshirish
        if (!returnLocationId || !returnLocationType) {
            showMessage('‚ö†Ô∏è Iltimos, avval qaytarish joyini tanlang!', 'warning');
            return;
        }

        // Qaytariladigan mahsulotlarni tekshirish
        const itemsToReturn = returnItems.filter(item => item.return_quantity > 0);
        
        if (itemsToReturn.length === 0) {
            showMessage('‚ö†Ô∏è Hech qanday mahsulot tanlanmagan!', 'warning');
            return;
        }

        const confirmMsg = `${itemsToReturn.length} ta mahsulotni qaytarishni tasdiqlaysizmi?`;
        if (!confirm(confirmMsg)) {
            return;
        }

        try {
            const response = await fetch('/api/return-product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sale_id: currentSale.id,
                    items: itemsToReturn,
                    location_id: returnLocationId,
                    location_type: returnLocationType
                })
            });

            const data = await response.json();

            if (data.success) {
                showMessage('‚úÖ Mahsulotlar muvaffaqiyatli qaytarildi!', 'success');
                // Formani tozalash
                setTimeout(() => {
                    clearProductSelection();
                    document.getElementById('saleDetails').style.display = 'none';
                    currentSale = null;
                    returnItems = [];
                }, 2000);
            } else {
                showMessage('‚ùå Xatolik: ' + data.error, 'error');
            }
        } catch (error) {
            console.error('Xatolik:', error);
            showMessage('‚ùå Server bilan bog\'lanishda xatolik!', 'error');
        }
    }

    function getPaymentStatusText(status) {
        const statuses = {
            'paid': '‚úÖ To\'langan',
            'partial': '‚ö†Ô∏è Qisman to\'langan',
            'pending': '‚è≥ Kutilmoqda',
            'debt': 'üí≥ Qarzda'
        };
        return statuses[status] || status;
    }

    function showMessage(message, type) {
        const messageDiv = document.getElementById('messageDiv');
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'error' ? 'alert-error' : 'alert-warning';
        
        messageDiv.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
        
        setTimeout(() => {
            messageDiv.innerHTML = '';
        }, 5000);
    }
</script>
{% endblock %}
