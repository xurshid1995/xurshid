{% extends "base_with_sidebar.html" %}

{% block title %}Mahsulotni Qaytarish - DOKON{% endblock %}

{% block content %}
<div class="container" style="max-width: 1400px; margin: 0 auto; padding: 20px;">
    <div class="page-header" style="margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
        <div>
            <h1 style="color: #333; font-size: 28px; margin: 0;">
                <span style="font-size: 32px;">‚Ü©Ô∏è</span> Mahsulotni Qaytarish
            </h1>
        </div>
        <div style="min-width: 300px;">
            <label style="display: block; margin-bottom: 5px; color: #666; font-weight: 500; font-size: 14px;">üìç Qaytarish joyi:</label>
            <select id="returnLocationSelect" onchange="handleLocationChange()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px; background: white; cursor: pointer;">
                <option value="">Joylashuvni tanlang...</option>
            </select>
        </div>
    </div>

    <!-- Mahsulot qidirish -->
    <div class="search-section" style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="margin-bottom: 15px; color: #333;">üîç Mahsulotni qidirish</h3>
        <div style="display: flex; gap: 10px; align-items: end;">
            <div style="flex: 1; position: relative;">
                <label style="display: block; margin-bottom: 5px; color: #666; font-weight: 500;">Mahsulot nomi yoki barkodi:</label>
                <input type="text" id="productSearchInput" placeholder="Avval joylashuvni tanlang..." 
                       autocomplete="off"
                       disabled
                       oninput="searchProducts()"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px;">
                <div id="productSuggestions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.1);"></div>
            </div>
        </div>
    </div>

    <!-- Tanlangan mahsulot ma'lumoti -->
    <div id="selectedProductInfo" style="display: none; background: #e3f2fd; border-radius: 8px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <strong style="font-size: 16px; color: #1976d2;">Tanlangan mahsulot:</strong>
                <span id="selectedProductName" style="margin-left: 10px; font-size: 16px; color: #333;"></span>
            </div>
            <button onclick="clearProductSelection()" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                ‚úï Bekor qilish
            </button>
        </div>
    </div>

    <!-- Mahsulot bor savdolar jadvali -->
    <div id="recentSalesSection" style="display: none; background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="margin-bottom: 15px; color: #333;">üìä Bu mahsulot bor savdolar</h3>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Sana va vaqt</th>
                        <th style="padding: 12px; text-align: center; font-weight: 600;">ID</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Mijoz</th>
                        <th style="padding: 12px; text-align: center; font-weight: 600;">Mahsulot soni</th>
                        <th style="padding: 12px; text-align: center; font-weight: 600;">Joriy mahsulot miqdori</th>
                        <th style="padding: 12px; text-align: center; font-weight: 600;">Holat</th>
                        <th style="padding: 12px; text-align: center; font-weight: 600;">Amal</th>
                    </tr>
                </thead>
                <tbody id="recentSalesTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Savdo ma'lumotlari -->
    <div id="saleDetails" style="display: none;">
        <div class="sale-info" style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-bottom: 15px; color: #333;">üìã Savdo ma'lumotlari</h3>
            <div id="saleInfoContent"></div>
        </div>

        <!-- Mahsulotlar ro'yxati -->
        <div class="products-section" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-bottom: 15px; color: #333;">üì¶ Mahsulotlar</h3>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 12px; text-align: left; font-weight: 600;">Mahsulot</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Sotilgan miqdor</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600;">Narx</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600;">Jami</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Qaytarish miqdori</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Amal</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #dee2e6; text-align: right;">
                <button onclick="confirmReturnOld()" id="returnBtn" style="padding: 12px 40px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: 600;">
                    ‚úÖ Qaytarishni tasdiqlash
                </button>
            </div>
        </div>
    </div>

    <!-- Qaytarilgan mahsulotlar tarixi -->
    <div class="history-section" style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; color: #333;">üìú Qaytarilgan mahsulotlar tarixi</h3>
            <button onclick="loadReturnHistory()" style="padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                üîÑ Yangilash
            </button>
        </div>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Sana va vaqt</th>
                        <th style="padding: 12px; text-align: center; font-weight: 600;">Savdo ID</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Mahsulot</th>
                        <th style="padding: 12px; text-align: center; font-weight: 600;">Miqdor</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Qaytarilgan joy</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Foydalanuvchi</th>
                        <th style="padding: 12px; text-align: right; font-weight: 600;">Summa</th>
                        <th style="padding: 12px; text-align: center; font-weight: 600;">Amal</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <tr>
                        <td colspan="8" style="padding: 20px; text-align: center; color: #999;">
                            <span style="font-size: 16px;">‚è≥ Yuklanmoqda...</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Xabarlar -->
    <div id="messageDiv" style="margin-top: 20px;"></div>
</div>

<style>
    .container input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .container button:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .container button:active {
        transform: translateY(0);
    }

    .return-input {
        width: 80px;
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-align: center;
        font-size: 14px;
    }

    .return-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }

    .info-item {
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
    }

    .info-label {
        color: #666;
        font-size: 13px;
        margin-bottom: 4px;
    }

    .info-value {
        color: #333;
        font-size: 16px;
        font-weight: 600;
    }

    .alert {
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 15px;
    }

    .alert-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    .alert-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .alert-warning {
        background: #fff3cd;
        border: 1px solid #ffeeba;
        color: #856404;
    }
</style>

<script>
    let currentSale = null;
    let returnItems = [];
    let selectedProduct = null;
    let productsCache = [];
    let searchTimeout = null;
    let returnLocationId = null;
    let returnLocationType = null;

    // Sahifa yuklanganda joylashuvlarni yuklash
    document.addEventListener('DOMContentLoaded', function() {
        loadLocations();
    });

    // Joylashuvlarni yuklash
    async function loadLocations() {
        try {
            const response = await fetch('/api/locations');
            const locations = await response.json();

            console.log('Joylashuvlar yuklandi:', locations);

            const locationSelect = document.getElementById('returnLocationSelect');
            let html = '<option value="">Joylashuvni tanlang...</option>';

            // Joylashuvlarni guruhlash
            const stores = locations.filter(loc => loc.type === 'store');
            const warehouses = locations.filter(loc => loc.type === 'warehouse');

            // Do'konlar
            if (stores && stores.length > 0) {
                html += '<optgroup label="üè¨ Do\'konlar">';
                stores.forEach(store => {
                    html += `<option value="store_${store.id}">üè¨ ${store.name}</option>`;
                });
                html += '</optgroup>';
            }

            // Omborlar
            if (warehouses && warehouses.length > 0) {
                html += '<optgroup label="üè≠ Omborlar">';
                warehouses.forEach(warehouse => {
                    html += `<option value="warehouse_${warehouse.id}">üè≠ ${warehouse.name}</option>`;
                });
                html += '</optgroup>';
            }

            locationSelect.innerHTML = html;
            console.log('Joylashuvlar dropdown\'ga qo\'shildi');

            // Sotuvchi uchun avtomatik tanlash
            {% if session.role == 'sotuvchi' %}
            if (locations.length === 1) {
                // Agar bitta joylashuv bo'lsa, uni avtomatik tanlash
                const loc = locations[0];
                const locationValue = `${loc.type}_${loc.id}`;
                locationSelect.value = locationValue;
                console.log('‚úÖ Bitta joylashuv avtomatik tanlandi:', loc.name);
                handleLocationChange();
            } else if (locations.length > 1) {
                // Agar bir nechta bo'lsa, birinchi do'konni yoki birinchi joylashuvni tanlash
                const firstStore = stores.length > 0 ? stores[0] : locations[0];
                const locationValue = `${firstStore.type}_${firstStore.id}`;
                locationSelect.value = locationValue;
                console.log('‚úÖ Birinchi joylashuv avtomatik tanlandi:', firstStore.name);
                handleLocationChange();
            }
            {% endif %}
        } catch (error) {
            console.error('Joylashuvlarni yuklashda xatolik:', error);
            showMessage('‚ùå Joylashuvlarni yuklashda xatolik!', 'error');
        }
    }

    // Joylashuv o'zgarganda
    function handleLocationChange() {
        const locationSelect = document.getElementById('returnLocationSelect');
        const selectedValue = locationSelect.value;

        if (!selectedValue) {
            returnLocationId = null;
            returnLocationType = null;
            // Mahsulot qidirishni tozalash
            document.getElementById('productSearchInput').value = '';
            document.getElementById('productSearchInput').disabled = true;
            document.getElementById('productSearchInput').placeholder = 'Avval joylashuvni tanlang...';
            clearProductSelection();
            return;
        }

        const parts = selectedValue.split('_');
        returnLocationType = parts[0];
        returnLocationId = parseInt(parts[1]);

        // Mahsulot qidirishni yoqish
        document.getElementById('productSearchInput').disabled = false;
        document.getElementById('productSearchInput').placeholder = 'Mahsulot nomini kiriting...';

        console.log('Joylashuv tanlandi:', returnLocationType, returnLocationId);
    }

    // Mahsulotlarni qidirish
    async function searchProducts() {
        const searchTerm = document.getElementById('productSearchInput').value.trim();
        
        if (searchTerm.length < 2) {
            document.getElementById('productSuggestions').style.display = 'none';
            return;
        }

        // Joylashuv tanlanganligini tekshirish
        if (!returnLocationId || !returnLocationType) {
            showMessage('‚ö†Ô∏è Avval qaytarish joyini tanlang!', 'warning');
            document.getElementById('productSuggestions').style.display = 'none';
            return;
        }

        // Debounce: 300ms kutish
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
            try {
                // Joylashuv parametrlarini alohida yuborish
                const url = `/api/products?search=${encodeURIComponent(searchTerm)}&limit=20&location_type=${returnLocationType}&location_id=${returnLocationId}`;
                console.log('Mahsulot qidiruv URL:', url);
                
                const response = await fetch(url);
                const data = await response.json();

                console.log('Mahsulot qidiruv natijasi:', data);
                console.log('data.success:', data.success);
                console.log('data.products:', data.products);
                console.log('data.products uzunligi:', data.products ? data.products.length : 'undefined');

                // API har doim products array qaytaradi, success property bo'lmasligi mumkin
                if (data.products && Array.isArray(data.products)) {
                    displayProductSuggestions(data.products);
                } else if (data.success && data.products) {
                    displayProductSuggestions(data.products);
                } else {
                    console.warn('‚ö†Ô∏è Mahsulotlar topilmadi yoki noto\'g\'ri format');
                    displayProductSuggestions([]);
                }
            } catch (error) {
                console.error('Mahsulotlarni qidirishda xatolik:', error);
            }
        }, 300);
    }

    function displayProductSuggestions(products) {
        const suggestionsDiv = document.getElementById('productSuggestions');
        
        console.log('displayProductSuggestions chaqirildi:', products);
        console.log('suggestionsDiv elementi:', suggestionsDiv);
        
        if (!suggestionsDiv) {
            console.error('‚ùå productSuggestions elementi topilmadi!');
            return;
        }
        
        if (products.length === 0) {
            suggestionsDiv.innerHTML = '<div style="padding: 15px; text-align: center; color: #666;">Mahsulot topilmadi</div>';
            suggestionsDiv.style.display = 'block';
            console.log('‚úÖ "Mahsulot topilmadi" xabari ko\'rsatildi');
            return;
        }

        let html = '';
        products.forEach(product => {
            console.log('Mahsulot qo\'shilmoqda:', product.name);
            html += `
                <div onclick="selectProduct(${product.id}, '${product.name.replace(/'/g, "\\'")}', '${product.barcode || ''}')" 
                     style="padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s;"
                     onmouseover="this.style.background='#f8f9fa'" 
                     onmouseout="this.style.background='white'">
                    <div style="font-weight: 600; color: #333;">${product.name}</div>
                    ${product.barcode ? `<div style="font-size: 12px; color: #666; margin-top: 4px;">Barkod: ${product.barcode}</div>` : ''}
                </div>
            `;
        });

        console.log('HTML yaratildi, uzunlik:', html.length);
        suggestionsDiv.innerHTML = html;
        suggestionsDiv.style.display = 'block';
        console.log('‚úÖ Mahsulotlar ko\'rsatildi, display:', suggestionsDiv.style.display);
    }

    async function selectProduct(productId, productName, barcode) {
        selectedProduct = { id: productId, name: productName, barcode: barcode };
        
        // Input va suggestions'ni yashirish
        document.getElementById('productSearchInput').value = productName;
        document.getElementById('productSuggestions').style.display = 'none';
        
        // Tanlangan mahsulot ma'lumotini ko'rsatish
        document.getElementById('selectedProductName').textContent = productName;
        document.getElementById('selectedProductInfo').style.display = 'block';
        
        // Bu mahsulot bor savdolarni yuklash
        await loadSalesByProduct(productId);
    }

    function clearProductSelection() {
        selectedProduct = null;
        document.getElementById('productSearchInput').value = '';
        document.getElementById('selectedProductInfo').style.display = 'none';
        document.getElementById('recentSalesSection').style.display = 'none';
        document.getElementById('saleDetails').style.display = 'none';
    }

    async function loadSalesByProduct(productId) {
        try {
            console.log('üì¶ Mahsulot bo\'yicha savdolar yuklanmoqda, productId:', productId);
            
            const response = await fetch(`/api/sales-by-product/${productId}`);
            const data = await response.json();

            if (!data.success || !data.sales) {
                showMessage('‚ùå Bu mahsulot bor savdolar topilmadi!', 'warning');
                return;
            }

            const salesTableBody = document.getElementById('recentSalesTableBody');
            let html = '';

            if (data.sales.length === 0) {
                html = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #666;">Bu mahsulot hech bir savdoda ishtirok etmagan</td></tr>';
            } else {
                data.sales.forEach(sale => {
                    // Sana va vaqtni format qilish: 19/01/26 19:24
                    const date = new Date(sale.created_at);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = String(date.getFullYear()).slice(-2);
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const saleDate = `${day}/${month}/${year}<br>${hours}:${minutes}`;
                    
                    // Holat badge'ini yaratish (qarz holatini tekshirib)
                    const statusBadge = getPaymentStatusBadge(sale);
                    
                    // Savdodagi jami mahsulot turlarini hisoblash
                    const totalProductTypes = sale.total_items || 0;

                    html += `
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 12px;">${saleDate}</td>
                            <td style="padding: 12px; text-align: center; font-weight: 600;">#${sale.id}</td>
                            <td style="padding: 12px;">${sale.customer_name}</td>
                            <td style="padding: 12px; text-align: center; font-weight: 600;">${totalProductTypes}</td>
                            <td style="padding: 12px; text-align: center; font-weight: 600; color: #007bff;">${sale.product_quantity}</td>
                            <td style="padding: 12px; text-align: center;">${statusBadge}</td>
                            <td style="padding: 12px; text-align: center;">
                                <button onclick="viewSaleDetails(${sale.id})" 
                                        style="padding: 6px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; margin-right: 5px;">
                                    üëÅÔ∏è Ko'rish
                                </button>
                                <button onclick="selectSaleForReturn(${sale.id}, ${productId})" 
                                        style="padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                    ‚Ü©Ô∏è Qaytarish
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }

            salesTableBody.innerHTML = html;
            document.getElementById('recentSalesSection').style.display = 'block';

        } catch (error) {
            console.error('Xatolik:', error);
            showMessage('‚ùå Server bilan bog\'lanishda xatolik!', 'error');
        }
    }

    async function selectSaleForReturn(saleId, productId) {
        try {
            const response = await fetch(`/api/sales/${saleId}`);
            const data = await response.json();

            if (!data.success) {
                showMessage('‚ùå Savdo topilmadi!', 'error');
                return;
            }

            const sale = data.sale;
            
            console.log('Modal ochilmoqda - productId:', productId, 'saleId:', saleId);
            
            // Sana formati
            const saleDate = new Date(sale.sale_date).toLocaleString('uz-UZ', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });

            // Modal yaratish
            let modalHTML = `
                <div id="returnProductModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 10px; padding: 30px; max-width: 1200px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;">
                            <h2 style="margin: 0; color: #333;">‚Ü©Ô∏è Mahsulotni qaytarish - Savdo #${sale.id}</h2>
                            <button onclick="closeReturnModal()" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 20px;">√ó</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Sana va vaqt</div>
                                <div style="font-weight: 600; color: #333;">${saleDate}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Mijoz</div>
                                <div style="font-weight: 600; color: #333;">${sale.customer_name || 'Noma\'lum'}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Sotuvchi</div>
                                <div style="font-weight: 600; color: #333;">${sale.seller_name || 'Admin'}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Holat</div>
                                <div>${getPaymentStatusBadge(sale)}</div>
                            </div>
                        </div>

                        <h3 style="margin: 20px 0 10px 0; color: #333; font-size: 16px;">üì¶ Mahsulotlar</h3>
                        <div style="overflow-x: auto; margin-bottom: 20px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Mahsulot</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6;">Miqdor</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #dee2e6;">Narx</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #dee2e6;">Summa</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6;">Amal</th>
                                    </tr>
                                </thead>
                                <tbody>`;
            
            sale.items.forEach(item => {
                // Qidirilgan mahsulotni topish - to'g'ridan-to'g'ri productId bilan
                const isSelectedProduct = item.product_id === productId;
                
                const bgColor = isSelectedProduct ? '#e3f2fd' : 'white';
                
                console.log('Mahsulot tekshirilmoqda:', item.product_name, 'product_id:', item.product_id, 'isSelected:', isSelectedProduct);
                
                modalHTML += `
                    <tr style="background: ${bgColor};">
                        <td style="padding: 10px; border-bottom: 1px solid #f0f0f0;">${item.product_name}</td>
                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #f0f0f0; font-weight: 600;">${item.quantity}</td>
                        <td style="padding: 10px; text-align: right; border-bottom: 1px solid #f0f0f0;">$${parseFloat(item.unit_price).toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right; border-bottom: 1px solid #f0f0f0; font-weight: 600;">$${parseFloat(item.total_price).toFixed(2)}</td>
                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #f0f0f0;">`;
                
                if (isSelectedProduct && item.quantity > 0) {
                    modalHTML += `
                        <div style="display: flex; gap: 5px; align-items: center; justify-content: center;">
                            <input type="number" id="returnQty_${item.product_id}" min="1" max="${item.quantity}" value="${item.quantity}" 
                                   style="width: 70px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                            <button onclick="confirmReturn(${sale.id}, ${item.product_id}, '${item.product_name.replace(/'/g, "\\'")}', ${item.quantity})" 
                                    style="padding: 5px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                ‚Ü©Ô∏è Qaytarish
                            </button>
                        </div>`;
                } else {
                    modalHTML += `<span style="color: #999;">-</span>`;
                }
                
                modalHTML += `</td></tr>`;
            });

            modalHTML += `
                                </tbody>
                            </table>
                        </div>

                        <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107;">
                            <div style="font-weight: 600; color: #856404; margin-bottom: 5px;">‚ö†Ô∏è Diqqat:</div>
                            <div style="color: #856404; font-size: 14px;">Mahsulot qaytarilganda to'lovlar avtomatik qaytariladi: Avval qarzdan, keyin naqd, click, terminal.</div>
                        </div>
                    </div>
                </div>`;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
        } catch (error) {
            console.error('Xatolik:', error);
            showMessage('‚ùå Server bilan bog\'lanishda xatolik!', 'error');
        }
    }

    function closeReturnModal() {
        const modal = document.getElementById('returnProductModal');
        if (modal) {
            modal.remove();
        }
    }

    async function confirmReturn(saleId, productId, productName, maxQuantity) {
        // Joylashuv tekshiruvi
        if (!returnLocationId || !returnLocationType) {
            showMessage('‚ùå Iltimos avval qaytarish joyini tanlang!', 'error');
            return;
        }

        const qtyInput = document.getElementById(`returnQty_${productId}`);
        if (!qtyInput) {
            console.error('Input topilmadi:', `returnQty_${productId}`);
            showMessage('‚ùå Xatolik yuz berdi!', 'error');
            return;
        }

        const returnQty = parseInt(qtyInput.value);

        if (!returnQty || returnQty <= 0) {
            showMessage('‚ùå Qaytarish miqdorini kiriting!', 'error');
            return;
        }

        if (returnQty > maxQuantity) {
            showMessage(`‚ùå Maksimal ${maxQuantity} dona qaytarish mumkin!`, 'error');
            return;
        }

        if (!confirm(`${productName} mahsulotidan ${returnQty} dona qaytarilsinmi?`)) {
            return;
        }

        console.log('Qaytarish ma\'lumotlari:', {
            saleId,
            productId,
            returnQty,
            returnLocationId,
            returnLocationType
        });

        try {
            const response = await fetch('/api/return-product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sale_id: saleId,
                    items: [{
                        product_id: productId,
                        quantity: returnQty
                    }],
                    location_id: returnLocationId,
                    location_type: returnLocationType
                })
            });

            const data = await response.json();

            if (data.success) {
                showMessage('‚úÖ Mahsulot muvaffaqiyatli qaytarildi!', 'success');
                closeReturnModal();
                
                // Savdolarni qayta yuklash
                if (selectedProduct) {
                    await loadSalesByProduct(selectedProduct.id);
                }
                
                // Tarixni yangilash
                await loadReturnHistory();
            } else {
                showMessage(`‚ùå Xatolik: ${data.error}`, 'error');
            }
        } catch (error) {
            console.error('Xatolik:', error);
            showMessage('‚ùå Server bilan bog\'lanishda xatolik!', 'error');
        }
    }

    function displaySaleDetailsForProduct(productQuantity) {
        // Savdo ma'lumotlarini ko'rsatish
        const saleDate = new Date(currentSale.sale_date).toLocaleString('uz-UZ');
        const infoHtml = `
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Savdo ID:</div>
                    <div class="info-value">#${currentSale.id}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Mijoz:</div>
                    <div class="info-value">${currentSale.customer_name || 'Noma\'lum'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Sana:</div>
                    <div class="info-value">${saleDate}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">To'lov holati:</div>
                    <div class="info-value">${getPaymentStatusText(currentSale.payment_status)}</div>
                </div>
            </div>
        `;
        document.getElementById('saleInfoContent').innerHTML = infoHtml;

        // Faqat tanlangan mahsulotni ko'rsatish
        let productsHtml = '';
        returnItems = [];

        const item = currentSale.items.find(i => i.product_id === selectedProduct.id);
        if (item) {
            returnItems.push({
                product_id: item.product_id,
                product_name: item.product_name,
                sold_quantity: item.quantity,
                unit_price: item.unit_price,
                return_quantity: 0
            });

            const totalPrice = (item.quantity * item.unit_price).toFixed(2);
            productsHtml = `
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 12px;">${item.product_name}</td>
                    <td style="padding: 12px; text-align: center; font-weight: 600;">${item.quantity}</td>
                    <td style="padding: 12px; text-align: right;">$${item.unit_price.toFixed(2)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600;">$${totalPrice}</td>
                    <td style="padding: 12px; text-align: center;">
                        <input type="number" 
                               class="return-input" 
                               id="return_0"
                               min="0" 
                               max="${item.quantity}" 
                               value="0"
                               onchange="updateReturnQuantity(0, this.value)">
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <button onclick="setFullReturn(0)" 
                                style="padding: 6px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                            Hammasi
                        </button>
                    </td>
                </tr>
            `;
        }

        document.getElementById('productsTableBody').innerHTML = productsHtml;
    }

    // Click tashqarisiga bosilganda suggestions yopish
    document.addEventListener('click', function(e) {
        const searchInput = document.getElementById('productSearchInput');
        const suggestions = document.getElementById('productSuggestions');
        if (e.target !== searchInput && !suggestions.contains(e.target)) {
            suggestions.style.display = 'none';
        }
    });

    function getPaymentStatusBadge(sale) {
        // Agar sale obyekt bo'lmasa (eski format), oddiy statusni qaytarish
        if (typeof sale === 'string') {
            const badges = {
                'paid': '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚úÖ To\'langan</span>',
                'partial': '<span style="background: #ffc107; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚ö†Ô∏è Qisman</span>',
                'pending': '<span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚è≥ Kutilmoqda</span>',
                'debt': '<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">üí≥ Qarzda</span>'
            };
            return badges[sale] || sale;
        }
        
        // To'lov ma'lumotlarini olish
        const totalAmount = parseFloat(sale.total_amount || 0);
        const debtUSD = parseFloat(sale.debt_usd || 0);
        const cashUSD = parseFloat(sale.cash_usd || 0);
        const clickUSD = parseFloat(sale.click_usd || 0);
        const terminalUSD = parseFloat(sale.terminal_usd || 0);
        const paidAmount = cashUSD + clickUSD + terminalUSD;
        
        // Holat aniqlash
        if (sale.payment_status === 'paid' || debtUSD === 0) {
            return '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚úÖ To\'langan</span>';
        } else if (debtUSD > 0 && paidAmount > 0) {
            // Qisman qarz - bir qism to'langan, bir qism qarzda
            return '<span style="background: #ffc107; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚ö†Ô∏è Qisman qarz</span>';
        } else if (debtUSD > 0 && paidAmount === 0) {
            // To'liq qarz - hech narsa to'lanmagan
            return '<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚ùå To\'liq qarz</span>';
        } else if (sale.payment_status === 'cancelled') {
            return '<span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">üö´ Bekor qilingan</span>';
        }
        
        return '<span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚ùì Noma\'lum</span>';
    }

    async function searchSale() {
        const saleId = document.getElementById('saleIdInput').value;
        if (!saleId) {
            showMessage('‚ö†Ô∏è Savdo ID ni kiriting!', 'warning');
            return;
        }

        try {
            const response = await fetch(`/api/sales/${saleId}`);
            const data = await response.json();

            if (!data.success) {
                showMessage('‚ùå Savdo topilmadi!', 'error');
                return;
            }

            currentSale = data.sale;
            displaySaleDetails();
            document.getElementById('saleDetails').style.display = 'block';
            showMessage('‚úÖ Savdo muvaffaqiyatli yuklandi!', 'success');
        } catch (error) {
            console.error('Xatolik:', error);
            showMessage('‚ùå Server bilan bog\'lanishda xatolik!', 'error');
        }
    }

    function displaySaleDetails() {
        // Savdo ma'lumotlarini ko'rsatish
        const saleDate = new Date(currentSale.sale_date).toLocaleString('uz-UZ');
        const infoHtml = `
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Savdo ID:</div>
                    <div class="info-value">#${currentSale.id}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Mijoz:</div>
                    <div class="info-value">${currentSale.customer_name || 'Noma\'lum'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Sana:</div>
                    <div class="info-value">${saleDate}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">To'lov holati:</div>
                    <div class="info-value">${getPaymentStatusText(currentSale.payment_status)}</div>
                </div>
            </div>
        `;
        document.getElementById('saleInfoContent').innerHTML = infoHtml;

        // Mahsulotlarni ko'rsatish
        let productsHtml = '';
        returnItems = [];

        currentSale.items.forEach((item, index) => {
            returnItems.push({
                product_id: item.product_id,
                product_name: item.product_name,
                sold_quantity: item.quantity,
                unit_price: item.unit_price,
                return_quantity: 0
            });

            const totalPrice = (item.quantity * item.unit_price).toFixed(2);
            productsHtml += `
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 12px;">${item.product_name}</td>
                    <td style="padding: 12px; text-align: center; font-weight: 600;">${item.quantity}</td>
                    <td style="padding: 12px; text-align: right;">$${item.unit_price.toFixed(2)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600;">$${totalPrice}</td>
                    <td style="padding: 12px; text-align: center;">
                        <input type="number" 
                               class="return-input" 
                               id="return_${index}"
                               min="0" 
                               max="${item.quantity}" 
                               value="0"
                               onchange="updateReturnQuantity(${index}, this.value)">
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <button onclick="setFullReturn(${index})" 
                                style="padding: 6px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                            Hammasi
                        </button>
                    </td>
                </tr>
            `;
        });

        document.getElementById('productsTableBody').innerHTML = productsHtml;
    }

    function updateReturnQuantity(index, quantity) {
        const qty = parseInt(quantity) || 0;
        const maxQty = returnItems[index].sold_quantity;
        
        if (qty > maxQty) {
            showMessage(`‚ö†Ô∏è Qaytarish miqdori sotilgan miqdordan oshmasligi kerak! (Max: ${maxQty})`, 'warning');
            document.getElementById(`return_${index}`).value = maxQty;
            returnItems[index].return_quantity = maxQty;
        } else {
            returnItems[index].return_quantity = qty;
        }
    }

    function setFullReturn(index) {
        const maxQty = returnItems[index].sold_quantity;
        document.getElementById(`return_${index}`).value = maxQty;
        returnItems[index].return_quantity = maxQty;
    }

    // ESKI FUNKSIYA - ishlatilmaydi, lekin kodda qoldirilgan
    async function confirmReturnOld() {
        // Joylashuvni tekshirish
        if (!returnLocationId || !returnLocationType) {
            showMessage('‚ö†Ô∏è Iltimos, avval qaytarish joyini tanlang!', 'warning');
            return;
        }

        // Qaytariladigan mahsulotlarni tekshirish
        const itemsToReturn = returnItems.filter(item => item.return_quantity > 0);
        
        if (itemsToReturn.length === 0) {
            showMessage('‚ö†Ô∏è Hech qanday mahsulot tanlanmagan!', 'warning');
            return;
        }

        const confirmMsg = `${itemsToReturn.length} ta mahsulotni qaytarishni tasdiqlaysizmi?`;
        if (!confirm(confirmMsg)) {
            return;
        }

        try {
            const response = await fetch('/api/return-product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sale_id: currentSale.id,
                    items: itemsToReturn,
                    location_id: returnLocationId,
                    location_type: returnLocationType
                })
            });

            const data = await response.json();

            if (data.success) {
                showMessage('‚úÖ Mahsulotlar muvaffaqiyatli qaytarildi!', 'success');
                // Formani tozalash
                setTimeout(() => {
                    clearProductSelection();
                    document.getElementById('saleDetails').style.display = 'none';
                    currentSale = null;
                    returnItems = [];
                }, 2000);
            } else {
                showMessage('‚ùå Xatolik: ' + data.error, 'error');
            }
        } catch (error) {
            console.error('Xatolik:', error);
            showMessage('‚ùå Server bilan bog\'lanishda xatolik!', 'error');
        }
    }

    function getPaymentStatusText(status) {
        const statuses = {
            'paid': '‚úÖ To\'langan',
            'partial': '‚ö†Ô∏è Qisman to\'langan',
            'pending': '‚è≥ Kutilmoqda',
            'debt': 'üí≥ Qarzda'
        };
        return statuses[status] || status;
    }

    function showMessage(message, type) {
        const messageDiv = document.getElementById('messageDiv');
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'error' ? 'alert-error' : 'alert-warning';
        
        messageDiv.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
        
        setTimeout(() => {
            messageDiv.innerHTML = '';
        }, 5000);
    }

    // Savdo tafsilotlarini ko'rish
    async function viewSaleDetails(saleId) {
        try {
            const response = await fetch(`/api/sales/${saleId}`);
            const data = await response.json();

            if (!data.success) {
                showMessage('‚ùå Savdo topilmadi!', 'error');
                return;
            }

            const sale = data.sale;
            
            // Debug: API dan kelgan ma'lumotlarni console'ga chiqarish
            console.log('Sale data:', sale);
            console.log('Returned products:', sale.returned_products);
            console.log('Payment refunds:', sale.payment_refunds);
            
            // Qaytarilgan mahsulotlar ID larini olish
            const returnedProducts = sale.returned_products || [];
            const returnedProductIds = returnedProducts.map(rp => rp.product_id);
            
            console.log('Returned product IDs:', returnedProductIds);
            
            // Qaytarilgan to'lovlar
            const paymentRefunds = sale.payment_refunds || [];
            
            // Sana formati
            const saleDate = new Date(sale.sale_date).toLocaleString('uz-UZ', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });

            // Modal yaratish
            let modalHTML = `
                <div id="saleDetailsModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 10px; padding: 30px; max-width: 1200px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;">
                            <h2 style="margin: 0; color: #333;">üìã Savdo #${sale.id} tafsilotlari</h2>
                            <button onclick="closeSaleModal()" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 20px;">√ó</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Sana va vaqt</div>
                                <div style="font-weight: 600; color: #333;">${saleDate}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Mijoz</div>
                                <div style="font-weight: 600; color: #333;">${sale.customer_name || 'Noma\'lum'}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Sotuvchi</div>
                                <div style="font-weight: 600; color: #333;">${sale.seller_name || 'Admin'}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Holat</div>
                                <div>${getPaymentStatusBadge(sale)}</div>
                            </div>
                        </div>

                        <h3 style="margin: 20px 0 10px 0; color: #333; font-size: 16px;">üì¶ Mahsulotlar</h3>
                        <div style="overflow-x: auto; margin-bottom: 20px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Mahsulot</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6;">Miqdor</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #dee2e6;">Narx</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #dee2e6;">Summa</th>
                                    </tr>
                                </thead>
                                <tbody>`;
            
            sale.items.forEach(item => {
                // Debug: Har bir mahsulotni console'ga chiqarish
                console.log('Item product_id:', item.product_id, 'Type:', typeof item.product_id);
                console.log('Checking if', item.product_id, 'is in', returnedProductIds);
                
                // Qaytarilgan mahsulotni aniqlash
                const isReturned = returnedProductIds.includes(item.product_id);
                const returnedItem = returnedProducts.find(rp => rp.product_id === item.product_id);
                const returnedQty = returnedItem ? returnedItem.returned_quantity : 0;
                
                console.log('Is returned:', isReturned, 'Returned qty:', returnedQty);
                
                const rowStyle = isReturned ? 'background: #ffe6e6;' : '';
                const textColor = isReturned ? 'color: #dc3545;' : '';
                
                modalHTML += `
                                    <tr style="${rowStyle}">
                                        <td style="padding: 10px; border-bottom: 1px solid #f0f0f0; ${textColor}">
                                            ${item.product_name}
                                            ${isReturned ? '<span style="color: #dc3545; font-weight: 600; margin-left: 8px;">‚Ü©Ô∏è Qaytarilgan</span>' : ''}
                                        </td>
                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #f0f0f0; font-weight: 600; ${textColor}">
                                            ${item.quantity}
                                            ${isReturned ? `<span style="font-size: 11px; color: #dc3545;"> (-${returnedQty})</span>` : ''}
                                        </td>
                                        <td style="padding: 10px; text-align: right; border-bottom: 1px solid #f0f0f0; ${textColor}">$${parseFloat(item.unit_price).toFixed(2)}</td>
                                        <td style="padding: 10px; text-align: right; border-bottom: 1px solid #f0f0f0; font-weight: 600; ${textColor}">$${parseFloat(item.total_price).toFixed(2)}</td>
                                    </tr>`;
            });

            modalHTML += `
                                </tbody>
                            </table>
                        </div>`;
            
            // Qaytarilgan to'lovlarni ko'rsatish
            if (paymentRefunds.length > 0) {
                modalHTML += `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                            <h4 style="margin: 0 0 10px 0; color: #856404; font-size: 14px;">‚Ü©Ô∏è Qaytarilgan to'lovlar:</h4>`;
                
                paymentRefunds.forEach(refund => {
                    const paymentTypeNames = {
                        'cash': 'üíµ Naqd',
                        'click': 'üì± Click',
                        'terminal': 'üí≥ Terminal',
                        'debt': 'üìù Qarzdan'
                    };
                    const refundAmount = parseFloat(refund.refund_amount_usd || 0);
                    
                    modalHTML += `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span style="color: #856404;">${paymentTypeNames[refund.payment_type] || refund.payment_type}:</span>
                                <span style="font-weight: 600; color: #dc3545;">-$${refundAmount.toFixed(2)}</span>
                            </div>`;
                });
                
                modalHTML += `
                        </div>`;
            }

            modalHTML += `
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 6px; margin-top: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #666;">Jami summa:</span>
                                <span style="font-size: 18px; font-weight: 700; color: #007bff;">$${parseFloat(sale.total_amount).toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #666;">üíµ Naqd:</span>
                                <span style="font-weight: 600;">$${parseFloat(sale.cash_usd || 0).toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #666;">üì± Click:</span>
                                <span style="font-weight: 600;">$${parseFloat(sale.click_usd || 0).toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #666;">üí≥ Terminal:</span>
                                <span style="font-weight: 600;">$${parseFloat(sale.terminal_usd || 0).toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #dc3545; font-weight: 600;">üìù Qarz:</span>
                                <span style="font-weight: 700; color: #dc3545;">$${parseFloat(sale.debt_usd || 0).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>`;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
        } catch (error) {
            console.error('Xatolik:', error);
            showMessage('‚ùå Savdo tafsilotlarini yuklashda xatolik!', 'error');
        }
    }

    function closeSaleModal() {
        const modal = document.getElementById('saleDetailsModal');
        if (modal) {
            modal.remove();
        }
    }

    // Qaytarilgan mahsulotlar tarixini yuklash
    async function loadReturnHistory() {
        const tbody = document.getElementById('historyTableBody');
        tbody.innerHTML = `
            <tr>
                <td colspan="9" style="padding: 20px; text-align: center; color: #999;">
                    <span style="font-size: 16px;">‚è≥ Yuklanmoqda...</span>
                </td>
            </tr>`;

        try {
            const response = await fetch('/api/returned-products-history');
            const data = await response.json();

            if (data.success && data.history.length > 0) {
                tbody.innerHTML = '';
                data.history.forEach(item => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #f0f0f0';
                    row.innerHTML = `
                        <td style="padding: 12px;">${item.date}</td>
                        <td style="padding: 12px; text-align: center;">
                            <span style="background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-weight: 600;">#${item.sale_id}</span>
                        </td>
                        <td style="padding: 12px;">${item.product_name}</td>
                        <td style="padding: 12px; text-align: center;">
                            <span style="background: #fff3cd; padding: 4px 8px; border-radius: 4px; font-weight: 600;">${item.quantity} dona</span>
                        </td>
                        <td style="padding: 12px;">${item.location}</td>
                        <td style="padding: 12px;">${item.user}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600;">
                            <div style="color: #28a745; font-size: 15px; margin-bottom: 3px;">
                                $${item.amount_usd.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                            </div>
                            <div style="color: #666; font-size: 13px;">
                                ${item.amount_uzs.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})} so'm
                            </div>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="viewSaleDetails(${item.sale_id})" 
                                    style="padding: 6px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 13px;"
                                    title="Savdo tafsilotlarini ko'rish">
                                üëÅÔ∏è Savdo
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="padding: 20px; text-align: center; color: #999;">
                            <span style="font-size: 16px;">üì≠ Hozircha qaytarilgan mahsulotlar yo'q</span>
                        </td>
                    </tr>`;
            }
        } catch (error) {
            console.error('Tarixni yuklashda xatolik:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="padding: 20px; text-align: center; color: #dc3545;">
                        <span style="font-size: 16px;">‚ùå Tarixni yuklashda xatolik yuz berdi</span>
                    </td>
                </tr>`;
        }
    }

    // Sahifa yuklanganda tarixni yuklash
    document.addEventListener('DOMContentLoaded', function() {
        loadReturnHistory();
    });
</script>
{% endblock %}
