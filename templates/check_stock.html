{% extends "base.html" %}

{% block title %}Qoldiqni tekshirish{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Sahifa sarlavhasi -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header" style="background: #f8f9fa; padding: 1rem; border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="color: #000000; margin-bottom: 0.25rem; font-size: 1.5rem;">
                            <i class="fas fa-clipboard-check" style="margin-right: 0.3rem; color: #007bff;"></i>Qoldiqni tekshirish
                        </h2>
                        <p style="color: #6c757d; margin: 0; font-size: 0.9rem;">
                            Mahsulotlarning do'kon va omborlardagi qoldiqlarini tekshiring
                        </p>
                    </div>
                    <select id="locationSelect" style="padding: 0.5rem; margin-right: 1rem; border: 1px solid #ddd; border-radius: 25px; font-size: 0.9rem; min-width: 200px;">
                        <option value="">Joylashuvni tanlang...</option>
                    </select>
                    <button type="button" class="btn" onclick="startCheck()" style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 0.7rem 1.5rem; font-size: 1rem;">
                        <i class="fas fa-play" style="margin-right: 0.3rem;"></i>Tekshiruvni boshlash
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tekshiruv tarixi jadvali -->
    <div id="historySection" class="row mb-4" style="display: none;">
        <div class="col-12">
            <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <h3 style="color: #000; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <span>
                        <i class="fas fa-history" style="color: #007bff; margin-right: 0.5rem;"></i>
                        Tekshiruv tarixi
                    </span>
                    {% if session.role != 'sotuvchi' %}
                    <button onclick="clearHistory()" style="background: #dc3545; color: white; border: none; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem; cursor: pointer;">
                        <i class="fas fa-trash" style="margin-right: 0.3rem;"></i>Tozalash
                    </button>
                    {% endif %}
                </h3>
                <div style="background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #f8f9fa;">
                            <tr>
                                <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #ddd;">Sana va vaqt</th>
                                <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #ddd;">Foydalanuvchi</th>
                                <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #ddd;">Joylashuv</th>
                                <th style="padding: 1rem; text-align: center; border-bottom: 1px solid #ddd;">Tekshirildi</th>
                                <th style="padding: 1rem; text-align: center; border-bottom: 1px solid #ddd;">Xatoliklar</th>
                                <th style="padding: 1rem; text-align: center; border-bottom: 1px solid #ddd;">Amallar</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr>
                                <td colspan="6" style="padding: 2rem; text-align: center; color: #6c757d;">
                                    Hali hech qanday tekshiruv amalga oshirilmagan
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Tekshiruv tafsilotlari bo'limi -->
    <div id="historyDetailsSection" style="display: none; margin-top: 2rem;">
        <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 2px solid #f8f9fa; padding-bottom: 1rem;">
                <h2 style="color: #333; margin: 0; display: flex; align-items: center;">
                    <i class="fas fa-chart-line" style="color: #007bff; margin-right: 0.75rem;"></i>
                    Tekshiruv tafsilotlari
                </h2>
                <button onclick="closeHistoryDetails()" style="background: #6c757d; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 25px; font-size: 1rem; cursor: pointer; display: flex; align-items: center;">
                    <i class="fas fa-times" style="margin-right: 0.5rem;"></i>Yopish
                </button>
            </div>
            <div id="historyDetailsContent">
                <!-- Tafsilotlar shu yerga yuklanadi -->
            </div>
        </div>
    </div>

    <!-- Natijalar bo'limi -->
    <div id="resultsSection" style="display: none;">
        <div style="display: flex; width: 100%; gap: 0.5rem;">
            <!-- Chap tomon - Mahsulotlar jadvali -->
            <div style="flex: 0.67; width: 40%;">
                <h3 style="margin-bottom: 0.7rem; display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem;">
                    <span>
                        <i class="fas fa-boxes" style="margin-right: 0.4rem; color: #007bff;"></i>
                        Mahsulotlar
                    </span>
                    <span id="productCount" style="background: #007bff; color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem; font-weight: normal;">
                        0 ta mahsulot
                    </span>
                </h3>
                <!-- Qidiruv maydoni -->
                <div style="margin-bottom: 0.7rem;">
                    <input type="text" id="productSearchInput" placeholder="Qidirish (masalan: Mat gra weis)..." 
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem;"
                           onkeyup="handleProductSearchWithNav(event)" onkeydown="handleTableNavigation(event)">
                </div>
                <div style="width: 100%; overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem; table-layout: fixed;">
                        <thead>
                            <tr>
                                <th style="padding: 0.4rem; border-bottom: 1px solid #ddd; width: 55.2%;">Mahsulot nomi</th>
                                <th style="padding: 0.4rem; border-bottom: 1px solid #ddd; width: 15.8%;">Narxi</th>
                                <th style="padding: 0.4rem; border-bottom: 1px solid #ddd; width: 14.6%;">Miqdori</th>  
                                <th style="padding: 0.4rem; border-bottom: 1px solid #ddd; width: 14.4%;">Amallar</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <tr>
                                <td colspan="4" style="padding: 2rem; text-align: center; color: #6c757d;">
                                    Ma'lumotlar yuklanmoqda...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- O'ng tomon - Ikkinchi jadval -->
            <div style="flex: 1; width: 60%;">
                <h3 style="margin-bottom: 0.7rem; display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem;">
                    <span>
                        <i class="fas fa-chart-bar" style="margin-right: 0.4rem; color: #007bff;"></i>
                        Tekshirilgan mahsulotlar
                    </span>
                    <div style="display: flex; gap: 0.5rem;">
                        <span id="checkedProductCount" style="background: #28a745; color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem; font-weight: normal;">
                            0 ta tekshirildi
                        </span>
                        <span id="errorCount" onclick="showErrorDetails()" style="background: #dc3545; color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem; font-weight: normal; display: none; cursor: pointer;" title="Xatoliklar tafsilotini ko'rish uchun bosing">
                            0 ta xatolik
                        </span>
                        <button id="errorFilterBtn" onclick="toggleErrorFilter()" style="background: #ffc107; color: #212529; border: none; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem; font-weight: normal; cursor: pointer; display: none; margin-left: 0.5rem;" title="Faqat xatolikli mahsulotlarni ko'rsatish">
                            <i class="fas fa-filter" style="margin-right: 0.3rem;"></i>Xatoliklar filtri
                        </button>
                    </div>
                </h3>
                <!-- Qidiruv maydoni -->
                <div style="margin-bottom: 0.7rem;">
                    <input type="text" id="statisticsSearchInput" placeholder="Ko'rsatkichni qidiring..." 
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem;"
                           onkeyup="filterStatistics()">
                </div>
                <div style="width: 100%; overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 1rem; table-layout: fixed;">
                        <thead>
                            <tr>
                                <th style="padding: 0.5rem; border-bottom: 1px solid #ddd; width: 40%; font-size: 0.95rem;">Mahsulot nomi</th>
                                <th style="padding: 0.5rem; border-bottom: 1px solid #ddd; width: 12%; font-size: 0.95rem;">Narxi</th>
                                <th style="padding: 0.5rem; border-bottom: 1px solid #ddd; width: 8%; font-size: 0.95rem;">Tizimda</th>
                                <th style="padding: 0.5rem; border-bottom: 1px solid #ddd; width: 8%; font-size: 0.95rem;">Haqiqiy</th>
                                <th style="padding: 0.5rem; border-bottom: 1px solid #ddd; width: 18%; font-size: 0.95rem;">Xatolik</th>
                                <th style="padding: 0.5rem; border-bottom: 1px solid #ddd; width: 8%; font-size: 0.95rem;">Holat</th>
                                <th style="padding: 0.5rem; border-bottom: 1px solid #ddd; width: 6%; font-size: 0.95rem;">Amallar</th>
                            </tr>
                        </thead>
                        <tbody id="statisticsTableBody">
                            <tr>
                                <td colspan="7" style="padding: 2rem; text-align: center; color: #6c757d;">
                                    Hali hech qanday mahsulot tekshirilmagan
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>



    <!-- Modal oyna -->
    <div id="productModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; padding: 2rem; min-width: 400px; max-width: 500px;">
            <!-- Modal header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;">
                <h3 style="margin: 0; color: #000;">
                    <i class="fas fa-box" style="color: #007bff; margin-right: 0.5rem;"></i>
                    Mahsulot ma'lumotlari
                </h3>
                <span onclick="closeProductModal()" style="font-size: 1.5rem; cursor: pointer; color: #666;" title="Yopish">×</span>
            </div>
            
            <!-- Modal content -->
            <div id="modalContent">
                <div style="margin-bottom: 1rem;">
                    <strong style="color: #555;">Nomi:</strong>
                    <span id="modalProductName" style="margin-left: 0.5rem;">-</span>
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong style="color: #555;">Narxi:</strong>
                    <span id="modalProductPrice" style="margin-left: 0.5rem; color: #28a745; font-weight: bold;">-</span>
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <strong style="color: #555;">Miqdori:</strong>
                    <input type="number" id="modalProductQuantity" style="margin-left: 0.5rem; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 100px; font-weight: bold;" step="0.01" min="0">
                </div>
                
                <!-- Amallar -->
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="closeProductModal()" style="background: #6c757d; color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 4px; cursor: pointer; flex: 1;">
                        <i class="fas fa-times"></i> Bekor qilish
                    </button>
                    <button onclick="saveProductChanges()" style="background: #28a745; color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 4px; cursor: pointer; flex: 1;">
                        <i class="fas fa-save"></i> Saqlash
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
// Global o'zgaruvchilar
let allOriginalProducts = []; // Tekshiruv boshida barcha mahsulotlarni saqlab qo'yish uchun
const userRole = '{{ session.role }}'; // Foydalanuvchi roli

// Miqdorni to'g'ri formatda ko'rsatish funksiyasi
function formatQuantity(quantity) {
    const num = parseFloat(quantity);
    // Agar butun son bo'lsa, kasrli qismini ko'rsatmaslik
    if (num === Math.floor(num)) {
        return num.toString();
    }
    // Aks holda 2 ta kasr raqam bilan ko'rsatish
    return num.toFixed(2);
}

// HTML escape funksiyasi
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Edit tugmalariga event listener qo'shish funksiyasi
function attachEditButtonListeners() {
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('edit-product-btn')) {
            const btn = e.target;
            const productId = btn.getAttribute('data-product-id');
            const productName = btn.getAttribute('data-product-name');
            const productPrice = btn.getAttribute('data-product-price');
            const currentQuantity = parseFloat(btn.getAttribute('data-current-quantity'));
            const originalQuantity = parseFloat(btn.getAttribute('data-original-quantity'));
            
            editCheckedProduct(productId, productName, productPrice, currentQuantity, originalQuantity);
        }
    });
}

// Global o'zgaruvchilar
let productSearchInput, statisticsSearchInput;

// Sahifa yuklanganda joylashuvlarni yuklash va holatni tiklash
document.addEventListener('DOMContentLoaded', function() {
    loadLocations();
    
    // Edit tugmalariga event listener qo'shish
    attachEditButtonListeners();
    
    // Event delegation ni sozlash - sahifa yangilanganda ham ishlaydi
    setupEventDelegation();
    
    // Global o'zgaruvchilarni initialize qilish va tozalash
    productSearchInput = document.getElementById('productSearchInput');
    statisticsSearchInput = document.getElementById('statisticsSearchInput');
    if (productSearchInput) {
        productSearchInput.value = '';
    }
    if (statisticsSearchInput) {
        statisticsSearchInput.value = '';
    }
    
    // SetTimeout bilan biroz kechiktirib holatni tiklash (joylashuvlar yuklanishi uchun)
    setTimeout(() => {
        restorePageState();
    }, 1000);
    
    // Qidiruv maydoni faqat filtr vazifasini bajaradi, auto save kerak emas
    
    // Joylashuv o'zgarishida ham avtomatik saqlash va tarix jadvalini yangilash
    const locationSelect = document.getElementById('locationSelect');
    if (locationSelect) {
        locationSelect.addEventListener('change', function() {
            autoSave();
            // Tarix jadvalini filtrlash
            refreshHistoryTable();
        });
    }
});

// Do'kon va omborlarni yuklash + aktiv sessionlarni tekshirish
async function loadLocations() {
    const select = document.getElementById('locationSelect');
    
    // Avval aktiv sessionlarni yuklash
    let activeSessions = {};
    try {
        const response = await fetch('/api/get-active-sessions');
        const data = await response.json();
        if (data.sessions) {
            data.sessions.forEach(session => {
                const key = `${session.location_type}_${session.location_id}`;
                activeSessions[key] = session.user_name;
            });
        }
    } catch (error) {
        console.error('❌ Aktiv sessionlarni yuklab bo\'lmadi:', error);
    }
    
    // Do'konlarni yuklash
    fetch('/api/stores')
        .then(response => response.json())
        .then(data => {
            if (Array.isArray(data)) {
                data.forEach(store => {
                    const option = document.createElement('option');
                    const key = 'store_' + store.id;
                    option.value = key;
                    
                    // Agar bu joylashuv band bo'lsa
                    if (activeSessions[key]) {
                        option.textContent = `🏪 ${store.name} (${activeSessions[key]} tekshiryapti)`;
                        option.disabled = true;
                        option.style.color = '#999';
                        option.style.fontStyle = 'italic';
                    } else {
                        option.textContent = '🏪 ' + store.name;
                    }
                    
                    select.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Do\'konlarni yuklashda xatolik:', error));
    
    // Omborlarni yuklash
    fetch('/api/warehouses')
        .then(response => response.json())
        .then(data => {
            if (Array.isArray(data)) {
                data.forEach(warehouse => {
                    const option = document.createElement('option');
                    const key = 'warehouse_' + warehouse.id;
                    option.value = key;
                    
                    // Agar bu joylashuv band bo'lsa
                    if (activeSessions[key]) {
                        option.textContent = `🏭 ${warehouse.name} (${activeSessions[key]} tekshiryapti)`;
                        option.disabled = true;
                        option.style.color = '#999';
                        option.style.fontStyle = 'italic';
                    } else {
                        option.textContent = '🏭 ' + warehouse.name;
                    }
                    
                    select.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Omborlarni yuklashda xatolik:', error));
}

// Tekshiruvni boshlash yoki tugatish
async function startCheck() {
    const locationSelect = document.getElementById('locationSelect');
    const selectedValue = locationSelect.value;
    const button = document.querySelector('.btn');
    const resultsSection = document.getElementById('resultsSection');
    
    // Agar tugmada "Tekshiruvni tugatish" yozuvi bo'lsa
    if (button.innerHTML.includes('Tekshiruvni tugatish')) {
        // Tekshirilgan mahsulotlarni stokda yangilash va keyin tugmani o'zgartirish
        finalizeFinalStockUpdates(selectedValue, async function() {
            // Natijalarni yashirish
            resultsSection.style.display = 'none';
            
            // Tarix jadvalini qayta ko'rsatish (tekshiruv tugaganda)
            const historySection = document.getElementById('historySection');
            const history = getCheckHistory();
            if (historySection && history.length > 0) {
                historySection.style.display = 'block';
                refreshHistoryTable(); // Filtrlangan tarixni ko'rsatish
            }
            
            // Tugmani qaytarish
            button.innerHTML = '<i class="fas fa-play" style="margin-right: 0.3rem;"></i>Tekshiruvni boshlash';
            button.style.background = 'linear-gradient(135deg, #007bff, #0056b3)';
            
            // Joylashuv maydonini yoqing
            locationSelect.disabled = false;
            locationSelect.style.opacity = '1';
            locationSelect.style.cursor = 'pointer';
            
            // Holatni tozalash (reload qilmasdan)
            localStorage.removeItem('stockCheckState');
            
            // Server sessionni tugatish
            try {
                const [type, id] = selectedValue.split('_');
                await fetch('/api/end-stock-check', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        location_id: parseInt(id),
                        location_type: type,
                        status: 'completed'
                    })
                });
                console.log('✅ Session tugatildi');
            } catch (error) {
                console.error('❌ Session tugatishda xatolik:', error);
            }
            
            try {
                await clearServerSession();
            } catch (error) {
                console.error('❌ Server session tozalashda xatolik:', error);
            }
        });
        
        return;
    }
    
    // Tekshiruvni boshlash
    if (!selectedValue) {
        alert('Iltimos, joylashuvni tanlang!');
        return;
    }
    
    // Joylashuvni parse qilish
    const [type, id] = selectedValue.split('_');
    const locationName = locationSelect.options[locationSelect.selectedIndex].text.replace('🏪 ', '').replace('🏭 ', '');
    
    // Server sessionni boshlash
    try {
        const response = await fetch('/api/start-stock-check', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                location_id: parseInt(id),
                location_type: type,
                location_name: locationName
            })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            // Agar joylashuv band bo'lsa
            alert(data.error || 'Bu joylashuv hozir band');
            return;
        }
        
        console.log('✅ Session boshlandi');
        
        // Heartbeat boshlash (har 30 soniyada session aktiv ekanligini bildirish)
        window.sessionHeartbeat = setInterval(async () => {
            try {
                await fetch('/api/update-stock-check-session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        location_id: parseInt(id),
                        location_type: type
                    })
                });
            } catch (error) {
                console.error('❌ Heartbeat xatolik:', error);
            }
        }, 30000); // 30 soniya
        
    } catch (error) {
        console.error('❌ Session boshlashda xatolik:', error);
        alert('Xatolik yuz berdi. Iltimos qaytadan urinib ko\'ring.');
        return;
    }
    
    // Natijalar bo'limini ko'rsatish
    resultsSection.style.display = 'block';
    
    // Tarix bo'limini yashirish (tekshiruv boshlanayotganda tarix ko'rsatilmasin)
    const historySection = document.getElementById('historySection');
    if (historySection) {
        historySection.style.display = 'none';
    }
    
    // Xatoliklar hisoblagichini tozalash
    window.stockUpdateErrors = [];
    
    // Tugmani o'zgartirish
    button.innerHTML = '<i class="fas fa-stop" style="margin-right: 0.3rem;"></i>Tekshiruvni tugatish';
    button.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
    
    // Joylashuv maydonini o'chirish
    locationSelect.disabled = true;
    locationSelect.style.opacity = '0.5';
    locationSelect.style.cursor = 'not-allowed';
    
    // Tanlangan joylashuvga qarab ma'lumotlarni yuklash
    loadLocationData(selectedValue);
    
    // Holatni saqlash
    savePageState();
    
    // Mahsulotlar qidiruv maydoniga fokus berish (tekshiruv boshlanganida)
    setTimeout(function() {
        if (productSearchInput) {
            productSearchInput.focus();
        }
    }, 1000); // 1 sekund kutish (ma'lumotlar yuklanishi uchun)
}

// Joylashuv ma'lumotlarini yuklash
function loadLocationData(selectedValue) {
    const productsBody = document.getElementById('productsTableBody');
    const statisticsBody = document.getElementById('statisticsTableBody');
    
    // Qidiruv maydonlarini tozalash
    if (productSearchInput) {
        productSearchInput.value = '';
    }
    if (statisticsSearchInput) {
        statisticsSearchInput.value = '';
    }
    
    // Loading holati
    productsBody.innerHTML = '<tr><td colspan="3" style="padding: 2rem; text-align: center; color: #6c757d;">Ma\'lumotlar yuklanmoqda...</td></tr>';
    statisticsBody.innerHTML = '<tr><td colspan="6" style="padding: 2rem; text-align: center; color: #6c757d;">Ma\'lumotlar yuklanmoqda...</td></tr>';
    
    if (selectedValue === 'all') {
        // Barcha joylashuvlar
        loadAllLocationsData();
    } else {
        // Aniq joylashuv
        const [type, id] = selectedValue.split('_');
        loadSpecificLocationData(type, id);
    }
}

// Aniq joylashuv ma'lumotlari
function loadSpecificLocationData(type, id) {
    // show_zero=true parametrini qo'shish - 0 miqdorli mahsulotlar ham ko'rinsin
    const endpoint = `/api/stock-by-location?type=${type}&location_id=${id}&show_zero=true`;
    
    fetch(endpoint)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayProducts(data.data || []);
                calculateStatistics(data.data || []);
            } else {
                throw new Error(data.error || 'API xatoligi');
            }
        })
        .catch(error => {
            console.error('Ma\'lumot yuklashda xatolik:', error);
            document.getElementById('productsTableBody').innerHTML = '<tr><td colspan="3" style="padding: 2rem; text-align: center; color: #dc3545;">Ma\'lumot yuklashda xatolik yuz berdi</td></tr>';
            document.getElementById('statisticsTableBody').innerHTML = '<tr><td colspan="5" style="padding: 2rem; text-align: center; color: #dc3545;">Xatolik</td></tr>';
        });
}

// Barcha joylashuvlar ma'lumotlari
function loadAllLocationsData() {
    fetch('/api/stock-status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayProducts(data.data || []);
                calculateStatistics(data.data || []);
            } else {
                throw new Error(data.error || 'API xatoligi');
            }
        })
        .catch(error => {
            console.error('Ma\'lumot yuklashda xatolik:', error);
            document.getElementById('productsTableBody').innerHTML = '<tr><td colspan="3" style="padding: 2rem; text-align: center; color: #dc3545;">Ma\'lumot yuklashda xatolik yuz berdi</td></tr>';
            document.getElementById('statisticsTableBody').innerHTML = '<tr><td colspan="5" style="padding: 2rem; text-align: center; color: #dc3545;">Xatolik</td></tr>';
        });
}

// Mahsulotlarni ko'rsatish
function displayProducts(data) {
    const tbody = document.getElementById('productsTableBody');
    tbody.innerHTML = '';
    
    // Mahsulotlarni global o'zgaruvchiga saqlash (tekshiruv boshida)
    allOriginalProducts = data.map(item => ({
        id: String(item.product_id), // ID'ni string sifatida saqlash
        name: item.product_name,
        originalQuantity: parseFloat(item.quantity) || 0,
        quantity: parseFloat(item.quantity) || 0,
        isChecked: false
    }));
    

    

    
    if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="padding: 2rem; text-align: center; color: #6c757d;">Ma\'lumot topilmadi</td></tr>';
        return;
    }
    
    data.forEach(item => {
        const quantity = parseFloat(item.quantity) || 0;
        let statusClass = 'success';
        let statusText = 'Yetarli';
        
        if (quantity <= 0) {
            statusClass = 'danger';
            statusText = 'Tugagan';
        } else if (quantity <= 10) {
            statusClass = 'warning';
            statusText = 'Kam';
        }
        
        const row = document.createElement('tr');
        row.style.backgroundColor = '#ffffff'; // Oq fon
        const price = item.sell_price || item.price || 0;
        row.innerHTML = `
            <td style="padding: 0.6rem; border-bottom: 1px solid #eee; font-size: 1.1rem; font-weight: 500;">${item.product_name || item.name}</td>
            <td style="padding: 0.6rem; text-align: right; border-bottom: 1px solid #eee; font-weight: bold; color: #28a745;">$${Number(price).toFixed(2)}</td>
            <td style="padding: 0.6rem; text-align: right; border-bottom: 1px solid #eee; font-weight: bold;">${formatQuantity(quantity)}</td>
            <td style="padding: 0.6rem; text-align: center; border-bottom: 1px solid #eee;">
                <span style="font-size: 1.5rem; cursor: pointer;" onclick="openProductModal(${item.product_id}, '${item.product_name}', ${price}, ${quantity})" title="Tahrirlash">
                    ➡️
                </span>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Mahsulotlar sonini yangilash
    updateProductCount();
    
    // Mahsulotlar yuklangandan keyin qidiruv maydoniga fokus berish
    setTimeout(function() {
        if (productSearchInput) {
            productSearchInput.focus();
        }
    }, 100);
}

// Statistikani hisoblash
function calculateStatistics(data) {
    const tbody = document.getElementById('statisticsTableBody');
    tbody.innerHTML = '';
    
    // Statistika ma'lumotlari olib tashlandi - faqat tekshirilgan mahsulotlar ko'rsatiladi
}

// Mahsulotlarni qidirish
// Mahsulotlarni qidirish (eski funksiya - dropdown bilan almashtirildi)
function filterProducts() {
    const searchInput = document.getElementById('productSearchInput');
    const searchTerm = searchInput.value.toLowerCase();
    filterProductsTable(searchTerm);
}

// Statistikalarni qidirish
function filterStatistics() {
    const searchInput = document.getElementById('statisticsSearchInput');
    const searchTerm = searchInput.value.toLowerCase();
    const tableBody = document.getElementById('statisticsTableBody');
    const rows = tableBody.getElementsByTagName('tr');
    
    let visibleCount = 0;
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        
        // Agar bitta ustunli bo'lsa (xabar qatori), uni o'tkazib yuborish
        if (cells.length === 1) {
            continue;
        }
        
        if (cells.length > 0) {
            const indicatorName = cells[0].textContent.toLowerCase();
            
            if (indicatorName.includes(searchTerm)) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        }
    }
    
    // Agar hech narsa topilmasa, xabar ko'rsatish
    if (visibleCount === 0 && searchTerm !== '') {
        // Mavjud xabar qatorini olib tashlash
        const existingMessage = tableBody.querySelector('.no-statistics-results');
        if (existingMessage) {
            existingMessage.remove();
        }
        
        // Yangi xabar qatori qo'shish
        const messageRow = document.createElement('tr');
        messageRow.className = 'no-statistics-results';
        messageRow.innerHTML = `
            <td colspan="6" style="padding: 2rem; text-align: center; color: #6c757d;">
                <i class="fas fa-search fa-2x mb-2 d-block" style="color: #ddd;"></i>
                "${searchTerm}" uchun ko'rsatkich topilmadi
            </td>
        `;
        tableBody.appendChild(messageRow);
    } else {
        // Xabar qatorini olib tashlash
        const existingMessage = tableBody.querySelector('.no-statistics-results');
        if (existingMessage) {
            existingMessage.remove();
        }
    }
}

// Modal quantity input handler funksiyasi
function modalQuantityInputHandler(event) {
    const inputValue = event.target.value;
    const timestamp = new Date().toLocaleTimeString('uz-UZ', { timeZone: 'Asia/Tashkent', hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
    console.log(`⌨️ [${timestamp}] Modal input o'zgardi: "${inputValue}" (AUTO-SAVE O'CHIRILGAN)`);
    
    // Auto-save o'chirildi - faqat "Saqlash" tugmasi orqali saqlash
    // autoSave(); // DISABLED
}

// Modal oynani ochish
function openProductModal(productId, productName, price, quantity) {
    // Global o'zgaruvchi sifatida saqlash
    window.currentProductId = productId;
    window.originalQuantity = quantity; // Asl miqdorni saqlash
    
    // Modal ma'lumotlarini to'ldirish
    document.getElementById('modalProductName').textContent = productName;
    document.getElementById('modalProductPrice').textContent = `$${Number(price).toFixed(2)}`;
    document.getElementById('modalProductQuantity').value = formatQuantity(quantity);
    
    // Modal oynani ko'rsatish
    document.getElementById('productModal').style.display = 'block';
    
    // Input maydoniga focus berish
    document.getElementById('modalProductQuantity').focus();
    document.getElementById('modalProductQuantity').select();
    
    // Modal quantity input'iga auto-save event listener qo'shish
    const modalQuantityInput = document.getElementById('modalProductQuantity');
    
    // Eski event listener'larni olib tashlash
    modalQuantityInput.removeEventListener('input', modalQuantityInputHandler);
    
    // Yangi event listener qo'shish
    modalQuantityInput.addEventListener('input', modalQuantityInputHandler);
    
    // Input uchun keydown event listener
    const inputKeydownHandler = function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveProductChanges(); // Saqlash funksiyasini chaqirish
        }
    };
    
    // Modal uchun global Escape event listener
    const modalKeydownHandler = function(e) {
        if (e.key === 'Escape') {
            closeProductModal();
        }
    };
    
    // Event listener'larni qo'shish
    modalQuantityInput.removeEventListener('keydown', inputKeydownHandler);
    modalQuantityInput.addEventListener('keydown', inputKeydownHandler);
    
    if (window.currentModalKeydownHandler) {
        document.removeEventListener('keydown', window.currentModalKeydownHandler);
    }
    document.addEventListener('keydown', modalKeydownHandler);
    
    // Modal yopilganda olib tashlash uchun saqlash
    window.currentModalKeydownHandler = modalKeydownHandler;
    window.currentInputKeydownHandler = inputKeydownHandler;
}

// Modal oynani yopish
function closeProductModal() {
    document.getElementById('productModal').style.display = 'none';
    window.currentProductId = null;
    
    // Keyboard event listener'larni olib tashlash
    if (window.currentModalKeydownHandler) {
        document.removeEventListener('keydown', window.currentModalKeydownHandler);
        window.currentModalKeydownHandler = null;
    }
    
    if (window.currentInputKeydownHandler) {
        const modalQuantityInput = document.getElementById('modalProductQuantity');
        modalQuantityInput.removeEventListener('keydown', window.currentInputKeydownHandler);
        window.currentInputKeydownHandler = null;
    }
    
    // Fokusni mahsulotlar qidiruv maydoniga qaytarish
    setTimeout(() => {
        if (productSearchInput) {
            productSearchInput.focus();
        }
    }, 100);
}

// Mahsulot o'zgarishlarini saqlash
function saveProductChanges() {
    const timestamp = new Date().toLocaleTimeString('uz-UZ', { timeZone: 'Asia/Tashkent', hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
    console.log(`\n💾 [${timestamp}] ========== SAQLASH TUGMASI BOSILDI ==========`);
    
    const productId = window.currentProductId;
    if (!productId) return;
    
    const newQuantity = parseFloat(document.getElementById('modalProductQuantity').value);
    const originalQuantity = window.originalQuantity;
    const productName = document.getElementById('modalProductName').textContent;
    
    console.log(`   📦 Mahsulot: ${productName} (ID: ${productId})`);
    console.log(`   🔢 Asl miqdor: ${originalQuantity}`);
    console.log(`   🔢 Yangi miqdor: ${newQuantity}`);
    
    // Miqdor validation
    if (isNaN(newQuantity) || newQuantity < 0) {
        // Input qizil rangga o'tadi
        document.getElementById('modalProductQuantity').style.borderColor = '#dc3545';
        console.log(`   ❌ Validation xatolik: noto'g'ri miqdor`);
        return;
    } else {
        // Input rangini tiklash
        document.getElementById('modalProductQuantity').style.borderColor = '#ced4da';
    }
    
    const locationSelect = document.getElementById('locationSelect');
    const selectedValue = locationSelect.value;
    
    if (!selectedValue) return;
    
    const [type, locationId] = selectedValue.split('_');
    
    // Loading holatini ko'rsatish
    const saveButton = document.querySelector('button[onclick="saveProductChanges()"]');
    const originalButtonText = saveButton.innerHTML;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saqlanmoqda...';
    saveButton.disabled = true;
    
    // API endpoint ni tanlash
    let apiEndpoint;
    if (type === 'store') {
        apiEndpoint = `/edit_store_stock/${locationId}/${productId}`;
    } else {
        apiEndpoint = `/edit_stock/${locationId}/${productId}`;
    }
    
    // Server'ga POST so'rov yuborish
    const formData = new FormData();
    formData.append('quantity', newQuantity);
    
    console.log(`   🚀 1. BIRINCHI SO'ROV: /edit_*_stock (ma'lumot olish)`);
    
    fetch(apiEndpoint, {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        console.log(`   ✅ 1. Ma'lumot olindi`);
        
        // YANGI: Stokni darhol yangilash (ikkinchi so'rov)
        console.log(`   🚀 2. IKKINCHI SO'ROV: /api/update_*_stock (stok yangilash)`);
        
        let updateEndpoint;
        if (type === 'store') {
            updateEndpoint = `/api/update_store_stock/${locationId}/${productId}`;
        } else {
            updateEndpoint = `/api/update_warehouse_stock/${locationId}/${productId}`;
        }
        
        console.log(`      └─ Endpoint: ${updateEndpoint}`);
        console.log(`      └─ Yangi miqdor: ${newQuantity}`);
        
        const updateFormData = new FormData();
        updateFormData.append('quantity', newQuantity);
        
        return fetch(updateEndpoint, {
            method: 'POST',
            body: updateFormData
        });
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Stok yangilashda xatolik: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log(`   ✅ 2. STOK YANGILANDI!`);
        console.log(`      └─ Eski: ${data.old_quantity}`);
        console.log(`      └─ Yangi: ${data.new_quantity}`);
        console.log(`      └─ Message: ${data.message}`);
        
        // Modal oynani darhol yopish (tez javob uchun)
        closeProductModal();
        console.log(`   🚪 Modal oyna yopildi`);
        
        // Background'da boshqa operatsiyalarni bajarish
        setTimeout(() => {
            // Agar mahsulot allaqachon tekshirilgan bo'lsa, uni yangilash
            const isExistingProduct = updateExistingCheckedProduct(productId, productName, originalQuantity, newQuantity);
            
            if (isExistingProduct) {
                console.log(`   🔄 Mavjud mahsulot yangilandi`);
                // Tekshirilgan mahsulot yangilanganda ham chap jadvaldan o'chirish kerak
                removeProductFromMainTable(productId);
            } else {
                console.log(`   ➕ Yangi mahsulot qo'shildi`);
                // Yangi tekshirilgan mahsulot qo'shish
                addToCheckedProducts(productId, productName, originalQuantity, newQuantity);
                // Mahsulotni asosiy jadvaldan olib tashlash
                removeProductFromMainTable(productId);
            }
            
            // Statistikani kechiktirib yangilash (performance uchun)
            setTimeout(() => updateStatisticsAfterCheck(), 50);
            
            // Qidiruv maydonini tozalash va fokusni qaytarish
            if (productSearchInput) {
                productSearchInput.value = ''; // Qidiruv maydonini tozalash
                productSearchInput.focus();
                // Filtrni qayta ishlatish (barcha mahsulotlarni ko'rsatish)
                filterProducts('');
            }
        }, 10);
        
        // AutoSave darhol chaqirish (kechikishsiz)
        console.log(`   🔄 AutoSave chaqirilmoqda...`);
        autoSave();
        console.log(`========== SAQLASH JARAYONI TUGADI (STOK YANGILANDI!) ==========\n`);
    })
    .catch(error => {
        console.error('❌ Saqlashda xatolik:', error);
        alert('Saqlashda xatolik yuz berdi. Qaytadan urinib ko\'ring.');
    })
    .finally(() => {
        // Loading tugmani qaytarish
        saveButton.innerHTML = originalButtonText;
        saveButton.disabled = false;
    });
}

// Modal tashqarisiga bosilganda yopish
document.addEventListener('click', function(e) {
    const modal = document.getElementById('productModal');
    if (e.target === modal) {
        closeProductModal();
    }
});

// Tekshirilgan mahsulotlar ro'yxatiga qo'shish
function addToCheckedProducts(productId, productName, oldQuantity, newQuantity) {
    const tbody = document.getElementById('statisticsTableBody');
    
    // Birinchi tekshirilgan mahsulot bo'lsa, bo'sh xabarni olib tashlash
    if (tbody.children.length === 1 && tbody.children[0].children.length === 1) {
        tbody.innerHTML = '';
    }
    
    // Mahsulotning narxini olish (global o'zgaruvchidan yoki modal'dan)
    const priceElement = document.getElementById('modalProductPrice');
    const price = priceElement ? priceElement.textContent : '$0.00';
    
    // Mahsulot nomini JavaScript uchun escape qilish (faqat single quote)
    const escapedProductNameForJs = productName.replace(/'/g, "\\'");
    
    // Tekshirilgan mahsulot qatorini qo'shish
    const row = document.createElement('tr');
    row.style.backgroundColor = '#ffffff'; // Oq fon
    row.dataset.productId = productId; // Product ID ni data attribute sifatida saqlash
    row.dataset.originalQuantity = oldQuantity; // Asl miqdorni saqlash
    
    // Holat ma'lumotini aniqlash - miqdor farqini ko'rsatish
    let status;
    const difference = newQuantity - oldQuantity;
    const emojiColor = difference === 0 ? '#28a745' : '#dc3545';
    const emojiTitle = difference === 0 ? 'To\'g\'ri tekshirilgan' : 'Xatolik bor';
    
    if (difference === 0) {
        status = '<span style="color: #28a745; font-weight: bold;">✓ To\'g\'ri</span>';
    } else if (difference > 0) {
        status = `<span style="color: #17a2b8; font-weight: bold;">+${formatQuantity(difference)} ortiq</span>`;
    } else {
        status = `<span style="color: #dc3545; font-weight: bold;">${formatQuantity(difference)} kam</span>`;
    }
    
    row.innerHTML = `
        <td style="padding: 0.4rem; border-bottom: 1px solid #eee; font-size: 0.9rem;">
            <strong>${productName}</strong>
        </td>
        <td style="padding: 0.4rem; text-align: right; border-bottom: 1px solid #eee; font-weight: bold; color: #28a745; font-size: 0.9rem;">
            ${price}
        </td>
        <td style="padding: 0.4rem; text-align: center; border-bottom: 1px solid #eee; font-weight: bold; color: #6c757d; font-size: 0.9rem;">
            ${formatQuantity(oldQuantity)}
        </td>
        <td style="padding: 0.4rem; text-align: center; border-bottom: 1px solid #eee; font-weight: bold; ${difference === 0 ? 'color: #28a745;' : 'color: #dc3545;'}; font-size: 0.9rem;">
            ${formatQuantity(newQuantity)}
        </td>
        <td style="padding: 0.4rem; text-align: center; border-bottom: 1px solid #eee; font-size: 0.85rem;">
            ${difference === 0 ? 
                '<span style="color: #28a745; font-weight: bold;">✓ To\'g\'ri</span>' : 
                difference > 0 ?
                `<span style="color: #17a2b8; font-weight: bold;">+${Math.abs(difference)} ta ko'p</span>` :
                `<span style="color: #dc3545; font-weight: bold;">-${Math.abs(difference)} ta kam</span>`
            }
        </td>
        <td style="padding: 0.3rem; text-align: center; border-bottom: 1px solid #eee; font-size: 0.8rem;">
            ${difference === 0 ? 
                '<span style="color: #28a745; font-weight: bold;">✓</span>' : 
                '<span style="color: #dc3545; font-weight: bold;">❌</span>'
            }
        </td>
        <td style="padding: 0.3rem; text-align: center; border-bottom: 1px solid #eee;">
            <span class="edit-product-btn" 
                  style="font-size: 1rem; cursor: pointer; color: #007bff;" 
                  data-product-id="${productId}"
                  data-product-name="${productName}"
                  data-product-price="${price}"
                  data-current-quantity="${newQuantity}"
                  data-original-quantity="${oldQuantity}"
                  title="Qayta tahrirlash">
                ✏️
            </span>
        </td>
    `;
    
    // Yangi mahsulotni jadval boshiga qo'shish (tepada ko'rinadi)
    tbody.insertBefore(row, tbody.firstChild);
    
    // AllOriginalProducts da bu mahsulotni tekshirilgan deb belgilash
    const productIndex = allOriginalProducts.findIndex(p => String(p.id) === String(productId));
    if (productIndex !== -1) {
        allOriginalProducts[productIndex].isChecked = true;
        allOriginalProducts[productIndex].quantity = newQuantity; // Yangi miqdorni ham yangilash

    } else {
        // Agar topilmasa, mahsulotni qo'shish (localStorage'dan tiklangan holat uchun)
        allOriginalProducts.push({
            id: productId,
            name: productName,
            originalQuantity: parseFloat(oldQuantity) || 0,
            quantity: newQuantity,
            isChecked: true
        });
    }
    
    // Tekshirilgan mahsulotlar sonini yangilash
    updateCheckedProductCount();
    
    // Avtomatik saqlash
    console.log(`📊 [JADVAL] Yangi mahsulot qo'shildi: ${productName}`);
    autoSave();
}

// Mahsulotni asosiy jadvaldan olib tashlash
function removeProductFromMainTable(productId) {
    const tbody = document.getElementById('productsTableBody');
    if (!tbody) {
        return;
    }
    
    const rows = tbody.getElementsByTagName('tr');
    for (let j = 0; j < rows.length; j++) {
        const row = rows[j];
        const actionCell = row.cells[3];
        if (actionCell) {
            const cellHtml = actionCell.innerHTML;
            // openProductModal( dan keyin raqamni olish
            const match = cellHtml.match(/openProductModal\((\d+)/);
            if (match) {
                const foundId = match[1];
                const productNameCell = row.cells[0];
                const productName = productNameCell ? productNameCell.textContent.trim() : 'Unknown';
            }
        }
    }
    
    let productRemoved = false;
    
    for (let i = rows.length - 1; i >= 0; i--) {
        const row = rows[i];
        const actionCell = row.cells[3]; // Amallar ustuni
        
        if (actionCell) {
            const pattern1 = `openProductModal(${productId},`;
            const pattern2 = `openProductModal("${productId}",`;
            const pattern3 = `openProductModal('${productId}',`;
            const pattern4 = `openProductModal(${productId} `;
            
            if (actionCell.innerHTML.includes(pattern1) || 
                actionCell.innerHTML.includes(pattern2) || 
                actionCell.innerHTML.includes(pattern3) ||
                actionCell.innerHTML.includes(pattern4)) {
                row.remove();
                productRemoved = true;
                break;
            }
        }
    }
    
    // Debug information removed for performance
    
    // Agar jadvalda mahsulot qolmagan bo'lsa
    if (tbody.getElementsByTagName('tr').length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="padding: 2rem; text-align: center; color: #6c757d;">Barcha mahsulotlar tekshirildi!</td></tr>';
    }
    
    // Mahsulotlar sonini yangilash
    updateProductCount();
    
    // Avtomatik saqlash
    console.log(`🗑️ [JADVAL] Mahsulot o'chirildi: ID=${productId}`);
    autoSave();
}

// Statistikani yangilash
function updateStatisticsAfterCheck() {
    // Statistika yangilanmaydi, faqat tekshirilgan mahsulotlar ko'rsatiladi
}

// Sahifa holatini saqlash
function savePageState() {
    const timestamp = new Date().toLocaleTimeString('uz-UZ', { timeZone: 'Asia/Tashkent', hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
    console.log(`📦 [${timestamp}] savePageState() boshlandi`);
    
    const locationSelect = document.getElementById('locationSelect');
    const resultsSection = document.getElementById('resultsSection');
    const button = document.querySelector('.btn');
    
    // Asosiy holat
    const pageState = {
        selectedLocation: locationSelect.value,
        isCheckingActive: button.innerHTML.includes('Tekshiruvni tugatish'),
        resultsVisible: resultsSection.style.display === 'block'
    };
    
    console.log(`   📍 Joylashuv: ${pageState.selectedLocation}`);
    console.log(`   🔄 Tekshiruv faol: ${pageState.isCheckingActive}`);
    
    // Mahsulotlar jadvalidagi ma'lumotlarni saqlash
    const productsTableBody = document.getElementById('productsTableBody');
    const products = [];
    if (productsTableBody && productsTableBody.children.length > 0) {
        for (let row of productsTableBody.children) {
            if (row.children.length >= 4) {
                products.push({
                    name: row.children[0].textContent.trim(),
                    price: row.children[1].textContent.trim(),
                    quantity: row.children[2].textContent.trim(),
                    actions: row.children[3].innerHTML
                });
            }
        }
    }
    pageState.productsData = products;
    console.log(`   📦 Mahsulotlar: ${products.length} ta`);
    
    // Tekshirilgan mahsulotlar jadvalidagi ma'lumotlarni saqlash
    const statisticsTableBody = document.getElementById('statisticsTableBody');
    const checkedProducts = [];
    if (statisticsTableBody && statisticsTableBody.children.length > 0) {
        // Yuqoridan pastga o'qish (jadvalda qaysi tartibda bo'lsa, shunday saqlanadi)
        for (let row of statisticsTableBody.children) {
            if (row.children.length >= 6) { // 6 ta ustun bor endi
                checkedProducts.push({
                    id: row.dataset.productId, // Mahsulot ID sini saqlash
                    name: row.children[0].innerHTML,
                    price: row.children[1].textContent.trim(),
                    systemQuantity: row.children[2].textContent.trim(), // Tizimdagi miqdor
                    actualQuantity: row.children[3].textContent.trim(), // Haqiqiy miqdor
                    status: row.children[4].innerHTML, // Xatolik holati
                    actions: row.children[5].innerHTML, // Amallar
                    originalQuantity: row.dataset.originalQuantity // Asl miqdorni saqlash
                });
            }
        }
    }
    pageState.checkedProductsData = checkedProducts;
    console.log(`   ✅ Tekshirilgan: ${checkedProducts.length} ta`);
    
    // Qidiruv maydonlari har doim tozalanadi, saqlanmaydi
    
    // Local da saqlash (tez)
    localStorage.setItem('stockCheckState', JSON.stringify(pageState));
    const dataSize = JSON.stringify(pageState).length;
    const dataSizeKB = (dataSize / 1024).toFixed(2);
    console.log(`   💾 localStorage'ga saqlandi:`);
    console.log(`      └─ Hajm: ${dataSize} bytes (${dataSizeKB} KB)`);
    console.log(`      └─ Joy: Browser localStorage (offline ishlaydi)`);
    console.log(`      └─ Key: "stockCheckState"`);
    
    // Server-da ham saqlash (debounced) - barcha qurilmalar uchun
    if (pageState.isCheckingActive && pageState.selectedLocation) {
        debouncedServerSave(pageState);
        console.log(`   🌐 Server'ga yuborish rejalashtirildi:`);
        console.log(`      └─ URL: /api/stock-check-session/save`);
        console.log(`      └─ Database: PostgreSQL (dokon_db)`);
        console.log(`      └─ Jadval: stock_check_sessions`);
        console.log(`      └─ Maqsad: Barcha qurilmalarda sinxronlash`);
    }
    
    console.log(`✅ [${timestamp}] savePageState() tugadi`);
}

// Debounce timer
let saveTimeout = null;

// Avtomatik saqlash funksiyasi (debounced) - jadvalda o'zgarish bo'lganda darhol saqlash
function autoSave() {
    // Debug: Auto-save chaqirildi
    const timestamp = new Date().toLocaleTimeString('uz-UZ', { timeZone: 'Asia/Tashkent', hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
    console.log(`🔄 [${timestamp}] AUTO-SAVE chaqirildi`);
    
    // Oldingi timer ni bekor qilish
    if (saveTimeout) {
        clearTimeout(saveTimeout);
        console.log(`   ⏹️ Oldingi timer bekor qilindi`);
    }
    
    // Darhol saqlash (0ms - no delay)
    saveTimeout = setTimeout(() => {
        const saveTimestamp = new Date().toLocaleTimeString('uz-UZ', { timeZone: 'Asia/Tashkent', hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
        console.log(`💾 [${saveTimestamp}] ✅ Saqlash BOSHLANDI`);
        
        savePageState();
        // Real-time statistikani yangilash
        updateCheckedProductCount();
        
        const endTimestamp = new Date().toLocaleTimeString('uz-UZ', { timeZone: 'Asia/Tashkent', hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
        console.log(`✅ [${endTimestamp}] Saqlash TUGADI`);
    }, 0);
}

// Darhol saqlash funksiyasi (important actions uchun)
function immediateSave() {
    const timestamp = new Date().toLocaleTimeString('uz-UZ', { timeZone: 'Asia/Tashkent', hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
    console.log(`⚡ [${timestamp}] IMMEDIATE SAVE chaqirildi`);
    
    // Barcha timerlarni bekor qilish
    if (saveTimeout) {
        clearTimeout(saveTimeout);
        console.log(`   ⏹️ saveTimeout bekor qilindi`);
    }
    if (serverSaveTimeout) {
        clearTimeout(serverSaveTimeout);
        console.log(`   ⏹️ serverSaveTimeout bekor qilindi`);
    }
    
    // Darhol saqlash
    const pageState = getCurrentPageState();
    localStorage.setItem('stockCheckState', JSON.stringify(pageState));
    console.log(`   💾 LocalStorage'ga saqlandi`);
    
    if (pageState.isCheckingActive && pageState.selectedLocation) {
        debouncedServerSave(pageState, true); // immediate = true
        console.log(`   🌐 Server'ga yuborildi`);
    }
    
    updateCheckedProductCount();
    console.log(`✅ [${timestamp}] IMMEDIATE SAVE tugadi`);
}

// Hozirgi sahifa holatini olish
function getCurrentPageState() {
    const locationSelect = document.getElementById('locationSelect');
    const resultsSection = document.getElementById('resultsSection');
    const button = document.querySelector('.btn');
    
    return {
        selectedLocation: locationSelect?.value,
        isCheckingActive: button?.innerHTML.includes('Tekshiruvni tugatish'),
        resultsVisible: resultsSection?.style.display === 'block',
        productsData: getProductsData(),
        checkedProductsData: getCheckedProductsData()
    };
}

function getProductsData() {
    const productsTableBody = document.getElementById('productsTableBody');
    const products = [];
    if (productsTableBody && productsTableBody.children.length > 0) {
        for (let row of productsTableBody.children) {
            if (row.children.length >= 4) {
                products.push({
                    name: row.children[0].textContent.trim(),
                    price: row.children[1].textContent.trim(),
                    quantity: row.children[2].textContent.trim(),
                    actions: row.children[3].innerHTML
                });
            }
        }
    }
    return products;
}

function getCheckedProductsData() {
    const statisticsTableBody = document.getElementById('statisticsTableBody');
    const checkedProducts = [];
    if (statisticsTableBody && statisticsTableBody.children.length > 0) {
        // Yuqoridan pastga o'qish (jadvalda qaysi tartibda bo'lsa, shunday qaytadi)
        for (let row of statisticsTableBody.children) {
            if (row.children.length >= 6) {
                checkedProducts.push({
                    id: row.dataset.productId,
                    name: row.children[0].innerHTML,
                    price: row.children[1].textContent.trim(),
                    systemQuantity: row.children[2].textContent.trim(),
                    actualQuantity: row.children[3].textContent.trim(),
                    status: row.children[4].innerHTML,
                    actions: row.children[5].innerHTML,
                    originalQuantity: row.dataset.originalQuantity
                });
            }
        }
    }
    return checkedProducts;
}

// Server session'ni tozalash
async function clearServerSession() {
    try {
        const response = await fetch('/api/stock-check-session/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        // Server session successfully cleared
    } catch (error) {
        console.error('❌ Server session tozalashda xatolik:', error);
    }
}

// Debug: localStorage va server session'ni tozalash funksiyasi
async function clearLocalStorage() {
    // localStorage tozalash
    localStorage.removeItem('stockCheckState');
    
    // Server session'ni ham tozalash
    await clearServerSession();
    
    location.reload();
}

// Eski ma'lumotlarni migration qilish
function migrateOldData(pageState) {
    // Agar checkedProductsData mavjud bo'lsa va ustunlar kam bo'lsa
    if (pageState.checkedProductsData && pageState.checkedProductsData.length > 0) {
        pageState.checkedProductsData = pageState.checkedProductsData.map(product => {
            // Agar yangi field'lar mavjud bo'lmasa, eski field'lardan yaratish
            if (!product.systemQuantity && !product.actualQuantity) {
                const originalQty = parseFloat(product.originalQuantity) || parseFloat(product.quantity) || 0;
                const currentQty = parseFloat(product.quantity) || 0;
                
                return {
                    ...product,
                    systemQuantity: formatQuantity(originalQty),
                    actualQuantity: formatQuantity(currentQty),
                    // Status ustuni uchun yangi ma'lumot qo'shish
                    status: product.status || (originalQty === currentQty ? 
                        '<span style="color: #28a745; font-weight: bold;">✓ To\'g\'ri</span>' : 
                        '<span style="color: #dc3545; font-weight: bold;">❌ Xato</span>')
                };
            }
            return product;
        });
    }
    
    return pageState;
}

// Server save debounce timer
let serverSaveTimeout = null;

// Debounced server save
function debouncedServerSave(pageState, immediate = false) {
    const timestamp = new Date().toLocaleTimeString('uz-UZ', { timeZone: 'Asia/Tashkent', hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
    
    // Oldingi timer ni bekor qilish
    if (serverSaveTimeout) {
        clearTimeout(serverSaveTimeout);
        console.log(`   ⏹️ [${timestamp}] Oldingi server save timer bekor qilindi`);
    }
    
    if (immediate) {
        // Darhol saqlash
        console.log(`   ⚡ [${timestamp}] Server'ga DARHOL yuborilmoqda...`);
        saveToServer(pageState);
    } else {
        // 3 soniya kutish (server save uchun)
        console.log(`   ⏳ [${timestamp}] Server'ga 3 soniyadan keyin yuboriladi (debounce)`);
        serverSaveTimeout = setTimeout(() => {
            saveToServer(pageState);
        }, 3000);
    }
}

// Server-da holatni saqlash
async function saveToServer(pageState) {
    const startTime = new Date();
    const timestamp = startTime.toLocaleTimeString('uz-UZ', { timeZone: 'Asia/Tashkent', hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
    console.log(`\n🌐 [${timestamp}] ========== SERVER'GA SAQLASH BOSHLANDI ==========`);
    
    try {
        const selectedLocation = pageState.selectedLocation;
        let location_type = null;
        let location_id = null;
        
        if (selectedLocation && selectedLocation !== 'all') {
            if (selectedLocation.startsWith('store-')) {
                location_type = 'store';
                location_id = parseInt(selectedLocation.replace('store-', ''));
            } else if (selectedLocation.startsWith('warehouse-')) {
                location_type = 'warehouse';
                location_id = parseInt(selectedLocation.replace('warehouse-', ''));
            } else {
                // Eski format: store_1, warehouse_2
                const parts = selectedLocation.split('_');
                if (parts.length === 2) {
                    location_type = parts[0];
                    location_id = parseInt(parts[1]);
                }
            }
        } else {
            location_type = 'all';
        }
        
        console.log(`   📍 Joylashuv: ${location_type}_${location_id}`);
        console.log(`   📦 Ma'lumot hajmi: ${JSON.stringify(pageState).length} bytes`);
        
        const requestData = {
            session_data: pageState,
            location_type: location_type,
            location_id: location_id
        };
        
        console.log(`   🚀 POST so'rov yuborilmoqda: /api/stock-check-session/save`);
        
        const response = await fetch('/api/stock-check-session/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_data: pageState,
                location_type: location_type,
                location_id: location_id
            })
        });
        
        const result = await response.json();
        const endTime = new Date();
        const duration = endTime - startTime;
        
        if (response.status === 403) {
            // Access denied - foydalanuvchiga tushunarli xabar
            console.error('🚫 Access denied:', result.error);
            alert(`🚫 Xavfsizlik xabari: ${result.error}\n\nSiz faqat o'zingizga ruxsat berilgan do'kon/omborlarda tekshiruv qila olasiz.`);
            
            // Location selectni reset qilish
            document.getElementById('locationSelect').value = '';
            return;
        } else if (result.success) {
            // Server-da saqlandi
            console.log(`   ✅ Server javob berdi: SUCCESS`);
            console.log(`   ⏱️ Davomiyligi: ${duration}ms`);
            console.log(`   💾 Saqlangan joy: PostgreSQL database`);
            console.log(`   📊 Jadval: stock_check_sessions`);
            console.log(`========== SERVER'GA SAQLASH TUGADI ==========\n`);
        } else {
            console.warn('⚠️ Server-da saqlashda muammo:', result.error);
        }
    } catch (error) {
        const endTime = new Date();
        const duration = endTime - startTime;
        console.error('❌ Server-da saqlashda xatolik:', error);
        console.error('🔍 Error details:', error.message);
        console.error(`⏱️ Xatolik yuz berguncha: ${duration}ms`);
        console.log(`========== SERVER'GA SAQLASH XATOLIK BILAN TUGADI ==========\n`);
    }
}

// Server-dan holatni yuklash
async function loadFromServer() {
    // Server-dan holat yuklanmoqda
    
    try {
        const response = await fetch('/api/stock-check-session/load');
        
        const result = await response.json();
        
        if (response.status === 403) {
            // Access denied - session deactivated
            console.error('🚫 Session access denied:', result.error);
            if (result.session_deactivated) {
                alert(`🚫 Xavfsizlik xabari: ${result.error}\n\nSizning eski session'ingiz xavfsizlik sabablariga ko'ra o'chirildi.`);
            }

            return null;
        } else if (result.success && result.session_data) {
            // Server-dan muvaffaqiyatli yuklandi

            return result.session_data;
        } else {


            return null;
        }
    } catch (error) {
        console.error('❌ Server-dan yuklashda xatolik:', error);
        console.error('🔍 Error details:', error.message);

        return null;
    }
}

// Sahifa holatini tiklash
async function restorePageState() {
    const startTime = performance.now();
    const timestamp = new Date().toLocaleTimeString('uz-UZ', { timeZone: 'Asia/Tashkent', hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
    console.log(`\n🔄 [${timestamp}] ========== HOLAT TIKLASH BOSHLANDI ==========`);
    
    let pageState = null;
    let fromLocalStorage = false;
    
    // OPTIMIZATSIYA: Avval localStorage'dan tez yuklash (10-50ms)
    const localStartTime = performance.now();
    console.log(`   ⚡ localStorage'dan tez yuklash (PRIMARY)...`);
    
    const savedState = localStorage.getItem('stockCheckState');
    if (savedState) {
        try {
            pageState = JSON.parse(savedState);
            const localEndTime = performance.now();
            const localDuration = (localEndTime - localStartTime).toFixed(2);
            const dataSize = (savedState.length / 1024).toFixed(2);
            console.log(`   ✅ localStorage'dan yuklandi (${localDuration}ms, ${dataSize} KB) - FAST!`);
            fromLocalStorage = true;
        } catch (error) {
            console.error(`   ❌ localStorage parse xatolik:`, error);
        }
    } else {
        console.log(`   ℹ️ localStorage'da ma'lumot yo'q`);
    }
    
    // Server'dan background'da yangilash (sync uchun)
    if (pageState && fromLocalStorage) {
        console.log(`   🔄 Server'dan background sync boshlandi...`);
        // Background'da server'dan yuklash (await qilmasdan)
        loadFromServer().then(serverState => {
            if (serverState) {
                const serverTimestamp = new Date().toLocaleTimeString('uz-UZ', { timeZone: 'Asia/Tashkent', hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
                console.log(`   🌐 [${serverTimestamp}] Background sync tugadi - server ma'lumoti yangilandi`);
                
                // Agar server ma'lumoti boshqa bo'lsa, hohlasangiz yangilashingiz mumkin
                // Hozircha localStorage ustunlik qiladi (tezlik uchun)
            }
        }).catch(error => {
            console.warn(`   ⚠️ Background server sync xatolik:`, error);
        });
    } else {
        // Agar localStorage'da yo'q bo'lsa, server'dan yuklash (FALLBACK)
        const serverStartTime = performance.now();
        try {
            console.log(`   🌐 Server'dan yuklanmoqda (FALLBACK)...`);
            pageState = await loadFromServer();
            const serverEndTime = performance.now();
            const serverDuration = (serverEndTime - serverStartTime).toFixed(2);
            
            if (pageState) {
                console.log(`   ✅ Server'dan yuklandi (${serverDuration}ms)`);
            } else {
                console.log(`   ℹ️ Server'da ma'lumot yo'q (${serverDuration}ms)`);
                console.log(`========== TIKLASH TUGADI (${(performance.now() - startTime).toFixed(2)}ms) ==========\n`);
                return;
            }
        } catch (error) {
            const serverEndTime = performance.now();
            const serverDuration = (serverEndTime - serverStartTime).toFixed(2);
            console.warn(`   ⚠️ Server-dan yuklashda xatolik (${serverDuration}ms):`, error);
            console.log(`========== TIKLASH XATOLIK BILAN TUGADI (${(performance.now() - startTime).toFixed(2)}ms) ==========\n`);
            return;
        }
    }
    
    // Agar hech qaysi joyda ma'lumot bo'lmasa
    if (!pageState) {
        console.log(`   ℹ️ Hech qayerda ma'lumot topilmadi`);
        console.log(`========== TIKLASH TUGADI (${(performance.now() - startTime).toFixed(2)}ms) ==========\n`);
        return;
    }
    
    try {
        console.log(`   ⚙️ Ma'lumotlarni qayta ishlash boshlandi...`);
        const processStartTime = performance.now();
        
        // Eski ma'lumotlarni migration qilish
        pageState = migrateOldData(pageState);
        const locationSelect = document.getElementById('locationSelect');
        const resultsSection = document.getElementById('resultsSection');
        const button = document.querySelector('.btn');
        
        // Joylashuvni tiklash
        if (pageState.selectedLocation) {
            console.log(`   📍 Joylashuv tiklanmoqda: ${pageState.selectedLocation}`);
            locationSelect.value = pageState.selectedLocation;
        }
        
        // Agar tekshiruv faol bo'lsa
        if (pageState.isCheckingActive && pageState.selectedLocation) {
            console.log(`   🔄 Tekshiruv faol - UI tiklanmoqda...`);
            
            // Tugmani o'zgartirish
            button.innerHTML = '<i class="fas fa-stop" style="margin-right: 0.3rem;"></i>Tekshiruvni tugatish';
            button.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
            
            // Joylashuv maydonini o'chirish
            locationSelect.disabled = true;
            locationSelect.style.opacity = '0.5';
            locationSelect.style.cursor = 'not-allowed';
            
            // Tarix bo'limini yashirish (tekshiruv faol bo'lganda)
            const historySection = document.getElementById('historySection');
            if (historySection) {
                historySection.style.display = 'none';
            }
            
            // Natijalarni ko'rsatish
            if (pageState.resultsVisible) {
                console.log(`   📊 Natijalar ko'rsatilmoqda...`);
                resultsSection.style.display = 'block';
                
                // Saqlangan jadval ma'lumotlarini tiklash
                if (pageState.productsData && pageState.productsData.length > 0) {
                    const tableStartTime = performance.now();
                    console.log(`   📦 Mahsulotlar jadvali tiklanmoqda (${pageState.productsData.length} ta)...`);
                    restoreProductsTable(pageState.productsData);
                    const tableEndTime = performance.now();
                    console.log(`   ✅ Mahsulotlar jadvali tiklandi (${(tableEndTime - tableStartTime).toFixed(2)}ms)`);
                }
                
                if (pageState.checkedProductsData && pageState.checkedProductsData.length > 0) {
                    const checkedTableStartTime = performance.now();
                    console.log(`   ✅ Tekshirilgan jadval tiklanmoqda (${pageState.checkedProductsData.length} ta)...`);
                    
                    // Ma'lumotlarni 7-ustunli format uchun tekshirish va to'g'irlash
                    const validatedData = pageState.checkedProductsData.map(product => {
                        // Asosiy ma'lumotlarni tekshirish
                        if (!product.systemQuantity || !product.actualQuantity) {
                            const originalQty = parseFloat(product.originalQuantity) || parseFloat(product.quantity) || 0;
                            const currentQty = parseFloat(product.quantity) || 0;
                            
                            return {
                                ...product,
                                systemQuantity: formatQuantity(originalQty),
                                actualQuantity: formatQuantity(currentQty),
                                id: product.id || Date.now() + Math.random() // ID yo'q bo'lsa random qo'shish
                            };
                        }
                        return product;
                    });
                    
                    restoreCheckedProductsTable(validatedData);
                    const checkedTableEndTime = performance.now();
                    console.log(`   ✅ Tekshirilgan jadval tiklandi (${(checkedTableEndTime - checkedTableStartTime).toFixed(2)}ms)`);
                    
                    // Event delegation'ni qayta sozlash (jadval tiklangandan keyin)
                    setTimeout(() => {
                        setupEventDelegation();
                    }, 100);
                } else {
                    console.log(`   🔄 Tekshirilgan mahsulotlar yo'q - API'dan yuklanmoqda...`);
                    // API'dan yangi ma'lumotlarni yuklash
                    loadLocationData(pageState.selectedLocation);
                }
            }
        }
        
        const processEndTime = performance.now();
        const processDuration = (processEndTime - processStartTime).toFixed(2);
        console.log(`   ⚙️ Ma'lumotlar qayta ishlandi (${processDuration}ms)`);
        
        // Qidiruv maydonlarini tiklash
        if (pageState.searchStates) {
            const productSearchInput = document.getElementById('productSearchInput');
            const statisticsSearchInput = document.getElementById('statisticsSearchInput');
            
            if (productSearchInput && pageState.searchStates.productSearch) {
                productSearchInput.value = pageState.searchStates.productSearch;
                // Qidiruv filterni qo'llash
                filterProducts();
            }
            
            if (statisticsSearchInput && pageState.searchStates.statisticsSearch) {
                statisticsSearchInput.value = pageState.searchStates.statisticsSearch;
                // Statistika qidiruvini qo'llash
                filterStatistics();
            }
        }
        
        // Sahifa holati tiklangandan keyin fokus berish
        setTimeout(function() {
            const productSearchInput = document.getElementById('productSearchInput');
            if (productSearchInput) {
                productSearchInput.focus();
            }
        }, 600); // Biroz ko'proq kutish (barcha ma'lumotlar tiklangunch)
        
        const totalDuration = (performance.now() - startTime).toFixed(2);
        console.log(`✅ [${timestamp}] ========== HOLAT TIKLASH TUGADI (${totalDuration}ms) ==========\n`);


        
    } catch (error) {
        const totalDuration = (performance.now() - startTime).toFixed(2);
        console.error(`❌ Sahifa holatini tiklashda xatolik (${totalDuration}ms):`, error);
        console.error('🔍 Error details:', error.message, error.stack);
        
        // Xatolik bo'lsa, holatni tozalash
        localStorage.removeItem('stockCheckState');
        console.log(`========== TIKLASH XATOLIK BILAN TUGADI (${totalDuration}ms) ==========\n`);
    }
}

// Mahsulotlar jadvalini tiklash
function restoreProductsTable(productsData) {
    const startTime = performance.now();
    console.log(`      🔧 restoreProductsTable() boshlandi (${productsData.length} mahsulot)...`);
    
    const tbody = document.getElementById('productsTableBody');
    tbody.innerHTML = '';
    
    // Batch insert uchun fragment ishlatish (tezroq)
    const fragment = document.createDocumentFragment();
    
    productsData.forEach((product, index) => {
        const row = document.createElement('tr');
        row.style.backgroundColor = '#ffffff'; // Oq fon
        row.innerHTML = `
            <td style="padding: 0.6rem; border-bottom: 1px solid #eee; font-size: 1.1rem; font-weight: 500;">${product.name}</td>
            <td style="padding: 0.6rem; text-align: right; border-bottom: 1px solid #eee; font-weight: bold; color: #28a745;">${product.price}</td>
            <td style="padding: 0.6rem; text-align: right; border-bottom: 1px solid #eee; font-weight: bold;">${product.quantity}</td>
            <td style="padding: 0.6rem; text-align: center; border-bottom: 1px solid #eee;">${product.actions}</td>
        `;
        fragment.appendChild(row);
    });
    
    tbody.appendChild(fragment);
    
    // Mahsulotlar sonini yangilash
    updateProductCount();
    
    const endTime = performance.now();
    const duration = (endTime - startTime).toFixed(2);
    console.log(`      ✅ restoreProductsTable() tugadi (${duration}ms, avg: ${(duration/productsData.length).toFixed(2)}ms/item)`);
    
    // Mahsulotlar tiklangandan keyin fokus berish
    setTimeout(function() {
        const productSearchInput = document.getElementById('productSearchInput');
        if (productSearchInput) {
            productSearchInput.focus();
        }
    }, 100);
}

// Tekshirilgan mahsulotlar jadvalini tiklash
function restoreCheckedProductsTable(checkedProductsData) {
    const startTime = performance.now();
    console.log(`      🔧 restoreCheckedProductsTable() boshlandi (${checkedProductsData.length} mahsulot)...`);
    
    const tbody = document.getElementById('statisticsTableBody');
    tbody.innerHTML = '';
    
    // Batch insert uchun fragment ishlatish (tezroq)
    const fragment = document.createDocumentFragment();
    
    // Ma'lumotlarni to'g'ridan-to'g'ri qo'shish (array'da qaysi tartibda bo'lsa, shunday)
    checkedProductsData.forEach((product, index) => {
        const row = document.createElement('tr');
        row.style.backgroundColor = '#ffffff';
        
        // Mahsulot ID va asl miqdorni tiklash
        if (product.id) {
            row.dataset.productId = product.id;
        }
        if (product.originalQuantity) {
            row.dataset.originalQuantity = product.originalQuantity;
        }
        
        // Mahsulot nomini olish (HTML taglardan tozalangan, lekin to'liq matn saqlanadi)
        const cleanProductName = product.name.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();
        
        // Yangi 7 ustun struktura uchun ma'lumotlarni aniqlash
        const systemQuantity = product.systemQuantity || product.originalQuantity || parseFloat(product.quantity);
        const actualQuantity = product.actualQuantity || parseFloat(product.quantity);
        const difference = actualQuantity - systemQuantity;
        
        // Xatolik ma'lumotini aniqlash
        let errorInfo;
        if (difference === 0) {
            errorInfo = '<span style="color: #28a745; font-weight: bold;">✓ To\'g\'ri</span>';
        } else if (difference > 0) {
            errorInfo = `<span style="color: #17a2b8; font-weight: bold;">+${Math.abs(difference)} ta ko'p</span>`;
        } else {
            errorInfo = `<span style="color: #dc3545; font-weight: bold;">-${Math.abs(difference)} ta kam</span>`;
        }
        
        // Holat ma'lumotini aniqlash
        let status;
        if (difference === 0) {
            status = '<span style="color: #28a745; font-weight: bold;">✓ To\'g\'ri</span>';
        } else {
            status = '<span style="color: #dc3545; font-weight: bold;">❌ Xato</span>';
        }
        
        row.innerHTML = `
            <td style="padding: 0.4rem; border-bottom: 1px solid #eee; font-size: 0.9rem;">
                <strong>${cleanProductName}</strong>
            </td>
            <td style="padding: 0.4rem; text-align: right; border-bottom: 1px solid #eee; font-weight: bold; color: #28a745; font-size: 0.9rem;">
                ${product.price}
            </td>
            <td style="padding: 0.4rem; text-align: center; border-bottom: 1px solid #eee; font-weight: bold; color: #6c757d; font-size: 0.9rem;">
                ${formatQuantity(systemQuantity)}
            </td>
            <td style="padding: 0.4rem; text-align: center; border-bottom: 1px solid #eee; font-weight: bold; ${difference === 0 ? 'color: #28a745;' : 'color: #dc3545;'}; font-size: 0.9rem;">
                ${formatQuantity(actualQuantity)}
            </td>
            <td style="padding: 0.4rem; text-align: center; border-bottom: 1px solid #eee; font-size: 0.85rem;">
                ${errorInfo}
            </td>
            <td style="padding: 0.3rem; text-align: center; border-bottom: 1px solid #eee; font-size: 0.8rem;">
                ${status}
            </td>
            <td style="padding: 0.3rem; text-align: center; border-bottom: 1px solid #eee;">
                <span class="edit-product-btn" 
                      style="font-size: 1rem; cursor: pointer; color: #007bff;" 
                      data-product-id="${product.id}"
                      data-product-name="${cleanProductName}"
                      data-product-price="${product.price}"
                      data-current-quantity="${actualQuantity}"
                      data-original-quantity="${systemQuantity}"
                      title="Qayta tahrirlash">
                    ✏️
                </span>
            </td>
        `;
        fragment.appendChild(row);
    });
    
    tbody.appendChild(fragment);
    
    // Tekshirilgan mahsulotlar sonini yangilash
    updateCheckedProductCount();
    
    const endTime = performance.now();
    const duration = (endTime - startTime).toFixed(2);
    console.log(`      ✅ restoreCheckedProductsTable() tugadi (${duration}ms, avg: ${(duration/checkedProductsData.length).toFixed(2)}ms/item)`);
}

// Tekshiruv tugatilganda barcha tekshirilgan mahsulotlarni stokda yangilash
function finalizeFinalStockUpdates(selectedLocation, callback) {
    console.log(`\n🏁 ========== TEKSHIRUV TUGATISH VA STOK YANGILASH ==========`);
    console.log(`   📍 Joylashuv: ${selectedLocation}`);
    
    const statisticsTableBody = document.getElementById('statisticsTableBody');
    if (!statisticsTableBody) {
        console.error('❌ statisticsTableBody topilmadi');
        return;
    }
    
    if (statisticsTableBody.children.length === 0) {
        console.log(`   ℹ️ Tekshirilgan mahsulotlar yo'q`);
        // Callback chaqirish (bo'sh bo'lsa ham)
        if (callback && typeof callback === 'function') {
            callback();
        }
        return;
    }
    
    const [type, locationId] = selectedLocation.split('_');
    console.log(`   🔧 Type: ${type}, Location ID: ${locationId}`);

    
    let updateCount = 0;
    let totalProducts = 0;
    
    // Tekshirilgan mahsulotlar ro'yxatini olish
    const checkedProducts = [];
    
    for (let i = 0; i < statisticsTableBody.children.length; i++) {
        const row = statisticsTableBody.children[i];
        
        if (row.children.length >= 7 && row.dataset.productId) {
            const productId = row.dataset.productId;
            const productName = row.children[0].querySelector('strong')?.textContent || row.children[0].textContent.split('\n')[0];
            const quantity = parseFloat(row.children[3].textContent) || 0; // Haqiqiy ustuni (4-chi)
            const originalQuantity = parseFloat(row.dataset.originalQuantity) || 0;
            
            const productData = {
                id: productId,
                name: productName.trim(),
                quantity: quantity,
                originalQuantity: originalQuantity
            };
            
            console.log(`   📦 Mahsulot ${totalProducts + 1}: ${productName.trim()}`);
            console.log(`      └─ ID: ${productId}`);
            console.log(`      └─ Yangi miqdor: ${quantity}`);
            console.log(`      └─ Asl miqdor: ${originalQuantity}`);
            
            checkedProducts.push(productData);
            totalProducts++;
        } else {
            console.warn(`   ⚠️ Qator ${i}: Ma'lumot to'liq emas`);
        }
    }
    
    console.log(`\n   📊 JAMI: ${checkedProducts.length} ta mahsulot yangilanadi`);

    
    if (checkedProducts.length === 0) {

        // Callback chaqirish (yangilanadigan mahsulot bo'lmasa ham)
        if (callback && typeof callback === 'function') {
            callback();
        }
        return;
    }
    
    // Loading holatini ko'rsatish
    const button = document.querySelector('.btn');
    const originalButtonText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Stok yangilanmoqda...';
    button.disabled = true;
    

    
    // Statuslarni funksiya darajasida e'lon qilish
    let finalCheckStatus = 'success';
    let finalResultMessage = '';
    let finalErrorCount = 0;
    
    // Har bir tekshirilgan mahsulotni stokda yangilash
    Promise.allSettled(
        checkedProducts.map(product => 
            updateFinalProductStock(product.id, product.name, product.quantity, type, locationId)
        )
    ).then(results => {
        // Natijalarni hisoblash
        let errorCount = 0;
        window.stockUpdateErrors = []; // Xatoliklar ro'yxatini tozalash
        
        results.forEach((result, index) => {
            if (result.status === 'fulfilled') {
                updateCount++;

            } else {
                finalErrorCount++;
                const errorInfo = {
                    productName: checkedProducts[index].name,
                    error: result.reason
                };
                window.stockUpdateErrors.push(errorInfo);
                console.error(`❌ ${checkedProducts[index].name}: yangilashda xatolik -`, result.reason);
            }
        });
        
        // Natija xabari va statusni belgilash
        if (updateCount > 0 && finalErrorCount === 0) {
            finalResultMessage = `✅ Tekshiruv muvaffaqiyatli yakunlandi!\n${updateCount}/${totalProducts} mahsulot stokda yangilandi.`;
            finalCheckStatus = 'success';
        } else if (updateCount > 0 && finalErrorCount > 0) {
            finalResultMessage = `⚠️ Tekshiruv yakunlandi!\n✅ ${updateCount}/${totalProducts} mahsulot yangilandi\n❌ ${finalErrorCount} ta xatolik yuz berdi`;
            finalCheckStatus = 'warning';
        } else {
            finalResultMessage = `❌ Hech bir mahsulot stokda yangilanmadi.\n${finalErrorCount} ta xatolik yuz berdi. Qaytadan urinib ko'ring.`;
            finalCheckStatus = 'error';
        }
        
        // Statistikani yangilash
        updateCheckedProductCount();
        
        // Natija xabari
        alert(finalResultMessage);
        
    }).catch(error => {
        console.error('Stokni yangilashda umumiy xatolik:', error);
        console.error('Xatolik turi:', typeof error);
        console.error('Xatolik stack:', error.stack);
        console.error('Xatolik message:', error.message);
        alert('❌ Stokni yangilashda xatolik yuz berdi: ' + (error.message || error));
    }).finally(() => {
        // Tarixga qo'shish - real statistika bilan + BARCHA mahsulotlar (tekshirilgan va tekshirilmagan)
        try {
            const realErrorCount = getCurrentErrorCount();
            const realCheckedCount = getCurrentCheckedCount();
            
            // Barcha mahsulotlarni olish (tekshirilgan va tekshirilmagan)

            const allProductsForHistory = getAllProductsForHistory();


            allProductsForHistory.forEach((product, index) => {
                console.log(`  ${index + 1}. ${product.name} - isChecked: ${product.isChecked} (${typeof product.isChecked}), originalQuantity: ${product.originalQuantity}, quantity: ${product.quantity}`);
            });
            
            addToHistory(selectedLocation, realCheckedCount || totalProducts, realErrorCount || finalErrorCount, finalCheckStatus, allProductsForHistory);
        } catch (historyError) {
            console.error('Tarix qo\'shishda xatolik:', historyError);
        }
        
        // Tugmani qaytarish
        button.innerHTML = originalButtonText;
        button.disabled = false;
        
        // Callback funksiyasini chaqirish (tekshiruv tugallangandan keyin)
        if (callback && typeof callback === 'function') {
            callback();
        }
    });
}

// Bitta mahsulotning stokini yangilash (faqat miqdor)
function updateFinalProductStock(productId, productName, newQuantity, locationType, locationId) {
    console.log(`🔄 ${productName} uchun stok yangilash boshlandi:`, {
        productId,
        productName,
        newQuantity,
        locationType,
        locationId
    });
    
    return new Promise((resolve, reject) => {
        // Stokni yangilash API endpoint (yangi endpoint)
        let updateEndpoint;
        if (locationType === 'store') {
            updateEndpoint = `/api/update_store_stock/${locationId}/${productId}`;
        } else {
            updateEndpoint = `/api/update_warehouse_stock/${locationId}/${productId}`;
        }
        

        
        const formData = new FormData();
        formData.append('quantity', newQuantity);
        

        
        fetch(updateEndpoint, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log(`📥 ${productName} uchun server javobi:`, {
                status: response.status,
                statusText: response.statusText,
                ok: response.ok
            });
            
            if (response.ok) {

                resolve(`${productName} stokda yangilandi: ${newQuantity}`);
            } else {
                console.error(`❌ ${productName} uchun server xatoligi:`, response.status, response.statusText);
                throw new Error(`Server xatoligi: ${response.status} ${response.statusText}`);
            }
        })
        .catch(error => {
            console.error(`💥 ${productName} uchun fetch xatoligi:`, error);
            reject(`${productName} uchun xatolik: ${error.message}`);
        });
    });
}

// Mahsulotlar sonini yangilash
function updateProductCount() {
    const tbody = document.getElementById('productsTableBody');
    const countElement = document.getElementById('productCount');
    
    if (!tbody || !countElement) return;
    
    // Haqiqiy mahsulot qatorlarini sanash (xabar qatorlarini hisobga olmaslik)
    const productRows = Array.from(tbody.children).filter(row => {
        return row.children.length === 4 && 
               !row.textContent.includes('Ma\'lumot topilmadi') && 
               !row.textContent.includes('Barcha mahsulotlar tekshirildi');
    });
    
    const count = productRows.length;
    countElement.textContent = `${count} ta mahsulot`;
}

// Tekshirilgan mahsulotlar sonini yangilash
function updateCheckedProductCount() {
    const tbody = document.getElementById('statisticsTableBody');
    const countElement = document.getElementById('checkedProductCount');
    const errorCountElement = document.getElementById('errorCount');
    
    if (!tbody || !countElement) return;
    
    // Haqiqiy tekshirilgan mahsulot qatorlarini sanash (endi 7 ta ustun bor)
    // Faqat ko'rinadigan qatorlarni hisobga olish
    const checkedRows = Array.from(tbody.children).filter(row => {
        return row.children.length >= 7 && row.dataset.productId && row.style.display !== 'none';
    });
    
    // Jami tekshirilgan mahsulotlar (yashirilganlarni ham hisobga olish)
    const allCheckedRows = Array.from(tbody.children).filter(row => {
        return row.children.length >= 7 && row.dataset.productId;
    });
    
    const totalCount = allCheckedRows.length;
    
    // Jami xatoliklar sonini hisoblash (holat ustunida "✓" belgisi yo'q mahsulotlar)
    let errorCount = 0;
    allCheckedRows.forEach(row => {
        const statusCell = row.children[5]; // Holat ustuni (6-chi ustun, index 5)

        if (statusCell && !statusCell.innerHTML.includes("✓")) {

            errorCount++;
        } else {

        }
    });
    
    // Tekshirilgan mahsulotlar sonini yangilash
    countElement.textContent = `${totalCount} ta tekshirildi`;
    
    // Xatoliklar sonini va filtr tugmasini yangilash
    const errorFilterBtn = document.getElementById('errorFilterBtn');
    if (errorCountElement) {
        if (errorCount > 0) {
            errorCountElement.style.display = 'inline-block';
            errorCountElement.textContent = `${errorCount} ta xatolik`;
            // Xatoliklar filtri tugmasini ko'rsatish
            if (errorFilterBtn) {
                errorFilterBtn.style.display = 'inline-block';
            }
        } else {
            errorCountElement.style.display = 'none';
            // Xatoliklar filtri tugmasini yashirish
            if (errorFilterBtn) {
                errorFilterBtn.style.display = 'none';
            }
        }
    }
}

// Global xatoliklar hisoblagichi
window.stockUpdateErrors = [];

// Xatoliklar tafsilotini ko'rsatish
function showErrorDetails() {
    const tbody = document.getElementById('statisticsTableBody');
    if (!tbody) {
        alert('Jadval topilmadi.');
        return;
    }
    
    // Xatolikli mahsulotlarni topish
    const errorProducts = [];
    Array.from(tbody.children).forEach(row => {
        if (row.children.length >= 7 && row.dataset.productId) {
            const productName = row.children[0].textContent.trim();
            const statusCell = row.children[5]; // Holat ustuni (6-chi ustun, index 5)
            

            if (statusCell && !statusCell.innerHTML.includes("✓")) {
                const statusText = statusCell.textContent.trim();

                errorProducts.push({
                    name: productName,
                    status: statusText
                });
            }
        }
    });
    
    if (errorProducts.length === 0) {
        alert('Barcha mahsulotlar to\'g\'ri tekshirilgan! ✅');
        return;
    }
    
    let errorMessage = `Xatolikli mahsulotlar (${errorProducts.length} ta):\n\n`;
    errorProducts.forEach((product, index) => {
        errorMessage += `${index + 1}. ${product.name}\n   Holat: ${product.status}\n\n`;
    });
    
    alert(errorMessage);
}

// Tekshirilgan mahsulotni qayta tahrirlash
function editCheckedProduct(productId, productName, price, currentQuantity, originalQuantity) {
    console.log('🔄 Tekshirilgan mahsulotni qayta tahrirlash:', {
        productId, productName, price, currentQuantity, originalQuantity
    });
    
    // Modal oynani ochish (mavjud modal'dan foydalanish)
    window.currentProductId = productId;
    window.originalQuantity = originalQuantity || currentQuantity; // Asl stok miqdori
    
    // Modal ma'lumotlarini to'ldirish
    document.getElementById('modalProductName').textContent = productName;
    document.getElementById('modalProductPrice').textContent = price;
    document.getElementById('modalProductQuantity').value = formatQuantity(currentQuantity);
    
    console.log('Modal ma\'lumotlari to\'ldirildi:', {
        modalProductName: document.getElementById('modalProductName').textContent,
        modalProductPrice: document.getElementById('modalProductPrice').textContent,
        modalQuantity: document.getElementById('modalProductQuantity').value
    });
    
    // Modal oynani ko'rsatish
    document.getElementById('productModal').style.display = 'block';
    
    // Input maydoniga focus berish
    document.getElementById('modalProductQuantity').focus();
    document.getElementById('modalProductQuantity').select();
    
    // Modal quantity input'iga auto-save event listener qo'shish
    const modalQuantityInput = document.getElementById('modalProductQuantity');
    
    // Eski event listener'larni olib tashlash
    modalQuantityInput.removeEventListener('input', modalQuantityInputHandler);
    
    // Yangi event listener qo'shish
    modalQuantityInput.addEventListener('input', modalQuantityInputHandler);
}

// Mavjud tekshirilgan mahsulotni yangilash
function updateExistingCheckedProduct(productId, productName, oldQuantity, newQuantity) {
    const tbody = document.getElementById('statisticsTableBody');
    if (!tbody) {
        return false;
    }
    
    // Mahsulotni topish
    for (let i = 0; i < tbody.children.length; i++) {
        const row = tbody.children[i];
        
        const currentRowId = String(row.dataset.productId);
        const searchId = String(productId);
        
        if (currentRowId === searchId) {
            
            // Asl miqdorni yangilash
            row.dataset.originalQuantity = oldQuantity;
            
            const priceElement = document.getElementById('modalProductPrice');
            const price = priceElement ? priceElement.textContent : '$0.00';
            
            // Mahsulot nomini JavaScript uchun escape qilish (faqat single quote)
            const escapedProductNameForJs = productName.replace(/'/g, "\\'");
            
            // Holat ma'lumotini aniqlash - miqdor farqini ko'rsatish
            let status;
            const difference = newQuantity - oldQuantity;
            const emojiColor = difference === 0 ? '#28a745' : '#dc3545';
            const emojiTitle = difference === 0 ? 'To\'g\'ri tekshirilgan' : 'Xatolik bor';
            
            if (difference === 0) {
                status = '<span style="color: #28a745; font-weight: bold;">✓ To\'g\'ri</span>';
            } else if (difference > 0) {
                status = `<span style="color: #17a2b8; font-weight: bold;">+${formatQuantity(difference)} ortiq</span>`;
            } else {
                status = `<span style="color: #dc3545; font-weight: bold;">${formatQuantity(difference)} kam</span>`;
            }
            
            // Xatolik ma'lumotini aniqlash
            let errorInfo;
            if (difference === 0) {
                errorInfo = '<span style="color: #28a745; font-weight: bold;">✓ To\'g\'ri</span>';
            } else if (difference > 0) {
                errorInfo = `<span style="color: #17a2b8; font-weight: bold;">+${Math.abs(difference)} ta ko'p</span>`;
            } else {
                errorInfo = `<span style="color: #dc3545; font-weight: bold;">-${Math.abs(difference)} ta kam</span>`;
            }
            
            // Holat ma'lumotini aniqlash
            let statusInfo;
            if (difference === 0) {
                statusInfo = '<span style="color: #28a745; font-weight: bold;">✓</span>';
            } else {
                statusInfo = '<span style="color: #dc3545; font-weight: bold;">❌</span>';
            }
            
            // Qatorni yangilash
            row.innerHTML = `
                <td style="padding: 0.4rem; border-bottom: 1px solid #eee; font-size: 0.9rem;">
                    <strong>${productName}</strong>
                </td>
                <td style="padding: 0.4rem; text-align: right; border-bottom: 1px solid #eee; font-weight: bold; color: #28a745; font-size: 0.9rem;">
                    ${price}
                </td>
                <td style="padding: 0.4rem; text-align: center; border-bottom: 1px solid #eee; font-weight: bold; color: #6c757d; font-size: 0.9rem;">
                    ${formatQuantity(oldQuantity)}
                </td>
                <td style="padding: 0.4rem; text-align: center; border-bottom: 1px solid #eee; font-weight: bold; ${difference === 0 ? 'color: #28a745;' : 'color: #dc3545;'}; font-size: 0.9rem;">
                    ${formatQuantity(newQuantity)}
                </td>
                <td style="padding: 0.4rem; text-align: center; border-bottom: 1px solid #eee; font-size: 0.85rem;">
                    ${errorInfo}
                </td>
                <td style="padding: 0.3rem; text-align: center; border-bottom: 1px solid #eee; font-size: 0.8rem;">
                    ${statusInfo}
                </td>
                <td style="padding: 0.3rem; text-align: center; border-bottom: 1px solid #eee;">
                    <span class="edit-product-btn" 
                          style="font-size: 1rem; cursor: pointer; color: #007bff;" 
                          data-product-id="${productId}"
                          data-product-name="${productName}"
                          data-product-price="${price}"
                          data-current-quantity="${newQuantity}"
                          data-original-quantity="${oldQuantity}"
                          title="Qayta tahrirlash">
                        ✏️
                    </span>
                </td>
            `;
            
            // AllOriginalProducts da bu mahsulotni yangilash
            const productIndex = allOriginalProducts.findIndex(p => String(p.id) === String(productId));
            if (productIndex !== -1) {
                allOriginalProducts[productIndex].isChecked = true;
                allOriginalProducts[productIndex].quantity = newQuantity; // Yangi miqdorni ham yangilash
            } else {
                // Agar topilmasa, mahsulotni qo'shish
                allOriginalProducts.push({
                    id: productId,
                    name: productName,
                    originalQuantity: parseFloat(oldQuantity) || 0,
                    quantity: newQuantity,
                    isChecked: true
                });
            }
            
            // Statistikani yangilash
            updateCheckedProductCount();
            
            // Avtomatik saqlash
            console.log(`✏️ [JADVAL] Mahsulot yangilandi: ${productName} (${oldQuantity} → ${newQuantity})`);
            autoSave();
            
            return true; // Mahsulot yangilandi
        }
    }
    
    return false; // Mahsulot topilmadi
}

// Global filtr holati
window.errorFilterActive = false;

// Xatoliklar filtrini yoqish/o'chirish
function toggleErrorFilter() {
    const filterBtn = document.getElementById('errorFilterBtn');
    const tbody = document.getElementById('statisticsTableBody');
    
    if (!filterBtn || !tbody) return;
    
    window.errorFilterActive = !window.errorFilterActive;
    
    if (window.errorFilterActive) {
        // Filtrni yoqish - faqat xatolikli mahsulotlarni ko'rsatish
        filterBtn.style.background = '#28a745';
        filterBtn.style.color = 'white';
        filterBtn.innerHTML = '<i class="fas fa-filter" style="margin-right: 0.3rem;"></i>Xatoliklar ko\'rsatilmoqda';
        filterBtn.title = 'Barcha mahsulotlarni ko\'rsatish';
        
        // Barcha qatorlarni tekshirish va faqat xatoliklilarni ko'rsatish
        Array.from(tbody.children).forEach(row => {
            if (row.children.length >= 6 && row.dataset.productId) {
                const statusCell = row.children[5]; // Holat ustuni (6-chi ustun, index 5)

                const hasError = statusCell && !statusCell.innerHTML.includes("✓");
                
                if (hasError) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
        
    } else {
        // Filtrni o'chirish - barcha mahsulotlarni ko'rsatish
        filterBtn.style.background = '#ffc107';
        filterBtn.style.color = '#212529';
        filterBtn.innerHTML = '<i class="fas fa-filter" style="margin-right: 0.3rem;"></i>Xatoliklar filtri';
        filterBtn.title = 'Faqat xatolikli mahsulotlarni ko\'rsatish';
        
        // Barcha qatorlarni ko'rsatish
        Array.from(tbody.children).forEach(row => {
            if (row.children.length >= 6 && row.dataset.productId) {
                row.style.display = '';
            }
        });
    }
    
    // Filtr o'zgartirilgandan keyin statistikani yangilash
    updateCheckedProductCount();
}

// Joriy tekshirilgan mahsulotlar sonini olish
function getCurrentCheckedCount() {
    const tbody = document.getElementById('statisticsTableBody');
    if (!tbody) return 0;
    
    const checkedRows = Array.from(tbody.children).filter(row => {
        return row.children.length >= 6 && row.dataset.productId;
    });
    

    return checkedRows.length;
}

// Joriy xatoliklar sonini olish
function getCurrentErrorCount() {
    const tbody = document.getElementById('statisticsTableBody');
    if (!tbody) return 0;
    
    const checkedRows = Array.from(tbody.children).filter(row => {
        return row.children.length >= 6 && row.dataset.productId;
    });
    
    let errorCount = 0;
    checkedRows.forEach(row => {
        const statusCell = row.children[5]; // Holat ustuni (6-chi ustun, index 5)

        if (statusCell && !statusCell.innerHTML.includes("✓")) {

            errorCount++;
        }
    });
    

    return errorCount;
}

// Barcha mahsulotlarni tarixga saqlash uchun olish funksiyasi
function getAllProductsForHistory() {



    
    // Global o'zgaruvchidagi barcha mahsulotlarni nusxalash
    const allProducts = [...allOriginalProducts];
    
    // 1. Tekshirilgan mahsulotlarni yangilash (statisticsTableBody dan)
    const statisticsTableBody = document.getElementById('statisticsTableBody');


    
    if (statisticsTableBody) {
        for (let i = 0; i < statisticsTableBody.children.length; i++) {
            const row = statisticsTableBody.children[i];
            if (row.children.length >= 6 && row.dataset.productId) {
                const productId = row.dataset.productId;
                const productName = row.children[0].querySelector('strong')?.textContent || row.children[0].textContent.split('\n')[0];
                const systemQuantity = parseFloat(row.dataset.originalQuantity) || 0;
                const actualQuantity = parseFloat(row.children[3].textContent) || 0; // Haqiqiy ustuni
                
                // Global arrayda bu mahsulotni topib yangilash
                const productIndex = allProducts.findIndex(p => p.id == productId);
                if (productIndex !== -1) {
                    allProducts[productIndex] = {
                        id: productId,
                        name: productName.trim(),
                        originalQuantity: systemQuantity,
                        quantity: actualQuantity,
                        isChecked: true
                    };
                    

                }
            }
        }
    }
    
    console.log(`📊 Jami mahsulotlar: ${allProducts.length} ta (${allProducts.filter(p => p.isChecked).length} tekshirilgan, ${allProducts.filter(p => !p.isChecked).length} tekshirilmagan)`);

    return allProducts;
}

// Tarixga tekshiruvni qo'shish
function addToHistory(location, checkedCount, errorCount, status, products = []) {
    console.log('📊 addToHistory ga kelgan ma\'lumotlar:', {
        location, checkedCount, errorCount, status, products
    });


    products.forEach((product, index) => {

    });
    
    const history = getCheckHistory();
    const now = new Date();
    
    // Joylashuv nomini olish
    const locationSelect = document.getElementById('locationSelect');
    const locationText = locationSelect.options[locationSelect.selectedIndex]?.text || location;
    
    // Mahsulotlar ma'lumotini yaratish - system_quantity va actual_quantity bilan + isChecked field
    const processedProducts = products.map(product => {

        
        const systemQuantity = product.originalQuantity || 0;
        const actualQuantity = product.quantity || 0;
        const isChecked = product.isChecked !== undefined ? product.isChecked : true; // Default true (eski format uchun)
        

        
        return {
            id: product.id,
            name: product.name,
            system_quantity: systemQuantity,
            actual_quantity: actualQuantity,
            isChecked: isChecked
        };
    });
    


    
    const historyItem = {
        id: Date.now(),
        date: now.toLocaleDateString('uz-UZ'),
        time: now.toLocaleTimeString('uz-UZ', { timeZone: 'Asia/Tashkent', hour: '2-digit', minute: '2-digit' }),
        user: 'Admin', // Default user - bu keyinroq authentication qo'shilganda o'zgartiriladi
        location: locationText,
        checkedCount: checkedCount,
        errorCount: errorCount,
        status: status,
        products: processedProducts
    };
    

    
    history.unshift(historyItem); // Boshiga qo'shish (eng yangi birinchi)
    
    // Faqat oxirgi 10 ta tekshiruvni saqlash
    if (history.length > 10) {
        history.splice(10);
    }
    
    localStorage.setItem('stockCheckHistory', JSON.stringify(history));
    console.log('💾 localStorage ga saqlandi:', JSON.stringify(historyItem, null, 2));
    console.log('💾 localStorage dagi barcha tarix:', JSON.stringify(history, null, 2));
    
    refreshHistoryTable();
    showHistorySection();
}

// Tarixni localStorage dan olish
function getCheckHistory() {
    const history = localStorage.getItem('stockCheckHistory');
    return history ? JSON.parse(history) : [];
}

// Tarix jadvalini yangilash
function refreshHistoryTable() {
    const history = getCheckHistory();

    const tbody = document.getElementById('historyTableBody');
    
    // Joylashuv filtrini tekshirish
    const locationSelect = document.getElementById('locationSelect');
    const selectedLocation = locationSelect ? locationSelect.options[locationSelect.selectedIndex]?.text : null;
    
    // Filtrlangan tarixni olish
    let filteredHistory = history;
    if (selectedLocation && selectedLocation !== 'Joylashuvni tanlang') {
        filteredHistory = history.filter(item => item.location === selectedLocation);

    }
    
    if (filteredHistory.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="padding: 2rem; text-align: center; color: #6c757d;">
                    ${selectedLocation && selectedLocation !== 'Joylashuvni tanlang' 
                        ? `"${selectedLocation}" joylashuvi uchun tekshiruv tarixi topilmadi`
                        : 'Hali hech qanday tekshiruv amalga oshirilmagan'
                    }
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = '';
    filteredHistory.forEach(item => {
        const row = document.createElement('tr');
        
        // Holat rangi
        let statusColor = '';
        let statusText = '';
        let statusIcon = '';
        
        switch(item.status) {
            case 'success':
                statusColor = '#28a745';
                statusText = 'Muvaffaqiyatli';
                statusIcon = '✅';
                break;
            case 'warning':
                statusColor = '#ffc107';
                statusText = 'Xatoliklar bilan';
                statusIcon = '⚠️';
                break;
            case 'error':
                statusColor = '#dc3545';
                statusText = 'Xatolik';
                statusIcon = '❌';
                break;
        }
        
        row.innerHTML = `
            <td style="padding: 1rem; border-bottom: 1px solid #eee;">
                <strong>${item.date}</strong><br>
                <small style="color: #6c757d;">${item.time}</small>
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #eee;">
                <i class="fas fa-user" style="color: #007bff; margin-right: 0.5rem;"></i>
                <strong style="color: #495057;">${item.user || 'Admin'}</strong>
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #eee;">
                <span style="color: ${statusColor}; font-weight: bold;">
                    ${statusIcon} ${item.location}
                </span>
            </td>
            <td style="padding: 1rem; text-align: center; border-bottom: 1px solid #eee; font-weight: bold;">
                ${item.checkedCount} ta
            </td>
            <td style="padding: 1rem; text-align: center; border-bottom: 1px solid #eee; font-weight: bold; color: ${item.errorCount > 0 ? '#dc3545' : '#28a745'};">
                ${item.errorCount} ta
            </td>
            <td style="padding: 1rem; text-align: center; border-bottom: 1px solid #eee;">
                <button onclick="viewHistoryDetails(${item.id})" style="background: #007bff; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer; margin-right: 0.5rem;" title="Tafsilotlarni ko'rish">
                    <i class="fas fa-eye"></i>
                </button>
                ${userRole !== 'sotuvchi' ? `<button onclick="deleteHistoryItem(${item.id})" style="background: #dc3545; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;" title="O'chirish">
                    <i class="fas fa-trash"></i>
                </button>` : ''}
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// Tarix bo'limini ko'rsatish
function showHistorySection() {
    document.getElementById('historySection').style.display = 'block';
}

// Tarixni tozalash
function clearHistory() {
    if (confirm('Barcha tekshiruv tarixini o\'chirmoqchimisiz?\n\n⚠️ Eslatma: Eski tarix yozuvlarida mahsulotlar jadvali ko\'rinmasligi mumkin. Yangi tekshiruvlarda jadval to\'liq ishlaydigan bo\'ladi.')) {
        localStorage.removeItem('stockCheckHistory');
        refreshHistoryTable();
        document.getElementById('historySection').style.display = 'none';

        alert('✅ Tarix tozalandi! Yangi tekshiruvlar o\'tkazganda mahsulotlar jadvali to\'liq ko\'rinadi.');
    }
}

// Alohida tarix elementini o'chirish
function deleteHistoryItem(itemId) {
    if (confirm('Bu tekshiruv tarixini o\'chirmoqchimisiz?')) {
        const history = getCheckHistory();
        const updatedHistory = history.filter(item => item.id !== itemId);
        localStorage.setItem('stockCheckHistory', JSON.stringify(updatedHistory));
        refreshHistoryTable();
        
        // Agar tarix bo'sh bo'lsa, bo'limni yashirish
        if (updatedHistory.length === 0) {
            document.getElementById('historySection').style.display = 'none';
        }
    }
}

// Tekshiruv tafsilotlarini ko'rish (shu tabda sahifaga yo'naltirish)
function viewHistoryDetails(itemId) {
    // Shu tabda tafsilotlar sahifasiga yo'naltirish
    window.location.href = `/history_details?id=${itemId}`;
}

// Event delegation ni sozlash - sahifa yangilanganda ham ishlaydi
function setupEventDelegation() {

    
    // Ong jadval uchun edit tugmalari - event delegation
    const statisticsTableBody = document.getElementById('statisticsTableBody');
    if (statisticsTableBody) {
        // Eski event listener'larni olib tashlash
        statisticsTableBody.removeEventListener('click', handleStatisticsTableClick);
        // Yangi event listener qo'shish
        statisticsTableBody.addEventListener('click', handleStatisticsTableClick);

    } else {

    }
}

// Statistika jadvali uchun click handler
function handleStatisticsTableClick(event) {
    const target = event.target;
    
    // Edit tugmasi bosilganini tekshirish
    if (target.classList.contains('edit-product-btn') || target.closest('.edit-product-btn')) {
        const editBtn = target.classList.contains('edit-product-btn') ? target : target.closest('.edit-product-btn');
        
        const productId = editBtn.dataset.productId;
        const productName = editBtn.dataset.productName;
        const price = editBtn.dataset.productPrice;
        const currentQuantity = parseFloat(editBtn.dataset.currentQuantity) || 0;
        const originalQuantity = parseFloat(editBtn.dataset.originalQuantity) || 0;
        
        console.log('🔄 Event delegation - edit tugmasi bosildi:', {
            productId, productName, price, currentQuantity, originalQuantity
        });
        
        // Tekshirilgan mahsulotni qayta tahrirlash
        editCheckedProduct(productId, productName, price, currentQuantity, originalQuantity);
    }
}

// Sahifa yuklanganda tarixni yuklash
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const history = getCheckHistory();
        if (history.length > 0) {
            refreshHistoryTable();
            
            // Faqat tekshiruv faol bo'lmagan holatde tarixni ko'rsatish
            const button = document.getElementById('startStopButton');
            const isCheckingActive = button && button.innerHTML.includes('Tekshiruvni tugatish');
            
            if (!isCheckingActive) {
                showHistorySection();
            }
        }
    }, 500);
});
</script>

<style>
/* Qidiruv highlight */
.search-highlight {
    background-color: #ffeb3b;
    color: #333;
    font-weight: 600;
    padding: 1px 2px;
    border-radius: 2px;
    box-shadow: 0 1px 2px rgba(255, 235, 59, 0.3);
}

/* Check stock specific CSS - High specificity */
#resultsSection table {
    border-spacing: 0 !important;
    border-collapse: collapse !important;
    width: 100% !important;
    table-layout: fixed !important;
    min-width: 0 !important;
}

#resultsSection th, #resultsSection td {
    box-sizing: border-box !important;
    border: 1px solid #ddd !important;
    text-align: left !important;
    vertical-align: middle !important;
    word-break: break-word !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}

#resultsSection th {
    white-space: nowrap !important;
    font-weight: 600 !important;
    background-color: #f8f9fa !important;
}

#resultsSection td {
    min-height: 40px !important;
    max-height: 60px !important;
}

/* Responsive design for check_stock */
@media (max-width: 768px) {
    #resultsSection > div {
        flex-direction: column !important;
        gap: 1rem !important;
    }
    
    #resultsSection > div > div {
        flex: none !important;
        width: 100% !important;
        max-width: 100% !important;
        min-width: 100% !important;
    }
    
    #resultsSection table th, #resultsSection table td {
        padding: 0.4rem !important;
        font-size: 0.8rem !important;
    }
}

@media (max-width: 480px) {
    .container-fluid {
        padding: 0.5rem !important;
    }
    
    table th, table td {
        padding: 0.3rem !important;
        font-size: 0.75rem !important;
    }
    
    h3 {
        font-size: 1rem !important;
    }
}

/* Keyboard navigatsiyasi uchun stillar */
.table-row-selected {
    background-color: #e3f2fd !important;
    border: 2px solid #2196f3 !important;
    box-shadow: 0 0 0 1px #2196f3 !important;
}

.table-row-hover {
    background-color: #f5f5f5 !important;
}
</style>

<script>
// Keyboard navigatsiyasi uchun o'zgaruvchilar
let currentSelectedRowIndex = -1;
let visibleRows = [];
let visibleCount = 0; // Global visibleCount o'zgaruvchisi

// Qidiruv va navigatsiya boshqaruvi
function handleProductSearchWithNav(event) {
    const searchTerm = event.target.value.trim();
    
    // Navigatsiya tugmalari bo'lmasa qidirish
    if (!['ArrowDown', 'ArrowUp', 'Enter', 'Escape'].includes(event.key)) {
        filterProductsTable(searchTerm);
        updateVisibleRows();
        currentSelectedRowIndex = -1; // Reset selection
        clearTableSelection();
    }
}

// Keyboard navigatsiyasi
function handleTableNavigation(event) {
    updateVisibleRows();
    
    if (event.key === 'ArrowDown') {
        event.preventDefault();
        if (visibleRows.length > 0) {
            currentSelectedRowIndex = currentSelectedRowIndex < visibleRows.length - 1 
                ? currentSelectedRowIndex + 1 
                : 0;
            selectTableRow(currentSelectedRowIndex);
        }
    } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        if (visibleRows.length > 0) {
            currentSelectedRowIndex = currentSelectedRowIndex > 0 
                ? currentSelectedRowIndex - 1 
                : visibleRows.length - 1;
            selectTableRow(currentSelectedRowIndex);
        }
    } else if (event.key === 'Enter') {
        event.preventDefault();
        if (currentSelectedRowIndex >= 0 && visibleRows[currentSelectedRowIndex]) {
            openModalFromSelectedRow(visibleRows[currentSelectedRowIndex]);
        }
    } else if (event.key === 'Escape') {
        event.preventDefault();
        clearTableSelection();
        currentSelectedRowIndex = -1;
        document.getElementById('productSearchInput').blur();
    }
}

// Ko'rinadigan qatorlarni yangilash
function updateVisibleRows() {
    const tableBody = document.getElementById('productsTableBody');
    const allRows = Array.from(tableBody.getElementsByTagName('tr'));
    
    visibleRows = allRows.filter(row => {
        const cells = row.getElementsByTagName('td');
        if (cells.length <= 1) return false; // Xabar qatorlarini o'tkazib yuborish
        return row.style.display !== 'none';
    });
}

// Jadval qatorini tanlash
function selectTableRow(index) {
    clearTableSelection();
    
    if (index >= 0 && index < visibleRows.length) {
        const selectedRow = visibleRows[index];
        selectedRow.classList.add('table-row-selected');
        
        // Scroll qilish
        selectedRow.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
    }
}

// Barcha tanlovni tozalash
function clearTableSelection() {
    const tableBody = document.getElementById('productsTableBody');
    const allRows = Array.from(tableBody.getElementsByTagName('tr'));
    
    allRows.forEach(row => {
        row.classList.remove('table-row-selected', 'table-row-hover');
    });
}

// Tanlangan qatordan modal ochish
function openModalFromSelectedRow(row) {
    const cells = row.getElementsByTagName('td');
    if (cells.length > 3) {
        const productName = cells[0].textContent.trim();
        const price = cells[1].textContent.trim();
        const quantity = cells[2].textContent.trim();
        
        // onclick eventdan productId ni olish
        const actionCell = cells[3];
        const onclickAttr = actionCell.querySelector('span')?.getAttribute('onclick');
        const productIdMatch = onclickAttr?.match(/openProductModal\((\d+)/);
        
        if (productIdMatch) {
            const productId = productIdMatch[1];
            const priceValue = price.match(/[\d.]+/)?.[0] || '0';
            const quantityValue = parseFloat(quantity) || 0;
            
            // Modal ochish
            openProductModal(productId, productName, parseFloat(priceValue), quantityValue);
        }
    }
}

// Mouse hover effektlari qo'shish
function addTableHoverEffects() {
    const tableBody = document.getElementById('productsTableBody');
    
    tableBody.addEventListener('mouseover', function(event) {
        const row = event.target.closest('tr');
        if (row && !row.classList.contains('table-row-selected')) {
            row.classList.add('table-row-hover');
        }
    });
    
    tableBody.addEventListener('mouseout', function(event) {
        const row = event.target.closest('tr');
        if (row) {
            row.classList.remove('table-row-hover');
        }
    });
}

// Sahifa yuklanganda hover effektlarini qo'shish
document.addEventListener('DOMContentLoaded', function() {
    addTableHoverEffects();
});

// Eski filtr funksiyasi (dropdown bo'lmagan holatlar uchun)
// Qidiruv matnini ajratib ko'rsatish funksiyasi
function highlightSearchText(text, searchTerm) {
    if (!searchTerm || searchTerm.trim() === '') {
        return text;
    }
    
    // Qidiruv so'zlarini ajratish
    const searchWords = searchTerm.trim().split(/\s+/).filter(word => word.length > 0);
    if (searchWords.length === 0) return text;
    
    // Barcha so'zlarni bitta regex pattern ga birlashtirish (alternation)
    const pattern = searchWords
        .map(word => word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'))
        .join('|');
    
    // Bir marta replace qilish - shunda HTML taglarga tegmaydi
    const regex = new RegExp(`(${pattern})`, 'gi');
    return text.replace(regex, '<span class="search-highlight">$1</span>');
}

function filterProductsTable(searchTerm) {
    const tableBody = document.getElementById('productsTableBody');
    const rows = tableBody.getElementsByTagName('tr');
    
    let visibleCount = 0;
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        
        if (cells.length === 1) continue;
        
        if (cells.length > 0) {
            // Asl mahsulot nomini olish (data attribute'dan)
            const originalName = row.dataset.originalName || cells[0].textContent;
            
            // Agar data attribute bo'lmasa, birinchi marta saqlash
            if (!row.dataset.originalName) {
                row.dataset.originalName = cells[0].textContent;
            }
            
            // Qisman so'zlar bilan qidirish
            const searchWords = searchTerm.toLowerCase().trim().split(/\s+/);
            let matchesAll = true;
            
            if (searchTerm.trim()) {
                for (const word of searchWords) {
                    if (word && !originalName.toLowerCase().includes(word)) {
                        matchesAll = false;
                        break;
                    }
                }
            }
            
            if (matchesAll) {
                row.style.display = '';
                visibleCount++;
                
                // Qidiruv matnini highlight qilish
                if (searchTerm.trim()) {
                    cells[0].innerHTML = highlightSearchText(originalName, searchTerm);
                } else {
                    cells[0].textContent = originalName;
                }
            } else {
                row.style.display = 'none';
            }
        }
    }
    
    updateProductCount();
}

// Sahifa yuklanganda mahsulotlar qidiruviga fokus berish
document.addEventListener('DOMContentLoaded', function() {
    // Bir oz kutish (jadval yuklanishi uchun)
    setTimeout(function() {
        const productSearchInput = document.getElementById('productSearchInput');
        if (productSearchInput) {
            productSearchInput.focus();

        }
    }, 500);
});
</script>

{% endblock %}
