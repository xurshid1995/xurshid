{% extends "base_with_sidebar.html" %}

{% block title %}Qarzlar - Dokon Boshqaruv Tizimi{% endblock %}

{% block extra_css %}
<style>
    .debts-container {
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #dee2e6;
        gap: 15px;
    }

    .page-header h1 {
        margin: 0;
        color: #333;
        font-size: 28px;
        font-weight: 600;
    }

    .stats-cards {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 25px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-left: 4px solid;
    }

    .stat-card.total { border-left-color: #dc3545; }
    .stat-card.paid { border-left-color: #28a745; }
    .stat-card.customers { border-left-color: #ffc107; }

    .stat-card h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #666;
        font-weight: 500;
    }

    .stat-card .value {
        font-size: 28px;
        font-weight: 700;
        color: #333;
    }

    .filters-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .filters-row {
        display: grid;
        grid-template-columns: 1fr 200px 200px 150px;
        gap: 15px;
        align-items: end;
    }

    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
        font-weight: 500;
        color: #495057;
    }

    .filter-group input,
    .filter-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 14px;
    }

    .filter-group button {
        width: 100%;
        padding: 10px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
    }

    .filter-group button:hover {
        background: #0056b3;
    }

    .debts-table-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .debts-table {
        width: 100%;
        border-collapse: collapse;
    }

    .debts-table thead {
        background: #f8f9fa;
    }

    .debts-table th {
        padding: 15px;
        text-align: left;
        font-size: 14px;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
    }

    .debts-table td {
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
        font-size: 14px;
        color: #333;
    }

    .debts-table tbody tr:hover {
        background: #f8f9fa;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-badge.debt {
        background: #fff3cd;
        color: #856404;
    }

    .status-badge.paid {
        background: #d4edda;
        color: #155724;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .btn-view {
        padding: 6px 12px;
        background: #17a2b8;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
    }

    .btn-view:hover {
        background: #138496;
    }

    .btn-pay {
        padding: 6px 12px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
    }

    .btn-pay:hover {
        background: #218838;
    }

    .btn-sms {
        background: #25D366;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.3s;
        white-space: nowrap;
    }

    .btn-sms:hover {
        background: #128C7E;
        transform: translateY(-2px);
    }

    .btn-sms:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
    }

    /* Qidiruv maydoni */
    .search-container {
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .search-input {
        flex: 1;
        max-width: 400px;
        padding: 10px 15px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: #17a2b8;
        box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.1);
    }

    .search-input::placeholder {
        color: #999;
    }

    /* Location buttons */
    #locationButtons {
        max-height: 120px;
        overflow-y: auto;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    #locationButtons::-webkit-scrollbar {
        width: 6px;
    }

    #locationButtons::-webkit-scrollbar-track {
        background: #e9ecef;
        border-radius: 3px;
    }

    #locationButtons::-webkit-scrollbar-thumb {
        background: #6c757d;
        border-radius: 3px;
    }

    #locationButtons::-webkit-scrollbar-thumb:hover {
        background: #495057;
    }

    /* Tugmalar - Bosilmagan holat */
    .location-btn {
        background: none !important;
        background-color: transparent !important;
        border: 1px solid #007bff !important;
        color: black !important;
        box-shadow: none !important;
        transition: all 0.3s ease;
        font-weight: 450;
        font-size: 14px !important;
        padding: 6px 12px !important;
        border-radius: 5px;
    }

    /* Tugma bosilganda */
    .location-btn.active {
        background-color: #007bff !important;
        border: 1px solid #007bff !important;
        color: white !important;
        box-shadow: none !important;
        transform: scale(1.02) !important;
    }

    /* Hover effect */
    .location-btn:hover:not(.active) {
        background-color: rgba(0, 123, 255, 0.1) !important;
        transform: translateY(-2px) !important;
        box-shadow: none !important;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        width: 95%;
        max-width: 1200px;
        max-height: 90vh;
        overflow-y: auto;
        overflow-x: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .modal-header {
        padding: 20px;
        border-bottom: 2px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 22px;
        color: #333;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #999;
        line-height: 1;
        padding: 0;
        width: 30px;
        height: 30px;
    }

    .modal-close:hover {
        color: #333;
    }

    .modal-body {
        padding: 20px;
    }

    .customer-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .customer-info h3 {
        margin: 0 0 15px 0;
        font-size: 18px;
        color: #333;
    }

    .customer-info p {
        margin: 5px 0;
        font-size: 14px;
        color: #666;
    }

    .debt-history-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

    .debt-history-table th,
    .debt-history-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
        font-size: 14px;
    }

    .debt-history-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }

    .payment-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .payment-section h3 {
        margin: 0 0 15px 0;
        font-size: 18px;
        color: #333;
    }

    .payment-methods {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 20px;
    }

    .payment-method {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .payment-method label {
        font-size: 14px;
        font-weight: 500;
        color: #495057;
    }

    .payment-method input {
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 14px;
    }

    .payment-total {
        text-align: right;
        margin-bottom: 15px;
        font-size: 16px;
        font-weight: 600;
        color: #333;
    }

    .payment-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .btn-cancel {
        padding: 10px 20px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
    }

    .btn-cancel:hover {
        background: #5a6268;
    }

    .btn-confirm {
        padding: 10px 20px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
    }

    .btn-confirm:hover {
        background: #218838;
    }

    .no-data {
        text-align: center;
        padding: 40px;
        color: #999;
        font-size: 16px;
    }

    /* Mobile responsive styles */
    @media (max-width: 768px) {
        .debts-container {
            padding: 10px;
        }

        .page-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .page-header h1 {
            font-size: 22px;
        }

        .page-header > div {
            width: 100%;
            flex-direction: column;
            gap: 10px !important;
        }

        .page-header button,
        .page-header a {
            width: 100%;
            text-align: center;
            justify-content: center;
        }

        .stats-cards {
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            padding: 15px;
        }

        .stat-card .value {
            font-size: 24px;
        }

        #locationButtons {
            max-height: none;
            padding: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .location-btn {
            font-size: 12px !important;
            padding: 5px 10px !important;
            white-space: nowrap;
        }

        .filters-row {
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .search-input {
            max-width: 100%;
            font-size: 14px;
            padding: 8px 12px;
        }

        .debts-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .debts-table-container h2 {
            font-size: 18px;
            margin-bottom: 10px;
            padding: 0 5px;
        }

        .debts-table {
            min-width: 800px;
            font-size: 13px;
        }

        .debts-table th,
        .debts-table td {
            padding: 10px 8px;
            font-size: 12px;
        }

        .action-buttons {
            flex-direction: column;
            gap: 5px;
        }

        .btn-view,
        .btn-pay,
        .btn-sms {
            width: 100%;
            padding: 8px;
            font-size: 12px;
            white-space: nowrap;
        }

        .status-badge {
            padding: 3px 8px;
            font-size: 11px;
        }

        /* Modal mobile optimization */
        .modal-content {
            width: 100%;
            max-width: 100%;
            height: 100%;
            max-height: 100vh;
            border-radius: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 12px 15px;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .modal-header h2 {
            font-size: 16px;
        }

        .modal-close {
            font-size: 24px;
            width: 28px;
            height: 28px;
        }

        .modal-body {
            padding: 12px;
            overflow-y: auto;
            flex: 1;
        }

        .customer-info,
        .payment-section {
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 6px;
        }

        .customer-info h3,
        .payment-section h3 {
            font-size: 15px;
            margin-bottom: 8px;
        }

        .customer-info p {
            font-size: 12px;
            margin: 3px 0;
        }

        .payment-methods {
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .payment-method label {
            font-size: 13px;
            margin-bottom: 4px;
        }

        .payment-method input {
            padding: 10px;
            font-size: 15px;
            border: 1.5px solid #ced4da;
        }

        .payment-method input:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .payment-total {
            font-size: 15px;
            margin-bottom: 12px;
            text-align: center;
            padding: 10px;
            background: #e7f4ea;
            border-radius: 6px;
        }

        .payment-actions {
            flex-direction: column;
            gap: 10px;
            position: sticky;
            bottom: 0;
            background: white;
            padding: 12px 0 0 0;
            border-top: 1px solid #dee2e6;
            margin-top: 12px;
        }

        .btn-cancel,
        .btn-confirm {
            width: 100%;
            padding: 14px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 8px;
        }

        .debt-history-table {
            display: block;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            font-size: 11px;
            margin-bottom: 12px;
        }

        .debt-history-table thead,
        .debt-history-table tbody {
            display: table;
            width: 100%;
            min-width: 500px;
        }

        .debt-history-table th,
        .debt-history-table td {
            padding: 6px 4px;
            font-size: 11px;
        }

        /* Mijoz ma'lumotlari va To'lov qilish yonma-yon joylashuv */
        .modal-body > div[style*="display: flex"] {
            flex-direction: column !important;
            gap: 12px !important;
        }

        .modal-body > div[style*="display: flex"] > div {
            flex: 1 1 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
        }

        /* To'lov turlari grid */
        .payment-section > div > h4 ~ div[style*="grid-template-columns"] {
            grid-template-columns: 1fr !important;
        }

        /* To'lov input container - ixcham layout */
        .payment-section div[style*="display: flex"][style*="gap: 8px"] {
            flex-wrap: nowrap !important;
            gap: 2px !important;
        }

        .payment-section div[style*="display: flex"][style*="gap: 8px"] > label {
            width: auto !important;
            min-width: auto !important;
            flex-shrink: 0 !important;
            font-size: 10px !important;
            padding: 4px 2px !important;
            max-width: 50px;
        }

        .payment-section div[style*="display: flex"][style*="gap: 8px"] > div {
            flex: 1 !important;
            min-width: 0 !important;
            max-width: 35% !important;
        }

        .payment-section div[style*="display: flex"][style*="gap: 8px"] > div input {
            padding: 4px 2px !important;
            font-size: 11px !important;
            width: 100% !important;
        }

        .payment-section div[style*="display: flex"][style*="gap: 8px"] > div span {
            font-size: 10px !important;
            min-width: 12px;
            padding: 0 2px;
        }

        .payment-section div[style*="display: flex"][style*="gap: 8px"] > button {
            flex: 0 0 auto !important;
            width: auto !important;
            padding: 4px 5px !important;
            font-size: 8px !important;
            margin-top: 0 !important;
            white-space: nowrap;
        }

        /* Table scroll wrapper */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .filters-section {
            padding: 15px;
        }

        .filter-group label {
            font-size: 13px;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px;
            font-size: 13px;
        }

        .no-data {
            padding: 30px 15px;
            font-size: 14px;
        }
    }

    /* Extra small devices */
    @media (max-width: 480px) {
        .page-header h1 {
            font-size: 18px;
        }

        .stat-card .value {
            font-size: 20px;
        }

        .stat-card h3 {
            font-size: 13px;
        }

        .debts-table {
            min-width: 700px;
        }

        .debts-table th,
        .debts-table td {
            padding: 8px 5px;
            font-size: 11px;
        }

        .modal-header h2 {
            font-size: 14px;
        }

        .modal-close {
            font-size: 22px;
            width: 26px;
            height: 26px;
        }

        .customer-info h3,
        .payment-section h3 {
            font-size: 14px;
        }

        .customer-info p {
            font-size: 11px;
        }

        .payment-method label {
            font-size: 12px;
        }

        .payment-method input {
            padding: 9px;
            font-size: 14px;
        }

        .payment-total {
            font-size: 14px;
            padding: 8px;
        }

        .btn-cancel,
        .btn-confirm {
            padding: 13px;
            font-size: 14px;
        }

        .debt-history-table th,
        .debt-history-table td {
            padding: 5px 3px;
            font-size: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="debts-container">
    <div class="page-header">
        <h1>üí∞ Qarzlar</h1>
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            <!-- Joylashuv tugmalari -->
            <div id="locationButtons" style="margin: 15px 0;">
                {% if current_user.role in ['admin', 'kassir'] %}
                <button class="btn btn-sm me-2 mb-2 location-btn active" data-location="" onclick="selectLocation(this, '')">
                    üè¢ Barchasi
                </button>
                {% endif %}
            </div>
            <button onclick="sendBulkDebtTelegram()" class="btn-sms" style="padding: 10px 20px; border-radius: 8px; font-weight: 500;">
                ‚úàÔ∏è Barchaga Telegram yuborish
            </button>
            <a href="/paid-debts-history" class="btn btn-primary" style="padding: 10px 20px; border-radius: 8px; font-weight: 500; text-decoration: none; color: white;">
                <i class="fas fa-history"></i> Mijozlarni qarz to'lash tarixi
            </a>
        </div>
    </div>

    <!-- Statistika kartochkalari -->
    <div class="stats-cards">
        <div class="stat-card customers">
            <h3>üë• Qarzli mijozlar</h3>
            <div class="value" id="debtCustomers">0</div>
        </div>
        <div class="stat-card total">
            <h3>üí∞ Umumiy qarz</h3>
            <div class="value" id="totalDebt">$0.00</div>
        </div>
    </div>

    <!-- Qarzlar jadvali -->
    <div class="debts-table-container">
        <h2 style="margin-bottom: 15px; color: #dc3545; display: flex; align-items: center; gap: 10px;">
            <span>üí≥ Qarzli mijozlar</span>
        </h2>
        <div class="search-container">
            <input type="text" id="debtSearchInput" class="search-input" placeholder="üîç Mijoz nomi yoki telefon raqamini kiriting..." oninput="searchDebts()">
        </div>
        <table class="debts-table">
            <thead>
                <tr>
                    <th>‚Ññ</th>
                    <th>üë§ Mijoz</th>
                    <th>üìû Telefon</th>
                    <th> Qolgan qarz</th>
                    <th>üíµ Oxirgi to'lov</th>
                    <th>üìÖ Oxirgi to'lov sanasi</th>
                    <th>üè∑Ô∏è Status</th>
                    <th>‚öôÔ∏è Amallar</th>
                </tr>
            </thead>
            <tbody id="debtsTableBody">
                <tr>
                    <td colspan="8" class="no-data">Ma'lumotlar yuklanmoqda...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- To'langan qarzlar jadvali -->
    <div class="debts-table-container" id="paidDebtsSection" style="margin-top: 30px;">
        <h2 style="margin-bottom: 15px; color: #28a745; display: flex; align-items: center; gap: 10px;">
            <span>‚úÖ To'langan qarzlar tarixi</span>
        </h2>
        <div class="search-container">
            <input type="text" id="paidDebtSearchInput" class="search-input" placeholder="üîç Mijoz nomi yoki savdo raqami orqali qidirish..." oninput="searchPaidDebts()">
        </div>
        <table class="debts-table">
            <thead>
                <tr>
                    <th>‚Ññ</th>
                    <th>üìÖ Sana</th>
                    <th>üë§ Mijoz</th>
                    <th>üõí Savdo ‚Ññ</th>
                    <th>üíµ Summa</th>
                    <th>üí≥ To'lov turlari</th>
                </tr>
            </thead>
            <tbody id="paidDebtsTableBody">
                <tr>
                    <td colspan="6" class="no-data">Ma'lumotlar yuklanmoqda...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Batafsil modal -->
<div id="debtModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üìã Qarz ma'lumotlari</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Mijoz ma'lumotlari va To'lov qilish yonma-yon -->
            <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; align-items: stretch;">
                <!-- Mijoz ma'lumotlari - qisqartirilgan -->
                <div class="customer-info" style="flex: 0 0 280px; min-width: 280px; display: flex; flex-direction: column;">
                    <h3 id="modalCustomerName" style="font-size: 16px; margin-bottom: 10px;">-</h3>
                    <div style="display: flex; flex-direction: column; gap: 6px; font-size: 13px;">
                        <p style="margin: 0;"><strong>üìû</strong> <span id="modalCustomerPhone">-</span></p>
                        <p style="margin: 0;"><strong>üìç</strong> <span id="modalCustomerAddress">-</span></p>
                        <p style="margin: 0;"><strong>üí∞</strong> <span id="modalTotalDebt">$0.00</span></p>
                    </div>
                </div>

                <!-- To'lov qilish bo'limi - kengaytirilgan -->
                <div class="payment-section" style="flex: 1; min-width: 500px; margin-bottom: 0; display: flex; flex-direction: column;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">üí≥ Qarzga to'lov qilish</h3>
                        <div style="background: #f8f9fa; padding: 8px 12px; border-radius: 6px; border-left: 4px solid #007bff;">
                            <span style="font-weight: 500; color: #495057; font-size: 14px;">Qarz miqdori: </span>
                            <span style="font-weight: 700; color: #dc3545; font-size: 18px;" id="paymentAmount">$0.00</span>
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 12px; color: #333; font-size: 16px;">To'lov turlari</h4>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-weight: 500; white-space: nowrap; min-width: 90px;">üíµ Naqd:</label>
                                <div style="flex: 1; display: flex; align-items: center; gap: 4px;">
                                    <span style="font-weight: 700; color: #28a745; font-size: 16px;">$</span>
                                    <input type="number" id="modalPaymentCashUSD" step="0.01" placeholder="0.00" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div style="flex: 1; display: flex; align-items: center; gap: 4px;">
                                    <span style="font-weight: 700; color: #6c757d; font-size: 16px;">UZS</span>
                                    <input type="number" id="modalPaymentCashUZS" step="1" placeholder="0" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                                </div>
                                <button onclick="addModalRemainingToField('modalPaymentCashUSD')" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; white-space: nowrap;">+ Qolgan</button>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-weight: 500; white-space: nowrap; min-width: 90px;">üì± Click:</label>
                                <div style="flex: 1; display: flex; align-items: center; gap: 4px;">
                                    <span style="font-weight: 700; color: #28a745; font-size: 16px;">$</span>
                                    <input type="number" id="modalPaymentClickUSD" step="0.01" placeholder="0.00" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div style="flex: 1; display: flex; align-items: center; gap: 4px;">
                                    <span style="font-weight: 700; color: #6c757d; font-size: 16px;">UZS</span>
                                    <input type="number" id="modalPaymentClickUZS" step="1" placeholder="0" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                                </div>
                                <button onclick="addModalRemainingToField('modalPaymentClickUSD')" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; white-space: nowrap;">+ Qolgan</button>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-weight: 500; white-space: nowrap; min-width: 90px;">üèß Terminal:</label>
                                <div style="flex: 1; display: flex; align-items: center; gap: 4px;">
                                    <span style="font-weight: 700; color: #28a745; font-size: 16px;">$</span>
                                    <input type="number" id="modalPaymentTerminalUSD" step="0.01" placeholder="0.00" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div style="flex: 1; display: flex; align-items: center; gap: 4px;">
                                    <span style="font-weight: 700; color: #6c757d; font-size: 16px;">UZS</span>
                                    <input type="number" id="modalPaymentTerminalUZS" step="1" placeholder="0" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                                </div>
                                <button onclick="addModalRemainingToField('modalPaymentTerminalUSD')" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; white-space: nowrap;">+ Qolgan</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="payment-actions">
                        <button class="btn-cancel" onclick="closeModal()">‚ùå Bekor qilish</button>
                        <button class="btn-confirm" onclick="confirmPayment()">‚úÖ To'lovni tasdiqlash</button>
                    </div>
                </div>
            </div>

            <!-- Qarzlar tarixi -->
            <h3>üìú Qarzlar tarixi</h3>
            <table class="debt-history-table">
                <thead>
                    <tr>
                        <th>üìÖ Sana</th>
                        <th>üõí Savdo ‚Ññ</th>
                        <th>üíµ Summa</th>
                        <th>‚úÖ To'langan</th>
                        <th>üìä Qolgan</th>
                        <th>üè∑Ô∏è Status</th>
                    </tr>
                </thead>
                <tbody id="debtHistoryBody">
                    <tr>
                        <td colspan="6" class="no-data">Ma'lumot yo'q</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let debts = [];
    let allDebts = []; // Barcha qarzlar (filter uchun)
    let allPaidDebts = []; // Barcha to'langan qarzlar (filter uchun)
    let currentCustomerId = null;
    let exchangeRate = 13000;
    let selectedLocation = '';
    const userRole = '{{ user_role }}';
    const allowedLocations = {{ allowed_locations | tojson }};

    // Locationlarni yuklash va tugmalar yaratish
    async function loadLocations() {
        try {
            const response = await fetch('/api/locations');
            const locations = await response.json();
            
            const container = document.getElementById('locationButtons');
            container.innerHTML = '';
            
            // Admin uchun "Barchasi" tugmasini ko'rsatish
            if (userRole === 'admin') {
                const allButton = document.createElement('button');
                allButton.className = 'btn btn-sm me-2 mb-2 location-btn';
                allButton.setAttribute('data-location', '');
                allButton.onclick = () => selectLocation(allButton, '');
                allButton.textContent = 'üè¢ Barchasi';
                container.appendChild(allButton);
            }
            
            let firstLocation = null;
            locations.forEach((loc, index) => {
                const button = document.createElement('button');
                button.className = 'btn btn-sm me-2 mb-2 location-btn';
                button.setAttribute('data-location', loc.id);
                button.onclick = () => selectLocation(button, loc.id);
                button.textContent = `${loc.emoji} ${loc.name}`;
                container.appendChild(button);
                
                // Sotuvchi uchun birinchi ruxsat etilgan locationni saqlash
                if (userRole !== 'admin' && index === 0) {
                    firstLocation = { button, id: loc.id };
                }
            });
            
            // Sotuvchi uchun avtomatik birinchi locationni tanlash
            if (userRole !== 'admin' && firstLocation) {
                selectLocation(firstLocation.button, firstLocation.id);
            } else if (userRole === 'admin') {
                // Admin uchun "Barchasi" tugmasini avtomatik tanlash
                const allBtn = container.querySelector('[data-location=""]');
                if (allBtn) {
                    selectLocation(allBtn, '');
                }
            }
        } catch (error) {
            console.error('Locationlarni yuklashda xatolik:', error);
        }
    }

    // Location tugmasini tanlash
    function selectLocation(button, locationId) {
        // Barcha tugmalardan active classni olib tashlash
        document.querySelectorAll('.location-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Tanlangan tugmaga active class qo'shish
        button.classList.add('active');
        
        // Tanlangan locationni saqlash
        selectedLocation = locationId;
        
        // Ma'lumotlarni yangilash
        loadDebts();
        loadPaidDebts();
    }

    // To'langan qarzlar tarixini ko'rsatish/yashirish
    function togglePaidDebtsHistory() {
        const section = document.getElementById('paidDebtsSection');
        if (section.style.display === 'none') {
            section.style.display = 'block';
            section.scrollIntoView({ behavior: 'smooth' });
        } else {
            section.style.display = 'none';
        }
    }

    // Qarzlarni qidirish
    function searchDebts() {
        const searchTerm = document.getElementById('debtSearchInput').value.toLowerCase().trim();
        const rows = document.querySelectorAll('#debtsTableBody tr');
        
        let visibleCount = 0;
        rows.forEach(row => {
            const nameCell = row.querySelector('td:nth-child(2)');
            const phoneCell = row.querySelector('td:nth-child(3)');
            
            if (nameCell && phoneCell) {
                const name = nameCell.textContent.toLowerCase();
                const phone = phoneCell.textContent.toLowerCase();
                
                if (name.includes(searchTerm) || phone.includes(searchTerm)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            }
        });
        
        // Agar hech narsa topilmasa
        if (visibleCount === 0 && searchTerm !== '') {
            const noResultRow = document.querySelector('#debtsTableBody .no-result');
            if (!noResultRow) {
                const tbody = document.getElementById('debtsTableBody');
                const tr = document.createElement('tr');
                tr.className = 'no-result';
                tr.innerHTML = '<td colspan="8" class="no-data">üîç Hech narsa topilmadi</td>';
                tbody.appendChild(tr);
            }
        } else {
            const noResultRow = document.querySelector('#debtsTableBody .no-result');
            if (noResultRow) noResultRow.remove();
        }
    }

    // To'langan qarzlarni qidirish
    function searchPaidDebts() {
        const searchTerm = document.getElementById('paidDebtSearchInput').value.toLowerCase().trim();
        const rows = document.querySelectorAll('#paidDebtsTableBody tr');
        
        let visibleCount = 0;
        rows.forEach(row => {
            const dateCell = row.querySelector('td:nth-child(2)');
            const nameCell = row.querySelector('td:nth-child(3)');
            const saleCell = row.querySelector('td:nth-child(4)');
            
            if (dateCell && nameCell && saleCell) {
                const date = dateCell.textContent.toLowerCase();
                const name = nameCell.textContent.toLowerCase();
                const sale = saleCell.textContent.toLowerCase();
                
                if (name.includes(searchTerm) || sale.includes(searchTerm) || date.includes(searchTerm)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            }
        });
        
        // Agar hech narsa topilmasa
        if (visibleCount === 0 && searchTerm !== '') {
            const noResultRow = document.querySelector('#paidDebtsTableBody .no-result');
            if (!noResultRow) {
                const tbody = document.getElementById('paidDebtsTableBody');
                const tr = document.createElement('tr');
                tr.className = 'no-result';
                tr.innerHTML = '<td colspan="6" class="no-data">üîç Hech narsa topilmadi</td>';
                tbody.appendChild(tr);
            }
        } else {
            const noResultRow = document.querySelector('#paidDebtsTableBody .no-result');
            if (noResultRow) noResultRow.remove();
        }
    }

    // Ma'lumotlarni yuklash
    async function loadDebts() {
        try {
            const url = selectedLocation ? `/api/debts?location_id=${selectedLocation}` : '/api/debts';
            const response = await fetch(url);
            if (!response.ok) throw new Error('Ma\'lumotlarni yuklashda xatolik');
            
            const data = await response.json();
            allDebts = data.debts || [];
            debts = [...allDebts];
            exchangeRate = data.exchange_rate || 13000;
            
            updateStats();
            renderDebtsTable();
        } catch (error) {
            console.error('Xatolik:', error);
            document.getElementById('debtsTableBody').innerHTML = 
                '<tr><td colspan="9" class="no-data">‚ùå Ma\'lumotlarni yuklashda xatolik</td></tr>';
        }
    }
    
    // To'langan qarzlarni yuklash
    async function loadPaidDebts() {
        try {
            const url = selectedLocation ? `/api/debts/paid?location_id=${selectedLocation}` : '/api/debts/paid';
            
            const response = await fetch(url);
            if (!response.ok) throw new Error('Ma\'lumotlarni yuklashda xatolik');
            
            const data = await response.json();
            renderPaidDebtsTable(data.paid_debts || []);
        } catch (error) {
            console.error('Xatolik:', error);
            document.getElementById('paidDebtsTableBody').innerHTML = 
                '<tr><td colspan="6" class="no-data">‚ùå Ma\'lumotlarni yuklashda xatolik</td></tr>';
        }
    }
    
    // To'langan qarzlar jadvalini render qilish
    function renderPaidDebtsTable(paidDebts) {
        const tbody = document.getElementById('paidDebtsTableBody');
        
        if (paidDebts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="no-data">üì≠ To\'langan qarzlar yo\'q</td></tr>';
            return;
        }

        const html = paidDebts.map((debt, index) => {
            // To'lov turlarini aniqlash
            const payments = [];
            if (debt.cash_usd > 0) payments.push(`üíµ Naqd: $${debt.cash_usd.toFixed(2)}`);
            if (debt.click_usd > 0) payments.push(`üì± Click: $${debt.click_usd.toFixed(2)}`);
            if (debt.terminal_usd > 0) payments.push(`üèß Terminal: $${debt.terminal_usd.toFixed(2)}`);
            
            const paymentText = payments.length > 0 ? payments.join(', ') : '-';
            
            return `
                <tr>
                    <td>${index + 1}</td>
                    <td>${debt.sale_date}</td>
                    <td>${debt.customer_name}</td>
                    <td><strong>#${debt.sale_id}</strong></td>
                    <td><strong style="color: #28a745">$${debt.total_amount.toFixed(2)}</strong></td>
                    <td style="font-size: 13px;">${paymentText}</td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = html;
    }

    // Statistikani yangilash
    function updateStats() {
        const totalDebt = debts.reduce((sum, d) => sum + (d.remaining_debt || 0), 0);
        const debtCustomers = debts.filter(d => (d.remaining_debt || 0) > 0).length;

        document.getElementById('debtCustomers').textContent = debtCustomers;
        document.getElementById('totalDebt').textContent = `$${totalDebt.toFixed(2)}`;
    }

    // Jadvalni render qilish
    function renderDebtsTable() {
        const tbody = document.getElementById('debtsTableBody');
        
        if (debts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="no-data">üì≠ Qarzlar yo\'q</td></tr>';
            return;
        }

        const html = debts.map((debt, index) => {
            const remainingDebt = debt.remaining_debt || 0;
            const status = remainingDebt > 0 ? 'debt' : 'paid';
            const statusText = remainingDebt > 0 ? 'üí≥ Qarzli' : '‚úÖ To\'langan';
            const lastPayment = debt.last_payment_date || '-';
            const lastPaymentAmount = debt.last_payment_amount || 0;
            const lastPaymentRate = debt.last_payment_rate || exchangeRate;

            return `
                <tr>
                    <td>${index + 1}</td>
                    <td>${debt.customer_name}</td>
                    <td>${debt.customer_phone || '-'}</td>
                    <td>
                        <strong style="color: ${remainingDebt > 0 ? '#dc3545' : '#28a745'}">$${remainingDebt.toFixed(2)}</strong>
                        <br><small style="color: #666;">${(remainingDebt * exchangeRate).toLocaleString('uz-UZ')} so'm</small>
                    </td>
                    <td>
                        <strong style="color: #28a745">$${lastPaymentAmount.toFixed(2)}</strong>
                        <br><small style="color: #666;">${(lastPaymentAmount * lastPaymentRate).toLocaleString('uz-UZ')} so'm</small>
                    </td>
                    <td>${lastPayment}</td>
                    <td><span class="status-badge ${status}">${statusText}</span></td>
                    <td>
                        <div class="action-buttons">
                            <a href="/debts/customer/${debt.customer_id}" class="btn-view" style="text-decoration: none;">üëÅÔ∏è Ko'rish</a>
                            ${remainingDebt > 0 ? `<button class="btn-pay" onclick="openPaymentModal(${debt.customer_id})">üí≥ To'lov</button>` : ''}
                            ${remainingDebt > 0 && debt.customer_phone ? `<button class="btn-sms" onclick="sendDebtSMS(${debt.customer_id}, '${debt.customer_name}', ${remainingDebt})">üì± SMS</button>` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = html;
    }

    // Filterlarni qo'llash
    function applyFilters() {
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;
        const date = document.getElementById('dateFilter').value;

        let filtered = debts;

        if (searchText) {
            filtered = filtered.filter(d => 
                d.customer_name.toLowerCase().includes(searchText)
            );
        }

        if (status === 'debt') {
            filtered = filtered.filter(d => (d.remaining_debt || 0) > 0);
        } else if (status === 'paid') {
            filtered = filtered.filter(d => (d.remaining_debt || 0) === 0);
        }

        // Jadvalni yangilash
        const tbody = document.getElementById('debtsTableBody');
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="no-data">üì≠ Natija topilmadi</td></tr>';
            return;
        }

        const html = filtered.map((debt, index) => {
            const remainingDebt = debt.remaining_debt || 0;
            const status = remainingDebt > 0 ? 'debt' : 'paid';
            const statusText = remainingDebt > 0 ? 'üí≥ Qarzli' : '‚úÖ To\'langan';
            const lastPayment = debt.last_payment_date || '-';
            const lastPaymentAmount = debt.last_payment_amount || 0;
            const lastPaymentRate = debt.last_payment_rate || exchangeRate;

            return `
                <tr>
                    <td>${index + 1}</td>
                    <td>${debt.customer_name}</td>
                    <td>${debt.customer_phone || '-'}</td>
                    <td>
                        <strong style="color: ${remainingDebt > 0 ? '#dc3545' : '#28a745'}">$${remainingDebt.toFixed(2)}</strong>
                        <br><small style="color: #666;">${(remainingDebt * exchangeRate).toLocaleString('uz-UZ')} so'm</small>
                    </td>
                    <td>
                        <strong style="color: #28a745">$${lastPaymentAmount.toFixed(2)}</strong>
                        <br><small style="color: #666;">${(lastPaymentAmount * lastPaymentRate).toLocaleString('uz-UZ')} so'm</small>
                    </td>
                    <td>${lastPayment}</td>
                    <td><span class="status-badge ${status}">${statusText}</span></td>
                    <td>
                        <div class="action-buttons">
                            <a href="/debts/customer/${debt.customer_id}" class="btn-view" style="text-decoration: none;">üëÅÔ∏è Ko'rish</a>
                            ${remainingDebt > 0 ? `<button class="btn-pay" onclick="openPaymentModal(${debt.customer_id})">üí≥ To'lov</button>` : ''}
                            ${remainingDebt > 0 && debt.customer_phone ? `<button class="btn-sms" onclick="sendDebtSMS(${debt.customer_id}, '${debt.customer_name}', ${remainingDebt})">üì± SMS</button>` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = html;
    }

    // Batafsil ma'lumotlarni ko'rish
    async function viewDebtDetails(customerId) {
        currentCustomerId = customerId;
        
        try {
            const response = await fetch(`/api/debts/${customerId}`);
            if (!response.ok) throw new Error('Ma\'lumotlarni yuklashda xatolik');
            
            const data = await response.json();
            
            // Mijoz ma'lumotlarini to'ldirish
            document.getElementById('modalCustomerName').textContent = data.customer.name;
            document.getElementById('modalCustomerPhone').textContent = data.customer.phone || '-';
            document.getElementById('modalCustomerAddress').textContent = data.customer.address || '-';
            document.getElementById('modalTotalDebt').textContent = `$${data.total_debt.toFixed(2)}`;
            document.getElementById('paymentAmount').textContent = `$${data.remaining_debt.toFixed(2)}`;
            
            // Qarzlar tarixi
            const historyBody = document.getElementById('debtHistoryBody');
            if (data.history && data.history.length > 0) {
                const historyHtml = data.history.map(h => {
                    const remaining = h.debt_amount - h.paid_amount;
                    const status = remaining > 0 ? 'debt' : 'paid';
                    const statusText = remaining > 0 ? 'üí≥ Qarzli' : '‚úÖ To\'langan';
                    
                    return `
                        <tr>
                            <td>${h.sale_date}</td>
                            <td>#${h.sale_id}</td>
                            <td>$${h.debt_amount.toFixed(2)}</td>
                            <td>$${h.paid_amount.toFixed(2)}</td>
                            <td><strong style="color: ${remaining > 0 ? '#dc3545' : '#28a745'}">$${remaining.toFixed(2)}</strong></td>
                            <td><span class="status-badge ${status}">${statusText}</span></td>
                        </tr>
                    `;
                }).join('');
                historyBody.innerHTML = historyHtml;
            } else {
                historyBody.innerHTML = '<tr><td colspan="6" class="no-data">üì≠ Qarzlar tarixi yo\'q</td></tr>';
            }
            
            // To'lov maydonlarini tozalash
            document.getElementById('modalPaymentCashUSD').value = '';
            document.getElementById('modalPaymentCashUZS').value = '';
            document.getElementById('modalPaymentClickUSD').value = '';
            document.getElementById('modalPaymentClickUZS').value = '';
            document.getElementById('modalPaymentTerminalUSD').value = '';
            document.getElementById('modalPaymentTerminalUZS').value = '';
            
            // Valyuta konvertatsiyasini sozlash
            setupModalCurrencyConversion();
            
            // Modalni ochish
            document.getElementById('debtModal').style.display = 'flex';
            
            // Fokusni birinchi to'lov maydoniga berish
            setTimeout(() => {
                document.getElementById('modalPaymentCashUSD').focus();
                document.getElementById('modalPaymentCashUSD').select();
            }, 100);
        } catch (error) {
            console.error('Xatolik:', error);
            alert('‚ùå Ma\'lumotlarni yuklashda xatolik yuz berdi');
        }
    }

    // To'lov modalni ochish
    function openPaymentModal(customerId) {
        viewDebtDetails(customerId);
    }

    // Qolgan qarzni maydoniga qo'shish (modal uchun)
    function addModalRemainingToField(fieldId) {
        const debtElement = document.getElementById('paymentAmount');
        if (!debtElement) {
            alert('‚ùå Qarz ma\'lumotlari topilmadi');
            return;
        }
        
        const debtText = debtElement.textContent.replace('$', '').replace(',', '').trim();
        const remainingDebt = parseFloat(debtText) || 0;
        
        const field = document.getElementById(fieldId);
        if (!field) return;
        
        const currentValue = parseFloat(field.value) || 0;
        
        // Hozirgi to'lovlarni hisoblash (tanlangan maydonni hisobga olmasdan)
        let cashUSD = parseFloat(document.getElementById('modalPaymentCashUSD').value) || 0;
        let clickUSD = parseFloat(document.getElementById('modalPaymentClickUSD').value) || 0;
        let terminalUSD = parseFloat(document.getElementById('modalPaymentTerminalUSD').value) || 0;
        
        // Tanlangan maydonning qiymatini 0 qilish (qolganini hisoblash uchun)
        if (fieldId === 'modalPaymentCashUSD') cashUSD = 0;
        if (fieldId === 'modalPaymentClickUSD') clickUSD = 0;
        if (fieldId === 'modalPaymentTerminalUSD') terminalUSD = 0;
        
        const totalPaid = cashUSD + clickUSD + terminalUSD;
        const remaining = remainingDebt - totalPaid;
        
        if (remaining > 0) {
            field.value = remaining.toFixed(2);
            // USD yozilganda UZS ham yangilanadi (avtomatik konvertatsiya)
            field.dispatchEvent(new Event('input'));
        } else {
            alert('‚úÖ Qarz to\'liq to\'landi');
        }
    }

    // Modalni yopish
    function closeModal() {
        document.getElementById('debtModal').style.display = 'none';
        currentCustomerId = null;
    }

    // Valyuta konvertatsiyasini sozlash
    function setupModalCurrencyConversion() {
        // USD ‚Üí UZS va UZS ‚Üí USD avtomatik konvertatsiya
        const cashUsdInput = document.getElementById('modalPaymentCashUSD');
        const cashUzsInput = document.getElementById('modalPaymentCashUZS');
        const clickUsdInput = document.getElementById('modalPaymentClickUSD');
        const clickUzsInput = document.getElementById('modalPaymentClickUZS');
        const terminalUsdInput = document.getElementById('modalPaymentTerminalUSD');
        const terminalUzsInput = document.getElementById('modalPaymentTerminalUZS');

        if (cashUsdInput && cashUzsInput) {
            cashUsdInput.addEventListener('input', function() {
                const usdValue = parseFloat(this.value) || 0;
                cashUzsInput.value = Math.round(usdValue * exchangeRate);
            });
            cashUzsInput.addEventListener('input', function() {
                const uzsValue = parseFloat(this.value) || 0;
                cashUsdInput.value = (uzsValue / exchangeRate).toFixed(2);
            });
        }

        if (clickUsdInput && clickUzsInput) {
            clickUsdInput.addEventListener('input', function() {
                const usdValue = parseFloat(this.value) || 0;
                clickUzsInput.value = Math.round(usdValue * exchangeRate);
            });
            clickUzsInput.addEventListener('input', function() {
                const uzsValue = parseFloat(this.value) || 0;
                clickUsdInput.value = (uzsValue / exchangeRate).toFixed(2);
            });
        }

        if (terminalUsdInput && terminalUzsInput) {
            terminalUsdInput.addEventListener('input', function() {
                const usdValue = parseFloat(this.value) || 0;
                terminalUzsInput.value = Math.round(usdValue * exchangeRate);
            });
            terminalUzsInput.addEventListener('input', function() {
                const uzsValue = parseFloat(this.value) || 0;
                terminalUsdInput.value = (uzsValue / exchangeRate).toFixed(2);
            });
        }
    }

    // To'lovni tasdiqlash
    async function confirmPayment() {
        if (!currentCustomerId) {
            alert('‚ùå Mijoz tanlanmagan');
            return;
        }

        const cashUSD = parseFloat(document.getElementById('modalPaymentCashUSD').value) || 0;
        const clickUSD = parseFloat(document.getElementById('modalPaymentClickUSD').value) || 0;
        const terminalUSD = parseFloat(document.getElementById('modalPaymentTerminalUSD').value) || 0;
        
        const totalPayment = cashUSD + clickUSD + terminalUSD;
        
        if (totalPayment <= 0) {
            alert('‚ùå To\'lov summasini kiriting');
            return;
        }

        const paymentData = {
            customer_id: currentCustomerId,
            cash_usd: cashUSD,
            click_usd: clickUSD,
            terminal_usd: terminalUSD
        };

        try {
            const response = await fetch('/api/debts/payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(paymentData)
            });

            const result = await response.json();

            if (response.ok && result.success) {
                alert('‚úÖ To\'lov muvaffaqiyatli amalga oshirildi!');
                closeModal();
                loadDebts(); // Ma'lumotlarni yangilash
            } else {
                alert('‚ùå Xatolik: ' + (result.error || 'Noma\'lum xatolik'));
            }
        } catch (error) {
            console.error('Xatolik:', error);
            alert('‚ùå To\'lovni amalga oshirishda xatolik yuz berdi');
        }
    }

    // Telegram yuborish funksiyasi
    async function sendDebtSMS(customerId, customerName, debtAmount) {
        if (!confirm(`${customerName}ga qarz eslatmasi Telegram orqali yuborilsinmi?\n\nQarz: $${debtAmount.toFixed(2)}`)) {
            return;
        }

        const button = event.target;
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '‚è≥ Yuborilmoqda...';

        try {
            const response = await fetch('/api/sms/send-debt-reminder', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({customer_id: customerId})
            });

            const result = await response.json();

            if (result.success) {
                alert(`‚úÖ Telegram xabari muvaffaqiyatli yuborildi!\n\nüë§ Mijoz: ${customerName}\nüí∞ Qarz: $${debtAmount.toFixed(2)}`);
            } else {
                alert(`‚ùå Telegram yuborishda xatolik:\n${result.error}`);
            }
        } catch (error) {
            console.error('Telegram xatolik:', error);
            alert(`‚ùå Telegram yuborishda xatolik yuz berdi:\n${error.message}`);
        } finally {
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }

    // Barcha qarzlilarga Telegram yuborish
    async function sendBulkDebtTelegram() {
        const minDebt = prompt('Minimal qarz miqdorini kiriting (USD):', '10');
        if (!minDebt || isNaN(minDebt)) return;

        if (!confirm(`$${minDebt} dan ortiq qarzli barcha mijozlarga Telegram xabari yuborilsinmi?`)) {
            return;
        }

        const loadingDiv = document.createElement('div');
        loadingDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:30px;border-radius:15px;box-shadow:0 8px 32px rgba(0,0,0,0.3);z-index:10000;text-align:center;min-width:300px;';
        loadingDiv.innerHTML = '<div style="font-size:48px;margin-bottom:15px;">üì±</div><div style="font-size:18px;color:#333;margin-bottom:10px;">Telegram yuborilmoqda...</div><div style="font-size:14px;color:#666;">Iltimos kuting</div>';
        document.body.appendChild(loadingDiv);

        try {
            const response = await fetch('/api/telegram/send-bulk-reminders', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({min_debt: parseFloat(minDebt)})
            });

            const result = await response.json();

            if (result.success) {
                let message = `‚úÖ Telegram xabarlari yuborish yakunlandi!\n\n`;
                message += `üìä Statistika:\n`;
                message += `‚úîÔ∏è  Yuborildi: ${result.sent}\n`;
                message += `‚ùå Xatolik: ${result.failed}\n`;

                if (result.errors && result.errors.length > 0) {
                    message += `\n‚ö†Ô∏è  Xatoliklar:\n`;
                    result.errors.slice(0, 5).forEach(e => {
                        message += `- ${e.customer}: ${e.error}\n`;
                    });
                    if (result.errors.length > 5) {
                        message += `... va yana ${result.errors.length - 5} ta xatolik`;
                    }
                }

                alert(message);
                loadDebts(); // Ma'lumotlarni yangilash
            } else {
                alert(`‚ùå Xatolik:\n${result.error}`);
            }
        } catch (error) {
            console.error('Bulk Telegram xatolik:', error);
            alert(`‚ùå Telegram yuborishda xatolik:\n${error.message}`);
        } finally {
            document.body.removeChild(loadingDiv);
        }
    }

    // Sahifa yuklanganda ma'lumotlarni yuklash
    document.addEventListener('DOMContentLoaded', function() {
        loadLocations(); // Locationlarni yuklash
        loadDebts();
    });
</script>
{% endblock %}
