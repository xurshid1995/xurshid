{% extends "base_with_sidebar.html" %}

{% block title %}Qarzlar - Dokon Boshqaruv Tizimi{% endblock %}

{% block extra_css %}
<style>
    .debts-container {
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #dee2e6;
    }

    .page-header h1 {
        margin: 0;
        color: #333;
        font-size: 28px;
        font-weight: 600;
    }

    .stats-cards {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 25px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-left: 4px solid;
    }

    .stat-card.total { border-left-color: #dc3545; }
    .stat-card.paid { border-left-color: #28a745; }
    .stat-card.customers { border-left-color: #ffc107; }

    .stat-card h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #666;
        font-weight: 500;
    }

    .stat-card .value {
        font-size: 28px;
        font-weight: 700;
        color: #333;
    }

    .filters-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .filters-row {
        display: grid;
        grid-template-columns: 1fr 200px 200px 150px;
        gap: 15px;
        align-items: end;
    }

    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
        font-weight: 500;
        color: #495057;
    }

    .filter-group input,
    .filter-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 14px;
    }

    .filter-group button {
        width: 100%;
        padding: 10px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
    }

    .filter-group button:hover {
        background: #0056b3;
    }

    .debts-table-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .debts-table {
        width: 100%;
        border-collapse: collapse;
    }

    .debts-table thead {
        background: #f8f9fa;
    }

    .debts-table th {
        padding: 15px;
        text-align: left;
        font-size: 14px;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
    }

    .debts-table td {
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
        font-size: 14px;
        color: #333;
    }

    .debts-table tbody tr:hover {
        background: #f8f9fa;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-badge.debt {
        background: #fff3cd;
        color: #856404;
    }

    .status-badge.paid {
        background: #d4edda;
        color: #155724;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .btn-view {
        padding: 6px 12px;
        background: #17a2b8;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
    }

    .btn-view:hover {
        background: #138496;
    }

    .btn-pay {
        padding: 6px 12px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
    }

    .btn-pay:hover {
        background: #218838;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        width: 95%;
        max-width: 1200px;
        max-height: 90vh;
        overflow-y: auto;
        overflow-x: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .modal-header {
        padding: 20px;
        border-bottom: 2px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 22px;
        color: #333;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #999;
        line-height: 1;
        padding: 0;
        width: 30px;
        height: 30px;
    }

    .modal-close:hover {
        color: #333;
    }

    .modal-body {
        padding: 20px;
    }

    .customer-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        align-items: center;
    }

    .customer-info h3 {
        margin: 0;
        font-size: 18px;
        color: #333;
        flex: 0 0 100%;
    }

    .customer-info p {
        margin: 0;
        font-size: 14px;
        color: #666;
        white-space: nowrap;
    }

    .debt-history-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

    .debt-history-table th,
    .debt-history-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
        font-size: 14px;
    }

    .debt-history-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }

    .payment-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
    }

    .payment-section h3 {
        margin: 0 0 15px 0;
        font-size: 18px;
        color: #333;
    }

    .payment-methods {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 20px;
    }

    .payment-method {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .payment-method label {
        font-size: 14px;
        font-weight: 500;
        color: #495057;
    }

    .payment-method input {
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 14px;
    }

    .payment-total {
        text-align: right;
        margin-bottom: 15px;
        font-size: 16px;
        font-weight: 600;
        color: #333;
    }

    .payment-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .btn-cancel {
        padding: 10px 20px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
    }

    .btn-cancel:hover {
        background: #5a6268;
    }

    .btn-confirm {
        padding: 10px 20px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
    }

    .btn-confirm:hover {
        background: #218838;
    }

    .no-data {
        text-align: center;
        padding: 40px;
        color: #999;
        font-size: 16px;
    }
</style>
{% endblock %}

{% block content %}
<div class="debts-container">
    <div class="page-header">
        <h1>üí∞ Qarzlar</h1>
    </div>

    <!-- Statistika kartochkalari -->
    <div class="stats-cards">
        <div class="stat-card customers">
            <h3>üë• Qarzli mijozlar</h3>
            <div class="value" id="debtCustomers">0</div>
        </div>
        <div class="stat-card total">
            <h3>üí∞ Umumiy qarz</h3>
            <div class="value" id="totalDebt">$0.00</div>
        </div>
    </div>

    <!-- Filter va qidiruv -->
    <div class="filters-section">
        <div class="filters-row">
            <div class="filter-group">
                <label>üîç Mijoz nomini qidirish</label>
                <input type="text" id="searchInput" placeholder="Mijoz nomini kiriting...">
            </div>
            <div class="filter-group">
                <label>üìã Status</label>
                <select id="statusFilter">
                    <option value="all">Hammasi</option>
                    <option value="debt">Qarzli</option>
                    <option value="paid">To'langan</option>
                </select>
            </div>
            <div class="filter-group">
                <label>üìÖ Sana</label>
                <input type="date" id="dateFilter">
            </div>
            <div class="filter-group">
                <label>&nbsp;</label>
                <button onclick="applyFilters()">üîé Qidirish</button>
            </div>
        </div>
    </div>

    <!-- Qarzlar jadvali -->
    <div class="debts-table-container">
        <h2 style="margin-bottom: 15px; color: #dc3545; display: flex; align-items: center; gap: 10px;">
            <span>üí≥ Qarzli mijozlar</span>
        </h2>
        <table class="debts-table">
            <thead>
                <tr>
                    <th>‚Ññ</th>
                    <th>üë§ Mijoz</th>
                    <th>üìû Telefon</th>
                    <th> Qolgan qarz</th>
                    <th>üíµ Oxirgi to'lov</th>
                    <th>üìÖ Oxirgi to'lov sanasi</th>
                    <th>üè∑Ô∏è Status</th>
                    <th>‚öôÔ∏è Amallar</th>
                </tr>
            </thead>
            <tbody id="debtsTableBody">
                <tr>
                    <td colspan="8" class="no-data">Ma'lumotlar yuklanmoqda...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- To'langan qarzlar jadvali -->
    <div class="debts-table-container" style="margin-top: 30px;">
        <h2 style="margin-bottom: 15px; color: #28a745; display: flex; align-items: center; gap: 10px;">
            <span>‚úÖ To'langan qarzlar tarixi</span>
        </h2>
        <table class="debts-table">
            <thead>
                <tr>
                    <th>‚Ññ</th>
                    <th>üìÖ Sana</th>
                    <th>üë§ Mijoz</th>
                    <th>üõí Savdo ‚Ññ</th>
                    <th>üíµ Summa</th>
                    <th>üí≥ To'lov turlari</th>
                </tr>
            </thead>
            <tbody id="paidDebtsTableBody">
                <tr>
                    <td colspan="6" class="no-data">Ma'lumotlar yuklanmoqda...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Batafsil modal -->
<div id="debtModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üìã Qarz ma'lumotlari</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Mijoz ma'lumotlari va To'lov qilish yonma-yon -->
            <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                <!-- Mijoz ma'lumotlari -->
                <div class="customer-info" style="flex: 1; min-width: 300px;">
                    <h3 id="modalCustomerName">-</h3>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">
                        <p><strong>üìû Telefon:</strong> <span id="modalCustomerPhone">-</span></p>
                        <p><strong>üìç Manzil:</strong> <span id="modalCustomerAddress">-</span></p>
                        <p><strong>üí∞ Umumiy qarz:</strong> <span id="modalTotalDebt">$0.00</span></p>
                    </div>
                </div>

                <!-- To'lov qilish bo'limi -->
                <div class="payment-section" style="flex: 1; min-width: 400px; margin-bottom: 0;">
                    <h3>üí≥ Qarzga to'lov qilish</h3>
                    <div class="payment-total">
                        Qarz summasi: <span id="paymentAmount">$0.00</span>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 12px; color: #333; font-size: 16px;">To'lov turlari</h4>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-weight: 500; white-space: nowrap; min-width: 90px;">üíµ Naqd:</label>
                                <div style="flex: 1; display: flex; align-items: center; gap: 4px;">
                                    <span style="font-weight: 700; color: #28a745; font-size: 16px;">$</span>
                                    <input type="number" id="modalPaymentCashUSD" step="0.01" value="0.00" placeholder="0.00" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div style="flex: 1; display: flex; align-items: center; gap: 4px;">
                                    <span style="font-weight: 700; color: #6c757d; font-size: 16px;">UZS</span>
                                    <input type="number" id="modalPaymentCashUZS" step="1" value="0" placeholder="0" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; background: #f8f9fa;" readonly>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-weight: 500; white-space: nowrap; min-width: 90px;">üì± Click:</label>
                                <div style="flex: 1; display: flex; align-items: center; gap: 4px;">
                                    <span style="font-weight: 700; color: #28a745; font-size: 16px;">$</span>
                                    <input type="number" id="modalPaymentClickUSD" step="0.01" value="0.00" placeholder="0.00" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div style="flex: 1; display: flex; align-items: center; gap: 4px;">
                                    <span style="font-weight: 700; color: #6c757d; font-size: 16px;">UZS</span>
                                    <input type="number" id="modalPaymentClickUZS" step="1" value="0" placeholder="0" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; background: #f8f9fa;" readonly>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-weight: 500; white-space: nowrap; min-width: 90px;">üèß Terminal:</label>
                                <div style="flex: 1; display: flex; align-items: center; gap: 4px;">
                                    <span style="font-weight: 700; color: #28a745; font-size: 16px;">$</span>
                                    <input type="number" id="modalPaymentTerminalUSD" step="0.01" value="0.00" placeholder="0.00" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div style="flex: 1; display: flex; align-items: center; gap: 4px;">
                                    <span style="font-weight: 700; color: #6c757d; font-size: 16px;">UZS</span>
                                    <input type="number" id="modalPaymentTerminalUZS" step="1" value="0" placeholder="0" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; background: #f8f9fa;" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="payment-actions">
                        <button class="btn-cancel" onclick="closeModal()">‚ùå Bekor qilish</button>
                        <button class="btn-confirm" onclick="confirmPayment()">‚úÖ To'lovni tasdiqlash</button>
                    </div>
                </div>
            </div>

            <!-- Qarzlar tarixi -->
            <h3>üìú Qarzlar tarixi</h3>
            <table class="debt-history-table">
                <thead>
                    <tr>
                        <th>üìÖ Sana</th>
                        <th>üõí Savdo ‚Ññ</th>
                        <th>üíµ Summa</th>
                        <th>‚úÖ To'langan</th>
                        <th>üìä Qolgan</th>
                        <th>üè∑Ô∏è Status</th>
                    </tr>
                </thead>
                <tbody id="debtHistoryBody">
                    <tr>
                        <td colspan="6" class="no-data">Ma'lumot yo'q</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let debts = [];
    let currentCustomerId = null;
    let exchangeRate = 13000;

    // Ma'lumotlarni yuklash
    async function loadDebts() {
        try {
            const response = await fetch('/api/debts');
            if (!response.ok) throw new Error('Ma\'lumotlarni yuklashda xatolik');
            
            const data = await response.json();
            debts = data.debts || [];
            exchangeRate = data.exchange_rate || 13000;
            
            updateStats();
            renderDebtsTable();
            loadPaidDebts(); // To'langan qarzlarni yuklash
        } catch (error) {
            console.error('Xatolik:', error);
            document.getElementById('debtsTableBody').innerHTML = 
                '<tr><td colspan="9" class="no-data">‚ùå Ma\'lumotlarni yuklashda xatolik</td></tr>';
        }
    }
    
    // To'langan qarzlarni yuklash
    async function loadPaidDebts() {
        try {
            const response = await fetch('/api/debts/paid');
            if (!response.ok) throw new Error('Ma\'lumotlarni yuklashda xatolik');
            
            const data = await response.json();
            renderPaidDebtsTable(data.paid_debts || []);
        } catch (error) {
            console.error('Xatolik:', error);
            document.getElementById('paidDebtsTableBody').innerHTML = 
                '<tr><td colspan="6" class="no-data">‚ùå Ma\'lumotlarni yuklashda xatolik</td></tr>';
        }
    }
    
    // To'langan qarzlar jadvalini render qilish
    function renderPaidDebtsTable(paidDebts) {
        const tbody = document.getElementById('paidDebtsTableBody');
        
        if (paidDebts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="no-data">üì≠ To\'langan qarzlar yo\'q</td></tr>';
            return;
        }

        const html = paidDebts.map((debt, index) => {
            // To'lov turlarini aniqlash
            const payments = [];
            if (debt.cash_usd > 0) payments.push(`üíµ Naqd: $${debt.cash_usd.toFixed(2)}`);
            if (debt.click_usd > 0) payments.push(`üì± Click: $${debt.click_usd.toFixed(2)}`);
            if (debt.terminal_usd > 0) payments.push(`üèß Terminal: $${debt.terminal_usd.toFixed(2)}`);
            
            const paymentText = payments.length > 0 ? payments.join(', ') : '-';
            
            return `
                <tr>
                    <td>${index + 1}</td>
                    <td>${debt.sale_date}</td>
                    <td>${debt.customer_name}</td>
                    <td><strong>#${debt.sale_id}</strong></td>
                    <td><strong style="color: #28a745">$${debt.total_amount.toFixed(2)}</strong></td>
                    <td style="font-size: 13px;">${paymentText}</td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = html;
    }

    // Statistikani yangilash
    function updateStats() {
        const totalDebt = debts.reduce((sum, d) => sum + (d.remaining_debt || 0), 0);
        const debtCustomers = debts.filter(d => (d.remaining_debt || 0) > 0).length;

        document.getElementById('debtCustomers').textContent = debtCustomers;
        document.getElementById('totalDebt').textContent = `$${totalDebt.toFixed(2)}`;
    }

    // Jadvalni render qilish
    function renderDebtsTable() {
        const tbody = document.getElementById('debtsTableBody');
        
        if (debts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="no-data">üì≠ Qarzlar yo\'q</td></tr>';
            return;
        }

        const html = debts.map((debt, index) => {
            const remainingDebt = debt.remaining_debt || 0;
            const status = remainingDebt > 0 ? 'debt' : 'paid';
            const statusText = remainingDebt > 0 ? 'üí≥ Qarzli' : '‚úÖ To\'langan';
            const lastPayment = debt.last_payment_date || '-';
            const lastPaymentAmount = debt.last_payment_amount || 0;
            const lastPaymentRate = debt.last_payment_rate || exchangeRate;

            return `
                <tr>
                    <td>${index + 1}</td>
                    <td>${debt.customer_name}</td>
                    <td>${debt.customer_phone || '-'}</td>
                    <td>
                        <strong style="color: ${remainingDebt > 0 ? '#dc3545' : '#28a745'}">$${remainingDebt.toFixed(2)}</strong>
                        <br><small style="color: #666;">${(remainingDebt * exchangeRate).toLocaleString('uz-UZ')} so'm</small>
                    </td>
                    <td>
                        <strong style="color: #28a745">$${lastPaymentAmount.toFixed(2)}</strong>
                        <br><small style="color: #666;">${(lastPaymentAmount * lastPaymentRate).toLocaleString('uz-UZ')} so'm</small>
                    </td>
                    <td>${lastPayment}</td>
                    <td><span class="status-badge ${status}">${statusText}</span></td>
                    <td>
                        <div class="action-buttons">
                            <a href="/debts/customer/${debt.customer_id}" class="btn-view" style="text-decoration: none;">üëÅÔ∏è Ko'rish</a>
                            ${remainingDebt > 0 ? `<button class="btn-pay" onclick="openPaymentModal(${debt.customer_id})">üí≥ To'lov</button>` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = html;
    }

    // Filterlarni qo'llash
    function applyFilters() {
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;
        const date = document.getElementById('dateFilter').value;

        let filtered = debts;

        if (searchText) {
            filtered = filtered.filter(d => 
                d.customer_name.toLowerCase().includes(searchText)
            );
        }

        if (status === 'debt') {
            filtered = filtered.filter(d => (d.remaining_debt || 0) > 0);
        } else if (status === 'paid') {
            filtered = filtered.filter(d => (d.remaining_debt || 0) === 0);
        }

        // Jadvalni yangilash
        const tbody = document.getElementById('debtsTableBody');
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="no-data">üì≠ Natija topilmadi</td></tr>';
            return;
        }

        const html = filtered.map((debt, index) => {
            const remainingDebt = debt.remaining_debt || 0;
            const status = remainingDebt > 0 ? 'debt' : 'paid';
            const statusText = remainingDebt > 0 ? 'üí≥ Qarzli' : '‚úÖ To\'langan';
            const lastPayment = debt.last_payment_date || '-';
            const lastPaymentAmount = debt.last_payment_amount || 0;
            const lastPaymentRate = debt.last_payment_rate || exchangeRate;

            return `
                <tr>
                    <td>${index + 1}</td>
                    <td>${debt.customer_name}</td>
                    <td>${debt.customer_phone || '-'}</td>
                    <td>
                        <strong style="color: ${remainingDebt > 0 ? '#dc3545' : '#28a745'}">$${remainingDebt.toFixed(2)}</strong>
                        <br><small style="color: #666;">${(remainingDebt * exchangeRate).toLocaleString('uz-UZ')} so'm</small>
                    </td>
                    <td>
                        <strong style="color: #28a745">$${lastPaymentAmount.toFixed(2)}</strong>
                        <br><small style="color: #666;">${(lastPaymentAmount * lastPaymentRate).toLocaleString('uz-UZ')} so'm</small>
                    </td>
                    <td>${lastPayment}</td>
                    <td><span class="status-badge ${status}">${statusText}</span></td>
                    <td>
                        <div class="action-buttons">
                            <a href="/debts/customer/${debt.customer_id}" class="btn-view" style="text-decoration: none;">üëÅÔ∏è Ko'rish</a>
                            ${remainingDebt > 0 ? `<button class="btn-pay" onclick="openPaymentModal(${debt.customer_id})">üí≥ To'lov</button>` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = html;
    }

    // Batafsil ma'lumotlarni ko'rish
    async function viewDebtDetails(customerId) {
        currentCustomerId = customerId;
        
        try {
            const response = await fetch(`/api/debts/${customerId}`);
            if (!response.ok) throw new Error('Ma\'lumotlarni yuklashda xatolik');
            
            const data = await response.json();
            
            // Mijoz ma'lumotlarini to'ldirish
            document.getElementById('modalCustomerName').textContent = data.customer.name;
            document.getElementById('modalCustomerPhone').textContent = data.customer.phone || '-';
            document.getElementById('modalCustomerAddress').textContent = data.customer.address || '-';
            document.getElementById('modalTotalDebt').textContent = `$${data.total_debt.toFixed(2)}`;
            document.getElementById('paymentAmount').textContent = `$${data.remaining_debt.toFixed(2)}`;
            
            // Qarzlar tarixi
            const historyBody = document.getElementById('debtHistoryBody');
            if (data.history && data.history.length > 0) {
                const historyHtml = data.history.map(h => {
                    const remaining = h.debt_amount - h.paid_amount;
                    const status = remaining > 0 ? 'debt' : 'paid';
                    const statusText = remaining > 0 ? 'üí≥ Qarzli' : '‚úÖ To\'langan';
                    
                    return `
                        <tr>
                            <td>${h.sale_date}</td>
                            <td>#${h.sale_id}</td>
                            <td>$${h.debt_amount.toFixed(2)}</td>
                            <td>$${h.paid_amount.toFixed(2)}</td>
                            <td><strong style="color: ${remaining > 0 ? '#dc3545' : '#28a745'}">$${remaining.toFixed(2)}</strong></td>
                            <td><span class="status-badge ${status}">${statusText}</span></td>
                        </tr>
                    `;
                }).join('');
                historyBody.innerHTML = historyHtml;
            } else {
                historyBody.innerHTML = '<tr><td colspan="6" class="no-data">üì≠ Qarzlar tarixi yo\'q</td></tr>';
            }
            
            // To'lov maydonlarini tozalash
            document.getElementById('modalPaymentCashUSD').value = '0.00';
            document.getElementById('modalPaymentCashUZS').value = '0';
            document.getElementById('modalPaymentClickUSD').value = '0.00';
            document.getElementById('modalPaymentClickUZS').value = '0';
            document.getElementById('modalPaymentTerminalUSD').value = '0.00';
            document.getElementById('modalPaymentTerminalUZS').value = '0';
            
            // Valyuta konvertatsiyasini sozlash
            setupModalCurrencyConversion();
            
            // Modalni ochish
            document.getElementById('debtModal').style.display = 'flex';
            
            // Fokusni birinchi to'lov maydoniga berish
            setTimeout(() => {
                document.getElementById('modalPaymentCashUSD').focus();
                document.getElementById('modalPaymentCashUSD').select();
            }, 100);
        } catch (error) {
            console.error('Xatolik:', error);
            alert('‚ùå Ma\'lumotlarni yuklashda xatolik yuz berdi');
        }
    }

    // To'lov modalni ochish
    function openPaymentModal(customerId) {
        viewDebtDetails(customerId);
    }

    // Modalni yopish
    function closeModal() {
        document.getElementById('debtModal').style.display = 'none';
        currentCustomerId = null;
    }

    // Valyuta konvertatsiyasini sozlash
    function setupModalCurrencyConversion() {
        // USD ‚Üí UZS avtomatik konvertatsiya
        const cashUsdInput = document.getElementById('modalPaymentCashUSD');
        const cashUzsInput = document.getElementById('modalPaymentCashUZS');
        const clickUsdInput = document.getElementById('modalPaymentClickUSD');
        const clickUzsInput = document.getElementById('modalPaymentClickUZS');
        const terminalUsdInput = document.getElementById('modalPaymentTerminalUSD');
        const terminalUzsInput = document.getElementById('modalPaymentTerminalUZS');

        if (cashUsdInput && cashUzsInput) {
            cashUsdInput.addEventListener('input', function() {
                const usdValue = parseFloat(this.value) || 0;
                cashUzsInput.value = Math.round(usdValue * exchangeRate);
            });
        }

        if (clickUsdInput && clickUzsInput) {
            clickUsdInput.addEventListener('input', function() {
                const usdValue = parseFloat(this.value) || 0;
                clickUzsInput.value = Math.round(usdValue * exchangeRate);
            });
        }

        if (terminalUsdInput && terminalUzsInput) {
            terminalUsdInput.addEventListener('input', function() {
                const usdValue = parseFloat(this.value) || 0;
                terminalUzsInput.value = Math.round(usdValue * exchangeRate);
            });
        }
    }

    // To'lovni tasdiqlash
    async function confirmPayment() {
        if (!currentCustomerId) {
            alert('‚ùå Mijoz tanlanmagan');
            return;
        }

        const cashUSD = parseFloat(document.getElementById('modalPaymentCashUSD').value) || 0;
        const clickUSD = parseFloat(document.getElementById('modalPaymentClickUSD').value) || 0;
        const terminalUSD = parseFloat(document.getElementById('modalPaymentTerminalUSD').value) || 0;
        
        const totalPayment = cashUSD + clickUSD + terminalUSD;
        
        if (totalPayment <= 0) {
            alert('‚ùå To\'lov summasini kiriting');
            return;
        }

        const paymentData = {
            customer_id: currentCustomerId,
            cash_usd: cashUSD,
            click_usd: clickUSD,
            terminal_usd: terminalUSD
        };

        try {
            const response = await fetch('/api/debts/payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(paymentData)
            });

            const result = await response.json();

            if (response.ok && result.success) {
                alert('‚úÖ To\'lov muvaffaqiyatli amalga oshirildi!');
                closeModal();
                loadDebts(); // Ma'lumotlarni yangilash
            } else {
                alert('‚ùå Xatolik: ' + (result.error || 'Noma\'lum xatolik'));
            }
        } catch (error) {
            console.error('Xatolik:', error);
            alert('‚ùå To\'lovni amalga oshirishda xatolik yuz berdi');
        }
    }

    // Sahifa yuklanganda ma'lumotlarni yuklash
    document.addEventListener('DOMContentLoaded', function() {
        loadDebts();
        
        // Qidiruv maydoni uchun real-time qidiruv
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
    });
</script>
{% endblock %}
