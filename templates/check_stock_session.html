{% extends "base.html" %}

{% block title %}{{ location_name }} - Qoldiqni tekshirish{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Sahifa sarlavhasi -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="margin: 0;"><i class="fas fa-clipboard-check"></i> {{ location_name }} - Qoldiqni tekshirish</h2>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <button type="button" onclick="finishCheck()" style="background-color: #dc3545 !important; color: white !important; border: none !important; padding: 0.5rem 1rem; font-size: 1.25rem; border-radius: 0.5rem; cursor: pointer;">
                            <i class="fas fa-check me-2"></i>Tekshiruvni yakunlash
                        </button>
                        <a href="/check_stock" class="btn btn-secondary btn-lg">
                            <i class="fas fa-arrow-left me-2"></i>Orqaga
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ikkita jadval - Transfer kabi -->
    <div style="display: grid; grid-template-columns: 665px 715px; gap: 20px; justify-content: center; padding: 20px; align-items: start;">
        <!-- Chap jadval - Mahsulotlar ro'yxati -->
        <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 665px; box-sizing: border-box;">
            <div style="background: linear-gradient(135deg, #5B9BD5, #4A90D9); padding: 15px; border-radius: 8px; margin-bottom: 10px; height: 54px; display: flex; align-items: center;">
                <div style="color: white; font-weight: 600; font-size: 16px;">üì¶ Mahsulotlar ro'yxati</div>
            </div>

            <div style="margin-bottom: 10px;">
                <input type="text" 
                       id="productSearch" 
                       placeholder="üîç Mahsulot / Barcode qidirish..." 
                       style="width: 100%; padding: 10px 12px; border: 2px solid #28a745; border-radius: 25px; font-size: 14px;"
                       autofocus>
            </div>

            <div style="border: 1px solid #dee2e6; border-radius: 4px; margin-top: 10px; overflow-x: hidden;">
                <table style="width: 625px !important; min-width: 625px !important; border-collapse: collapse;">
                    <thead style="position: sticky; top: 0; background: linear-gradient(135deg, #5B9BD5, #4A90D9); z-index: 10;">
                        <tr>
                            <th style="width: 365px; color: white; padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Mahsulot</th>
                            <th style="width: 100px; text-align: center; color: white; padding: 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Narx</th>
                            <th style="width: 85px; text-align: center; color: white; padding: 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Mavjud</th>
                            <th style="width: 75px; text-align: center; color: white; padding: 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Amal</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 40px 20px; color: #999;">
                                <div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">üì¶</div>
                                <div>Qidirish orqali mahsulot tanlang</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- O'ng jadval - Tekshirilgan mahsulotlar -->
        <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 715px; box-sizing: border-box;">
            <div style="background: linear-gradient(135deg, #5B9BD5, #4A90D9); padding: 15px; border-radius: 8px; margin-bottom: 10px; height: 54px; display: flex; align-items: center; justify-content: space-between;">
                <div style="color: white; font-weight: 600; font-size: 16px;">‚úÖ Tekshirilgan mahsulotlar</div>
                <div style="color: white; font-size: 16px;">
                    <span id="checkedCount" style="background: rgba(255,255,255,0.25); padding: 2px 8px; border-radius: 10px; font-weight: 600;">0</span> ta
                </div>
            </div>

            <div style="margin-bottom: 10px;">
                <input type="text" 
                       id="checkedSearch" 
                       placeholder="üîç Tekshirilganlardan qidirish..." 
                       style="width: 100%; padding: 10px 12px; border: 1px solid #ced4da; border-radius: 25px; font-size: 14px;">
            </div>

            <div style="border: 1px solid #dee2e6; border-radius: 4px; margin-top: 10px; overflow-x: hidden;">
                <table style="width: 675px !important; min-width: 675px !important; border-collapse: collapse;">
                    <thead style="position: sticky; top: 0; background: linear-gradient(135deg, #5B9BD5, #4A90D9); z-index: 10;">
                        <tr>
                            <th style="width: 250px; color: white; padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Mahsulot nomi</th>
                            <th style="width: 80px; text-align: center; color: white; padding: 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Narxi</th>
                            <th style="width: 70px; text-align: center; color: white; padding: 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Tizimda</th>
                            <th style="width: 70px; text-align: center; color: white; padding: 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Haqiqiy</th>
                            <th style="width: 70px; text-align: center; color: white; padding: 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Xatolik</th>
                            <th style="width: 70px; text-align: center; color: white; padding: 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Holat</th>
                            <th style="width: 65px; text-align: center; color: white; padding: 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Amal</th>
                        </tr>
                    </thead>
                    <tbody id="checkedTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px 20px; color: #999;">
                                <div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">üìã</div>
                                <div>Hali mahsulot tekshirilmagan</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
.page-header {
    background: white;
    color: #333;
    padding: 0.75rem 2rem;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.page-header h2 {
    font-size: 1.5rem;
    font-weight: 600;
}

.card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-radius: 10px;
}

.card-header {
    border-radius: 10px 10px 0 0 !important;
}

.table-responsive {
    max-height: 600px;
    overflow-y: auto;
}

.table thead th {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 10;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
}

.quantity-input {
    width: 100px;
    text-align: center;
}

.diff-positive {
    color: #28a745;
    font-weight: 600;
}

.diff-negative {
    color: #dc3545;
    font-weight: 600;
}

.diff-zero {
    color: #6c757d;
}
</style>

<script>
const sessionId = '{{ session_id }}';
const locationType = '{{ location_type }}';
const locationId = {{ location_id }};
let checkedProducts = [];
let allProducts = [];

// Sahifa yuklanganda mahsulotlarni yuklash
document.addEventListener('DOMContentLoaded', function() {
    loadAllProducts();
});

// Barcha mahsulotlarni yuklash
async function loadAllProducts() {
    try {
        const response = await fetch(`/api/check_stock/products?location_type=${locationType}&location_id=${locationId}`);
        const data = await response.json();
        
        if (data.success && data.products.length > 0) {
            allProducts = data.products;
            displayProducts(allProducts);
        } else {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align: center; padding: 40px 20px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">üì¶</div>
                        <div>Mahsulotlar topilmadi</div>
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        console.error('Mahsulotlarni yuklashda xatolik:', error);
        alert('Mahsulotlarni yuklashda xatolik yuz berdi');
    }
}

// Mahsulotni qidirish
document.getElementById('productSearch').addEventListener('input', function(e) {
    const query = e.target.value.trim().toLowerCase();
    if (query.length === 0) {
        displayProducts(allProducts);
    } else {
        const filtered = allProducts.filter(p => 
            p.name.toLowerCase().includes(query) || 
            (p.barcode && p.barcode.toLowerCase().includes(query))
        );
        displayProducts(filtered);
    }
});

// Mahsulotlarni qidirish
async function searchProducts(query) {
    try {
        const response = await fetch(`/api/check_stock/search?query=${encodeURIComponent(query)}&location_type=${locationType}&location_id=${locationId}`);
        const data = await response.json();
        
        if (data.success && data.products.length > 0) {
            displayProducts(data.products);
        } else {
            alert('Mahsulot topilmadi');
        }
    } catch (error) {
        console.error('Qidiruv xatosi:', error);
        alert('Qidiruvda xatolik yuz berdi');
    }
}

// Mahsulotlarni ko'rsatish
function displayProducts(products) {
    const tbody = document.getElementById('productsTableBody');
    
    if (products.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; padding: 40px 20px; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">üîç</div>
                    <div>Mahsulot topilmadi</div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = '';
    
    products.forEach((product) => {
        const row = document.createElement('tr');
        row.style.cursor = 'pointer';
        row.onclick = () => addToChecked(product);
        
        row.innerHTML = `
            <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px;">
                <strong>${product.name}</strong>
            </td>
            <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
                ${product.price ? product.price.toLocaleString() : '-'}
            </td>
            <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
                <span style="background: #17a2b8; color: white; padding: 2px 8px; border-radius: 4px; font-weight: 600;">
                    ${product.system_quantity}
                </span>
            </td>
            <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
                <button onclick="event.stopPropagation(); addToChecked(product)" 
                        style="background: transparent; color: #28a745; border: none; padding: 4px 8px; cursor: pointer; font-size: 24px;">
                    ‚û°Ô∏è
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// Mahsulotni tekshirilganlarga qo'shish
function addToChecked(product) {
    // Avval tekshirilganlar ichida bormi deb tekshirish
    const exists = checkedProducts.find(p => p.id === product.id);
    if (exists) {
        alert('Bu mahsulot allaqachon tekshirilgan!');
        return;
    }
    
    // Tekshirilganlarga qo'shish
    checkedProducts.push({
        id: product.id,
        name: product.name,
        price: product.price,
        system_quantity: product.system_quantity,
        actual_quantity: product.system_quantity,
        difference: 0,
        status: 'normal'
    });
    
    updateCheckedTable();
    updateCheckedCount();
}

// Tekshirilganlar jadvalini yangilash
function updateCheckedTable() {
    const tbody = document.getElementById('checkedTableBody');
    
    if (checkedProducts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 40px 20px; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">üìã</div>
                    <div>Hali mahsulot tekshirilmagan</div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = '';
    
    checkedProducts.forEach((product) => {
        const row = document.createElement('tr');
        
        // Xatolik rangini aniqlash
        let errorColor = '#6c757d';
        if (product.difference > 0) errorColor = '#28a745';
        if (product.difference < 0) errorColor = '#dc3545';
        
        // Holat badge
        let statusBadge = '<span style="background: #6c757d; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Normal</span>';
        if (product.difference > 0) statusBadge = '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Ortiqcha</span>';
        if (product.difference < 0) statusBadge = '<span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Kamomad</span>';
        
        row.innerHTML = `
            <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px;">
                ${product.name}
            </td>
            <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
                ${product.price ? product.price.toLocaleString() : '-'}
            </td>
            <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
                ${product.system_quantity}
            </td>
            <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
                <input type="number" 
                       value="${product.actual_quantity}" 
                       onchange="updateActualQuantity(${product.id}, this.value)"
                       style="width: 60px; text-align: center; padding: 4px; border: 1px solid #ced4da; border-radius: 4px;">
            </td>
            <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center; color: ${errorColor}; font-weight: 600;">
                ${product.difference > 0 ? '+' : ''}${product.difference}
            </td>
            <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
                ${statusBadge}
            </td>
            <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
                <button onclick="removeFromChecked(${product.id})" 
                        style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                    üóëÔ∏è
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// Haqiqiy miqdorni yangilash
function updateActualQuantity(productId, actualQty) {
    const product = checkedProducts.find(p => p.id === productId);
    if (product) {
        product.actual_quantity = parseFloat(actualQty) || 0;
        product.difference = product.actual_quantity - product.system_quantity;
        updateCheckedTable();
    }
}

// Tekshirilganlardan o'chirish
function removeFromChecked(productId) {
    checkedProducts = checkedProducts.filter(p => p.id !== productId);
    updateCheckedTable();
    updateCheckedCount();
}

// Tekshirilganlar sonini yangilash
function updateCheckedCount() {
    document.getElementById('checkedCount').textContent = checkedProducts.length;
}

// Tekshiruvni yakunlash
async function finishCheck() {
    if (checkedProducts.length === 0) {
        alert('Hech qanday mahsulot tekshirilmagan!');
        return;
    }
    
    if (!confirm(`${checkedProducts.length} ta mahsulot tekshirildi. Tekshiruvni yakunlaysizmi?`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/check_stock/finish', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: sessionId,
                location_type: locationType,
                location_id: locationId,
                products: checkedProducts
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Tekshiruv muvaffaqiyatli yakunlandi!');
            window.location.href = '/check_stock';
        } else {
            alert('Xatolik: ' + (data.message || 'Tekshiruvni yakunlab bo\'lmadi'));
        }
    } catch (error) {
        console.error('Tekshiruvni yakunlashda xatolik:', error);
        alert('Tekshiruvni yakunlashda xatolik yuz berdi');
    }
}
</script>

{% endblock %}
