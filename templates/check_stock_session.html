{% extends "base.html" %}

{% block title %}{{ location_name }} - Qoldiqni tekshirish{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Sahifa sarlavhasi -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="margin: 0;"><i class="fas fa-clipboard-check"></i> {{ location_name }} - Qoldiqni tekshirish</h2>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <button type="button" onclick="finishCheck()" style="background-color: #dc3545 !important; color: white !important; border: none !important; padding: 0.5rem 1rem; font-size: 1.25rem; border-radius: 0.5rem; cursor: pointer;">
                            <i class="fas fa-check me-2"></i>Tekshiruvni yakunlash
                        </button>
                        <a href="/check_stock" class="btn btn-secondary btn-lg">
                            <i class="fas fa-arrow-left me-2"></i>Orqaga
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ikkita jadval - Transfer kabi -->
    <div style="display: grid; grid-template-columns: 550px 830px; gap: 20px; justify-content: center; padding: 20px; align-items: start;">
        <!-- Chap jadval - Mahsulotlar ro'yxati -->
        <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 550px; box-sizing: border-box;">
            <div style="background: #2563eb; padding: 15px; border-radius: 8px; margin-bottom: 10px; height: 54px; display: flex; align-items: center; justify-content: space-between;">
                <div style="color: white; font-weight: 600; font-size: 16px;">üì¶ Mahsulotlar ro'yxati</div>
                <div style="color: white; font-size: 16px;">
                    <span id="productsCount" style="background: rgba(255,255,255,0.25); padding: 2px 8px; border-radius: 10px; font-weight: 600;">0</span> ta
                </div>
            </div>

            <div style="margin-bottom: 10px;">
                <input type="text" 
                       id="productSearch" 
                       placeholder="üîç Mahsulot / Barcode qidirish..." 
                       style="width: 100%; padding: 10px 12px; border: 2px solid #28a745; border-radius: 25px; font-size: 14px;"
                       autofocus>
            </div>

            <div style="border: 1px solid #dee2e6; border-radius: 4px; margin-top: 10px; overflow-x: hidden;">
                <table style="width: 510px !important; min-width: 510px !important; border-collapse: collapse;">
                    <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                        <tr>
                            <th style="width: 280px; color: #333; padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Mahsulot</th>
                            <th style="width: 80px; text-align: center; color: #333; padding: 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Narx</th>
                            <th style="width: 80px; text-align: center; color: #333; padding: 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Mavjud</th>
                            <th style="width: 70px; text-align: center; color: #333; padding: 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Amal</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 40px 20px; color: #999;">
                                <div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">üì¶</div>
                                <div>Qidirish orqali mahsulot tanlang</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- O'ng jadval - Tekshirilgan mahsulotlar -->
        <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 830px; box-sizing: border-box;">
            <div style="background: #2563eb; padding: 15px; border-radius: 8px; margin-bottom: 10px; height: 54px; display: flex; align-items: center; justify-content: space-between;">
                <div style="color: white; font-weight: 600; font-size: 16px;">‚úÖ Tekshirilgan mahsulotlar</div>
                <div style="color: white; font-size: 16px;">
                    <span id="checkedCount" style="background: rgba(255,255,255,0.25); padding: 2px 8px; border-radius: 10px; font-weight: 600;">0</span> ta
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" 
                       id="checkedSearch" 
                       placeholder="üîç Tekshirilganlardan qidirish..." 
                       style="flex: 1; padding: 10px 12px; border: 1px solid #ced4da; border-radius: 25px; font-size: 14px;">
                <div style="display: flex; gap: 5px;">
                    <button onclick="filterChecked('all')" id="filterAll" 
                            style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 25px; cursor: pointer; font-size: 13px; font-weight: 600; white-space: nowrap;">
                        üìä Tekshirilgan <span id="allCount" style="background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 50px; margin-left: 4px; min-width: 25px; display: inline-block; text-align: center;">0</span>
                    </button>
                    <button onclick="filterChecked('error')" id="filterError" 
                            style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 25px; cursor: pointer; font-size: 13px; font-weight: 600; white-space: nowrap;">
                        ‚ö†Ô∏è Xatolik <span id="errorCount" style="background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 50px; margin-left: 4px; min-width: 25px; display: inline-block; text-align: center;">0</span>
                    </button>
                    <button onclick="filterChecked('correct')" id="filterCorrect" 
                            style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 25px; cursor: pointer; font-size: 13px; font-weight: 600; white-space: nowrap;">
                        ‚úÖ To'g'ri <span id="correctCount" style="background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 50px; margin-left: 4px; min-width: 25px; display: inline-block; text-align: center;">0</span>
                    </button>
                </div>
            </div>

            <div style="border: 1px solid #dee2e6; border-radius: 4px; margin-top: 10px; overflow-x: hidden;">
                <table style="width: 790px !important; min-width: 790px !important; border-collapse: collapse;">
                    <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                        <tr>
                            <th style="width: 350px; color: #333; padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Mahsulot nomi</th>
                            <th style="width: 90px; text-align: center; color: #333; padding: 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Narxi</th>
                            <th style="width: 80px; text-align: center; color: #333; padding: 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Tizimda</th>
                            <th style="width: 80px; text-align: center; color: #333; padding: 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Haqiqiy</th>
                            <th style="width: 80px; text-align: center; color: #333; padding: 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Xatolik</th>
                            <th style="width: 80px; text-align: center; color: #333; padding: 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Holat</th>
                            <th style="width: 70px; text-align: center; color: #333; padding: 10px; border-bottom: 2px solid #dee2e6; font-weight: 600; font-size: 13px;">Amal</th>
                        </tr>
                    </thead>
                    <tbody id="checkedTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px 20px; color: #999;">
                                <div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">üìã</div>
                                <div>Hali mahsulot tekshirilmagan</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal oyna - Haqiqiy miqdorni kiritish -->
<div id="quantityModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; border-radius: 12px; padding: 30px; width: 450px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h4 style="margin: 0; color: #333; font-weight: 600;">üì¶ Haqiqiy miqdorni kiriting</h4>
            <button onclick="closeModal()" style="background: transparent; border: none; font-size: 24px; cursor: pointer; color: #999; line-height: 1;">&times;</button>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div style="color: #666; font-size: 14px; margin-bottom: 5px;">Mahsulot:</div>
            <div id="modalProductName" style="font-weight: 600; font-size: 16px; color: #333;"></div>
            <div style="color: #666; font-size: 14px; margin-top: 10px;">Tizimdagi miqdor:</div>
            <div id="modalSystemQuantity" style="font-weight: 600; font-size: 18px; color: #17a2b8;"></div>
        </div>
        
        <div style="margin-bottom: 25px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Haqiqiy miqdor:</label>
            <input type="number" 
                   id="actualQuantityInput" 
                   placeholder="Miqdorni kiriting..."
                   min="0"
                   step="0.01"
                   style="width: 100%; padding: 12px; border: 2px solid #28a745; border-radius: 8px; font-size: 16px; box-sizing: border-box;"
                   onkeypress="if(event.key === 'Enter') saveQuantity()">
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button onclick="saveQuantity()" 
                    style="flex: 1; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                <i class="fas fa-check"></i> Saqlash
            </button>
            <button onclick="closeModal()" 
                    style="flex: 1; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                <i class="fas fa-times"></i> Bekor qilish
            </button>
        </div>
    </div>
</div>

<style>
.page-header {
    background: white;
    color: #333;
    padding: 0.75rem 2rem;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.page-header h2 {
    font-size: 1.5rem;
    font-weight: 600;
}

.card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-radius: 10px;
}

.card-header {
    border-radius: 10px 10px 0 0 !important;
}

.table-responsive {
    max-height: 600px;
    overflow-y: auto;
}

.table thead th {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 10;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
}

.quantity-input {
    width: 100px;
    text-align: center;
}

.diff-positive {
    color: #28a745;
    font-weight: 600;
}

.diff-negative {
    color: #dc3545;
    font-weight: 600;
}

.diff-zero {
    color: #6c757d;
}
</style>

<script>
const sessionId = '{{ session_id }}';
const locationType = '{{ location_type }}';
const locationId = {{ location_id }};
let checkedProducts = [];
let allProducts = [];
let currentFilter = 'all'; // Filtr holati: 'all', 'error', 'correct'

// Sahifa yuklanganda mahsulotlarni yuklash
document.addEventListener('DOMContentLoaded', async function() {
    await loadAllProducts();
    await loadCheckedProducts(); // Barcha mahsulotlar yuklangandan keyin tekshirilganlarni yuklash
    
    // Filtr tugmalarini boshlang'ich holatga keltirish
    document.getElementById('filterAll').style.opacity = '1';
    document.getElementById('filterError').style.opacity = '0.6';
    document.getElementById('filterCorrect').style.opacity = '0.6';
});

// Tekshirilgan mahsulotlarni database'dan yuklash
async function loadCheckedProducts() {
    try {
        const response = await fetch(`/api/check_stock/items/${sessionId}`);
        const data = await response.json();
        
        if (data.success && data.items.length > 0) {
            checkedProducts = data.items;
            
            // Tekshirilgan mahsulotlarni chap jadvaldan o'chirish
            const checkedIds = data.items.map(item => item.id);
            allProducts = allProducts.filter(p => !checkedIds.includes(p.id));
            
            displayProducts(allProducts);
            updateCheckedTable();
            updateCheckedCount();
        }
    } catch (error) {
        console.error('Tekshirilgan mahsulotlarni yuklashda xatolik:', error);
    }
}

// Barcha mahsulotlarni yuklash
async function loadAllProducts() {
    try {
        const response = await fetch(`/api/check_stock/products?location_type=${locationType}&location_id=${locationId}`);
        const data = await response.json();
        
        if (data.success && data.products.length > 0) {
            allProducts = data.products;
            displayProducts(allProducts);
        } else {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align: center; padding: 40px 20px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">üì¶</div>
                        <div>Mahsulotlar topilmadi</div>
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        console.error('Mahsulotlarni yuklashda xatolik:', error);
        alert('Mahsulotlarni yuklashda xatolik yuz berdi');
    }
}

// Mahsulotni qidirish
document.getElementById('productSearch').addEventListener('input', function(e) {
    const query = e.target.value.trim().toLowerCase();
    if (query.length === 0) {
        displayProducts(allProducts);
    } else {
        const filtered = allProducts.filter(p => 
            p.name.toLowerCase().includes(query) || 
            (p.barcode && p.barcode.toLowerCase().includes(query))
        );
        displayProducts(filtered);
    }
});

// Tekshirilganlardan qidirish
document.getElementById('checkedSearch').addEventListener('input', function(e) {
    const query = e.target.value.trim().toLowerCase();
    filterAndDisplayChecked(query);
});

// Filtr funksiyasi
function filterChecked(type) {
    currentFilter = type;
    
    // Barcha filtr tugmalarining holatini reset qilish
    document.getElementById('filterAll').style.opacity = '0.6';
    document.getElementById('filterError').style.opacity = '0.6';
    document.getElementById('filterCorrect').style.opacity = '0.6';
    
    // Faol filtrni ko'rsatish
    if (type === 'all') {
        document.getElementById('filterAll').style.opacity = '1';
    } else if (type === 'error') {
        document.getElementById('filterError').style.opacity = '1';
    } else if (type === 'correct') {
        document.getElementById('filterCorrect').style.opacity = '1';
    }
    
    // Qidiruv maydonidagi qiymatni o'qish
    const query = document.getElementById('checkedSearch').value.trim().toLowerCase();
    filterAndDisplayChecked(query);
}

// Filtr va qidiruv bilan tekshirilganlarni ko'rsatish
function filterAndDisplayChecked(searchQuery = '') {
    let filtered = [...checkedProducts];
    
    // Filtr bo'yicha saralash
    if (currentFilter === 'error') {
        filtered = filtered.filter(p => p.difference !== 0);
    } else if (currentFilter === 'correct') {
        filtered = filtered.filter(p => p.difference === 0);
    }
    
    // Qidiruv bo'yicha saralash
    if (searchQuery) {
        filtered = filtered.filter(p => 
            p.name.toLowerCase().includes(searchQuery) ||
            (p.barcode && p.barcode.toLowerCase().includes(searchQuery))
        );
    }
    
    // Jadvalni yangilash
    displayCheckedTable(filtered);
}

// Mahsulotlarni qidirish
async function searchProducts(query) {
    try {
        const response = await fetch(`/api/check_stock/search?query=${encodeURIComponent(query)}&location_type=${locationType}&location_id=${locationId}`);
        const data = await response.json();
        
        if (data.success && data.products.length > 0) {
            displayProducts(data.products);
        } else {
            alert('Mahsulot topilmadi');
        }
    } catch (error) {
        console.error('Qidiruv xatosi:', error);
        alert('Qidiruvda xatolik yuz berdi');
    }
}

// Mahsulotlarni ko'rsatish (Virtual Scrolling bilan)
function displayProducts(products) {
    const tbody = document.getElementById('productsTableBody');
    
    // Mahsulotlar sonini yangilash
    document.getElementById('productsCount').textContent = products.length;
    
    if (products.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; padding: 40px 20px; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">üîç</div>
                    <div>Mahsulot topilmadi</div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = '';
    
    // Batch rendering - 50 tadan qo'shish
    const batchSize = 50;
    let currentIndex = 0;
    
    function renderBatch() {
        const fragment = document.createDocumentFragment();
        const endIndex = Math.min(currentIndex + batchSize, products.length);
        
        for (let i = currentIndex; i < endIndex; i++) {
            const product = products[i];
            const row = document.createElement('tr');
            row.style.cursor = 'pointer';
            
            // Row onclick hodisasi
            row.addEventListener('click', function(e) {
                if (e.target.tagName !== 'BUTTON') {
                    addToChecked(product);
                }
            });
            
            row.innerHTML = `
                <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px;">
                    <strong>${product.name}</strong>
                </td>
                <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
                    ${product.price ? product.price.toLocaleString() + '$' : '-'}
                </td>
                <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
                    <span style="background: #17a2b8; color: white; padding: 2px 8px; border-radius: 4px; font-weight: 600;">
                        ${product.system_quantity}
                    </span>
                </td>
                <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
                    <button style="background: transparent; color: #28a745; border: none; padding: 4px 8px; cursor: pointer; font-size: 24px;">
                        ‚û°Ô∏è
                    </button>
                </td>
            `;
            
            // Button uchun alohida click handler
            const btn = row.querySelector('button');
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                addToChecked(product);
            });
            
            fragment.appendChild(row);
        }
        
        tbody.appendChild(fragment);
        currentIndex = endIndex;
        
        // Yana mahsulotlar bo'lsa, keyingi batchni render qilish
        if (currentIndex < products.length) {
            requestAnimationFrame(renderBatch);
        }
    }
    
    renderBatch();
}

// Modal oynani ochish
let currentProduct = null;

function addToChecked(product) {
    // Avval tekshirilganlar ichida bormi deb tekshirish
    const exists = checkedProducts.find(p => p.id === product.id);
    if (exists) {
        alert('Bu mahsulot allaqachon tekshirilgan!');
        return;
    }
    
    // Modal oynani ochish
    currentProduct = product;
    document.getElementById('modalProductName').textContent = product.name;
    document.getElementById('modalSystemQuantity').textContent = product.system_quantity;
    document.getElementById('actualQuantityInput').value = product.system_quantity;
    
    const modal = document.getElementById('quantityModal');
    modal.style.display = 'flex';
    
    // Focus qilish
    setTimeout(() => {
        document.getElementById('actualQuantityInput').focus();
        document.getElementById('actualQuantityInput').select();
    }, 100);
}

// Modal oynani yopish
function closeModal() {
    document.getElementById('quantityModal').style.display = 'none';
    currentProduct = null;
}

// Miqdorni saqlash
async function saveQuantity() {
    if (!currentProduct) return;
    
    const actualQuantity = parseFloat(document.getElementById('actualQuantityInput').value) || 0;
    
    // Xatolik va holatni hisoblash (haqiqiy - tizimda)
    const difference = actualQuantity - currentProduct.system_quantity;
    let status = 'normal';
    if (difference > 0) status = 'ortiqcha';
    else if (difference < 0) status = 'kamomad';
    
    const checkedItem = {
        id: currentProduct.id,
        name: currentProduct.name,
        barcode: currentProduct.barcode || '',
        price: currentProduct.price,
        system_quantity: currentProduct.system_quantity,
        actual_quantity: actualQuantity,
        difference: difference,
        status: status
    };
    
    try {
        // Database'ga saqlash
        const response = await fetch('/api/check_stock/add_item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: sessionId,
                product_id: currentProduct.id,
                product_name: currentProduct.name,
                system_quantity: currentProduct.system_quantity,
                actual_quantity: actualQuantity,
                difference: difference,
                status: status
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Tekshirilganlarga qo'shish
            checkedProducts.push(checkedItem);
            
            // Chap jadvaldan o'chirish
            allProducts = allProducts.filter(p => p.id !== currentProduct.id);
            displayProducts(allProducts);
            
            updateCheckedTable();
            updateCheckedCount();
            closeModal();
        } else {
            alert('Saqlashda xatolik: ' + data.message);
        }
    } catch (error) {
        console.error('Saqlash xatosi:', error);
        alert('Saqlashda xatolik yuz berdi');
    }
}

// Tekshirilganlar jadvalini yangilash
function updateCheckedTable() {
    const query = document.getElementById('checkedSearch').value.trim().toLowerCase();
    filterAndDisplayChecked(query);
}

// Tekshirilganlar jadvalini ko'rsatish (filtr yordamida)
function displayCheckedTable(products) {
    const tbody = document.getElementById('checkedTableBody');
    
    if (products.length === 0) {
        let message = 'Hali mahsulot tekshirilmagan';
        if (currentFilter === 'error') {
            message = 'Xatolik bilan tekshirilgan mahsulot yo\'q';
        } else if (currentFilter === 'correct') {
            message = 'To\'g\'ri tekshirilgan mahsulot yo\'q';
        } else if (checkedProducts.length > 0) {
            message = 'Qidiruv bo\'yicha mahsulot topilmadi';
        }
        
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 40px 20px; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">üìã</div>
                    <div>${message}</div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = '';
    
    products.forEach((product) => {
        const row = document.createElement('tr');
        
        // Xatolik rangini aniqlash
        let errorColor = '#6c757d';
        if (product.difference > 0) errorColor = '#28a745';
        if (product.difference < 0) errorColor = '#dc3545';
        
        // Holat badge
        let statusBadge = '<span style="background: #6c757d; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Normal</span>';
        if (product.difference > 0) statusBadge = '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Ortiqcha</span>';
        if (product.difference < 0) statusBadge = '<span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Kamomad</span>';
        
        row.innerHTML = `
            <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px;">
                ${product.name}
            </td>
            <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
                ${product.price ? product.price.toLocaleString() + '$' : '-'}
            </td>
            <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
                ${product.system_quantity}
            </td>
            <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
                <input type="number" 
                       value="${product.actual_quantity}" 
                       onchange="updateActualQuantity(${product.id}, this.value)"
                       style="width: 60px; text-align: center; padding: 4px; border: 1px solid #ced4da; border-radius: 4px;">
            </td>
            <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center; color: ${errorColor}; font-weight: 600;">
                ${product.difference > 0 ? '+' : ''}${product.difference}
            </td>
            <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
                ${statusBadge}
            </td>
            <td style="padding: 8px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
                <button onclick="removeFromChecked(${product.id})" 
                        style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                    üóëÔ∏è
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// Haqiqiy miqdorni yangilash
function updateActualQuantity(productId, actualQty) {
    const product = checkedProducts.find(p => p.id === productId);
    if (product) {
        product.actual_quantity = parseFloat(actualQty) || 0;
        product.difference = product.actual_quantity - product.system_quantity;
        
        // Tekshirish uchun status yangilash
        if (product.difference > 0) product.status = 'kamomad';
        else if (product.difference < 0) product.status = 'ortiqcha';
        else product.status = 'normal';
        
        const query = document.getElementById('checkedSearch').value.trim().toLowerCase();
        filterAndDisplayChecked(query);
    }
}

// Tekshirilganlardan o'chirish
async function removeFromChecked(productId) {
    try {
        // Database'dan o'chirish
        const response = await fetch('/api/check_stock/remove_item', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: sessionId,
                product_id: productId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // O'chirilayotgan mahsulotni topish
            const removedProduct = checkedProducts.find(p => p.id === productId);
            
            // Tekshirilganlardan o'chirish
            checkedProducts = checkedProducts.filter(p => p.id !== productId);
            
            // Agar mahsulot topilsa, uni qayta chap jadvalga qo'shish
            if (removedProduct) {
                allProducts.push({
                    id: removedProduct.id,
                    name: removedProduct.name,
                    barcode: removedProduct.barcode || '',
                    price: removedProduct.price,
                    system_quantity: removedProduct.system_quantity
                });
                
                // Chap jadvalni yangilash
                displayProducts(allProducts);
            }
            
            updateCheckedTable();
            updateCheckedCount();
        } else {
            alert('O\'chirishda xatolik: ' + data.message);
        }
    } catch (error) {
        console.error('O\'chirish xatosi:', error);
        alert('O\'chirishda xatolik yuz berdi');
    }
}

// Tekshirilganlar sonini yangilash
function updateCheckedCount() {
    document.getElementById('checkedCount').textContent = checkedProducts.length;
    updateFilterCounts();
}

// Filtr sonlarini yangilash
function updateFilterCounts() {
    const allCount = checkedProducts.length;
    const errorCount = checkedProducts.filter(p => p.difference !== 0).length;
    const correctCount = checkedProducts.filter(p => p.difference === 0).length;
    
    document.getElementById('allCount').textContent = allCount;
    document.getElementById('errorCount').textContent = errorCount;
    document.getElementById('correctCount').textContent = correctCount;
}

// Tekshiruvni yakunlash
async function finishCheck() {
    // Ogohlantirish xabari
    let confirmMessage;
    if (checkedProducts.length === 0) {
        confirmMessage = 'DIQQAT: Hech qanday mahsulot tekshirilmagan!\n\nTekshiruv yakunlanadi va hisobotda ma\'lumot bo\'lmaydi.\n\nDavom etishni xohlaysizmi?';
    } else {
        confirmMessage = `${checkedProducts.length} ta mahsulot tekshirildi.\n\nTekshiruvni yakunlaysizmi?`;
    }
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    try {
        const response = await fetch('/api/check_stock/finish', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: sessionId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (checkedProducts.length === 0) {
                alert('Tekshiruv yakunlandi (mahsulot tekshirilmagan)');
            } else {
                alert('Tekshiruv muvaffaqiyatli yakunlandi!');
            }
            window.location.href = '/check_stock';
        } else {
            alert('Xatolik: ' + (data.message || 'Tekshiruvni yakunlab bo\'lmadi'));
        }
    } catch (error) {
        console.error('Tekshiruvni yakunlashda xatolik:', error);
        alert('Tekshiruvni yakunlashda xatolik yuz berdi');
    }
}
</script>

{% endblock %}
