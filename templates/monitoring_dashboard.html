{% extends "base_with_sidebar.html" %}

{% block title %}Server Monitoring{% endblock %}

{% block extra_head %}
<style>
    .monitoring-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .monitor-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .monitor-card h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #4CAF50;
        padding-bottom: 10px;
    }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-healthy { background: #4CAF50; }
    .status-warning { background: #FF9800; }
    .status-error { background: #F44336; }
    
    .metric {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    
    .metric-label {
        font-weight: 500;
        color: #666;
    }
    
    .metric-value {
        font-weight: bold;
        color: #333;
    }
    
    .progress-bar {
        width: 100%;
        height: 20px;
        background: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 5px;
    }
    
    .progress-fill {
        height: 100%;
        background: #4CAF50;
        transition: width 0.3s, background 0.3s;
    }
    
    .progress-fill.warning { background: #FF9800; }
    .progress-fill.danger { background: #F44336; }
    
    .error-log {
        background: #f8f8f8;
        padding: 10px;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
    }
    
    .error-log pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    .refresh-info {
        text-align: center;
        color: #666;
        margin: 10px 0;
        font-size: 14px;
    }
    
    .btn-refresh {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .btn-refresh:hover {
        background: #45a049;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>üîç Server Monitoring Dashboard</h1>
    
    <div class="refresh-info">
        <button class="btn-refresh" onclick="refreshData()">üîÑ Yangilash</button>
        <span id="last-update">Oxirgi yangilanish: ---</span>
    </div>
    
    <div class="monitoring-grid">
        <!-- Server Resources -->
        <div class="monitor-card">
            <h3>üíª Server Resurslari</h3>
            <div class="metric">
                <span class="metric-label">CPU:</span>
                <span class="metric-value" id="cpu-usage">---</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="cpu-progress"></div>
            </div>
            
            <div class="metric">
                <span class="metric-label">RAM:</span>
                <span class="metric-value" id="memory-usage">---</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="memory-progress"></div>
            </div>
            
            <div class="metric">
                <span class="metric-label">Disk:</span>
                <span class="metric-value" id="disk-usage">---</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="disk-progress"></div>
            </div>
        </div>
        
        <!-- Database Status -->
        <div class="monitor-card">
            <h3>üóÑÔ∏è Database Holati</h3>
            <div class="metric">
                <span class="metric-label">Holat:</span>
                <span class="metric-value" id="db-status">
                    <span class="status-indicator status-healthy"></span>
                    <span id="db-status-text">---</span>
                </span>
            </div>
            <div class="metric">
                <span class="metric-label">Active Connections:</span>
                <span class="metric-value" id="db-connections">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Database Size:</span>
                <span class="metric-value" id="db-size">---</span>
            </div>
        </div>
        
        <!-- Application Status -->
        <div class="monitor-card">
            <h3>üì± Ilova Holati</h3>
            <div class="metric">
                <span class="metric-label">Uptime:</span>
                <span class="metric-value" id="app-uptime">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Requestlar (5 daq):</span>
                <span class="metric-value" id="app-requests">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Xatolar:</span>
                <span class="metric-value" id="app-errors-count">---</span>
            </div>
        </div>
        
        <!-- Network Stats -->
        <div class="monitor-card">
            <h3>üåê Network</h3>
            <div class="metric">
                <span class="metric-label">Yuborildi:</span>
                <span class="metric-value" id="net-sent">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Qabul qilindi:</span>
                <span class="metric-value" id="net-recv">---</span>
            </div>
        </div>
    </div>
    
    <!-- Recent Errors -->
    <div class="monitor-card" style="margin-top: 20px;">
        <h3>‚ö†Ô∏è Oxirgi Xatolar</h3>
        <div class="error-log" id="error-log">
            <pre>Xatolar yuklanmoqda...</pre>
        </div>
    </div>
</div>

<script>
let autoRefresh = true;
let refreshInterval;

function refreshData() {
    fetch('/monitoring/status')
        .then(response => response.json())
        .then(data => {
            updateUI(data);
            document.getElementById('last-update').textContent = 
                'Oxirgi yangilanish: ' + new Date().toLocaleTimeString('uz-UZ');
        })
        .catch(error => {
            console.error('Monitoring ma\'lumotlarini olishda xato:', error);
        });
}

function updateUI(data) {
    // Server resources
    const cpu = data.server.cpu_percent;
    document.getElementById('cpu-usage').textContent = cpu.toFixed(1) + '%';
    updateProgressBar('cpu-progress', cpu);
    
    const memory = data.server.memory;
    document.getElementById('memory-usage').textContent = 
        `${memory.used} GB / ${memory.total} GB (${memory.percent}%)`;
    updateProgressBar('memory-progress', memory.percent);
    
    const disk = data.server.disk;
    document.getElementById('disk-usage').textContent = 
        `${disk.used} GB / ${disk.total} GB (${disk.percent}%)`;
    updateProgressBar('disk-progress', disk.percent);
    
    // Database
    const dbConn = data.database.connection;
    const statusIndicator = document.querySelector('#db-status .status-indicator');
    if (dbConn.connected) {
        statusIndicator.className = 'status-indicator status-healthy';
        document.getElementById('db-status-text').textContent = 'Online';
    } else {
        statusIndicator.className = 'status-indicator status-error';
        document.getElementById('db-status-text').textContent = 'Offline';
    }
    
    document.getElementById('db-connections').textContent = 
        data.database.active_connections || 'N/A';
    document.getElementById('db-size').textContent = 
        data.database.size || 'N/A';
    
    // Application
    document.getElementById('app-uptime').textContent = 
        data.application.uptime.formatted;
    document.getElementById('app-requests').textContent = 
        data.application.requests.recent_5min;
    
    // Errors
    const errors = data.application.recent_errors;
    document.getElementById('app-errors-count').textContent = errors.length;
    
    if (errors.length > 0) {
        document.getElementById('error-log').innerHTML = 
            '<pre>' + errors.join('\n') + '</pre>';
    } else {
        document.getElementById('error-log').innerHTML = 
            '<pre>Xatolar topilmadi ‚úÖ</pre>';
    }
    
    // Network
    document.getElementById('net-sent').textContent = 
        data.server.network.bytes_sent + ' MB';
    document.getElementById('net-recv').textContent = 
        data.server.network.bytes_recv + ' MB';
}

function updateProgressBar(elementId, percent) {
    const element = document.getElementById(elementId);
    element.style.width = percent + '%';
    
    // Rang o'zgartirish
    if (percent > 90) {
        element.className = 'progress-fill danger';
    } else if (percent > 70) {
        element.className = 'progress-fill warning';
    } else {
        element.className = 'progress-fill';
    }
}

// Sahifa yuklanganda
document.addEventListener('DOMContentLoaded', function() {
    refreshData();
    
    // Har 30 sekundda yangilash
    refreshInterval = setInterval(refreshData, 30000);
});
</script>
{% endblock %}
