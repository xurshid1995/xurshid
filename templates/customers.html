{% extends "base_with_sidebar.html" %}

{% block head %}
{{ super() }}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block title %}Mijozlar - Sayt 2025{% endblock %}

{% block extra_css %}
<style>
    .customers-container {
        padding: 1rem;
        background: #f8f9fa;
        min-height: auto;
    }

    .page-header {
        padding: 0.5rem 1rem;
        margin-bottom: 0.5rem;
        text-align: left;
    }

    .page-header h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 1rem;
        color: #333;
    }

    .page-header p {
        margin: 0.5rem 0 0 0;
        font-size: 1.1rem;
        color: #666;
    }

    .controls-section {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex !important;
        align-items: center !important;
        flex-wrap: nowrap !important;
        gap: 0.3rem;
        justify-content: space-between !important;
        min-height: 80px;
        overflow: visible;
    }

    .search-box {
        flex: 1 1 auto !important;
        max-width: 450px !important;
        min-width: 250px !important;
        position: relative;
    }

    .search-box input {
        width: 100%;
        padding: 0.75rem 2.5rem 0.75rem 2.5rem;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .search-box input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
    }

    .search-box .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        font-size: 1rem;
    }
    
    .search-box .clear-search-btn {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        background: transparent;
        color: #dc3545;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        cursor: pointer;
        font-size: 1.1rem;
        display: none;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    
    .search-box .clear-search-btn:hover {
        background: #dc3545;
        color: white;
        transform: translateY(-50%) scale(1.15);
    }

    .add-customer-btn {
        background: #28a745;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        display: flex !important;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
        white-space: nowrap !important;
        border: 2px solid #28a745;
        min-width: 140px !important;
        max-width: 160px !important;
        justify-content: center;
        flex: 0 0 auto !important;
        flex-shrink: 0 !important;
    }

    .add-customer-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        text-decoration: none;
        color: white;
        background: #218838;
        border-color: #218838;
    }

    .add-customer-btn span {
        font-size: 1rem;
    }

    /* Inline filtrlari */
    .inline-filters {
        display: flex !important;
        align-items: center !important;
        gap: 0.2rem;
        flex: 1 1 auto !important;
        justify-content: flex-start !important;
        min-width: 0 !important;
        flex-wrap: nowrap !important;
    }

    .store-filter-buttons {
        display: flex !important;
        gap: 0.6rem;
        flex-wrap: nowrap !important;
        align-items: center;
        justify-content: flex-start;
        min-width: 0;
        overflow-x: auto;
        overflow-y: hidden;
        max-width: 100%;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .store-filter-buttons::-webkit-scrollbar {
        display: none;
    }

    .store-filter-btn {
        padding: 0.6rem 1rem;
        border: 2px solid #e9ecef;
        border-radius: 20px;
        background: white;
        color: #495057;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        white-space: nowrap;
        flex-shrink: 0;
        min-width: fit-content;
        white-space: nowrap;
    }

    .store-filter-btn:hover {
        border-color: #667eea;
        color: #667eea;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }

    .store-filter-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    .store-filter-btn.active:hover {
        background: #5a6fd8;
        border-color: #5a6fd8;
    }

    .customers-table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
    }

    .table-info {
        padding: 1rem 1.5rem;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .analysis-dropdown {
        position: relative;
        display: inline-block;
    }

    .analysis-btn {
        background: #667eea;
        color: white;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
    }

    .analysis-btn:hover {
        background: #5a6fd8;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        background: white;
        min-width: 200px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 8px;
        z-index: 1000;
        margin-top: 0.5rem;
    }

    .dropdown-content.show {
        display: block;
    }

    .dropdown-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border-bottom: 1px solid #f0f0f0;
    }

    .dropdown-item:last-child {
        border-bottom: none;
    }

    .dropdown-item:hover {
        background: #f8f9fa;
    }

    .dropdown-item.active {
        background: #e7f3ff;
        color: #667eea;
        font-weight: 600;
    }

    .time-filter-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: nowrap;
    }

    .time-filter-btn {
        background: white;
        color: #667eea;
        padding: 0.4rem 0.7rem;
        border: 2px solid #667eea;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .time-filter-btn:hover {
        background: #f0f3ff;
    }

    .time-filter-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    .analysis-filter-btn {
        background: white;
        color: #f57c00;
        padding: 0.4rem 0.7rem;
        border: 2px solid #f57c00;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .analysis-filter-btn:hover {
        background: #fff3e0;
    }

    .analysis-filter-btn.active {
        background: #f57c00;
        color: white;
        border-color: #f57c00;
    }

    .customers-table {
        width: 100%;
        min-width: 800px; /* Mijozlar jadvali uchun minimal kenglik */
        border-collapse: collapse;
    }

    .customers-table th {
        background: #667eea;
        color: white;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #5a67d8;
    }

    .customers-table td {
        padding: 0.875rem 1rem;
        border-bottom: 1px solid #e9ecef;
        vertical-align: middle;
    }

    .customers-table tr:hover {
        background-color: #f8f9fa;
    }

    .emoji {
        font-size: 1.1em;
        margin-right: 0.5rem;
    }

    .store-name {
        font-weight: 600;
        color: #667eea;
    }

    .customer-name {
        font-weight: 600;
        color: #333;
    }

    .customer-phone {
        font-family: inherit;
        color: #495057;
    }

    .customer-email {
        color: #6c757d;
        font-size: 0.9rem;
    }

    .actions {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
        align-items: center;
        justify-content: center;
        min-width: 90px;
    }

    .btn-view, .btn-edit, .btn-delete {
        padding: 0.35rem 0.5rem;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.75rem;
        font-weight: 500;
        border: 1px solid;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
        width: 100%;
        text-align: center;
        white-space: nowrap;
    }

    .btn-view {
        background: #1976d2;
        color: white;
        border-color: #1565c0;
    }

    .btn-view:hover {
        background: #1565c0;
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(21, 101, 192, 0.3);
    }

    .btn-edit {
        background: #f57c00;
        color: white;
        border-color: #ef6c00;
    }

    .btn-edit:hover {
        background: #ef6c00;
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(239, 108, 0, 0.3);
    }

    .btn-delete {
        background: #d32f2f;
        color: white;
        border-color: #c62828;
    }

    .btn-delete:hover {
        background: #c62828;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(198, 40, 40, 0.3);
    }

    .loading-state, .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: #6c757d;
    }

    .loading-state h3, .empty-state h3 {
        color: #6c757d;
        margin-bottom: 1rem;
    }

    .empty-state p {
        color: #6c757d;
    }

    /* Responsive - soddalashtirilgan */
    @media (max-width: 500px) {
        .controls-section {
            flex-wrap: wrap;
            padding: 1rem;
        }
        
        .search-box, 
        .inline-filters, 
        .add-customer-btn {
            flex-basis: 100%;
        }
        
        .customers-table {
            font-size: 0.9rem;
        }
        
        .actions {
            flex-direction: column;
            gap: 0.3rem;
        }
    }
    
    /* Desktop kichik ekranlar uchun horizontal scroll */
    @media (min-width: 769px) and (max-width: 1400px) {
        .customers-table-container {
            border: 1px solid #dee2e6;
        }
        
        .customers-table {
            min-width: 1000px; /* Desktop uchun kengrok minimal kenglik */
        }
        
        /* Scroll indicator */
        .customers-table-container::before {
            content: "üí° Mijozlar jadvalida ko'proq ma'lumot uchun gorizontal scroll qiling ‚Üê ‚Üí";
            display: block;
            text-align: center;
            font-size: 11px;
            color: #495057;
            padding: 6px;
            background: linear-gradient(90deg, #e3f2fd 0%, #f3e5f5 50%, #e8f5e8 100%);
            border-bottom: 1px solid #dee2e6;
            font-weight: 500;
        }
    }
    
    /* 480px dan kichik ekranlar uchun */
    @media (max-width: 480px) {
        .customers-container {
            padding: 0.5rem;
        }
        
        .page-header {
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .page-header h1 {
            font-size: 1.8rem;
        }
        
        .customers-table {
            min-width: 600px; /* Mobile uchun minimal kenglik */
            font-size: 0.8rem;
        }
        
        .customers-table th,
        .customers-table td {
            padding: 0.5rem 0.3rem;
            white-space: nowrap;
        }
    }

    /* Modal Styles */
    .delete-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .delete-modal.active {
        display: flex;
    }

    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        color: #e74c3c;
    }

    .modal-header i {
        font-size: 2rem;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.5rem;
    }

    .modal-body {
        margin-bottom: 20px;
    }

    .modal-body p {
        margin: 10px 0;
        color: #555;
        line-height: 1.6;
    }

    .modal-body .customer-name-highlight {
        font-weight: bold;
        color: #e74c3c;
        font-size: 1.1rem;
        padding: 5px 10px;
        background: #fee;
        border-radius: 4px;
        display: inline-block;
        margin: 10px 0;
    }

    .modal-input-group {
        margin: 20px 0;
    }

    .modal-input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #333;
    }

    .modal-input-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.3s;
    }

    .modal-input-group input:focus {
        outline: none;
        border-color: #3498db;
    }

    .modal-input-group input.error {
        border-color: #e74c3c;
    }

    .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .modal-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }

    .modal-btn-cancel {
        background: #95a5a6;
        color: white;
    }

    .modal-btn-cancel:hover {
        background: #7f8c8d;
    }

    .modal-btn-delete {
        background: #e74c3c;
        color: white;
        opacity: 0.5;
        cursor: not-allowed;
    }

    .modal-btn-delete.enabled {
        opacity: 1;
        cursor: pointer;
    }

    .modal-btn-delete.enabled:hover {
        background: #c0392b;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="delete-modal">
    <div class="modal-content">
        <div class="modal-header">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>DIQQAT! Mijozni o'chirish</h3>
        </div>
        <div class="modal-body">
            <p><strong>Siz quyidagi mijozni o'chirmoqchisiz:</strong></p>
            <div class="customer-name-highlight" id="modalCustomerName"></div>
            <p style="color: #e74c3c; font-weight: bold;">‚ö†Ô∏è Bu amal qaytarib bo'lmaydi!</p>
            <p>Davom etish uchun mijoz nomini quyidagi maydonga kiriting:</p>
            
            <div class="modal-input-group">
                <label for="confirmInput">Mijoz nomi:</label>
                <input 
                    type="text" 
                    id="confirmInput" 
                    placeholder="Mijoz nomini kiriting..."
                    autocomplete="off"
                    autofocus
                >
            </div>
        </div>
        <div class="modal-actions">
            <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">
                ‚ùå Bekor qilish
            </button>
            <button class="modal-btn modal-btn-delete" id="confirmDeleteBtn" disabled>
                üóëÔ∏è O'chirish
            </button>
        </div>
    </div>
</div>

<div class="customers-container">
    <!-- Sahifa sarlavhasi -->
    <div class="page-header">
        <h1>
            <span>üë•</span>
            Mijozlar Boshqaruvi
        </h1>
    </div>

    <!-- Boshqaruv paneli -->
    <div class="controls-section">
        <div class="inline-filters">
            <div class="store-filter-buttons">
                <button class="store-filter-btn active" onclick="filterByStore('')" id="allStoresBtn">
                    üìä Hammasi
                </button>
                <div id="storeFilterButtons">
                    <!-- Dokon tugmalari bu yerga yuklanadi -->
                </div>
            </div>
        </div>
        
        <a href="/add-customer" class="add-customer-btn">
            <span>‚ûï</span>
            Mijoz qo'shish
        </a>
    </div>

    <!-- Jadval container -->
    <div class="table-responsive">
        <div class="customers-table-container">
        <!-- Ma'lumot ko'rsatuvchisi -->
        <div class="table-info">
            <div style="display: flex; align-items: center; gap: 0.3rem; flex-wrap: nowrap;">
                <div class="search-box" style="flex: 1 1 auto; max-width: 450px; min-width: 250px;">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="customerSearch" placeholder="Mijozlarni qidirish..." oninput="searchCustomers()">
                    <button class="clear-search-btn" id="clearSearchBtn" onclick="clearSearch()">‚ùå</button>
                </div>
                <span id="resultsInfo">Mijozlar yuklanmoqda...</span>
                <div class="time-filter-buttons">
                    <button class="time-filter-btn" onclick="filterByTime('today')">Bugun</button>
                    <button class="time-filter-btn" onclick="filterByTime('week')">Bu hafta</button>
                    <button class="time-filter-btn" onclick="filterByTime('month')">Bu oy</button>
                    <button class="time-filter-btn" onclick="filterByTime('year')">Bu yil</button>
                </div>
                <div class="time-filter-buttons">
                    <button class="analysis-filter-btn" onclick="filterByAnalysis('count')">üî¢ Savdo soni</button>
                    <button class="analysis-filter-btn" onclick="filterByAnalysis('sum')">üí∞ Savdo summasi</button>
                    {% if session.role != 'sotuvchi' %}
                    <button class="analysis-filter-btn" onclick="filterByAnalysis('profit')">üìä Jami foyda</button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Loading holati -->
        <div id="loadingState" class="loading-state">
            <h3>‚è≥ Yuklanmoqda...</h3>
            <p>Mijozlar ma'lumotlari yuklanmoqda, biroz kuting.</p>
        </div>

        <!-- Bo'sh holat -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <h3>üì≠ Mijozlar topilmadi</h3>
            <p>Hech qanday mijoz ma'lumoti mavjud emas yoki filter shartlariga mos mijoz yo'q.</p>
        </div>

        <!-- Mijozlar jadvali -->
        <table class="customers-table" id="customersTable" style="display: none;">
            <thead>
                <tr>
                    <th><span class="emoji">üè™</span>Dokon</th>
                    <th><span class="emoji">üë§</span>Mijoz nomi</th>
                    <th><span class="emoji">üìû</span>Telefon</th>
                    <th><span class="emoji">üìä</span>Savdoni tahlili</th>
                    <th><span class="emoji">üìç</span>Manzil</th>
                    <th><span class="emoji">üìÖ</span>Qo'shilgan sana</th>
                    <th><span class="emoji">‚öôÔ∏è</span>Amallar</th>
                </tr>
            </thead>
            <tbody id="customersTableBody">
                <!-- Mijozlar ma'lumotlari bu yerga yuklanadi -->
            </tbody>
        </table>
        </div>
    </div>
</div>

<script>
    // Server'dan user role ma'lumoti
    const userRole = '{{ user_role }}';
    console.log('User role:', userRole);
    
    let allCustomers = [];
    let filteredCustomers = [];
    let allStores = [];
    
    // Filtr o'zgaruvchilari (funktsiyalardan oldin e'lon qilish kerak!)
    let currentAnalysisFilter = 'none'; // default: hech qanday filtr yo'q
    let currentTimeFilter = 'all'; // default: hech qanday filtr yo'q

    // Sahifa yuklanganda mijozlar va dokonlarni olish
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Sahifa yuklandi, ma\'lumotlarni yuklaydi...');
        loadCustomers();
        loadStores();
    });

    // Mijozlarni yuklash
    async function loadCustomers() {
        try {
            console.log('üîç Mijozlarni yuklayapti... currentTimeFilter:', currentTimeFilter);
            const url = `/api/customers?time_filter=${currentTimeFilter}`;
            console.log('üì° API URL:', url);
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Data array ekanligini tekshirish
            if (!Array.isArray(data)) {
                console.error('API javob formati noto\'g\'ri:', data);
                throw new Error('API javob array emas');
            }
            
            console.log('Mijozlar yuklandi:', data.length, 'ta mijoz');
            allCustomers = data;
            filteredCustomers = [...allCustomers];
            displayCustomers();
            
            // Dokonlar filtri yangilash (agar dokonlar allaqachon yuklangan bo'lsa)
            if (allStores.length > 0) {
                populateStoreFilter();
            }
        } catch (error) {
            console.error('Mijozlarni yuklashda xatolik:', error);
            allCustomers = [];
            filteredCustomers = [];
            showError('Mijozlarni yuklashda xatolik yuz berdi: ' + error.message);
        }
    }

    // Mijozlarni ko'rsatish
    function displayCustomers() {
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const customersTable = document.getElementById('customersTable');
        const tableBody = document.getElementById('customersTableBody');

        loadingState.style.display = 'none';

        if (filteredCustomers.length === 0) {
            emptyState.style.display = 'block';
            customersTable.style.display = 'none';
        } else {
            emptyState.style.display = 'none';
            customersTable.style.display = 'table';

            // Savdo tahlili bo'yicha saralash
            let sortedCustomers = [...filteredCustomers];
            if (currentAnalysisFilter === 'count') {
                // Savdo soni bo'yicha kamayish tartibida
                sortedCustomers.sort((a, b) => (b.total_sales || 0) - (a.total_sales || 0));
            } else if (currentAnalysisFilter === 'sum') {
                // Savdo summasi bo'yicha kamayish tartibida
                sortedCustomers.sort((a, b) => (parseFloat(b.total_amount) || 0) - (parseFloat(a.total_amount) || 0));
            } else if (currentAnalysisFilter === 'profit') {
                // Jami foyda bo'yicha kamayish tartibida
                sortedCustomers.sort((a, b) => (parseFloat(b.total_profit) || 0) - (parseFloat(a.total_profit) || 0));
            }

            // Jadval ma'lumotlarini yaratish
            let tableHtml = '';
            sortedCustomers.forEach(customer => {
                const createdDate = new Date(customer.created_at).toLocaleDateString('uz-UZ');
                
                tableHtml += `
                    <tr>
                        <td class="store-name">${customer.store_name || 'Umumiy'}</td>
                        <td class="customer-name">${customer.name || 'Noma\'lum'}</td>
                        <td class="customer-phone">${customer.phone || '-'}</td>
                        <td class="customer-email">
                            <div style="display: flex; flex-direction: column; gap: 3px;">
                                <span style="font-size: 0.85rem;">üî¢ Soni: <strong>${customer.total_sales || 0}</strong></span>
                                <span style="font-size: 0.85rem;">üí∞ Summa: <strong>$${customer.total_amount ? parseFloat(customer.total_amount).toFixed(2) : '0.00'}</strong></span>
                                ${userRole !== 'sotuvchi' ? `<span style="font-size: 0.85rem; color: #28a745;">üìä Foyda: <strong>$${customer.total_profit ? parseFloat(customer.total_profit).toFixed(2) : '0.00'}</strong></span>` : ''}
                            </div>
                        </td>
                        <td>${customer.address || '-'}</td>
                        <td>${createdDate}</td>
                        <td class="actions">
                            <button onclick="viewCustomer(${customer.id})" class="btn-view">üëÅÔ∏è Ko'rish</button>
                            ${userRole === 'admin' ? `<a href="/edit-customer/${customer.id}" class="btn-edit">‚úèÔ∏è Tahrirlash</a>` : ''}
                            ${userRole === 'admin' ? `<button onclick="deleteCustomer(${customer.id}, '${customer.name.replace(/'/g, "\\'")}')" class="btn-delete">üóëÔ∏è O'chirish</button>` : ''}
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = tableHtml;
            document.getElementById('resultsInfo').innerHTML = 
                `<span class="badge" style="background-color: #4CAF50; color: white; padding: 0.4rem 0.8rem; border-radius: 20px; font-weight: 500;">${filteredCustomers.length} ta mijoz</span>`;
        }
    }

    // Mijozlarni qidirish va filtrash
    function searchCustomers() {
        // X tugmasini ko'rsatish/yashirish
        const searchInput = document.getElementById('customerSearch');
        const clearBtn = document.getElementById('clearSearchBtn');
        
        if (searchInput.value.trim() !== '' || currentTimeFilter !== 'all' || currentAnalysisFilter !== 'none') {
            clearBtn.style.display = 'flex';
        } else {
            clearBtn.style.display = 'none';
        }
        
        applyFilters();
    }

    let currentStoreFilter = '';

    // Dokon bo'yicha filtrash
    function filterByStore(storeId) {
        console.log('Dokon filtri bosildi:', storeId);
        currentStoreFilter = storeId || '';
        
        // Tugma active holatini yangilash
        document.querySelectorAll('.store-filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        if (!storeId) {
            const allBtn = document.getElementById('allStoresBtn');
            if (allBtn) {
                allBtn.classList.add('active');
            }
        } else {
            const targetBtn = document.querySelector(`[data-store-id="${storeId}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
        }
        
        applyFilters();
    }

    // Barcha filtrlarni qo'llash
    function applyFilters() {
        const searchTerm = document.getElementById('customerSearch').value.toLowerCase().trim();
        
        filteredCustomers = allCustomers.filter(customer => {
            // Qidiruv filtri
            const matchesSearch = !searchTerm || 
                (customer.name && customer.name.toLowerCase().includes(searchTerm)) ||
                (customer.phone && customer.phone.toLowerCase().includes(searchTerm)) ||
                (customer.email && customer.email.toLowerCase().includes(searchTerm)) ||
                (customer.address && customer.address.toLowerCase().includes(searchTerm));
            
            // Dokon filtri
            const matchesStore = !currentStoreFilter || 
                (customer.store_id && customer.store_id.toString() === currentStoreFilter);
            
            return matchesSearch && matchesStore;
        });
        
        displayCustomers();
    }

    // Dokonlarni yuklash
    async function loadStores() {
        try {
            console.log('Dokonlarni yuklayapti...');
            const response = await fetch('/api/stores');
            const data = await response.json();
            console.log('Dokonlar yuklandi:', data.length, 'ta dokon');
            allStores = data;
            populateStoreFilter();
        } catch (error) {
            console.error('Dokonlarni yuklashda xatolik:', error);
        }
    }

    // Dokon filtr tugmalarini yaratish
    function populateStoreFilter() {
        const storeButtonsContainer = document.getElementById('storeFilterButtons');
        
        // Faqat mijozlarga tegishli dokonlarni ko'rsatish
        const usedStores = [...new Set(allCustomers
            .filter(customer => customer.store_id)
            .map(customer => customer.store_id))];
        
        const relevantStores = allStores.filter(store => usedStores.includes(store.id));
        
        // Container ni tozalash
        storeButtonsContainer.innerHTML = '';
        
        relevantStores.forEach(store => {
            const button = document.createElement('button');
            button.className = 'store-filter-btn';
            button.setAttribute('data-store-id', store.id.toString());
            button.onclick = () => filterByStore(store.id.toString());
            button.innerHTML = `üè™ ${store.name}`;
            storeButtonsContainer.appendChild(button);
        });
    }

    // Mijoz ma'lumotlarini ko'rish
    function viewCustomer(customerId) {
        window.location.href = `/customer/${customerId}`;
    }

    // Mijozni tahrirlash
    function editCustomer(customerId) {
        window.location.href = `/edit-customer?id=${customerId}`;
    }

    // Modal variables
    let currentCustomerId = null;
    let currentCustomerName = null;

    // Mijozni o'chirish - modal ochish
    function deleteCustomer(customerId, customerName) {
        // Faqat admin o'chira oladi
        if (userRole !== 'admin') {
            alert('‚ö†Ô∏è Mijozni o\'chirish uchun admin huquqi kerak!');
            return;
        }
        
        console.log('üéØ YANGI deleteCustomer FUNKSIYASI CHAQIRILDI!');
        console.log('O\'chirish funksiyasi chaqirildi:', customerId, customerName);
        
        currentCustomerId = customerId;
        currentCustomerName = customerName;
        
        // Modal ochish
        const modal = document.getElementById('deleteModal');
        const modalCustomerName = document.getElementById('modalCustomerName');
        const confirmInput = document.getElementById('confirmInput');
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        
        if (!modal) {
            console.error('‚ùå Modal topilmadi!');
            alert('Xatolik: Modal oyna topilmadi!');
            return;
        }
        
        modalCustomerName.textContent = customerName;
        confirmInput.value = '';
        confirmBtn.disabled = true;
        confirmBtn.classList.remove('enabled');
        confirmInput.classList.remove('error');
        
        modal.classList.add('active');
        console.log('‚úÖ Modal ochildi, active class qo\'shildi');
        
        // Input'ga fokus - darhol va qaytadan
        confirmInput.focus();
        setTimeout(() => {
            confirmInput.focus();
            confirmInput.select();
        }, 100);
    }

    // Close delete modal
    function closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.classList.remove('active');
        currentCustomerId = null;
        currentCustomerName = null;
    }

    // Input validation - real-time
    document.addEventListener('DOMContentLoaded', function() {
        const confirmInput = document.getElementById('confirmInput');
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        
        if (!confirmInput || !confirmBtn) return;
        
        confirmInput.addEventListener('input', function() {
            const inputValue = this.value.trim();
            
            if (inputValue === currentCustomerName) {
                confirmBtn.disabled = false;
                confirmBtn.classList.add('enabled');
                this.classList.remove('error');
            } else {
                confirmBtn.disabled = true;
                confirmBtn.classList.remove('enabled');
                if (inputValue.length > 0) {
                    this.classList.add('error');
                } else {
                    this.classList.remove('error');
                }
            }
        });
        
        // Enter tugmasini bosish
        confirmInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !confirmBtn.disabled) {
                confirmDeleteCustomer();
            }
        });
        
        // Modal tashqarisiga bosish
        const modal = document.getElementById('deleteModal');
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeDeleteModal();
                }
            });
        }
        
        // Confirm delete button click
        confirmBtn.addEventListener('click', confirmDeleteCustomer);
    });

    // Confirm delete customer
    function confirmDeleteCustomer() {
        if (!currentCustomerId) return;
        
        console.log('Tasdiqlandi! O\'chirish boshlandi:', currentCustomerId);
        
        // Tugmani o'chirish
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        confirmBtn.disabled = true;
        confirmBtn.textContent = '‚è≥ O\'chirilmoqda...';
        
        fetch(`/api/customers/${currentCustomerId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            console.log('API javob olindi:', response.status, response.statusText);
            if (response.ok) {
                return response.json().then(data => {
                    console.log('Muvaffaqiyat! Ro\'yxat yangilanmoqda...');
                    closeDeleteModal();
                    alert(data.message || 'Mijoz muvaffaqiyatli o\'chirildi!');
                    loadCustomers(); // Ro'yxatni yangilash
                });
            } else {
                alert('Xatolik yuz berdi! Mijozni o\'chirib bo\'lmadi.');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'üóëÔ∏è O\'chirish';
            }
        })
        .catch(error => {
            console.error('Fetch xatosi:', error);
            alert('Aloqa xatosi! Qaytadan urinib ko\'ring.');
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'üóëÔ∏è O\'chirish';
        });
    }

    // Xatolikni ko'rsatish
    function showError(message) {
        const loadingState = document.getElementById('loadingState');
        loadingState.innerHTML = `
            <h3 style="color: #e74c3c;">‚ùå Xatolik</h3>
            <p>${message}</p>
        `;
    }

    // Savdo tahlili bo'yicha filtr
    function filterByAnalysis(type) {
        currentAnalysisFilter = type;
        
        // Active class o'zgartirish - faqat tahlil tugmalari uchun
        const analysisButtons = document.querySelectorAll('.analysis-filter-btn');
        analysisButtons.forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Qidiruv maydonidagi X tugmasini ko'rsatish
        const searchInput = document.getElementById('customerSearch');
        const clearBtn = document.getElementById('clearSearchBtn');
        if (searchInput.value.trim() !== '' || currentTimeFilter !== 'all' || currentAnalysisFilter !== 'none') {
            clearBtn.style.display = 'flex';
        }
        
        // Mijozlarni qayta saralash
        applyFilters();
    }

    // Vaqt bo'yicha filtr
    function filterByTime(period) {
        currentTimeFilter = period;
        
        // Active class o'zgartirish
        document.querySelectorAll('.time-filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Qidiruv maydonidagi X tugmasini ko'rsatish
        const searchInput = document.getElementById('customerSearch');
        const clearBtn = document.getElementById('clearSearchBtn');
        if (searchInput.value.trim() !== '' || currentTimeFilter !== 'all' || currentAnalysisFilter !== 'none') {
            clearBtn.style.display = 'flex';
        }
        
        // Mijozlarni qayta yuklash (backend'dan filtr bilan)
        loadCustomers();
    }
    
    // Qidiruvni tozalash
    function clearSearch() {
        // Qidiruv maydonini tozalash
        document.getElementById('customerSearch').value = '';
        
        // Vaqt filtrini tozalash
        currentTimeFilter = 'all';
        
        // Savdo tahlili filtrini tozalash
        currentAnalysisFilter = 'none';
        
        // Barcha vaqt filtr tugmalaridan active classni olib tashlash
        document.querySelectorAll('.time-filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Barcha tahlil filtr tugmalaridan active classni olib tashlash
        document.querySelectorAll('.analysis-filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // X tugmasini yashirish
        document.getElementById('clearSearchBtn').style.display = 'none';
        
        // Mijozlarni qayta yuklash va ko'rsatish
        loadCustomers();
        displayCustomers();
    }

    // Vaqt oralig'ini hisoblash - ENDI BACKEND'DA ISHLATILADI


</script>
{% endblock %}
