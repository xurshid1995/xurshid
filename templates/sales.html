{% extends "base_with_sidebar.html" %}

{% block title %}Savdo - Dokon Boshqaruv Tizimi{% endblock %}

{% block extra_css %}
<style>
    .sales-container {
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #dee2e6;
    }

    .page-header h1 {
        margin: 0;
        color: #333;
        font-size: 24px;
    }
</style>
{% endblock %}

{% block content %}
<div class="sales-container">
    <div class="page-header">
        <h1>🛒 Savdo Sahifasi</h1>
    </div>

    <!-- Ikkita 665px kenglikda layout -->
    <div style="display: grid; grid-template-columns: 665px 665px; gap: 20px; justify-content: center; padding: 20px;">
        <!-- Birinchi layout -->
        <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 665px; box-sizing: border-box;">
            <!-- Joylashuv va Mijoz tanlash -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500; color: #495057;">📍 Joylashuvni tanlang</label>
                    <select id="locationSelect" onchange="loadProducts()" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; background: white; cursor: pointer;">
                        <option value="">Tanlang...</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500; color: #495057;">👤 Mijozni tanlang</label>
                    <input type="text" id="customerSearch" placeholder="Mijoz qidirish..." style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                </div>
            </div>
            
            <!-- Mahsulot qidirish -->
            <div style="margin-bottom: 15px;">
                <input type="text" id="productSearch" placeholder="Mahsulot nomini kiriting..." style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
            </div>
            
            <!-- Mahsulotlar jadvali -->
            <div style="overflow: auto; width: 100%;">
                <table style="width: 100%; border-collapse: collapse; min-width: 580px;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 10px 8px; text-align: left; font-size: 13px; color: #495057; min-width: 300px; word-wrap: break-word; white-space: normal; border-right: 1px solid #dee2e6;">Mahsulot</th>
                            <th style="padding: 10px 8px; text-align: center; font-size: 13px; color: #495057; min-width: 80px; width: 80px; word-wrap: break-word; white-space: normal; border-right: 1px solid #dee2e6;">Mavjud</th>
                            <th style="padding: 10px 8px; text-align: right; font-size: 13px; color: #495057; min-width: 150px; width: 150px; word-wrap: break-word; white-space: normal;">Narx</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                        <tr>
                            <td colspan="3" style="text-align: center; padding: 30px; color: #999;">
                                Joylashuvni tanlang
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Ikkinchi layout -->
        <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; color: #333;">Layout 2</h3>
            <div style="min-height: 400px; border: 2px dashed #dee2e6; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #999;">
                <p>Ikkinchi layout</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Joylashuvlarni yuklash
    async function loadLocations() {
        try {
            const response = await fetch('/api/locations');
            const locations = await response.json();
            
            const locationSelect = document.getElementById('locationSelect');
            locationSelect.innerHTML = '<option value="">Tanlang...</option>';
            
            locations.forEach(location => {
                const option = document.createElement('option');
                option.value = `${location.type}_${location.id}`;
                const locationType = location.type === 'warehouse' ? '🏭 Ombor' : '🏪 Do\'kon';
                option.textContent = `${locationType}: ${location.name}`;
                locationSelect.appendChild(option);
            });
            
            console.log(`✅ ${locations.length} ta joylashuv yuklandi`);
        } catch (error) {
            console.error('Joylashuvlarni yuklashda xatolik:', error);
        }
    }
    
    // Mahsulotlarni yuklash
    async function loadProducts() {
        const locationSelect = document.getElementById('locationSelect');
        const tbody = document.getElementById('productsTable');
        
        const locationValue = locationSelect.value;
        
        if (!locationValue) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px; color: #999;">Joylashuvni tanlang</td></tr>';
            return;
        }
        
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px; color: #999;">⏳ Yuklanmoqda...</td></tr>';
        
        try {
            const [type, id] = locationValue.split('_');
            const response = await fetch(`/api/products?location=${locationValue}`);
            const data = await response.json();
            
            console.log('API response:', data);
            
            // API dan kelgan ma'lumotni tekshirish
            const products = Array.isArray(data) ? data : (data.products || []);
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px; color: #999;">Mahsulotlar topilmadi</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            products.forEach(product => {
                // Quantity va selling price ni olish
                let quantity = 0;
                let sellingPrice = product.sell_price || product.price || 0;
                
                // Agar stocks mavjud bo'lsa, locationga mos keladiganini topish
                if (product.stocks && product.stocks.length > 0) {
                    const [type, id] = locationValue.split('_');
                    const locationId = parseInt(id);
                    
                    // Mos stock ni topish
                    const matchingStock = product.stocks.find(stock => {
                        if (type === 'warehouse') {
                            return stock.warehouse_id === locationId;
                        } else if (type === 'store') {
                            return stock.store_id === locationId;
                        }
                        return false;
                    });
                    
                    if (matchingStock) {
                        quantity = matchingStock.quantity || 0;
                    }
                }
                
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #f0f0f0';
                row.innerHTML = `
                    <td style="padding: 12px 8px; font-size: 14px; color: #333; word-wrap: break-word; white-space: normal; border-right: 1px solid #eee;" title="${product.name || 'N/A'}">${product.name || 'N/A'}</td>
                    <td style="padding: 12px 8px; text-align: center; font-size: 14px; color: #28a745; font-weight: 500; word-wrap: break-word; white-space: normal; border-right: 1px solid #eee;">${quantity}</td>
                    <td style="padding: 12px 8px; text-align: right; font-size: 14px; color: #333; font-weight: 500; word-wrap: break-word; white-space: normal;">${formatPrice(sellingPrice)} so'm</td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`✅ ${products.length} ta mahsulot yuklandi`);
        } catch (error) {
            console.error('Mahsulotlarni yuklashda xatolik:', error);
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px; color: #dc3545;">⚠️ Xatolik yuz berdi</td></tr>';
        }
    }
    
    // Narxni formatlash
    function formatPrice(price) {
        if (!price) return '0';
        return Number(price).toLocaleString('uz-UZ');
    }
    
    // Sahifa yuklanganda joylashuvlarni yuklash
    document.addEventListener('DOMContentLoaded', function() {
        loadLocations();
        console.log('✅ Sales sahifasi tayyor');
    });
</script>
{% endblock %}
