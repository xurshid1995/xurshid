{% extends "base_with_sidebar.html" %}

{% block title %}Savdo - Omborxona Boshqaruv Tizimi{% endblock %}

{% block extra_css %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
    .sales-container {
        padding: 1rem;
        background: #f8f9fa;
        min-height: auto;
        overflow-x: auto; /* Gorizontal scroll qo'shish */
        -webkit-overflow-scrolling: touch; /* iOS uchun smooth scroll */
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }

    .page-header {
        margin-bottom: 0.5rem;
        text-align: left;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    /* Mobile uchun header optimizatsiyasi */
    @media (max-width: 768px) {
        .page-header {
            margin-bottom: 0.1rem;
        }
        
        .page-header h1 {
            font-size: 1.5rem;
            flex: 1;
            min-width: 200px;
        }
    }

    .page-header .btn {
        position: static;
        transform: none;
        padding: 8px 12px;
        font-size: 0.8rem;
        min-width: auto;
        max-width: 150px;
        flex-shrink: 0;
        height: auto;
        line-height: 1.2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Mobile uchun kichikroq o'lcham */
    @media (max-width: 768px) {
        .page-header .btn {
            padding: 6px 10px;
            font-size: 0.75rem;
            max-width: 100px;
        }
        
        .page-header .btn i {
            font-size: 0.7rem;
            margin-right: 4px;
        }
        
        .page-header .btn .btn-text {
            display: none;
        }
        
        .page-header .btn::after {
            content: "Yangi";
            font-size: 0.7rem;
        }
    }
    
    /* Juda kichik ekranlar uchun faqat icon */
    @media (max-width: 480px) {
        .page-header .btn {
            padding: 6px 8px;
            max-width: 40px;
        }
        
        .page-header .btn i {
            margin-right: 0;
        }
        
        .page-header .btn::after {
            display: none;
        }
    }



    .page-header h1 {
        margin: 0;
        font-size: 2rem;
        color: #333;
        font-weight: 600;
        white-space: nowrap;
        flex-shrink: 0;
    }

    /* Tab Sistema CSS */
    .tabs-container {
        margin-bottom: 1rem;
        border-bottom: 2px solid #e9ecef;
    }

    .tabs-nav {
        display: flex;
        align-items: center;
        gap: 2px;
        overflow-x: auto;
        padding-bottom: 0;
    }

    .tab-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-bottom: none;
        border-radius: 8px 8px 0 0;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 150px;
        position: relative;
        margin-right: 2px;
    }

    .tab-item:hover {
        background: #e9ecef;
    }

    .tab-item.active {
        background: white;
        border-color: #007bff;
        border-bottom: 2px solid white;
        margin-bottom: -2px;
        z-index: 1;
    }

    .tab-title {
        flex: 1;
        font-weight: 500;
        color: #495057;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .tab-item.active .tab-title {
        color: #007bff;
        font-weight: 600;
    }

    .tab-close {
        margin-left: 8px;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #dc3545;
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.2s ease;
    }

    .tab-close:hover {
        background: #c82333;
        transform: scale(1.1);
    }

    /* Faqat bitta tab bo'lsa, close tugmasini yashirish */
    .tab-item:only-child .tab-close {
        display: none;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Split Layout - sodda qilish */
    .split-container {
        display: flex;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        gap: 10px;
        overflow-x: auto; /* Gorizontal scroll qo'shish */
        -webkit-overflow-scrolling: touch; /* iOS uchun smooth scroll */
    }



    /* Sol panel - Mahsulotlar ro'yxati */
    .left-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
        /* Mobile da 100% kenglik, desktop da 40% */
        flex: 1;
        width: 100%; /* Default 100% */
        max-width: 100%; /* Default 100% */
    }

    /* Desktop-only qoida */
    @media (min-width: 769px) {
        .left-panel {
            flex: 0 0 40% !important; /* Desktop da 40% */
            width: 40% !important; /* Desktop da 40% */
            max-width: 40% !important; /* Desktop da 40% */
        }
    }

    .panel-header {
        background: #667eea;
        color: white;
        padding: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .panel-content {
        flex: 1;
        padding: 1rem;
    }

    /* Form elementlari */
    .form-row {
        margin-bottom: 0.2rem;
    }

    .form-row-double {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
    }

    /* Eski form-row-product-quantity stillar olib tashlandi - yangi struktura ishlatiladi */

    /* Mavjud va Miqdor qatori uchun maxsus stil */
    .form-row-quantities {
        margin-top: -10px !important; /* Yuqoridan bo'shliqni qisqartirish */
        margin-bottom: 0.2rem;
    }

    /* Sotish narxi qatori uchun maxsus stil */
    .form-row-prices {
        margin-top: 15px !important; /* Yuqoridan bo'shliqni kengaytirish */
        margin-bottom: 0.2rem;
    }

    .form-row-double {
        margin-top: -15px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-row label {
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.9rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
    }

    /* Mahsulot qidirish dropdown */
    .product-search-container {
        position: relative;
    }

    .product-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 0 0 8px 8px;
        z-index: 1000;
        box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        max-height: 400px;
        overflow-y: auto;
        min-height: 50px;
    }

    .product-dropdown-item {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #e9ecef;
        background: #ffffff;
        font-size: 1rem;
        min-height: auto; /* Avtomatik balandlik */
        white-space: normal; /* Matn qator bo'yicha o'ralishini ta'minlash */
    }
    
    .product-dropdown-item:hover {
        background-color: #f8f9fa !important;
    }

    .product-dropdown-item:active {
        background-color: #e9ecef !important;
    }
    
    .product-dropdown-content {
        white-space: normal; /* nowrap o'rniga normal */
        overflow: visible; /* hidden o'rniga visible */
        word-wrap: break-word; /* Uzun so'zlarni bo'lish */
        line-height: 1.4; /* Qator oralig'i */
    }
    
    .quantity-badge {
        color: white !important;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 3px;
    }

    /* Mijoz qidirish dropdown */
    .customer-search-container {
        position: relative;
    }

    .customer-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid #667eea;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 400px; /* Ko'proq natijalarni ko'rsatish uchun */
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .dropdown-item {
        padding: 0.75rem;
        border-bottom: 1px solid #e9ecef;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .dropdown-item:hover {
        background: #f8f9fa;
    }

    .dropdown-item:last-child {
        border-bottom: none;
    }

    /* Qo'shish tugmasi */
    .btn-add {
        background: #28a745;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-weight: 600;
        width: 100%;
    }

    .btn-add:hover {
        background: #218838;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:hover {
        background: #5a67d8;
    }



    /* Mahsulotlar ro'yxati */
    .products-list {
        max-height: none;
    }

    .product-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .product-item:hover {
        background: #f8f9fa;
        border-color: #667eea;
    }

    .product-info h4 {
        margin: 0 0 0.25rem 0;
        color: #2c3e50;
        font-size: 1rem;
    }

    .product-info p {
        margin: 0;
        color: #6c757d;
        font-size: 0.9rem;
    }

    .product-price {
        font-weight: 600;
        color: #28a745;
        font-size: 1.1rem;
    }

    /* O'ng panel - Savdo korzinasi */
    .right-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        flex: 1;
        box-sizing: border-box;
        /* Desktop da 60% kenglik, mobile da 100% */
        width: 100%; /* Default 100% */
        max-width: 100%; /* Default 100% */
    }

    /* Desktop-only qoida */
    @media (min-width: 769px) {
        .right-panel {
            width: calc(60% - 10px) !important; /* Desktop da 60% */
            max-width: calc(60% - 10px) !important; /* Desktop da 60% */
        }
    }

    /* Korzina qidiruvi */
    .cart-search-container {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e9ecef;
        background-color: #f8f9fa;
    }

    .search-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .cart-search-input {
        width: 100%;
        padding: 0.5rem 2.5rem 0.5rem 0.75rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.875rem;
        background-color: white;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .cart-search-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
    }

    .search-icon {
        position: absolute;
        right: 0.75rem;
        color: #6c757d;
        font-size: 0.875rem;
        pointer-events: none;
    }

    /* Qidiruv highlight */
    .search-highlight {
        background-color: #ffeb3b;
        color: #333;
        font-weight: 600;
        padding: 1px 2px;
        border-radius: 2px;
        box-shadow: 0 1px 2px rgba(255, 235, 59, 0.3);
    }

    /* Korzina ro'yxati */
    .cart-list {
        flex: 1;
    }

    /* Table responsive wrapper - desktop uchun */
    .table-responsive {
        overflow: visible; /* Desktop da overflow visible */
        width: 100%;
    }

    /* Cart table container - desktop uchun */
    .cart-table-container {
        width: 100%;
        max-width: 100%;
        overflow: visible; /* Desktop da overflow visible */
        box-sizing: border-box;
        padding: 5px;
    }

    /* KATTAROQ JADVAL - o'lchamni oshirish */
    .cart-table {
        width: 100% !important; /* 98% dan 100% ga oshirdik */
        max-width: 100% !important; /* 98% dan 100% ga oshirdik */
        min-width: auto !important; /* Global min-width: 800px ni bekor qilish */
        border-collapse: collapse !important;
        font-size: 0.75rem !important; /* 0.6rem dan 0.75rem ga kattalashtirish */
        border: 1px solid #dee2e6 !important;
        table-layout: auto !important; /* Fixed ni auto qilish - bu asosiy o'zgarish! */
        box-sizing: border-box !important;
        margin: 0 auto !important;
    }

    /* Ensure right-panel and cart container allow horizontal scrolling when table is wider
       than the available panel width. This targets the specific overflow issue in desktop
       device-emulation where the sidebar + content can push the table out of layout. */
    .split-container .right-panel,
    .split-container .right-panel .cart-table-container {
        overflow-x: auto !important;
        overflow-y: visible !important;
        -webkit-overflow-scrolling: touch !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
    }

    /* Jadval ustunlari o'z holatida qolishi kerak - gorizontal scroll uchun */
    .cart-table {
        min-width: 700px !important; /* Jadval eng kamida 700px bo'lsin */
        width: 700px !important;      /* Fixed kenglik - ustunlar siqilmaydi */
        table-layout: fixed !important; /* Fixed layout ustunlar siqilishini oldini oladi */
    }

    .cart-table th, .cart-table td {
        white-space: nowrap !important; /* Matnlar qator bo'yicha o'ralmasin */
        overflow: visible !important;   /* Matn to'liq ko'rinsin */
        text-overflow: clip !important; /* Ellipsis emas, to'liq matn */
    }

    .cart-table th {
        background-color: #f8f9fa;
        padding: 0.5rem; /* 0.4rem dan 0.5rem ga oshirdik */
        text-align: left;
        border-bottom: 2px solid #dee2e6;
        border-right: 1px solid #dee2e6; /* Vertical border qo'shish */
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem; /* 0.8rem dan 0.9rem ga oshirdik */
        line-height: 1.3; /* Line height ham oshirdik */
    }

    .cart-table th:last-child {
        border-right: none; /* Oxirgi ustun uchun border yo'q */
    }

    .cart-table td {
        padding: 0.5rem; /* 0.4rem dan 0.5rem ga oshirdik */
        border-bottom: 1px solid #e9ecef;
        border-right: 1px solid #e9ecef; /* Vertical border qo'shish */
        vertical-align: middle;
        font-size: 0.9rem; /* 0.8rem dan 0.9rem ga oshirdik */
        line-height: 1.3; /* Line height ham oshirdik */
    }

    .cart-table td:last-child {
        border-right: none; /* Oxirgi ustun uchun border yo'q */
    }

    /* DESKTOP UCHUN USTUN KENGLIKLAR - Foiz asosida */
    @media (min-width: 769px) {
        .cart-table th:nth-child(1), .cart-table td:nth-child(1) { width: 12% !important; } /* Joylashuv */
        .cart-table th:nth-child(2), .cart-table td:nth-child(2) { width: 43% !important; } /* Mahsulot - kengaytirildi */
        .cart-table th:nth-child(3), .cart-table td:nth-child(3) { width: 13% !important; } /* Miqdor - asl holiga */
        .cart-table th:nth-child(4), .cart-table td:nth-child(4) { width: 14% !important; } /* Narx */
        .cart-table th:nth-child(5), .cart-table td:nth-child(5) { width: 13% !important; } /* Jami */
        .cart-table th:nth-child(6), .cart-table td:nth-child(6) { width: 5% !important; } /* Amallar */
    }

    /* Narx ustunlari uchun alohida stil */
    .cart-table td:nth-child(4), 
    .cart-table td:nth-child(5) {
        line-height: 1.4;
    }

    /* Narx ustunidagi asosiy matnni qalinroq qilish */
    .cart-table td:nth-child(4) {
        font-weight: 700 !important; /* Qalin font */
        color: #2c3e50 !important; /* To'q rang */
    }

    /* Mobile responsive uchun korzina jadvali */
    @media (max-width: 768px) {
        .table-responsive {
            overflow-x: auto !important; /* Table-responsive ni ham mobile da auto qilish */
            -webkit-overflow-scrolling: touch !important;
        }
        
        .cart-table-container {
            overflow-x: auto !important; /* Gorizontal scroll qo'shish */
            overflow-y: visible !important; /* Vertikal scroll yo'q */
            -webkit-overflow-scrolling: touch !important; /* iOS uchun smooth scroll */
            border: 1px solid #dee2e6 !important;
            border-radius: 8px !important;
            max-width: 100% !important;
            width: 100% !important;
            margin: 0 auto !important;
            padding: 0 !important; /* Padding olib tashlash */
        }

        .cart-table {
            min-width: 700px !important; /* Minimal kenglik - ustunlar siqilmasin */
            font-size: 0.7rem !important; /* Kichikroq font */
            width: 700px !important; /* Fixed width - ustunlar o'z joyida */
            table-layout: fixed !important; /* Fixed layout - ustunlar siqilmaydi */
        }

        .cart-table th {
            padding: 0.3rem !important; /* Kichikroq padding */
            font-size: 0.75rem !important;
            white-space: nowrap !important; /* nowrap - ustunlar siqilmasin */
            overflow: visible !important;   /* Matn to'liq ko'rinsin */
        }

        .cart-table td {
            padding: 0.3rem !important; /* Kichikroq padding */
            font-size: 0.7rem !important;
            white-space: nowrap !important; /* nowrap - ustunlar siqilmasin */
            overflow: visible !important;   /* Matn to'liq ko'rinsin */
        }

        /* Mobile uchun ustun kengliklari */
        .cart-table th:nth-child(1), .cart-table td:nth-child(1) { width: 85px !important; } /* Joylashuv */
        .cart-table th:nth-child(2), .cart-table td:nth-child(2) { width: 220px !important; } /* Mahsulot */
        .cart-table th:nth-child(3), .cart-table td:nth-child(3) { width: 75px !important; } /* Miqdor */
        .cart-table th:nth-child(4), .cart-table td:nth-child(4) { width: 100px !important; } /* Narx */
        .cart-table th:nth-child(5), .cart-table td:nth-child(5) { width: 100px !important; } /* Jami */
        .cart-table th:nth-child(6), .cart-table td:nth-child(6) { width: 40px !important; } /* Amallar */

        /* Mobile uchun narx qiymatlarini kichikroq qilish */
        .cart-table td:nth-child(4) small, 
        .cart-table td:nth-child(5) small {
            font-size: 9px !important;
            padding: 1px 3px !important;
        }

        /* Mobile uchun qty input */
        .qty-input {
            width: 35px !important;
            height: 20px !important;
            font-size: 0.6rem !important;
        }

        .remove-btn {
            width: 22px !important;
            height: 22px !important;
            font-size: 0.9rem !important;
        }
    }

    /* Juda kichik ekranlar uchun (480px va undan kichik) */
    @media (max-width: 480px) {
        .table-responsive {
            overflow-x: auto !important; /* Table-responsive ni ham kichik ekranda auto qilish */
            -webkit-overflow-scrolling: touch !important;
            width: 100% !important;
        }
        
        .cart-table-container {
            overflow-x: auto !important;
            overflow-y: visible !important;
            -webkit-overflow-scrolling: touch !important;
            border: 1px solid #dee2e6 !important;
            border-radius: 6px !important;
            max-width: 100% !important;
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box !important;
        }

        .cart-table {
            min-width: 650px !important; /* Kichikroq minimal kenglik - lekin yetarli */
            width: 650px !important; /* Fixed width - ustunlar siqilmasin */
            font-size: 0.65rem !important; /* Juda kichik font */
            table-layout: fixed !important; /* Fixed layout - ustunlar o'z joyida */
        }

        .cart-table th {
            padding: 0.25rem !important; /* Juda kichik padding */
            font-size: 0.7rem !important;
            white-space: nowrap !important; /* nowrap - ustunlar siqilmasin */
            overflow: visible !important;   /* Matn to'liq ko'rinsin */
        }

        .cart-table td {
            padding: 0.25rem !important; /* Juda kichik padding */
            font-size: 0.65rem !important;
            white-space: nowrap !important; /* nowrap - ustunlar siqilmasin */
            overflow: visible !important;   /* Matn to'liq ko'rinsin */
        }

        /* 480px uchun ustun kengliklari - optimallashtirish */
        .cart-table th:nth-child(1), .cart-table td:nth-child(1) { width: 65px !important; } /* Joylashuv */
        .cart-table th:nth-child(2), .cart-table td:nth-child(2) { width: 180px !important; } /* Mahsulot */
        .cart-table th:nth-child(3), .cart-table td:nth-child(3) { width: 60px !important; } /* Miqdor */
        .cart-table th:nth-child(4), .cart-table td:nth-child(4) { width: 90px !important; } /* Narx */
        .cart-table th:nth-child(5), .cart-table td:nth-child(5) { width: 90px !important; } /* Jami */
        .cart-table th:nth-child(6), .cart-table td:nth-child(6) { width: 35px !important; } /* Amallar */

        /* 480px uchun narx qiymatlarini yanada kichikroq qilish */
        .cart-table td:nth-child(4) small, 
        .cart-table td:nth-child(5) small {
            font-size: 8px !important;
            padding: 1px 2px !important;
            border-radius: 2px !important;
        }

        /* 480px uchun input va button o'lchamlari */
        .qty-input {
            width: 30px !important;
            height: 18px !important;
            font-size: 0.55rem !important;
            padding: 1px !important;
        }

        .remove-btn {
            width: 18px !important;
            height: 18px !important;
            font-size: 0.8rem !important;
        }

        /* Edit button kichikroq */
        .edit-btn {
            font-size: 0.7rem !important;
        }
    }

    /* Juda-juda kichik ekranlar uchun (320px va undan kichik) */
    @media (max-width: 320px) {
        .table-responsive {
            overflow-x: auto !important;
            -webkit-overflow-scrolling: touch !important;
            width: 100% !important;
        }
        
        .cart-table-container {
            overflow-x: auto !important;
            overflow-y: visible !important;
            -webkit-overflow-scrolling: touch !important;
            border: 1px solid #dee2e6 !important;
            border-radius: 4px !important;
            max-width: 100% !important;
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box !important;
        }

        .cart-table {
            min-width: 600px !important; /* Yanada kichikroq minimal kenglik - lekin yetarli */
            width: 600px !important; /* Fixed width - ustunlar siqilmasin */
            font-size: 0.6rem !important; /* Juda kichik font */
            table-layout: fixed !important; /* Fixed layout - ustunlar o'z joyida */
        }

        .cart-table th {
            padding: 0.2rem !important; /* Minimal padding */
            font-size: 0.65rem !important;
            white-space: nowrap !important; /* nowrap - ustunlar siqilmasin */
            overflow: visible !important;   /* Matn to'liq ko'rinsin */
        }

        .cart-table td {
            padding: 0.2rem !important; /* Minimal padding */
            font-size: 0.6rem !important;
            white-space: nowrap !important; /* nowrap - ustunlar siqilmasin */
            overflow: visible !important;   /* Matn to'liq ko'rinsin */
        }

        /* 320px uchun ustun kengliklari - maksimal optimallashtirish */
        .cart-table th:nth-child(1), .cart-table td:nth-child(1) { width: 55px !important; } /* Joylashuv */
        .cart-table th:nth-child(2), .cart-table td:nth-child(2) { width: 160px !important; } /* Mahsulot */
        .cart-table th:nth-child(3), .cart-table td:nth-child(3) { width: 50px !important; } /* Miqdor */
        .cart-table th:nth-child(4), .cart-table td:nth-child(4) { width: 80px !important; } /* Narx */
        .cart-table th:nth-child(5), .cart-table td:nth-child(5) { width: 80px !important; } /* Jami */
        .cart-table th:nth-child(6), .cart-table td:nth-child(6) { width: 30px !important; } /* Amallar */

        /* 320px uchun narx qiymatlarini minimal qilish */
        .cart-table td:nth-child(4) small, 
        .cart-table td:nth-child(5) small {
            font-size: 7px !important;
            padding: 1px !important;
            border-radius: 1px !important;
        }

        /* 320px uchun input va button o'lchamlari minimal */
        .qty-input {
            width: 25px !important;
            height: 16px !important;
            font-size: 0.5rem !important;
            padding: 0 !important;
        }

        .remove-btn {
            width: 16px !important;
            height: 16px !important;
            font-size: 0.7rem !important;
        }

        /* Container-ning o'zi mobile da to'liq kenglikda bo'lishi */
        .right-panel {
            width: 100% !important;
            max-width: 100% !important;
        }
    }



    /* Narx va jami ustunlaridagi som qiymatlarini kattalashtirish */
    .cart-table td:nth-child(4) small, /* Narx ustunidagi som */
    .cart-table td:nth-child(5) small  /* Jami ustunidagi som */ {
        font-size: 14px !important; /* 10px dan 14px ga kattalashtirish */
        color: white !important; /* Oq rang */
        font-weight: 700 !important; /* Qalinroq font - 500 dan 700 ga */
        display: inline-block !important; /* Inline-block qilish */
        margin-top: 3px !important; /* Yuqoridan ozgina joy */
        background-color: #007bff !important; /* Ko'k fon */
        padding: 2px 6px !important; /* Ichki joy */
        border-radius: 4px !important; /* Burchaklarni yumaloq qilish */
        box-shadow: 0 1px 3px rgba(0, 123, 255, 0.3) !important; /* Soya */
    }

    .cart-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .qty-input {
        width: 40px; /* 50px dan 40px ga kichiklashtirdik */
        height: 22px; /* 25px dan 22px ga kichiklashtirdik */
        text-align: center;
        border: 1px solid #ddd;
        border-radius: 3px; /* 4px dan 3px ga kichiklashtirdik */
        font-size: 0.65rem; /* 0.75rem dan 0.65rem ga kichiklashtirdik */
    }

    .remove-btn {
        background: transparent; /* Shaffof fon */
        color: #dc3545; /* Qizil X belgisi */
        border: none; /* Border yo'q */
        width: 26px; /* 20px dan 26px ga oshirdik */
        height: 26px; /* 20px dan 26px ga oshirdik */
        border-radius: 0; /* Burchaklar tekis */
        cursor: pointer;
        font-size: 1.1rem; /* 0.8rem dan 1.1rem ga oshirdik */
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s ease; /* Faqat rang o'tishi */
    }

    .remove-btn:hover {
        color: #a71e2a; /* Hover da to'qroq qizil */
        background: transparent; /* Shaffof qoladi */
    }

    .action-buttons-group {
        display: flex;
        flex-direction: column; /* Vertical layout */
        gap: 2px; /* 3px dan 2px ga kichiklashtirdik */
        justify-content: center;
        align-items: center;
    }

    .edit-btn {
        background: transparent; /* Shaffof fon */
        color: #007bff; /* Ko'k qalam belgisi */
        border: none; /* Border yo'q */
        width: 22px;
        height: 20px;
        border-radius: 0; /* Tekis burchaklar */
        cursor: pointer;
        font-size: 0.8rem; /* Qalam belgisi uchun */
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s ease; /* Faqat rang o'tishi */
    }

    .edit-btn:hover {
        color: #0056b3; /* Hover da to'qroq ko'k */
        background: transparent; /* Shaffof qoladi */
    }

    .location-badge {
        color: #6c757d;
        font-size: 0.85rem;
        font-weight: 400;
    }

    .location-type-badge {
        background: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
    }

    .location-badge:contains("Ombor") {
        background: #28a745;
    }

    .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        border-bottom: 1px solid #e9ecef;
    }

    .cart-item-info h5 {
        margin: 0 0 0.25rem 0;
        color: #2c3e50;
        font-size: 0.95rem;
    }

    .cart-item-info p {
        margin: 0;
        color: #6c757d;
        font-size: 0.85rem;
    }

    .cart-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .qty-btn {
        background: #667eea;
        color: white;
        border: none;
        width: 28px;
        height: 28px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
    }

    .qty-btn:hover {
        background: #5a67d8;
    }

    .qty-input {
        width: 50px;
        padding: 0.25rem;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        text-align: center;
        font-size: 0.9rem;
    }

    .price-input-inline {
        width: 80px;
        padding: 0.25rem;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        text-align: center;
        font-size: 0.9rem;
        font-weight: 600;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .price-input-inline:focus {
        outline: none;
        border-color: #28a745;
        box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2);
    }



    .product-id {
        color: #6c757d;
        font-size: 0.8rem;
    }

    .item-total {
        color: #28a745;
        font-size: 1rem;
    }

    .remove-btn {
        background: transparent; /* Shaffof fon */
        color: #dc3545; /* Qizil X belgisi */
        border: none; /* Border yo'q */
        width: 32px; /* 28px dan 32px ga oshirdik */
        height: 32px; /* 28px dan 32px ga oshirdik */
        border-radius: 0; /* Burchaklar tekis */
        cursor: pointer;
        font-size: 1.2rem; /* X belgisi uchun font qo'shildi */
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 0.5rem;
        transition: color 0.2s ease; /* Faqat rang o'tishi */
    }

    .remove-btn:hover {
        color: #a71e2a; /* Hover da to'qroq qizil */
        background: transparent; /* Shaffof qoladi */
    }

    /* Edit Card Styles */
    .edit-card-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .edit-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 450px;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            transform: scale(0.9) translateY(-20px);
            opacity: 0;
        }
        to {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
    }

    .edit-card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px 12px 0 0;
        position: relative;
    }

    .edit-card-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
    }

    .edit-card-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .edit-card-close:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .edit-card-body {
        padding: 1.5rem;
    }

    .edit-form-group {
        margin-bottom: 1.25rem;
    }

    .edit-form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.9rem;
    }

    .edit-form-control {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .edit-form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .edit-readonly {
        background: #f8f9fa;
        color: #6c757d;
    }

    .edit-location-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        background: #e9ecef;
        border-radius: 20px;
        font-size: 0.85rem;
        color: #495057;
        margin-bottom: 0.5rem;
    }

    .edit-location-badge.warehouse {
        background: #d4edda;
        color: #155724;
    }

    .edit-location-badge.store {
        background: #cce5ff;
        color: #004085;
    }

    .edit-price-display {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        margin: 1rem 0;
    }

    .edit-price-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .edit-price-row:last-child {
        margin-bottom: 0;
        padding-top: 0.5rem;
        border-top: 1px solid #dee2e6;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .edit-card-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e9ecef;
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
    }

    .edit-btn-cancel {
        background: #6c757d;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
        transition: background 0.2s;
    }

    .edit-btn-cancel:hover {
        background: #545b62;
    }

    .edit-btn-save {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .edit-btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    /* Inline Edit Card Styles */
    .cart-item-editing {
        background: #f8f9fa !important;
    }

    .inline-edit-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        margin: 8px 0;
        overflow: hidden;
        border: 2px solid #667eea;
        animation: expandCard 0.3s ease-out;
    }

    @keyframes expandCard {
        from {
            transform: scaleY(0.8);
            opacity: 0;
        }
        to {
            transform: scaleY(1);
            opacity: 1;
        }
    }

    .inline-edit-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem 1.5rem;
    }

    .edit-product-info h4 {
        margin: 0 0 0.5rem 0;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .edit-location-info {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .inline-edit-body {
        padding: 1.5rem;
    }

    .edit-controls-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .edit-control-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .edit-control-group label {
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.9rem;
    }

    .inline-edit-input {
        padding: 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .inline-edit-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .total-display {
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 8px;
        font-weight: 700;
        font-size: 1.1rem;
        color: #28a745;
        text-align: center;
        border: 2px solid #e9ecef;
    }

    .inline-edit-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .inline-btn-cancel {
        background: #6c757d;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
        transition: background 0.2s, transform 0.1s;
    }

    .inline-btn-cancel:hover {
        background: #5a6268;
        transform: translateY(-1px);
    }

    .inline-btn-save {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .inline-btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    /* Yangi karta elementlari */
    .product-title-row {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .product-icon {
        font-size: 2.5rem;
        opacity: 0.9;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .product-details {
        flex: 1;
    }

    .product-details h4 {
        margin: 0 0 0.5rem 0;
        font-size: 1.3rem;
        font-weight: 700;
    }

    .location-details-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 0.5rem;
    }

    .product-id-badge {
        background: rgba(255,255,255,0.25);
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        border: 1px solid rgba(255,255,255,0.3);
    }

    .edit-badge {
        background: rgba(255,255,255,0.2);
        padding: 0.75rem 1.25rem;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 600;
        border: 1px solid rgba(255,255,255,0.3);
        animation: glow 3s ease-in-out infinite alternate;
    }

    @keyframes glow {
        from { box-shadow: 0 0 5px rgba(255,255,255,0.2); }
        to { box-shadow: 0 0 20px rgba(255,255,255,0.4); }
    }

    .info-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.25rem;
        margin-bottom: 1.5rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 1rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .info-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .info-item.status-highlight {
        border-left: 4px solid #667eea;
    }

    .info-item.location-highlight {
        border-left: 4px solid #17a2b8;
    }

    .info-item.price-highlight {
        border-left: 4px solid #28a745;
    }

    .info-item.stock-info {
        border-left: 4px solid #ffc107;
    }

    .info-label {
        font-size: 0.85rem;
        color: #6c757d;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .info-value {
        font-weight: 700;
        color: #2c3e50;
        font-size: 1.1rem;
    }

    .info-value.price-display {
        color: #28a745;
        font-size: 1.3rem;
        font-weight: 800;
    }

    .info-value.product-code {
        color: #667eea;
        font-family: 'Courier New', monospace;
    }

    .info-value.stock-status {
        color: #28a745;
        font-weight: 600;
    }

    .location-type-warehouse {
        color: #17a2b8 !important;
        font-weight: 700;
    }

    .location-type-store {
        color: #dc3545 !important;
        font-weight: 700;
    }

    /* Enhanced Control Sections */
    .edit-controls-section {
        margin: 1.5rem 0;
        padding: 1.5rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        border: 1px solid #dee2e6;
    }

    .controls-title {
        margin: 0 0 1.5rem 0;
        font-size: 1.1rem;
        font-weight: 700;
        color: #2c3e50;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #667eea;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .edit-control-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        padding: 1rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .edit-control-group:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }

    .quantity-control {
        border-left: 4px solid #667eea;
    }

    .price-control {
        border-left: 4px solid #28a745;
    }

    .total-control {
        border-left: 4px solid #ffc107;
    }

    .control-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 700;
        color: #2c3e50;
        font-size: 0.95rem;
    }

    .label-icon {
        font-size: 1.1rem;
    }

    .input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .inline-edit-input {
        flex: 1;
        padding: 0.75rem 3rem 0.75rem 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .inline-edit-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .quantity-input {
        border-color: #667eea !important;
    }

    .price-input {
        border-color: #28a745 !important;
    }

    .input-unit {
        position: absolute;
        right: 0.75rem;
        color: #6c757d;
        font-weight: 600;
        font-size: 0.9rem;
        pointer-events: none;
    }

    .total-display-wrapper {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .total-display {
        padding: 1rem;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-radius: 8px;
        font-weight: 800;
        font-size: 1.2rem;
        text-align: center;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        animation: valueChange 0.3s ease-out;
    }

    @keyframes valueChange {
        0% { transform: scale(0.95); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .calculation-formula {
        text-align: center;
        padding: 0.5rem;
        background: rgba(0,0,0,0.05);
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        color: #6c757d;
    }

    /* Actions Section */
    .inline-edit-actions-section {
        margin-top: 1.5rem;
    }

    .actions-divider {
        height: 1px;
        background: linear-gradient(to right, transparent, #dee2e6, transparent);
        margin-bottom: 1.5rem;
    }

    .inline-edit-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        align-items: center;
    }

    .inline-btn-cancel {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .inline-btn-cancel:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }

    .inline-btn-delete {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .inline-btn-delete:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }

    .inline-btn-save {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .inline-btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        animation: saveGlow 1s ease-in-out infinite alternate;
    }

    @keyframes saveGlow {
        from { box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); }
        to { box-shadow: 0 4px 20px rgba(40, 167, 69, 0.5); }
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .price-warning {
        animation: slideInRight 0.3s ease-out;
    }

    .price-warning-inline {
        animation: fadeIn 0.3s ease-out;
    }

    .btn-icon {
        font-size: 1.1rem;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .info-row {
            grid-template-columns: 1fr;
            padding: 1rem;
            gap: 1rem;
        }

        .edit-controls-row {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .inline-edit-card {
            margin: 4px 0;
        }

        .inline-edit-header {
            padding: 1rem;
        }

        .product-title-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .location-details-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .inline-edit-actions {
            flex-direction: column;
            gap: 0.75rem;
        }

        .inline-btn-cancel,
        .inline-btn-delete,
        .inline-btn-save {
            width: 100%;
            justify-content: center;
        }

        .product-details h4 {
            font-size: 1.1rem;
        }

        .edit-badge {
            align-self: stretch;
            text-align: center;
        }
    }

    .input-hint {
        font-size: 0.8rem;
        color: #6c757d;
        font-style: italic;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .calculation-info {
        font-size: 0.8rem;
        color: #28a745;
        font-weight: 600;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
    }





    .inline-edit-actions {
        border-top: 1px solid #e9ecef;
        padding-top: 1.5rem;
        margin-top: 1.5rem;
    }

    .inline-btn-cancel,
    .inline-btn-save {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }

    .btn-icon {
        font-size: 1.1rem;
    }

    .btn-text {
        font-weight: 500;
    }



    /* Responsive inline edit */
    @media (max-width: 768px) {
        .edit-controls-row {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .inline-edit-actions {
            flex-direction: column;
        }

        .product-title-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .info-row {
            grid-template-columns: 1fr;
        }
    }

    /* Jami summa */
    .cart-total {
        padding: 1rem;
        border-top: 2px solid #e9ecef;
        background: #f8f9fa;
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .total-amount {
        font-size: 1.8rem; /* 1.5rem dan 1.8rem ga kattalashtirdik */
        font-weight: 700;
        color: #2c3e50;
    }

    /* Savdo tugmalari */
    .action-buttons {
        padding: 1rem;
        display: flex;
        gap: 0.5rem;
    }

    .btn {
        flex: 1;
        padding: 0.75rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-success {
        background: #28a745;
        color: white;
    }

    .btn-success:hover {
        background: #218838;
    }

    .btn-warning {
        background: #ffc107;
        color: #212529;
        font-weight: 600;
    }

    .btn-warning:hover {
        background: #e0a800;
        color: #212529;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #5a6268;
    }

    /* Bo'sh holatlar */
    .empty-state {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .split-container {
            flex-direction: column;
            gap: 10px;
            overflow-x: auto !important; /* Mobile da ham horizontal scroll */
            -webkit-overflow-scrolling: touch !important;
            width: 100% !important;
            max-width: 100% !important;
        }

        .sales-container {
            overflow-x: auto !important; /* Mobile da horizontal scroll */
            -webkit-overflow-scrolling: touch !important;
            padding: 0.5rem !important; /* Mobile da kichikroq padding */
        }
        
        .left-panel, .right-panel {
            flex: none !important;
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
        }

        .left-panel,
        .right-panel {
            min-height: 400px;
        }

        .page-header h1 {
            font-size: 1.5rem;
        }

        .form-row-double {
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }

        .form-input {
            padding: 0.6rem;
            font-size: 0.9rem;
        }
        
        /* Mobile mahsulot qidirish dropdown */
        .product-dropdown-content {
            white-space: normal !important; /* nowrap ni bekor qilish */
            overflow: visible !important;
            text-overflow: unset !important;
            word-wrap: break-word;
            line-height: 1.4;
        }
        
        .product-dropdown-item {
            padding: 15px 12px; /* Kattaroq padding mobil uchun */
            min-height: 60px; /* Minimum balandlik */
            white-space: normal;
        }
        
        /* Mobile Cart Table - Card Format */
        .cart-table {
            min-width: auto; /* Minimum kenglik olib tashlash */
            width: 100%; /* To'liq kenglik */
        }
        
        .mobile-cart {
            display: block;
        }
        
        .mobile-cart-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }
        
        .mobile-cart-item .item-header {
            font-weight: 600;
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }
        
        .mobile-cart-item .item-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .mobile-cart-item .detail-item {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
        }
        
        .mobile-cart-item .detail-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 2px;
        }
        
        .mobile-cart-item .detail-value {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .mobile-cart-item .item-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #eee;
            padding-top: 12px;
            margin-top: 12px;
        }
        
        .mobile-cart-item .qty-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .mobile-cart-item .qty-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.2s;
        }
        
        .mobile-cart-item .qty-btn:hover {
            background: #f8f9fa;
            border-color: #007bff;
            color: #007bff;
        }
        
        .mobile-cart-item .qty-input {
            width: 50px;
            height: 28px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .mobile-cart-item .edit-btn {
            background: transparent; /* Shaffof fon */
            color: #007bff; /* Ko'k qalam belgisi */
            border: none; /* Border yo'q */
            padding: 6px 12px;
            border-radius: 0; /* Tekis burchaklar */
            font-size: 0.9rem; /* Biroz kattaroq qalam */
            cursor: pointer;
            transition: color 0.2s;
            margin-right: 8px;
        }
        
        .mobile-cart-item .edit-btn:hover {
            color: #0056b3; /* Hover da to'qroq ko'k */
            background: transparent; /* Shaffof qoladi */
        }
        
        .mobile-cart-item .remove-btn {
            background: transparent; /* Shaffof fon */
            color: #dc3545; /* Qizil X belgisi */
            border: none; /* Border yo'q */
            padding: 8px 16px; /* 6px 12px dan 8px 16px ga oshirdik */
            border-radius: 0; /* Tekis burchaklar */
            font-size: 1.1rem; /* 0.9rem dan 1.1rem ga oshirdik */
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .mobile-cart-item .remove-btn:hover {
            color: #a71e2a; /* Hover da to'qroq qizil */
            background: transparent; /* Shaffof qoladi */
        }
        
        .mobile-cart-item .total-price {
            font-size: 1.1rem;
            font-weight: 600;
            color: #007bff;
            background: #e3f2fd;
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
        }
        
        .mobile-cart-item .item-details {
            grid-template-columns: 1fr;
        }
        
        .mobile-cart-item .item-actions {
            flex-direction: column;
            gap: 10px;
        }
        
        .mobile-cart-item .qty-controls {
            justify-content: center;
        }
        
    }
            align-items: center;
        }
        
        .mobile-cart-item .item-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }
        
        .mobile-cart-item .detail-item {
            display: flex;
            justify-content: space-between;
        }
        
        .mobile-cart-item .detail-label {
            font-weight: 500;
            color: #6c757d;
        }
        
        .mobile-cart-item .detail-value {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .mobile-cart-item .item-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }
        
        .mobile-cart-item .qty-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mobile-cart-item .qty-btn {
            background: #007bff;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .mobile-cart-item .qty-btn:hover {
            background: #0056b3;
            transform: scale(1.1);
        }
        
        .mobile-cart-item .qty-input {
            width: 80px;
            height: 40px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        
        .mobile-cart-item .edit-btn {
            background: transparent; /* Shaffof fon */
            color: #007bff; /* Ko'k qalam belgisi */
            border: none; /* Border yo'q */
            padding: 10px 15px;
            border-radius: 0; /* Tekis burchaklar */
            font-size: 1rem; /* Qalam belgisi uchun */
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s ease;
        }
        
        .mobile-cart-item .edit-btn:hover {
            color: #0056b3; /* Hover da to'qroq ko'k */
            background: transparent; /* Shaffof qoladi */
        }
        
        .mobile-cart-item .remove-btn {
            background: transparent; /* Shaffof fon */
            color: #dc3545; /* Qizil X belgisi */
            border: none; /* Border yo'q */
            padding: 10px 16px; /* 8px 12px dan 10px 16px ga oshirdik */
            border-radius: 0; /* Tekis burchaklar */
            font-size: 1.2rem; /* 1rem dan 1.2rem ga oshirdik */
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .mobile-cart-item .remove-btn:hover {
            color: #a71e2a; /* Hover da to'qroq qizil */
            background: transparent; /* Shaffof qoladi */
        }
        
        .mobile-cart-item .total-price {
            font-size: 1.2rem;
            font-weight: bold;
            color: #28a745;
        }
    }
    
    /* Mobile savdo formasi */
    @media (max-width: 480px) {
        .mobile-cart-item .item-details {
            grid-template-columns: 1fr;
            gap: 5px;
        }
        
        .mobile-cart-item .item-actions {
            flex-direction: column;
            gap: 10px;
            align-items: stretch;
        }
        
        .mobile-cart-item .qty-controls {
            justify-content: center;
        }
        
        /* Juda kichik ekranlar uchun mahsulot dropdown */
        .product-dropdown-item {
            padding: 8px 6px;
            font-size: 0.8rem; /* Kichikroq font */
        }
        
        .product-dropdown-content {
            white-space: nowrap !important; /* Bitta qatorga majburlash */
            overflow: hidden !important;
            text-overflow: ellipsis !important; /* Ellipsis qaytarish */
            font-size: 0.8rem; /* Kichikroq font */
        }
        
        .product-dropdown {
            max-height: 300px; /* Kichikroq maksimal balandlik */
        }
        
        /* 480px da cart table - gorizontal scroll olib tashlash */
        .cart-table {
            min-width: auto !important; /* Minimum kenglik olib tashlash */
            width: 100% !important; /* To'liq kenglik */
            max-width: 100% !important; /* Maksimal kenglik cheklash */
            font-size: 0.65rem !important; /* Kichikroq font */
            table-layout: auto !important; /* Fixed ni auto qilish - horizontal scroll uchun */
        }
        
        /* Mobile da ustun kengliklarini qayta belgilash - olib tashlandi conflict tufayli */
        
        .cart-table th, .cart-table td {
            padding: 0.35rem !important; /* Padding yana oshirdik */
            font-size: 0.75rem !important; /* Font ham yana oshirdik */
        }
    }

    /* Desktop da mobile cart ni yashirish */
    .mobile-cart {
        display: none;
    }

    /* Disabled maydonlar uchun stil */
    .form-input:disabled, select:disabled {
        background-color: #f8f9fa !important;
        color: #6c757d !important;
        cursor: not-allowed !important;
        opacity: 0.6;
        border-color: #dee2e6 !important;
    }

    .form-input:disabled::placeholder {
        color: #adb5bd !important;
    }

</style>
{% endblock %}

{% block content %}
<div class="sales-container" data-user-role="{{ session.role }}" data-user-store-id="{{ session.store_id or '' }}">
    <div class="page-header">
        <h1>🛒 Savdo Boshqaruvi</h1>
        <button id="newSaleBtn" class="btn" title="Yangi savdo tabi qo'shish (Ctrl+N)" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 8px 14px; border-radius: 6px; font-weight: 500; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.3s ease; font-size: 0.8rem;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 3px 6px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
            <i class="fas fa-plus" style="margin-right: 6px; font-size: 0.75rem;"></i>
            <span class="btn-text">Yangi Savdo</span>
        </button>
    </div>

    <!-- Tab Sistema -->
    <div class="tabs-container">
        <div class="tabs-nav" id="tabsNav">
            <!-- Tablar bu yerga qo'shiladi -->
        </div>
    </div>

    <!-- Tab Content -->
    <div id="tabsContent">
        <!-- Tablar bu yerga qo'shiladi -->
    </div>
</div>

<!-- Sale Tab Template -->
<script type="text/template" id="saleTabTemplate">
    <div class="tab-content" id="tab-{TAB_ID}">
        <div class="split-container">
            <!-- Sol panel - Mahsulot ma'lumotlari -->
            <div class="left-panel">
                <div class="panel-header">
                    <span>📦</span>
                    Mahsulot ma'lumotlari
                </div>
                <div class="panel-content">
                    <!-- 1-qator: Joylashuv tanlash -->
                    <div class="form-row">
                        <label for="locationSelect-{TAB_ID}">📍 Joylashuv tanlash:</label>
                        <select id="locationSelect-{TAB_ID}" class="form-input" onchange="loadLocationProducts('{TAB_ID}')">
                            <option value="">Joylashuvni tanlang</option>
                        </select>
                    </div>

                    <!-- 2-qator: Mijoz tanlash -->
                    <div class="form-row">
                        <label for="customerSearch-{TAB_ID}">👤 Mijoz tanlash:</label>
                        <div class="customer-search-container">
                            <input type="text" id="customerSearch-{TAB_ID}" class="form-input" placeholder="Mijoz nomini kiriting (ixtiyoriy)..." onkeyup="if(!['ArrowDown','ArrowUp','Enter','Escape'].includes(event.key)) searchCustomers('{TAB_ID}')" onkeydown="handleCustomerKeyNavigation(event, '{TAB_ID}')">
                            <div id="customerDropdown-{TAB_ID}" class="customer-dropdown" style="display: none;"></div>
                            <input type="hidden" id="selectedCustomerId-{TAB_ID}" value="">
                        </div>
                    </div>

                    <!-- 3-qator: Mahsulot qidirish -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productSearch-{TAB_ID}">🔍 Mahsulot qidirish:</label>
                            <div class="product-search-container">
                                <input type="text" id="productSearch-{TAB_ID}" class="form-input" placeholder="Mahsulot nomini kiriting (min 2 harf)..." onkeyup="if(!['ArrowDown','ArrowUp','Enter','Escape'].includes(event.key)) debouncedSearchProducts('{TAB_ID}')" onkeydown="handleProductKeyNavigation(event, '{TAB_ID}')">
                                <div id="productDropdown-{TAB_ID}" class="product-dropdown" style="display: none;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 4-qator: Mavjud va Miqdor bir qatorda -->
                    <div class="form-row form-row-quantities">
                        <div style="display: grid; grid-template-columns: 0.7fr 0.6fr; gap: 15px;">
                            <div class="form-group" style="margin: 0;">
                                <label for="availableQuantity-{TAB_ID}" style="font-size: 0.85rem; color: #666;">📊 Mavjud:</label>
                                <input type="text" id="availableQuantity-{TAB_ID}" class="form-input" readonly placeholder="0" style="background: #f8f9fa; cursor: not-allowed;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label for="quantity-{TAB_ID}" style="font-size: 0.85rem; color: #666;">📦 Miqdor:</label>
                                <input type="number" id="quantity-{TAB_ID}" class="form-input" placeholder="0" min="0" onkeydown="if(event.key==='Enter') addSelectedProduct('{TAB_ID}')">
                            </div>
                        </div>
                    </div>

                    <!-- 5-qator: Sotish narxi USD va UZS -->
                    <div class="form-row form-row-double form-row-prices">
                        <div class="form-group">
                            <label for="priceUSD-{TAB_ID}">💵 Sotish narxi ($):</label>
                            <input type="number" id="priceUSD-{TAB_ID}" class="form-input" placeholder="0.00" step="0.01" oninput="debouncedConvertPrice('usd', '{TAB_ID}', 200)" onchange="convertPrice('usd', '{TAB_ID}')" onkeydown="if(event.key==='Enter') addSelectedProduct('{TAB_ID}')">
                        </div>
                        <div class="form-group">
                            <label for="priceUZS-{TAB_ID}">💰 Sotish narxi (UZS):</label>
                            <input type="number" id="priceUZS-{TAB_ID}" class="form-input" placeholder="0" step="1" oninput="debouncedConvertPrice('uzs', '{TAB_ID}', 200)" onchange="convertPrice('uzs', '{TAB_ID}')" onkeydown="if(event.key==='Enter') addSelectedProduct('{TAB_ID}')">
                        </div>
                    </div>

                    <!-- Qo'shish tugmasi -->
                    <div class="form-row">
                        <button class="btn btn-primary btn-add" id="addButton-{TAB_ID}" onclick="addSelectedProduct('{TAB_ID}')">
                            <span id="addButtonIcon-{TAB_ID}">➕</span>
                            <span id="addButtonText-{TAB_ID}">Savdo korzinasiga qo'shish</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- O'ng panel - Savdo ro'yxati -->
            <div class="right-panel">
                <div class="panel-header">
                    <span>🛒</span>
                    <span id="cartTitle-{TAB_ID}">Savdo ro'yxati</span>
                </div>
                
                <!-- Korzina qidiruvi -->
                <div class="cart-search-container" id="cartSearchContainer-{TAB_ID}" style="display: none;">
                    <div class="search-input-wrapper">
                        <input type="text" 
                               id="cartSearch-{TAB_ID}" 
                               class="cart-search-input" 
                               placeholder="Korzinada qidiring..."
                               oninput="filterCartItems('{TAB_ID}')">
                        <span class="search-icon">🔍</span>
                    </div>
                </div>
                
                <div class="panel-content">
                    <!-- Bo'sh korzina -->
                    <div id="emptyCart-{TAB_ID}" class="empty-state">
                        <h4>🛒 Korzina bo'sh</h4>
                        <p>Savdo qilish uchun mahsulot tanlang</p>
                    </div>

                    <!-- Korzina ro'yxati -->
                    <div id="cartList-{TAB_ID}" class="cart-list" style="display: none;">
                        <!-- Desktop versiya -->
                        <div class="cart-table-container">
                            <table class="cart-table">
                                <thead>
                                    <tr>
                                        <th>Joylashuv</th>
                                        <th>Mahsulot</th>
                                        <th>Miqdori</th>
                                        <th>Narx</th>
                                        <th>Jami</th>
                                        <th>T</th>
                                    </tr>
                                </thead>
                                <tbody id="cartTableBody-{TAB_ID}">
                                    <!-- Tanlangan mahsulotlar bu yerga qo'shiladi -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Mobile versiya -->
                        <div class="mobile-cart" id="mobileCart-{TAB_ID}">
                            <!-- Mobile cart items bu yerga qo'shiladi -->
                        </div>
                    </div>
                </div>

                <!-- Jami summa -->
                <div class="cart-total" id="cartTotal-{TAB_ID}" style="display: none;">
                    <div class="total-row">
                        <span>Mahsulot turlari:</span>
                        <span id="totalItems-{TAB_ID}">0</span>
                    </div>
                    <div class="total-row">
                        <span>Jami summa:</span>
                        <span class="total-amount" id="totalAmount-{TAB_ID}">$0.00</span>
                    </div>
                </div>

                <!-- Savdo tugmalari -->
                <div class="action-buttons" id="actionButtons-{TAB_ID}" style="display: none;">
                    <button class="btn btn-secondary" onclick="clearCart('{TAB_ID}')">🗑️ Tozalash</button>
                    <button class="btn btn-warning" onclick="saveSalePending('{TAB_ID}')">⏳ Keyinroq tasdiqlash</button>
                    <button class="btn btn-success" onclick="completeSale('{TAB_ID}')">✅ Savdo qilish</button>
                </div>
            </div>
        </div>
    </div>
</script>



<script>
    let allProducts = []; // Deprecated - lazy loading ishlatilmoqda
    let allLocations = [];
    let allCustomers = [];
    let allStores = []; // Do'konlar ro'yxati
    let allWarehouses = []; // Omborlar ro'yxati
    
    // Tab sistema uchun global o'zgaruvchilar
    let tabs = {}; // Har bir tab uchun ma'lumotlar: {tabId: {cart: [], selectedProduct: null, ...}}
    let activeTabId = null;
    let tabCounter = 0;
    
    // Window-level global valyuta kursi (base.html bilan shared)
    window.USD_TO_UZS_RATE = window.USD_TO_UZS_RATE || null;
    
    // Helper funksiyalar: faol tab uchun element olish
    function getActiveElement(baseId) {
        if (!activeTabId) {
            console.error(`getActiveElement: Faol tab yo'q (${baseId})`);
            return null;
        }
        return document.getElementById(`${baseId}-${activeTabId}`);
    }
    
    // Faol tab ma'lumotlarini olish
    function getActiveTabData() {
        if (!activeTabId || !tabs[activeTabId]) {
            console.error(`getActiveTabData: Faol tab ma'lumotlari yo'q`);
            return null;
        }
        return tabs[activeTabId];
    }
    let USD_TO_UZS_RATE = window.USD_TO_UZS_RATE;
    let editingSaleId = null;
    let isEditMode = false; // Tahrirlash rejimi
    let originalQuantities = {}; // Tahrirlash boshida asl miqdorlarni saqlash
    let originalSaleProcessed = false; // Asl savdo bir marta qayta ishlanganini belgilash
    let editingSaleStatus = null; // Tahrirlangan savdo holati: 'pending' yoki 'paid'
    
    // Avtomatik saqlash uchun o'zgaruvchilar
    let currentPendingSaleId = null;
    let autoSaveTimeout = null;
    let isAutoSaving = false;
    let isLoadingEditData = false; // Tahrirlash ma'lumotlari yuklanayotganini belgilash

    // Debug mode configuration - Production da false qiling
    const DEBUG_MODE = true; // Development uchun
    
    // Debug logging function
    function debugLog(...args) {
        if (DEBUG_MODE) {
            console.log(...args);
        }
    }
    
    // UZS ga aylantirish funksiyasi
    function convertToUZS(usdAmount) {
        // Window-level currency rate'ni ham tekshirish
        const currentRate = window.USD_TO_UZS_RATE || USD_TO_UZS_RATE;
        
        debugLog(`🔢 convertToUZS: ${usdAmount} USD`);
        debugLog(`🔢 USD_TO_UZS_RATE: ${USD_TO_UZS_RATE}`);
        debugLog(`🔢 window.USD_TO_UZS_RATE: ${window.USD_TO_UZS_RATE}`);
        debugLog(`🔢 Ishlatiladigan kurs: ${currentRate}`);
        
        if (currentRate === null || currentRate === undefined) {
            console.warn('⚠️ Hech qanday valyuta kursi yuklanmagan, 12500 fallback ishlatilmoqda');
            return (parseFloat(usdAmount) * 12500).toFixed(0);
        }
        
        const result = (parseFloat(usdAmount) * currentRate).toFixed(0);
        debugLog(`✅ ${usdAmount} USD × ${currentRate} = ${result} UZS`);
        return result;
    }

    // Narxni formatlash (USD va som)
    function formatPrice(usdAmount) {
        const usdFormatted = parseFloat(usdAmount).toFixed(2);
        const uzsFormatted = convertToUZS(usdAmount);
        return `$${usdFormatted}<br><small style="color: #6c757d; font-size: 10px;">${parseInt(uzsFormatted).toLocaleString('uz-UZ')}</small>`;
    }

    // Ma'lumotlarni reset qilish funksiyasi
    function resetData(tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) return;
        
        const tabData = tabs[currentTabId];
        if (!tabData) return;
        
        tabData.cart = [];
        updateCart(currentTabId);
        
        const customerSearch = document.getElementById(`customerSearch-${currentTabId}`);
        const selectedCustomerId = document.getElementById(`selectedCustomerId-${currentTabId}`);
        const productSearch = document.getElementById(`productSearch-${currentTabId}`);
        const quantity = document.getElementById(`quantity-${currentTabId}`);
        const priceUSD = document.getElementById(`priceUSD-${currentTabId}`);
        const priceUZS = document.getElementById(`priceUZS-${currentTabId}`);
        const locationSelect = document.getElementById(`locationSelect-${currentTabId}`);
        
        if (customerSearch) customerSearch.value = '';
        if (selectedCustomerId) selectedCustomerId.value = '';
        if (productSearch) productSearch.value = '';
        if (quantity) quantity.value = '1';
        if (priceUSD) priceUSD.value = '';
        if (priceUZS) priceUZS.value = '';
        if (locationSelect) locationSelect.value = '';
        
        // Korzina sarlavhasini yangilash
        updateCart(currentTabId);
    }





    // Sahifa yuklanganda ma'lumotlarni olish
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            // SALES: Valyuta kursini olish
            debugLog('🔌 SALES DOMContentLoaded: valyuta kursini yuklayman...');
            await loadSalesCurrencyRate();
            
            await loadLocations();
            await loadCustomers();
            // loadProducts() deprecated - lazy loading ishlatiladi
            
            // URL parametrini tekshirish (edit mode)
            checkEditMode();
            
            // Birinchi tabni yaratish
            addNewSaleTab();
            
            // Yangi savdo tugmasi event listener
            const newSaleBtn = document.getElementById('newSaleBtn');
            if (newSaleBtn) {
                newSaleBtn.addEventListener('click', function() {
                    addNewSaleTab();
                });
            }
            
            // Keyboard shortcut: Ctrl+N yangi savdo uchun
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault(); // Browser'ning standart Ctrl+N funksiyasini to'xtatish
                    addNewSaleTab();
                }
            });
        } catch (error) {
            console.error('Error loading initial data:', error);
        }
    });

    // Joylashuvlarni yuklash
    async function loadLocations() {
        try {
            console.log('🔄 Fetching locations from /api/locations...');
            const response = await fetch('/api/locations');
            console.log('📡 Response status:', response.status);
            
            const locations = await response.json();
            console.log('📦 Raw locations data:', locations);
            console.log('📦 Locations count:', locations.length);
            
            allLocations = locations;
            
            // Do'konlar va omborlarni alohida ajratish
            allStores = locations.filter(loc => loc.type === 'store');
            allWarehouses = locations.filter(loc => loc.type === 'warehouse');
            
            console.log('🏪 Stores:', allStores);
            console.log('🏭 Warehouses:', allWarehouses);
            
            debugLog(`✅ ${locations.length} ta joylashuv yuklandi (${allStores.length} do'kon, ${allWarehouses.length} ombor)`);
            
            // Faol tablar uchun joylashuvlarni yangilash
            Object.keys(tabs).forEach(tabId => {
                populateTabSelects(tabId);
            });
        } catch (error) {
            console.error('Error loading locations:', error);
            allLocations = [];
            allStores = [];
            allWarehouses = [];
        }
    }

    // Mijozlarni yuklash
    async function loadCustomers() {
        try {
            const response = await fetch('/api/customers');
            const customers = await response.json();
            allCustomers = customers;
            displayCustomers(customers);
            console.log(`✅ ${customers.length} ta mijoz yuklandi`);
        } catch (error) {
            console.error('Error loading customers:', error);
            allCustomers = [];
        }
    }

    function displayCustomers(customers) {
        // Mijozlar ro'yxati allCustomers o'zgaruvchiga saqlanadi
        // Qidirish orqali ishlaydi
    }

    // Mijozlar qidirish funksiyasi
    function searchCustomers(tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) {
            console.error('searchCustomers: Tab ID topilmadi');
            return;
        }
        
        const customerSearch = document.getElementById(`customerSearch-${currentTabId}`);
        const dropdown = document.getElementById(`customerDropdown-${currentTabId}`);
        
        if (!customerSearch || !dropdown) {
            console.error(`searchCustomers: Elementlar topilmadi (tabId: ${currentTabId})`);
            return;
        }
        
        const searchTerm = customerSearch.value.toLowerCase().trim();
        
        if (!searchTerm) {
            dropdown.style.display = 'none';
            // Mijoz maydoni bo'sh bo'lganda selectedCustomerId ham tozalash
            const selectedCustomerId = document.getElementById(`selectedCustomerId-${currentTabId}`);
            if (selectedCustomerId) selectedCustomerId.value = '';
            
            // Tab ma'lumotlaridan mijoz ma'lumotlarini tozalash
            if (tabs[currentTabId]) {
                tabs[currentTabId].selectedCustomer = null;
            }
            
            // Tab nomini yangilash
            updateTabTitle(currentTabId);
            
            // Sarlavhani yangilash
            updateCart(currentTabId);
            return;
        }

        const filteredCustomers = allCustomers.filter(customer => 
            (customer.name && customer.name.toLowerCase().includes(searchTerm)) ||
            (customer.phone && customer.phone.includes(searchTerm)) ||
            (customer.email && customer.email && customer.email.toLowerCase().includes(searchTerm))
        );
        
        // Keyboard navigation uchun barcha natijalarni saqlash
        filteredCustomersForNav = filteredCustomers; // Barcha mijozlarni ko'rsatish
        
        displayCustomerDropdown(filteredCustomers, currentTabId);
    }

    function displayCustomerDropdown(customers, tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) return;
        
        const dropdown = document.getElementById(`customerDropdown-${currentTabId}`);
        if (!dropdown) return;
        
        if (customers.length === 0) {
            dropdown.innerHTML = '<div class="dropdown-item" style="color: #6c757d; text-align: center;">Mijoz topilmadi</div>';
            dropdown.style.display = 'block';
            return;
        }

        let dropdownHtml = '';
        customers.forEach((customer, index) => { // Barcha mijozlarni ko'rsatish
            dropdownHtml += `
                <div class="dropdown-item" data-customer-id="${customer.id}" onclick="selectCustomer(${customer.id}, '${currentTabId}')">
                    <strong>${customer.name}</strong><br>
                    <small>Tel: ${customer.phone || 'N/A'} | Email: ${customer.email || 'N/A'}</small>
                </div>
            `;
        });

        dropdown.innerHTML = dropdownHtml;
        dropdown.style.display = 'block';
        
        // Keyboard navigation uchun birinchi elementni highlight qilish
        currentCustomerHighlight = 0;
        highlightCustomerItem(0, currentTabId);
    }

    // Keyboard navigation uchun o'zgaruvchilar
    let currentCustomerHighlight = -1;
    let filteredCustomersForNav = [];
    
    // Product keyboard navigation uchun o'zgaruvchilar
    let currentProductHighlight = -1;
    let filteredProductsForNav = [];

    // Mijoz keyboard navigation
    function handleCustomerKeyNavigation(event, tabId) {
        const currentTabId = tabId || activeTabId;
        const dropdown = document.getElementById(`customerDropdown-${currentTabId}`);
        
        if (!dropdown || dropdown.style.display === 'none') return;
        
        const items = dropdown.querySelectorAll('.dropdown-item');
        if (items.length === 0) return;
        
        switch(event.key) {
            case 'ArrowDown':
                event.preventDefault();
                currentCustomerHighlight = Math.min(currentCustomerHighlight + 1, items.length - 1);
                highlightCustomerItem(currentCustomerHighlight, currentTabId);
                break;
                
            case 'ArrowUp':
                event.preventDefault();
                currentCustomerHighlight = Math.max(currentCustomerHighlight - 1, 0);
                highlightCustomerItem(currentCustomerHighlight, currentTabId);
                break;
                
            case 'Enter':
                event.preventDefault();
                if (currentCustomerHighlight >= 0 && items[currentCustomerHighlight]) {
                    items[currentCustomerHighlight].click();
                }
                break;
                
            case 'Escape':
                event.preventDefault();
                dropdown.style.display = 'none';
                currentCustomerHighlight = -1;
                break;
        }
    }
    
    function handleProductKeyNavigation(event, tabId) {
        const currentTabId = tabId || activeTabId;
        const dropdown = document.getElementById(`productDropdown-${currentTabId}`);
        
        if (!dropdown || dropdown.style.display === 'none') return;
        
        const items = dropdown.querySelectorAll('.product-dropdown-item');
        if (items.length === 0) return;
        
        switch(event.key) {
            case 'ArrowDown':
                event.preventDefault();
                currentProductHighlight = Math.min(currentProductHighlight + 1, items.length - 1);
                highlightProductItem(currentProductHighlight, currentTabId);
                break;
                
            case 'ArrowUp':
                event.preventDefault();
                currentProductHighlight = Math.max(currentProductHighlight - 1, 0);
                highlightProductItem(currentProductHighlight, currentTabId);
                break;
                
            case 'Enter':
                event.preventDefault();
                if (currentProductHighlight >= 0 && items[currentProductHighlight]) {
                    items[currentProductHighlight].click();
                }
                break;
                
            case 'Escape':
                event.preventDefault();
                dropdown.style.display = 'none';
                currentProductHighlight = -1;
                break;
        }
    }

    // Mijoz elementini highlight qilish
    function highlightCustomerItem(index, tabId) {
        const currentTabId = tabId || activeTabId;
        const dropdown = document.getElementById(`customerDropdown-${currentTabId}`);
        if (!dropdown) return;
        
        const items = dropdown.querySelectorAll('.dropdown-item');
        
        // Barcha highlight ni olib tashlash
        items.forEach((item, i) => {
            if (i === index) {
                item.style.backgroundColor = '#007bff';
                item.style.color = 'white';
                item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            } else {
                item.style.backgroundColor = '';
                item.style.color = '';
            }
        });
        
        currentCustomerHighlight = index;
    }
    
    function highlightProductItem(index, tabId) {
        const currentTabId = tabId || activeTabId;
        const dropdown = document.getElementById(`productDropdown-${currentTabId}`);
        if (!dropdown) return;
        
        const items = dropdown.querySelectorAll('.product-dropdown-item');
        
        // Barcha highlight ni olib tashlash
        items.forEach((item, i) => {
            if (i === index) {
                // Background ko'k qilish
                item.style.backgroundColor = '#007bff';
                item.style.color = 'white';
                
                // Ichidagi barcha matnlarni oq rangga o'zgartirish
                const allTextElements = item.querySelectorAll('*');
                allTextElements.forEach(element => {
                    element.style.setProperty('color', 'white', 'important');
                });
                
                item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            } else {
                // Reset qilish
                item.style.backgroundColor = '';
                item.style.color = '';
                
                // Ichidagi elementlarning rangini qaytarish
                const allTextElements = item.querySelectorAll('*');
                allTextElements.forEach(element => {
                    element.style.removeProperty('color');
                });
            }
        });
        
        currentProductHighlight = index;
    }

    // Mijozni tanlash
    function selectCustomer(customerId, tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) {
            console.error('selectCustomer: Tab ID topilmadi');
            return;
        }
        
        const selectedCustomer = allCustomers.find(c => c.id === customerId);
        if (!selectedCustomer) return;

        // Form maydonlarini to'ldirish
        const customerSearch = document.getElementById(`customerSearch-${currentTabId}`);
        const selectedCustomerId = document.getElementById(`selectedCustomerId-${currentTabId}`);
        const customerDropdown = document.getElementById(`customerDropdown-${currentTabId}`);
        
        if (customerSearch) customerSearch.value = `${selectedCustomer.name} - ${selectedCustomer.phone || 'N/A'}`;
        if (selectedCustomerId) selectedCustomerId.value = selectedCustomer.id;
        if (customerDropdown) customerDropdown.style.display = 'none';
        
        // Tab ma'lumotlarida mijoz ma'lumotlarini saqlash
        if (!tabs[currentTabId]) tabs[currentTabId] = {};
        tabs[currentTabId].selectedCustomer = selectedCustomer;
        
        // Tab nomini yangilash
        updateTabTitle(currentTabId);
        
        // Korzina sarlavhasini yangilash
        updateCart(currentTabId);
        
        // Mijoz tanlangandan keyin mahsulot qidiruviga fokus berish
        setTimeout(() => {
            const productSearch = document.getElementById(`productSearch-${currentTabId}`);
            if (productSearch) {
                productSearch.focus();
            }
        }, 100);
        
    }

    // Savdo ro'yxati sarlavhasini yangilash
    function updateCartTitle(customer = null, tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) return;
        
        const cartTitle = document.getElementById(`cartTitle-${currentTabId}`);
        if (customer) {
            // Agar customer string bo'lsa (faqat nom), uni obyekt sifatida qarab chiqamiz
            if (typeof customer === 'string') {
                cartTitle.textContent = `${customer} - Savdo ro'yxati`;
            } else {
                // Agar customer obyekt bo'lsa, nom va telefon raqamini ko'rsatamiz
                const phone = customer.phone ? ` (${customer.phone})` : '';
                cartTitle.textContent = `${customer.name}${phone} - Savdo ro'yxati`;
            }
        } else {
            cartTitle.textContent = 'Savdo ro\'yxati';
        }
    }

    // Mahsulotlarni yuklash (lazy loading)
    // Bu funksiya deprecated - endi lazy loading ishlatilmoqda

    // Joylashuv o'zgartirilganda mahsulotlarni yuklash
    // Global o'zgaruvchilar optimizatsiya uchun
    let selectedLocationInfo = null; // Tanlangan joylashuv ma'lumotlari
    let searchDebounceTimer = null; // Debounce timer
    
    function loadLocationProducts(tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) {
            console.error('loadLocationProducts: Tab ID topilmadi');
            return;
        }
        
        const locationSelect = document.getElementById(`locationSelect-${currentTabId}`);
        const productSearch = document.getElementById(`productSearch-${currentTabId}`);
        const dropdown = document.getElementById(`productDropdown-${currentTabId}`);
        
        if (!locationSelect || !productSearch || !dropdown) {
            console.error(`loadLocationProducts: Elementlar topilmadi (tabId: ${currentTabId})`);
            return;
        }
        
        const locationValue = locationSelect.value;
        
        if (!locationValue) {
            // Agar joylashuv tanlanmagan bo'lsa
            selectedLocationInfo = null;
            allProducts = [];
            productSearch.value = '';
            dropdown.style.display = 'none';
            selectedProduct = null;
            console.log('❌ Joylashuv tanlanmadi');
            return;
        }

        // locationValue dan location_type va location_id ni ajratish
        // Format: "warehouse_1" yoki "store_2"
        const [locationType, locationId] = locationValue.split('_');
        
        // Tanlangan joylashuv ma'lumotlarini saqlash (mahsulotlarni yuklamasdan)
        selectedLocationInfo = {
            type: locationType,
            id: locationId,
            value: locationValue
        };
        
        // Mahsulotlar ro'yxatini tozalash (lazy loading uchun - allProducts deprecated)
        
        // Mahsulot qidirishni tozalash
        productSearch.value = '';
        dropdown.style.display = 'none';
        
        // Tanlangan mahsulot ma'lumotlarini tozalash
        selectedProduct = null;
        
        console.log(`✅ Joylashuv tanlandi: ${locationType} ${locationId} (Mahsulotlar lazy loading orqali yuklanadi)`);
        
        // Joylashuv tanlangandan keyin mijoz input maydoniga fokus berish
        setTimeout(() => {
            const customerInput = document.getElementById(`customerSearch-${currentTabId}`);
            if (customerInput) {
                customerInput.focus();
                console.log(`🎯 Fokus mijoz maydoniga berildi (Tab ${currentTabId})`);
            }
        }, 100); // Kichik kechikish - DOM yangilanishi uchun
    }

    // Click tashqarisida dropdown yashirish
    document.addEventListener('click', function(event) {
        // Mahsulot dropdown (hamma faol tablar uchun)
        if (activeTabId) {
            const productSearchContainer = document.querySelector(`#tab-${activeTabId} .product-search-container`);
            const productDropdown = document.getElementById(`productDropdown-${activeTabId}`);
            
            if (productSearchContainer && productDropdown && !productSearchContainer.contains(event.target)) {
                productDropdown.style.display = 'none';
            }
        }

        // Mijoz dropdown
        if (activeTabId) {
            const customerSearchContainer = document.querySelector(`#tab-${activeTabId} .customer-search-container`);
            const customerDropdown = document.getElementById(`customerDropdown-${activeTabId}`);
            
            if (customerSearchContainer && customerDropdown && !customerSearchContainer.contains(event.target)) {
                customerDropdown.style.display = 'none';
                currentCustomerHighlight = -1; // Highlight reset
            }
        }
    });

    // Debounced qidirish funksiyasi (300ms kechikish)
    function debouncedSearchProducts(tabId) {
        // Oldingi timer'ni bekor qilish
        if (searchDebounceTimer) {
            clearTimeout(searchDebounceTimer);
        }
        
        // Yangi timer o'rnatish
        searchDebounceTimer = setTimeout(() => {
            searchProducts(tabId);
        }, 300); // 300ms kechikish
    }

    // Mahsulot qidirish (OPTIMIZED - Lazy Loading)
    function searchProducts(tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) {
            console.error('searchProducts: Tab ID topilmadi');
            return;
        }
        
        const productSearch = document.getElementById(`productSearch-${currentTabId}`);
        const dropdown = document.getElementById(`productDropdown-${currentTabId}`);
        const locationSelect = document.getElementById(`locationSelect-${currentTabId}`);
        
        if (!productSearch || !dropdown || !locationSelect) {
            console.error(`searchProducts: Elementlar topilmadi (tabId: ${currentTabId})`);
            return;
        }
        
        const searchTerm = productSearch.value.trim();
        
        // Joylashuv tanlanmaganligini tekshirish
        if (!selectedLocationInfo || !locationSelect.value) {
            alert('❌ Avval joylashuvni tanlang!');
            dropdown.style.display = 'none';
            productSearch.value = '';
            return;
        }
        
        if (!searchTerm || searchTerm.length < 2) {
            dropdown.style.display = 'none';
            return;
        }

        // Loading holatini ko'rsatish
        dropdown.innerHTML = '<div class="product-dropdown-item" style="text-align: center; color: #666;"><i class="fas fa-spinner fa-spin"></i> Qidirilmoqda...</div>';
        dropdown.style.display = 'block';

        // Server tomonidan qidirish (lazy loading)
        const searchUrl = `/api/search-products-by-location/${selectedLocationInfo.type}/${selectedLocationInfo.id}?search=${encodeURIComponent(searchTerm)}&limit=20`;
        
        fetch(searchUrl)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const products = data.products || [];
                console.log(`🔍 Server tomonidan ${products.length} ta mahsulot topildi: "${searchTerm}"`);
                
                // Har bir mahsulotga joylashuv ma'lumotlarini qo'shish
                products.forEach(product => {
                    if (!product.location_id) {
                        product.location_id = selectedLocationInfo.id;
                        product.location_type = selectedLocationInfo.type;
                    }
                });
                
                // Keyboard navigation uchun barcha natijalarni saqlash
                filteredProductsForNav = products; // Barcha mahsulotlarni ko'rsatish
                
                displayProductDropdown(products, currentTabId);
            })
            .catch(error => {
                console.error('Error searching products:', error);
                dropdown.innerHTML = '<div class="product-dropdown-item" style="text-align: center; color: #dc3545;">⚠️ Qidirishda xatolik yuz berdi</div>';
                setTimeout(() => {
                    dropdown.style.display = 'none';
                }, 2000);
            });
    }

    function displayProductDropdown(products, tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) return;
        
        const dropdown = document.getElementById(`productDropdown-${currentTabId}`);
        if (!dropdown) return;
        
        if (products.length === 0) {
            dropdown.style.display = 'none';
            return;
        }

        let dropdownHtml = '';
        products.forEach((product, index) => { // Barcha mahsulotlarni ko'rsatish
            const availableQty = product.available_quantity || product.total_stock || 0;
            const quantityText = product.location_type === 'warehouse' ? `Omborda: ${availableQty}` : `${availableQty}`;
            const uzsPrice = Math.round((product.price || 0) * USD_TO_UZS_RATE);
            
            // Mahsulot ma'lumotlarini JSON formatda saqlash
            const productDataJson = JSON.stringify(product).replace(/"/g, '&quot;');
            
            dropdownHtml += `
                <div class="product-dropdown-item" data-product-id="${product.id}" data-product-data="${productDataJson}" onclick="selectProductFromDropdown(this, '${currentTabId}')">
                    <div class="product-dropdown-content" style="display: flex; justify-content: space-between; align-items: center;">
                        <strong style="color: #2c3e50; font-size: 1.1rem;">${product.name}</strong>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: #28a745; font-weight: 600;">$${product.price || '0.00'} / ${uzsPrice.toLocaleString()} So'm</span>
                            <span class="quantity-badge" style="color: white !important; background-color: #28a745; padding: 2px 6px; border-radius: 3px; font-weight: 600;">${quantityText}</span>
                        </div>
                    </div>
                </div>
            `;
        });

        dropdown.innerHTML = dropdownHtml;
        dropdown.style.display = 'block';
        
        // Keyboard navigation uchun birinchi elementni highlight qilish
        currentProductHighlight = 0;
        highlightProductItem(0, currentTabId);
    }

    // Mahsulotni tanlash
    // Yangi funksiya: dropdown elementidan mahsulot tanlash
    function selectProductFromDropdown(element, tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) {
            console.error('selectProductFromDropdown: Tab ID topilmadi');
            return;
        }
        
        try {
            // Element'dan mahsulot ma'lumotlarini olish
            const productDataJson = element.getAttribute('data-product-data');
            const selectedProduct = JSON.parse(productDataJson.replace(/&quot;/g, '"'));
            
            selectProduct(selectedProduct, currentTabId);
        } catch (error) {
            console.error('Mahsulot ma\'lumotlarini parsing qilishda xatolik:', error);
            
            // Fallback: eski usul
            const productId = parseInt(element.getAttribute('data-product-id'));
            if (productId) {
                selectProductById(productId, currentTabId);
            }
        }
    }

    // Mahsulot obyekti bilan ishlash uchun yangilangan funksiya
    function selectProduct(selectedProduct, tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) {
            console.error('selectProduct: Tab ID topilmadi');
            return;
        }
        
        if (!selectedProduct) {
            console.error('selectProduct: Mahsulot ma\'lumotlari topilmadi');
            return;
        }

        // Joylashuv ma'lumotlarini olish
        const locationSelect = document.getElementById(`locationSelect-${currentTabId}`);
        if (!locationSelect || !locationSelect.value) {
            alert('❌ Iltimos, avval joylashuv tanlang!');
            return;
        }

        const [locationType, locationId] = locationSelect.value.split('_');
        
        // Mahsulot obyektiga joylashuv ma'lumotlarini qo'shish
        selectedProduct.location_id = parseInt(locationId);
        selectedProduct.location_type = locationType;
        selectedProduct.location_name = getLocationName(locationType, locationId);

        // Tab ma'lumotlarida mahsulotni saqlash
        if (tabs[currentTabId]) {
            tabs[currentTabId].selectedProduct = selectedProduct;
        }

        console.log(`🔍 Mahsulot tanlandi (Tab ${currentTabId}): ${selectedProduct.name}`);
        console.log(`📍 Joylashuv: ${selectedProduct.location_type} ${selectedProduct.location_id} (${selectedProduct.location_name})`);
        console.log(`💰 USD narxi: $${selectedProduct.price}`);
        console.log(`💰 Tan narxi: $${selectedProduct.cost_price}`);
        
        // Mahsulot tanlaganda validatsiyani faollashtirish/yangilash
        enablePriceValidationForTab(currentTabId);

        // Form maydonlarini to'ldirish
        const productSearch = document.getElementById(`productSearch-${currentTabId}`);
        const priceUSD = document.getElementById(`priceUSD-${currentTabId}`);
        
        if (productSearch) productSearch.value = selectedProduct.name;
        if (priceUSD) priceUSD.value = selectedProduct.price || 0;
        
        // Window-level currency rate'ni ham tekshirish
        const currentRate = window.USD_TO_UZS_RATE || USD_TO_UZS_RATE;
        console.log(`📊 Ishlatiladigan kurs: ${currentRate}`);
        
        const priceUZS = document.getElementById(`priceUZS-${currentTabId}`);
        
        // Valyuta kursi yuklanmagan bo'lsa, kutish
        if (currentRate === null || currentRate === undefined) {
            console.warn('⚠️ Hech qanday valyuta kursi yuklanmagan, 12500 fallback ishlatilmoqda');
            const uzsPrice = Math.round((selectedProduct.price || 0) * 12500);
            if (priceUZS) priceUZS.value = uzsPrice;
        } else {
            const uzsPrice = Math.round((selectedProduct.price || 0) * currentRate);
            console.log(`💱 Hisoblangan UZS narxi: ${uzsPrice} (${selectedProduct.price} x ${currentRate})`);
            if (priceUZS) priceUZS.value = uzsPrice;
        }
        
        const productDropdown = document.getElementById(`productDropdown-${currentTabId}`);
        if (productDropdown) productDropdown.style.display = 'none';

        // Miqdor maydonining maksimal qiymatini o'rnatish
        const availableQty = selectedProduct.available_quantity || selectedProduct.total_stock || 0;
        const quantityInput = document.getElementById(`quantity-${currentTabId}`);
        const availableQuantityInput = document.getElementById(`availableQuantity-${currentTabId}`);
        
        if (quantityInput) {
            quantityInput.max = availableQty;
            quantityInput.title = `Maksimal miqdor: ${availableQty}`;
        }
        
        // Mavjud miqdorni ko'rsatish
        if (availableQuantityInput) {
            availableQuantityInput.value = availableQty;
        }
        
        // Mahsulot tanlangandan keyin miqdor maydoniga fokus berish
        setTimeout(() => {
            const quantityInput = document.getElementById(`quantity-${currentTabId}`);
            if (quantityInput) {
                quantityInput.focus();
                quantityInput.select(); // Agar oldingi qiymat bo'lsa, uni tanlab qo'yish
            }
        }, 100);
    }
    
    // Fallback: mahsulot ID orqali server'dan ma'lumot olish
    function selectProductById(productId, tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId || !selectedLocationInfo) {
            console.error('selectProductById: Tab ID yoki joylashuv ma\'lumotlari topilmadi');
            return;
        }
        
        // Server'dan mahsulot ma'lumotlarini olish
        const searchUrl = `/api/search-products-by-location/${selectedLocationInfo.type}/${selectedLocationInfo.id}?search=&limit=1000`;
        
        fetch(searchUrl)
            .then(response => response.json())
            .then(data => {
                const products = data.products || [];
                const selectedProduct = products.find(p => p.id === productId);
                
                if (selectedProduct) {
                    selectProduct(selectedProduct, currentTabId);
                } else {
                    console.error(`Mahsulot topilmadi: ID ${productId}`);
                }
            })
            .catch(error => {
                console.error('Mahsulot ma\'lumotlarini olishda xatolik:', error);
            });
    }

    // Debounce funksiyasi - tez-tez chaqirilmaslik uchun
    let priceConvertTimeout = {};
    
    function debouncedConvertPrice(fromCurrency, tabId, delay = 300) {
        const currentTabId = tabId || activeTabId;
        
        // Avvalgi timeout ni bekor qilish
        if (priceConvertTimeout[currentTabId]) {
            clearTimeout(priceConvertTimeout[currentTabId]);
        }
        
        // Yangi timeout o'rnatish
        priceConvertTimeout[currentTabId] = setTimeout(() => {
            convertPrice(fromCurrency, currentTabId);
        }, delay);
    }

    // Narx konvertatsiyasi
    function convertPrice(fromCurrency, tabId) {
        // Agar tabId berilmagan bo'lsa, faol tabdan foydalanish
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) {
            console.error('convertPrice: Tab ID topilmadi');
            return;
        }
        
        const usdInput = document.getElementById(`priceUSD-${currentTabId}`);
        const uzsInput = document.getElementById(`priceUZS-${currentTabId}`);
        
        if (!usdInput || !uzsInput) {
            console.error(`convertPrice: Input elementlari topilmadi (tabId: ${currentTabId})`);
            return;
        }

        // Window-level currency rate'ni ham tekshirish
        const currentRate = window.USD_TO_UZS_RATE || USD_TO_UZS_RATE;
        
        console.log(`💱 convertPrice: ${fromCurrency}`);
        console.log(`💱 USD_TO_UZS_RATE: ${USD_TO_UZS_RATE}`);
        console.log(`💱 window.USD_TO_UZS_RATE: ${window.USD_TO_UZS_RATE}`);
        console.log(`💱 Ishlatiladigan kurs: ${currentRate}`);

        if (currentRate === null || currentRate === undefined) {
            console.warn('⚠️ Hech qanday valyuta kursi hali yuklanmagan, konversiya qilib bo\'lmaydi');
            return;
        }

        if (fromCurrency === 'usd') {
            const usdValue = parseFloat(usdInput.value) || 0;
            
            // Tan narx validatsiyasi va xatoliklarni tozalash
            const isValid = validateSalePrice(usdValue, currentTabId);
            if (isValid) {
                // Agar narx to'g'ri bo'lsa, xatoliklarni tozalash
                clearPriceWarnings(currentTabId);
            }
            
            const uzsValue = Math.round(usdValue * currentRate);
            uzsInput.value = uzsValue;
            console.log(`💰 USD→UZS: $${usdValue} → ${uzsValue} UZS (kurs: ${currentRate})`);
        } else if (fromCurrency === 'uzs') {
            const uzsValue = parseFloat(uzsInput.value) || 0;
            const usdValue = (uzsValue / currentRate).toFixed(2);
            
            // Tan narx validatsiyasi USD qiymati uchun va xatoliklarni tozalash
            const isValid = validateSalePrice(parseFloat(usdValue), currentTabId);
            if (isValid) {
                // Agar narx to'g'ri bo'lsa, xatoliklarni tozalash
                clearPriceWarnings(currentTabId);
            }
            
            usdInput.value = usdValue;
            console.log(`💰 UZS→USD: ${uzsValue} UZS → $${usdValue} (kurs: ${currentRate})`);
        }
    }

    // Sotish narxini tan narx bilan solishtirish
    function validateSalePrice(salePriceUSD, tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId || !tabs[currentTabId] || !tabs[currentTabId].selectedProduct) {
            return true; // Mahsulot tanlanmagan bo'lsa validatsiya o'tkazilmaydi
        }
        
        const product = tabs[currentTabId].selectedProduct;
        const costPrice = parseFloat(product.cost_price) || 0;
        
        if (salePriceUSD < costPrice) {
            // Faqat xatolik xabarini ko'rsatish, narxni o'zgartirmaslik
            showPriceWarning(salePriceUSD, costPrice, currentTabId);
            
            console.warn(`🚫 Bu narxda sotib bo'lmaydi! Kiritilgan narx: $${salePriceUSD}, Minimal narx: $${costPrice}`);
            return false;
        }
        
        return true;
    }

    // Narx ogohlantirish xabarini ko'rsatish
    function showPriceWarning(salePrice, costPrice, tabId) {
        const currentTabId = tabId || activeTabId;
        
        // Input maydonlarni qizil rangga o'zgartirish
        const usdInput = document.getElementById(`priceUSD-${currentTabId}`);
        const uzsInput = document.getElementById(`priceUZS-${currentTabId}`);
        
        // Edit modalda bo'lsa
        const editPriceInput = document.getElementById('editPrice');
        
        // Maydonlarni qizil rangga o'zgartirish
        if (usdInput) {
            usdInput.style.border = '2px solid #ff4757';
            usdInput.style.backgroundColor = '#ffebee';
        }
        if (uzsInput) {
            uzsInput.style.border = '2px solid #ff4757';
            uzsInput.style.backgroundColor = '#ffebee';
        }
        if (editPriceInput) {
            editPriceInput.style.border = '2px solid #ff4757';
            editPriceInput.style.backgroundColor = '#ffebee';
        }
        
        // Avvalgi ogohlantirishlarni olib tashlash
        const existingWarnings = document.querySelectorAll('.price-warning-inline');
        existingWarnings.forEach(warning => warning.remove());
        
        // Maydon tagida xatolik xabari yaratish
        const targetInput = editPriceInput || usdInput;
        if (targetInput) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'price-warning-inline';
            warningDiv.style.cssText = `
                color: #dc3545;
                font-size: 13px;
                margin-top: 4px;
                font-weight: 600;
                animation: fadeIn 0.3s ease-out;
            `;
            
            warningDiv.innerHTML = `
                <span>❌Bu narxda sotib bo'lmaydi!</span>
            `;
            
            // Input maydondan keyin qo'shish
            targetInput.parentNode.appendChild(warningDiv);
            
            // 10 soniyadan keyin xatolikni olib tashlash (agar hali ham mavjud bo'lsa)
            setTimeout(() => {
                if (warningDiv && warningDiv.parentNode) {
                    warningDiv.remove();
                }
                // Maydon rangini qaytarish (faqat hali ham qizil bo'lsa)
                if (usdInput && usdInput.style.border.includes('#ff4757')) {
                    usdInput.style.border = '';
                    usdInput.style.backgroundColor = '';
                }
                if (uzsInput && uzsInput.style.border.includes('#ff4757')) {
                    uzsInput.style.border = '';
                    uzsInput.style.backgroundColor = '';
                }
                if (editPriceInput && editPriceInput.style.border.includes('#ff4757')) {
                    editPriceInput.style.border = '';
                    editPriceInput.style.backgroundColor = '';
                }
            }, 10000);
        }
    }

    // Har qanday tab uchun narx validatsiyasini faollashtirish
    function enablePriceValidationForTab(tabId) {
        const currentTabId = tabId || activeTabId;
        const usdInput = document.getElementById(`priceUSD-${currentTabId}`);
        const uzsInput = document.getElementById(`priceUZS-${currentTabId}`);
        
        console.log(`🔧 ${currentTabId} tab uchun narx validatsiyasi faollashtirilmoqda...`);
        
        if (usdInput && !usdInput.hasCustomValidation) {
            usdInput.hasCustomValidation = true;
            usdInput.addEventListener('input', function() {
                const tabData = tabs[currentTabId];
                if (!tabData) return;
                
                const inputPrice = parseFloat(this.value) || 0;
                let costPrice = 0;
                
                // Cost price ni topish: selectedProduct yoki cart itemlardan
                if (tabData.selectedProduct && tabData.selectedProduct.cost_price) {
                    costPrice = parseFloat(tabData.selectedProduct.cost_price) || 0;
                    console.log('💰 Cost price selectedProduct dan:', costPrice);
                } else if (tabData.isEditMode && tabData.cart && tabData.cart.length > 0) {
                    // Tahrirlash rejimida cart itemlardan cost_price topish
                    const firstItem = tabData.cart[0];
                    costPrice = parseFloat(firstItem.cost_price) || 0;
                    console.log('� Cost price cart dan (tahrirlash rejimi):', costPrice);
                }
                
                console.log('�🔄 Global USD validatsiya:', {
                    inputPrice: inputPrice,
                    costPrice: costPrice,
                    comparison: inputPrice < costPrice,
                    isEditMode: tabData.isEditMode
                });
                
                setTimeout(() => {
                    if (inputPrice < costPrice && costPrice > 0 && inputPrice > 0) {
                        showPriceWarning(inputPrice, costPrice, currentTabId);
                    } else {
                        clearPriceWarnings(currentTabId);
                    }
                }, 250);
            });
        }
        
        if (uzsInput && !uzsInput.hasCustomValidation) {
            uzsInput.hasCustomValidation = true;
            uzsInput.addEventListener('input', function() {
                const tabData = tabs[currentTabId];
                if (!tabData) return;
                
                const currentRate = window.USD_TO_UZS_RATE || USD_TO_UZS_RATE || 12500;
                const inputUZS = parseFloat(this.value) || 0;
                const inputPriceUSD = inputUZS / currentRate;
                let costPrice = 0;
                
                // Cost price ni topish: selectedProduct yoki cart itemlardan
                if (tabData.selectedProduct && tabData.selectedProduct.cost_price) {
                    costPrice = parseFloat(tabData.selectedProduct.cost_price) || 0;
                    console.log('💰 Cost price selectedProduct dan:', costPrice);
                } else if (tabData.isEditMode && tabData.cart && tabData.cart.length > 0) {
                    // Tahrirlash rejimida cart itemlardan cost_price topish
                    const firstItem = tabData.cart[0];
                    costPrice = parseFloat(firstItem.cost_price) || 0;
                    console.log('� Cost price cart dan (tahrirlash rejimi):', costPrice);
                }
                
                console.log('�🔄 Global UZS validatsiya:', {
                    inputUZS: inputUZS,
                    inputPriceUSD: inputPriceUSD,
                    costPrice: costPrice,
                    comparison: inputPriceUSD < costPrice,
                    isEditMode: tabData.isEditMode
                });
                
                setTimeout(() => {
                    if (inputPriceUSD < costPrice && costPrice > 0 && inputUZS > 0) {
                        showPriceWarning(inputPriceUSD, costPrice, currentTabId);
                    } else {
                        clearPriceWarnings(currentTabId);
                    }
                }, 250);
            });
        }
    }

    // Narx ogohlantirishlarini tozalash
    function clearPriceWarnings(tabId) {
        const currentTabId = tabId || activeTabId;
        
        // Inline ogohlantirishlarni olib tashlash
        const existingWarnings = document.querySelectorAll('.price-warning-inline');
        existingWarnings.forEach(warning => warning.remove());
        
        // Input maydonlarning rangini qaytarish
        const usdInput = document.getElementById(`priceUSD-${currentTabId}`);
        const uzsInput = document.getElementById(`priceUZS-${currentTabId}`);
        const editPriceInput = document.getElementById('editPrice');
        
        if (usdInput) {
            usdInput.style.border = '';
            usdInput.style.backgroundColor = '';
        }
        if (uzsInput) {
            uzsInput.style.border = '';
            uzsInput.style.backgroundColor = '';
        }
        if (editPriceInput) {
            editPriceInput.style.border = '';
            editPriceInput.style.backgroundColor = '';
        }
    }

    // Tanlangan mahsulotni korzinaga qo'shish yoki tahrirlash
    // Mahsulotni korzinaga qo'shish (HTML onclick uchun wrapper)
    function addSelectedProduct(tabId) {
        addSelectedProductAsync(tabId);
    }

    async function addSelectedProductAsync(tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) {
            console.error('addSelectedProduct: Tab ID topilmadi');
            return;
        }
        
        const tabData = tabs[currentTabId];
        if (!tabData) {
            console.error(`addSelectedProduct: Tab ma'lumotlari topilmadi (${currentTabId})`);
            return;
        }
        
        // Tab'ning form elementlarini olish
        const quantityInput = document.getElementById(`quantity-${currentTabId}`);
        const priceUSDInput = document.getElementById(`priceUSD-${currentTabId}`);
        
        if (!quantityInput || !priceUSDInput) {
            console.error(`addSelectedProduct: Form elementlari topilmadi (${currentTabId})`);
            return;
        }
        
        // Agar tahrirlash rejimida bo'lsa
        if (tabData.currentEditingItem) {
            const quantityValue = parseInt(quantityInput.value) || 1;
            const customPrice = parseFloat(priceUSDInput.value) || 0;

            if (quantityValue <= 0 || customPrice < 0) {
                alert('Miqdor va narx to\'g\'ri kiritilishi kerak!');
                return;
            }

            // Tan narx validatsiyasi
            if (!validateSalePrice(customPrice, currentTabId)) {
                return;
            }

            // Stock validatsiyasi - stock + joriy cart + asl miqdorni hisobga olish
            const stockQty = tabData.selectedProduct.available_quantity || tabData.selectedProduct.total_stock || 0;
            
            // Tahrirlash rejimida asl miqdorni ham qo'shish
            let maxAllowed = stockQty;
            if (tabData.isEditMode && tabData.originalQuantities && tabData.originalQuantities[tabData.currentEditingItem.id]) {
                const originalQty = tabData.originalQuantities[tabData.currentEditingItem.id] || 0;
                maxAllowed = stockQty + originalQty; // Stock + asl miqdor
                console.log(`📝 Stock validatsiya: Stock=${stockQty} + Asl miqdor=${originalQty} = Max=${maxAllowed}`);
            }
            
            if (quantityValue > maxAllowed) {
                const locationText = tabData.currentEditingItem.location_type === 'warehouse' ? 'omborda' : 'do\'konda';
                alert(`Xato! ${locationText} maksimal ${maxAllowed} ta mahsulot mavjud.`);
                return;
            }

            // Tahrirlash tugallangach mahsulotni korzinaga qayta qo'shish
            const editedItem = {
                id: tabData.currentEditingItem.id,
                name: tabData.currentEditingItem.name,
                price: customPrice,
                quantity: quantityValue,
                location_id: tabData.currentEditingItem.location_id,
                location_type: tabData.currentEditingItem.location_type,
                location: tabData.currentEditingItem.location,
                location_name: tabData.currentEditingItem.location_name,
                cost_price: tabData.currentEditingItem.cost_price || 0,
                originalSaleItemId: tabData.currentEditingItem.originalSaleItemId // Asl SaleItem ID ni saqlash
            };

            // DOIMO stock ayirish - tahrirlash paytida ham
            console.log('💾 Tahrirlash paytida stock ayirish...');
            
            try {
                const success = await deductStock(editedItem.id, quantityValue, editedItem.location_id, editedItem.location_type);
                
                if (success) {
                    // Stock muvaffaqiyatli ayirildi, korzinaga tepaga qo'shish
                    tabData.cart.unshift(editedItem);
                    console.log(`✅ Tahrirlangan mahsulot korzinaga qayta qo'shildi (tepaga): ${editedItem.name} (${quantityValue} ta)`);

                    // Cart ni yangilash
                    updateCart(currentTabId);
                    
                    // Form ni tozalash va tahrirlash rejimini yakunlash
                    clearProductForm(currentTabId);
                    tabData.currentEditingItem = null;

                    // Avtomatik pending savdo yangilash
                    autoSavePendingSale(currentTabId);

                    showAlert('✅ Mahsulot muvaffaqiyatli yangilandi va korzinaga qayta qo\'shildi!', 'success');
                } else {
                    console.log('❌ Stock ayirib bo\'lmadi - tahrirlash bekor qilindi');
                    showAlert('❌ Stock yetarli emas, tahrirlash bekor qilindi!', 'error');
                }
            } catch (error) {
                console.error('❌ Tahrirlashda stock ayirishda xatolik:', error);
                showAlert('❌ Tahrirlashda xatolik yuz berdi!', 'error');
            }
            return;
        }

        // Oddiy qo'shish rejimi - agar tahrirlash rejimida bo'lmasa
        if (!tabData.selectedProduct && !tabData.currentEditingItem) {
            alert('Iltimos, avval mahsulot tanlang!');
            return;
        }

        // Agar oddiy qo'shish rejimida bo'lsa
        if (!tabData.currentEditingItem) {
            // Joylashuv ma'lumotlarini tekshirish
            if (!tabData.selectedProduct.location_id || !tabData.selectedProduct.location_type) {
                alert('❌ Xatolik: Mahsulot uchun joylashuv ma\'lumoti yo\'q. Iltimos, avval joylashuv tanlang!');
                console.error('🚨 Joylashuv ma\'lumoti yo\'q:', tabData.selectedProduct);
                return;
            }
        }

        const quantity = parseInt(quantityInput.value) || 1;
        const customPrice = parseFloat(priceUSDInput.value) || tabData.selectedProduct.price || 0;
        const availableQty = tabData.selectedProduct.available_quantity || tabData.selectedProduct.total_stock || 0;

        if (quantity <= 0) {
            alert('Miqdor 1 dan kam bo\'lmasligi kerak!');
            return;
        }

        // Tan narx validatsiyasi
        if (!validateSalePrice(customPrice, currentTabId)) {
            return;
        }

        // Oddiy qo'shish rejimi uchun stock tekshiruvi
        if (quantity > availableQty) {
            const locationText = tabData.selectedProduct.location_type === 'warehouse' ? 'omborda' : 'do\'konda';
            alert(`Xato! ${locationText} faqat ${availableQty} ta mahsulot mavjud.`);
            return;
        }

        // Maksimal miqdor tekshiruvi - faqat oddiy qo'shish rejimida
        let existingItem = tabData.cart.find(item => item.id === tabData.selectedProduct.id);
        const currentCartQuantity = existingItem ? existingItem.quantity : 0;
        const totalQuantity = currentCartQuantity + quantity;
        
        if (totalQuantity > availableQty) {
            const locationText = tabData.selectedProduct.location_type === 'warehouse' ? 'omborda' : 'do\'konda';
            const currentInfo = currentCartQuantity > 0 ? ` Korzinada allaqachon ${currentCartQuantity} ta bor.` : '';
            alert(`Xato! ${locationText} maksimal ${availableQty} ta mahsulot mavjud.${currentInfo}`);
            return;
        }
        
        // DOIMO stock ayirish 
        console.log('💾 Stock ayirish boshlandi...');
        console.log('🔍 Stock ayirish sababi: Korzinaga qo\'shish (darhol stockdan ayirish)');
        
        try {
            const success = await deductStock(tabData.selectedProduct.id, quantity, tabData.selectedProduct.location_id, tabData.selectedProduct.location_type);
            
            console.log(`📊 DeductStock natijasi: success = ${success}`);
            
            if (success) {
                // Stock muvaffaqiyatli ayirildi, korzinaga qo'shish
                console.log('✅ Stock ayirildi, korzinaga qo\'shish...');
                addToCartDirectly(tabData.selectedProduct, quantity, customPrice, currentTabId, true);
            } else {
                // Stock ayira olmadi
                console.log('❌ Stock ayirib bo\'lmadi');
            }
        } catch (error) {
            console.error('❌ Stock ayirishda xatolik:', error);
            showAlert('❌ Stock ayirishda xatolik yuz berdi!', 'error');
            // Xatolik bo'lsa ham formni tozalash
            clearProductForm(currentTabId);
        }
    }

    // Korzinaga to'g'ridan-to'g'ri qo'shish funksiyasi
    function addToCartDirectly(selectedProduct, quantity, customPrice, tabId, isReserved = false) {
        console.log(`📦 addToCartDirectly chaqirildi:`, {
            product_id: selectedProduct.id,
            product_name: selectedProduct.name,
            quantity: quantity,
            customPrice: customPrice,
            isReserved: isReserved,
            location_id: selectedProduct.location_id,
            location_type: selectedProduct.location_type
        });
        
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) return;
        
        const tabData = tabs[currentTabId];
        
        // Maksimal miqdor tekshiruvi - tahrirlash rejimida ham
        const availableQty = selectedProduct.available_quantity || selectedProduct.total_stock || 0;
        let existingItem = tabData.cart.find(item => item.id === selectedProduct.id);
        const currentCartQuantity = existingItem ? existingItem.quantity : 0;
        const totalQuantity = currentCartQuantity + quantity;
        
        console.log(`🔍 AddToCartDirectly - Debug ma'lumotlar:`);
        console.log(`   selectedProduct.id: ${selectedProduct.id}`);
        console.log(`   availableQty: ${availableQty}`);
        console.log(`   currentCartQuantity: ${currentCartQuantity}`);
        console.log(`   quantity: ${quantity}`);
        console.log(`   totalQuantity: ${totalQuantity}`);
        console.log(`   tabData.isEditMode: ${tabData.isEditMode}`);
        console.log(`   originalQuantities:`, tabData.originalQuantities);
        
        // Tahrirlash rejimida maksimal miqdor hisoblash - TO'G'RI MANTIQ
        let maxAllowedQty = availableQty;
        if (tabData.isEditMode && tabData.originalQuantities && tabData.originalQuantities[selectedProduct.id]) {
            // Tahrirlash rejimida: faqat hozirgi stock, asl miqdorni qo'shmaslik
            // Chunki availableQty allaqachon asl savdo stockini hisobga olgan
            maxAllowedQty = availableQty; 
            console.log(`📝 AddToCartDirectly - Tahrirlash rejimi: Max=${availableQty} (faqat hozirgi stock)`);
        } else {
            console.log(`⚠️ AddToCartDirectly - Tahrirlash rejimi emas yoki originalQuantities[${selectedProduct.id}] topilmadi`);
        }
        
        console.log(`🎯 Final check: ${totalQuantity} > ${maxAllowedQty} = ${totalQuantity > maxAllowedQty}`);
        
        if (totalQuantity > maxAllowedQty) {
            const locationText = selectedProduct.location_type === 'warehouse' ? 'omborda' : 'do\'konda';
            const currentInfo = currentCartQuantity > 0 ? ` Korzinada allaqachon ${currentCartQuantity} ta bor.` : '';
            alert(`Xato! ${locationText} maksimal ${maxAllowedQty} ta mahsulot mavjud.${currentInfo}`);
            return;
        }
        if (!tabData) return;
        
        existingItem = tabData.cart.find(item => item.id === selectedProduct.id);
        if (existingItem) {
            existingItem.quantity += quantity;
            existingItem.price = customPrice; // Yangi narxni o'rnatish
        } else {
            console.log('🆕 Yangi mahsulot qo\'shish:', {
                selectedProduct_id: selectedProduct.id,
                selectedProduct_name: selectedProduct.name,
                selectedProduct: selectedProduct
            });
            
            console.log('💾 Korzinaga qo\'shilayotgan mahsulot:', {
                selectedProduct_cost_price: selectedProduct.cost_price,
                will_save_cost_price: selectedProduct.cost_price || 0
            });
            
            // Yangi mahsulotni tepaga qo'shish (unshift ishlatib)
            tabData.cart.unshift({
                id: selectedProduct.id,
                name: selectedProduct.name,
                price: customPrice,
                quantity: quantity,
                location_id: selectedProduct.location_id,
                location_type: selectedProduct.location_type,
                location: selectedProduct.location_type === 'warehouse' ? 'Ombor' : 'Do\'kon',
                location_name: selectedProduct.location_name || 'Noma\'lum',
                cost_price: selectedProduct.cost_price || 0  // Tan narxni ham saqlash
            });
            
            // Tahrirlash rejimida yangi mahsulot uchun asl miqdor 0
            if (tabData.isEditMode && tabData.editingSaleId) {
                tabData.originalQuantities[selectedProduct.id] = 0;
                console.log(`📝 Tahrirlash rejimida yangi mahsulot: asl miqdor 0 qo'yildi`);
            }
        }

        // Mavjud stock miqdorini yangilash (faqat stock rezerv qilingan bo'lsa)
        if (isReserved) {
            if (selectedProduct.available_quantity !== undefined) {
                selectedProduct.available_quantity -= quantity;
            }
            if (selectedProduct.total_stock !== undefined) {
                selectedProduct.total_stock -= quantity;
            }
        }

        updateCart(currentTabId);
        
        const message = isReserved ? 
            '✅ Mahsulot korzinaga qo\'shildi va stock rezerv qilindi!' : 
            '📝 Mahsulot korzinaga yuklandi (tahrirlash rejimi)';
        showAlert(message, 'success');

        // Avtomatik tasdiqlanmagan savdolarga saqlash
        autoSavePendingSale(currentTabId);

        // Formni tozalash
        clearProductForm(currentTabId);
    }

    function clearProductForm(tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) return;
        
        const tabData = tabs[currentTabId];
        if (!tabData) return;
        
        // Faqat mahsulot ma'lumotlarini tozalash (mijoz va joylashuvni saqlab qolish)
        const productSearch = document.getElementById(`productSearch-${currentTabId}`);
        const quantity = document.getElementById(`quantity-${currentTabId}`);
        const availableQuantity = document.getElementById(`availableQuantity-${currentTabId}`);
        const priceUSD = document.getElementById(`priceUSD-${currentTabId}`);
        const priceUZS = document.getElementById(`priceUZS-${currentTabId}`);
        
        if (productSearch) productSearch.value = '';
        if (quantity) quantity.value = '';
        if (availableQuantity) availableQuantity.value = '0';
        if (priceUSD) priceUSD.value = '';
        if (priceUZS) priceUZS.value = '';
        
        tabData.selectedProduct = null;
        tabData.currentEditingItem = null; // Tahrirlash rejimini tozalash
        
        // Barcha maydonlarni faollashtirish
        const locationSelect = document.getElementById(`locationSelect-${currentTabId}`);
        const customerSearch = document.getElementById(`customerSearch-${currentTabId}`);
        
        if (locationSelect) locationSelect.disabled = false;
        if (customerSearch) customerSearch.disabled = false;
        if (productSearch) productSearch.disabled = false;
        
        // Tugma matnini tiklash
        const addButtonIcon = document.getElementById(`addButtonIcon-${currentTabId}`);
        const addButtonText = document.getElementById(`addButtonText-${currentTabId}`);
        
        if (addButtonIcon) addButtonIcon.textContent = '➕';
        if (addButtonText) addButtonText.textContent = 'Savdo korzinasiga qo\'shish';
        
        // Mahsulot tanlash maydoniga fokus berish
        if (productSearch) productSearch.focus();
    }

    // Joylashuv nomini olish funksiyasi
    function getLocationName(locationType, locationId) {
        if (locationType === 'store') {
            const store = allStores.find(s => s.id == locationId);
            return store ? store.name : 'Noma\'lum do\'kon';
        } else if (locationType === 'warehouse') {
            const warehouse = allWarehouses.find(w => w.id == locationId);
            return warehouse ? warehouse.name : 'Noma\'lum ombor';
        }
        return 'Noma\'lum joylashuv';
    }



    // Korzinani yangilash
    function updateCart(tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) return;
        
        const tabData = tabs[currentTabId];
        if (!tabData) return;
        
        const cartList = document.getElementById(`cartList-${currentTabId}`);
        const emptyCart = document.getElementById(`emptyCart-${currentTabId}`);
        const cartTotal = document.getElementById(`cartTotal-${currentTabId}`);
        const actionButtons = document.getElementById(`actionButtons-${currentTabId}`);
        const cartTitle = document.getElementById(`cartTitle-${currentTabId}`);

        if (!cartList || !emptyCart) return;

        // Korzina sarlavhasini mijoz ma'lumotlari bilan yangilash
        let titleText = 'Savdo ro\'yxati';
        const selectedCustomerIdEl = document.getElementById(`selectedCustomerId-${currentTabId}`);
        const customerSearchEl = document.getElementById(`customerSearch-${currentTabId}`);
        
        if (selectedCustomerIdEl && customerSearchEl && selectedCustomerIdEl.value) {
            const customerName = customerSearchEl.value;
            titleText = `Savdo ro'yxati - ${customerName}`;
        }
        
        if (cartTitle) {
            cartTitle.textContent = titleText;
        }

        // Qidiruv konteynerini boshqarish
        const cartSearchContainer = document.getElementById(`cartSearchContainer-${currentTabId}`);
        
        if (tabData.cart.length === 0) {
            emptyCart.style.display = 'block';
            cartList.style.display = 'none';
            if (cartTotal) cartTotal.style.display = 'none';
            if (actionButtons) actionButtons.style.display = 'none';
            if (cartSearchContainer) cartSearchContainer.style.display = 'none';
            return;
        }

        emptyCart.style.display = 'none';
        cartList.style.display = 'block';
        if (cartTotal) cartTotal.style.display = 'block';
        if (actionButtons) actionButtons.style.display = 'flex';
        if (cartSearchContainer) cartSearchContainer.style.display = 'block';

        let cartHtml = '';
        let totalAmount = 0;

        tabData.cart.forEach(item => {
            console.log('🛒 Rendering cart item:', item);
            console.log('📍 Item location_name:', item.location_name);
            console.log('📍 Item location:', item.location);
            console.log('📍 Original location_name:', JSON.stringify(item.location_name));
            
            // Xavfsiz qiymatlar bilan hisoblash
            const safePrice = parseFloat(item.price) || 0;
            const safeQuantity = parseInt(item.quantity) || 0;
            const itemTotal = safePrice * safeQuantity;
            
            totalAmount += itemTotal;

            // Oddiy jadval qatori - modal orqali tahrirlash
            cartHtml += `
                <tr id="item-${item.id}">
                    <td>
                        <span class="location-type-badge">${item.location || 'Store'}</span>
                        <br><small style="color: #6c757d;">${(() => {
                            const original = item.location_name || 'Noma\'lum';
                            // Dublikat so'zlarni olib tashlash va tozalash
                            const cleaned = original
                                .replace(/(Store|Warehouse|Ombor|Do'kon|Dokon|dokan)[\s:\-]*/gi, '') // Dokon so'zini qo'shdik
                                .replace(/(\w+)\s+\1/gi, '$1') // Dublikat so'zlarni olib tashlash
                                .replace(/\s+/g, ' ') // Ko'p bo'shliqlarni bitta qilish
                                .trim();
                            console.log('🔧 Location cleaning:', original, '->', cleaned);
                            return cleaned || 'Noma\'lum';
                        })()}</small>
                    </td>
                    <td>
                        <strong>${item.name || 'Noma\'lum'}</strong>
                    </td>
                    <td>
                        <input type="number" class="qty-input" value="${safeQuantity}" onchange="setQuantity(${item.id}, this.value, '${currentTabId}')" min="1" style="width: 60px; text-align: center;">
                    </td>
                    <td>${formatPrice(safePrice)}</td>
                    <td><strong>${formatPrice(itemTotal)}</strong></td>
                    <td>
                        <div class="action-buttons-group">
                            <button class="remove-btn" onclick="confirmRemoveFromCart(${item.id}, '${currentTabId}')" title="O'chirish">×</button>
                            <button class="edit-btn" onclick="confirmStartProductEdit(${item.id}, '${currentTabId}')" title="Tahrirlash">✏️</button>
                        </div>
                    </td>
                </tr>
            `;
        });

        const cartTableBody = document.getElementById(`cartTableBody-${currentTabId}`);
        const mobileCart = document.getElementById(`mobileCart-${currentTabId}`);
        const totalItems = document.getElementById(`totalItems-${currentTabId}`);
        const totalAmountEl = document.getElementById(`totalAmount-${currentTabId}`);
        
        // Desktop table yangilash
        if (cartTableBody) cartTableBody.innerHTML = cartHtml;
        
        // Mobile cart yangilash
        if (mobileCart) {
            let mobileCartHtml = '';
            tabData.cart.forEach(item => {
                const safePrice = parseFloat(item.price) || 0;
                const safeQuantity = parseInt(item.quantity) || 0;
                const itemTotal = safePrice * safeQuantity;
                
                const locationName = (() => {
                    const original = item.location_name || 'Noma\'lum';
                    // Tozalash algoritmi
                    const cleaned = original
                        .replace(/(Store|Warehouse|Ombor|Do'kon|Dokon|dokan)[\s:\-]*/gi, '') // Dokon so'zini qo'shdik
                        .replace(/(\w+)\s+\1/gi, '$1') // Dublikat so'zlarni olib tashlash
                        .replace(/\s+/g, ' ') // Ko'p bo'shliqlarni bitta qilish
                        .trim();
                    
                    // Agar tozalashdan keyin bo'sh qolsa, asl nomni qaytarish
                    return cleaned || original || 'Noma\'lum';
                })();
                
                mobileCartHtml += `
                    <div class="mobile-cart-item" id="mobile-item-${item.id}">
                        <div class="item-header">
                            <span class="product-name">${item.name || 'Noma\'lum'}</span>
                            <button class="remove-btn" onclick="confirmRemoveFromCart(${item.id}, '${currentTabId}')" title="O'chirish">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        
                        <div class="item-details">
                            <div class="detail-item">
                                <span class="detail-label">📍 Joylashuv:</span>
                                <span class="detail-value">${item.location || 'Store'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">🏪 Joy nomi:</span>
                                <span class="detail-value">${locationName}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">💰 Narxi:</span>
                                <span class="detail-value">${formatPrice(safePrice)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">💵 Jami:</span>
                                <span class="detail-value total-price">${formatPrice(itemTotal)}</span>
                            </div>
                        </div>
                        
                        <div class="item-actions">
                            <div class="qty-controls">
                                <button class="qty-btn" onclick="adjustQuantity(${item.id}, -1, '${currentTabId}')">-</button>
                                <input type="number" class="qty-input" value="${safeQuantity}" 
                                       onchange="setQuantity(${item.id}, this.value, '${currentTabId}')" 
                                       min="1">
                                <button class="qty-btn" onclick="adjustQuantity(${item.id}, 1, '${currentTabId}')">+</button>
                            </div>
                            <button class="edit-btn" onclick="confirmStartProductEdit(${item.id}, '${currentTabId}')" title="Tahrirlash">
                                <i class="fas fa-edit"></i> Tahrirlash
                            </button>
                        </div>
                    </div>
                `;
            });
            mobileCart.innerHTML = mobileCartHtml;
        }
        
        // Mahsulot turlari soni (cart.length - necha xil mahsulot)
        if (totalItems) totalItems.textContent = tabData.cart.length;
        if (totalAmountEl) totalAmountEl.innerHTML = formatPrice(totalAmount);
    }

    // Miqdorni o'rnatish (HTML onchange uchun wrapper)
    function setQuantity(productId, newQuantity, tabId) {
        setQuantityAsync(productId, newQuantity, tabId);
    }

    // Miqdorni o'rnatish
    async function setQuantityAsync(productId, newQuantity, tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) return;
        
        const tabData = tabs[currentTabId];
        if (!tabData) return;
        
        const quantity = parseInt(newQuantity);
        if (quantity <= 0) {
            removeFromCart(productId, currentTabId);
            return;
        }

        const item = tabData.cart.find(item => item.id === productId);
        if (item) {
            const oldQuantity = item.quantity;
            
            console.log(`🔄 Miqdor o'zgartirish: ${item.name} (Product ID: ${productId})`);
            console.log(`   Hozirgi: ${oldQuantity}, Yangi: ${quantity}`);
            
            // Tahrirlash yuklanayotganda stock operatsiyalarini skip qilish
            if (tabData.isLoadingEditData) {
                console.log(`⏸️ Tahrirlash yuklanmoqda - stock operatsiyalari skip qilindi`);
                item.quantity = quantity; // Faqat miqdorni yangilash
                updateCart(currentTabId);
                return;
            }
            
            // ✅ TO'LIQ ALMASHTIRISH MANTIQ:
            // 1️⃣ Avval hozirgi miqdorni to'liq stokga qaytarish
            console.log(`↩️ Qadam 1: Hozirgi ${oldQuantity} ta stokga qaytarilmoqda...`);
            const returnSuccess = await returnStock(item.id, oldQuantity, item.location_id, item.location_type);
            
            if (!returnSuccess) {
                console.log(`❌ Stock qaytarib bo'lmadi`);
                return;
            }
            console.log(`✅ ${oldQuantity} ta stock qaytarildi`);
            
            // 2️⃣ Keyin yangi miqdorni to'liq stokdan rezerv qilish
            console.log(`🔒 Qadam 2: Yangi ${quantity} ta stokdan rezerv qilinmoqda...`);
            const reserveSuccess = await reserveStock(item.id, quantity, item.location_id, item.location_type);
            
            if (!reserveSuccess) {
                console.log(`❌ Stock rezerv qilib bo'lmadi`);
                // Rollback: eski miqdorni qaytadan rezerv qilish
                await reserveStock(item.id, oldQuantity, item.location_id, item.location_type);
                return;
            }
            console.log(`✅ ${quantity} ta stock rezerv qilindi`);
            
            // 3️⃣ Miqdorni yangilash
            item.quantity = quantity;
            console.log(`✅ Korzinada yangilandi: ${oldQuantity} → ${quantity}`);
            
            updateCart(currentTabId);
            // Auto save qo'shish
            autoSavePendingSale(currentTabId);
        }
    }

    // Mobile cart uchun miqdorni o'zgartirish
    function adjustQuantity(productId, change, tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) return;
        
        const tabData = tabs[currentTabId];
        if (!tabData) return;
        
        const item = tabData.cart.find(item => item.id === productId);
        if (!item) return;
        
        const newQuantity = parseInt(item.quantity) + parseInt(change);
        if (newQuantity <= 0) {
            removeFromCart(productId, currentTabId);
            return;
        }
        
        setQuantityAsync(productId, newQuantity, currentTabId);
    }



    // Korzina elementini tahrirlash - Card-based interface
    function editCartItem(productId, tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) return;
        
        const tabData = tabs[currentTabId];
        if (!tabData) return;
        
        const item = tabData.cart.find(item => item.id === productId);
        if (!item) return;

        // Xavfsiz qiymatlar
        const safePrice = parseFloat(item.price) || 0;
        const safeQuantity = parseInt(item.quantity) || 1;
        const itemTotal = safePrice * safeQuantity;

        // Location badge class
        const locationClass = item.location_type === 'warehouse' ? 'warehouse' : 'store';
        const locationIcon = item.location_type === 'warehouse' ? '🏭' : '🏪';

        // Edit card HTML
        const editCardHTML = `
            <div class="edit-card-overlay" id="editCardOverlay" onclick="closeEditCard(event)">
                <div class="edit-card" data-product-id="${productId}" onclick="event.stopPropagation()">
                    <div class="edit-card-header">
                        <h3>📝 Mahsulotni Tahrirlash</h3>
                        <button class="edit-card-close" onclick="closeEditCard()">&times;</button>
                    </div>
                    <div class="edit-card-body">
                        <div class="edit-form-group">
                            <label>Mahsulot nomi</label>
                            <input type="text" class="edit-form-control edit-readonly" value="${item.name || 'Noma\'lum'}" readonly>
                        </div>
                        
                        <div class="edit-form-group">
                            <label>Joylashuv</label>
                            <div class="edit-location-badge ${locationClass}">
                                ${locationIcon} ${item.location_name || 'Noma\'lum joylashuv'}
                            </div>
                        </div>
                        
                        <div class="edit-form-group">
                            <label for="editQuantity">Miqdori</label>
                            <input type="number" id="editQuantity" class="edit-form-control" value="${safeQuantity}" min="1" oninput="updateEditTotal()">
                        </div>
                        
                        <div class="edit-form-group">
                            <label for="editPrice">Birlik narxi ($)</label>
                            <input type="number" id="editPrice" class="edit-form-control" value="${safePrice.toFixed(2)}" min="0" step="0.01" oninput="updateEditTotal()" onblur="clearPriceWarnings()">
                        </div>
                        
                        <div class="edit-price-display">
                            <div class="edit-price-row">
                                <span>Miqdor:</span>
                                <span id="displayQuantity">${safeQuantity}</span>
                            </div>
                            <div class="edit-price-row">
                                <span>Birlik narxi:</span>
                                <span id="displayPrice">${formatPrice(safePrice)}</span>
                            </div>
                            <div class="edit-price-row">
                                <span>Jami summa:</span>
                                <span id="displayTotal">${formatPrice(itemTotal)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="edit-card-footer">
                        <button class="edit-btn-cancel" onclick="closeEditCard()">❌ Bekor qilish</button>
                        <button class="edit-btn-save" onclick="saveEditedItem(${productId})">✅ Saqlash</button>
                    </div>
                </div>
            </div>
        `;

        // Card ni sahifaga qo'shish
        document.body.insertAdjacentHTML('beforeend', editCardHTML);
        
        // Miqdor maydoniga fokus berish
        setTimeout(() => {
            const quantityInput = document.getElementById('editQuantity');
            if (quantityInput) {
                quantityInput.focus();
                quantityInput.select(); // Mavjud qiymatni tanlash
            }
        }, 100);
    }

    // Edit card ni yopish
    function closeEditCard(event) {
        if (event && event.target !== event.currentTarget) return;
        
        const overlay = document.getElementById('editCardOverlay');
        if (overlay) {
            overlay.remove();
        }
    }

    // Edit card da jami summani yangilash
    function updateEditTotal() {
        const quantity = parseInt(document.getElementById('editQuantity').value) || 0;
        const price = parseFloat(document.getElementById('editPrice').value) || 0;
        
        // Edit modalda tan narx validatsiyasi
        const modal = document.querySelector('.edit-card');
        if (modal && document.getElementById('editCardOverlay')) {
            const productId = modal.dataset.productId;
            const currentTabId = activeTabId;
            
            if (currentTabId && tabs[currentTabId] && productId) {
                // Tahrirlayotgan mahsulotni topish
                const product = tabs[currentTabId].cart.find(item => item.id == productId);
                if (product && product.cost_price !== undefined) {
                    const costPrice = parseFloat(product.cost_price) || 0;
                    
                    if (price < costPrice && price > 0) {
                        // Faqat xatolik xabarini ko'rsatish, narxni o'zgartirmaslik
                        showPriceWarning(price, costPrice, currentTabId);
                    } else if (price >= costPrice) {
                        // Agar narx to'g'ri bo'lsa, xatoliklarni tozalash
                        clearPriceWarnings(currentTabId);
                    }
                }
            }
        }
        
        const total = quantity * price;

        document.getElementById('displayQuantity').textContent = quantity;
        document.getElementById('displayPrice').innerHTML = formatPrice(price);
        document.getElementById('displayTotal').innerHTML = formatPrice(total);
    }

    // Edit card da tahrirlangan mahsulotni saqlash
    async function saveEditedItem(productId) {
        const currentTabId = activeTabId;
        if (!currentTabId) return;
        
        const tabData = tabs[currentTabId];
        if (!tabData) return;
        
        // Yangi qiymatlarni olish
        const newQuantity = parseInt(document.getElementById('editQuantity').value) || 0;
        const newPrice = parseFloat(document.getElementById('editPrice').value) || 0;
        
        // Validatsiya
        if (newQuantity <= 0) {
            alert('Miqdor 0 dan katta bo\'lishi kerak!');
            return;
        }
        
        if (newPrice <= 0) {
            alert('Narx 0 dan katta bo\'lishi kerak!');
            return;
        }
        
        // Mahsulotni topish
        const item = tabData.cart.find(item => item.id === productId);
        if (!item) {
            alert('Mahsulot topilmadi!');
            closeEditCard();
            return;
        }
        
        // Tan narx tekshiruvi
        const costPrice = parseFloat(item.cost_price) || 0;
        if (newPrice < costPrice && costPrice > 0) {
            if (!confirm(`Diqqat! Sotish narxi ($${newPrice}) tan narxidan ($${costPrice}) past. Davom etasizmi?`)) {
                return;
            }
        }
        
        // Narxni yangilash (faqat narx o'zgardi)
        if (item.price !== newPrice) {
            item.price = newPrice;
            console.log(`💲 Narx yangilandi: ${item.name} - $${newPrice}`);
        }
        
        // Miqdorni yangilash (agar o'zgardi bo'lsa)
        if (item.quantity !== newQuantity) {
            const oldQuantity = item.quantity;
            console.log(`📝 Edit card: Miqdorni to'liq almashtirish ${oldQuantity} → ${newQuantity}`);
            
            // 1️⃣ Avval hozirgi miqdorni TO'LIQ stokga qaytarish
            console.log(`↩️ Qadam 1: Hozirgi ${oldQuantity} ta stokga qaytarilmoqda...`);
            const returnSuccess = await returnStock(item.id, oldQuantity, item.location_id, item.location_type);
            
            if (!returnSuccess) {
                console.log(`❌ Stock qaytarib bo'lmadi`);
                alert('Stock qaytarishda xatolik yuz berdi!');
                closeEditCard();
                return;
            }
            console.log(`✅ ${oldQuantity} ta stock qaytarildi`);
            
            // 2️⃣ Keyin yangi miqdorni TO'LIQ stokdan rezerv qilish
            console.log(`🔒 Qadam 2: Yangi ${newQuantity} ta stokdan rezerv qilinmoqda...`);
            const reserveSuccess = await reserveStock(item.id, newQuantity, item.location_id, item.location_type);
            
            if (!reserveSuccess) {
                console.log(`❌ Stock rezerv qilib bo'lmadi`);
                // Eski miqdorni qaytadan rezerv qilish (rollback)
                await reserveStock(item.id, oldQuantity, item.location_id, item.location_type);
                alert('Stock rezerv qilishda xatolik yuz berdi!');
                closeEditCard();
                return;
            }
            console.log(`✅ ${newQuantity} ta stock rezerv qilindi`);
            
            // 3️⃣ Miqdorni yangilash
            item.quantity = newQuantity;
            console.log(`✅ Korzinada yangilandi: ${oldQuantity} → ${newQuantity}`);
        } else {
            // Faqat narx o'zgardi, korzinani yangilash
            console.log(`📊 Faqat narx o'zgardi, miqdor bir xil: ${item.quantity}`);
            updateCart(currentTabId);
            autoSavePendingSale(currentTabId);
        }
        
        // Korzinani yangilash
        updateCart(currentTabId);
        autoSavePendingSale(currentTabId);
        
        // Edit card ni yopish
        closeEditCard();
        
        showAlert('Mahsulot muvaffaqiyatli yangilandi!', 'success');
    }



    // Success notification ko'rsatish
    function showSuccessNotification(message) {
        const notification = document.createElement('div');
        notification.innerHTML = `
            <div style="
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                z-index: 2000;
                font-weight: 500;
                animation: slideIn 0.3s ease-out;
            ">
                ${message}
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // 3 soniya keyin o'chirish
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }, 3000);
    }

    // Tasdiqlash bilan o'chirish funksiyasi (HTML onclick uchun wrapper)
    function confirmRemoveFromCart(productId, tabId) {
        confirmRemoveFromCartAsync(productId, tabId);
    }

    // Tasdiqlash bilan o'chirish funksiyasi (async)
    async function confirmRemoveFromCartAsync(productId, tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) return false;
        
        const tabData = tabs[currentTabId];
        if (!tabData) return false;
        
        const itemToConfirm = tabData.cart.find(item => item.id === productId);
        if (itemToConfirm) {
            const confirmMessage = `"${itemToConfirm.name}" mahsulotini korzinadan o'chirishni tasdiqlaysizmi?`;
            if (confirm(confirmMessage)) {
                await removeFromCart(productId, tabId);
            }
        }
    }

    // Korzinadan olib tashlash
    async function removeFromCart(productId, tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) return false;
        
        const tabData = tabs[currentTabId];
        if (!tabData) return false;
        
        console.log('removeFromCart chaqirildi, productId:', productId);
        console.log('O\'chirishdan oldin cart:', tabData.cart);
        
        // O'chiriladigan mahsulot ma'lumotlarini topish
        const itemToRemove = tabData.cart.find(item => item.id === productId);
        let stockReturnSuccess = false;
        
        if (itemToRemove) {
            const originalQuantity = tabData.originalQuantities[productId] || 0;
            const currentQuantity = itemToRemove.quantity;
            
            console.log(`🗑️ Mahsulot o'chirilmoqda: ${itemToRemove.name}`);
            console.log(`   isEditMode: ${tabData.isEditMode}`);
            console.log(`   currentEditingItem: ${tabData.currentEditingItem ? 'MAVJUD' : 'YO\'Q'}`);
            console.log(`   editingSaleId: ${tabData.editingSaleId}`);
            console.log(`   editingSaleStatus: ${tabData.editingSaleStatus}`);
            console.log(`   originalQuantities:`, tabData.originalQuantities);
            console.log(`   Asl miqdor: ${originalQuantity}, Joriy: ${currentQuantity}`);
            
            
            // Tahrirlash yuklanayotganda stock operatsiyalarini skip qilish
            if (tabData.isLoadingEditData) {
                console.log('Tahrirlash yuklanmoqda - stock qaytarish skip qilindi');
                stockReturnSuccess = true; // Skip qilindi deb belgilash
            } else {
                // ODDIY MANTIQ: Har doim stock qaytarish
                // Korzinadan olib tashlanganda har doim stock qaytariladi
                console.log('Mahsulot korzinadan olib tashlanmoqda - stock qaytarish:', currentQuantity, 'ta');
                
                try {
                    stockReturnSuccess = await addStock(
                        itemToRemove.id,
                        currentQuantity,
                        itemToRemove.location_id,
                        itemToRemove.location_type
                    );
                    
                    if (stockReturnSuccess) {
                        console.log('Stock muvaffaqiyatli qaytarildi:', currentQuantity, 'ta');
                        showAlert('Mahsulot uchun ' + currentQuantity + ' ta stock qaytarildi!', 'success');
                    } else {
                        console.log('Stock qaytarishda muammo');
                    }
                } catch (error) {
                    console.error('Stock qaytarishda xatolik:', error);
                    stockReturnSuccess = false;
                }
            }

            delete tabData.originalQuantities[productId];
        }
        
        tabData.cart = tabData.cart.filter(item => item.id !== productId);
        console.log('O\'chirishdan keyin cart:', tabData.cart);
        updateCart(currentTabId);
        
        // Avtomatik pending savdo yangilash
        autoSavePendingSale(currentTabId);
        
        // Stock qaytarish natijasini qaytarish
        return stockReturnSuccess;
    }

    // Korzinani tozalash
    function clearCart() {
        if (confirm('Haqiqatan ham korzinani tozalamoqchimisiz?')) {
            // Savdo holatiga qarab stock qaytarish
            const returnPromises = cart.map(item => {
                const originalQuantity = originalQuantities[item.id] || 0;
                
                if (editingSaleStatus === 'pending') {
                    // TASDIQLANMAGAN SAVDO: To'liq miqdorni qaytarish
                    console.log(`📝 ${item.name}: tasdiqlanmagan savdo - to'liq ${item.quantity} ta qaytariladi`);
                    return returnStock(item.id, item.quantity, item.location_id, item.location_type);
                } else {
                    // TASDIQLANGAN SAVDO yoki oddiy rejim: Faqat qo'shimcha stockni qaytarish
                    const stockToReturn = item.quantity - originalQuantity;
                    
                    if (stockToReturn > 0) {
                        console.log(`💰 ${item.name}: asl ${originalQuantity}, joriy ${item.quantity}, qaytarish ${stockToReturn}`);
                        return returnStock(item.id, stockToReturn, item.location_id, item.location_type);
                    } else {
                        console.log(`⏭️ ${item.name}: qaytarish shart emas (${stockToReturn})`);
                        return Promise.resolve(true);
                    }
                }
            });
            
            Promise.all(returnPromises).then(() => {
                const message = editingSaleStatus === 'pending' 
                    ? '↩️ Barcha stocklar to\'liq qaytarildi (tasdiqlanmagan savdo)!'
                    : '↩️ Barcha qo\'shimcha stocklar qaytarildi!';
                console.log(message);
                showAlert(message, 'success');
            }).catch(error => {
                console.error('❌ Stocklarni qaytarishda xatolik:', error);
                showAlert('❌ Ba\'zi stocklarni qaytarishda xatolik!', 'error');
            });
            
            // Pending savdoni o'chirish
            if (currentPendingSaleId) {
                deletePendingSale(currentPendingSaleId);
                currentPendingSaleId = null;
            }
            
            cart = [];
            originalQuantities = {}; // Asl miqdorlarni tozalash
            updateCart();
            updateCartTitle(); // Sarlavhani standart holatga qaytarish
        }
    }

    // Savdoni yakunlash
    // Savdoni yakunlash (HTML onclick uchun wrapper)
    function completeSale(tabId) {
        completeSaleAsync(tabId);
    }

    async function completeSaleAsync(tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) return;
        
        const tabData = tabs[currentTabId];
        if (!tabData) return;
        
        if (tabData.cart.length === 0) {
            alert('Korzina bo\'sh! Avval mahsulot tanlang.');
            return;
        }

        const selectedCustomerIdEl = document.getElementById(`selectedCustomerId-${currentTabId}`);
        const selectedCustomerNameEl = document.getElementById(`customerSearch-${currentTabId}`);
        
        const selectedCustomerId = selectedCustomerIdEl ? selectedCustomerIdEl.value : '';
        const selectedCustomerName = selectedCustomerNameEl ? selectedCustomerNameEl.value : '';
        const totalAmount = tabData.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        
        let confirmMessage = `Jami summa: $${totalAmount.toFixed(2)}\n`;
        if (selectedCustomerId) {
            confirmMessage += `Mijoz: ${selectedCustomerName}\n`;
        }
        confirmMessage += '\nSavdoni yakunlamoqchimisiz?';
        
        if (confirm(confirmMessage)) {
            try {
                // Debug: Korzina ma'lumotlarini console da ko'rsatish
                console.log('🛒 Korzina ma\'lumotlari:', tabData.cart);
                
                // Har bir mahsulot o'z joylashuvi bilan tekshirish
                for (const item of tabData.cart) {
                    if (!item.location_id || !item.location_type) {
                        alert(`❌ Mahsulot "${item.name}" uchun joylashuv ma'lumoti yo'q!`);
                        return;
                    }
                }

                // Edit mode tekshiruvi
                if (tabData.isEditMode) {
                    if (tabData.editingSaleStatus === 'paid') {
                        // Savdo tarixidagi tasdiqlangan savdolarni yangilash
                        console.log('🔄 Tasdiqlangan savdoni yangilash (updateSale)');
                        updateSale(currentTabId);
                        return;
                    } else if (tabData.editingSaleStatus === 'pending') {
                        // Tasdiqlanmagan savdolarni tahrirlashda yangi tasdiqlangan savdo yaratish
                        console.log('🆕 Tasdiqlanmagan savdoni tasdiqlash (create-sale)');
                        // Davom etadi - create-sale API'ga boradi
                    }
                }
                
                // Savdo ma'lumotlarini serverga yuborish (har mahsulot o'z joylashuvi bilan)
                const saleData = {
                    customer_id: selectedCustomerId || null,
                    items: tabData.cart, // Har item da location_id va location_type bor
                    total_amount: totalAmount,
                    payment_status: 'paid', // Tasdiqlangan savdo
                    multi_location: true, // Backend ga signal berish
                    is_edit_mode: tabData.isEditMode || false, // Tahrirlash rejimi
                    original_sale_id: tabData.editingSaleId || null // Asl savdo ID'si
                };
                
                console.log('📤 Serverga yuborilayotgan ma\'lumot:', saleData);
                
                const response = await fetch('/api/create-sale', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(saleData)
                });
                
                const result = await response.json();
                console.log('📥 Serverdan kelgan javob:', result);
                
                if (result.success) {
                    alert('✅ Savdo muvaffaqiyatli yakunlandi!');
                    
                    // Pending savdoni tozalash (agar mavjud bo'lsa)
                    if (tabData.currentPendingSaleId) {
                        console.log(`🗑️ Yakunlangan savdo uchun pending savdoni o'chirish: ${tabData.currentPendingSaleId}`);
                        await deletePendingSale(tabData.currentPendingSaleId);
                        tabData.currentPendingSaleId = null;
                    }
                    
                    // Yangi yaratilgan savdoni ham pending dan o'chirish (agar server javobida ID bo'lsa)
                    if (result.sale_id || result.id) {
                        const newSaleId = result.sale_id || result.id;
                        console.log(`🗑️ Yangi tasdiqlangan savdoni pending dan o'chirish: ${newSaleId}`);
                        await deletePendingSale(newSaleId);
                    }
                    
                    // Edit mode'ni tozalash
                    isEditMode = false;
                    editingSaleId = null;
                    originalQuantities = {}; // Asl miqdorlarni tozalash
                    originalSaleProcessed = false; // Flag'ni reset qilish
                    editingSaleStatus = null; // Savdo holatini tozalash
                    
                    // Formni tozalash
                    cart = [];
                    updateCart();
                    
                    // Mijoz ma'lumotlarini tozalash (xavfsiz usul)
                    const customerSearchEl = document.getElementById(`customerSearch-${currentTabId}`);
                    const selectedCustomerIdEl = document.getElementById(`selectedCustomerId-${currentTabId}`);
                    
                    if (customerSearchEl) customerSearchEl.value = '';
                    if (selectedCustomerIdEl) selectedCustomerIdEl.value = '';
                    
                    // Tab ma'lumotlaridan mijoz ma'lumotlarini tozalash
                    if (tabs[currentTabId]) {
                        tabs[currentTabId].selectedCustomer = null;
                    }
                    
                    // Tab nomini yangilash
                    updateTabTitle(currentTabId);
                    
                    // Tab'ni yopish
                    setTimeout(() => {
                        closeTab(currentTabId);
                    }, 1000);
                } else {
                    alert('❌ Xatolik: ' + (result.error || 'Noma\'lum xatolik'));
                }
            } catch (error) {
                console.error('Error creating sale:', error);
                alert('❌ Tarmoq xatoligi: ' + error.message);
            }
        }
    }

    // Savdoni keyinroq tasdiqlash uchun saqlash (HTML onclick uchun wrapper)
    function saveSalePending(tabId) {
        saveSalePendingAsync(tabId);
    }

    // Savdoni keyinroq tasdiqlash uchun saqlash
    async function saveSalePendingAsync(tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) return;
        
        const tabData = tabs[currentTabId];
        if (!tabData) return;
        
        if (tabData.cart.length === 0) {
            alert('Korzina bo\'sh! Avval mahsulot tanlang.');
            return;
        }

        const selectedCustomerIdEl = document.getElementById(`selectedCustomerId-${currentTabId}`);
        const selectedCustomerNameEl = document.getElementById(`customerSearch-${currentTabId}`);
        
        const selectedCustomerId = selectedCustomerIdEl ? selectedCustomerIdEl.value : '';
        const selectedCustomerName = selectedCustomerNameEl ? selectedCustomerNameEl.value : '';
        const totalAmount = tabData.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        
        let confirmMessage = `Jami summa: $${totalAmount.toFixed(2)}\n`;
        if (selectedCustomerId) {
            confirmMessage += `Mijoz: ${selectedCustomerName}\n`;
        }
        
        // Tahrirlash rejimida turli xabar
        if (tabData.isEditMode && tabData.editingSaleId) {
            confirmMessage += '\n⚠️ Diqqat: Asl savdo savdo tarixidan o\'chiriladi va tasdiqlanmagan savdolar ro\'yxatiga o\'tadi.\n';
            confirmMessage += 'Davom etasizmi?';
        } else {
            confirmMessage += '\nSavdo keyinroq tasdiqlash uchun saqlansinmi?';
        }
        
        if (confirm(confirmMessage)) {
            try {
                console.log('⏳ Savdoni pending holatda saqlash...');
                console.log('🛒 Korzina ma\'lumotlari:', tabData.cart);
                
                // Debug: har bir item'ni alohida ko'rsatish
                tabData.cart.forEach((item, index) => {
                    console.log(`📦 Item ${index + 1}:`, {
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                        location_id: item.location_id,
                        location_type: item.location_type
                    });
                });
                
                // Har bir mahsulot o'z joylashuvi bilan tekshirish
                let allItemsValid = true;
                for (const item of tabData.cart) {
                    if (!item.location_id || !item.location_type) {
                        alert(`❌ ${item.name} mahsuloti uchun joylaşhuv belgilanmagan!`);
                        allItemsValid = false;
                        break;
                    }
                }
                
                if (!allItemsValid) {
                    return;
                }

                const saleData = {
                    customer_id: selectedCustomerId || null,
                    items: tabData.cart.map(item => ({
                        product_id: item.id,
                        quantity: item.quantity,
                        unit_price: item.price,
                        location_id: item.location_id,
                        location_type: item.location_type,
                        original_quantity: tabData.originalQuantities[item.id] || 0 // Asl miqdorni qo'shish
                    })),
                    payment_method: 'cash',
                    payment_status: 'pending', // Keyinroq tasdiqlash uchun pending holat
                    notes: tabData.isEditMode ? `Tahrirlangan savdo (asl ID: ${tabData.editingSaleId}) - keyinroq tasdiqlash uchun` : 'Keyinroq tasdiqlash uchun saqlangan savdo',
                    multi_location: true, // Multi-location rejimida ishlash
                    is_edit_mode: tabData.isEditMode || false, // Tahrirlash rejimi
                    original_sale_id: (tabData.isEditMode && tabData.editingSaleId && !tabData.originalSaleProcessed) ? tabData.editingSaleId : null, // Asl savdo ID'si faqat bir marta
                    skip_stock_return: true, // Stock allaqachon rezerv qilingan, qaytarmaslik
                    original_quantities: tabData.originalQuantities // Barcha asl miqdorlarni yuborish
                };

                console.log('📤 Yuborilayotgan ma\'lumotlar:', saleData);

                const response = await fetch('/api/create-sale', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(saleData)
                });

                const result = await response.json();
                console.log('📥 Server javobi:', result);

                if (result.success) {
                    // Asl savdo qayta ishlangani belgilash
                    if (tabData.isEditMode && tabData.editingSaleId && !tabData.originalSaleProcessed) {
                        tabData.originalSaleProcessed = true;
                        console.log('✅ Asl savdo qayta ishlandi, flag o\'rnatildi');
                    }
                    
                    if (tabData.isEditMode && tabData.editingSaleId) {
                        alert('✅ Savdo tasdiqlanmagan savdolar ro\'yxatiga o\'tkazildi!\n\n' +
                              'Asl savdo savdo tarixidan o\'chirildi va stock qaytarildi.');
                    } else {
                        alert('✅ Savdo keyinroq tasdiqlash uchun saqlandi!\n\n' +
                              'Siz uni "Tasdiqlanmagan savdolar" bo\'limida topishingiz mumkin.');
                    }
                    
                    // Pending savdoni tozalash (chunki yangi pending savdo yaratildi)
                    if (tabData.currentPendingSaleId && tabData.currentPendingSaleId !== result.sale_id) {
                        console.log(`🔄 Eski pending savdoni yangi bilan almashtirish: ${tabData.currentPendingSaleId} → ${result.sale_id}`);
                        await deletePendingSale(tabData.currentPendingSaleId);
                    }
                    tabData.currentPendingSaleId = null;
                    
                    // Edit mode'ni tozalash
                    tabData.isEditMode = false;
                    tabData.editingSaleId = null;
                    tabData.originalQuantities = {}; // Asl miqdorlarni tozalash
                    tabData.originalSaleProcessed = false; // Flag'ni reset qilish
                    tabData.editingSaleStatus = null; // Savdo holatini tozalash
                    
                    // Korzinani tozalash
                    tabData.cart = [];
                    updateCart(currentTabId);
                    
                    // Tasdiqlanmagan savdolar sahifasiga o'tish
                    if (confirm('Tasdiqlanmagan savdolar ro\'yxatini ko\'rmoqchimisiz?')) {
                        window.location.href = '/pending-sales';
                    }
                } else {
                    alert('❌ Xatolik: ' + (result.error || 'Noma\'lum xatolik'));
                }
            } catch (error) {
                console.error('Error saving pending sale:', error);
                alert('❌ Tarmoq xatoligi: ' + error.message);
            }
        }
    }

    // Completed sale'dan pending sale yaratish
    async function createPendingSaleFromCompletedSale(tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) return;
        
        const tabData = tabs[currentTabId];
        if (!tabData || !tabData.editingSaleId) return;
        
        try {
            console.log(`🔄 Completed sale ${tabData.editingSaleId}'dan pending sale yaratish...`);
            
            // Pending sale yaratish
            const pendingData = {
                customer_id: tabData.selectedCustomerId || null,
                items: tabData.cart.map(item => ({
                    product_id: item.id,
                    quantity: item.quantity,
                    unit_price: item.price,
                    location_id: item.location_id,
                    location_type: item.location_type
                })),
                notes: `Savdo tarixidan tahrirlash - Original Sale ID: ${tabData.editingSaleId}`,
                original_sale_id: tabData.editingSaleId // Asl savdo ID'sini saqlash
            };
            
            const response = await fetch('/api/pending-sales', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(pendingData)
            });
            
            const result = await response.json();
            if (response.ok && result.success) {
                tabData.currentPendingSaleId = result.sale_id;
                // Status'ni pending'ga o'zgartirish - avtomatik saqlash uchun
                tabData.editingSaleStatus = 'pending';
                console.log(`✅ Birinchi o'zgarishda pending sale yaratildi: ID = ${result.sale_id}`);
                showNotification('✅ O\'zgarishlar tasdiqlanmagan savdoga ko\'chirildi - avtomatik saqlash faollashtirildi!', 'success');
                return true;
            } else {
                throw new Error(result.error || 'Pending sale yaratishda xatolik');
            }
        } catch (error) {
            console.error('❌ Pending sale yaratishda xatolik:', error);
            showNotification('⚠️ Avtomatik saqlash ishga tushmadi, lekin tahrirlash davom etadi', 'warning');
            return false;
        }
    }

    // Avtomatik tasdiqlanmagan savdolarga saqlash (har mahsulot qo'shilganda)
    async function autoSavePendingSale(tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) return;
        
        const tabData = tabs[currentTabId];
        if (!tabData) return;
        
        // Completed sale tahrirlashda birinchi marta pending sale yaratish
        if (tabData.isEditMode && tabData.editingSaleId && tabData.editingSaleStatus === 'paid' && !tabData.currentPendingSaleId) {
            console.log('🔄 Completed sale tahrirlashda birinchi o\'zgarish - pending sale yaratiladi');
            await createPendingSaleFromCompletedSale(currentTabId);
            // Agar pending sale yaratilmasa, auto save qilmaslik
            if (tabData.editingSaleStatus !== 'pending') {
                console.log('⏭️ Pending sale yaratilmadi - auto save o\'tkazib yuborildi');
                return;
            }
        }
        
        // Savdo tarixidagi savdoni tahrirlashda auto save qilmaslik (pending sale yaratilmaganida)
        if (tabData.isEditMode && tabData.editingSaleId && tabData.editingSaleStatus !== 'pending') {
            console.log('⏭️ Savdo tarixini tahrirlash rejimi - auto save o\'tkazib yuborildi');
            return;
        }
        
        // Agar korzina bo'sh bo'lsa, mavjud pending savdoni o'chirish
        if (tabData.cart.length === 0) {
            if (tabData.currentPendingSaleId) {
                console.log('🗑️ Korzina bo\'sh, pending savdoni o\'chirish...');
                await deletePendingSale(tabData.currentPendingSaleId, currentTabId);
                tabData.currentPendingSaleId = null;
            }
            return;
        }

        // Agar allaqachon saqlash jarayonida bo'lsa, kutish
        if (tabData.isAutoSaving) {
            console.log('⏳ Auto save jarayonida, kutmoqda...');
            return;
        }

        // Debounce - 1 soniyadan keyin saqlash
        if (tabData.autoSaveTimeout) {
            clearTimeout(tabData.autoSaveTimeout);
        }
        
        console.log('💾 Auto save rejalashtirildi (1 soniyadan keyin)');
        tabData.autoSaveTimeout = setTimeout(async () => {
            await performAutoSave(currentTabId);
        }, 1000);
    }

    async function performAutoSave(tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) return;
        
        const tabData = tabs[currentTabId];
        if (!tabData) return;
        
        if (tabData.isAutoSaving) return;
        
        try {
            tabData.isAutoSaving = true;
            const selectedCustomerIdEl = document.getElementById(`selectedCustomerId-${currentTabId}`);
            const selectedCustomerId = selectedCustomerIdEl ? selectedCustomerIdEl.value : '';
            const totalAmount = tabData.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            console.log('💾 Avtomatik pending savdo saqlash...');
            console.log('🛒 Korzina:', tabData.cart);
            console.log('📝 Edit mode:', tabData.isEditMode);
            console.log('🆔 Current Pending Sale ID:', tabData.currentPendingSaleId);
            console.log('🔢 Editing Sale ID:', tabData.editingSaleId);

            // Har bir item uchun joylashuv ma'lumotlarini tekshirish
            for (const item of tabData.cart) {
                if (!item.location_id || !item.location_type) {
                    console.warn('⚠️ Mahsulot uchun joylashuv ma\'lumoti yo\'q:', item);
                    return;
                }
            }

            // Savdo ma'lumotlarini tayyorlash
            // MUHIM: Pending sale backend'da stock ayirmaydi, faqat ma'lumotlarni saqlaydi
            // Stock allaqachon frontend'da rezerv qilingan va pending sale tasdiqlanganda asl stockga ayiriladi
            const saleData = {
                customer_id: selectedCustomerId || null,
                items: tabData.cart,
                total_amount: totalAmount,
                multi_location: true,
                payment_status: 'pending',
                notes: tabData.isEditMode ? 'Tasdiqlanmagan savdo tahrirlash rejimi' : 'Avtomatik saqlangan savdo',
                // original_sale_id faqat manual save'da yuborish, auto-save'da emas
                pending_sale_id: tabData.currentPendingSaleId // Yangilash uchun
            };

            let endpoint = '/api/pending-sales';
            let method = 'POST';

            // Agar mavjud pending savdo bo'lsa, uni yangilash
            if (tabData.currentPendingSaleId) {
                endpoint = `/api/pending-sales/${tabData.currentPendingSaleId}`;
                method = 'PUT';
                console.log(`🔄 Mavjud pending savdo yangilanmoqda: ${tabData.currentPendingSaleId}`);
            } else {
                console.log('🆕 Yangi pending savdo yaratilmoqda...');
            }

            const response = await fetch(endpoint, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(saleData)
            });

            console.log(`📡 API Response Status: ${response.status} ${response.statusText}`);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`❌ API Response Error: ${errorText}`);
                throw new Error(`API xatoligi: ${response.status} ${response.statusText}`);
            }

            const result = await response.json();
            console.log(`📥 API Response Data:`, result);
            
            if (result.success) {
                if (!tabData.currentPendingSaleId && result.sale_id) {
                    tabData.currentPendingSaleId = result.sale_id;
                    console.log(`✅ Yangi pending savdo yaratildi: ${tabData.currentPendingSaleId}`);
                } else {
                    console.log(`✅ Pending savdo yangilandi: ${tabData.currentPendingSaleId}`);
                }
            } else {
                console.warn('❌ Avtomatik saqlashda xatolik:', result.error);
                // Agar yangilashda xatolik bo'lsa, qaytadan yaratishga harakat qilish
                if (tabData.currentPendingSaleId && method === 'PUT') {
                    console.log('🔄 Qaytadan yaratishga harakat qilish...');
                    tabData.currentPendingSaleId = null;
                    await performAutoSave(currentTabId);
                }
            }
        } catch (error) {
            console.error('❌ Avtomatik saqlash xatoligi:', error);
            // Xatolik bo'lsa, ID ni tozalash
            tabData.currentPendingSaleId = null;
        } finally {
            tabData.isAutoSaving = false;
        }
    }

    // Pending savdoni o'chirish funksiyasi
    async function deletePendingSale(saleId, tabId = null) {
        try {
            const response = await fetch(`/api/pending-sales/${saleId}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            if (result.success) {
                console.log(`🗑️ Pending savdo o'chirildi: ${saleId}`);
                
                // Agar tabId berilgan bo'lsa, korzinani tozalash va stock qaytarish
                if (tabId) {
                    const tabData = tabs[tabId];
                    if (tabData && tabData.cart.length > 0) {
                        console.log(`📦 Pending savdo o'chirildi, korzina stocklarini qaytarish...`);
                        
                        // Barcha korzina mahsulotlarini stockga qaytarish
                        const returnPromises = tabData.cart.map(async item => {
                            try {
                                const success = await addStock(
                                    item.id,
                                    item.quantity,
                                    item.location_id,
                                    item.location_type
                                );
                                console.log(`${success ? '✅' : '❌'} Stock qaytarish: ${item.name} - ${item.quantity} ta`);
                                return success;
                            } catch (error) {
                                console.error(`❌ Stock qaytarishda xatolik (${item.name}):`, error);
                                return false;
                            }
                        });
                        
                        await Promise.all(returnPromises);
                        
                        // Korzinani tozalash
                        tabData.cart = [];
                        tabData.currentPendingSaleId = null;
                        updateCart(tabId);
                        
                        showAlert('📦 Pending savdo bekor qilindi, barcha stocklar qaytarildi!', 'success');
                    }
                }
            }
        } catch (error) {
            console.error('❌ Pending savdoni o\'chirishda xatolik:', error);
        }
    }

    // URL parametrini tekshirish va edit mode ni aniqlash
    function checkEditMode() {
        console.log(`🔍 CHECKEDITMODE CHAQIRILDI: URL = ${window.location.href}`);
        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('edit');
        const editGroupIds = urlParams.get('edit_group');
        console.log(`🔍 URL parametrlari: editId=${editId}, editGroupIds=${editGroupIds}`);
        
        if (editId) {
            isEditMode = true;
            editingSaleId = parseInt(editId);
            
            // Sahifa sarlavhasini o'zgartirish
            document.querySelector('.page-header h1').innerHTML = '✏️ Savdoni Tahrirlash';
            
            // Tugmalarni o'zgartirish (keyinroq loadSaleForEdit'da aniq status bo'yicha o'zgartiriladi)
            const completeSaleBtn = document.querySelector('.btn-success');
            if (completeSaleBtn) {
                // Default: tasdiqlangan savdo tahrirlash
                completeSaleBtn.innerHTML = '✅ Savdoni Yangilash';
                completeSaleBtn.setAttribute('onclick', 'updateSale()');
            }
            
            console.log(`📝 Edit mode debug: isEditMode=${isEditMode}, editingSaleId=${editingSaleId}`);
            
            // Savdo ma'lumotlarini yuklash - yangi tab ochib
            const newTabId = addNewSaleTab();
            loadSaleForEdit(editId, newTabId);
        } else if (editGroupIds) {
            // Savdo guruhini tahrirlash (yangi structure - bitta Sale ID)
            isEditMode = true;
            editingSaleId = parseInt(editGroupIds); // Bitta Sale ID
            
            // Sahifa sarlavhasini o'zgartirish
            document.querySelector('.page-header h1').innerHTML = `✏️ Savdoni Tahrirlash`;
            
            // Tugmalarni o'zgartirish (keyinroq loadSaleForEdit'da aniq status bo'yicha o'zgartiriladi)
            const completeSaleBtn = document.querySelector('.btn-success');
            if (completeSaleBtn) {
                // Default: tasdiqlangan savdo tahrirlash
                completeSaleBtn.innerHTML = '✅ Savdoni Yangilash';
                completeSaleBtn.setAttribute('onclick', 'updateSale()');
            }
            
            // Savdo ma'lumotlarini yuklash - yangi tab ochib
            const newTabId = addNewSaleTab();
            loadSaleForEdit(editGroupIds, newTabId);
        }
    }

    // Tahrirlash uchun savdo ma'lumotlarini yuklash
    async function loadSaleForEdit(saleId, tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) {
            // Agar tab ID yo'q bo'lsa, yangi tab ochish
            const newTabId = addNewSaleTab();
            return loadSaleForEdit(saleId, newTabId);
        }
        
        const tabData = tabs[currentTabId];
        if (!tabData) return;
        
        try {
            console.log(`� LOADSFALEFOREDIT CHAQIRILDI: saleId=${saleId}, tabId=${currentTabId}`);
            console.log(`�🔍 Loading sale ${saleId} for editing...`);
            tabData.isLoadingEditData = true; // Tahrirlash ma'lumotlari yuklanayotganini belgilash
            
            // Tab uchun tahrirlash rejimini o'rnatish
            tabData.isEditMode = true;
            tabData.editingSaleId = parseInt(saleId);
            
            const response = await fetch(`/api/sales/${saleId}`);
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Savdo ma\'lumotlarini yuklab bo\'lmadi');
            }
            
            // API javobini to'g'ri formatda olish
            const saleData = result.success && result.sale ? result.sale : result.data || result;
            
            console.log('📥 Tahrirlash uchun yuklangan savdo:', saleData);
            console.log('📦 Savdo itemlari:', saleData.items);
            if (saleData.items && saleData.items.length > 0) {
                console.log('🔍 Birinchi item ma\'lumotlari:', saleData.items[0]);
                console.log('💰 Birinchi item cost_price:', saleData.items[0].cost_price);
            }
            
            // Mijozni tanlash - ma'lumotlar yuklashni kutish
            if (saleData.customer_id) {
                // Agar allCustomers hali yuklanmagan bo'lsa, kutamiz
                if (allCustomers.length === 0) {
                    console.log('⏳ Mijozlar ro\'yxati yuklanishini kutmoqda...');
                    // Mijozlar yuklanishini kutish uchun kichik timeout
                    setTimeout(() => {
                        const customer = allCustomers.find(c => c.id === saleData.customer_id);
                        if (customer) {
                            const customerSearch = document.getElementById(`customerSearch-${currentTabId}`);
                            const selectedCustomerId = document.getElementById(`selectedCustomerId-${currentTabId}`);
                            
                            if (customerSearch) customerSearch.value = `${customer.name} - ${customer.phone || 'N/A'}`;
                            if (selectedCustomerId) selectedCustomerId.value = customer.id;
                            
                            // Tab ma'lumotlariga mijozni saqlash
                            tabData.selectedCustomer = customer;
                            
                            updateCartTitle(customer, currentTabId);
                            updateTabTitle(currentTabId);
                            console.log('✅ Mijoz o\'rnatildi:', customer.name);
                        }
                    }, 1000);
                } else {
                    const customer = allCustomers.find(c => c.id === saleData.customer_id);
                    if (customer) {
                        const customerSearch = document.getElementById(`customerSearch-${currentTabId}`);
                        const selectedCustomerId = document.getElementById(`selectedCustomerId-${currentTabId}`);
                        
                        if (customerSearch) customerSearch.value = `${customer.name} - ${customer.phone || 'N/A'}`;
                        if (selectedCustomerId) selectedCustomerId.value = customer.id;
                        
                        // Tab ma'lumotlariga mijozni saqlash
                        tabData.selectedCustomer = customer;
                        
                        updateCartTitle(customer, currentTabId);
                        updateTabTitle(currentTabId);
                        console.log('✅ Mijoz o\'rnatildi:', customer.name);
                    }
                }
            }
            
            // Yangi structure: Sale'da items array mavjud
            tabData.cart = [];
            tabData.originalQuantities = {}; // Asl miqdorlarni reset qilish
            const items = saleData.items || [];
            
            items.forEach(item => {
                console.log('🔍 Processing item:', item);
                
                // Location name ni backend dan olish (item.location_name field)
                let locationName = 'Noma\'lum joylashuv';
                if (item.location_name) {
                    locationName = item.location_name;
                    console.log('✅ Using backend location_name:', locationName);
                } else if (item.source_type === 'warehouse') {
                    locationName = `Ombor (ID: ${item.source_id})`;
                    console.log('⚠️ Fallback warehouse name:', locationName);
                } else {
                    locationName = `Do'kon (ID: ${item.source_id})`;
                    console.log('⚠️ Fallback store name:', locationName);
                }
                
                const cartItem = {
                    id: item.product_id || 0,
                    name: item.product_name || 'Noma\'lum mahsulot',
                    price: parseFloat(item.unit_price) || 0,
                    quantity: parseInt(item.quantity) || 1,
                    location_id: item.source_id || saleData.store_id || 1,
                    location_type: item.source_type || 'store',
                    location: item.source_type === 'warehouse' ? 'Ombor' : 'Do\'kon',
                    location_name: locationName,
                    originalSaleItemId: item.id, // SaleItem ID sini saqlash
                    cost_price: item.cost_price || 0 // Tan narxni ham saqlash
                };
                
                // Asl miqdorni saqlash (tahrirlash uchun)
                tabData.originalQuantities[item.product_id] = parseInt(item.quantity) || 1;
                
                console.log(`📝 Asl miqdor saqlandi: item.product_id=${item.product_id}, cartItem.id=${cartItem.id}, quantity=${parseInt(item.quantity) || 1}`);
                console.log('📦 Adding cart item:', cartItem);
                tabData.cart.unshift(cartItem);
            });
            
            updateCart(currentTabId);
            
            // Savdo holatini saqlash
            tabData.editingSaleStatus = saleData.payment_status;
            console.log(`📊 Tahrirlangan savdo holati: ${tabData.editingSaleStatus}`);
            
            // Agar tasdiqlanmagan savdoni tahrirlayotgan bo'lsak, pending sale ID'ni saqlash
            if (saleData.payment_status === 'pending') {
                tabData.currentPendingSaleId = saleData.id;
                console.log(`📝 Tasdiqlanmagan savdo tahrirlash rejimi: Pending Sale ID = ${tabData.currentPendingSaleId}`);
                
                // Tasdiqlanmagan savdo uchun tugma matnini o'zgartirish
                const completeSaleBtn = document.querySelector(`#tab-${currentTabId} .btn-success`);
                if (completeSaleBtn) {
                    completeSaleBtn.innerHTML = '✅ Savdo Qilish';
                    completeSaleBtn.setAttribute('onclick', `completeSale('${currentTabId}')`);
                    console.log('🔄 Tugma matni "Savdo Qilish"ga o\'zgartirildi');
                }
            } else if (saleData.payment_status === 'paid') {
                // Completed sale tahrirlash rejimi - pending sale korzina o'zgarganda yaratiladi
                console.log(`🔄 COMPLETED SALE TAHRIRLASH: payment_status=${saleData.payment_status}`);
                console.log(`⏳ Pending sale korzinada o'zgarish bo'lganda yaratiladi`);
            }
            
            // Success xabari
            showNotification('Savdo ma\'lumotlari yuklandi', 'success');
            
            // Tab fokusini berilgan tabga berish
            console.log(`🎯 Tab fokusini ${currentTabId} ga berish...`);
            switchToTab(currentTabId);
            
        } catch (error) {
            console.error('Error loading sale for edit:', error);
            alert('❌ Xatolik: ' + error.message);
            
            // Edit mode dan chiqish
            window.location.href = '/sales';
        } finally {
            tabData.isLoadingEditData = false; // Flag'ni o'chirish
        }
    }

    // Savdo guruhini tahrirlash uchun ma'lumotlarni yuklash
    async function loadSaleGroupForEdit(saleIds) {
        try {
            console.log(`🔍 Loading sale group [${saleIds.join(', ')}] for editing...`);
            
            // Barcha savdolarni parallel yuklash
            const promises = saleIds.map(id => fetch(`/api/sales/${id}`).then(res => res.json()));
            const results = await Promise.all(promises);
            
            console.log('📥 Tahrirlash uchun yuklangan savdo guruhi:', results);
            
            // Barcha savdolarni cart ga qo'shish
            cart = [];
            let commonCustomerId = null;
            
            for (let i = 0; i < results.length; i++) {
                const result = results[i];
                const saleData = result.success && result.data ? result.data : result;
                
                if (i === 0) {
                    commonCustomerId = saleData.customer_id;
                    
                    // Mijozni tanlash (birinchi savdodan)
                    if (saleData.customer_id && allCustomers.length > 0) {
                        const customer = allCustomers.find(c => c.id === saleData.customer_id);
                        if (customer) {
                            const customerSearchEl = document.getElementById('customerSearch');
                            const selectedCustomerIdEl = document.getElementById('selectedCustomerId');
                            
                            if (customerSearchEl) customerSearchEl.value = `${customer.name} - ${customer.phone || 'N/A'}`;
                            if (selectedCustomerIdEl) selectedCustomerIdEl.value = customer.id;
                        }
                    }
                }
                
                // Har bir mahsulotni cart ga qo'shish - asl joylashuv ma'lumotlari bilan
                cart.unshift({
                    id: saleData.product_id || 0,
                    name: saleData.product_name || 'Noma\'lum mahsulot',
                    price: parseFloat(saleData.unit_price) || 0,
                    quantity: parseInt(saleData.quantity) || 1,
                    location_id: saleData.location_id || saleData.store_id || 1, 
                    location_type: saleData.location_type || 'store',
                    location: saleData.location_type === 'warehouse' ? 'Ombor' : 'Do\'kon',
                    location_name: saleData.location_info || saleData.store_name || 'Noma\'lum',
                    originalSaleId: saleIds[i] // Asl savdo ID sini saqlash
                });
            }
            
            updateCart();
            
            // Success xabari
            showNotification(`${saleIds.length} ta savdo ma'lumoti yuklandi`, 'success');
            
        } catch (error) {
            console.error('Error loading sale group for edit:', error);
            alert('❌ Xatolik: ' + error.message);
            
            // Edit mode dan chiqish
            window.location.href = '/sales';
        }
    }

    // Savdoni yangilash (HTML onclick uchun wrapper)
    function updateSale(tabId) {
        updateSaleAsync(tabId);
    }

    // Savdoni yangilash (yangi structure uchun)
    async function updateSaleAsync(tabId) {
        const currentTabId = tabId || activeTabId;
        if (!currentTabId) return;
        
        const tabData = tabs[currentTabId];
        if (!tabData) return;
        
        console.log(`🔄 UpdateSale boshlandi: tabId=${currentTabId}, editingSaleId=${tabData.editingSaleId}`);
        console.log(`🛒 Korzina ma'lumotlari:`, tabData.cart);
        console.log(`📦 Original quantities:`, tabData.originalQuantities);
        
        if (tabData.cart.length === 0) {
            alert('Korzina bo\'sh! Avval mahsulot tanlang.');
            return;
        }

        const selectedCustomerIdEl = document.getElementById(`selectedCustomerId-${currentTabId}`);
        const selectedCustomerId = selectedCustomerIdEl ? selectedCustomerIdEl.value : '';
        
        // Ko'p mahsulotli savdo uchun ma'lumotlar
        const updateData = {
            customer_id: selectedCustomerId || null,
            items: tabData.cart.map(item => ({
                product_id: item.id,
                quantity: item.quantity,
                unit_price: item.price,
                location_id: item.location_id,
                location_type: item.location_type,
                original_quantity: tabData.originalQuantities[item.id] || 0 // Asl miqdorni qo'shish
            })),
            payment_method: 'cash',
            payment_status: 'paid',
            notes: `Tahrirlangan savdo - ${tabData.cart.length} ta mahsulot`,
            original_quantities: tabData.originalQuantities, // Barcha asl miqdorlarni yuborish
            is_pending_sale_confirmation: true // Tasdiqlanmagan savdoni tasdiqlash
        };
        
        const totalAmount = tabData.cart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
        const confirmMessage = `Savdoni yangilamoqchimisiz?\n\nMahsulotlar: ${tabData.cart.length} ta\nJami summa: $${totalAmount.toFixed(2)}`;
        
        if (confirm(confirmMessage)) {
            try {
                console.log('📤 Savdoni yangilash:', updateData);
                
                console.log(`📡 API chaqiruvi: PUT /api/sales/${tabData.editingSaleId}`);
                const response = await fetch(`/api/sales/${tabData.editingSaleId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData)
                });
                
                console.log(`📡 API Response Status: ${response.status} ${response.statusText}`);
                const result = await response.json();
                console.log('📥 Yangilash javobi:', result);
                
                if (response.ok) {
                    showNotification('Savdo muvaffaqiyatli yangilandi!', 'success');
                    
                    // Pending savdonu tozalash (agar bu pending savdo bo'lsa)
                    if (tabData.currentPendingSaleId) {
                        console.log(`🗑️ Yangilangan savdoni pending dan o'chirish: ${tabData.currentPendingSaleId}`);
                        await deletePendingSale(tabData.currentPendingSaleId);
                        tabData.currentPendingSaleId = null;
                    }
                    
                    // Tab'ni yopish
                    setTimeout(() => {
                        closeTab(currentTabId);
                    }, 1000);
                    
                } else {
                    throw new Error(result.error || 'Noma\'lum xatolik');
                }
            } catch (error) {
                console.error('Error updating sale:', error);
                alert('❌ Xatolik: ' + error.message);
            }
        }
    }

    // Savdo guruhini yangilash
    async function updateSaleGroup() {
        if (cart.length === 0) {
            alert('Korzina bo\'sh! Avval mahsulot tanlang.');
            return;
        }

        const selectedCustomerId = document.getElementById('selectedCustomerId').value;
        
        // Har bir cart item uchun yangilash ma'lumotlarini tayyorlash
        const updatePromises = cart.map(item => {
            const updateData = {
                quantity: item.quantity,
                unit_price: item.price,
                payment_method: 'cash', // Default value, can be made dynamic
                payment_status: 'paid', // Default value, can be made dynamic
                notes: `Tahrirlangan savdo - ${item.name}`
            };
            
            return {
                id: item.originalSaleId,
                data: updateData,
                item: item
            };
        });
        
        const confirmMessage = `Barcha savdolarni yangilamoqchimisiz?\n\n${cart.map(item => 
            `${item.name}: ${item.quantity} x $${item.price.toFixed(2)} = $${(item.quantity * item.price).toFixed(2)}`
        ).join('\n')}\n\nJami: $${cart.reduce((sum, item) => sum + item.quantity * item.price, 0).toFixed(2)}`;
        
        if (confirm(confirmMessage)) {
            try {
                console.log('📤 Savdo guruhini yangilash:', updatePromises);
                
                // Barcha savdolarni parallel yangilash
                const promises = updatePromises.map(update => 
                    fetch(`/api/sales/${update.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(update.data)
                    }).then(res => res.json())
                );
                
                const results = await Promise.all(promises);
                console.log('📥 Yangilash javoblari:', results);
                
                // Barcha natijalarni tekshirish
                const failedUpdates = results.filter(result => !result.success);
                
                if (failedUpdates.length === 0) {
                    showNotification(`${cart.length} ta savdo muvaffaqiyatli yangilandi!`, 'success');
                    
                    // 2 soniya kutib, savdo sahifasiga o'tish
                    setTimeout(() => {
                        window.location.href = '/sales';
                    }, 2000);
                    
                } else {
                    const errorMessages = failedUpdates.map(f => f.error || 'Noma\'lum xatolik').join('\n');
                    throw new Error(`Ba'zi savdolarni yangilashda xatolik:\n${errorMessages}`);
                }
            } catch (error) {
                console.error('Error updating sale group:', error);
                alert('❌ Xatolik: ' + error.message);
            }
        }
    }

    // Notification ko'rsatish
    function showNotification(message, type = 'info') {
        // Notification div yaratish
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div style="
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 9999;
                font-weight: 500;
                max-width: 300px;
            ">
                ${message}
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // 3 soniya keyin o'chirish
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }



    // Oddiy tahrirlash - faqat ma'lumotlarni formaga to'ldirish
    let currentEditingItem = null;

    // Tasdiqlash bilan tahrirlash funksiyasi (HTML onclick uchun wrapper)
    function confirmStartProductEdit(productId, tabId = null) {
        confirmStartProductEditAsync(productId, tabId);
    }

    // Tasdiqlash bilan tahrirlash funksiyasi (async)
    async function confirmStartProductEditAsync(productId, tabId = null) {
        const currentTabId = tabId || activeTabId;
        const tabData = tabs[currentTabId];
        if (!tabData) return;
        
        const item = tabData.cart.find(cartItem => cartItem.id === productId);
        if (item) {
            const confirmMessage = `"${item.name}" mahsulotini tahrirlashni tasdiqlaysizmi?`;
            if (confirm(confirmMessage)) {
                await startProductEdit(productId, tabId);
            }
        }
    }

    async function startProductEdit(productId, tabId = null) {
        const currentTabId = tabId || activeTabId;
        const tabData = tabs[currentTabId];
        if (!tabData) {
            console.error('Tab ma\'lumotlari topilmadi:', currentTabId);
            return;
        }
        
        const item = tabData.cart.find(cartItem => cartItem.id === productId);
        if (!item) {
            console.error('Mahsulot topilmadi:', productId);
            return;
        }

        // Mahsulot ma'lumotlarini oldindan saqlash (korzinadan o'chirishdan oldin)
        const itemCopy = {
            id: item.id,
            name: item.name,
            price: item.price,
            quantity: item.quantity,
            location_id: item.location_id,
            location_type: item.location_type,
            location: item.location,
            location_name: item.location_name,
            cost_price: item.cost_price || 0,
            originalSaleItemId: item.originalSaleItemId
        };
        
        console.log('🔍 Tahrirlashga tayyorlanayotgan mahsulot:', itemCopy);
        
        // MUHIM: Tahrirlash rejimini oldindan o'rnatish (removeFromCart chaqirishdan oldin)
        tabData.currentEditingItem = itemCopy;
        
        // Mahsulotni korzinadan olib tashlash (stock qaytarish bilan)
        console.log(`🗑️ Mahsulotni korzinadan olib tashlash: ${itemCopy.name} (ID: ${productId})`);
        const stockReturned = await removeFromCart(productId, currentTabId);
        if (!stockReturned) {
            console.error(`❌ Stock qaytarishda muammo bo'ldi.`);
            showAlert(`❌ Mahsulotni tahrirlashda xatolik yuz berdi`, 'error');
            return;
        }
        
        console.log(`📝 Tahrirlash rejimi: Form maydonlarini to'ldirish...`);
        
        // Form maydonlarini to'ldirish
        const locationSelect = document.getElementById(`locationSelect-${currentTabId}`);
        const productSearch = document.getElementById(`productSearch-${currentTabId}`);
        const quantity = document.getElementById(`quantity-${currentTabId}`);
        const priceUSD = document.getElementById(`priceUSD-${currentTabId}`);
        const priceUZS = document.getElementById(`priceUZS-${currentTabId}`);
        const customerSearch = document.getElementById(`customerSearch-${currentTabId}`);
        
        // Joylashuvni tanlash
        if (locationSelect) {
            locationSelect.value = `${itemCopy.location_type}_${itemCopy.location_id}`;
            locationSelect.disabled = true;
        }
        
        // Mahsulot nomini to'ldirish
        if (productSearch) {
            productSearch.value = itemCopy.name;
            productSearch.disabled = true;
        }
        
        // Miqdor va narxlarni to'ldirish
        if (quantity) quantity.value = itemCopy.quantity;
        if (priceUSD) priceUSD.value = itemCopy.price;
        
        // UZS narxini hisoblash va to'ldirish
        if (priceUZS && window.USD_TO_UZS_RATE) {
            const uzsPrice = Math.round(itemCopy.price * window.USD_TO_UZS_RATE);
            priceUZS.value = uzsPrice;
        }
        
        // Mijoz maydonini disabled qilish
        if (customerSearch) customerSearch.disabled = true;
        
        // Stock ma'lumotlarini backend'dan olish (lazy loading)
        console.log('� Stock ma\'lumotlarini yangilash...');
        await loadUpdatedStockInfo(itemCopy, currentTabId);
        
        // Form UI'ni tahrirlash rejimiga o'zgartirish
        updateFormForEditMode(currentTabId);
        
        // Miqdor maydoniga fokus berish
        setTimeout(() => {
            const quantityInput = document.getElementById(`quantity-${currentTabId}`);
            if (quantityInput) {
                quantityInput.focus();
                quantityInput.select();
                console.log(`🎯 Tahrir rejimi: Miqdor maydoniga fokus berildi`);
            }
        }, 100);
        
        showAlert(`✏️ Tahrirlash rejimi: ${itemCopy.name}. Miqdor va narxni o'zgartiring.`, 'info');
    }

    // Stock ma'lumotlarini yangilash (lazy loading)
    async function loadUpdatedStockInfo(item, tabId) {
        const tabData = tabs[tabId];
        if (!tabData) return;
        
        try {
            // Backend'dan yangi stock ma'lumotlarini olish
            const locationId = item.location_id;
            const locationType = item.location_type;
            
            console.log('🔍 Lazy loading API so\'rovi:', {
                url: `/api/search-products-by-location/${locationType}/${locationId}?search=${encodeURIComponent(item.name)}&limit=10`,
                item_id: item.id,
                product_id: item.product_id || item.id
            });
            
            // Yangi lazy loading API'sidan foydalanish
            const response = await fetch(`/api/search-products-by-location/${locationType}/${locationId}?search=${encodeURIComponent(item.name)}&limit=10`);
            const data = await response.json();
            const products = data.products || [];
            
            console.log('📦 Lazy loading natijasi:', products);
            
            // Mahsulotni topish
            const searchId = item.product_id || item.id;
            const currentProduct = products.find(p => p.id === searchId);
            
            if (currentProduct) {
                // Stock qaytarilgandan keyingi miqdor
                const stockQty = currentProduct.available_quantity || currentProduct.total_stock || 0;
                console.log('📊 Yangilangan stock ma\'lumotlari:', {
                    current_stock: stockQty,
                    removed_from_cart: item.quantity,
                    product_id: currentProduct.id
                });
                
                // tabData.selectedProduct ni yangilash
                tabData.selectedProduct = {
                    id: item.product_id || item.id,
                    name: item.name,
                    location_type: item.location_type,
                    location_id: item.location_id,
                    available_quantity: stockQty,
                    total_stock: currentProduct.total_stock || 0,
                    price: item.price,
                    cost_price: item.cost_price || currentProduct.cost_price || 0
                };
                
                // Mavjud miqdorni ko'rsatish
                const availableQuantityEl = document.getElementById(`availableQuantity-${tabId}`);
                if (availableQuantityEl) availableQuantityEl.value = stockQty;
                
                // Miqdor inputiga maksimal qiymat o'rnatish  
                const quantityInput = document.getElementById(`quantity-${tabId}`);
                if (quantityInput) {
                    quantityInput.max = stockQty;
                    quantityInput.title = `Maksimal miqdor: ${stockQty}`;
                }
                
                console.log('✅ Stock ma\'lumotlari muvaffaqiyatli yangilandi');
            } else {
                console.warn('⚠️ Mahsulot backend\'da topilmadi, fallback ishlatilmoqda');
                
                // Fallback: asl ma'lumotlardan foydalanish
                tabData.selectedProduct = {
                    id: item.product_id || item.id,
                    name: item.name,
                    location_type: item.location_type,
                    location_id: item.location_id,
                    available_quantity: item.quantity, // Avvalgi miqdor
                    total_stock: item.quantity,
                    price: item.price,
                    cost_price: item.cost_price || 0
                };
                
                const availableQuantityEl = document.getElementById(`availableQuantity-${tabId}`);
                if (availableQuantityEl) availableQuantityEl.value = item.quantity;
            }
        } catch (error) {
            console.error('Stock ma\'lumotlarini olishda xatolik:', error);
            
            // Xatolik holatida fallback
            tabData.selectedProduct = {
                id: item.product_id || item.id,
                name: item.name,
                location_type: item.location_type,
                location_id: item.location_id,
                available_quantity: item.quantity,
                total_stock: item.quantity,
                price: item.price,
                cost_price: item.cost_price || 0
            };
            
            const availableQuantityEl = document.getElementById(`availableQuantity-${tabId}`);
            if (availableQuantityEl) availableQuantityEl.value = item.quantity;
            
            showAlert('⚠️ Stock ma\'lumotlarini yangilashda xatolik', 'warning');
        }
    }
    
    // Form UI'ni tahrirlash rejimiga o'zgartirish
    function updateFormForEditMode(tabId) {
        // Tugma matnini o'zgartirish
        const addButtonIcon = document.getElementById(`addButtonIcon-${tabId}`);
        const addButtonText = document.getElementById(`addButtonText-${tabId}`);
        
        if (addButtonIcon) addButtonIcon.textContent = '✅';
        if (addButtonText) addButtonText.textContent = 'O\'zgarishlarni saqlash';
        
        // Mahsulot kartasini ko'rsatish
        const productCardSection = document.querySelector(`#tab-${tabId} .product-card-section`);
        if (productCardSection && productCardSection.style.display === 'none') {
            productCardSection.style.display = 'block';
        }
    }





    // Helper function to find location by ID and type
    function findLocationById(locationId, locationType) {
        if (locationType === 'store') {
            return allStores.find(s => s.id == locationId) || { name: 'Noma\'lum do\'kon' };
        } else {
            return allWarehouses.find(w => w.id == locationId) || { name: 'Noma\'lum ombor' };
        }
    }

    // Stock ayirish funksiyasi (korzinaga qo'shishda)
    async function deductStock(productId, quantity, locationId, locationType) {
        try {
            console.log(`🔻 Stock ayirish: Product ${productId}, Quantity ${quantity}, Location ${locationId} (${locationType})`);
            
            // Mavjud /api/reserve-stock endpoint'ini ishlatamiz
            const response = await fetch('/api/reserve-stock', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    product_id: productId,
                    quantity: quantity,
                    location_id: locationId,
                    location_type: locationType
                })
            });

            const result = await response.json();
            
            if (result.success) {
                console.log('✅ Stock muvaffaqiyatli ayirildi (reserve-stock orqali):', result.message);
                return true;
            } else {
                console.error('❌ Stock ayirishda xatolik:', result.error);
                showAlert(`❌ ${result.error}`, 'error');
                return false;
            }
        } catch (error) {
            console.error('❌ Stock ayirishda server xatoligi:', error);
            showAlert('❌ Stock ayirishda server xatoligi!', 'error');
            return false;
        }
    }

    // Stock rezerv qilish funksiyasi (pending sale uchun)
    async function reserveStock(productId, quantity, locationId, locationType) {
        try {
            console.log(`📦 Stock rezerv qilish: Product ${productId}, Quantity ${quantity}, Location ${locationId} (${locationType})`);
            
            const response = await fetch('/api/reserve-stock', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    product_id: productId,
                    quantity: quantity,
                    location_id: locationId,
                    location_type: locationType
                })
            });

            const result = await response.json();
            
            if (result.success) {
                console.log('✅ Stock muvaffaqiyatli rezerv qilindi:', result.message);
                return true;
            } else {
                console.error('❌ Stock rezerv qilishda xatolik:', result.error);
                showAlert(`❌ ${result.error}`, 'error');
                return false;
            }
        } catch (error) {
            console.error('❌ Stock rezerv qilishda server xatoligi:', error);
            showAlert('❌ Stock rezerv qilishda server xatoligi!', 'error');
            return false;
        }
    }

    // Stock qaytarish funksiyasi
    async function addStock(productId, quantity, locationId, locationType) {
        try {
            console.log(`⬆️ Stock qaytarish: Product ${productId}, Quantity ${quantity}, Location ${locationId} (${locationType})`);
            
            // Mavjud /api/return-stock endpoint'ini ishlatamiz
            const response = await fetch('/api/return-stock', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    product_id: productId,
                    quantity: quantity,
                    location_id: locationId,
                    location_type: locationType
                })
            });

            const result = await response.json();
            
            if (result.success) {
                console.log('⬆️ Stock muvaffaqiyatli qaytarildi (return-stock orqali):', result.message);
                return true;
            } else {
                console.error('❌ Stock qaytarishda xatolik:', result.error);
                showAlert(`❌ ${result.error}`, 'error');
                return false;
            }
        } catch (error) {
            console.error('❌ Stock qaytarishda server xatoligi:', error);
            showAlert('❌ Stock qaytarishda server xatoligi!', 'error');
            return false;
        }
    }

    // Eski API uchun backward compatibility
    async function returnStock(productId, quantity, locationId, locationType) {
        return await addStock(productId, quantity, locationId, locationType);
    }

    // Show alert function
    function showAlert(message, type = 'info') {
        const alertClass = type === 'error' ? 'alert-danger' : type === 'success' ? 'alert-success' : 'alert-info';
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 80px; right: 20px; z-index: 1050; min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        // Add to page
        const alertContainer = document.createElement('div');
        alertContainer.innerHTML = alertHtml;
        document.body.appendChild(alertContainer);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (alertContainer.parentNode) {
                alertContainer.parentNode.removeChild(alertContainer);
            }
        }, 3000);
    }





    // Sales sahifasi uchun valyuta kursini olish
    async function loadSalesCurrencyRate() {
        try {
            console.log('🔄 SALES: valyuta kursini yuklayapman...');
            const response = await fetch('/api/currency-rate');
            const data = await response.json();
            
            console.log('📊 SALES API javob:', data);
            
            if (data.success && data.rate) {
                const oldRate = USD_TO_UZS_RATE;
                USD_TO_UZS_RATE = data.rate.rate;
                window.USD_TO_UZS_RATE = data.rate.rate; // Window level yangilash
                console.log(`✅ SALES: Valyuta kursi yangilandi: ${oldRate} → ${USD_TO_UZS_RATE} UZS`);
                console.log(`✅ SALES: Window.USD_TO_UZS_RATE ham yangilandi: ${window.USD_TO_UZS_RATE}`);
                
                // Global o'zgaruvchi yangilanganini window'ga bildirish
                window.dispatchEvent(new CustomEvent('salesCurrencyUpdated', {
                    detail: { oldRate, newRate: USD_TO_UZS_RATE }
                }));
            } else {
                console.error('❌ SALES: API dan xato javob keldi:', data);
            }
        } catch (error) {
            console.error('❌ Sales: Valyuta kursini yuklashda xatolik:', error);
        }
    }

    // Header dan valyuta kursi yangilanganda
    window.addEventListener('currencyRateUpdated', function(event) {
        USD_TO_UZS_RATE = event.detail.newRate;
        window.USD_TO_UZS_RATE = event.detail.newRate; // Window level ham yangilash
        console.log(`🔄 SALES: Header'dan valyuta kursi yangilandi: 1 USD = ${USD_TO_UZS_RATE} UZS`);
        console.log(`🔄 SALES: Window.USD_TO_UZS_RATE = ${window.USD_TO_UZS_RATE}`);
        
        // Hozirgi ko'rsatilgan narxlarni yangilash
        updatePricesAfterRateChange();
    });

    // Valyuta kursi o'zgargandan keyin narxlarni yangilash
    function updatePricesAfterRateChange() {
        // Agar mahsulot tanlangan bo'lsa, narxlarni qayta hisoblash
        const usdInput = document.getElementById('priceUSD');
        if (usdInput && usdInput.value) {
            convertPrice('usd');
        }
        
        // Savdo ro'yxatidagi barcha narxlarni yangilash
        updateCartDisplayPrices();
    }

    // Savdo ro'yxatidagi narxlarni yangilash
    function updateCartDisplayPrices() {
        const cartRows = document.querySelectorAll('#cartTableBody tr');
        cartRows.forEach(row => {
            const priceCell = row.querySelector('.item-price');
            const totalCell = row.querySelector('.item-total');
            
            if (priceCell && totalCell) {
                // USD qiymatni olish va qayta formatlash
                const usdPrice = parseFloat(priceCell.dataset.usdPrice || 0);
                const quantity = parseInt(row.querySelector('.quantity-input').value || 0);
                
                if (usdPrice > 0) {
                    priceCell.innerHTML = formatPrice(usdPrice);
                    totalCell.innerHTML = formatPrice(usdPrice * quantity);
                }
            }
        });
        
        // Jami summani yangilash
        updateCartTotal();
    }

    // Tab nomini yangilash funksiyasi
    function updateTabTitle(tabId) {
        const tab = tabs[tabId];
        if (!tab) return;
        
        const baseTitle = tab.title ? tab.title.split(':')[0] : `Savdo ${tabId.split('-')[1]}`;
        let newTitle = baseTitle;
        
        // Agar mijoz tanlangan bo'lsa, faqat mijoz ma'lumotlarini ko'rsatish
        if (tab.selectedCustomer) {
            newTitle = `${tab.selectedCustomer.name} - ${tab.selectedCustomer.phone}`;
        }
        
        // Tab nomini yangilash
        const tabElement = document.querySelector(`[data-tab-id="${tabId}"] .tab-title`);
        if (tabElement) {
            tabElement.textContent = newTitle;
        }
        
        // Tab ma'lumotlarini saqlash
        tab.title = baseTitle;
    }

    // Yangi savdo tab qo'shish funksiyasi
    function addNewSaleTab() {
        tabCounter++;
        const tabId = `sale-${tabCounter}`;
        const tabTitle = `Savdo ${tabCounter}`;
        
        // Tab ma'lumotlarini yaratish
        tabs[tabId] = {
            cart: [],
            selectedProduct: null,
            title: tabTitle,
            originalQuantities: {} // Asl miqdorlar uchun bo'sh obyekt
        };
        
        // Tab navigation qo'shish
        const tabNav = document.getElementById('tabsNav');
        const tabItem = document.createElement('div');
        tabItem.className = 'tab-item';
        tabItem.setAttribute('data-tab-id', tabId);
        tabItem.innerHTML = `
            <span class="tab-title">${tabTitle}</span>
            <button class="tab-close" onclick="confirmCloseTab('${tabId}')" title="Tabni yopish">×</button>
        `;
        tabItem.addEventListener('click', (e) => {
            if (!e.target.classList.contains('tab-close')) {
                switchToTab(tabId);
            }
        });
        tabNav.appendChild(tabItem);
        
        // Tab content qo'shish
        const template = document.getElementById('saleTabTemplate').innerHTML;
        const tabContent = template.replace(/{TAB_ID}/g, tabId);
        document.getElementById('tabsContent').insertAdjacentHTML('beforeend', tabContent);
        
        // Yangi tabga o'tish
        switchToTab(tabId);
        
        // Joylashuvlar va boshqa ma'lumotlarni yuklash
        populateTabSelects(tabId);
        
        // Yangi tab uchun narx validatsiyasini faollashtirish
        enablePriceValidationForTab(tabId);
        
        console.log(`✅ Yangi savdo tab qo'shildi: ${tabId}`);
        showNotification(`${tabTitle} tab yaratildi! 🎉`, 'success');
    }
    
    // Tab'ga o'tish funksiyasi
    function switchToTab(tabId) {
        // Barcha tablarni nofaol qilish
        document.querySelectorAll('.tab-item').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Tanlangan tabni faol qilish
        document.querySelector(`[data-tab-id="${tabId}"]`).classList.add('active');
        document.getElementById(`tab-${tabId}`).classList.add('active');
        
        activeTabId = tabId;
        console.log(`🔄 Tab o'zgartirildi: ${tabId}`);
    }
    
    // Tasdiqlash bilan tab yopish funksiyasi
    function confirmCloseTab(tabId) {
        const tabData = tabs[tabId];
        if (!tabData) {
            closeTab(tabId);
            return;
        }
        
        // Agar tabda mahsulotlar bo'lsa, tasdiqlash so'rash
        if (tabData.cart && tabData.cart.length > 0) {
            const itemCount = tabData.cart.length;
            const confirmMessage = `Bu tabda ${itemCount} ta mahsulot bor. Tabni yopishni tasdiqlaysizmi? (Barcha ma'lumotlar o'chadi)`;
            if (!confirm(confirmMessage)) {
                return; // Foydalanuvchi bekor qildi
            }
        } else {
            // Bo'sh tab uchun oddiy tasdiqlash
            const confirmMessage = `Bu tabni yopishni tasdiqlaysizmi?`;
            if (!confirm(confirmMessage)) {
                return; // Foydalanuvchi bekor qildi
            }
        }
        
        closeTab(tabId);
    }
    
    // Tabni yopish funksiyasi
    function closeTab(tabId) {
        // Agar bu yagona tab bo'lsa, uni to'liq tozalash
        if (Object.keys(tabs).length === 1) {
            console.log('🧹 Yagona tab to\'liq tozalanmoqda...');
            clearTab(tabId);
            showNotification('Tab tozalandi! 🧹', 'success');
            return;
        }
        
        // Tab ma'lumotlarini o'chirish
        delete tabs[tabId];
        
        // DOM dan olib tashlash
        document.querySelector(`[data-tab-id="${tabId}"]`).remove();
        document.getElementById(`tab-${tabId}`).remove();
        
        // Agar faol tab yopilgan bo'lsa, boshqa tabga o'tish
        if (activeTabId === tabId) {
            const remainingTabs = Object.keys(tabs);
            if (remainingTabs.length > 0) {
                switchToTab(remainingTabs[0]);
            }
        }
        
        console.log(`❌ Tab yopildi: ${tabId}`);
        showNotification('Tab yopildi! 🗑️', 'info');
    }
    
    // Tabni to'liq tozalash funksiyasi
    function clearTab(tabId) {
        const tabData = tabs[tabId];
        if (!tabData) return;
        
        // Tab ma'lumotlarini tozalash
        tabData.cart = [];
        tabData.selectedProduct = null;
        tabData.selectedCustomer = null;
        tabData.isEditMode = false;
        tabData.editingSaleId = null;
        tabData.editingSaleStatus = null;
        tabData.originalQuantities = {};
        tabData.currentPendingSaleId = null;
        
        // Form elementlarini tozalash
        const customerSearch = document.getElementById(`customerSearch-${tabId}`);
        const selectedCustomerId = document.getElementById(`selectedCustomerId-${tabId}`);
        const productSearch = document.getElementById(`productSearch-${tabId}`);
        const locationSelect = document.getElementById(`locationSelect-${tabId}`);
        
        if (customerSearch) customerSearch.value = '';
        if (selectedCustomerId) selectedCustomerId.value = '';
        if (productSearch) productSearch.value = '';
        if (locationSelect) locationSelect.selectedIndex = 0;
        
        // Korzinani yangilash
        updateCart(tabId);
        
        // Tab nomini tiklash
        tabData.title = `Savdo ${tabId.split('-')[1]}`;
        updateTabTitle(tabId);
        
        console.log(`🧹 Tab to'liq tozalandi: ${tabId}`);
    }
    
    // Tab select'larini to'ldirish
    function populateTabSelects(tabId) {
        // Joylashuvlarni to'ldirish
        const locationSelect = document.getElementById(`locationSelect-${tabId}`);
        if (locationSelect && allLocations.length > 0) {
            // Agar select allaqachon to'ldirilgan bo'lsa, uni tozalash
            locationSelect.innerHTML = '<option value="">Joylashuvni tanlang</option>';
            
            allLocations.forEach(location => {
                const option = document.createElement('option');
                option.value = `${location.type}_${location.id}`;
                
                let locationType = location.type;
                if (locationType === 'warehouse') {
                    locationType = 'Ombor';
                } else if (locationType === 'store') {
                    locationType = 'Do\'kon';
                }
                
                option.textContent = `${locationType}: ${location.name}`;
                locationSelect.appendChild(option);
            });
            
            // Sotuvchi uchun avtomatik joylashuv tanlash
            autoSelectLocationForSotuvchi(tabId, locationSelect);
            
            console.log(`✅ Tab ${tabId} uchun ${allLocations.length} ta joylashuv to'ldirildi`);
        }
    }
    
    // Sotuvchi uchun avtomatik joylashuv tanlash funksiyasi
    function autoSelectLocationForSotuvchi(tabId, locationSelect) {
        const container = document.querySelector('.sales-container');
        const userRole = container.dataset.userRole;
        const userStoreId = container.dataset.userStoreId;
        
        // Faqat sotuvchi roli uchun va store_id mavjud bo'lsa
        if (userRole === 'sotuvchi' && userStoreId) {
            // Store tipida user store ID ni topish
            const storeOption = locationSelect.querySelector(`option[value="store_${userStoreId}"]`);
            
            if (storeOption) {
                locationSelect.value = `store_${userStoreId}`;
                console.log(`🎯 Sotuvchi uchun avtomatik tanlandi: Store ${userStoreId}`);
                
                // Joylashuv tanlagandan keyin mahsulotlarni yuklash
                loadLocationProducts(tabId);
                
                // Avtomatik tanlashdan keyin mijoz maydoniga fokus berish
                setTimeout(() => {
                    const customerInput = document.getElementById(`customerSearch-${tabId}`);
                    if (customerInput) {
                        customerInput.focus();
                        console.log(`🎯 Avtomatik tanlash: Fokus mijoz maydoniga berildi (Tab ${tabId})`);
                    }
                }, 200); // Bir oz ko'proq kechikish - loadLocationProducts tugashini kutish
            } else {
                console.log(`⚠️ Sotuvchi uchun store ${userStoreId} topilmadi`);
            }
        }
    }
    
    // Notification ko'rsatish funksiyasi
    function showNotification(message, type = 'info') {
        // Agar mavjud notification bor bo'lsa, olib tashlash
        const existingNotification = document.getElementById('notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        // Yangi notification yaratish
        const notification = document.createElement('div');
        notification.id = 'notification';
        notification.innerHTML = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            font-size: 0.9rem;
            font-weight: 500;
            max-width: 300px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        `;
        
        document.body.appendChild(notification);
        
        // Animation bilan ko'rsatish
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 100);
        
        // 3 soniyadan keyin yashirish
        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 300);
        }, 3000);
    }

    // Matnda qidiruv so'zini sariq bilan ajratib ko'rsatish
    function highlightSearchTerm(text, searchTerm) {
        if (!searchTerm || searchTerm.length < 1) return text;
        
        const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        return text.replace(regex, '<span class="search-highlight">$1</span>');
    }

    // Qidiruv highlight ini olib tashlash
    function removeHighlights(element) {
        const highlights = element.querySelectorAll('.search-highlight');
        highlights.forEach(highlight => {
            const parent = highlight.parentNode;
            parent.replaceChild(document.createTextNode(highlight.textContent), highlight);
            parent.normalize();
        });
    }

    // Korzinada qidiruv funksiyasi
    function filterCartItems(tabId) {
        const searchInput = document.getElementById(`cartSearch-${tabId}`);
        const cartTableBody = document.getElementById(`cartTableBody-${tabId}`);
        
        if (!searchInput || !cartTableBody) return;
        
        const searchTerm = searchInput.value.toLowerCase().trim();
        const rows = cartTableBody.querySelectorAll('tr');
        
        // Avval barcha highlight larni olib tashlash
        rows.forEach(row => {
            if (row.id && row.id.startsWith('item-')) {
                removeHighlights(row);
            }
        });

        rows.forEach(row => {
            if (!row.id || !row.id.startsWith('item-')) return;
            
            // Qator matnini olish
            const rowText = row.textContent.toLowerCase();
            
            // Qidiruv so'zi mavjudligini tekshirish
            const isVisible = searchTerm === '' || rowText.includes(searchTerm);
            
            // Qatorni ko'rsatish/yashirish
            row.style.display = isVisible ? '' : 'none';
            
            // Agar ko'rinadigan bo'lsa va qidiruv so'zi bor bo'lsa, highlight qo'shish
            if (isVisible && searchTerm && searchTerm.length > 0) {
                const cells = row.querySelectorAll('td');
                // Faqat ikkinchi ustun (mahsulot ustuni) - index 1
                const productCell = cells[1];
                if (productCell) {
                    // Tugmalar va input elementlarni saqlab qolish
                    const textNodes = [];
                    const walker = document.createTreeWalker(
                        productCell,
                        NodeFilter.SHOW_TEXT,
                        {
                            acceptNode: function(node) {
                                // Tugma va input ichidagi matnlarni o'tkazib yuborish
                                const parent = node.parentNode;
                                if (parent.tagName === 'BUTTON' || 
                                    parent.tagName === 'INPUT' || 
                                    parent.classList.contains('search-highlight')) {
                                    return NodeFilter.FILTER_REJECT;
                                }
                                return NodeFilter.FILTER_ACCEPT;
                            }
                        }
                    );
                    
                    let node;
                    while (node = walker.nextNode()) {
                        textNodes.push(node);
                    }
                    
                    textNodes.forEach(textNode => {
                        const text = textNode.textContent;
                        if (text.toLowerCase().includes(searchTerm)) {
                            const highlightedHTML = highlightSearchTerm(text, searchTerm);
                            if (highlightedHTML !== text) {
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = highlightedHTML;
                                const fragment = document.createDocumentFragment();
                                while (tempDiv.firstChild) {
                                    fragment.appendChild(tempDiv.firstChild);
                                }
                                textNode.parentNode.replaceChild(fragment, textNode);
                            }
                        }
                    });
                }
            }
        });
        
        // Agar hech narsa topilmasa, xabar ko'rsatish
        const visibleRows = Array.from(rows).filter(row => 
            row.style.display !== 'none' && row.id && row.id.startsWith('item-')
        );
        
        // Bo'sh holatni boshqarish
        let noResultsRow = cartTableBody.querySelector('.no-search-results');
        
        if (searchTerm && visibleRows.length === 0) {
            if (!noResultsRow) {
                noResultsRow = document.createElement('tr');
                noResultsRow.className = 'no-search-results';
                noResultsRow.innerHTML = `
                    <td colspan="6" style="text-align: center; padding: 1rem; color: #6c757d; font-style: italic;">
                        🔍 "<span class="search-highlight">${searchTerm}</span>" bo'yicha hech narsa topilmadi
                    </td>
                `;
                cartTableBody.appendChild(noResultsRow);
            }
        } else if (noResultsRow) {
            noResultsRow.remove();
        }
    }
</script>



{% endblock %}
