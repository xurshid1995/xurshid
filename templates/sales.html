{% extends "base_with_sidebar.html" %}

{% block title %}Savdo - Dokon Boshqaruv Tizimi{% endblock %}

{% block extra_css %}
<style>
    .sales-container {
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #dee2e6;
    }

    .page-header h1 {
        margin: 0;
        color: #333;
        font-size: 24px;
    }
</style>
{% endblock %}

{% block content %}
<div class="sales-container">
    <div class="page-header">
        <h1>🛒 Savdo Sahifasi</h1>
    </div>

    <!-- Ikkita 665px kenglikda layout -->
    <div style="display: grid; grid-template-columns: 665px 665px; gap: 20px; justify-content: center; padding: 20px;">
        <!-- Birinchi layout -->
        <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 665px; box-sizing: border-box;">
            <!-- Joylashuv va Mijoz tanlash -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500; color: #495057;">📍 Joylashuvni tanlang</label>
                    <select id="locationSelect" onchange="loadProducts()" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; background: white; cursor: pointer;">
                        <option value="">Tanlang...</option>
                    </select>
                </div>
                <div style="position: relative;">
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500; color: #495057;">👤 Mijozni tanlang</label>
                    <input type="text" id="customerSearch" placeholder="Mijoz nomini kiriting..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <div id="customerDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ced4da; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
                    <input type="hidden" id="selectedCustomerId" value="">
                </div>
            </div>
            
            <!-- Mahsulot qidirish -->
            <div style="margin-bottom: 15px;">
                <input type="text" id="productSearch" placeholder="Mahsulot nomini kiriting..." style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
            </div>
            
            <!-- Mahsulotlar jadvali -->
            <div style="width: 625px; overflow-x: auto;">
                <table class="sales-product-table" style="width: 550px !important; min-width: 550px !important; max-width: 550px !important; border-collapse: collapse; table-layout: fixed !important;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 10px 8px; text-align: left; font-size: 13px; color: #495057; border-right: 1px solid #dee2e6; width: 250px; box-sizing: border-box;">Mahsulot</th>
                            <th style="padding: 10px 8px; text-align: center; font-size: 13px; color: #495057; border-right: 1px solid #dee2e6; width: 80px; box-sizing: border-box;">Mavjud</th>
                            <th style="padding: 10px 8px; text-align: left; font-size: 13px; color: #495057; border-right: 1px solid #dee2e6; width: 170px; box-sizing: border-box;">Narx</th>
                            <th style="padding: 2px; text-align: center; font-size: 13px; color: #495057; width: 50px; box-sizing: border-box;">Amal</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 30px; color: #999;">
                                Joylashuvni tanlang
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Ikkinchi layout -->
        <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; color: #333;">Layout 2</h3>
            <div style="min-height: 400px; border: 2px dashed #dee2e6; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #999;">
                <p>Ikkinchi layout</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Joylashuvlarni yuklash
    async function loadLocations() {
        try {
            const response = await fetch('/api/locations');
            const locations = await response.json();
            
            const locationSelect = document.getElementById('locationSelect');
            locationSelect.innerHTML = '<option value="">Tanlang...</option>';
            
            locations.forEach(location => {
                const option = document.createElement('option');
                option.value = `${location.type}_${location.id}`;
                const locationType = location.type === 'warehouse' ? '🏭 Ombor' : '🏪 Do\'kon';
                option.textContent = `${locationType}: ${location.name}`;
                locationSelect.appendChild(option);
            });
            
            console.log(`✅ ${locations.length} ta joylashuv yuklandi`);
        } catch (error) {
            console.error('Joylashuvlarni yuklashda xatolik:', error);
        }
    }
    
    // Mijozlarni yuklash va qidirish
    let allCustomers = [];
    
    async function loadCustomers() {
        try {
            const response = await fetch('/api/customers');
            const data = await response.json();
            allCustomers = data.customers || [];
            console.log(`✅ ${allCustomers.length} ta mijoz yuklandi`);
        } catch (error) {
            console.error('Mijozlarni yuklashda xatolik:', error);
        }
    }
    
    function searchCustomers(searchText) {
        const dropdown = document.getElementById('customerDropdown');
        
        if (!searchText || searchText.length < 2) {
            dropdown.style.display = 'none';
            return;
        }
        
        const filtered = allCustomers.filter(customer => {
            const name = customer.name ? customer.name.toLowerCase() : '';
            const phone = customer.phone ? customer.phone : '';
            const search = searchText.toLowerCase();
            return name.includes(search) || phone.includes(search);
        });
        
        if (filtered.length === 0) {
            dropdown.innerHTML = '<div style="padding: 10px; color: #999; text-align: center;">Mijoz topilmadi</div>';
            dropdown.style.display = 'block';
            return;
        }
        
        dropdown.innerHTML = filtered.map(customer => {
            return `<div onclick="selectCustomer(${customer.id}, '${customer.name.replace(/'/g, "\\'")}', '${customer.phone || ''}')" 
                    style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s;"
                    onmouseover="this.style.background='#f8f9fa'"
                    onmouseout="this.style.background='white'">
                    <div style="font-weight: 500; color: #333;">${customer.name}</div>
                    <div style="font-size: 12px; color: #6c757d;">${customer.phone || 'Telefon yo\'q'}</div>
                </div>`;
        }).join('');
        
        dropdown.style.display = 'block';
    }
    
    function selectCustomer(id, name, phone) {
        document.getElementById('customerSearch').value = name;
        document.getElementById('selectedCustomerId').value = id;
        document.getElementById('customerDropdown').style.display = 'none';
        console.log(`✅ Mijoz tanlandi: ${name} (ID: ${id})`);
    }
    
    // Mahsulotlarni yuklash
    async function loadProducts() {
        const locationSelect = document.getElementById('locationSelect');
        const tbody = document.getElementById('productsTable');
        
        const locationValue = locationSelect.value;
        
        if (!locationValue) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px; color: #999;">Joylashuvni tanlang</td></tr>';
            return;
        }
        
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">⏳ Yuklanmoqda...</td></tr>';
        
        try {
            const [type, id] = locationValue.split('_');
            const response = await fetch(`/api/products?location=${locationValue}`);
            const data = await response.json();
            
            console.log('API response:', data);
            
            // API dan kelgan ma'lumotni tekshirish
            const products = Array.isArray(data) ? data : (data.products || []);
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">Mahsulotlar topilmadi</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            products.forEach(product => {
                // Quantity va selling price ni olish
                let quantity = 0;
                let sellingPrice = product.sell_price || product.price || 0;
                
                // Agar stocks mavjud bo'lsa, locationga mos keladiganini topish
                if (product.stocks && product.stocks.length > 0) {
                    const [type, id] = locationValue.split('_');
                    const locationId = parseInt(id);
                    
                    // Mos stock ni topish
                    const matchingStock = product.stocks.find(stock => {
                        if (type === 'warehouse') {
                            return stock.warehouse_id === locationId;
                        } else if (type === 'store') {
                            return stock.store_id === locationId;
                        }
                        return false;
                    });
                    
                    if (matchingStock) {
                        quantity = matchingStock.quantity || 0;
                    }
                }
                
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #f0f0f0';
                row.innerHTML = `
                    <td style="padding: 12px 8px; font-size: 14px; color: #333; border-right: 1px solid #eee;" title="${product.name || 'N/A'}">${product.name || 'N/A'}</td>
                    <td style="padding: 12px 8px; text-align: center; font-size: 14px; border-right: 1px solid #eee;">
                        <span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 500; display: inline-block;">${quantity}</span>
                    </td>
                    <td style="padding: 12px 8px; text-align: left; font-size: 14px; border-right: 1px solid #eee;">
                        <span style="background: #ffc107; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 500; margin-right: 6px; display: inline-block;">$${formatPrice(sellingPrice)}</span>
                        <span style="background: #5cb3ff; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 500; display: inline-block;">${formatPrice(sellingPrice * 12650)} so'm</span>
                    </td>
                    <td style="padding: 2px; text-align: center; font-size: 14px;">
                        <button onclick="addToCart(${product.id}, '${product.name.replace(/'/g, "\\'")}',, ${quantity}, ${sellingPrice})" style="background: #007bff; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">+</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`✅ ${products.length} ta mahsulot yuklandi`);
        } catch (error) {
            console.error('Mahsulotlarni yuklashda xatolik:', error);
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #dc3545;">⚠️ Xatolik yuz berdi</td></tr>';
        }
    }
    
    // Mahsulotni savatga qo'shish
    function addToCart(productId, productName, quantity, price) {
        console.log(`➕ Savatga qo'shildi: ${productName} (ID: ${productId})`);
        // Bu yerda savat logikasini qo'shish kerak
    }
    
    // Mahsulot qidirish funksiyasi
    function filterProducts() {
        const searchText = document.getElementById('productSearch').value.toLowerCase().trim();
        const tbody = document.getElementById('productsTable');
        const rows = tbody.getElementsByTagName('tr');
        
        // Bo'sh qidiruv - barchasini ko'rsat, highlight yo'q
        if (!searchText) {
            for (let i = 0; i < rows.length; i++) {
                const productNameCell = rows[i].getElementsByTagName('td')[0];
                if (productNameCell) {
                    // Highlight ni olib tashlash
                    const originalText = productNameCell.getAttribute('data-original-text') || productNameCell.textContent;
                    productNameCell.innerHTML = originalText;
                }
                rows[i].style.display = '';
            }
            return;
        }
        
        // Regex maxsus belgilarini escape qilish
        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // Qidiruv so'zlarini ajratish (bo'shliq bilan)
        const searchWords = searchText.split(/\s+/).filter(word => word.length > 0);
        
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const productNameCell = row.getElementsByTagName('td')[0];
            
            if (productNameCell) {
                // Original textni saqlash
                if (!productNameCell.getAttribute('data-original-text')) {
                    productNameCell.setAttribute('data-original-text', productNameCell.textContent);
                }
                
                const originalText = productNameCell.getAttribute('data-original-text');
                const textValue = originalText.toLowerCase();
                
                // Barcha so'zlar topilishi kerak
                const allWordsFound = searchWords.every(word => textValue.indexOf(word) > -1);
                
                if (allWordsFound) {
                    row.style.display = '';
                    
                    // Highlight qilish - barcha so'zlarni bir vaqtda
                    let highlightedText = originalText;
                    
                    // Barcha so'zlarni alternation bilan birlashtirib bir marta replace qilish
                    if (searchWords.length > 0) {
                        const escapedWords = searchWords.map(word => escapeRegex(word));
                        const combinedPattern = escapedWords.join('|');
                        const regex = new RegExp(`(${combinedPattern})`, 'gi');
                        highlightedText = highlightedText.replace(regex, '<span style="background-color: #ffeb3b; padding: 2px 4px; border-radius: 2px;">$1</span>');
                    }
                    
                    productNameCell.innerHTML = highlightedText;
                } else {
                    row.style.display = 'none';
                }
            }
        }
    }
    
    // Narxni formatlash
    function formatPrice(price) {
        if (!price) return '0';
        return Number(price).toLocaleString('uz-UZ');
    }
    
    // Sahifa yuklanganda joylashuvlarni yuklash
    document.addEventListener('DOMContentLoaded', function() {
        loadLocations();
        loadCustomers();
        
        // Mahsulot qidirish input'ga event listener qo'shish
        const productSearchInput = document.getElementById('productSearch');
        if (productSearchInput) {
            productSearchInput.addEventListener('input', filterProducts);
        }
        
        // Mijoz qidirish input'ga event listener qo'shish
        const customerSearchInput = document.getElementById('customerSearch');
        if (customerSearchInput) {
            customerSearchInput.addEventListener('input', function() {
                searchCustomers(this.value);
            });
            
            // Input focus bo'lganda dropdown'ni ko'rsatish
            customerSearchInput.addEventListener('focus', function() {
                if (this.value.length >= 2) {
                    searchCustomers(this.value);
                }
            });
        }
        
        // Dropdown tashqarisiga bosilganda yopish
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('customerDropdown');
            const input = document.getElementById('customerSearch');
            if (e.target !== input && e.target !== dropdown && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        console.log('✅ Sales sahifasi tayyor');
    });
</script>
{% endblock %}
