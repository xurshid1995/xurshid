{% extends "base_with_sidebar.html" %}

{% block title %}Savdo - Dokon Boshqaruv Tizimi{% endblock %}

{% block extra_css %}
<style>
    .sales-container {
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #dee2e6;
    }

    .page-header h1 {
        margin: 0;
        color: #333;
        font-size: 24px;
    }
</style>
{% endblock %}

{% block content %}
<div class="sales-container">
    <div class="page-header">
        <h1>🛒 Savdo Sahifasi</h1>
    </div>

    <!-- Ikkita 665px kenglikda layout -->
    <div style="display: grid; grid-template-columns: 665px 665px; gap: 20px; justify-content: center; padding: 20px; align-items: start;">
        <!-- Birinchi layout -->
        <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 665px; box-sizing: border-box;">
            <!-- Joylashuv va Mijoz tanlash -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500; color: #495057;">📍 Joylashuvni tanlang</label>
                    <select id="locationSelect" onchange="loadProducts()" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; background: white; cursor: pointer;">
                        <option value="">Tanlang...</option>
                    </select>
                </div>
                <div style="position: relative;">
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500; color: #495057;">👤 Mijozni tanlang</label>
                    <input type="text" id="customerSearch" placeholder="Mijoz nomini kiriting..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <div id="customerDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ced4da; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
                    <input type="hidden" id="selectedCustomerId" value="">
                </div>
            </div>
            
            <!-- Mahsulot qidirish -->
            <div style="margin-bottom: 15px;">
                <input type="text" id="productSearch" placeholder="Mahsulot nomini kiriting..." style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
            </div>
            
            <!-- Mahsulotlar jadvali -->
            <div style="width: 625px; overflow-x: auto;">
                <table class="sales-product-table" style="width: 620px !important; min-width: 620px !important; max-width: 620px !important; border-collapse: collapse; table-layout: fixed !important;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 10px 8px; text-align: left; font-size: 14px; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6; width: 320px; box-sizing: border-box;">Mahsulot</th>
                            <th style="padding: 10px 8px; text-align: center; font-size: 14px; color: #495057; border-right: 1px solid #dee2e6; width: 60px; box-sizing: border-box;">Mavjud</th>
                            <th style="padding: 10px 8px; text-align: left; font-size: 14px; color: #495057; border-right: 1px solid #dee2e6; width: 200px; box-sizing: border-box;">Narx</th>
                            <th style="padding: 2px; text-align: center; font-size: 14px; color: #495057; width: 40px; box-sizing: border-box;">Amal</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 30px; color: #999;">
                                Joylashuvni tanlang
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Ikkinchi layout -->
        <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 665px; box-sizing: border-box;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div id="cartCustomerInfo">
                    <h3 style="margin: 0; color: #333;">🛒 Savdo Korzinasi</h3>
                </div>
                <div id="cartTotalHeader" style="text-align: right;"></div>
            </div>
            <div id="cartContainer">
                <div style="width: 620px; overflow-x: auto;">
                    <table class="cart-table" style="width: 620px !important; max-width: 620px !important; border-collapse: collapse; margin-bottom: 15px; table-layout: fixed !important;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 8px 5px; text-align: left; font-size: 14px; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6; width: 312px;">Mahsulot</th>
                                <th style="padding: 8px 5px; text-align: center; font-size: 14px; color: #495057; border-right: 1px solid #dee2e6; width: 84px;">Soni</th>
                                <th style="padding: 8px 5px; text-align: right; font-size: 14px; color: #495057; border-right: 1px solid #dee2e6; width: 90px;">Narxi</th>
                                <th style="padding: 8px 5px; text-align: right; font-size: 14px; color: #495057; border-right: 1px solid #dee2e6; width: 94px;">Jami</th>
                                <th style="padding: 8px 5px; text-align: center; font-size: 14px; color: #495057; width: 40px;">Amal</th>
                            </tr>
                        </thead>
                        <tbody id="cartItems">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 50px; color: #999;">Savat bo'sh</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="cartTotal" style="border-top: 2px solid #dee2e6; padding-top: 10px; font-weight: bold; font-size: 16px; text-align: right;"></div>
                
                <!-- Tugmalar -->
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="clearCart()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">🗑️ Tozalash</button>
                    <button onclick="savePending()" style="background: #ffc107; color: #333; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">⏸️ Keyinroq</button>
                    <button onclick="completeSale()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">✅ Yakunlash</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- To'lov modal oyna -->
    <div id="paymentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 8px; padding: 30px; width: 650px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h3 style="margin: 0 0 20px 0; color: #333;">💳 To'lov turlari</h3>
            
            <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-weight: 500; white-space: nowrap; min-width: 90px;">💵 Naxt:</label>
                    <input type="number" id="paymentCashUSD" step="0.01" value="0.00" placeholder="$" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <input type="number" id="paymentCashUZS" step="1" value="0" placeholder="UZS" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <button onclick="addRemainingToField('paymentCashUSD')" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; white-space: nowrap;">+ Qolgan</button>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-weight: 500; white-space: nowrap; min-width: 90px;">📱 Click:</label>
                    <input type="number" id="paymentClickUSD" step="0.01" value="0.00" placeholder="$" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <input type="number" id="paymentClickUZS" step="1" value="0" placeholder="UZS" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <button onclick="addRemainingToField('paymentClickUSD')" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; white-space: nowrap;">+ Qolgan</button>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-weight: 500; white-space: nowrap; min-width: 90px;">🏧 Terminal:</label>
                    <input type="number" id="paymentTerminalUSD" step="0.01" value="0.00" placeholder="$" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <input type="number" id="paymentTerminalUZS" step="1" value="0" placeholder="UZS" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <button onclick="addRemainingToField('paymentTerminalUSD')" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; white-space: nowrap;">+ Qolgan</button>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-weight: 500; white-space: nowrap; min-width: 90px;">📋 Qarz:</label>
                    <input type="number" id="paymentDebtUSD" step="0.01" value="0.00" placeholder="$" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <input type="number" id="paymentDebtUZS" step="1" value="0" placeholder="UZS" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <button onclick="addRemainingToField('paymentDebtUSD')" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; white-space: nowrap;">+ Qolgan</button>
                </div>
            </div>
            
            <div id="paymentWarning" style="display: none; padding: 10px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin-bottom: 15px; color: #856404; font-size: 14px;"></div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="closePaymentModal()" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">Bekor qilish</button>
                <button onclick="confirmPayment()" style="flex: 1; padding: 12px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">✅ Tasdiqlash</button>
            </div>
        </div>
    </div>
    
    <!-- Modal oyna -->
    <div id="quantityModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 8px; padding: 30px; width: 450px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h3 style="margin: 0 0 20px 0; color: #333;">Mahsulot ma'lumotlari</h3>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">📦 Mahsulot:</label>
                <div id="modalProductName" style="padding: 10px; background: #f8f9fa; border-radius: 4px; font-weight: 500;"></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">📊 Mavjud:</label>
                    <input type="number" id="modalAvailable" readonly style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; background: #e9ecef;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">🔢 Miqdor:</label>
                    <input type="number" id="modalQuantity" min="1" value="0" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">💵 Sotish narxi ($):</label>
                    <input type="number" id="modalPriceUSD" step="0.01" value="0.00" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">💰 Sotish narxi (UZS):</label>
                    <input type="number" id="modalPriceUZS" step="100" value="0" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="closeModal()" style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Bekor qilish</button>
                <button onclick="confirmAddToCart()" style="flex: 1; padding: 10px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Qo'shish</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Joylashuvlarni yuklash
    async function loadLocations() {
        try {
            const response = await fetch('/api/locations');
            const locations = await response.json();
            
            const locationSelect = document.getElementById('locationSelect');
            locationSelect.innerHTML = '<option value="">Tanlang...</option>';
            
            locations.forEach(location => {
                const option = document.createElement('option');
                option.value = `${location.type}_${location.id}`;
                const locationType = location.type === 'warehouse' ? '🏭 Ombor' : '🏪 Do\'kon';
                option.textContent = `${locationType}: ${location.name}`;
                locationSelect.appendChild(option);
            });
            
            console.log(`✅ ${locations.length} ta joylashuv yuklandi`);
        } catch (error) {
            console.error('Joylashuvlarni yuklashda xatolik:', error);
        }
    }
    
    // Mijozlarni yuklash va qidirish
    let allCustomers = [];
    let cart = [];
    let currentProduct = null;
    
    async function loadCustomers() {
        try {
            console.log('🔄 Mijozlarni yuklash boshlandi...');
            const response = await fetch('/api/customers');
            console.log('📡 API response status:', response.status);
            if (!response.ok) {
                console.error('❌ Mijozlarni yuklashda xatolik: HTTP', response.status);
                return;
            }
            const data = await response.json();
            console.log('📦 API response data:', data);
            // API to'g'ridan-to'g'ri array qaytaradi
            allCustomers = Array.isArray(data) ? data : (data.customers || []);
            console.log(`✅ ${allCustomers.length} ta mijoz yuklandi`, allCustomers);
        } catch (error) {
            console.error('❌ Mijozlarni yuklashda xatolik:', error);
        }
    }
    
    function searchCustomers(searchText) {
        console.log('🔍 searchCustomers chaqirildi:', searchText, 'Jami mijozlar:', allCustomers.length);
        const dropdown = document.getElementById('customerDropdown');
        
        if (!searchText || searchText.length < 2) {
            console.log('⚠️ Qidiruv matni 2 ta belgidan kam');
            dropdown.style.display = 'none';
            return;
        }
        
        const filtered = allCustomers.filter(customer => {
            const name = customer.name ? customer.name.toLowerCase() : '';
            const phone = customer.phone ? customer.phone : '';
            const search = searchText.toLowerCase();
            
            // Telefon raqamdan barcha maxsus belgilarni olib tashlash
            const cleanPhone = phone.replace(/[\s\-\(\)\+]/g, '');
            const cleanSearch = search.replace(/[\s\-\(\)\+]/g, '');
            
            return name.includes(search) || cleanPhone.includes(cleanSearch);
        });
        
        console.log('📋 Filterlangan mijozlar soni:', filtered.length);
        
        if (filtered.length === 0) {
            dropdown.innerHTML = '<div style="padding: 10px; color: #999; text-align: center;">Mijoz topilmadi</div>';
            dropdown.style.display = 'block';
            return;
        }
        
        dropdown.innerHTML = filtered.map(customer => {
            return `<div onclick="selectCustomer(${customer.id}, '${customer.name.replace(/'/g, "\\'")}', '${customer.phone || ''}')" 
                    style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s;"
                    onmouseover="this.style.background='#f8f9fa'"
                    onmouseout="this.style.background='white'">
                    <div style="font-weight: 500; color: #333;">${customer.name}</div>
                    <div style="font-size: 12px; color: #6c757d;">${customer.phone || 'Telefon yo\'q'}</div>
                </div>`;
        }).join('');
        
        dropdown.style.display = 'block';
    }
    
    function selectCustomer(id, name, phone) {
        const displayText = phone ? `${name} - ${phone}` : name;
        document.getElementById('customerSearch').value = displayText;
        document.getElementById('selectedCustomerId').value = id;
        document.getElementById('customerDropdown').style.display = 'none';
        
        // Savdo korzinasi sarlavhasida mijoz ma'lumotlarini ko'rsatish
        const cartCustomerInfo = document.getElementById('cartCustomerInfo');
        const customerDisplay = phone ? `👤 ${name} ${phone}` : `👤 ${name}`;
        cartCustomerInfo.innerHTML = `<h3 style="margin: 0; color: #333; font-size: 15px; font-weight: 600;">${customerDisplay}</h3>`;
        
        console.log(`✅ Mijoz tanlandi: ${name} (ID: ${id})`);
    }
    
    // Mahsulotlarni yuklash
    async function loadProducts() {
        const locationSelect = document.getElementById('locationSelect');
        const tbody = document.getElementById('productsTable');
        
        const locationValue = locationSelect.value;
        
        if (!locationValue) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px; color: #999;">Joylashuvni tanlang</td></tr>';
            return;
        }
        
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">⏳ Yuklanmoqda...</td></tr>';
        
        try {
            const [type, id] = locationValue.split('_');
            const response = await fetch(`/api/products?location=${locationValue}`);
            const data = await response.json();
            
            console.log('API response:', data);
            
            // API dan kelgan ma'lumotni tekshirish
            const products = Array.isArray(data) ? data : (data.products || []);
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">Mahsulotlar topilmadi</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            products.forEach(product => {
                // Quantity va selling price ni olish
                let quantity = 0;
                let sellingPrice = product.sell_price || product.price || 0;
                
                // Agar stocks mavjud bo'lsa, locationga mos keladiganini topish
                if (product.stocks && product.stocks.length > 0) {
                    const [type, id] = locationValue.split('_');
                    const locationId = parseInt(id);
                    
                    // Mos stock ni topish
                    const matchingStock = product.stocks.find(stock => {
                        if (type === 'warehouse') {
                            return stock.warehouse_id === locationId;
                        } else if (type === 'store') {
                            return stock.store_id === locationId;
                        }
                        return false;
                    });
                    
                    if (matchingStock) {
                        quantity = matchingStock.quantity || 0;
                    }
                }
                
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #f0f0f0';
                row.innerHTML = `
                    <td style="padding: 12px 8px; font-size: 14px; color: #333; border-right: 1px solid #eee;" title="${product.name || 'N/A'}">${product.name || 'N/A'}</td>
                    <td style="padding: 12px 8px; text-align: left; font-size: 14px; border-right: 1px solid #eee;">
                        <span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 0; font-weight: 500; display: inline-block;">${quantity}</span>
                    </td>
                    <td style="padding: 12px 8px; text-align: left; font-size: 14px; border-right: 1px solid #eee;">
                        <span style="background: #ffc107; color: white; padding: 4px 8px; border-radius: 0; font-weight: 500; margin-right: 6px; display: inline-block;">$${formatPrice(sellingPrice)}</span>
                        <span style="background: #5cb3ff; color: white; padding: 4px 8px; border-radius: 0; font-weight: 500; display: inline-block;">${formatPrice(sellingPrice * exchangeRate)} so'm</span>
                    </td>
                    <td style="padding: 2px; text-align: center; font-size: 14px;">
                        <button onclick="addToCart(${product.id}, '${product.name.replace(/'/g, "\\'")}', ${quantity}, ${sellingPrice})" style="background: transparent; color: #333; border: none; padding: 4px 8px; cursor: pointer; font-size: 18px;">➡️</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`✅ ${products.length} ta mahsulot yuklandi`);
        } catch (error) {
            console.error('Mahsulotlarni yuklashda xatolik:', error);
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #dc3545;">⚠️ Xatolik yuz berdi</td></tr>';
        }
    }
    
    // Valyuta kursi (global o'zgaruvchi)
    let exchangeRate = 12700; // Default kurs
    
    // Valyuta kursini olish
    async function loadExchangeRate() {
        try {
            const response = await fetch('/api/currency-rate');
            const data = await response.json();
            if (data.success && data.rate && data.rate.rate) {
                const newRate = parseFloat(data.rate.rate);
                if (!isNaN(newRate) && newRate > 0) {
                    exchangeRate = newRate;
                    console.log('✅ Valyuta kursi yuklandi:', exchangeRate);
                } else {
                    console.warn('⚠️ Noto\'g\'ri kurs qiymati, default ishlatiladi:', exchangeRate);
                }
            } else {
                console.warn('⚠️ Kurs ma\'lumoti topilmadi, default ishlatiladi:', exchangeRate);
            }
        } catch (error) {
            console.error('❌ Kursni yuklashda xatolik, default ishlatiladi:', exchangeRate, error);
        }
    }
    
    // USD dan UZS ga avtomatik konversiya
    function updateUZSPrice() {
        const usdInput = document.getElementById('modalPriceUSD');
        const uzsInput = document.getElementById('modalPriceUZS');
        
        if (!usdInput || !uzsInput) {
            console.error('❌ Modal input elementlari topilmadi');
            return;
        }
        
        const usdPrice = parseFloat(usdInput.value) || 0;
        const uzsPrice = usdPrice * exchangeRate;
        uzsInput.value = uzsPrice.toFixed(2);
        
        console.log('💱 Konversiya (USD→UZS):', usdPrice, 'USD ×', exchangeRate, '=', uzsPrice.toFixed(2), 'UZS');
    }
    
    // UZS dan USD ga avtomatik konversiya
    function updateUSDPrice() {
        const usdInput = document.getElementById('modalPriceUSD');
        const uzsInput = document.getElementById('modalPriceUZS');
        
        if (!usdInput || !uzsInput) {
            console.error('❌ Modal input elementlari topilmadi');
            return;
        }
        
        const uzsPrice = parseFloat(uzsInput.value) || 0;
        const usdPrice = uzsPrice / exchangeRate;
        usdInput.value = usdPrice.toFixed(2);
        
        console.log('💱 Konversiya (UZS→USD):', uzsPrice, 'UZS ÷', exchangeRate, '=', usdPrice.toFixed(2), 'USD');
    }
    
    // Modal ochish
    function addToCart(productId, productName, quantity, price) {
        currentProduct = { id: productId, name: productName, available: quantity, price: price };
        
        document.getElementById('modalProductName').textContent = productName;
        document.getElementById('modalAvailable').value = quantity;
        document.getElementById('modalQuantity').value = 1;
        document.getElementById('modalQuantity').max = quantity;
        document.getElementById('modalPriceUSD').value = price.toFixed(2);
        updateUZSPrice();
        
        document.getElementById('quantityModal').style.display = 'flex';
    }
    
    // Modal yopish
    function closeModal() {
        document.getElementById('quantityModal').style.display = 'none';
        currentProduct = null;
        delete window.editingCartIndex; // Tahrirlash rejimini tozalash
    }
    
    // Savatga qo'shish
    function confirmAddToCart() {
        const quantity = parseInt(document.getElementById('modalQuantity').value);
        const priceUSD = parseFloat(document.getElementById('modalPriceUSD').value);
        const priceUZS = parseFloat(document.getElementById('modalPriceUZS').value);
        
        // Agar tahrirlash rejimi bo'lsa
        if (typeof window.editingCartIndex !== 'undefined') {
            if (quantity <= 0) {
                alert('Noto\'g\'ri miqdor!');
                return;
            }
            
            if (priceUSD <= 0) {
                alert('Narx kiritilishi shart!');
                return;
            }
            
            // Savatdagi elementni yangilash
            cart[window.editingCartIndex].quantity = quantity;
            cart[window.editingCartIndex].priceUSD = priceUSD;
            cart[window.editingCartIndex].priceUZS = priceUZS;
            
            delete window.editingCartIndex;
            updateCart();
            closeModal();
            console.log('✏️ Savat elementi tahrirlandi');
            return;
        }
        
        // Yangi mahsulot qo'shish - currentProduct tekshiruvi
        if (!currentProduct) {
            alert('Mahsulot ma\'lumotlari topilmadi!');
            console.error('❌ currentProduct null holatda');
            return;
        }
        
        if (quantity <= 0 || quantity > currentProduct.available) {
            alert('Noto\'g\'ri miqdor!');
            return;
        }
        
        if (priceUSD <= 0) {
            alert('Narx kiritilishi shart!');
            return;
        }
        
        // Savat ichida mahsulot bormi tekshirish
        const existingItem = cart.find(item => item.id === currentProduct.id);
        
        if (existingItem) {
            existingItem.quantity += quantity;
            existingItem.priceUSD = priceUSD;
            existingItem.priceUZS = priceUZS;
        } else {
            cart.push({
                id: currentProduct.id,
                name: currentProduct.name,
                priceUSD: priceUSD,
                priceUZS: priceUZS,
                quantity: quantity
            });
        }
        
        updateCart();
        closeModal();
        console.log('✅ Savatga qo\'shildi:', currentProduct.name, quantity, 'dona, $' + priceUSD);
    }
    
    // Savatni yangilash
    function updateCart() {
        const cartItemsDiv = document.getElementById('cartItems');
        const cartTotalDiv = document.getElementById('cartTotal');
        const cartTotalHeader = document.getElementById('cartTotalHeader');
        
        if (cart.length === 0) {
            cartItemsDiv.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 50px; color: #999;">Savat bo\'sh</td></tr>';
            cartTotalDiv.innerHTML = '';
            cartTotalHeader.innerHTML = '';
            return;
        }
        
        let html = '';
        let totalUSD = 0;
        let totalUZS = 0;
        
        cart.forEach((item, index) => {
            const subtotalUSD = item.priceUSD * item.quantity;
            const subtotalUZS = item.priceUZS * item.quantity;
            totalUSD += subtotalUSD;
            totalUZS += subtotalUZS;
            
            html += `
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 8px 5px; font-size: 16px; color: #333; border-right: 1px solid #f0f0f0; word-wrap: break-word; width: 312px; max-width: 312px; overflow: hidden;">${item.name}</td>
                    <td style="padding: 8px 5px; text-align: center; font-size: 16px; color: #333; border-right: 1px solid #f0f0f0; width: 84px;">
                        <input type="number" value="${item.quantity}" min="1" onchange="updateCartQuantity(${index}, this.value)" style="width: 60px; text-align: center; border: 1px solid #ced4da; border-radius: 4px; padding: 4px; font-size: 15px; font-weight: 500;">
                    </td>
                    <td style="padding: 8px 5px; text-align: right; font-size: 15px; color: #333; border-right: 1px solid #f0f0f0; width: 90px;">
                        <div style="margin-bottom: 2px; font-weight: 600; color: #333; font-size: 15px;">$${item.priceUSD.toFixed(2)}</div>
                        <div>
                            <span style="background: #0d6efd; color: white; padding: 2px 4px; border-radius: 2px; font-weight: 500; font-size: 14px;">${formatPrice(item.priceUZS)}</span>
                        </div>
                    </td>
                    <td style="padding: 8px 5px; text-align: right; font-size: 15px; color: #333; border-right: 1px solid #f0f0f0; width: 94px;">
                        <div style="margin-bottom: 2px; font-weight: 600; color: #333; font-size: 15px;">$${subtotalUSD.toFixed(2)}</div>
                        <div>
                            <span style="background: #0d6efd; color: white; padding: 2px 4px; border-radius: 2px; font-weight: 500; font-size: 14px;">${formatPrice(subtotalUZS)}</span>
                        </div>
                    </td>
                    <td style="padding: 8px 5px; text-align: center; width: 40px;">
                        <button onclick="editCartItem(${index})" style="background: transparent; color: #333; border: none; padding: 4px 6px; cursor: pointer; font-size: 14px; margin-right: 2px;">✏️</button>
                        <button onclick="removeFromCart(${index})" style="background: transparent; color: #333; border: none; padding: 4px 6px; cursor: pointer; font-size: 14px; font-weight: bold;">❌</button>
                    </td>
                </tr>
            `;
        });
        
        cartItemsDiv.innerHTML = html;
        cartTotalDiv.innerHTML = '';
        
        // Jami summani sarlavhada ko'rsatish
        cartTotalHeader.innerHTML = `
            <div style="padding: 10px 15px; background: #f8f9fa; border-radius: 6px; border: 2px solid #dee2e6;">
                <div style="font-size: 14px; font-weight: 600; color: #333;">
                    Jami: <span style="color: #28a745; font-size: 16px;">$${totalUSD.toFixed(2)}</span>
                    <span style="margin-left: 15px; color: #333; font-size: 16px;">${formatPrice(totalUZS)} so'm</span>
                </div>
            </div>
        `;
    }
    
    // Savatdan o'chirish
    function removeFromCart(index) {
        cart.splice(index, 1);
        updateCart();
        console.log('🗑️ Savatdan o\'chirildi');
    }
    
    // Savat miqdorini yangilash
    function updateCartQuantity(index, newQuantity) {
        const quantity = parseInt(newQuantity);
        if (quantity < 1 || isNaN(quantity)) {
            alert('Noto\'g\'ri miqdor!');
            updateCart();
            return;
        }
        cart[index].quantity = quantity;
        updateCart();
        console.log('📝 Miqdor yangilandi:', quantity);
    }
    
    // Savat elementini tahrirlash
    function editCartItem(index) {
        const item = cart[index];
        
        // Modal oynani ochish
        document.getElementById('quantityModal').style.display = 'flex';
        document.getElementById('modalProductName').textContent = item.name;
        document.getElementById('modalAvailable').value = 999; // Tahrirlashda limit yo'q
        document.getElementById('modalQuantity').value = item.quantity;
        document.getElementById('modalPriceUSD').value = item.priceUSD.toFixed(2);
        document.getElementById('modalPriceUZS').value = item.priceUZS;
        
        // Eski confirm funksiyasini yangilash uchun indexni saqlash
        window.editingCartIndex = index;
    }
    
    // Mahsulotni savatga qo'shish (eski)
    /*
    function addToCart(productId, productName, quantity, price) {
        console.log(`➕ Savatga qo'shildi: ${productName} (ID: ${productId})`);
        // Bu yerda savat logikasini qo'shish kerak
    }
    */
    
    // Mahsulot qidirish funksiyasi
    function filterProducts() {
        const searchText = document.getElementById('productSearch').value.toLowerCase().trim();
        const tbody = document.getElementById('productsTable');
        const rows = tbody.getElementsByTagName('tr');
        
        // Bo'sh qidiruv - barchasini ko'rsat, highlight yo'q
        if (!searchText) {
            for (let i = 0; i < rows.length; i++) {
                const productNameCell = rows[i].getElementsByTagName('td')[0];
                if (productNameCell) {
                    // Highlight ni olib tashlash
                    const originalText = productNameCell.getAttribute('data-original-text') || productNameCell.textContent;
                    productNameCell.innerHTML = originalText;
                }
                rows[i].style.display = '';
            }
            return;
        }
        
        // Regex maxsus belgilarini escape qilish
        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // Qidiruv so'zlarini ajratish (bo'shliq bilan)
        const searchWords = searchText.split(/\s+/).filter(word => word.length > 0);
        
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const productNameCell = row.getElementsByTagName('td')[0];
            
            if (productNameCell) {
                // Original textni saqlash
                if (!productNameCell.getAttribute('data-original-text')) {
                    productNameCell.setAttribute('data-original-text', productNameCell.textContent);
                }
                
                const originalText = productNameCell.getAttribute('data-original-text');
                const textValue = originalText.toLowerCase();
                
                // Barcha so'zlar topilishi kerak
                const allWordsFound = searchWords.every(word => textValue.indexOf(word) > -1);
                
                if (allWordsFound) {
                    row.style.display = '';
                    
                    // Highlight qilish - barcha so'zlarni bir vaqtda
                    let highlightedText = originalText;
                    
                    // Barcha so'zlarni alternation bilan birlashtirib bir marta replace qilish
                    if (searchWords.length > 0) {
                        const escapedWords = searchWords.map(word => escapeRegex(word));
                        const combinedPattern = escapedWords.join('|');
                        const regex = new RegExp(`(${combinedPattern})`, 'gi');
                        highlightedText = highlightedText.replace(regex, '<span style="background-color: #ffeb3b; padding: 2px 4px; border-radius: 2px;">$1</span>');
                    }
                    
                    productNameCell.innerHTML = highlightedText;
                } else {
                    row.style.display = 'none';
                }
            }
        }
    }
    
    // Narxni formatlash
    function formatPrice(price) {
        if (!price) return '0';
        return Number(price).toLocaleString('uz-UZ');
    }
    
    // Sahifa yuklanganda joylashuvlarni yuklash
    document.addEventListener('DOMContentLoaded', function() {
        loadLocations();
        loadCustomers();
        loadExchangeRate();
        
        // Mahsulot qidirish input'ga event listener qo'shish
        const productSearchInput = document.getElementById('productSearch');
        if (productSearchInput) {
            productSearchInput.addEventListener('input', filterProducts);
        }
        
        // Mijoz qidirish input'ga event listener qo'shish
        const customerSearchInput = document.getElementById('customerSearch');
        console.log('🔧 customerSearchInput elementi:', customerSearchInput);
        if (customerSearchInput) {
            console.log('✅ Event listener qo\'shilmoqda...');
            customerSearchInput.addEventListener('input', function() {
                console.log('⌨️ Input event: ', this.value);
                searchCustomers(this.value);
            });
        } else {
            console.error('❌ customerSearch elementi topilmadi!');
        }
        
        // USD narx o'zgarganda avtomatik UZS hisoblash
        document.getElementById('modalPriceUSD').addEventListener('input', updateUZSPrice);
        
        // UZS narx o'zgarganda avtomatik USD hisoblash
        document.getElementById('modalPriceUZS').addEventListener('input', updateUSDPrice);
        
        // To'lov modal oynasida USD dan UZS ga avtomatik konversiya
        document.getElementById('paymentCashUSD').addEventListener('input', function() {
            const usd = parseFloat(this.value) || 0;
            document.getElementById('paymentCashUZS').value = Math.round(usd * exchangeRate);
        });
        
        document.getElementById('paymentClickUSD').addEventListener('input', function() {
            const usd = parseFloat(this.value) || 0;
            document.getElementById('paymentClickUZS').value = Math.round(usd * exchangeRate);
        });
        
        document.getElementById('paymentTerminalUSD').addEventListener('input', function() {
            const usd = parseFloat(this.value) || 0;
            document.getElementById('paymentTerminalUZS').value = Math.round(usd * exchangeRate);
        });
        
        document.getElementById('paymentDebtUSD').addEventListener('input', function() {
            const usd = parseFloat(this.value) || 0;
            document.getElementById('paymentDebtUZS').value = Math.round(usd * exchangeRate);
        });
        
        // To'lov modal oynasida UZS dan USD ga avtomatik konversiya
        document.getElementById('paymentCashUZS').addEventListener('input', function() {
            const uzs = parseFloat(this.value) || 0;
            document.getElementById('paymentCashUSD').value = (uzs / exchangeRate).toFixed(2);
        });
        
        document.getElementById('paymentClickUZS').addEventListener('input', function() {
            const uzs = parseFloat(this.value) || 0;
            document.getElementById('paymentClickUSD').value = (uzs / exchangeRate).toFixed(2);
        });
        
        document.getElementById('paymentTerminalUZS').addEventListener('input', function() {
            const uzs = parseFloat(this.value) || 0;
            document.getElementById('paymentTerminalUSD').value = (uzs / exchangeRate).toFixed(2);
        });
        
        document.getElementById('paymentDebtUZS').addEventListener('input', function() {
            const uzs = parseFloat(this.value) || 0;
            document.getElementById('paymentDebtUSD').value = (uzs / exchangeRate).toFixed(2);
        });
        
        // Input focus bo'lganda dropdown'ni ko'rsatish
        const customerSearchInput2 = document.getElementById('customerSearch');
        if (customerSearchInput2) {
            customerSearchInput2.addEventListener('focus', function() {
                if (this.value.length >= 2) {
                    searchCustomers(this.value);
                }
            });
        }
        
        // Dropdown tashqarisiga bosilganda yopish
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('customerDropdown');
            const input = document.getElementById('customerSearch');
            if (e.target !== input && e.target !== dropdown && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        console.log('✅ Sales sahifasi tayyor');
    });
    
    // Savatni tozalash
    function clearCart() {
        if (cart.length === 0) {
            alert('Savat allaqachon bo\'sh!');
            return;
        }
        if (confirm('Savatni tozalashni xohlaysizmi?')) {
            cart = [];
            updateCart();
            console.log('🗑️ Savat tozalandi');
        }
    }
    
    // Keyinroq tasdiqlash
    function savePending() {
        if (cart.length === 0) {
            alert('Savat bo\'sh!');
            return;
        }
        // Bu yerda pending sales API'ga saqlash kerak
        alert('Savdo keyinroq tasdiqlash uchun saqlandi!');
        console.log('⏸️ Savdo pending holatga o\'tkazildi');
    }
    
    // Savdoni yakunlash
    function completeSale() {
        if (cart.length === 0) {
            alert('Savat bo\'sh!');
            return;
        }
        
        const customerId = document.getElementById('selectedCustomerId').value;
        if (!customerId) {
            alert('Mijozni tanlang!');
            return;
        }
        
        // Jami summani hisoblash
        let totalUSD = 0;
        cart.forEach(item => {
            totalUSD += item.priceUSD * item.quantity;
        });
        
        const totalUZS = totalUSD * exchangeRate;
        
        // To'lov modal oynasini ochish
        document.getElementById('paymentCashUSD').value = totalUSD.toFixed(2);
        document.getElementById('paymentCashUZS').value = '0';
        document.getElementById('paymentClickUSD').value = '0.00';
        document.getElementById('paymentClickUZS').value = '0';
        document.getElementById('paymentTerminalUSD').value = '0.00';
        document.getElementById('paymentTerminalUZS').value = '0';
        document.getElementById('paymentDebtUSD').value = '0.00';
        document.getElementById('paymentDebtUZS').value = '0';
        document.getElementById('paymentModal').style.display = 'flex';
        console.log('💳 To\'lov modali ochildi');
    }
    
    // To'lov modal oynasini yopish
    function closePaymentModal() {
        document.getElementById('paymentModal').style.display = 'none';
    }
    
    // Qolgan summani maydonga qo'shish
    function addRemainingToField(fieldId) {
        // Jami summani hisoblash
        let totalUSD = 0;
        cart.forEach(item => {
            totalUSD += item.priceUSD * item.quantity;
        });
        
        // Hozirgi to'lovlarni hisoblash (USD + UZS/kurs)
        const cashUSD = parseFloat(document.getElementById('paymentCashUSD').value) || 0;
        const cashUZS = parseFloat(document.getElementById('paymentCashUZS').value) || 0;
        const clickUSD = parseFloat(document.getElementById('paymentClickUSD').value) || 0;
        const clickUZS = parseFloat(document.getElementById('paymentClickUZS').value) || 0;
        const terminalUSD = parseFloat(document.getElementById('paymentTerminalUSD').value) || 0;
        const terminalUZS = parseFloat(document.getElementById('paymentTerminalUZS').value) || 0;
        const debtUSD = parseFloat(document.getElementById('paymentDebtUSD').value) || 0;
        const debtUZS = parseFloat(document.getElementById('paymentDebtUZS').value) || 0;
        
        const cash = cashUSD + (cashUZS / exchangeRate);
        const click = clickUSD + (clickUZS / exchangeRate);
        const terminal = terminalUSD + (terminalUZS / exchangeRate);
        const debt = debtUSD + (debtUZS / exchangeRate);
        
        const currentTotal = cash + click + terminal + debt;
        const remaining = totalUSD - currentTotal;
        
        if (remaining > 0) {
            const currentValue = parseFloat(document.getElementById(fieldId).value) || 0;
            document.getElementById(fieldId).value = (currentValue + remaining).toFixed(2);
            console.log(`➕ Qolgan $${remaining.toFixed(2)} ${fieldId} ga qo'shildi`);
        } else {
            console.log('✅ To\'lov to\'liq');
        }
    }
    
    // To'lovni tasdiqlash
    function confirmPayment() {
        const cashUSD = parseFloat(document.getElementById('paymentCashUSD').value) || 0;
        const cashUZS = parseFloat(document.getElementById('paymentCashUZS').value) || 0;
        const clickUSD = parseFloat(document.getElementById('paymentClickUSD').value) || 0;
        const clickUZS = parseFloat(document.getElementById('paymentClickUZS').value) || 0;
        const terminalUSD = parseFloat(document.getElementById('paymentTerminalUSD').value) || 0;
        const terminalUZS = parseFloat(document.getElementById('paymentTerminalUZS').value) || 0;
        const debtUSD = parseFloat(document.getElementById('paymentDebtUSD').value) || 0;
        const debtUZS = parseFloat(document.getElementById('paymentDebtUZS').value) || 0;
        
        const cash = cashUSD + (cashUZS / exchangeRate);
        const click = clickUSD + (clickUZS / exchangeRate);
        const terminal = terminalUSD + (terminalUZS / exchangeRate);
        const debt = debtUSD + (debtUZS / exchangeRate);
        
        // Jami summani hisoblash
        let totalUSD = 0;
        cart.forEach(item => {
            totalUSD += item.priceUSD * item.quantity;
        });
        
        const totalPayment = cash + click + terminal + debt;
        const paymentWarning = document.getElementById('paymentWarning');
        
        // To'lov tekshiruvi
        if (Math.abs(totalPayment - totalUSD) > 0.01) {
            paymentWarning.textContent = `⚠️ Jami to'lov ($${totalPayment.toFixed(2)}) savdo summasiga ($${totalUSD.toFixed(2)}) teng emas!`;
            paymentWarning.style.display = 'block';
            return;
        }
        
        // Bu yerda savdoni backend'ga yuborish kerak
        const saleData = {
            customer_id: document.getElementById('selectedCustomerId').value,
            items: cart,
            payment: {
                cash: { usd: cashUSD, uzs: cashUZS },
                click: { usd: clickUSD, uzs: clickUZS },
                terminal: { usd: terminalUSD, uzs: terminalUZS },
                debt: { usd: debtUSD, uzs: debtUZS }
            },
            total_usd: totalUSD,
            exchange_rate: exchangeRate
        };
        
        console.log('✅ Savdo tasdiqlandi:', saleData);
        alert('Savdo muvaffaqiyatli yakunlandi!');
        
        // Savatni tozalash va modal yopish
        cart = [];
        updateCart();
        closePaymentModal();
        
        // Mijoz ma'lumotlarini tozalash
        document.getElementById('customerSearch').value = '';
        document.getElementById('selectedCustomerId').value = '';
        document.getElementById('cartCustomerInfo').innerHTML = '<h3 style="margin: 0; color: #333;">🛒 Savdo Korzinasi</h3>';
    }
</script>
{% endblock %}
