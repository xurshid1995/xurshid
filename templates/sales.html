{% extends "base_with_sidebar.html" %}

{% block title %}Savdo - Dokon Boshqaruv Tizimi{% endblock %}

{% block extra_css %}
<style>
    .sales-container {
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #dee2e6;
    }

    .page-header h1 {
        margin: 0;
        color: #333;
        font-size: 24px;
    }
</style>
{% endblock %}

{% block content %}
<div class="sales-container">
    <div class="page-header">
        <h1>🛒 Savdo Sahifasi</h1>
    </div>

    <!-- Ikkita 665px kenglikda layout -->
    <div style="display: grid; grid-template-columns: 665px 665px; gap: 20px; justify-content: center; padding: 20px; align-items: start;">
        <!-- Birinchi layout -->
        <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 665px; box-sizing: border-box;">
            <!-- Joylashuv va Mijoz tanlash -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500; color: #495057;">📍 Joylashuvni tanlang</label>
                    <select id="locationSelect" onchange="loadProducts()" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; background: white; cursor: pointer;">
                        <option value="">Tanlang...</option>
                    </select>
                </div>
                <div style="position: relative;">
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500; color: #495057;">👤 Mijoz (ixtiyoriy)</label>
                    <input type="text" id="customerSearch" placeholder="Mijoz nomini kiriting..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <div id="customerDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ced4da; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
                    <input type="hidden" id="selectedCustomerId" value="">
                </div>
            </div>
            
            <!-- Universal Qidiruv maydoni (Barcode + Mahsulot) -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500; color: #495057;">🔍 Barcode yoki mahsulot nomi</label>
                <div style="position: relative;">
                    <input type="text" 
                           id="universalSearch" 
                           placeholder="Barcode skanerlang yoki mahsulot nomini kiriting..." 
                           autocomplete="off"
                           style="width: 100%; padding: 10px 10px 10px 40px; border: 2px solid #28a745; border-radius: 6px; font-size: 14px; background: white;">
                    <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px;">📷</span>
                    <div id="searchStatus" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 5px; padding: 8px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; font-size: 12px; color: #155724; z-index: 100;">
                        ✓ Mahsulot topildi!
                    </div>
                </div>
            </div>
            
            <!-- Mahsulotlar jadvali -->
            <div style="width: 625px; overflow-x: auto;">
                <table class="sales-product-table" style="width: 620px !important; min-width: 620px !important; max-width: 620px !important; border-collapse: collapse; table-layout: fixed !important;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 10px 8px; text-align: left; font-size: 14px; font-weight: 600; color: #495057; width: 320px; box-sizing: border-box;">Mahsulot</th>
                            <th style="padding: 10px 8px; text-align: center; font-size: 14px; color: #495057; width: 60px; box-sizing: border-box;">Mavjud</th>
                            <th style="padding: 10px 8px; text-align: left; font-size: 14px; color: #495057; width: 200px; box-sizing: border-box;">Narx</th>
                            <th style="padding: 2px; text-align: center; font-size: 14px; color: #495057; width: 40px; box-sizing: border-box;">Amal</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 30px; color: #999;">
                                Joylashuvni tanlang
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Ikkinchi layout -->
        <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 665px; box-sizing: border-box;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div id="cartCustomerInfo">
                    <h3 style="margin: 0; color: #333;">🛒 Savdo Korzinasi</h3>
                </div>
                <div id="cartTotalHeader" style="text-align: right;"></div>
            </div>
            <div id="cartContainer">
                <div style="width: 620px; overflow-x: auto;">
                    <table class="cart-table" style="width: 620px !important; max-width: 620px !important; border-collapse: collapse; margin-bottom: 15px; table-layout: fixed !important;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 8px 5px; text-align: left; font-size: 14px; font-weight: 600; color: #495057; width: 312px;">Mahsulot</th>
                                <th style="padding: 8px 5px; text-align: center; font-size: 14px; color: #495057; width: 84px;">Soni</th>
                                <th style="padding: 8px 5px; text-align: right; font-size: 14px; color: #495057; width: 90px;">Narxi</th>
                                <th style="padding: 8px 5px; text-align: right; font-size: 14px; color: #495057; width: 94px;">Jami</th>
                                <th style="padding: 8px 5px; text-align: center; font-size: 14px; color: #495057; width: 40px;">Amal</th>
                            </tr>
                        </thead>
                        <tbody id="cartItems">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 50px; color: #999;">Savat bo'sh</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="cartTotal" style="border-top: 2px solid #dee2e6; padding-top: 10px; font-weight: bold; font-size: 16px; text-align: right;"></div>
                
                <!-- Tugmalar -->
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="clearCart()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">🗑️ Tozalash</button>
                    <button onclick="savePending()" style="background: #ffc107; color: #333; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">⏸️ Keyinroq tasdiqlash</button>
                    <button onclick="completeSale()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">✅ Yakunlash</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- To'lov modal oyna -->
    <div id="paymentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 8px; padding: 30px; width: 650px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #333;">💳 To'lov turlari</h3>
                <div id="paymentModalTotal" style="text-align: right;">
                    <div style="font-size: 12px; color: #666;">Jami summa:</div>
                    <div style="font-weight: 700; color: #28a745; font-size: 16px;"><span id="paymentModalTotalUSD">$0.00</span> / <span id="paymentModalTotalUZS">0 so'm</span></div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-weight: 500; white-space: nowrap; min-width: 90px;">💵 Naxt:</label>
                    <input type="number" id="paymentCashUSD" step="0.01" value="0.00" placeholder="$" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <input type="number" id="paymentCashUZS" step="1" value="0" placeholder="UZS" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <button onclick="addRemainingToField('paymentCashUSD')" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; white-space: nowrap;">+ Qolgan</button>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-weight: 500; white-space: nowrap; min-width: 90px;">📱 Click:</label>
                    <input type="number" id="paymentClickUSD" step="0.01" value="0.00" placeholder="$" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <input type="number" id="paymentClickUZS" step="1" value="0" placeholder="UZS" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <button onclick="addRemainingToField('paymentClickUSD')" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; white-space: nowrap;">+ Qolgan</button>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-weight: 500; white-space: nowrap; min-width: 90px;">🏧 Terminal:</label>
                    <input type="number" id="paymentTerminalUSD" step="0.01" value="0.00" placeholder="$" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <input type="number" id="paymentTerminalUZS" step="1" value="0" placeholder="UZS" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <button onclick="addRemainingToField('paymentTerminalUSD')" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; white-space: nowrap;">+ Qolgan</button>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-weight: 500; white-space: nowrap; min-width: 90px;">📋 Qarz:</label>
                    <input type="number" id="paymentDebtUSD" step="0.01" value="0.00" placeholder="$" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <input type="number" id="paymentDebtUZS" step="1" value="0" placeholder="UZS" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <button onclick="addRemainingToField('paymentDebtUSD')" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; white-space: nowrap;">+ Qolgan</button>
                </div>
            </div>
            
            <div id="paymentWarning" style="display: none; padding: 10px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin-bottom: 15px; color: #856404; font-size: 14px;"></div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="closePaymentModal()" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">Bekor qilish</button>
                <button onclick="confirmPayment()" style="flex: 1; padding: 12px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">✅ Tasdiqlash</button>
            </div>
        </div>
    </div>
    
    <!-- Modal oyna -->
    <div id="quantityModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 8px; padding: 30px; width: 450px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h3 style="margin: 0 0 20px 0; color: #333;">Mahsulot ma'lumotlari</h3>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">📦 Mahsulot:</label>
                <div id="modalProductName" style="padding: 10px; background: #f8f9fa; border-radius: 4px; font-weight: 500;"></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">📊 Mavjud:</label>
                    <input type="number" id="modalAvailable" readonly style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; background: #e9ecef;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">🔢 Miqdor:</label>
                    <input type="number" id="modalQuantity" min="1" value="0" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">💵 Sotish narxi ($):</label>
                    <input type="number" id="modalPriceUSD" step="0.01" value="0.00" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">💰 Sotish narxi (UZS):</label>
                    <input type="number" id="modalPriceUZS" step="100" value="0" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="closeModal()" style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Bekor qilish</button>
                <button onclick="confirmAddToCart()" style="flex: 1; padding: 10px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Qo'shish</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Joylashuvlarni yuklash
    async function loadLocations() {
        try {
            const response = await fetch('/api/locations');
            const locations = await response.json();
            
            const locationSelect = document.getElementById('locationSelect');
            locationSelect.innerHTML = '<option value="">Tanlang...</option>';
            
            locations.forEach(location => {
                const option = document.createElement('option');
                option.value = `${location.type}_${location.id}`;
                const locationType = location.type === 'warehouse' ? '🏭 Ombor' : '🏪 Do\'kon';
                option.textContent = `${locationType}: ${location.name}`;
                locationSelect.appendChild(option);
            });
            
            console.log(`✅ ${locations.length} ta joylashuv yuklandi`);
        } catch (error) {
            console.error('Joylashuvlarni yuklashda xatolik:', error);
        }
    }
    
    // BARCODE SCANNER FUNKSIYASI
    let barcodeBuffer = '';
    let barcodeTimeout = null;
    
    async function searchProductByBarcode(barcode) {
        console.log('🔍 Barcode qidiruvi:', barcode);
        
        // Joylashuv tanlanganligini tekshirish
        if (!selectedLocationId || !selectedLocationType) {
            showBarcodeStatus('⚠️ Avval joylashuvni tanlang!', 'error');
            return;
        }
        
        showBarcodeStatus('⏳ Qidirilmoqda...', 'loading');
        
        try {
            const response = await fetch('/api/search-product-by-barcode', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    barcode: barcode,
                    location_type: selectedLocationType,
                    location_id: selectedLocationId
                })
            });
            
            const product = await response.json();
            
            if (!response.ok) {
                showBarcodeStatus(`❌ ${product.error || 'Mahsulot topilmadi'}`, 'error');
                // Barcode inputni tozalash
                document.getElementById('barcodeInput').value = '';
                return;
            }
            
            console.log('✅ Mahsulot topildi:', product);
            
            // Mahsulotni avtomatik savatga qo'shish
            showBarcodeStatus(`✓ ${product.name} topildi!`, 'success');
            
            // 1 soniyadan keyin avtomatik savatga qo'shish
            setTimeout(() => {
                addToCart(product.id, product.name, product.available_quantity, product.sell_price);
                // Universal qidiruv inputini tozalash
                document.getElementById('universalSearch').value = '';
                // Statusni yashirish
                document.getElementById('searchStatus').style.display = 'none';
            }, 500);
            
        } catch (error) {
            console.error('❌ Barcode qidiruv xatosi:', error);
            showBarcodeStatus('❌ Server xatosi', 'error');
            document.getElementById('universalSearch').value = '';
        }
    }
    
    function showBarcodeStatus(message, type) {
        const statusDiv = document.getElementById('searchStatus');
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
        
        // Rang o'zgartirish
        if (type === 'success') {
            statusDiv.style.background = '#d4edda';
            statusDiv.style.borderColor = '#c3e6cb';
            statusDiv.style.color = '#155724';
        } else if (type === 'error') {
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.borderColor = '#f5c6cb';
            statusDiv.style.color = '#721c24';
        } else if (type === 'loading') {
            statusDiv.style.background = '#d1ecf1';
            statusDiv.style.borderColor = '#bee5eb';
            statusDiv.style.color = '#0c5460';
        }
        
        // Agar error yoki success bo'lsa, 3 soniyadan keyin yashirish
        if (type === 'error' || type === 'success') {
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
    }
    
    // Universal qidiruv maydoni (Barcode + Mahsulot)
    document.addEventListener('DOMContentLoaded', function() {
        const universalSearch = document.getElementById('universalSearch');
        
        // Keyboard navigation
        universalSearch.addEventListener('keydown', function(e) {
            // Klaviatura navigatsiyasi
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                navigateProductTable('down');
                return;
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                navigateProductTable('up');
                return;
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const searchValue = universalSearch.value.trim();
                
                // Agar mahsulot tanlangan bo'lsa, uni savatga qo'shish
                if (currentSelectedRowIndex >= 0 && visibleProductRows[currentSelectedRowIndex]) {
                    selectProductFromTable(visibleProductRows[currentSelectedRowIndex]);
                    return;
                }
                
                // Aks holda qidiruv
                if (searchValue) {
                    // Agar faqat raqamlar bo'lsa va uzunligi barcode ga o'xshasa - barcode qidirish
                    if (/^\d+$/.test(searchValue) && searchValue.length >= 8) {
                        searchProductByBarcode(searchValue);
                    }
                }
                return;
            } else if (e.key === 'Escape') {
                e.preventDefault();
                clearProductSelection();
                universalSearch.value = '';
                filterProducts();
                return;
            }
        });
        
        // Barcode scanner ko'pincha enter tugmasini avtomatik bosadi
        universalSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                // keydown da ishlov beriladi
            }
        });
        
        // Klaviaturadan kiritish (Bluetooth scanner uchun)
        universalSearch.addEventListener('input', function(e) {
            const value = e.target.value.trim();
            
            // Reset navigatsiya
            clearProductSelection();
            
            // Agar faqat raqamlar bo'lsa va scanner tez yozayotgan bo'lsa (buffer)
            if (/^\d+$/.test(value)) {
                clearTimeout(barcodeTimeout);
                barcodeTimeout = setTimeout(() => {
                    if (value.length >= 8) { // Minimal barcode uzunligi (8+)
                        searchProductByBarcode(value);
                    }
                }, 100); // 100ms kutish - scanner tez yozadi
            } else {
                // Matn kiritilsa - mahsulot qidirish
                filterProducts();
            }
        });
        
        // Focus qilganda eski ma'lumotni tozalash
        universalSearch.addEventListener('focus', function() {
            document.getElementById('searchStatus').style.display = 'none';
        });
    });
    
    // Mijozlarni yuklash va qidirish
    let allCustomers = [];
    let cart = [];
    let currentProduct = null;
    let selectedLocationId = null;
    let selectedLocationType = null;
    
    // Tahrirlash rejimi uchun
    let editingSaleId = null;  // Agar savdo tahrirlanyotgan bo'lsa, ID saqlanadi
    
    // Autosave uchun
    let currentPendingSaleId = null;  // Hozirgi pending savdo ID
    let autosaveTimeout = null;  // Debounce uchun
    
    // Klaviatura navigatsiyasi uchun o'zgaruvchilar
    let visibleProductRows = [];
    let currentSelectedRowIndex = -1;
    
    // Mijoz qidiruv klaviatura navigatsiyasi uchun
    let filteredCustomers = [];
    let selectedCustomerIndex = -1;
    
    async function loadCustomers() {
        try {
            console.log('🔄 Mijozlarni yuklash boshlandi...');
            const response = await fetch('/api/customers');
            console.log('📡 API response status:', response.status);
            if (!response.ok) {
                console.error('❌ Mijozlarni yuklashda xatolik: HTTP', response.status);
                return;
            }
            const data = await response.json();
            console.log('📦 API response data:', data);
            // API to'g'ridan-to'g'ri array qaytaradi
            allCustomers = Array.isArray(data) ? data : (data.customers || []);
            console.log(`✅ ${allCustomers.length} ta mijoz yuklandi`, allCustomers);
        } catch (error) {
            console.error('❌ Mijozlarni yuklashda xatolik:', error);
        }
    }
    
    function searchCustomers(searchText) {
        console.log('🔍 searchCustomers chaqirildi:', searchText, 'Jami mijozlar:', allCustomers.length);
        const dropdown = document.getElementById('customerDropdown');
        selectedCustomerIndex = -1;
        
        if (!searchText || searchText.length < 2) {
            console.log('⚠️ Qidiruv matni 2 ta belgidan kam');
            dropdown.style.display = 'none';
            filteredCustomers = [];
            return;
        }
        
        filteredCustomers = allCustomers.filter(customer => {
            const name = customer.name ? customer.name.toLowerCase() : '';
            const phone = customer.phone ? customer.phone : '';
            const search = searchText.toLowerCase();
            
            // Telefon raqamdan barcha maxsus belgilarni olib tashlash
            const cleanPhone = phone.replace(/[\s\-\(\)\+]/g, '');
            const cleanSearch = search.replace(/[\s\-\(\)\+]/g, '');
            
            return name.includes(search) || cleanPhone.includes(cleanSearch);
        });
        
        console.log('📋 Filterlangan mijozlar soni:', filteredCustomers.length);
        
        if (filteredCustomers.length === 0) {
            dropdown.innerHTML = '<div style="padding: 10px; color: #999; text-align: center;">Mijoz topilmadi</div>';
            dropdown.style.display = 'block';
            return;
        }
        
        renderCustomerDropdown();
        dropdown.style.display = 'block';
    }
    
    function renderCustomerDropdown() {
        const dropdown = document.getElementById('customerDropdown');
        dropdown.innerHTML = filteredCustomers.map((customer, index) => {
            const isSelected = index === selectedCustomerIndex;
            const bgColor = isSelected ? '#2196F3' : 'white';
            const hoverBg = isSelected ? '#2196F3' : '#f8f9fa';
            const textColor = isSelected ? 'white' : '#333';
            const phoneColor = isSelected ? 'white' : '#6c757d';
            return `<div onclick="selectCustomer(${customer.id}, '${customer.name.replace(/'/g, "\\'")}', '${customer.phone || ''}')" 
                    class="customer-item" data-index="${index}"
                    style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: all 0.2s; background: ${bgColor};"
                    onmouseover="this.style.background='${hoverBg}'"
                    onmouseout="this.style.background='${bgColor}'">
                    <div style="font-weight: 500; color: ${textColor};">${customer.name}</div>
                    <div style="font-size: 12px; color: ${phoneColor};">${customer.phone || 'Telefon yo\'q'}</div>
                </div>`;
        }).join('');
    }
    
    function navigateCustomerDropdown(direction) {
        if (filteredCustomers.length === 0) return;
        
        if (direction === 'down') {
            selectedCustomerIndex = (selectedCustomerIndex + 1) % filteredCustomers.length;
        } else if (direction === 'up') {
            selectedCustomerIndex = selectedCustomerIndex <= 0 ? filteredCustomers.length - 1 : selectedCustomerIndex - 1;
        }
        
        renderCustomerDropdown();
        
        // Scroll to selected item
        const dropdown = document.getElementById('customerDropdown');
        const selectedItem = dropdown.querySelector(`[data-index="${selectedCustomerIndex}"]`);
        if (selectedItem) {
            selectedItem.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
    }
    
    function selectCurrentCustomer() {
        if (selectedCustomerIndex >= 0 && selectedCustomerIndex < filteredCustomers.length) {
            const customer = filteredCustomers[selectedCustomerIndex];
            selectCustomer(customer.id, customer.name, customer.phone || '');
        }
    }
    
    function selectCustomer(id, name, phone) {
        const displayText = phone ? `${name} - ${phone}` : name;
        document.getElementById('customerSearch').value = displayText;
        document.getElementById('selectedCustomerId').value = id;
        document.getElementById('customerDropdown').style.display = 'none';
        
        // Savdo korzinasi sarlavhasida mijoz ma'lumotlarini ko'rsatish
        const cartCustomerInfo = document.getElementById('cartCustomerInfo');
        const customerDisplay = phone ? `👤 ${name} ${phone}` : `👤 ${name}`;
        cartCustomerInfo.innerHTML = `<h3 style="margin: 0; color: #333; font-size: 15px; font-weight: 600;">${customerDisplay}</h3>`;
        
        console.log(`✅ Mijoz tanlandi: ${name} (ID: ${id})`);
        
        // Fokusni mahsulot qidirish maydoniga o'tkazish
        const universalSearch = document.getElementById('universalSearch');
        if (universalSearch) {
            setTimeout(() => universalSearch.focus(), 100);
        }
    }
    
    // Mahsulotlarni yuklash
    async function loadProducts() {
        const locationSelect = document.getElementById('locationSelect');
        const tbody = document.getElementById('productsTable');
        
        const locationValue = locationSelect.value;
        
        if (!locationValue) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px; color: #999;">Joylashuvni tanlang</td></tr>';
            selectedLocationId = null;
            selectedLocationType = null;
            return;
        }
        
        // Tanlangan joylashuvni saqlash
        const [type, id] = locationValue.split('_');
        selectedLocationType = type;
        selectedLocationId = parseInt(id);
        
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">⏳ Yuklanmoqda...</td></tr>';
        
        try {
            const response = await fetch(`/api/products?location=${locationValue}`);
            const data = await response.json();
            
            console.log('API response:', data);
            
            // API dan kelgan ma'lumotni tekshirish
            const products = Array.isArray(data) ? data : (data.products || []);
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">Mahsulotlar topilmadi</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            products.forEach(product => {
                // Quantity va selling price ni olish
                let quantity = 0;
                let sellingPrice = product.sell_price || product.price || 0;
                
                // Agar stocks mavjud bo'lsa, locationga mos keladiganini topish
                if (product.stocks && product.stocks.length > 0) {
                    const [type, id] = locationValue.split('_');
                    const locationId = parseInt(id);
                    
                    // Mos stock ni topish
                    const matchingStock = product.stocks.find(stock => {
                        if (type === 'warehouse') {
                            return stock.warehouse_id === locationId;
                        } else if (type === 'store') {
                            return stock.store_id === locationId;
                        }
                        return false;
                    });
                    
                    if (matchingStock) {
                        quantity = matchingStock.quantity || 0;
                    }
                }
                
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #f0f0f0';
                row.setAttribute('data-product-id', product.id);
                const productName = product.name || `Mahsulot #${product.id}`;
                const safeProductName = productName.replace(/'/g, "\\'");
                row.innerHTML = `
                    <td style="padding: 12px 8px; font-size: 14px; color: #333;" data-original-text="${productName}" title="${productName}">${productName}</td>
                    <td style="padding: 12px 8px; text-align: left; font-size: 14px;">
                        <span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 0; font-weight: 500; display: inline-block;">${quantity}</span>
                    </td>
                    <td style="padding: 12px 8px; text-align: left; font-size: 14px;">
                        <span style="background: #ffc107; color: white; padding: 4px 8px; border-radius: 0; font-weight: 500; margin-right: 6px; display: inline-block;">$${formatPrice(sellingPrice)}</span>
                        <span style="background: #5cb3ff; color: white; padding: 4px 8px; border-radius: 0; font-weight: 500; display: inline-block;">${formatPrice(sellingPrice * exchangeRate)} so'm</span>
                    </td>
                    <td style="padding: 2px; text-align: center; font-size: 14px;">
                        <button onclick="addToCart(${product.id}, '${safeProductName}', ${quantity}, ${sellingPrice})" style="background: transparent; color: #333; border: none; padding: 4px 8px; cursor: pointer; font-size: 18px;">➡️</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`✅ ${products.length} ta mahsulot yuklandi`);
        } catch (error) {
            console.error('Mahsulotlarni yuklashda xatolik:', error);
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #dc3545;">⚠️ Xatolik yuz berdi</td></tr>';
        }
    }
    
    // Valyuta kursi (global o'zgaruvchi)
    let exchangeRate = 12700; // Default kurs
    
    // Valyuta kursini olish
    async function loadExchangeRate() {
        try {
            const response = await fetch('/api/currency-rate');
            const data = await response.json();
            if (data.success && data.rate && data.rate.rate) {
                const newRate = parseFloat(data.rate.rate);
                if (!isNaN(newRate) && newRate > 0) {
                    exchangeRate = newRate;
                    console.log('✅ Valyuta kursi yuklandi:', exchangeRate);
                } else {
                    console.warn('⚠️ Noto\'g\'ri kurs qiymati, default ishlatiladi:', exchangeRate);
                }
            } else {
                console.warn('⚠️ Kurs ma\'lumoti topilmadi, default ishlatiladi:', exchangeRate);
            }
        } catch (error) {
            console.error('❌ Kursni yuklashda xatolik, default ishlatiladi:', exchangeRate, error);
        }
    }
    
    // USD dan UZS ga avtomatik konversiya
    function updateUZSPrice() {
        const usdInput = document.getElementById('modalPriceUSD');
        const uzsInput = document.getElementById('modalPriceUZS');
        
        if (!usdInput || !uzsInput) {
            console.error('❌ Modal input elementlari topilmadi');
            return;
        }
        
        const usdPrice = parseFloat(usdInput.value) || 0;
        const uzsPrice = usdPrice * exchangeRate;
        uzsInput.value = Math.round(uzsPrice);
        
        console.log('💱 Konversiya (USD→UZS):', usdPrice, 'USD ×', exchangeRate, '=', Math.round(uzsPrice), 'UZS');
    }
    
    // UZS dan USD ga avtomatik konversiya
    function updateUSDPrice() {
        const usdInput = document.getElementById('modalPriceUSD');
        const uzsInput = document.getElementById('modalPriceUZS');
        
        if (!usdInput || !uzsInput) {
            console.error('❌ Modal input elementlari topilmadi');
            return;
        }
        
        const uzsPrice = parseFloat(uzsInput.value) || 0;
        const usdPrice = uzsPrice / exchangeRate;
        usdInput.value = usdPrice.toFixed(2);
        
        console.log('💱 Konversiya (UZS→USD):', uzsPrice, 'UZS ÷', exchangeRate, '=', usdPrice.toFixed(2), 'USD');
    }
    
    // Modal ochish
    function addToCart(productId, productName, quantity, price) {
        currentProduct = { id: productId, name: productName, available: quantity, price: price };
        
        document.getElementById('modalProductName').textContent = productName;
        document.getElementById('modalAvailable').value = quantity;
        document.getElementById('modalQuantity').value = 1;
        document.getElementById('modalQuantity').max = quantity;
        document.getElementById('modalPriceUSD').value = price.toFixed(2);
        updateUZSPrice();
        
        document.getElementById('quantityModal').style.display = 'flex';
        
        // Fokusni miqdor maydoniga berish
        setTimeout(() => {
            const quantityInput = document.getElementById('modalQuantity');
            if (quantityInput) {
                quantityInput.focus();
                quantityInput.select(); // Matnni belgilash
            }
        }, 100);
    }
    
    // To'g'ridan-to'g'ri savatga qo'shish (modal ochmasdan) - savdo tahrirlash uchun
    function addToCartDirectly(productId, productName, quantity, priceUSD) {
        console.log(`➕ To'g'ridan-to'g'ri savatga qo'shilmoqda: ${productName} x${quantity} = $${priceUSD}`);
        
        // Korzinada allaqachon bor-yo'qligini tekshirish
        const existingIndex = cart.findIndex(item => item.id === productId);
        
        if (existingIndex !== -1) {
            // Mavjud bo'lsa, miqdorni oshirish
            cart[existingIndex].quantity += quantity;
            console.log(`  ✅ Miqdor oshirildi: ${cart[existingIndex].quantity}`);
        } else {
            // Yangi element qo'shish
            const priceUZS = priceUSD * exchangeRate;
            cart.push({
                id: productId,              // 'id' maydon nomi (removeFromCart uchun)
                name: productName,          // 'name' maydon nomi (updateCart uchun)
                quantity: quantity,
                priceUSD: priceUSD,
                priceUZS: priceUZS
            });
            console.log(`  ✅ Yangi element qo'shildi: ${productName}`);
        }
        
        // Korzinani yangilash
        updateCart();
    }
    
    // Modal yopish
    function closeModal() {
        document.getElementById('quantityModal').style.display = 'none';
        currentProduct = null;
        delete window.editingCartIndex; // Tahrirlash rejimini tozalash
        
        // Fokusni universal qidiruv maydoniga qaytarish
        setTimeout(() => {
            const universalSearch = document.getElementById('universalSearch');
            if (universalSearch) {
                universalSearch.focus();
            }
        }, 100);
    }
    
    // Savatga qo'shish
    async function confirmAddToCart() {
        const quantity = parseInt(document.getElementById('modalQuantity').value);
        const priceUSD = parseFloat(document.getElementById('modalPriceUSD').value);
        const priceUZS = parseFloat(document.getElementById('modalPriceUZS').value);
        
        // Agar tahrirlash rejimi bo'lsa - eski elementni o'chirib, yangisini qo'shamiz
        if (typeof window.editingCartIndex !== 'undefined') {
            if (quantity <= 0) {
                alert('Noto\'g\'ri miqdor!');
                return;
            }
            
            if (priceUSD <= 0) {
                alert('Narx kiritilishi shart!');
                return;
            }
            
            // currentProduct tekshiruvi
            if (!currentProduct) {
                alert('Mahsulot ma\'lumotlari topilmadi!');
                return;
            }
            
            if (quantity > currentProduct.available) {
                alert('Stokda yetarli mahsulot yo\'q! Mavjud: ' + currentProduct.available);
                return;
            }
            
            // Stokdan yangi miqdorni ayirish
            try {
                const response = await fetch('/api/reserve-stock', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        product_id: currentProduct.id,
                        quantity: quantity,
                        location_id: selectedLocationId,
                        location_type: selectedLocationType
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    alert(result.error || 'Stokdan ayirib bo\'lmadi!');
                    return;
                }
                console.log('✅ Tahrirlash: stokdan yangi miqdor ayirildi:', quantity, 'dona');
            } catch (error) {
                console.error('Stok ayirish xatosi:', error);
                alert('Stokni yangilashda xatolik!');
                return;
            }
            
            // Savatdagi elementni yangilash
            cart[window.editingCartIndex].quantity = quantity;
            cart[window.editingCartIndex].priceUSD = priceUSD;
            cart[window.editingCartIndex].priceUZS = priceUZS;
            
            delete window.editingCartIndex;
            updateCart();
            closeModal();
            
            // Avtomatik pending savdo yangilash
            await autoSavePending();
            
            // Chap tomondagi mahsulotlar jadvalini yangilash
            await loadProducts();
            
            console.log('✏️ Savat elementi tahrirlandi');
            return;
        }
        
        // Yangi mahsulot qo'shish - currentProduct tekshiruvi
        if (!currentProduct) {
            alert('Mahsulot ma\'lumotlari topilmadi!');
            console.error('❌ currentProduct null holatda');
            return;
        }
        
        if (quantity <= 0 || quantity > currentProduct.available) {
            alert('Noto\'g\'ri miqdor!');
            return;
        }
        
        if (priceUSD <= 0) {
            alert('Narx kiritilishi shart!');
            return;
        }
        
        // Stokdan darhol ayirish
        try {
            const response = await fetch('/api/reserve-stock', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    product_id: currentProduct.id,
                    quantity: quantity,
                    location_id: selectedLocationId,
                    location_type: selectedLocationType
                })
            });
            
            const result = await response.json();
            if (!result.success) {
                alert(result.error || 'Stokdan ayirib bo\'lmadi!');
                return;
            }
            
            console.log('✅ Stokdan ayirildi:', quantity, 'dona');
        } catch (error) {
            console.error('Stok ayirish xatosi:', error);
            alert('Stokni yangilashda xatolik!');
            return;
        }
        
        // Savat ichida mahsulot bormi tekshirish
        const existingItem = cart.find(item => item.id === currentProduct.id);
        
        if (existingItem) {
            const oldQuantity = existingItem.quantity;
            existingItem.quantity += quantity;
            existingItem.priceUSD = priceUSD;
            existingItem.priceUZS = priceUZS;
            console.log(`📦 Mavjud mahsulot miqdori oshirildi: ${oldQuantity} + ${quantity} = ${existingItem.quantity}`);
        } else {
            cart.push({
                id: currentProduct.id,
                name: currentProduct?.name || `Mahsulot #${currentProduct?.id || 'Unknown'}`,
                priceUSD: priceUSD,
                priceUZS: priceUZS,
                quantity: quantity
            });
            console.log(`➕ Yangi mahsulot qo'shildi: ${quantity} dona`);
        }
        
        // currentProduct ma'lumotlarini saqlab qo'yish (closeModal() uni null qiladi)
        const addedProduct = {
            name: currentProduct?.name || `Mahsulot #${currentProduct?.id}`,
            id: currentProduct?.id
        };
        
        updateCart();
        closeModal();
        
        // Avtomatik pending savdo yaratish/yangilash
        await autoSavePending();
        
        // Chap tomondagi mahsulotlar jadvalini yangilash
        await loadProducts();
        
        // Fokusni universal qidiruv maydoniga qaytarish
        setTimeout(() => {
            const universalSearch = document.getElementById('universalSearch');
            if (universalSearch) {
                universalSearch.focus();
                universalSearch.select(); // Matnni belgilash
            }
        }, 200);
        
        console.log('✅ Savatga qo\'shildi:', addedProduct.name, quantity, 'dona, $' + priceUSD);
    }
    
    // Savatni yangilash
    function updateCart() {
        const cartItemsDiv = document.getElementById('cartItems');
        const cartTotalDiv = document.getElementById('cartTotal');
        const cartTotalHeader = document.getElementById('cartTotalHeader');
        const locationSelect = document.getElementById('locationSelect');
        const customerSearch = document.getElementById('customerSearch');
        const selectedCustomerId = document.getElementById('selectedCustomerId');
        
        if (cart.length === 0) {
            cartItemsDiv.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 50px; color: #999;">Savat bo\'sh</td></tr>';
            cartTotalDiv.innerHTML = '';
            cartTotalHeader.innerHTML = '';
            
            // Savat bo'sh bo'lganda joylashuv va mijozni yoqish
            if (locationSelect) {
                locationSelect.disabled = false;
                locationSelect.style.background = 'white';
                locationSelect.style.cursor = 'pointer';
            }
            if (customerSearch) {
                customerSearch.disabled = false;
                customerSearch.style.background = 'white';
                customerSearch.style.cursor = 'text';
            }
            return;
        }
        
        // Savatda mahsulot bor bo'lsa joylashuvni bloklash
        if (locationSelect && cart.length > 0) {
            locationSelect.disabled = true;
            locationSelect.style.background = '#f0f0f0';
            locationSelect.style.cursor = 'not-allowed';
        }
        
        // Mijozni faqat mijoz tanlangan bo'lsa va savatda mahsulot bo'lsa bloklash
        if (customerSearch && cart.length > 0 && selectedCustomerId && selectedCustomerId.value) {
            customerSearch.disabled = true;
            customerSearch.style.background = '#f0f0f0';
            customerSearch.style.cursor = 'not-allowed';
        } else if (customerSearch) {
            customerSearch.disabled = false;
            customerSearch.style.background = 'white';
            customerSearch.style.cursor = 'text';
        }
        
        let html = '';
        let totalUSD = 0;
        let totalUZS = 0;
        
        cart.forEach((item, index) => {
            const subtotalUSD = item.priceUSD * item.quantity;
            const subtotalUZS = item.priceUZS * item.quantity;
            totalUSD += subtotalUSD;
            totalUZS += subtotalUZS;
            
            html += `
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 8px 5px; font-size: 16px; color: #333; word-wrap: break-word; width: 312px; max-width: 312px; overflow: hidden;">${item.name}</td>
                    <td style="padding: 8px 5px; text-align: center; font-size: 16px; color: #333; width: 84px;">
                        <input type="number" value="${item.quantity}" min="1" onchange="updateCartQuantity(${index}, this.value)" style="width: 60px; text-align: center; border: 1px solid #ced4da; border-radius: 4px; padding: 4px; font-size: 15px; font-weight: 500;">
                    </td>
                    <td style="padding: 8px 5px; text-align: right; font-size: 15px; color: #333; width: 90px;">
                        <div style="margin-bottom: 2px; font-weight: 600; color: #333; font-size: 15px;">$${item.priceUSD.toFixed(2)}</div>
                        <div>
                            <span style="background: #0d6efd; color: white; padding: 2px 4px; border-radius: 2px; font-weight: 500; font-size: 14px;">${formatPrice(item.priceUZS)}</span>
                        </div>
                    </td>
                    <td style="padding: 8px 5px; text-align: right; font-size: 15px; color: #333; width: 94px;">
                        <div style="margin-bottom: 2px; font-weight: 600; color: #333; font-size: 15px;">$${subtotalUSD.toFixed(2)}</div>
                        <div>
                            <span style="background: #0d6efd; color: white; padding: 2px 4px; border-radius: 2px; font-weight: 500; font-size: 14px;">${formatPrice(subtotalUZS)}</span>
                        </div>
                    </td>
                    <td style="padding: 8px 5px; text-align: center; width: 40px;">
                        <button onclick="editCartItem(${index})" style="background: transparent; color: #333; border: none; padding: 4px 6px; cursor: pointer; font-size: 14px; margin-right: 2px;">✏️</button>
                        <button onclick="removeFromCart(${index})" style="background: transparent; color: #333; border: none; padding: 4px 6px; cursor: pointer; font-size: 14px; font-weight: bold;">❌</button>
                    </td>
                </tr>
            `;
        });
        
        cartItemsDiv.innerHTML = html;
        cartTotalDiv.innerHTML = '';
        
        // Jami summani sarlavhada ko'rsatish
        cartTotalHeader.innerHTML = `
            <div style="padding: 10px 15px; background: #f8f9fa; border-radius: 6px; border: 2px solid #dee2e6;">
                <div style="font-size: 14px; font-weight: 600; color: #333;">
                    Jami: <span style="color: #28a745; font-size: 16px;">$${totalUSD.toFixed(2)}</span>
                    <span style="margin-left: 15px; color: #333; font-size: 16px;">${formatPrice(totalUZS)} so'm</span>
                </div>
            </div>
        `;
    }
    
    // Savatdan o'chirish
    async function removeFromCart(index) {
        const item = cart[index];
        
        // Debug: funksiya chaqirilgan vaqtni log qilish
        const timestamp = new Date().toISOString();
        console.log(`\n${'='.repeat(80)}`);
        console.log(`🗑️ removeFromCart() CHAQIRILDI - ${timestamp}`);
        console.log(`   Index: ${index}`);
        console.log(`   Product: ${item.name} (ID: ${item.id})`);
        console.log(`   Quantity: ${item.quantity}`);
        console.log(`   Location: ${selectedLocationId} (${selectedLocationType})`);
        console.log(`   Stock returned flag: ${item._stockReturned || false}`);
        console.log(`${'='.repeat(80)}\n`);
        
        // FAQAT BIR MARTA stokka qaytarish
        if (!item._stockReturned) {
            console.log('🔄 Stokka qaytarish jarayoni boshlanmoqda...');
            try {
                const requestData = {
                    product_id: item.id,
                    quantity: item.quantity,
                    location_id: selectedLocationId,
                    location_type: selectedLocationType
                };
                console.log('📤 API ga yuborilayotgan ma\'lumot:', JSON.stringify(requestData, null, 2));
                
                const response = await fetch('/api/return-stock', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestData)
                });
                
                console.log('📡 API response status:', response.status);
                
                const result = await response.json();
                console.log('📦 API response:', JSON.stringify(result, null, 2));
                
                if (!result.success) {
                    console.error('❌ Stokka qaytarishda xatolik:', result.error);
                    alert('Stokka qaytarishda xatolik: ' + result.error);
                    console.log(`${'='.repeat(80)}\n`);
                    return; // Xatolik bo'lsa savatdan o'chirmaymiz
                } else {
                    console.log('✅ Stokka qaytarildi:', item.quantity, 'dona');
                    console.log('📊 Yangi stock:', result.new_stock);
                    item._stockReturned = true; // Belgi qo'yamiz
                    console.log('🔒 _stockReturned flag = true');
                }
            } catch (error) {
                console.error('❌ Stok qaytarish xatosi:', error);
                alert('Stok qaytarish xatosi: ' + error.message);
                console.log(`${'='.repeat(80)}\n`);
                return; // Xatolik bo'lsa savatdan o'chirmaymiz
            }
        } else {
            console.log('⚠️ Stock allaqachon qaytarilgan, qayta qaytarmaymiz');
            console.log('🔒 _stockReturned flag allaqachon = true');
        }
        
        cart.splice(index, 1);
        updateCart();
        
        // Avtomatik pending savdo yangilash
        await autoSavePending();
        
        // Chap tomondagi mahsulotlar jadvalini yangilash
        await loadProducts();
        
        console.log('✅ Savatdan o\'chirish tugadi');
    }
    
    // Savat miqdorini yangilash
    async function updateCartQuantity(index, newQuantity) {
        const quantity = parseInt(newQuantity);
        if (quantity < 1 || isNaN(quantity)) {
            alert('Noto\'g\'ri miqdor!');
            updateCart();
            return;
        }
        
        const item = cart[index];
        const oldQuantity = item.quantity;
        const quantityDiff = quantity - oldQuantity;
        
        if (quantityDiff === 0) {
            return; // O'zgarish yo'q
        }
        
        // Agar miqdor oshsa, stokdan qo'shimcha ayirish
        if (quantityDiff > 0) {
            try {
                const response = await fetch('/api/reserve-stock', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        product_id: item.id,
                        quantity: quantityDiff,
                        location_id: selectedLocationId,
                        location_type: selectedLocationType
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    alert(result.error || 'Stokdan ayirib bo\'lmadi!');
                    updateCart(); // Eski qiymatni qaytarish
                    return;
                }
                console.log('✅ Stokdan qo\'shimcha ayirildi:', quantityDiff, 'dona');
            } catch (error) {
                console.error('Stok ayirish xatosi:', error);
                alert('Stokni yangilashda xatolik!');
                updateCart();
                return;
            }
        }
        // Agar miqdor kamaysa, stokka qaytarish
        else if (quantityDiff < 0) {
            try {
                const response = await fetch('/api/return-stock', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        product_id: item.id,
                        quantity: Math.abs(quantityDiff),
                        location_id: selectedLocationId,
                        location_type: selectedLocationType
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    alert(result.error || 'Stokka qaytarib bo\'lmadi!');
                    updateCart();
                    return;
                }
                console.log('✅ Stokka qaytarildi:', Math.abs(quantityDiff), 'dona');
            } catch (error) {
                console.error('Stok qaytarish xatosi:', error);
                alert('Stokni yangilashda xatolik!');
                updateCart();
                return;
            }
        }
        
        cart[index].quantity = quantity;
        updateCart();
        
        // Avtomatik pending savdo yangilash
        await autoSavePending();
        
        // Chap tomondagi mahsulotlar jadvalini yangilash
        await loadProducts();
        
        console.log('📝 Miqdor yangilandi:', quantity);
    }
    
    // Savat elementini tahrirlash
    async function editCartItem(index) {
        const item = cart[index];
        
        // Avval eski miqdorni stokka qaytarish
        try {
            const response = await fetch('/api/return-stock', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    product_id: item.id,
                    quantity: item.quantity,
                    location_id: selectedLocationId,
                    location_type: selectedLocationType
                })
            });
            
            const result = await response.json();
            if (!result.success) {
                console.error('Stokka qaytarishda xatolik:', result.error);
            } else {
                console.log('✅ Tahrirlash uchun stokka qaytarildi:', item.quantity, 'dona');
            }
        } catch (error) {
            console.error('Stok qaytarish xatosi:', error);
        }
        
        // Chap tomondagi jadvalni yangilash
        await loadProducts();
        
        // Modal oynani ochish
        document.getElementById('quantityModal').style.display = 'flex';
        document.getElementById('modalProductName').textContent = item.name;
        
        // Mavjud miqdorni olish (stokka qaytarilgandan keyin)
        const locationValue = document.getElementById('locationSelect').value;
        const [type, id] = locationValue.split('_');
        try {
            const response = await fetch(`/api/products?location=${locationValue}`);
            const data = await response.json();
            const products = Array.isArray(data) ? data : (data.products || []);
            const product = products.find(p => p.id === item.id);
            
            if (product && product.stocks && product.stocks.length > 0) {
                const locationId = parseInt(id);
                const matchingStock = product.stocks.find(stock => {
                    if (type === 'warehouse') {
                        return stock.warehouse_id === locationId;
                    } else if (type === 'store') {
                        return stock.store_id === locationId;
                    }
                    return false;
                });
                
                if (matchingStock) {
                    document.getElementById('modalAvailable').value = matchingStock.quantity || 0;
                    document.getElementById('modalQuantity').max = matchingStock.quantity || 0;
                }
            }
        } catch (error) {
            console.error('Mavjud miqdorni olishda xatolik:', error);
            document.getElementById('modalAvailable').value = 0;
        }
        
        // Korzinada qancha bo'lsa o'sha miqdorni ko'rsatish
        document.getElementById('modalQuantity').value = item.quantity;
        document.getElementById('modalPriceUSD').value = item.priceUSD.toFixed(2);
        document.getElementById('modalPriceUZS').value = item.priceUZS;
        
        // Miqdor maydonini avtomatik select qilish
        setTimeout(() => {
            const quantityInput = document.getElementById('modalQuantity');
            if (quantityInput) {
                quantityInput.focus();
                quantityInput.select(); // Ctrl+A effekti
            }
        }, 100);
        
        // currentProduct ni o'rnatish
        currentProduct = { 
            id: item.id, 
            name: item.name, 
            available: parseInt(document.getElementById('modalAvailable').value),
            price: item.priceUSD
        };
        
        // Eski confirm funksiyasini yangilash uchun indexni saqlash
        window.editingCartIndex = index;
    }
    
    // Mahsulotni savatga qo'shish (eski)
    /*
    function addToCart(productId, productName, quantity, price) {
        console.log(`➕ Savatga qo'shildi: ${productName} (ID: ${productId})`);
        // Bu yerda savat logikasini qo'shish kerak
    }
    */
    
    // Mahsulot qidirish funksiyasi
    function filterProducts() {
        const searchText = document.getElementById('universalSearch').value.toLowerCase().trim();
        const tbody = document.getElementById('productsTable');
        const rows = tbody.getElementsByTagName('tr');
        
        // Bo'sh qidiruv - barchasini ko'rsat, highlight yo'q
        if (!searchText) {
            for (let i = 0; i < rows.length; i++) {
                const productNameCell = rows[i].getElementsByTagName('td')[0];
                if (productNameCell) {
                    // Highlight ni olib tashlash
                    const originalText = productNameCell.getAttribute('data-original-text') || productNameCell.textContent;
                    productNameCell.innerHTML = originalText;
                }
                rows[i].style.display = '';
            }
            return;
        }
        
        // Regex maxsus belgilarini escape qilish
        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // Qidiruv so'zlarini ajratish (bo'shliq bilan)
        const searchWords = searchText.split(/\s+/).filter(word => word.length > 0);
        
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const productNameCell = row.getElementsByTagName('td')[0];
            
            if (productNameCell) {
                // Original textni saqlash
                if (!productNameCell.getAttribute('data-original-text')) {
                    productNameCell.setAttribute('data-original-text', productNameCell.textContent);
                }
                
                const originalText = productNameCell.getAttribute('data-original-text');
                const textValue = originalText.toLowerCase();
                
                // Barcha so'zlar topilishi kerak
                const allWordsFound = searchWords.every(word => textValue.indexOf(word) > -1);
                
                if (allWordsFound) {
                    row.style.display = '';
                    
                    // Highlight qilish - barcha so'zlarni bir vaqtda
                    let highlightedText = originalText;
                    
                    // Barcha so'zlarni alternation bilan birlashtirib bir marta replace qilish
                    if (searchWords.length > 0) {
                        const escapedWords = searchWords.map(word => escapeRegex(word));
                        const combinedPattern = escapedWords.join('|');
                        const regex = new RegExp(`(${combinedPattern})`, 'gi');
                        highlightedText = highlightedText.replace(regex, '<span style="background-color: #ffeb3b; padding: 2px 4px; border-radius: 2px;">$1</span>');
                    }
                    
                    productNameCell.innerHTML = highlightedText;
                } else {
                    row.style.display = 'none';
                }
            }
        }
        
        // Ko'rinadigan qatorlarni yangilash
        updateVisibleProductRows();
    }
    
    // Ko'rinadigan mahsulot qatorlarini yangilash
    function updateVisibleProductRows() {
        const tbody = document.getElementById('productsTable');
        const allRows = Array.from(tbody.getElementsByTagName('tr'));
        
        visibleProductRows = allRows.filter(row => {
            const cells = row.getElementsByTagName('td');
            if (cells.length <= 1) return false; // Xabar qatorlarini o'tkazib yuborish
            return row.style.display !== 'none';
        });
    }
    
    // Mahsulotlar jadvalida navigatsiya
    function navigateProductTable(direction) {
        updateVisibleProductRows();
        
        if (visibleProductRows.length === 0) return;
        
        if (direction === 'down') {
            currentSelectedRowIndex = currentSelectedRowIndex < visibleProductRows.length - 1 
                ? currentSelectedRowIndex + 1 
                : 0;
        } else if (direction === 'up') {
            currentSelectedRowIndex = currentSelectedRowIndex > 0 
                ? currentSelectedRowIndex - 1 
                : visibleProductRows.length - 1;
        }
        
        highlightSelectedRow();
    }
    
    // Tanlangan qatorni highlight qilish
    function highlightSelectedRow() {
        // Barcha qatorlardan highlight ni olib tashlash
        visibleProductRows.forEach(row => {
            row.style.background = '';
        });
        
        // Tanlangan qatorni highlight qilish
        if (currentSelectedRowIndex >= 0 && visibleProductRows[currentSelectedRowIndex]) {
            const selectedRow = visibleProductRows[currentSelectedRowIndex];
            selectedRow.style.background = '#bbdefb';
            
            // Scrollni tanlangan qatorga olib borish
            selectedRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }
    
    // Tanlangan mahsulotni savatga qo'shish
    function selectProductFromTable(row) {
        const cells = row.getElementsByTagName('td');
        if (cells.length < 4) return;
        
        // Mahsulot ma'lumotlarini olish
        const productName = cells[0].getAttribute('data-original-text') || cells[0].textContent.trim();
        const productId = row.getAttribute('data-product-id');
        
        // Miqdorni span ichidan olish (cells[1] = Mavjud)
        const quantitySpan = cells[1].querySelector('span');
        const quantity = quantitySpan ? parseInt(quantitySpan.textContent.trim()) : 0;
        
        // Narxni span ichidan olish (cells[2] = Narx, birinchi span USD)
        const priceSpans = cells[2].querySelectorAll('span');
        let price = 0;
        if (priceSpans.length > 0) {
            const priceText = priceSpans[0].textContent.replace(/[$,]/g, '').trim();
            price = parseFloat(priceText) || 0;
        }
        
        console.log('🔍 Tanlangan mahsulot:', { productId, productName, quantity, price });
        
        if (productId && quantity > 0 && price > 0) {
            addToCart(parseInt(productId), productName, quantity, price);
            
            // Qidiruvni tozalash
            document.getElementById('universalSearch').value = '';
            filterProducts();
            clearProductSelection();
        } else {
            console.error('❌ Mahsulot ma\'lumotlari noto\'g\'ri:', { productId, quantity, price });
            alert('Mahsulot ma\'lumotlarini olishda xatolik!');
        }
    }
    
    // Mahsulot tanlanishini tozalash
    function clearProductSelection() {
        currentSelectedRowIndex = -1;
        visibleProductRows.forEach(row => {
            row.style.background = '';
        });
    }
    
    // Narxni formatlash
    function formatPrice(price) {
        if (!price) return '0';
        return Number(price).toLocaleString('uz-UZ');
    }
    
    // URL parametrlarini tekshirish va savdo ma'lumotlarini yuklash
    async function checkURLParametersAndLoadSale() {
        const urlParams = new URLSearchParams(window.location.search);
        const editGroupId = urlParams.get('edit_group');
        const editId = urlParams.get('edit');
        
        if (editGroupId) {
            console.log(`✏️ Savdo guruhi ${editGroupId} yuklanmoqda...`);
            editingSaleId = editGroupId;  // Global o'zgaruvchiga saqlash
            await loadSaleGroup(editGroupId);
        } else if (editId) {
            console.log(`✏️ Savdo ${editId} yuklanmoqda...`);
            editingSaleId = editId;  // Global o'zgaruvchiga saqlash
            await loadSingleSale(editId);
        }
    }
    
    // Savdo guruhini yuklash (bir xil sale_date, customer, location)
    async function loadSaleGroup(saleId) {
        try {
            console.log(`📥 Savdo ${saleId} yuklanmoqda...`);
            
            // Avval korzinani tozalash (agar biror narsa bo'lsa)
            if (cart.length > 0) {
                console.log('🗑️ Korzinani tozalash...');
                cart = [];
                updateCart();
            }
            
            const response = await fetch(`/api/sales/${saleId}`);
            console.log('📡 API response status:', response.status);
            
            if (!response.ok) {
                throw new Error('Savdoni yuklashda xatolik');
            }
            
            const data = await response.json();
            console.log('📦 API javob (to\'liq):', JSON.stringify(data, null, 2));
            console.log('📦 data.success:', data.success);
            console.log('📦 data.sale:', data.sale);
            
            if (data.success && data.sale) {
                const sale = data.sale;
                console.log('📦 Sale obyekti:', sale);
                console.log('📍 location_type:', sale.location_type);
                console.log('📍 location_id:', sale.location_id);
                console.log('👤 customer_name:', sale.customer_name);
                console.log('👤 customer_id:', sale.customer_id);
                console.log('📦 items:', sale.items);
                console.log('📦 items.length:', sale.items?.length);
                
                // 1. JOYLASHUVNI TANLASH
                const locationSelect = document.getElementById('locationSelect');
                console.log('📍 locationSelect element:', locationSelect);
                console.log('📍 locationSelect.options.length:', locationSelect?.options?.length);
                
                const locationValue = sale.location_type === 'store' ? `store_${sale.location_id}` : `warehouse_${sale.location_id}`;
                console.log(`📍 Joylashuv qiymati o'rnatilmoqda: ${locationValue}`);
                
                // Joylashuvni topish va o'rnatish
                let locationFound = false;
                for (let i = 0; i < locationSelect.options.length; i++) {
                    if (locationSelect.options[i].value === locationValue) {
                        locationSelect.selectedIndex = i;
                        locationFound = true;
                        console.log(`✅ Joylashuv topildi va tanlandi: ${locationSelect.options[i].text}`);
                        break;
                    }
                }
                
                if (!locationFound) {
                    console.error(`❌ Joylashuv topilmadi: ${locationValue}`);
                    alert(`Joylashuv topilmadi: ${locationValue}`);
                    return;
                }
                
                // Global o'zgaruvchilarni yangilash
                selectedLocationType = sale.location_type;
                selectedLocationId = sale.location_id;
                console.log(`📍 Global o'zgaruvchilar o'rnatildi: type=${selectedLocationType}, id=${selectedLocationId}`);
                
                // 2. MAHSULOTLARNI YUKLASH
                console.log('📦 Mahsulotlar yuklanmoqda...');
                await loadProducts();
                console.log('✅ Mahsulotlar yuklandi');
                
                // 3. MIJOZNI TO'LDIRISH
                const customerSearchInput = document.getElementById('customerSearch');
                const selectedCustomerIdInput = document.getElementById('selectedCustomerId');
                console.log('👤 customerSearch element:', customerSearchInput);
                console.log('👤 selectedCustomerId element:', selectedCustomerIdInput);
                
                // Mijoz ma'lumotlarini o'rnatish
                if (sale.customer_id && sale.customer_name) {
                    const displayText = sale.customer_phone ? `${sale.customer_name} - ${sale.customer_phone}` : sale.customer_name;
                    customerSearchInput.value = displayText;
                    selectedCustomerIdInput.value = sale.customer_id;
                    
                    // Korzina sarlavhasida mijoz ko'rsatish
                    const cartCustomerInfo = document.getElementById('cartCustomerInfo');
                    const customerDisplay = sale.customer_phone ? `👤 ${sale.customer_name} ${sale.customer_phone}` : `👤 ${sale.customer_name}`;
                    cartCustomerInfo.innerHTML = `<h3 style="margin: 0; color: #333; font-size: 15px; font-weight: 600;">${customerDisplay}</h3>`;
                    
                    console.log(`✅ Mijoz to'ldirildi: ${sale.customer_name} (ID: ${sale.customer_id})`);
                } else {
                    console.warn('⚠️ Mijoz ma\'lumotlari topilmadi');
                }
                
                // 4. MAHSULOTLARNI KORZINAGA QO'SHISH
                console.log('⏳ 800ms kutilmoqda (DOM yangilanishi uchun)...');
                await new Promise(resolve => setTimeout(resolve, 800));
                
                if (sale.items && sale.items.length > 0) {
                    console.log(`\n🛒 ${sale.items.length} ta mahsulot savatga qo'shilmoqda...`);
                    console.log('==================================================');
                    
                    for (const item of sale.items) {
                        console.log(`\n📦 Mahsulot #${item.product_id}:`);
                        console.log(`   Nomi: ${item.product_name}`);
                        console.log(`   Miqdor: ${item.quantity}`);
                        console.log(`   Narx: $${item.unit_price}`);
                        console.log(`   Jami: $${item.total_price}`);
                        
                        // Modal ochmasdan to'g'ridan-to'g'ri qo'shish
                        addToCartDirectly(
                            item.product_id,
                            item.product_name,
                            item.quantity,
                            item.unit_price
                        );
                    }
                    
                    console.log('==================================================');
                    console.log(`✅ ${sale.items.length} ta mahsulot korzinaga qo'shildi`);
                    console.log(`📊 Korzina holati: ${cart.length} ta element`);
                    
                    // Korzinani ko'rsatish uchun
                    cart.forEach((item, index) => {
                        console.log(`   ${index + 1}. ${item.name} x${item.quantity} = $${(item.priceUSD * item.quantity).toFixed(2)}`);
                    });
                } else {
                    console.warn('⚠️ Savdoda mahsulotlar topilmadi');
                }
            } else {
                console.error('❌ API javobida xatolik:', data);
                alert('Savdo ma\'lumotlari noto\'g\'ri formatda');
            }
        } catch (error) {
            console.error('❌ Savdo guruhini yuklashda xatolik:', error);
            console.error('❌ Error stack:', error.stack);
            alert('Savdo ma\'lumotlarini yuklashda xatolik: ' + error.message);
        }
    }
    
    // Bitta savdoni yuklash
    async function loadSingleSale(saleId) {
        try {
            console.log(`📥 Savdo ${saleId} yuklanmoqda...`);
            
            // Avval korzinani tozalash
            if (cart.length > 0) {
                console.log('🗑️ Korzinani tozalash...');
                cart = [];
                updateCart();
            }
            
            const response = await fetch(`/api/sales/${saleId}`);
            if (!response.ok) {
                throw new Error('Savdoni yuklashda xatolik');
            }
            
            const data = await response.json();
            console.log('📦 Savdo ma\'lumotlari:', data);
            
            if (data.success && data.sale) {
                const sale = data.sale;
                
                // Joylashuvni tanlash
                const locationSelect = document.getElementById('locationSelect');
                const locationValue = sale.location_type === 'store' ? `store_${sale.location_id}` : `warehouse_${sale.location_id}`;
                console.log(`📍 Joylashuv tanlanmoqda: ${locationValue}`);
                locationSelect.value = locationValue;
                
                // Global o'zgaruvchilarni yangilash
                selectedLocationType = sale.location_type;
                selectedLocationId = sale.location_id;
                
                // Mahsulotlarni yuklash
                console.log('📦 Mahsulotlar yuklanmoqda...');
                await loadProducts();
                console.log('✅ Mahsulotlar yuklandi');
                
                // Mijozni to'ldirish (ID bilan)
                if (sale.customer_id && sale.customer_name) {
                    const displayText = sale.customer_phone ? `${sale.customer_name} - ${sale.customer_phone}` : sale.customer_name;
                    document.getElementById('customerSearch').value = displayText;
                    document.getElementById('selectedCustomerId').value = sale.customer_id;
                    
                    // Korzina sarlavhasida mijoz ko'rsatish
                    const cartCustomerInfo = document.getElementById('cartCustomerInfo');
                    const customerDisplay = sale.customer_phone ? `👤 ${sale.customer_name} ${sale.customer_phone}` : `👤 ${sale.customer_name}`;
                    cartCustomerInfo.innerHTML = `<h3 style="margin: 0; color: #333; font-size: 15px; font-weight: 600;">${customerDisplay}</h3>`;
                    
                    console.log(`✅ Mijoz to'ldirildi: ${sale.customer_name} (ID: ${sale.customer_id})`);
                } else {
                    console.warn('⚠️ Mijoz ma\'lumotlari topilmadi');
                }
                
                // Kichik kutish - mahsulotlar DOM'ga qo'shilishi uchun
                console.log('⏳ 800ms kutilmoqda...');
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Savdo elementini savatga qo'shish
                if (sale.items && sale.items.length > 0) {
                    console.log(`🛒 ${sale.items.length} ta mahsulot savatga qo'shilmoqda...`);
                    
                    for (const item of sale.items) {
                        console.log(`  📦 ${item.product_name}: ${item.quantity} ta × $${item.unit_price}`);
                        
                        // Modal ochmasdan to'g'ridan-to'g'ri qo'shish
                        addToCartDirectly(
                            item.product_id,
                            item.product_name,
                            item.quantity,
                            item.unit_price
                        );
                    }
                    
                    console.log(`✅ ${sale.items.length} ta mahsulot korzinaga qo'shildi`);
                    console.log(`📊 Korzina holati: ${cart.length} ta element`);
                } else {
                    console.warn('⚠️ Savdoda mahsulotlar topilmadi');
                }
            } else {
                console.error('❌ API javobida xatolik:', data);
                alert('Savdo ma\'lumotlari noto\'g\'ri formatda');
            }
        } catch (error) {
            console.error('❌ Savdoni yuklashda xatolik:', error);
            alert('Savdo ma\'lumotlarini yuklashda xatolik: ' + error.message);
        }
    }
    
    // Sahifa yuklanganda joylashuvlarni yuklash
    document.addEventListener('DOMContentLoaded', async function() {
        // Avval asosiy ma'lumotlarni yuklash
        await loadLocations();
        await loadCustomers();
        await loadExchangeRate();
        
        // Keyin URL parametrlarini tekshirish va savdo ma'lumotlarini yuklash
        await checkURLParametersAndLoadSale();
        
        // Universal qidiruv uchun event listener allaqachon DOMContentLoaded da qo'shilgan
        
        // Mijoz qidirish input'ga event listener qo'shish
        const customerSearchInput = document.getElementById('customerSearch');
        console.log('🔧 customerSearchInput elementi:', customerSearchInput);
        if (customerSearchInput) {
            console.log('✅ Event listener qo\'shilmoqda...');
            customerSearchInput.addEventListener('input', function() {
                console.log('⌨️ Input event: ', this.value);
                searchCustomers(this.value);
            });
            
            // Klaviatura navigatsiyasi
            customerSearchInput.addEventListener('keydown', function(e) {
                const dropdown = document.getElementById('customerDropdown');
                const isDropdownVisible = dropdown.style.display === 'block';
                
                if (!isDropdownVisible) return;
                
                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        navigateCustomerDropdown('down');
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        navigateCustomerDropdown('up');
                        break;
                    case 'Enter':
                        e.preventDefault();
                        selectCurrentCustomer();
                        break;
                    case 'Escape':
                        e.preventDefault();
                        dropdown.style.display = 'none';
                        filteredCustomers = [];
                        selectedCustomerIndex = -1;
                        break;
                }
            });
            
            // Dropdown tashqarisiga bosilganda yopish
            document.addEventListener('click', function(e) {
                const dropdown = document.getElementById('customerDropdown');
                if (!customerSearchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        } else {
            console.error('❌ customerSearch elementi topilmadi!');
        }
        
        // USD narx o'zgarganda avtomatik UZS hisoblash
        document.getElementById('modalPriceUSD').addEventListener('input', updateUZSPrice);
        
        // UZS narx o'zgarganda avtomatik USD hisoblash
        document.getElementById('modalPriceUZS').addEventListener('input', updateUSDPrice);
        
        // To'lov modal oynasida USD dan UZS ga avtomatik konversiya
        document.getElementById('paymentCashUSD').addEventListener('input', function() {
            const usd = parseFloat(this.value) || 0;
            document.getElementById('paymentCashUZS').value = Math.round(usd * exchangeRate);
        });
        
        document.getElementById('paymentClickUSD').addEventListener('input', function() {
            const usd = parseFloat(this.value) || 0;
            document.getElementById('paymentClickUZS').value = Math.round(usd * exchangeRate);
        });
        
        document.getElementById('paymentTerminalUSD').addEventListener('input', function() {
            const usd = parseFloat(this.value) || 0;
            document.getElementById('paymentTerminalUZS').value = Math.round(usd * exchangeRate);
        });
        
        document.getElementById('paymentDebtUSD').addEventListener('input', function() {
            const usd = parseFloat(this.value) || 0;
            document.getElementById('paymentDebtUZS').value = Math.round(usd * exchangeRate);
        });
        
        // To'lov modal oynasida UZS dan USD ga avtomatik konversiya
        document.getElementById('paymentCashUZS').addEventListener('input', function() {
            const uzs = parseFloat(this.value) || 0;
            document.getElementById('paymentCashUSD').value = (uzs / exchangeRate).toFixed(2);
        });
        
        document.getElementById('paymentClickUZS').addEventListener('input', function() {
            const uzs = parseFloat(this.value) || 0;
            document.getElementById('paymentClickUSD').value = (uzs / exchangeRate).toFixed(2);
        });
        
        document.getElementById('paymentTerminalUZS').addEventListener('input', function() {
            const uzs = parseFloat(this.value) || 0;
            document.getElementById('paymentTerminalUSD').value = (uzs / exchangeRate).toFixed(2);
        });
        
        document.getElementById('paymentDebtUZS').addEventListener('input', function() {
            const uzs = parseFloat(this.value) || 0;
            document.getElementById('paymentDebtUSD').value = (uzs / exchangeRate).toFixed(2);
        });
        
        // Input focus bo'lganda dropdown'ni ko'rsatish
        const customerSearchInput2 = document.getElementById('customerSearch');
        if (customerSearchInput2) {
            customerSearchInput2.addEventListener('focus', function() {
                if (this.value.length >= 2) {
                    searchCustomers(this.value);
                }
            });
        }
        
        // Modal oynada Enter tugmasi bosilganda savatga qo'shish
        const modalQuantity = document.getElementById('modalQuantity');
        const modalPriceUSD = document.getElementById('modalPriceUSD');
        const modalPriceUZS = document.getElementById('modalPriceUZS');
        
        [modalQuantity, modalPriceUSD, modalPriceUZS].forEach(input => {
            if (input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        confirmAddToCart();
                    }
                });
            }
        });
        
        // Dropdown tashqarisiga bosilganda yopish
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('customerDropdown');
            const input = document.getElementById('customerSearch');
            if (e.target !== input && e.target !== dropdown && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        // Sahifa yuklanganda mahsulot qidirish maydoniga fokus berish
        const universalSearch = document.getElementById('universalSearch');
        if (universalSearch) {
            setTimeout(() => universalSearch.focus(), 200);
        }
        
        console.log('✅ Sales sahifasi tayyor');
    });
    
    // Savatni tozalash
    async function clearCart() {
        if (cart.length === 0) {
            alert('Savat allaqachon bo\'sh!');
            return;
        }
        
        if (!confirm('Savatni tozalashni xohlaysizmi? Barcha mahsulotlar stokga qaytariladi.')) {
            return;
        }
        
        // Barcha mahsulotlarni stokga qaytarish
        console.log('🔄 Barcha mahsulotlarni stokga qaytarish...');
        
        for (const item of cart) {
            try {
                const response = await fetch('/api/return-stock', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        product_id: item.id,
                        quantity: item.quantity,
                        location_id: selectedLocationId,
                        location_type: selectedLocationType
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log(`✅ ${item.name}: ${item.quantity} dona stokga qaytarildi`);
                } else {
                    console.error(`❌ ${item.name}: Stokga qaytarishda xatolik - ${result.error}`);
                }
            } catch (error) {
                console.error(`❌ ${item.name}: Stok qaytarish xatosi:`, error);
            }
        }
        
        // Korzinani tozalash
        cart = [];
        
        // Pending savdoni o'chirish
        if (currentPendingSaleId) {
            try {
                await fetch(`/api/sales/${currentPendingSaleId}`, {
                    method: 'DELETE'
                });
                console.log('🗑️ Pending savdo o\'chirildi:', currentPendingSaleId);
                currentPendingSaleId = null;
            } catch (error) {
                console.error('❌ Pending savdoni o\'chirishda xatolik:', error);
            }
        }
        
        // Mijoz maydonini tozalash
        const customerSearch = document.getElementById('customerSearch');
        const selectedCustomerId = document.getElementById('selectedCustomerId');
        if (customerSearch) {
            customerSearch.value = '';
        }
        if (selectedCustomerId) {
            selectedCustomerId.value = '';
        }
        
        updateCart();
        
        // Mahsulotlar jadvalini yangilash
        await loadProducts();
        
        console.log('🗑️ Savat tozalandi va barcha mahsulotlar stokga qaytarildi');
        alert('✅ Savat tozalandi va mahsulotlar stokga qaytarildi');
    }
    
    // Avtomatik pending savdo yaratish/yangilash
    async function autoSavePending() {
        // Agar savat bo'sh bo'lsa, pending savdoni o'chirish (STOK QAYTARMASDAN)
        if (cart.length === 0) {
            if (currentPendingSaleId) {
                try {
                    // ?return_stock=false - chunki stok allaqachon removeFromCart() da qaytarilgan
                    await fetch(`/api/sales/${currentPendingSaleId}?return_stock=false`, {
                        method: 'DELETE'
                    });
                    console.log('🗑️ Bo\'sh pending savdo o\'chirildi (stok qaytarilmadi):', currentPendingSaleId);
                    currentPendingSaleId = null;
                } catch (error) {
                    console.error('❌ Pending savdoni o\'chirishda xatolik:', error);
                }
            }
            return;
        }
        
        // Location tanlanmagan bo'lsa, saqlamaymiz
        if (!selectedLocationId || !selectedLocationType) {
            console.log('⚠️ Location tanlanmagan, pending savdo saqlanmaydi');
            return;
        }
        
        // Savdo ma'lumotlarini tayyorlash
        const customerId = document.getElementById('selectedCustomerId').value || null;
        let totalUSD = 0;
        cart.forEach(item => {
            totalUSD += item.priceUSD * item.quantity;
        });
        
        const saleData = {
            customer_id: customerId ? parseInt(customerId) : null,
            location_id: selectedLocationId,
            location_type: selectedLocationType,
            items: cart.map(item => ({
                product_id: item.id || item.productId,
                product_name: item.name || item.productName,
                quantity: item.quantity,
                unit_price: item.priceUSD,
                price: item.priceUSD,
                price_usd: item.priceUSD,
                price_uzs: item.priceUZS,
                location_id: selectedLocationId,
                location_type: selectedLocationType
            })),
            payment: {
                cash_usd: 0,
                cash_uzs: 0,
                click_usd: 0,
                click_uzs: 0,
                terminal_usd: 0,
                terminal_uzs: 0,
                debt_usd: totalUSD,
                debt_uzs: Math.round(totalUSD * exchangeRate)
            },
            total_usd: totalUSD,
            total_uzs: totalUSD * exchangeRate,
            exchange_rate: exchangeRate,
            payment_status: 'pending'
        };
        
        try {
            let response, result;
            
            // Tahrirlash rejimida bo'lsa yoki mavjud pending savdo bo'lsa - yangilash
            if (editingSaleId || currentPendingSaleId) {
                const saleIdToUpdate = editingSaleId || currentPendingSaleId;
                console.log('📝 Pending savdoni yangilash:', saleIdToUpdate, editingSaleId ? '(tahrirlash rejimi)' : '(avtosave)');
                response = await fetch(`/api/sales/${saleIdToUpdate}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(saleData)
                });
                
                // Agar tahrirlash rejimida bo'lsa, currentPendingSaleId ni o'rnatish
                if (editingSaleId && !currentPendingSaleId) {
                    currentPendingSaleId = editingSaleId;
                }
            } else {
                // Yangi pending savdo yaratish
                console.log('➕ Yangi pending savdo yaratish');
                response = await fetch('/api/pending-sales', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(saleData)
                });
            }
            
            result = await response.json();
            
            if (result.success) {
                if (!currentPendingSaleId) {
                    currentPendingSaleId = result.sale_id;
                    console.log('✅ Yangi pending savdo yaratildi, ID:', currentPendingSaleId);
                } else {
                    console.log('✅ Pending savdo yangilandi, ID:', currentPendingSaleId);
                }
            } else {
                console.error('❌ Pending savdoni saqlashda xatolik:', result.error);
            }
        } catch (error) {
            console.error('❌ Pending savdoni saqlashda xatolik:', error);
        }
    }
    
    // Keyinroq tasdiqlash
    async function savePending() {
        if (cart.length === 0) {
            alert('Savat bo\'sh!');
            return;
        }
        
        const customerId = document.getElementById('selectedCustomerId').value || null;
        
        if (!selectedLocationId || !selectedLocationType) {
            alert('Joylashuvni tanlang!');
            return;
        }
        
        // Jami summani hisoblash
        let totalUSD = 0;
        cart.forEach(item => {
            totalUSD += item.priceUSD * item.quantity;
        });
        
        // Savdoni pending status bilan saqlash
        const saleData = {
            customer_id: parseInt(customerId),
            location_id: selectedLocationId,
            location_type: selectedLocationType,
            items: cart.map(item => ({
                product_id: item.id || item.productId,
                product_name: item.name || item.productName,
                quantity: item.quantity,
                unit_price: item.priceUSD,
                price: item.priceUSD,
                price_usd: item.priceUSD,
                price_uzs: item.priceUZS
            })),
            payment: {
                cash_usd: 0,
                cash_uzs: 0,
                click_usd: 0,
                click_uzs: 0,
                terminal_usd: 0,
                terminal_uzs: 0,
                debt_usd: totalUSD,
                debt_uzs: Math.round(totalUSD * exchangeRate)
            },
            total_usd: totalUSD,
            total_uzs: totalUSD * exchangeRate,
            exchange_rate: exchangeRate,
            payment_status: 'pending'
        };
        
        console.log('⏸️ Pending savdo ma\'lumotlari:', saleData);
        
        try {
            let response, result;
            
            // Agar tahrirlash rejimida bo'lsa, PUT so'rovi yuborish
            if (editingSaleId) {
                console.log('📝 Tahrirlash rejimi: savdoni pending holatga o\'zgartirish, ID:', editingSaleId);
                response = await fetch(`/api/sales/${editingSaleId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ...saleData,
                        payment_status: 'pending'
                    })
                });
            } else {
                // Yangi savdo yaratish
                console.log('➕ Yangi savdoni pending holatda yaratish');
                response = await fetch('/api/pending-sales', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(saleData)
                });
            }
            
            result = await response.json();
            console.log('API javob:', result);
            
            if (result.success) {
                if (editingSaleId) {
                    alert('✅ Savdo pending holatga o\'tkazildi! Endi Tasdiqlanmagan savdolar ro\'yxatida ko\'rinadi.');
                } else {
                    alert('✅ Savdo keyinroq tasdiqlash uchun saqlandi!');
                }
                console.log('⏸️ Savdo pending holatga o\'tkazildi, ID:', result.sale_id || editingSaleId);
                
                // Tahrirlash rejimidan chiqish
                editingSaleId = null;
                
                // Savatni tozalash
                cart = [];
                updateCart();
                
                // Mijozni tozalash (elementlar mavjudligini tekshirish)
                const customerIdInput = document.getElementById('selectedCustomerId');
                const customerNameDisplay = document.getElementById('customerNameDisplay');
                const customerPhoneDisplay = document.getElementById('customerPhoneDisplay');
                
                if (customerIdInput) customerIdInput.value = '';
                if (customerNameDisplay) customerNameDisplay.textContent = 'Mijoz tanlanmagan';
                if (customerPhoneDisplay) customerPhoneDisplay.textContent = '';
            } else {
                alert('❌ Xatolik: ' + (result.error || 'Noma\'lum xatolik'));
            }
        } catch (error) {
            console.error('Pending savdo xatosi:', error);
            alert('❌ Tarmoq xatoligi: ' + error.message);
        }
    }
    
    // Savdoni yakunlash
    function completeSale() {
        if (cart.length === 0) {
            alert('Savat bo\'sh!');
            return;
        }
        
        const customerId = document.getElementById('selectedCustomerId').value || null;
        
        // Jami summani hisoblash
        let totalUSD = 0;
        cart.forEach(item => {
            totalUSD += item.priceUSD * item.quantity;
        });
        
        const totalUZS = totalUSD * exchangeRate;
        
        // To'lov modal oynasini ochish
        document.getElementById('paymentModalTotalUSD').textContent = `$${totalUSD.toFixed(2)}`;
        document.getElementById('paymentModalTotalUZS').textContent = `${Math.round(totalUZS).toLocaleString('uz-UZ')} so'm`;
        document.getElementById('paymentCashUSD').value = totalUSD.toFixed(2);
        document.getElementById('paymentCashUZS').value = Math.round(totalUZS);
        document.getElementById('paymentClickUSD').value = '';
        document.getElementById('paymentClickUZS').value = '';
        document.getElementById('paymentTerminalUSD').value = '';
        document.getElementById('paymentTerminalUZS').value = '';
        document.getElementById('paymentDebtUSD').value = '';
        document.getElementById('paymentDebtUZS').value = '';
        document.getElementById('paymentModal').style.display = 'flex';
        
        // Fokusni Naxt so'm maydoniga berish
        setTimeout(() => {
            document.getElementById('paymentCashUZS').focus();
            document.getElementById('paymentCashUZS').select();
        }, 100);
        
        console.log('💳 To\'lov modali ochildi');
    }
    
    // To'lov modal oynasini yopish
    function closePaymentModal() {
        document.getElementById('paymentModal').style.display = 'none';
        // Ogohlantirishni yashirish
        const paymentWarning = document.getElementById('paymentWarning');
        if (paymentWarning) {
            paymentWarning.style.display = 'none';
            paymentWarning.textContent = '';
        }
    }
    
    // Qolgan summani maydonga qo'shish
    function addRemainingToField(fieldId) {
        console.log('🔧 addRemainingToField chaqirildi:', fieldId);
        
        // Jami summani hisoblash
        let totalUSD = 0;
        cart.forEach(item => {
            totalUSD += item.priceUSD * item.quantity;
        });
        
        console.log('💰 Jami summa (USD):', totalUSD);
        console.log('💱 Exchange rate:', exchangeRate);
        
        // Hozirgi to'lovlarni hisoblash (faqat USD qiymatlardan, UZS dan emas)
        const cashUSD = parseFloat(document.getElementById('paymentCashUSD').value) || 0;
        const clickUSD = parseFloat(document.getElementById('paymentClickUSD').value) || 0;
        const terminalUSD = parseFloat(document.getElementById('paymentTerminalUSD').value) || 0;
        const debtUSD = parseFloat(document.getElementById('paymentDebtUSD').value) || 0;
        
        console.log('💵 Hozirgi to\'lovlar (faqat USD):', { cashUSD, clickUSD, terminalUSD, debtUSD });
        
        const currentTotal = cashUSD + clickUSD + terminalUSD + debtUSD;
        const remaining = totalUSD - currentTotal;
        
        console.log('📊 Hozirgi jami:', currentTotal);
        console.log('📊 Qolgan:', remaining);
        
        if (remaining > 0) {
            const currentValue = parseFloat(document.getElementById(fieldId).value) || 0;
            const newUSDValue = currentValue + remaining;
            document.getElementById(fieldId).value = newUSDValue.toFixed(2);
            
            // UZS maydonini ham yangilash
            const uzsFieldId = fieldId.replace('USD', 'UZS');
            console.log('🔄 UZS maydon ID:', uzsFieldId);
            
            if (document.getElementById(uzsFieldId)) {
                const currentUZSValue = parseFloat(document.getElementById(uzsFieldId).value) || 0;
                const newUZSValue = currentUZSValue + Math.round(remaining * exchangeRate);
                document.getElementById(uzsFieldId).value = newUZSValue;
                console.log(`➕ Qolgan $${remaining.toFixed(2)} (${Math.round(remaining * exchangeRate)} so'm) ${fieldId} ga qo'shildi`);
            } else {
                console.error('❌ UZS maydoni topilmadi:', uzsFieldId);
            }
        } else {
            console.log('✅ To\'lov to\'liq yoki ortiqcha');
        }
    }
    
    // To'lovni tasdiqlash
    async function confirmPayment() {
        // Ogohlantirishni yashirish
        const paymentWarning = document.getElementById('paymentWarning');
        paymentWarning.style.display = 'none';
        paymentWarning.textContent = '';
        
        const cashUSD = parseFloat(document.getElementById('paymentCashUSD').value) || 0;
        const clickUSD = parseFloat(document.getElementById('paymentClickUSD').value) || 0;
        const terminalUSD = parseFloat(document.getElementById('paymentTerminalUSD').value) || 0;
        const debtUSD = parseFloat(document.getElementById('paymentDebtUSD').value) || 0;
        
        const cashUZS = parseFloat(document.getElementById('paymentCashUZS').value) || 0;
        const clickUZS = parseFloat(document.getElementById('paymentClickUZS').value) || 0;
        const terminalUZS = parseFloat(document.getElementById('paymentTerminalUZS').value) || 0;
        const debtUZS = parseFloat(document.getElementById('paymentDebtUZS').value) || 0;
        
        // Faqat USD qiymatlardan foydalanish (UZS avtomatik sinxronlashgan)
        const totalPayment = cashUSD + clickUSD + terminalUSD + debtUSD;
        
        // Jami summani hisoblash
        let totalUSD = 0;
        cart.forEach(item => {
            totalUSD += item.priceUSD * item.quantity;
        });
        
        // Mijoz tanlanganligini tekshirish (agar qarz bo'lsa)
        const customerId = document.getElementById('selectedCustomerId').value;
        if (debtUSD > 0 && !customerId) {
            paymentWarning.textContent = '⚠️ Qarzga sotish uchun mijoz tanlanishi shart!';
            paymentWarning.style.display = 'block';
            return;
        }
        
        // To'lov tekshiruvi
        if (Math.abs(totalPayment - totalUSD) > 0.01) {
            paymentWarning.textContent = `⚠️ Jami to'lov ($${totalPayment.toFixed(2)}) savdo summasiga ($${totalUSD.toFixed(2)}) teng emas!`;
            paymentWarning.style.display = 'block';
            return;
        }
        
        // Savdoni backend'ga yuborish uchun ma'lumotlarni tayyorlash
        const saleData = {
            customer_id: parseInt(document.getElementById('selectedCustomerId').value),
            location_id: selectedLocationId,
            location_type: selectedLocationType,
            items: cart.map(item => ({
                product_id: item.id || item.productId,  // id yoki productId
                product_name: item.name || item.productName,  // name yoki productName
                quantity: item.quantity,
                unit_price: item.priceUSD,
                price: item.priceUSD,
                price_usd: item.priceUSD,
                price_uzs: item.priceUZS
            })),
            payment: {
                cash_usd: cashUSD,
                cash_uzs: cashUZS,
                click_usd: clickUSD,
                click_uzs: clickUZS,
                terminal_usd: terminalUSD,
                terminal_uzs: terminalUZS,
                debt_usd: debtUSD,
                debt_uzs: debtUZS
            },
            total_usd: totalUSD,
            total_uzs: totalUSD * exchangeRate,
            exchange_rate: exchangeRate,
            // Payment status ni avtomatik aniqlash
            payment_status: debtUSD > 0 ? 'partial' : 'paid',
            // Agar tahrirlash rejimida bo'lsa
            original_sale_id: editingSaleId,
            is_edit_mode: editingSaleId !== null
        };
        
        console.log('📤 Savdoni backend ga yuborish:');
        console.log('   - Tahrirlash rejimi:', editingSaleId !== null);
        console.log('   - Original Sale ID:', editingSaleId);
        console.log('   - Jami mahsulotlar:', saleData.items.length);
        console.log('   - Mijoz ID:', saleData.customer_id);
        console.log('   - Location ID:', saleData.location_id);
        console.log('   - Location Type:', saleData.location_type);
        console.log('   - To\'lov holati:', saleData.payment_status);
        console.log('Full sale data:', JSON.stringify(saleData, null, 2));
        
        try {
            const response = await fetch('/api/create-sale', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(saleData)
            });
            
            const result = await response.json();
            
            if (!result.success) {
                alert('Savdo yaratishda xatolik: ' + (result.error || 'Noma\'lum xatolik'));
                console.error('❌ Savdo xatosi:', result);
                return;
            }
            
            console.log('✅ Savdo muvaffaqiyatli saqlandi:', result);
            
            // Pending savdoni o'chirish (chunki yakunlandi)
            if (currentPendingSaleId) {
                try {
                    await fetch(`/api/sales/${currentPendingSaleId}`, {
                        method: 'DELETE'
                    });
                    console.log('🗑️ Pending savdo o\'chirildi (yakunlandi):', currentPendingSaleId);
                    currentPendingSaleId = null;
                } catch (error) {
                    console.error('⚠️ Pending savdoni o\'chirishda xatolik:', error);
                }
            }
            
            // Tahrirlash rejimida eski sahifaga qaytish
            if (editingSaleId) {
                alert('✅ Savdo muvaffaqiyatli tahrirlandi!');
                console.log('🔄 Sales history sahifasiga qaytish...');
                window.location.href = '/sales-history';
            } else {
                alert('✅ Savdo muvaffaqiyatli yakunlandi!');
                
                // Savatni tozalash va modal yopish
                cart = [];
                updateCart();
                closePaymentModal();
                
                // Mijoz ma'lumotlarini tozalash
                document.getElementById('customerSearch').value = '';
                document.getElementById('selectedCustomerId').value = '';
                document.getElementById('cartCustomerInfo').innerHTML = '<h3 style="margin: 0; color: #333;">🛒 Savdo Korzinasi</h3>';
                
                // Mahsulotlar jadvalini yangilash
                await loadProducts();
            }
            
        } catch (error) {
            console.error('❌ Savdoni yuborishda xatolik:', error);
            alert('Savdoni saqlashda xatolik yuz berdi!');
        }
    }
</script>
{% endblock %}

