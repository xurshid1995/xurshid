{% extends "base_with_sidebar.html" %}

{% block title %}Savdo - Dokon Boshqaruv Tizimi{% endblock %}

{% block extra_css %}
<style>
    /* ===== MODAL OVERLAY GLOBAL CLASSES ===== */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
    }
    
    .modal-overlay-fullscreen {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #000;
        z-index: 9999;
    }
    
    .modal-overlay-customer {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    }
    
    .sales-container {
        padding: 15px;
        background: #f8f9fa;
        min-height: 100vh;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        margin: 0;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #dee2e6;
    }

    .page-header h1 {
        margin: 0;
        color: #333;
        font-size: 24px;
    }
    
    /* Sales grid layout - katta ekranlarda avtomatik moslashuvchi */
    .sales-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        padding: 0;
        align-items: start;
        max-width: 100%;
        box-sizing: border-box;
    }
    
    /* Layout boxes */
    .sales-layout-box {
        max-width: 100%;
        width: 100%;
        overflow: hidden;
    }
    
    .sales-grid > div:first-child,
    .sales-grid > div:nth-child(2) {
        width: 100%;
        box-sizing: border-box;
        overflow: hidden;
    }
    
    .table-wrapper {
        width: 100%;
        max-width: 100%;
        position: relative;
        box-sizing: border-box;
    }
    
    .sales-product-table {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 630px !important;
        border-collapse: collapse !important;
        table-layout: fixed !important;
    }
    
    .sales-product-table thead tr {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }
    
    .sales-product-table th {
        padding: 10px 8px;
        font-size: 15px;
        font-weight: 600;
        color: #495057;
        box-sizing: border-box;
    }
    
    .sales-product-table td {
        box-sizing: border-box;
    }
    
    .sales-product-table th:nth-child(1) { text-align: left; width: 40%; }
    .sales-product-table th:nth-child(2) { text-align: center; width: 20%; }
    .sales-product-table th:nth-child(3) { text-align: center; width: 30%; }
    .sales-product-table th:nth-child(4) { text-align: center; width: 10%; }
    
    .sales-product-table td:nth-child(1) { width: 40%; }
    .sales-product-table td:nth-child(2) { width: 20%; }
    .sales-product-table td:nth-child(3) { width: 30%; }
    .sales-product-table td:nth-child(4) { width: 10%; }
    
    .cart-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 15px;
        table-layout: fixed;
    }
    
    .cart-table thead tr {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }
    
    .cart-table th {
        padding: 8px 5px;
        font-size: 15px;
        font-weight: 600;
        color: #495057;
        box-sizing: border-box;
    }
    
    .cart-table td {
        box-sizing: border-box;
    }
    
    .cart-table th:nth-child(1) { text-align: left; width: 45%; }
    .cart-table th:nth-child(2) { text-align: center; width: 15%; }
    .cart-table th:nth-child(3) { text-align: right; width: 15%; }
    .cart-table th:nth-child(4) { text-align: right; width: 15%; }
    .cart-table th:nth-child(5) { text-align: center; width: 10%; }
    
    .cart-table td:nth-child(1) { width: 45%; }
    .cart-table td:nth-child(2) { width: 15%; }
    .cart-table td:nth-child(3) { width: 15%; }
    .cart-table td:nth-child(4) { width: 15%; }
    .cart-table td:nth-child(5) { width: 10%; }
    
    /* Scroll indicator removed for better mobile UX */
    
    /* Responsive - kichik ekranlar uchun vertikal layout */
    @media (max-width: 1200px) {
        .sales-grid {
            grid-template-columns: 1fr !important;
            margin: 0 auto;
        }
        
        .sales-layout-box,
        .sales-grid > div:first-child,
        .sales-grid > div:nth-child(2) {
            width: 100% !important;
            min-width: auto !important;
        }
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
        .sales-layout-box {
            width: 100% !important;
        }
        
        .table-wrapper {
            width: 100% !important;
            overflow-x: auto !important;
            -webkit-overflow-scrolling: touch;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin: 0 !important;
        }
        
        .table-wrapper::-webkit-scrollbar {
            height: 6px;
        }
        
        .table-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }
        
        .sales-product-table,
        .cart-table {
            width: 100% !important;
            min-width: auto !important;
            max-width: 100% !important;
            table-layout: auto !important;
            font-size: 0.8rem !important;
        }
        
        .sales-product-table th,
        .sales-product-table td,
        .cart-table th,
        .cart-table td {
            padding: 8px 4px !important;
            font-size: 0.8rem !important;
        }
        
        /* Mahsulot jadvalidagi Amal ustunini yashirish (mobilda qatorni bosish mumkin) */
        .sales-product-table th:nth-child(4),
        .sales-product-table td:nth-child(4) {
            display: none !important;
        }
        
        /* Mahsulot qatorini bosish mumkin qilish */
        .sales-product-table tbody tr {
            cursor: pointer !important;
        }
        
        .sales-product-table tbody tr:hover {
            background-color: #f0f8ff !important;
        }
        
        /* Mahsulot nomi ustunini kichikroq qilish va matnni o'rash */
        .sales-product-table th:first-child,
        .sales-product-table td:first-child,
        .cart-table th:first-child,
        .cart-table td:first-child {
            width: auto !important;
            max-width: 140px !important;
            min-width: 90px !important;
            white-space: normal !important;
            word-wrap: break-word !important;
            word-break: break-word !important;
            line-height: 1.3 !important;
        }
        
        /* Boshqa ustunlar uchun optimal kengliklar */
        .sales-product-table th:nth-child(2),
        .sales-product-table td:nth-child(2) {
            white-space: nowrap;
            text-align: center;
            width: auto !important;
        }
        
        .sales-product-table th:nth-child(3),
        .sales-product-table td:nth-child(3) {
            white-space: nowrap;
            width: auto !important;
        }
        
        .sales-product-table th:nth-child(4),
        .sales-product-table td:nth-child(4) {
            white-space: nowrap;
            text-align: center;
            width: auto !important;
        }
        
        .cart-table th:nth-child(2),
        .cart-table td:nth-child(2) {
            white-space: nowrap;
            text-align: center;
            width: auto !important;
        }
        
        .cart-table th:nth-child(3),
        .cart-table td:nth-child(3),
        .cart-table th:nth-child(4),
        .cart-table td:nth-child(4) {
            white-space: nowrap;
            width: auto !important;
        }
        
        .cart-table th:nth-child(5),
        .cart-table td:nth-child(5) {
            width: auto !important;
        }
        
        .sales-product-table th:first-child,
        .sales-product-table td:first-child,
        .cart-table th:first-child,
        .cart-table td:first-child {
            position: sticky;
            left: 0;
            z-index: 1;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        
        /* Sticky ustun uchun background */
        .sales-product-table th:first-child,
        .cart-table th:first-child {
            background: #f8f9fa;
        }
        
        .sales-product-table td:first-child,
        .cart-table td:first-child {
            background: white;
        }
        
        .sales-container {
            padding: 10px;
        }
        
        .sales-grid {
            grid-template-columns: 1fr !important;
            padding: 10px !important;
            gap: 10px !important;
        }
        
        .sales-grid > div {
            width: 100% !important;
            max-width: 100% !important;
        }
        
        .page-header h1 {
            font-size: 20px;
        }
        
        /* Input maydonlar */
        input[type="text"],
        input[type="number"],
        select {
            font-size: 14px !important;
            padding: 10px !important;
        }
        
        /* Tugmalar */
        button {
            padding: 10px 15px !important;
            font-size: 14px !important;
        }
        
        .btn-new-sale {
            width: 100%;
            margin-bottom: 10px;
        }
        
        /* To'lov modal mobil uchun */
        #paymentModal {
            padding: 2px !important;
            overflow-y: auto !important;
            align-items: flex-start !important;
            justify-content: flex-start !important;
        }
        
        .payment-modal-content {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: calc(100vw - 20px) !important;
            max-width: calc(100vw - 20px) !important;
            max-height: 90vh !important;
            overflow-y: auto !important;
            padding: 10px !important;
            margin: 0 !important;
            box-sizing: border-box !important;
            border-radius: 8px !important;
        }
        
        .payment-modal-content > div {
            margin-bottom: 3px !important;
            gap: 2px !important;
            padding: 3px !important;
        }
        
        .payment-modal-content h3 {
            font-size: 11px !important;
            margin: 0 0 3px 0 !important;
        }
        
        /* Faqat narx input maydonlarini qisqartirish */
        .payment-modal-content input[type="number"] {
            padding: 4px 3px !important;
            font-size: 11px !important;
            min-width: 50px !important;
            max-width: 80px !important;
        }
        
        .payment-modal-content button {
            padding: 2px 3px !important;
            font-size: 8px !important;
            white-space: nowrap !important;
        }
        
        .payment-modal-content label {
            font-size: 8px !important;
            min-width: 40px !important;
        }
        
        .payment-modal-content label span {
            font-size: 9px !important;
        }
        
        .payment-modal-content input[type="checkbox"] {
            width: 11px !important;
            height: 11px !important;
        }
        
        .payment-modal-content #paymentModalTotal {
            font-size: 9px !important;
        }
        
        .payment-modal-content #paymentModalTotal > div {
            font-size: 8px !important;
            margin-bottom: 1px !important;
        }
        
        .payment-modal-content #paymentModalTotal span {
            font-size: 10px !important;
        }
        
        .payment-modal-content > div:last-child {
            gap: 4px !important;
            margin-top: 4px !important;
        }
        
        .payment-modal-content > div:last-child button {
            flex: 1 !important;
            padding: 6px 3px !important;
            font-size: 10px !important;
        }
        
        /* Chek checkbox container */
        .payment-modal-content > div:nth-child(2) {
            flex-wrap: wrap !important;
            gap: 6px !important;
        }
        
        /* Mahsulot tanlash modal ham 280px yuqoridan */
        #quantityModal {
            align-items: flex-start !important;
            justify-content: flex-start !important;
        }
        
        #quantityModal > div {
            margin: 280px auto 10px auto !important;
            max-width: 95vw !important;
        }
    }
    }
    
    @media (max-width: 480px) {
        .sales-container {
            padding: 5px;
        }
        
        .page-header h1 {
            font-size: 16px;
        }
        
        .sales-product-table,
        .cart-table {
            width: 100% !important;
            font-size: 0.75rem !important;
        }
        
        .sales-product-table th,
        .sales-product-table td,
        .cart-table th,
        .cart-table td {
            padding: 6px 3px !important;
            font-size: 0.7rem !important;
        }
    }
    
    /* ============================================ */
    /* TAB SYSTEM STYLES - In-Page Tabs            */
    /* ============================================ */
    
    .sales-tabs-wrapper {
        background: white;
        border-radius: 8px 8px 0 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 0;
        overflow: hidden;
    }
    
    .sales-tabs-header {
        display: flex;
        align-items: center;
        background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 2px solid #dee2e6;
        padding: 8px 15px;
        gap: 10px;
        overflow-x: auto;
        overflow-y: hidden;
        white-space: nowrap;
        scrollbar-width: thin;
        scrollbar-color: #cbd5e0 #f1f3f5;
    }
    
    .sales-tabs-header::-webkit-scrollbar {
        height: 6px;
    }
    
    .sales-tabs-header::-webkit-scrollbar-track {
        background: #f1f3f5;
    }
    
    .sales-tabs-header::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 3px;
    }
    
    .tabs-container {
        display: flex;
        gap: 8px;
        flex: 1;
        align-items: center;
    }
    
    .sales-tab {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: #e9ecef;
        border: 1px solid #ced4da;
        border-radius: 6px 6px 0 0;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
        font-weight: 500;
        color: #495057;
        white-space: nowrap;
        user-select: none;
        min-width: 120px;
        justify-content: space-between;
    }
    
    .sales-tab:hover {
        background: #dee2e6;
        border-color: #adb5bd;
    }
    
    .sales-tab.active {
        background: white;
        border-bottom-color: white;
        color: #007bff;
        font-weight: 600;
        box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
    }
    
    .tab-title {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .tab-close {
        background: transparent;
        border: none;
        color: #6c757d;
        cursor: pointer;
        font-size: 18px;
        font-weight: 600;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 3px;
        transition: all 0.2s;
        line-height: 1;
    }
    
    .tab-close:hover {
        background: #dc3545;
        color: white;
    }
    
    .sales-tab.active .tab-close:hover {
        background: #dc3545;
        color: white;
    }
    
    .btn-new-sale {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        white-space: nowrap;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
    }
    
    .btn-new-sale:hover {
        background: #218838;
        box-shadow: 0 3px 6px rgba(40, 167, 69, 0.3);
        transform: translateY(-1px);
    }
    
    .btn-new-sale:active {
        transform: translateY(0);
    }
    
    .sales-tab-content {
        display: none;
        animation: fadeIn 0.3s ease-in;
    }
    
    .sales-tab-content.active {
        display: block;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Tab badge (mijoz/mahsulotlar soni) */
    .tab-badge {
        background: #007bff;
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: 600;
        margin-left: 4px;
    }
    
    .sales-tab.active .tab-badge {
        background: #0056b3;
    }
</style>
{% endblock %}

{% block content %}
<div class="sales-container">
    <!-- Page Header (yuqorida) -->
    <div class="page-header" style="margin-bottom: 15px;">
        <h1>🛒 Savdo Sahifasi</h1>
    </div>
    
    <!-- Tab System Header -->
    <div class="sales-tabs-wrapper">
        <div class="sales-tabs-header">
            <div class="tabs-container" id="salesTabsContainer">
                <!-- Tabs dinamik qo'shiladi -->
            </div>
            <button class="btn-new-sale" onclick="addNewSaleTab()" title="Yangi savdo ochish">
                + Yangi Savdo
            </button>
        </div>
    </div>
    
    <!-- Tab Contents Wrapper -->
    <div id="salesTabContentsWrapper">
        <!-- Har bir tab content bu yerda bo'ladi -->
    </div>
</div>

<!-- Tab Content Template -->
<template id="saleTabContentTemplate">
    <div class="sales-tab-content" data-tab-id="">
        <!-- Sarlavha olib tashlandi, chunki u endi global yuqorida -->

        <!-- Ikkita 665px kenglikda layout -->
    <div class="sales-grid">
        <!-- Birinchi layout -->
        <div class="sales-layout-box" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); box-sizing: border-box;">
            <!-- Joylashuv va Mijoz tanlash -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500; color: #495057;">📍 Joylashuvni tanlang</label>
                    <select id="locationSelect" onchange="loadProducts()" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; background: white; cursor: pointer;">
                        <option value="">Tanlang...</option>
                    </select>
                </div>
                <div style="position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <label style="font-size: 14px; font-weight: 500; color: #495057;">👤 Mijoz (ixtiyoriy)</label>
                        <button onclick="openAddCustomerModal()" style="padding: 3px 8px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 11px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 3px;">
                            <span style="filter: grayscale(100%) brightness(200%);">➕</span> Yangi
                        </button>
                    </div>
                    <input type="text" id="customerSearch" placeholder="Mijoz nomini kiriting..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    <div id="customerDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ced4da; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 1500; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
                    <input type="hidden" id="selectedCustomerId" value="">
                </div>
            </div>
            
            <!-- Universal Qidiruv maydoni (Barcode + Mahsulot) -->
            <div style="margin-bottom: 15px;">
                <div style="position: relative;">
                    <input type="text" 
                           id="universalSearch" 
                           placeholder="Barcode skanerlang yoki mahsulot nomini kiriting..." 
                           autocomplete="off"
                           style="width: 100%; padding: 10px 45px 10px 10px; border: 2px solid #28a745; border-radius: 6px; font-size: 14px; background: white;">
                    <!-- Mobile uchun native camera input (yashirin) -->
                    <input type="file" 
                           id="nativeCameraInput" 
                           accept="image/*" 
                           capture="environment"
                           style="display: none;">
                    <button id="cameraScanBtn" type="button" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #28a745; border: none; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 18px; color: white; transition: background 0.3s;" onmouseover="this.style.background='#218838'" onmouseout="this.style.background='#28a745'" title="Kamerada barcode skaner qilish">
                        📷
                    </button>
                    <div id="searchStatus" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 5px; padding: 8px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; font-size: 12px; color: #155724; z-index: 100;">
                        ✓ Mahsulot topildi!
                    </div>
                </div>
            </div>
            
            <!-- Mahsulotlar jadvali -->
            <div class="table-wrapper">
                <table class="sales-product-table">
                    <thead>
                        <tr>
                            <th>Mahsulot</th>
                            <th>Mavjud</th>
                            <th>Narx</th>
                            <th>Amal</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 30px; color: #999;">
                                Joylashuvni tanlang
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Pagination -->
            <div id="productsPagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 15px; padding: 10px;">
                <!-- Pagination tugmalari bu yerda dinamik qo'shiladi -->
            </div>
        </div>

        <!-- Ikkinchi layout -->
        <div class="sales-layout-box" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); box-sizing: border-box;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div id="cartCustomerInfo">
                    <h3 style="margin: 0; color: #333;">🛒 Savdo Korzinasi</h3>
                </div>
                <div id="cartTotalHeader" style="text-align: right;"></div>
            </div>
            <div id="cartContainer">
                <div class="table-wrapper">
                    <table class="cart-table">
                        <thead>
                            <tr>
                                <th>Mahsulot</th>
                                <th>Soni</th>
                                <th>Narxi</th>
                                <th>Jami</th>
                                <th>Amal</th>
                            </tr>
                        </thead>
                        <tbody id="cartItems">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 50px; color: #999;">Savat bo'sh</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="cartTotal" style="border-top: 2px solid #dee2e6; padding-top: 10px; font-weight: bold; font-size: 16px; text-align: right;"></div>
                
                <!-- Tugmalar -->
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="savePending()" style="background: #ffc107; color: #333; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">⏸️ Keyinroq tasdiqlash</button>
                    <button onclick="completeSale()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">✅ Yakunlash</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal oyna -->
    <div id="quantityModal" class="modal-overlay">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; padding: 30px; width: 450px; max-width: 90vw; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h3 style="margin: 0 0 20px 0; color: #333;">Mahsulot ma'lumotlari</h3>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">📦 Mahsulot:</label>
                <div id="modalProductName" style="padding: 10px; background: #f8f9fa; border-radius: 4px; font-weight: 500;"></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">📊 Mavjud:</label>
                    <input type="text" id="modalAvailable" readonly style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; background: #e9ecef;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">🔢 Miqdor:</label>
                    <input type="number" id="modalQuantity" min="0.01" step="0.01" value="0" onkeypress="if(event.key === 'Enter') confirmAddToCart()" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">💵 Sotish narxi ($):</label>
                    <input type="number" id="modalPriceUSD" step="0.01" value="0.00" onkeypress="if(event.key === 'Enter') confirmAddToCart()" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">💰 Sotish narxi (UZS):</label>
                    <input type="number" id="modalPriceUZS" step="100" value="0" onkeypress="if(event.key === 'Enter') confirmAddToCart()" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                </div>
            </div>
            <!-- Narx validatsiya xabari -->
            <div id="priceWarning" style="display: none; padding: 10px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; margin-bottom: 15px; color: #856404;">
                <strong>⚠️ Ogohlantirish:</strong> <span id="priceWarningText">Narx juda past, bu narxda sotib bo'lmaydi!</span>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="closeModal()" style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Bekor qilish</button>
                <button onclick="confirmAddToCart()" style="flex: 1; padding: 10px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Qo'shish</button>
            </div>
        </div>
    </div>
    </div> <!-- End of sales-tab-content -->
</template> <!-- End of saleTabContentTemplate -->

<!-- To'lov modal oyna - GLOBAL (barcha tablar uchun bitta modal) -->
<div id="paymentModal" class="modal-overlay">
    <div class="payment-modal-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; padding: 30px; width: 650px; max-width: 90vw; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #333;">💳 To'lov turlari</h3>
            <div id="paymentModalTotal" style="text-align: right;">
                <div style="font-size: 12px; color: #666;">Jami summa:</div>
                <div style="font-weight: 700; color: #28a745; font-size: 16px;"><span id="paymentModalTotalUSD">$0.00</span> / <span id="paymentModalTotalUZS">0 so'm</span></div>
            </div>
        </div>
        
        <!-- Chek chiqarish opsiyalari -->
        <div style="display: flex; gap: 20px; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 15px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="printReceiptUSD" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 500;">🖨️ USD chek chiqarish</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="printReceiptUZS" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 500;">🖨️ UZS chek chiqarish</span>
            </label>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-weight: 500; white-space: nowrap; min-width: 90px;">💵 Naxt:</label>
                <input type="number" id="paymentCashUSD" step="0.01" placeholder="$" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                <input type="number" id="paymentCashUZS" step="1" placeholder="UZS" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                <button onclick="addRemainingToField('paymentCashUSD')" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; white-space: nowrap;">+ Qolgan</button>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-weight: 500; white-space: nowrap; min-width: 90px;">📱 Click:</label>
                <input type="number" id="paymentClickUSD" step="0.01" placeholder="$" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                <input type="number" id="paymentClickUZS" step="1" placeholder="UZS" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                <button onclick="addRemainingToField('paymentClickUSD')" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; white-space: nowrap;">+ Qolgan</button>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-weight: 500; white-space: nowrap; min-width: 90px;">🏧 Terminal:</label>
                <input type="number" id="paymentTerminalUSD" step="0.01" placeholder="$" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                <input type="number" id="paymentTerminalUZS" step="1" placeholder="UZS" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                <button onclick="addRemainingToField('paymentTerminalUSD')" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; white-space: nowrap;">+ Qolgan</button>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-weight: 500; white-space: nowrap; min-width: 90px;">📋 Qarz:</label>
                <input type="number" id="paymentDebtUSD" step="0.01" placeholder="$" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                <input type="number" id="paymentDebtUZS" step="1" placeholder="UZS" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                <button onclick="addRemainingToField('paymentDebtUSD')" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; white-space: nowrap;">+ Qolgan</button>
            </div>
        </div>
        
        <div id="paymentWarning" style="display: none; padding: 10px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin-bottom: 15px; color: #856404; font-size: 14px;"></div>
        
        <div style="display: flex; gap: 10px;">
            <button onclick="closePaymentModal()" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">Bekor qilish</button>
            <button id="confirmPaymentBtn" onclick="confirmPayment()" style="flex: 1; padding: 12px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">✅ Tasdiqlash</button>
        </div>
    </div>
</div>

<!-- Barcode Scanner Modal - Global (barcha tablar uchun bitta modal) -->
<div id="barcodeScannerModal" class="modal-overlay-fullscreen">
    <!-- Yopish tugmasi -->
    <button id="closeScannerBtn" type="button" style="position: fixed; top: 15px; right: 15px; background: rgba(220, 53, 69, 0.9); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 28px; cursor: pointer; z-index: 10001; box-shadow: 0 4px 12px rgba(0,0,0,0.5); backdrop-filter: blur(5px);" title="Yopish">×</button>
    
    <!-- Kamera video - TO'LIQ EKRAN -->
    <div id="barcodeScannerContainer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000;">
        <div id="barcodeScanner" style="width: 100%; height: 100%; object-fit: cover;"></div>
        
        <!-- Skaner overlay -->
        <div id="scannerOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
            <!-- KATTA ramka - butun ekran 90% -->
            <div style="position: absolute; top: 5%; left: 5%; width: 90%; height: 90%; border: 4px solid #28a745; border-radius: 20px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);"></div>
            <!-- Markaziy chiziq -->
            <div style="position: absolute; top: 50%; left: 5%; width: 90%; height: 3px; background: linear-gradient(90deg, transparent, #28a745, transparent); animation: scanLine 2s ease-in-out infinite;"></div>
        </div>
        
        <!-- Status pastda -->
        <div id="scannerStatus" style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; text-align: center; font-size: 16px; font-weight: 600; color: white; padding: 15px 20px; background: rgba(40, 167, 69, 0.9); border-radius: 10px; backdrop-filter: blur(10px); box-shadow: 0 4px 12px rgba(0,0,0,0.4);">
            📷 Barcode ni yashil ramka ichiga joylashtiring
        </div>
    </div>
</div>

<!-- Scan animatsiyasi -->
<style>
    @keyframes scanLine {
        0%, 100% { top: 40%; opacity: 0.3; }
        50% { top: 60%; opacity: 1; }
    }
    
    /* Video element to'liq ekran */
    #barcodeScanner video {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
    }
    
    #barcodeScanner canvas {
        display: none !important;
    }
</style>

<!-- Mijoz qo'shish modal oyna (Global - barcha tablar uchun) -->
<div id="addCustomerModal" class="modal-overlay-customer">
    <div style="background: white; border-radius: 12px; padding: 0; width: 550px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
        <div style="background: white; border-bottom: 1px solid #e9ecef; padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; color: #2c3e50; font-size: 1.5rem; font-weight: 600;">👤 Yangi mijoz qo'shish</h3>
            <button onclick="closeAddCustomerModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999; line-height: 1;">&times;</button>
        </div>
        
        <div style="padding: 2rem;">
            <div id="addCustomerError" style="display: none; padding: 0.75rem; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; margin-bottom: 1rem; color: #721c24; font-size: 14px;"></div>
            <div id="addCustomerSuccess" style="display: none; padding: 0.75rem; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; margin-bottom: 1rem; color: #155724; font-size: 14px;"></div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">Mijoz nomi <span style="color: #e74c3c;">*</span></label>
                <input type="text" id="newCustomerName" placeholder="To'liq ism va familiyani kiriting" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; transition: all 0.3s ease;">
                <div style="font-size: 0.9rem; color: #6c757d; margin-top: 0.25rem;">To'liq ism va familiyani kiriting</div>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">Telefon raqami</label>
                <input type="tel" id="newCustomerPhone" placeholder="+998(99) 406-47-49" maxlength="18" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; transition: all 0.3s ease;">
                <div style="font-size: 0.9rem; color: #6c757d; margin-top: 0.25rem;">Format: +998(99) 406-47-49</div>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">Email manzili</label>
                <input type="email" id="newCustomerEmail" placeholder="mijoz@example.com" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; transition: all 0.3s ease;">
                <div style="font-size: 0.9rem; color: #6c757d; margin-top: 0.25rem;">Elektron pochta manzilini kiriting</div>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">Manzil</label>
                <textarea id="newCustomerAddress" placeholder="To'liq manzilni kiriting..." rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; resize: vertical; transition: all 0.3s ease; min-height: 100px;"></textarea>
                <div style="font-size: 0.9rem; color: #6c757d; margin-top: 0.25rem;">Mijozning to'liq yashash yoki ish manzili</div>
            </div>
            
            <div style="margin-bottom: 2rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">Dokon <span style="color: #e74c3c;">*</span></label>
                <select id="newCustomerStore" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; transition: all 0.3s ease;">
                    <option value="">Dokonni tanlang...</option>
                </select>
                <div style="font-size: 0.9rem; color: #6c757d; margin-top: 0.25rem;">Mijoz qaysi dokonga tegishli</div>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button onclick="closeAddCustomerModal()" style="flex: 1; padding: 0.75rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease;">❌ Bekor qilish</button>
                <button onclick="submitNewCustomer()" style="flex: 1; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease;">✅ Mijozni qo'shish</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Quagga2 Barcode Scanner - Local copy (CDN tracking issues) -->
<script src="{{ url_for('static', filename='js/quagga.min.js') }}"></script>

<script>
    // ============================================
    // DEBUG MODE & HELPER FUNCTIONS
    // ============================================
    const DEBUG = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    function log(...args) { if (DEBUG) console.log(...args); }
    function warn(...args) { if (DEBUG) console.warn(...args); }
    function error(...args) { console.error(...args); } // Xatolar doim ko'rinadi
    
    // XSS himoya funksiyasi
    function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        return String(text)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }
    
    // ============================================
    // TAB MANAGEMENT SYSTEM
    // ============================================
    
    let salesTabs = [];
    let activeTabId = null;
    let tabCounter = 0;
    
    // Tab Storage - har tab uchun alohida ma'lumot
    const TabStorage = {
        getKey(tabId, key) {
            return `sale_tab_${tabId}_${key}`;
        },
        
        set(tabId, key, value) {
            const fullKey = this.getKey(tabId, key);
            localStorage.setItem(fullKey, JSON.stringify(value));
        },
        
        get(tabId, key) {
            const fullKey = this.getKey(tabId, key);
            const data = localStorage.getItem(fullKey);
            return data ? JSON.parse(data) : null;
        },
        
        remove(tabId, key) {
            const fullKey = this.getKey(tabId, key);
            localStorage.removeItem(fullKey);
        },
        
        clearTab(tabId) {
            // Tabning barcha ma'lumotlarini o'chirish
            const keys = Object.keys(localStorage);
            const prefix = `sale_tab_${tabId}_`;
            keys.forEach(key => {
                if (key.startsWith(prefix)) {
                    localStorage.removeItem(key);
                }
            });
        },
        
        saveTabs() {
            // Tablar strukturasini saqlash
            localStorage.setItem('sales_tabs_structure', JSON.stringify(salesTabs));
        },
        
        loadTabs() {
            const data = localStorage.getItem('sales_tabs_structure');
            return data ? JSON.parse(data) : [];
        }
    };
    
    // Sahifa yuklanganda tablarni tiklash
    function initializeTabs() {
        console.log('🚀 Tab sistemasi ishga tushirilmoqda...');
        
        // Saqlangan tablarni yuklash
        const savedTabs = TabStorage.loadTabs();
        
        if (savedTabs.length > 0) {
            console.log('📂 Saqlangan tablar topildi:', savedTabs.length);
            
            // Tab raqamlarini qayta hisoblash (1, 2, 3, ...)
            savedTabs.forEach((tab, index) => {
                const newTabNumber = index + 1;
                tab.title = `Savdo ${newTabNumber}`;
                salesTabs.push(tab);
                createTabElement(tab.id, tab.title);
                createTabContent(tab.id);
            });
            
            // Oxirgi aktiv tabni qayta tiklash
            const lastActiveTab = savedTabs.find(t => t.active) || savedTabs[0];
            switchToTab(lastActiveTab.id);
            // tabCounter ni eng katta ID asosida o'rnatish
            tabCounter = Math.max(...savedTabs.map(t => t.id));
        } else {
            // Birinchi tabni yaratish
            console.log('➕ Birinchi tab yaratilmoqda...');
            addNewSaleTab();
        }
    }
    
    // Yangi tab qo'shish
    function addNewSaleTab() {
        const tabId = ++tabCounter;
        // Tab nomini hozirgi mavjud tablar soni asosida berish (1, 2, 3, ...)
        const tabNumber = salesTabs.length + 1;
        const tabTitle = `Savdo ${tabNumber}`;
        
        console.log(`➕ Yangi tab yaratilmoqda: ${tabTitle} (ID: ${tabId})`);
        
        // Tab strukturasini saqlash
        salesTabs.push({
            id: tabId,
            title: tabTitle,
            active: false,
            createdAt: new Date().toISOString()
        });
        
        // Tab elementini yaratish
        createTabElement(tabId, tabTitle);
        
        // Tab content yaratish
        createTabContent(tabId);
        
        // Yangi tabga o'tish
        switchToTab(tabId);
        
        // Saqlash
        TabStorage.saveTabs();
    }
    
    // Tab element yaratish
    function createTabElement(tabId, title) {
        const tabsContainer = document.getElementById('salesTabsContainer');
        
        const tabDiv = document.createElement('div');
        tabDiv.className = 'sales-tab';
        tabDiv.setAttribute('data-tab-id', tabId);
        tabDiv.onclick = () => switchToTab(tabId);
        
        const titleSpan = document.createElement('span');
        titleSpan.className = 'tab-title';
        titleSpan.textContent = title;
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'tab-close';
        closeBtn.innerHTML = '×';
        closeBtn.onclick = (e) => {
            e.stopPropagation();
            closeSaleTab(tabId);
        };
        
        tabDiv.appendChild(titleSpan);
        tabDiv.appendChild(closeBtn);
        tabsContainer.appendChild(tabDiv);
    }
    
    // Tab content yaratish
    function createTabContent(tabId) {
        const template = document.getElementById('saleTabContentTemplate');
        const clone = template.content.cloneNode(true);
        
        const contentDiv = clone.querySelector('.sales-tab-content');
        contentDiv.setAttribute('data-tab-id', tabId);
        
        // ID'larni unique qilish
        updateElementIds(contentDiv, tabId);
        
        document.getElementById('salesTabContentsWrapper').appendChild(contentDiv);
        
        // Tab uchun event listener'larni o'rnatish
        setupTabEventListeners(tabId);
        
        // Tab uchun ma'lumotlarni yuklash
        loadTabData(tabId);
    }
    
    // Element ID'larini tab-specific qilish
    function updateElementIds(element, tabId) {
        const suffix = `_tab${tabId}`;
        
        // Input va select elementlarni yangilash
        const elementsWithIds = element.querySelectorAll('[id]');
        elementsWithIds.forEach(el => {
            const oldId = el.id;
            const newId = oldId + suffix;
            el.id = newId;
            
            // onclick, onchange kabi atributlarni yangilash
            ['onclick', 'onchange', 'oninput'].forEach(attr => {
                if (el.hasAttribute(attr)) {
                    let attrValue = el.getAttribute(attr);
                    // ID'larni almashtirish
                    attrValue = attrValue.replace(/getElementById\('([^']+)'\)/g, 
                        `getElementById('$1${suffix}')`);
                    el.setAttribute(attr, attrValue);
                }
            });
        });
    }
    
    // Tab uchun event listener'larni o'rnatish
    function setupTabEventListeners(tabId) {
        console.log(`🎧 Tab ${tabId} uchun event listener'lar o'rnatilmoqda...`);
        
        // Universal qidiruv (barcode + mahsulot)
        const universalSearch = document.getElementById(`universalSearch_tab${tabId}`);
        if (universalSearch) {
            // Keyboard navigation
            universalSearch.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    navigateProductTable('down');
                    return;
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    navigateProductTable('up');
                    return;
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    selectCurrentProduct();
                    return;
                }
            });
            
            // Barcode scanner - faqat raqam tugmalari
            universalSearch.addEventListener('keypress', function(e) {
                // Agar faqat raqam bo'lsa, barcode deb hisoblaymiz
                if (/^\d$/.test(e.key)) {
                    barcodeBuffer += e.key;
                    clearTimeout(barcodeTimeout);
                    barcodeTimeout = setTimeout(() => barcodeBuffer = '', 100);
                }
            });
            
            // Input event - mahsulot qidirish
            let searchTimeout = null;
            universalSearch.addEventListener('input', function(e) {
                const value = e.target.value.trim();
                
                // Debounce - 300ms kutish
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    // Agar faqat raqamlar bo'lsa va 8+ belgi - barcode
                    if (/^\d+$/.test(value) && value.length >= 8) {
                        searchProductByBarcode(value);
                    } else {
                        // Aks holda mahsulot qidirish
                        filterProducts();
                    }
                }, 300);
            });
            
            // Focus bo'lganda placeholder o'zgartirish
            universalSearch.addEventListener('focus', function() {
                this.placeholder = 'Mahsulot yoki barcode kiriting...';
            });
            
            console.log('✅ universalSearch event listenerlar qo\'shildi');
        }
        
        // Mijoz qidiruv input
        const customerSearchInput = document.getElementById(`customerSearch_tab${tabId}`);
        if (customerSearchInput) {
            // Input event
            customerSearchInput.addEventListener('input', function() {
                console.log('⌨️ Tab', tabId, 'input event:', this.value);
                searchCustomers(this.value);
            });
            
            // Klaviatura navigatsiyasi
            customerSearchInput.addEventListener('keydown', function(e) {
                const dropdown = document.getElementById(`customerDropdown_tab${tabId}`);
                if (!dropdown) return;
                const isDropdownVisible = dropdown.style.display === 'block';
                
                if (!isDropdownVisible) return;
                
                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        navigateCustomerDropdown('down');
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        navigateCustomerDropdown('up');
                        break;
                    case 'Enter':
                        e.preventDefault();
                        selectCurrentCustomer();
                        break;
                    case 'Escape':
                        dropdown.style.display = 'none';
                        break;
                }
            });
            
            console.log('✅ customerSearch event listenerlar qo\'shildi');
        }
        
        // Camera scan button
        const cameraScanBtn = document.getElementById(`cameraScanBtn_tab${tabId}`);
        if (cameraScanBtn) {
            cameraScanBtn.addEventListener('click', function() {
                console.log('📷 Tab', tabId, 'camera scan button bosildi');
                startBarcodeScanner();
            });
            console.log('✅ cameraScanBtn event listener qo\'shildi');
        } else {
            console.warn('⚠️ cameraScanBtn topilmadi tab', tabId);
        }
        
        // Dropdown tashqarisiga bosish
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById(`customerDropdown_tab${tabId}`);
            const input = document.getElementById(`customerSearch_tab${tabId}`);
            if (dropdown && input && e.target !== input && e.target !== dropdown && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
    }
    
    // Tabga o'tish
    function switchToTab(tabId) {
        console.log(`🔄 Tabga o'tilmoqda: ${tabId}`);
        
        // Eski tabning state'ini saqlash (global o'zgaruvchilardan)
        if (activeTabId && tabStates[activeTabId]) {
            const oldState = tabStates[activeTabId];
            // Global o'zgaruvchilardan state'ga ko'chirish
            oldState.cart = cart.slice(); // Nusxa olish
            oldState.currentProduct = currentProduct;
            oldState.selectedLocationId = selectedLocationId;
            oldState.selectedLocationType = selectedLocationType;
            oldState.editingSaleId = editingSaleId;
            oldState.currentPendingSaleId = currentPendingSaleId;
            
            console.log(`💾 Tab ${activeTabId} state saqlandi:`, oldState);
        }
        
        // Barcha tablarni deactivate qilish
        document.querySelectorAll('.sales-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.sales-tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Tanlangan tabni activate qilish
        const tabElement = document.querySelector(`.sales-tab[data-tab-id="${tabId}"]`);
        const contentElement = document.querySelector(`.sales-tab-content[data-tab-id="${tabId}"]`);
        
        if (tabElement && contentElement) {
            tabElement.classList.add('active');
            contentElement.classList.add('active');
            
            // MUHIM: Avval activeTabId ni yangilash
            activeTabId = tabId;
            
            // Yangi tabning state'ini yuklash
            const newState = initTabState(tabId);
            
            // Global o'zgaruvchilarni yangilash (nusxa olish)
            cart = (newState.cart || []).slice();
            currentProduct = newState.currentProduct || null;
            selectedLocationId = newState.selectedLocationId || null;
            selectedLocationType = newState.selectedLocationType || null;
            editingSaleId = newState.editingSaleId || null;
            currentPendingSaleId = newState.currentPendingSaleId || null;
            
            console.log(`📂 Tab ${tabId} state yuklandi:`, newState);
            
            // Tablar strukturasini yangilash
            salesTabs.forEach(tab => {
                tab.active = (tab.id === tabId);
            });
            
            TabStorage.saveTabs();
            
            // Tab ma'lumotlarini qayta yuklash va UI'ni yangilash
            loadTabData(tabId);
            updateCart(); // Korzinani yangilash
        }
    }
    
    // Tabni yopish
    function closeSaleTab(tabId, skipConfirmation = false) {
        console.log(`❌ Tab yopilmoqda: ${tabId}`);
        
        // Agar faqat bitta tab qolgan bo'lsa, yopishga ruxsat bermaslik
        if (salesTabs.length <= 1) {
            alert('❌ Oxirgi tabni yopib bo\'lmaydi! Kamida bitta savdo tab ochiq bo\'lishi kerak.');
            return;
        }
        
        // Tab ma'lumotlarini tekshirish (faqat manual yopilganda)
        if (!skipConfirmation) {
            const tabState = tabStates[tabId];
            const cart = (tabState && tabState.cart) || [];
            
            // Tasdiqlash xabari
            let confirmMessage = '⚠️ Bu tabni yopmoqchimisiz?\n\n';
            if (cart.length > 0) {
                confirmMessage = `⚠️ Bu tabda ${cart.length} ta mahsulot bor!\n\n` +
                    'Tabni yopsangiz, barcha ma\'lumotlar o\'chadi.\n\n';
            }
            confirmMessage += 'Davom etasizmi?';
            
            const confirmClose = confirm(confirmMessage);
            if (!confirmClose) return;
        }
        
        // Tabni o'chirish
        const tabElement = document.querySelector(`.sales-tab[data-tab-id="${tabId}"]`);
        const contentElement = document.querySelector(`.sales-tab-content[data-tab-id="${tabId}"]`);
        
        if (tabElement) tabElement.remove();
        if (contentElement) contentElement.remove();
        
        // Strukturadan o'chirish
        salesTabs = salesTabs.filter(tab => tab.id !== tabId);
        
        // Tab state'ni tozalash
        delete tabStates[tabId];
        
        // Storage'dan o'chirish
        TabStorage.clearTab(tabId);
        TabStorage.saveTabs();
        
        // Agar yopilgan tab aktiv bo'lsa, boshqa tabga o'tish
        if (activeTabId === tabId) {
            const nextTab = salesTabs[salesTabs.length - 1];
            if (nextTab) {
                switchToTab(nextTab.id);
            }
        }
    }
    
    // Tab ma'lumotlarini yuklash
    function loadTabData(tabId) {
        console.log(`📂 Tab ${tabId} uchun ma'lumotlar yuklanmoqda...`);
        
        // Joylashuvlarni yuklash (har bir tab uchun)
        loadLocations();
        
        // Saqlangan ma'lumotlarni olish
        const cart = TabStorage.get(tabId, 'cart') || [];
        const locationId = TabStorage.get(tabId, 'locationId');
        const locationType = TabStorage.get(tabId, 'locationType');
        const customerId = TabStorage.get(tabId, 'customerId');
        const customerName = TabStorage.get(tabId, 'customerName');
        
        console.log('📦 Yuklangan ma\'lumotlar:', {cart, locationId, locationType, customerId, customerName});
        
        // Ma'lumotlarni UI'ga yuklash
        if (cart && cart.length > 0) {
            cart.forEach(item => addToCart(item.product, item.quantity, item.price));
        }
        if (locationId && locationElement) {
            locationElement.value = locationId;
        }
        if (customerId && customerName) {
            const customerInput = getActiveTabElement('customerSearch');
            if (customerInput) {
                customerInput.value = customerName;
                customerInput.dataset.customerId = customerId;
            }
        }
    }
    
    // Tab ma'lumotlarini saqlash
    function saveTabData(tabId) {
        if (!activeTabId) return;
        
        console.log(`💾 Tab ${tabId} ma'lumotlari saqlanmoqda...`);
        
        // Hozirgi UI state'ni olish va saqlash
        const tabData = {
            cart: cart,
            locationId: getCurrentLocationId(),
            locationType: getCurrentLocationType(),
            customerId: getCurrentCustomerId(),
            customerName: getCurrentCustomerName(),
            timestamp: Date.now()
        };
        
        tabStates.set(tabId, tabData);
        saveTabsToLocalStorage();
    }
    
    // ============================================
    // HELPER FUNKSIYALAR
    // ============================================
    
    // Faol tabdagi elementni topish
    function getActiveTabElement(baseId) {
        const activeTab = document.querySelector('.sales-tab.active');
        if (!activeTab) return null;
        const tabId = activeTab.dataset.tabId;
        return document.getElementById(`${baseId}_tab${tabId}`);
    }
    
    // Faol tab ID'sini olish
    function getActiveTabId() {
        const activeTab = document.querySelector('.sales-tab.active');
        return activeTab ? activeTab.dataset.tabId : null;
    }
    
    // ============================================
    // GLOBAL CACHE - Ma'lumotlarni qayta yuklamaslik uchun
    // ============================================
    let locationsCache = null;
    let customersCache = null;
    let currencyRateCache = null;
    
    // ============================================
    // ESKI KOD - Bu yerdan davom etadi
    // ============================================
    
    // Joylashuvlarni yuklash (caching bilan)
    async function loadLocations() {
        try {
            // Agar cache mavjud bo'lsa, uni ishlatish
            if (locationsCache) {
                console.log('📦 Joylashuvlar cache\'dan olinmoqda...');
                populateLocationSelect(locationsCache);
                return;
            }
            
            console.log('🔄 Joylashuvlarni yuklash boshlandi...');
            const response = await fetch('/api/locations');
            const locations = await response.json();
            
            // Cache'ga saqlash
            locationsCache = locations;
            
            console.log(`📍 API'dan ${locations.length} ta joylashuv olinadi:`, locations);
            populateLocationSelect(locations);
            
        } catch (error) {
            console.error('❌ Joylashuvlarni yuklashda xatolik:', error);
        }
    }
    
    // Location select'ni to'ldirish (alohida funksiya)
    function populateLocationSelect(locations) {
        // Faol tabdagi locationSelect'ni topish
        const activeTab = document.querySelector('.sales-tab.active');
        if (!activeTab) {
            console.warn('⚠️ Faol tab topilmadi');
            return;
        }
        const tabId = activeTab.dataset.tabId;
        const locationSelect = document.getElementById(`locationSelect_tab${tabId}`);
        if (!locationSelect) {
            console.warn('⚠️ locationSelect elementi topilmadi tab', tabId);
            return;
        }
        console.log(`📍 Tab ${tabId} uchun joylashuvlar yuklanmoqda`);
        locationSelect.innerHTML = '<option value="">Tanlang...</option>';
        
        // Foydalanuvchining default store_id'sini olish
        const userStoreId = {{ session.store_id if session.store_id else 'null' }};
        
        locations.forEach(location => {
            const option = document.createElement('option');
            option.value = `${location.type}_${location.id}`;
            const locationType = location.type === 'warehouse' ? '🏭 Ombor' : '🏪 Do\'kon';
            option.textContent = `${locationType}: ${location.name}`;
            
            // Agar user'ning default store'i bo'lsa va bu location mos kelsa, avtomatik tanlash
            if (userStoreId && location.type === 'store' && location.id === userStoreId) {
                option.selected = true;
                selectedLocationId = location.id;
                selectedLocationType = 'store';
            }
            
            locationSelect.appendChild(option);
        });
        
        console.log(`✅ ${locations.length} ta joylashuv select'ga qo'shildi`);
        
        // Agar joylashuv avtomatik tanlangan bo'lsa, mahsulotlarni yuklash
        if (userStoreId && selectedLocationId) {
            loadProducts();
        }
    }
    
    // Mijoz qo'shish modal funksiyalari
    function openAddCustomerModal() {
        const modal = document.getElementById('addCustomerModal');
        const nameInput = document.getElementById('newCustomerName');
        const phoneInput = document.getElementById('newCustomerPhone');
        const emailInput = document.getElementById('newCustomerEmail');
        const addressInput = document.getElementById('newCustomerAddress');
        const storeInput = document.getElementById('newCustomerStore');
        const errorDiv = document.getElementById('addCustomerError');
        const successDiv = document.getElementById('addCustomerSuccess');
        
        if (!modal) {
            console.error('❌ addCustomerModal element topilmadi!');
            return;
        }
        
        modal.style.display = 'flex';
        if (nameInput) nameInput.value = '';
        if (phoneInput) phoneInput.value = '';
        if (emailInput) emailInput.value = '';
        if (addressInput) addressInput.value = '';
        if (storeInput) storeInput.value = '';
        if (errorDiv) errorDiv.style.display = 'none';
        if (successDiv) successDiv.style.display = 'none';
        
        // Do'konlar ro'yxatini yuklash
        loadStoresForModal();
        
        // Fokusni ism maydoniga berish
        setTimeout(() => {
            if (nameInput) nameInput.focus();
        }, 100);
    }
    
    function closeAddCustomerModal() {
        const modal = document.getElementById('addCustomerModal');
        if (modal) modal.style.display = 'none';
    }
    
    // Do'konlar ro'yxatini yuklash
    async function loadStoresForModal() {
        try {
            const response = await fetch('/api/stores');
            const stores = await response.json();
            
            const storeSelect = document.getElementById('newCustomerStore');
            storeSelect.innerHTML = '<option value="">Dokonni tanlang...</option>';
            
            stores.forEach(store => {
                const option = document.createElement('option');
                option.value = store.id;
                option.textContent = store.name;
                storeSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Do\'konlar yuklashda xatolik:', error);
        }
    }
    
    // Telefon raqamini formatlash
    function formatPhoneNumber(input) {
        let value = input.value.replace(/\D/g, '');
        
        if (value.length > 12) {
            value = value.substring(0, 12);
        }
        
        if (value.length > 0 && !value.startsWith('998')) {
            if (value.startsWith('9')) {
                value = '998' + value;
            } else if (value.length >= 9) {
                value = '998' + value.substring(0, 9);
            }
        }
        
        if (value.length >= 3) {
            let formatted = '+' + value.substring(0, 3);
            if (value.length > 3) {
                formatted += '(' + value.substring(3, 5);
                if (value.length > 5) {
                    formatted += ') ' + value.substring(5, 8);
                    if (value.length > 8) {
                        formatted += '-' + value.substring(8, 10);
                        if (value.length > 10) {
                            formatted += '-' + value.substring(10, 12);
                        }
                    }
                }
            }
            input.value = formatted;
        }
    }
    
    async function submitNewCustomer() {
        const name = document.getElementById('newCustomerName').value.trim();
        const phone = document.getElementById('newCustomerPhone').value.trim();
        const email = document.getElementById('newCustomerEmail').value.trim();
        const address = document.getElementById('newCustomerAddress').value.trim();
        const storeId = document.getElementById('newCustomerStore').value;
        
        const errorDiv = document.getElementById('addCustomerError');
        const successDiv = document.getElementById('addCustomerSuccess');
        
        // Xatolik va muvaffaqiyat xabarlarini yashirish
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';
        
        // Validatsiya
        if (!name) {
            errorDiv.textContent = '⚠️ Mijoz nomini to\'ldirish shart!';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (!storeId) {
            errorDiv.textContent = '⚠️ Dokonni tanlash shart!';
            errorDiv.style.display = 'block';
            return;
        }
        
        // Telefon validatsiyasi
        if (phone && phone.length !== 18) {
            errorDiv.textContent = '❌ Telefon raqamini to\'liq formatda kiriting: +998(99) 406-47-49';
            errorDiv.style.display = 'block';
            return;
        }
        
        try {
            const response = await fetch('/api/customers', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: name,
                    phone: phone,
                    email: email,
                    address: address,
                    store_id: storeId
                })
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                errorDiv.textContent = '❌ ' + (result.error || 'Mijoz qo\'shishda xatolik!');
                errorDiv.style.display = 'block';
                return;
            }
            
            console.log('✅ Yangi mijoz qo\'shildi:', result);
            
            // Muvaffaqiyat xabari
            successDiv.textContent = '✅ Mijoz muvaffaqiyatli qo\'shildi!';
            successDiv.style.display = 'block';
            
            // Mijozlar ro'yxatini yangilash
            await loadCustomers();
            
            // Mijozni avtomatik tanlash (selectCustomer funksiyasidan foydalanish)
            const customerName = result.customer.name;
            const customerPhone = result.customer.phone || '';
            
            // Faol tabga mijozni qo'shish
            const activeTab = document.querySelector('.sales-tab.active');
            if (activeTab) {
                const tabId = activeTab.dataset.tabId;
                const customerDisplayText = customerPhone ? `${customerName} - ${customerPhone}` : customerName;
                
                // Input'ga mijoz nomini yozish
                const customerSearch = document.getElementById(`customerSearch_tab${tabId}`);
                const selectedCustomerId = document.getElementById(`selectedCustomerId_tab${tabId}`);
                if (customerSearch) customerSearch.value = customerDisplayText;
                if (selectedCustomerId) selectedCustomerId.value = result.customer.id;
                
                // Korzina sarlavhasida mijoz ma'lumotini ko'rsatish
                const cartCustomerInfo = document.getElementById(`cartCustomerInfo_tab${tabId}`);
                if (cartCustomerInfo) {
                    const customerDisplay = customerPhone ? `👤 ${customerName} ${customerPhone}` : `👤 ${customerName}`;
                    cartCustomerInfo.innerHTML = `<h3 style="margin: 0; color: #333; font-size: 15px; font-weight: 600;">${customerDisplay}</h3>`;
                }
                
                // Tab sarlavhasida mijoz ma'lumotlarini ko'rsatish
                const tabTitle = activeTab.querySelector('.tab-title');
                if (tabTitle) {
                    const tabText = customerPhone ? `${customerName} - ${customerPhone}` : customerName;
                    tabTitle.textContent = tabText;
                    tabTitle.title = customerDisplayText; // Tooltip uchun to'liq ma'lumot
                }
            }
            
            console.log(`✅ Mijoz avtomatik tanlandi: ${customerName} (ID: ${result.customer.id})`);
            
            // 1.5 soniyadan keyin modal yopish
            setTimeout(() => {
                closeAddCustomerModal();
            }, 1500);
            
        } catch (error) {
            console.error('Mijoz qo\'shish xatosi:', error);
            errorDiv.textContent = '❌ Server bilan bog\'lanishda xatolik!';
            errorDiv.style.display = 'block';
        }
    }
    
    // Enter tugmasi bosilganda submit qilish
    document.addEventListener('DOMContentLoaded', function() {
        // Mijoz qo'shish input'lari uchun Enter handler
        const customerInputs = ['newCustomerName', 'newCustomerPhone', 'newCustomerEmail', 'newCustomerAddress'];
        customerInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        submitNewCustomer();
                    }
                });
            }
        });
        
        // Telefon input formatlash
        const phoneInput = document.getElementById('newCustomerPhone');
        if (phoneInput) {
            phoneInput.addEventListener('input', function() {
                formatPhoneNumber(this);
            });
            
            phoneInput.addEventListener('keydown', function(e) {
                if (![8, 9, 27, 13, 46, 37, 38, 39, 40].includes(e.keyCode) && 
                    (e.keyCode < 48 || e.keyCode > 57) && 
                    (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }
            });
        }
        
        // Input focus effektlari
        const modalInputs = document.querySelectorAll('#addCustomerModal input, #addCustomerModal textarea, #addCustomerModal select');
        modalInputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.style.borderColor = '#667eea';
                this.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.1)';
            });
            input.addEventListener('blur', function() {
                this.style.borderColor = '#e9ecef';
                this.style.boxShadow = 'none';
            });
        });
    });
    
    // BARCODE SCANNER FUNKSIYASI
    let barcodeBuffer = '';
    let barcodeTimeout = null;
    
    async function searchProductByBarcode(barcode) {
        console.log('🔍 Barcode qidiruvi:', barcode);
        
        // Joylashuv tanlanganligini tekshirish
        if (!selectedLocationId || !selectedLocationType) {
            showBarcodeStatus('⚠️ Avval joylashuvni tanlang!', 'error');
            return;
        }
        
        showBarcodeStatus('⏳ Qidirilmoqda...', 'loading');
        
        try {
            const response = await fetch('/api/search-product-by-barcode', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    barcode: barcode,
                    location_type: selectedLocationType,
                    location_id: selectedLocationId
                })
            });
            
            const result = await response.json();
            
            // Yangi API format: { success: true, data: {...} } yoki { success: false, error: '...' }
            if (!response.ok || !result.success) {
                const errorMsg = result.error || 'Mahsulot topilmadi';
                showBarcodeStatus(`❌ ${errorMsg}`, 'error');
                // Barcode inputni tozalash
                document.getElementById('barcodeInput').value = '';
                return;
            }
            
            // Mahsulot ma'lumotlarini olish (yangi formatda data ichida)
            const product = result.data || result;
            console.log('✅ Mahsulot topildi:', product);
            
            // Mahsulotni darhol savatga qo'shish
            addToCart(product.id, product.name, product.available_quantity, product.sell_price, product.cost_price);
            
            // Statusni ko'rsatish
            showBarcodeStatus(`✓ ${product.name} savatga qo'shildi!`, 'success');
            
            // Universal qidiruv inputini tozalash
            const universalSearch = getActiveTabElement('universalSearch');
            if (universalSearch) universalSearch.value = '';
            
            // Barcode inputni tozalash
            const barcodeInput = document.getElementById('barcodeInput');
            if (barcodeInput) barcodeInput.value = '';
            
        } catch (error) {
            console.error('❌ Barcode qidiruv xatosi:', error);
            showBarcodeStatus('❌ Server xatosi', 'error');
            const universalSearch = getActiveTabElement('universalSearch');
            if (universalSearch) universalSearch.value = '';
        }
    }
    
    function showBarcodeStatus(message, type) {
        const statusDiv = getActiveTabElement('searchStatus');
        if (!statusDiv) return;
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
        
        // Rang o'zgartirish
        if (type === 'success') {
            statusDiv.style.background = '#d4edda';
            statusDiv.style.borderColor = '#c3e6cb';
            statusDiv.style.color = '#155724';
            // Success xabarni 1 soniyadan keyin yashirish
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 1000);
        } else if (type === 'error') {
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.borderColor = '#f5c6cb';
            statusDiv.style.color = '#721c24';
            // Error xabarni 3 soniyadan keyin yashirish
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        } else if (type === 'loading') {
            statusDiv.style.background = '#d1ecf1';
            statusDiv.style.borderColor = '#bee5eb';
            statusDiv.style.color = '#0c5460';
        }
    }
    
    // ==================== BARCODE SCANNER ====================
    let scannerActive = false;
    
    // Mobile qurilma tekshirish
    function isMobileDevice() {
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        const mobileRegex = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i;
        return mobileRegex.test(userAgent);
    }

    function startBarcodeScanner() {
        console.log('📷 Camera scan funksiyasi boshlandi');
        
        // Barcha qurilmalarda web camera modal ishlatish (facingMode: environment bilan)
        console.log('📷 Web camera modal ochilmoqda (orqa kamera)...');
        startWebCameraScanner();
    }
    
    // Native camera scanner (mobile uchun - to'liq ekran native app)
    function startNativeCameraScanner() {
        const nativeCameraInput = getActiveTabElement('nativeCameraInput');
        if (!nativeCameraInput) {
            console.error('❌ nativeCameraInput topilmadi!');
            alert('❌ Kamera ochilmadi!');
            return;
        }
        
        // Orqa kamerani majburlash (ba'zi brauzerlarda ishlaydi)
        // Har safar yangi input yaratish - ba'zi telefonlarda cache muammosi yechiladi
        const newInput = document.createElement('input');
        newInput.type = 'file';
        newInput.accept = 'image/*';
        newInput.capture = 'environment'; // Orqa kamera
        newInput.style.display = 'none';
        
        // Event listener qo'shish
        newInput.addEventListener('change', handleNativeCameraImage);
        
        // Eski inputni almashtirish
        nativeCameraInput.parentNode.replaceChild(newInput, nativeCameraInput);
        newInput.id = nativeCameraInput.id;
        
        // Kamerani ochish
        newInput.click();
    }
    
    // Native camera'dan olingan rasmni decode qilish
    async function handleNativeCameraImage(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        console.log('📷 Rasm olindi:', file.name);
        
        const reader = new FileReader();
        reader.onload = function(e) {
            console.log('🖼️ Barcode qidirilmoqda...');
            
            Quagga.decodeSingle({
                src: e.target.result,
                numOfWorkers: 0,
                decoder: {
                    readers: ["ean_reader", "ean_8_reader", "code_128_reader", "upc_reader", "upc_e_reader"]
                },
                locate: true
            }, function(result) {
                if (result && result.codeResult) {
                    const code = result.codeResult.code;
                    console.log('✅ Barcode topildi:', code);
                    
                    if (navigator.vibrate) navigator.vibrate(200);
                    
                    const universalSearch = getActiveTabElement('universalSearch');
                    if (universalSearch) {
                        universalSearch.value = code;
                        setTimeout(() => {
                            const event = new Event('input', { bubbles: true });
                            universalSearch.dispatchEvent(event);
                        }, 100);
                    }
                } else {
                    console.warn('⚠️ Barcode topilmadi');
                    alert("❌ Barcode topilmadi!\n\n💡 Maslahat:\n• Rasmni yaxshiroq yorug'likda oling\n• Barcode'ni aniq ko'rsating\n• Qayta urinib ko'ring");
                }
            });
        };
        reader.readAsDataURL(file);
        event.target.value = '';
    }
    
    // Web camera scanner (desktop uchun - KATTA SCAN AREA)
    function startWebCameraScanner() {
        const modal = document.getElementById('barcodeScannerModal');
        const statusDiv = document.getElementById('scannerStatus');
        
        console.log('   Protocol:', window.location.protocol);
        console.log('   Hostname:', window.location.hostname);
        console.log('   getUserMedia support:', !!navigator.mediaDevices?.getUserMedia);
        
        // HTTPS tekshiruvi - localhost va server IP uchun istisno
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const isServerIP = window.location.hostname === '139.59.154.185'; // Server IP
        const isHTTPS = window.location.protocol === 'https:';
        
        // getUserMedia tekshiruvi
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            console.error('❌ Brauzer kamerani qo\'llab-quvvatlamaydi');
            alert('⚠️ Kamera ishlamayapti!\n\nSabab: Brauzer kamerani qo\'llab-quvvatlamaydi\n\n✅ Yechim:\n• Chrome yoki Firefox brauzerni ishlating\n• Barcode ni qo\'lda kiriting');
            return;
        }
        
        if (!isHTTPS && !isLocalhost && !isServerIP) {
            console.warn('⚠️ HTTPS yo\'q - kamera ishlamaydi');
            alert('⚠️ Kamera HTTP orqali ishlamaydi!\n\n✅ Yechim:\n1. Barcode ni qo\'lda kiriting\n2. Yoki administrator HTTPS o\'rnatsin\n\n💡 Hozir: Barcode raqamini input maydoniga kiriting');
            return;
        }
        
        console.log('✅ Kamera ochilmoqda...');
        modal.style.display = 'block';
        scannerActive = true;
        statusDiv.innerHTML = '🔄 Kamera ochilmoqda...';
        
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#barcodeScanner'),
                constraints: {
                    width: { min: 640, ideal: 1920, max: 1920 },
                    height: { min: 480, ideal: 1080, max: 1080 },
                    facingMode: "environment", // Orqa kamera
                    aspectRatio: { ideal: 16/9 }
                },
                area: { // KATTA scan area - butun ekran
                    top: "5%",
                    right: "5%",
                    left: "5%",
                    bottom: "5%"
                }
            },
            locate: true,
            numOfWorkers: 0, // Web Worker o'chirish - TEZROQ
            frequency: 20, // 20 fps - TEZROQ
            decoder: {
                readers: [
                    "ean_reader",
                    "ean_8_reader",
                    "code_128_reader",
                    "upc_reader",
                    "upc_e_reader"
                ],
                multiple: false
            },
            locator: {
                patchSize: "medium",
                halfSample: true // Yarmi resolution - TEZROQ
            }
        }, function(err) {
            if (err) {
                console.error('❌ Scanner xatosi:', err);
                console.error('Xato tafsilotlari:', err.name, err.message);
                let errorMsg = '❌ ';
                
                if (err.name === 'NotAllowedError') {
                    errorMsg += 'Kameraga ruxsat berilmadi!\n\n✅ Yechim:\n1. Brauzer sozlamalarida kameraga ruxsat bering\n2. Sahifani yangilang va "Allow" bosing';
                    alert(errorMsg);
                } else if (err.name === 'NotFoundError') {
                    errorMsg += 'Kamera topilmadi!\n\n✅ Yechim:\n1. Qurilmangizda kamera borligini tekshiring\n2. Boshqa brauzerda sinab ko\'ring';
                    alert(errorMsg);
                } else if (err.name === 'OverconstrainedError') {
                    // Orqa kamera topilmasa, standart kamerani ishlatish
                    console.log('⚠️ Orqa kamera topilmadi, standart kamera ishlatilmoqda...');
                    startBarcodeScannerWithFallback();
                    return;
                } else {
                    errorMsg += 'Kamera ochilmadi: ' + err.message;
                    alert(errorMsg);
                }
                
                statusDiv.innerHTML = errorMsg;
                stopBarcodeScanner();
                return;
            }
            console.log('✅ Scanner ishga tushdi');
            statusDiv.innerHTML = "✅ Barcode ni yashil ramka ichiga joylashtiring";
            Quagga.start();
        });

        Quagga.onDetected(function(result) {
            if (!scannerActive) return;
            
            const code = result.codeResult.code;
            console.log('📷 Barcode topildi:', code);
            
            // Vibration feedback (telefon uchun)
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
            
            // Input maydoniga yozish
            const universalSearch = getActiveTabElement('universalSearch');
            if (universalSearch) universalSearch.value = code;
            
            // Scanner yopish
            stopBarcodeScanner();
            
            // Qidiruvni avtomatik ishga tushirish
            setTimeout(() => {
                const universalSearch = getActiveTabElement('universalSearch');
                if (universalSearch) {
                    const event = new Event('input', { bubbles: true });
                    universalSearch.dispatchEvent(event);
                }
            }, 100);
        });
    }
    
    // Fallback: standart kamera bilan
    function startBarcodeScannerWithFallback() {
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#barcodeScanner'),
                constraints: {
                    width: { min: 640, ideal: 1920 },
                    height: { min: 480, ideal: 1080 }
                },
                area: { // KATTA scan area
                    top: "5%",
                    right: "5%",
                    left: "5%",
                    bottom: "5%"
                }
            },
            locate: true,
            numOfWorkers: 0,
            frequency: 20,
            decoder: {
                readers: ["ean_reader", "ean_8_reader", "code_128_reader", "upc_reader"],
                multiple: false
            },
            locator: {
                patchSize: "medium",
                halfSample: true
            }
        }, function(err) {
            if (err) {
                document.getElementById('scannerStatus').innerHTML = '❌ Kamera ishga tushmadi';
                stopBarcodeScanner();
                return;
            }
            document.getElementById('scannerStatus').innerHTML = "✅ Barcode ni yashil ramka ichiga joylashtiring";
            Quagga.start();
        });
        
        Quagga.onDetected(function(result) {
            if (!scannerActive) return;
            const code = result.codeResult.code;
            if (navigator.vibrate) navigator.vibrate(200);
            const universalSearch = getActiveTabElement('universalSearch');
            if (universalSearch) universalSearch.value = code;
            stopBarcodeScanner();
            setTimeout(() => {
                const universalSearch = getActiveTabElement('universalSearch');
                if (universalSearch) {
                    const event = new Event('input', { bubbles: true });
                    universalSearch.dispatchEvent(event);
                }
            }, 100);
        });
    }

    function stopBarcodeScanner() {
        scannerActive = false;
        const modal = document.getElementById('barcodeScannerModal');
        
        if (Quagga) {
            Quagga.stop();
        }
        
        modal.style.display = 'none';
        console.log('🛑 Scanner to\'xtatildi');
    }

    // Yopish tugmasi - global (barcha tablar uchun bitta modal)
    const closeScannerBtn = document.getElementById('closeScannerBtn');
    if (closeScannerBtn) {
        closeScannerBtn.addEventListener('click', function() {
            stopBarcodeScanner();
        });
    }

    // Modal tashqarisiga bosganda yopish
    const barcodeScannerModal = document.getElementById('barcodeScannerModal');
    if (barcodeScannerModal) {
        barcodeScannerModal.addEventListener('click', function(e) {
            if (e.target.id === 'barcodeScannerModal') {
                stopBarcodeScanner();
            }
        });
    }

    // Mijozlarni yuklash va qidirish
    let allCustomers = [];
    
    // Tab-specific state (har bir tab uchun alohida)
    const tabStates = {};
    
    // Har bir tab uchun state yaratish
    function initTabState(tabId) {
        if (!tabStates[tabId]) {
            tabStates[tabId] = {
                cart: [],
                currentProduct: null,
                selectedLocationId: null,
                selectedLocationType: null,
                editingSaleId: null,
                currentPendingSaleId: null,
                autosaveTimeout: null
            };
        }
        return tabStates[tabId];
    }
    
    // Active tab state ni olish
    function getTabState() {
        if (!activeTabId) return null;
        return initTabState(activeTabId);
    }
    
    // ============================================
    // XAVFSIZ GETTER/SETTER FUNKSIYALARI
    // Global o'zgaruvchilar o'rniga tabStates dan foydalanish
    // ============================================
    
    // Cart getter/setter
    function getCart() {
        const state = getTabState();
        return state ? state.cart : [];
    }
    
    function setCart(value) {
        const state = getTabState();
        if (state) state.cart = value;
    }
    
    // CurrentProduct getter/setter
    function getCurrentProduct() {
        const state = getTabState();
        return state ? state.currentProduct : null;
    }
    
    function setCurrentProduct(value) {
        const state = getTabState();
        if (state) state.currentProduct = value;
    }
    
    // SelectedLocationId getter/setter
    function getSelectedLocationId() {
        const state = getTabState();
        return state ? state.selectedLocationId : null;
    }
    
    function setSelectedLocationId(value) {
        const state = getTabState();
        if (state) state.selectedLocationId = value;
    }
    
    // SelectedLocationType getter/setter
    function getSelectedLocationType() {
        const state = getTabState();
        return state ? state.selectedLocationType : null;
    }
    
    function setSelectedLocationType(value) {
        const state = getTabState();
        if (state) state.selectedLocationType = value;
    }
    
    // EditingSaleId getter/setter
    function getEditingSaleId() {
        const state = getTabState();
        return state ? state.editingSaleId : null;
    }
    
    function setEditingSaleId(value) {
        const state = getTabState();
        if (state) state.editingSaleId = value;
    }
    
    // CurrentPendingSaleId getter/setter
    function getCurrentPendingSaleId() {
        const state = getTabState();
        return state ? state.currentPendingSaleId : null;
    }
    
    function setCurrentPendingSaleId(value) {
        const state = getTabState();
        if (state) state.currentPendingSaleId = value;
    }
    
    // ============================================
    // BACKWARD COMPATIBILITY - Eski kod bilan ishlash uchun
    // Bu o'zgaruvchilar keyinroq olib tashlanadi
    // ============================================
    let cart = [];
    let currentProduct = null;
    let selectedLocationId = null;
    let selectedLocationType = null;
    
    // Tahrirlash rejimi uchun
    let editingSaleId = null;  // Agar savdo tahrirlanyotgan bo'lsa, ID saqlanadi
    
    // Autosave uchun
    let currentPendingSaleId = null;  // Hozirgi pending savdo ID
    let autosaveTimeout = null;  // Debounce uchun
    
    // Klaviatura navigatsiyasi uchun o'zgaruvchilar
    let visibleProductRows = [];
    let currentSelectedRowIndex = -1;
    
    // Mijoz qidiruv klaviatura navigatsiyasi uchun
    let filteredCustomers = [];
    let selectedCustomerIndex = -1;
    
    async function loadCustomers() {
        try {
            // Agar cache mavjud bo'lsa, uni ishlatish
            if (customersCache) {
                console.log('📦 Mijozlar cache\'dan olinmoqda...');
                allCustomers = customersCache;
                console.log(`✅ ${allCustomers.length} ta mijoz cache'dan yuklandi`);
                return;
            }
            
            console.log('🔄 Mijozlarni yuklash boshlandi...');
            const response = await fetch('/api/customers');
            console.log('📡 API response status:', response.status);
            if (!response.ok) {
                console.error('❌ Mijozlarni yuklashda xatolik: HTTP', response.status);
                return;
            }
            const data = await response.json();
            console.log('📦 API response data:', data);
            // API to'g'ridan-to'g'ri array qaytaradi
            allCustomers = Array.isArray(data) ? data : (data.customers || []);
            
            // Cache'ga saqlash
            customersCache = allCustomers;
            
            console.log(`✅ ${allCustomers.length} ta mijoz yuklandi`, allCustomers);
        } catch (error) {
            console.error('❌ Mijozlarni yuklashda xatolik:', error);
        }
    }
    
    function searchCustomers(searchText) {
        console.log('🔍 searchCustomers chaqirildi:', searchText, 'Jami mijozlar:', allCustomers.length);
        
        // Faol tabdagi dropdown'ni topish
        const activeTab = document.querySelector('.sales-tab.active');
        if (!activeTab) {
            console.warn('⚠️ Faol tab topilmadi');
            return;
        }
        const tabId = activeTab.dataset.tabId;
        const dropdown = document.getElementById(`customerDropdown_tab${tabId}`);
        if (!dropdown) {
            console.warn('⚠️ customerDropdown topilmadi tab', tabId);
            return;
        }
        selectedCustomerIndex = -1;
        
        if (!searchText || searchText.length < 2) {
            console.log('⚠️ Qidiruv matni 2 ta belgidan kam');
            dropdown.style.display = 'none';
            filteredCustomers = [];
            return;
        }
        
        filteredCustomers = allCustomers.filter(customer => {
            const name = customer.name ? customer.name.toLowerCase() : '';
            const phone = customer.phone ? customer.phone : '';
            const search = searchText.toLowerCase();
            
            // Telefon raqamdan barcha maxsus belgilarni olib tashlash
            const cleanPhone = phone.replace(/[\s\-\(\)\+]/g, '');
            const cleanSearch = search.replace(/[\s\-\(\)\+]/g, '');
            
            return name.includes(search) || cleanPhone.includes(cleanSearch);
        });
        
        console.log('📋 Filterlangan mijozlar soni:', filteredCustomers.length);
        
        if (filteredCustomers.length === 0) {
            dropdown.innerHTML = '<div style="padding: 10px; color: #999; text-align: center;">Mijoz topilmadi</div>';
            dropdown.style.display = 'block';
            return;
        }
        
        renderCustomerDropdown();
        dropdown.style.display = 'block';
    }
    
    function renderCustomerDropdown() {
        // Faol tabdagi dropdown'ni topish
        const activeTab = document.querySelector('.sales-tab.active');
        if (!activeTab) return;
        const tabId = activeTab.dataset.tabId;
        const dropdown = document.getElementById(`customerDropdown_tab${tabId}`);
        if (!dropdown) return;
        
        dropdown.innerHTML = filteredCustomers.map((customer, index) => {
            const isSelected = index === selectedCustomerIndex;
            const bgColor = isSelected ? '#2196F3' : 'white';
            const hoverBg = isSelected ? '#2196F3' : '#f8f9fa';
            const textColor = isSelected ? 'white' : '#333';
            const phoneColor = isSelected ? 'white' : '#6c757d';
            const safeName = escapeHtml(customer.name);
            const safePhone = escapeHtml(customer.phone);
            return `<div class="customer-item" data-customer-id="${customer.id}" data-customer-name="${safeName}" data-customer-phone="${safePhone}" data-index="${index}"
                    style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: all 0.2s; background: ${bgColor};"
                    onmouseover="this.style.background='${hoverBg}'"
                    onmouseout="this.style.background='${bgColor}'">
                    <div style="font-weight: 500; color: ${textColor};">${safeName}</div>
                    <div style="font-size: 12px; color: ${phoneColor};">${safePhone || "Telefon yo'q"}</div>
                </div>`;
        }).join('');
        
        // Event listener'larni qo'shish
        dropdown.querySelectorAll('.customer-item').forEach(item => {
            item.addEventListener('click', function() {
                const customerId = parseInt(this.dataset.customerId);
                const customerName = this.dataset.customerName;
                const customerPhone = this.dataset.customerPhone;
                selectCustomer(customerId, customerName, customerPhone);
            });
        });
    }
    
    function navigateCustomerDropdown(direction) {
        if (filteredCustomers.length === 0) return;
        
        if (direction === 'down') {
            selectedCustomerIndex = (selectedCustomerIndex + 1) % filteredCustomers.length;
        } else if (direction === 'up') {
            selectedCustomerIndex = selectedCustomerIndex <= 0 ? filteredCustomers.length - 1 : selectedCustomerIndex - 1;
        }
        
        renderCustomerDropdown();
        
        // Scroll to selected item
        const activeTab = document.querySelector('.sales-tab.active');
        if (!activeTab) return;
        const tabId = activeTab.dataset.tabId;
        const dropdown = document.getElementById(`customerDropdown_tab${tabId}`);
        if (!dropdown) return;
        const selectedItem = dropdown.querySelector(`[data-index="${selectedCustomerIndex}"]`);
        if (selectedItem) {
            selectedItem.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
    }
    
    function selectCurrentCustomer() {
        if (selectedCustomerIndex >= 0 && selectedCustomerIndex < filteredCustomers.length) {
            const customer = filteredCustomers[selectedCustomerIndex];
            selectCustomer(customer.id, customer.name, customer.phone || '');
        }
    }
    
    function selectCustomer(id, name, phone) {
        // Faol tabdagi elementlarni topish
        const activeTab = document.querySelector('.sales-tab.active');
        if (!activeTab) return;
        const tabId = activeTab.dataset.tabId;
        
        const displayText = phone ? `${name} - ${phone}` : name;
        const customerSearch = document.getElementById(`customerSearch_tab${tabId}`);
        const selectedCustomerId = document.getElementById(`selectedCustomerId_tab${tabId}`);
        const customerDropdown = document.getElementById(`customerDropdown_tab${tabId}`);
        
        if (customerSearch) customerSearch.value = displayText;
        if (selectedCustomerId) selectedCustomerId.value = id;
        if (customerDropdown) customerDropdown.style.display = 'none';
        
        // Savdo korzinasi sarlavhasida mijoz ma'lumotlarini ko'rsatish
        const cartCustomerInfo = document.getElementById(`cartCustomerInfo_tab${tabId}`);
        if (cartCustomerInfo) {
            const customerDisplay = phone ? `👤 ${name} ${phone}` : `👤 ${name}`;
            cartCustomerInfo.innerHTML = `<h3 style="margin: 0; color: #333; font-size: 15px; font-weight: 600;">${customerDisplay}</h3>`;
        }
        
        // Tab sarlavhasida mijoz ma'lumotlarini ko'rsatish
        const tabTitle = activeTab.querySelector('.tab-title');
        if (tabTitle) {
            const tabText = phone ? `${name} - ${phone}` : name;
            tabTitle.textContent = tabText;
            tabTitle.title = displayText; // Tooltip uchun to'liq ma'lumot
        }
        
        console.log(`✅ Mijoz tanlandi: ${name} (ID: ${id})`);
        
        // Fokusni mahsulot qidirish maydoniga o'tkazish
        const universalSearch = document.getElementById(`universalSearch_tab${tabId}`);
        if (universalSearch) {
            setTimeout(() => universalSearch.focus(), 100);
        }
    }
    
    // Mahsulot miqdorini yangilash - cache'ni tozalab jadvalni qayta yuklash
    async function updateProductQuantityInTable(productId, soldQuantity) {
        try {
            const activeTab = document.querySelector('.sales-tab.active');
            if (!activeTab) return;
            const tabId = activeTab.dataset.tabId;
            const locationSelect = document.getElementById(`locationSelect_tab${tabId}`);
            const locationValue = locationSelect?.value;
            if (!locationValue) return;
            
            // Joriy sahifaning cache'ini tozalash
            const cacheKey = `${locationValue}_${currentPage}`;
            productsCache.delete(cacheKey);
            
            // Jadvalni yangilash (cache'siz, backend'dan yangi ma'lumot oladi)
            await loadProducts(currentPage);
            
            console.log(`🔄 Mahsulotlar jadvali yangilandi (cache tozalandi)`);
        } catch (error) {
            console.error('Jadvalni yangilashda xatolik:', error);
        }
    }
    
    // Event delegation handler - mahsulot buttonlari uchun
    function handleProductClick(event) {
        const btn = event.target.closest('.add-to-cart-btn');
        const row = event.target.closest('tr');
        
        // Mobilda butun qatorni bosish (agar tugma bosilmagan bo'lsa)
        if (!btn && row && row.hasAttribute('data-product-id')) {
            // Faqat mobil ekranlarda ishlashi kerak (768px dan kichik)
            if (window.innerWidth <= 768) {
                event.preventDefault();
                event.stopPropagation();
                
                const productId = parseInt(row.getAttribute('data-product-id'));
                const productName = row.querySelector('td:first-child')?.getAttribute('data-original-text') || '';
                const quantityBadge = row.querySelector('td:nth-child(2) span');
                
                // Miqdorni olish - unit type bilan birga
                let quantity = 0;
                if (quantityBadge) {
                    const quantityText = quantityBadge.textContent.trim();
                    quantity = parseFloat(quantityText.replace(/[^0-9.]/g, '')) || 0;
                }
                
                // Narxni olish - span ichidagi matnni parse qilish
                const priceSpan = row.querySelector('td:nth-child(3) span:first-child');
                let price = 0;
                if (priceSpan) {
                    const priceText = priceSpan.textContent.replace(/[^0-9.]/g, '');
                    price = parseFloat(priceText) || 0;
                }
                
                const costPrice = parseFloat(row.getAttribute('data-cost-price')) || 0;
                const unitType = row.getAttribute('data-unit-type') || 'dona';
                
                // Agar miqdor 0 dan katta bo'lsa, qo'shish
                if (quantity > 0) {
                    addToCart(productId, productName, quantity, price, costPrice, unitType);
                }
                return;
            }
        }
        
        // Desktop yoki tugma bosilgan holda
        if (!btn || btn.disabled) return;
        
        event.preventDefault();
        event.stopPropagation();
        
        const productId = parseInt(btn.dataset.productId);
        const productName = btn.dataset.productName;
        const quantity = parseFloat(btn.dataset.quantity);
        const price = parseFloat(btn.dataset.price);
        const costPrice = parseFloat(btn.dataset.costPrice);
        const unitType = btn.dataset.unitType || 'dona';
        
        addToCart(productId, productName, quantity, price, costPrice, unitType);
    }
    
    // Mahsulotlarni yuklash
    // Pagination o'zgaruvchilari
    let currentPage = 1;
    const itemsPerPage = 30;
    let totalProducts = 0;
    let productsCache = new Map(); // Sahifalarni cache qilish

    async function loadProducts(page = 1) {
        currentPage = page;
        
        // Faol tabdagi elementlarni topish
        const activeTab = document.querySelector('.sales-tab.active');
        if (!activeTab) {
            console.warn('⚠️ Faol tab topilmadi');
            return;
        }
        const tabId = activeTab.dataset.tabId;
        const locationSelect = document.getElementById(`locationSelect_tab${tabId}`);
        const tbody = document.getElementById(`productsTable_tab${tabId}`);
        
        if (!locationSelect || !tbody) {
            console.warn('⚠️ locationSelect yoki productsTable topilmadi tab', tabId);
            return;
        }
        
        const locationValue = locationSelect.value;
        
        if (!locationValue) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px; color: #999;">Joylashuvni tanlang</td></tr>';
            selectedLocationId = null;
            selectedLocationType = null;
            document.getElementById(`productsPagination_tab${tabId}`).innerHTML = '';
            productsCache.clear();
            return;
        }
        
        // Tanlangan joylashuvni saqlash
        const [type, id] = locationValue.split('_');
        selectedLocationType = type;
        selectedLocationId = parseInt(id);
        
        // Tab state'ni yangilash
        const tabState = getTabState();
        if (tabState) {
            tabState.selectedLocationType = type;
            tabState.selectedLocationId = parseInt(id);
            console.log(`💾 Tab ${tabId} location saqlandi:`, type, parseInt(id));
        }
        
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">⏳ Yuklanmoqda...</td></tr>';
        
        try {
            // Cache'dan tekshirish
            const cacheKey = `${locationValue}_${page}`;
            let data, products;
            
            if (productsCache.has(cacheKey)) {
                // Cache'dan olish
                const cached = productsCache.get(cacheKey);
                products = cached.products;
                totalProducts = cached.total;
                console.log("✅ Cache'dan yuklandi:", products.length, "ta mahsulot");
            } else {
                // Backend'dan sahifa-sahifa yuklash
                const response = await fetch(`/api/products?location=${locationValue}&page=${page}&per_page=${itemsPerPage}`);
                data = await response.json();
                
                console.log('🌐 API response:', data);
                
                // API dan kelgan ma'lumotni to'g'ri parse qilish
                products = data.products || [];
                totalProducts = (data.pagination && data.pagination.total) ? data.pagination.total : products.length;
                
                console.log('📊 Parsed:', products.length, 'ta mahsulot, jami:', totalProducts);
                
                // Cache'ga saqlash
                productsCache.set(cacheKey, { products, total: totalProducts });
                console.log('🌐 Serverdan yuklandi:', products.length, 'ta mahsulot');
            }
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">Mahsulotlar topilmadi</td></tr>';
                document.getElementById(`productsPagination_tab${tabId}`).innerHTML = '';
                return;
            }
            
            // Tezkor render qilish
            const fragment = document.createDocumentFragment();
            products.forEach(product => {
                // Quantity va selling price ni olish
                let quantity = 0;
                let sellingPrice = product.sell_price || product.price || 0;
                
                // O'lchov birligi
                const unitType = product.unit_type || 'dona';
                
                // Agar stocks mavjud bo'lsa, locationga mos keladiganini topish
                if (product.stocks && product.stocks.length > 0) {
                    const [type, id] = locationValue.split('_');
                    const locationId = parseInt(id);
                    
                    // Mos stock ni topish
                    const matchingStock = product.stocks.find(stock => {
                        if (type === 'warehouse') {
                            return stock.warehouse_id === locationId;
                        } else if (type === 'store') {
                            return stock.store_id === locationId;
                        }
                        return false;
                    });
                    
                    if (matchingStock) {
                        quantity = matchingStock.quantity || 0;
                    }
                }
                
                // Miqdorni format qilish
                const quantityDisplay = unitType === 'litr' 
                    ? `${parseFloat(quantity).toFixed(2)} L` 
                    : (quantity % 1 === 0 ? `${Math.floor(quantity)} dona` : `${parseFloat(quantity).toFixed(1)} dona`);
                
                const productName = product.name || `Mahsulot #${product.id}`;
                const safeProductName = productName.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
                const htmlSafeProductName = escapeHtml(productName);
                const costPrice = product.cost_price || 0;
                
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #f0f0f0';
                row.setAttribute('data-product-id', product.id);
                row.setAttribute('data-cost-price', costPrice || 0);
                row.setAttribute('data-unit-type', unitType);
                
                // Mahsulot nomlarini console ga chiqarish (faqat birinchi marta)
                if (!window.productsLogged) {
                    console.log(`📦 Mahsulot: "${productName}"`);
                }
                
                // Miqdori 0 bo'lsa qizil ranglar
                const quantityBadgeColor = quantity <= 0 ? '#dc3545' : '#28a745';
                const buttonEmoji = quantity <= 0 ? '⛔' : '➡️';
                const buttonDisabled = quantity <= 0 ? 'disabled' : '';
                const cursorStyle = quantity <= 0 ? 'not-allowed' : 'pointer';
                const opacity = quantity <= 0 ? '0.8' : '1';
                
                row.innerHTML = `
                    <td style="padding: 12px 8px; font-size: 16px; color: #333;" data-original-text="${htmlSafeProductName}" title="${htmlSafeProductName}">${htmlSafeProductName}</td>
                    <td style="padding: 12px 8px; text-align: left; font-size: 14px;">
                        <span style="background: ${quantityBadgeColor}; color: white; padding: 4px 8px; border-radius: 0; font-weight: 500; display: inline-block; font-size: 12px;">${quantityDisplay}</span>
                    </td>
                    <td style="padding: 12px 8px; text-align: left; font-size: 14px;">
                        <span style="background: #ffc107; color: white; padding: 4px 8px; border-radius: 0; font-weight: 500; margin-right: 6px; display: inline-block; font-size: 12px;">$${formatPrice(sellingPrice)}</span>
                        <span style="background: #5cb3ff; color: white; padding: 4px 8px; border-radius: 0; font-weight: 500; display: inline-block; font-size: 12px;">${formatPrice(sellingPrice * exchangeRate)} so'm</span>
                    </td>
                    <td style="padding: 2px; text-align: center; font-size: 14px;">
                        <button class="add-to-cart-btn" data-product-id="${product.id}" data-product-name="${htmlSafeProductName}" data-quantity="${quantity}" data-price="${sellingPrice}" data-cost-price="${costPrice}" data-unit-type="${unitType}" ${buttonDisabled} style="background: transparent; color: #333; border: none; padding: 4px 8px; cursor: ${cursorStyle}; font-size: 18px; opacity: ${opacity};">${buttonEmoji}</button>
                    </td>
                `;
                
                // Event listener qo'shmaslik - event delegation ishlatamiz
                
                fragment.appendChild(row);
            });
            
            // Fragment'ni bir vaqtda DOM'ga qo'shish (tezroq)
            tbody.innerHTML = ''; // Eski ma'lumotlarni tozalash
            tbody.appendChild(fragment);
            
            // Event delegation - tbody uchun bitta listener
            tbody.removeEventListener('click', handleProductClick); // Eski listener'ni o'chirish
            tbody.addEventListener('click', handleProductClick);
            
            // Mahsulotlar nomini faqat birinchi marta chiqarish
            if (!window.productsLogged) {
                window.productsLogged = true;
            }
            
            // Pagination yaratish
            const totalPages = Math.ceil(totalProducts / itemsPerPage);
            const paginationDiv = document.getElementById(`productsPagination_tab${tabId}`);
            if (totalPages > 1) {
                let paginationHTML = `<span style="color: #666; font-size: 14px;">${totalProducts} ta mahsulot (${currentPage} / ${totalPages} bet)</span>`;
                
                // Oldingi tugma
                if (currentPage > 1) {
                    paginationHTML += `<button onclick="loadProducts(${currentPage - 1})" style="padding: 8px 12px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px;">← Oldingi</button>`;
                }
                
                // Sahifa raqamlari (faqat yaqin sahifalarni ko'rsatish)
                const pagesToShow = [];
                if (totalPages <= 7) {
                    for (let i = 1; i <= totalPages; i++) {
                        pagesToShow.push(i);
                    }
                } else {
                    pagesToShow.push(1);
                    if (currentPage > 3) pagesToShow.push('...');
                    for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
                        if (!pagesToShow.includes(i)) pagesToShow.push(i);
                    }
                    if (currentPage < totalPages - 2) pagesToShow.push('...');
                    if (!pagesToShow.includes(totalPages)) pagesToShow.push(totalPages);
                }
                
                pagesToShow.forEach(page => {
                    if (page === '...') {
                        paginationHTML += `<span style="padding: 8px 12px; color: #999;">...</span>`;
                    } else {
                        const isActive = page === currentPage;
                        paginationHTML += `<button onclick="loadProducts(${page})" style="padding: 8px 12px; border: 1px solid ${isActive ? '#007bff' : '#ddd'}; background: ${isActive ? '#007bff' : 'white'}; color: ${isActive ? 'white' : '#333'}; cursor: pointer; border-radius: 4px; font-weight: ${isActive ? 'bold' : 'normal'};">${page}</button>`;
                    }
                });
                
                // Keyingi tugma
                if (currentPage < totalPages) {
                    paginationHTML += `<button onclick="loadProducts(${currentPage + 1})" style="padding: 8px 12px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px;">Keyingi →</button>`;
                }
                
                paginationDiv.innerHTML = paginationHTML;
            } else {
                paginationDiv.innerHTML = `<span style="color: #666; font-size: 14px;">${totalProducts} ta mahsulot</span>`;
            }
            
            console.log(`✅ ${products.length} ta mahsulot ko'rsatildi (${currentPage}-bet / ${totalPages} bet)`);
        } catch (error) {
            console.error('Mahsulotlarni yuklashda xatolik:', error);
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #dc3545;">⚠️ Xatolik yuz berdi</td></tr>';
        }
    }
    
    // Valyuta kursi (global o'zgaruvchi)
    let exchangeRate = 12700; // Default kurs
    
    // Himoya mexanizmlari uchun o'zgaruvchilar
    let priceChangeTimeout = null; // Debounce timer
    let lockedProductId = null; // Hozir ishlayotgan mahsulot ID'si
    let lastPriceUpdate = {}; // Har bir mahsulot uchun oxirgi narx
    
    // Valyuta kursini olish (caching bilan)
    async function loadExchangeRate() {
        try {
            // Agar cache mavjud bo'lsa, uni ishlatish
            if (currencyRateCache) {
                exchangeRate = currencyRateCache;
                console.log('📦 Valyuta kursi cache\'dan olinmoqda:', exchangeRate);
                return;
            }
            
            const response = await fetch('/api/currency-rate');
            const data = await response.json();
            if (data.success && data.rate && data.rate.rate) {
                const newRate = parseFloat(data.rate.rate);
                if (!isNaN(newRate) && newRate > 0) {
                    exchangeRate = newRate;
                    currencyRateCache = newRate; // Cache'ga saqlash
                    console.log('✅ Valyuta kursi yuklandi:', exchangeRate);
                } else {
                    console.warn('⚠️ Noto\'g\'ri kurs qiymati, default ishlatiladi:', exchangeRate);
                }
            } else {
                console.warn('⚠️ Kurs ma\'lumoti topilmadi, default ishlatiladi:', exchangeRate);
            }
        } catch (error) {
            console.error('❌ Kursni yuklashda xatolik, default ishlatiladi:', exchangeRate, error);
        }
    }
    
    // USD dan UZS ga avtomatik konversiya (debounce bilan)
    function updateUZSPrice() {
        const usdInput = getActiveTabElement('modalPriceUSD');
        const uzsInput = getActiveTabElement('modalPriceUZS');
        
        if (!usdInput || !uzsInput) {
            console.error('❌ Modal input elementlari topilmadi');
            return;
        }
        
        const usdPrice = parseFloat(usdInput.value) || 0;
        const uzsPrice = usdPrice * exchangeRate;
        uzsInput.value = Math.round(uzsPrice);
        
        console.log('💱 Konversiya (USD→UZS):', usdPrice, 'USD ×', exchangeRate, '=', Math.round(uzsPrice), 'UZS');
        
        // Narx validatsiyasini ishga tushirish (faqat modal ochiq bo'lsa)
        if (currentProduct) {
            validatePrice();
            
            // Narx o'zgarishini saqlash (debounce bilan)
            clearTimeout(priceChangeTimeout);
            priceChangeTimeout = setTimeout(() => {
                if (currentProduct && lockedProductId === currentProduct.id) {
                    lastPriceUpdate[currentProduct.id] = {
                        priceUSD: usdPrice,
                        priceUZS: Math.round(uzsPrice),
                        timestamp: Date.now()
                    };
                    console.log('🔒 Narx saqlandi:', currentProduct.id, '=', usdPrice, 'USD');
                }
            }, 500); // 500ms kutadi
        }
    }
    
    // UZS dan USD ga avtomatik konversiya (debounce bilan)
    function updateUSDPrice() {
        const usdInput = getActiveTabElement('modalPriceUSD');
        const uzsInput = getActiveTabElement('modalPriceUZS');
        
        if (!usdInput || !uzsInput) {
            console.error('❌ Modal input elementlari topilmadi');
            return;
        }
        
        const uzsPrice = parseFloat(uzsInput.value) || 0;
        const usdPrice = uzsPrice / exchangeRate;
        usdInput.value = usdPrice.toFixed(2);
        
        console.log('💱 Konversiya (UZS→USD):', uzsPrice, 'UZS ÷', exchangeRate, '=', usdPrice.toFixed(2), 'USD');
        
        // Narx validatsiyasini ishga tushirish (faqat modal ochiq bo'lsa)
        if (currentProduct) {
            validatePrice();
            
            // Narx o'zgarishini saqlash (debounce bilan)
            clearTimeout(priceChangeTimeout);
            priceChangeTimeout = setTimeout(() => {
                if (currentProduct && lockedProductId === currentProduct.id) {
                    lastPriceUpdate[currentProduct.id] = {
                        priceUSD: usdPrice,
                        priceUZS: Math.round(uzsPrice),
                        timestamp: Date.now()
                    };
                    console.log('🔒 Narx saqlandi:', currentProduct.id, '=', usdPrice, 'USD');
                }
            }, 500); // 500ms kutadi
        }
    }
    
    // Modal ochish
    function addToCart(productId, productName, quantity, price, costPrice, unitType = 'dona') {
        console.log('🛒 addToCart() chaqirildi:', { productId, productName, quantity, price, costPrice, unitType });
        
        // Miqdori 0 bo'lsa xabar chiqarish
        if (quantity <= 0) {
            alert('Bu mahsulot miqdori 0, shuning uchun uni sotib bo\'lmaydi');
            return;
        }
        
        // 🔒 Mahsulot ID'sini lock qilish
        lockedProductId = productId;
        console.log('🔒 Product locked:', lockedProductId);
        
        // Agar avval saqlangan narx bo'lsa, uni ishlatish
        if (lastPriceUpdate[productId]) {
            const savedPrice = lastPriceUpdate[productId];
            const timeDiff = Date.now() - savedPrice.timestamp;
            // Agar 30 soniyadan kam bo'lsa, saqlangan narxni ishlatish
            if (timeDiff < 30000) {
                console.log('♻️ Saqlangan narx ishlatilmoqda:', savedPrice.priceUSD, 'USD');
                price = savedPrice.priceUSD;
            }
        }
        
        currentProduct = { id: productId, name: productName, available: quantity, price: price, costPrice: costPrice, unitType: unitType };
        console.log('📦 currentProduct:', currentProduct);
        
        // Tab-aware modal elementlarini topish
        const modalProductName = getActiveTabElement('modalProductName');
        const modalAvailable = getActiveTabElement('modalAvailable');
        const modalQuantity = getActiveTabElement('modalQuantity');
        const modalPriceUSD = getActiveTabElement('modalPriceUSD');
        const quantityModal = getActiveTabElement('quantityModal');
        
        if (!modalProductName || !modalAvailable || !modalQuantity || !modalPriceUSD || !quantityModal) {
            console.error('❌ Modal elementlari topilmadi');
            return;
        }
        
        modalProductName.textContent = productName;
        
        // Mavjud miqdorni unit type bilan ko'rsatish
        const unitText = unitType === 'litr' ? 'L' : 'dona';
        const formattedQuantity = unitType === 'litr' 
            ? `${parseFloat(quantity).toFixed(2)} ${unitText}`
            : (quantity % 1 === 0 ? `${Math.floor(quantity)} ${unitText}` : `${parseFloat(quantity).toFixed(1)} ${unitText}`);
        modalAvailable.value = formattedQuantity;
        
        modalQuantity.value = 1;
        modalQuantity.max = quantity;
        
        // Unit type ga qarab step o'rnatish
        if (unitType === 'dona') {
            modalQuantity.step = '0.5'; // Dona: 0.5, 1, 1.5, 2...
            modalQuantity.min = '0.5';
        } else {
            modalQuantity.step = '0.01'; // Litr: 0.01, 0.02...
            modalQuantity.min = '0.01';
        }
        
        modalPriceUSD.value = price.toFixed(2);
        console.log('💵 modalPriceUSD.value o\'rnatildi:', modalPriceUSD.value);
        updateUZSPrice();
        
        // Validatsiyalarni o'rnatish
        setupValidation();
        
        // Dastlabki validatsiyalar
        validatePrice();
        validateQuantity();
        
        quantityModal.style.display = 'flex';
        
        // Fokusni miqdor maydoniga berish
        setTimeout(() => {
            const quantityInput = getActiveTabElement('modalQuantity');
            if (quantityInput) {
                quantityInput.focus();
                quantityInput.select(); // Matnni belgilash
            }
        }, 100);
    }
    
    // To'g'ridan-to'g'ri savatga qo'shish (modal ochmasdan) - savdo tahrirlash uchun
    function addToCartDirectly(productId, productName, quantity, priceUSD) {
        console.log(`➕ To'g'ridan-to'g'ri savatga qo'shilmoqda: ${productName} x${quantity} = $${priceUSD}`);
        
        // Korzinada allaqachon bor-yo'qligini tekshirish
        const existingIndex = cart.findIndex(item => item.id === productId);
        
        if (existingIndex !== -1) {
            // Mavjud bo'lsa, miqdorni oshirish
            cart[existingIndex].quantity += quantity;
            console.log(`  ✅ Miqdor oshirildi: ${cart[existingIndex].quantity}`);
        } else {
            // Yangi element qo'shish
            const priceUZS = priceUSD * exchangeRate;
            cart.push({
                id: productId,              // 'id' maydon nomi (removeFromCart uchun)
                name: productName,          // 'name' maydon nomi (updateCart uchun)
                quantity: quantity,
                priceUSD: priceUSD,
                priceUZS: priceUZS
            });
            console.log(`  ✅ Yangi element qo'shildi: ${productName}`);
        }
        
        // Korzinani yangilash
        updateCart();
    }
    
    // Validatsiyalarni o'rnatish - event listener'lar sahifa yuklanganda qo'yilgan
    // Bu funksiya faqat dastlabki validatsiyalarni ishga tushirish uchun
    function setupValidation() {
        // Eski event listener'larni olib tashlash (clone qilish orqali)
        const usdInput = getActiveTabElement('modalPriceUSD');
        const uzsInput = getActiveTabElement('modalPriceUZS');
        const qtyInput = getActiveTabElement('modalQuantity');
        
        if (!usdInput || !uzsInput || !qtyInput) {
            console.error('❌ Modal validation elementlari topilmadi');
            return;
        }
        
        // Element'larni clone qilish barcha eski listener'larni olib tashlaydi
        const newUsdInput = usdInput.cloneNode(true);
        const newUzsInput = uzsInput.cloneNode(true);
        const newQtyInput = qtyInput.cloneNode(true);
        
        usdInput.parentNode.replaceChild(newUsdInput, usdInput);
        uzsInput.parentNode.replaceChild(newUzsInput, uzsInput);
        qtyInput.parentNode.replaceChild(newQtyInput, qtyInput);
        
        // Yangi event listener'lar qo'shish
        const modalPriceUSD = getActiveTabElement('modalPriceUSD');
        const modalPriceUZS = getActiveTabElement('modalPriceUZS');
        const modalQuantity = getActiveTabElement('modalQuantity');
        
        if (modalPriceUSD) modalPriceUSD.addEventListener('input', updateUZSPrice);
        if (modalPriceUZS) modalPriceUZS.addEventListener('input', updateUSDPrice);
        if (modalQuantity) modalQuantity.addEventListener('input', validateQuantity);
    }
    
    // Miqdorni validatsiya qilish
    function validateQuantity() {
        if (!currentProduct) {
            return; // Mahsulot mavjud emas
        }
        
        const modalQuantity = getActiveTabElement('modalQuantity');
        const warningDiv = getActiveTabElement('priceWarning');
        const warningText = getActiveTabElement('priceWarningText');
        
        if (!modalQuantity || !warningDiv || !warningText) {
            console.error('❌ Validation elementlari topilmadi');
            return;
        }
        
        const quantity = parseFloat(modalQuantity.value) || 0;
        const available = parseFloat(currentProduct.available) || 0;
        const unitType = currentProduct.unitType || 'dona';
        const unitText = unitType === 'litr' ? 'litr' : 'dona';
        
        // Miqdor mavjud miqdordan oshib ketsa yoki 0 dan kichik bo'lsa
        if (quantity > available) {
            warningDiv.style.display = 'block';
            warningText.textContent = `Stokda faqat ${available.toFixed(2)} ${unitText} mavjud!`;
            modalQuantity.style.borderColor = '#dc3545';
            modalQuantity.style.backgroundColor = '#ffe6e6';
        } else if (quantity <= 0) {
            warningDiv.style.display = 'block';
            warningText.textContent = 'Miqdor 0 dan katta bo\'lishi kerak!';
            modalQuantity.style.borderColor = '#dc3545';
            modalQuantity.style.backgroundColor = '#ffe6e6';
        } else if (unitType === 'dona' && (quantity % 0.5 !== 0)) {
            // Dona uchun: faqat 0.5 qadam (0.5, 1, 1.5, 2...)
            warningDiv.style.display = 'block';
            warningText.textContent = 'Dona uchun faqat 0.5, 1, 1.5, 2... miqdor mumkin!';
            modalQuantity.style.borderColor = '#dc3545';
            modalQuantity.style.backgroundColor = '#ffe6e6';
        } else {
            // Agar narx validatsiyasi bo'lmasa, warningni yashirish
            const modalPriceUSD = getActiveTabElement('modalPriceUSD');
            const priceUSD = modalPriceUSD ? parseFloat(modalPriceUSD.value) || 0 : 0;
            const costPrice = parseFloat(currentProduct.costPrice) || 0;
            
            if (priceUSD > costPrice || priceUSD <= 0) {
                warningDiv.style.display = 'none';
            }
            
            modalQuantity.style.borderColor = '#ced4da';
            modalQuantity.style.backgroundColor = '#ffffff';
        }
    }
    
    // Narxni validatsiya qilish
    function validatePrice() {
        if (!currentProduct || !currentProduct.costPrice) {
            return; // Tan narx mavjud emas
        }
        
        const modalPriceUSD = getActiveTabElement('modalPriceUSD');
        const modalPriceUZS = getActiveTabElement('modalPriceUZS');
        const warningDiv = getActiveTabElement('priceWarning');
        const warningText = getActiveTabElement('priceWarningText');
        
        if (!modalPriceUSD || !modalPriceUZS || !warningDiv || !warningText) {
            console.error('❌ Price validation elementlari topilmadi');
            return;
        }
        
        const priceUSD = parseFloat(modalPriceUSD.value) || 0;
        const costPrice = parseFloat(currentProduct.costPrice) || 0;
        
        // Narx tan narxdan past yoki teng bo'lsa
        if (priceUSD <= costPrice && priceUSD > 0) {
            warningDiv.style.display = 'block';
            warningText.textContent = 'Bu narxda sotib bo\'lmaydi, narx juda past!';
            
            // Input border va background'ini qizil qilish
            modalPriceUSD.style.borderColor = '#dc3545';
            modalPriceUSD.style.backgroundColor = '#ffe6e6';
            modalPriceUZS.style.borderColor = '#dc3545';
            modalPriceUZS.style.backgroundColor = '#ffe6e6';
        } else if (priceUSD <= 0) {
            // Narx 0 yoki manfiy bo'lsa
            warningDiv.style.display = 'block';
            warningText.textContent = 'Narx 0 dan katta bo\'lishi kerak!';
            
            // Input border va background'ini qizil qilish
            modalPriceUSD.style.borderColor = '#dc3545';
            modalPriceUSD.style.backgroundColor = '#ffe6e6';
            modalPriceUZS.style.borderColor = '#dc3545';
            modalPriceUZS.style.backgroundColor = '#ffe6e6';
        } else {
            warningDiv.style.display = 'none';
            
            // Input border va background'ini normal holatga qaytarish
            modalPriceUSD.style.borderColor = '#ced4da';
            modalPriceUSD.style.backgroundColor = '#ffffff';
            modalPriceUZS.style.borderColor = '#ced4da';
            modalPriceUZS.style.backgroundColor = '#ffffff';
        }
    }
    
    // Modal yopish
    function closeModal() {
        const quantityModal = getActiveTabElement('quantityModal');
        if (quantityModal) {
            quantityModal.style.display = 'none';
        }
        
        // 🔓 Lock'ni tozalash
        lockedProductId = null;
        console.log('🔓 Product unlocked');
        
        currentProduct = null;
        delete window.editingCartIndex; // Tahrirlash rejimini tozalash
        
        // Warning xabarini yashirish
        const warningDiv = getActiveTabElement('priceWarning');
        if (warningDiv) {
            warningDiv.style.display = 'none';
        }
        
        // Input border va background'larini tozalash
        const quantityInput = getActiveTabElement('modalQuantity');
        if (quantityInput) {
            quantityInput.style.borderColor = '#ced4da';
            quantityInput.style.backgroundColor = '#ffffff';
        }
        
        const usdPriceInput = getActiveTabElement('modalPriceUSD');
        if (usdPriceInput) {
            usdPriceInput.style.borderColor = '#ced4da';
            usdPriceInput.style.backgroundColor = '#ffffff';
        }
        
        const uzsPriceInput = getActiveTabElement('modalPriceUZS');
        if (uzsPriceInput) {
            uzsPriceInput.style.borderColor = '#ced4da';
            uzsPriceInput.style.backgroundColor = '#ffffff';
        }
        
        // Fokusni universal qidiruv maydoniga qaytarish
        setTimeout(() => {
            const universalSearch = getActiveTabElement('universalSearch');
            if (universalSearch) {
                universalSearch.focus();
            }
        }, 100);
    }
    
    // Savatga qo'shish
    async function confirmAddToCart() {
        // ⚠️ XAVFSIZLIK: Operatsiya boshidagi tabId ni saqlash
        const operationTabId = activeTabId;
        
        const modalQuantity = getActiveTabElement('modalQuantity');
        const modalPriceUSD = getActiveTabElement('modalPriceUSD');
        const modalPriceUZS = getActiveTabElement('modalPriceUZS');
        
        if (!modalQuantity || !modalPriceUSD || !modalPriceUZS) {
            console.error('❌ Modal input elementlari topilmadi');
            return;
        }
        
        const quantity = parseFloat(modalQuantity.value);
        const priceUSD = parseFloat(modalPriceUSD.value);
        const priceUZS = parseFloat(modalPriceUZS.value);
        
        // ⚠️ XAVFSIZLIK: Tab almashganini tekshirish
        if (operationTabId !== activeTabId) {
            console.warn('⚠️ Tab almashgan, operatsiya bekor qilindi');
            closeModal();
            return;
        }
        
        // Narx validatsiyasi - tan narxdan past yoki teng bo'lsa, tasdiqlash
        if (currentProduct && currentProduct.costPrice) {
            const costPrice = parseFloat(currentProduct.costPrice) || 0;
            if (priceUSD <= costPrice && priceUSD > 0) {
                const confirmation = confirm(
                    `⚠️ OGOHLANTIRISH!\n\n` +
                    `Bu narxda sotib bo'lmaydi, narx juda past!\n\n` +
                    `Rostdan ham davom etmoqchimisiz?`
                );
                
                if (!confirmation) {
                    // Agar bekor qilinsa, fokusni narx maydoniga qaytarish
                    document.getElementById('modalPriceUSD').focus();
                    return;
                }
            }
        }
        
        // Agar tahrirlash rejimi bo'lsa - eski elementni o'chirib, yangisini qo'shamiz
        if (typeof window.editingCartIndex !== 'undefined') {
            if (quantity <= 0) {
                alert('Noto\'g\'ri miqdor!');
                return;
            }
            
            if (priceUSD <= 0) {
                alert('Narx kiritilishi shart!');
                return;
            }
            
            // currentProduct tekshiruvi
            if (!currentProduct) {
                alert('Mahsulot ma\'lumotlari topilmadi!');
                return;
            }
            
            if (quantity > currentProduct.available) {
                alert('Stokda yetarli mahsulot yo\'q! Mavjud: ' + currentProduct.available);
                return;
            }
            
            // Stokdan yangi miqdorni ayirish
            try {
                const response = await fetch('/api/reserve-stock', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        product_id: currentProduct.id,
                        quantity: quantity,
                        location_id: selectedLocationId,
                        location_type: selectedLocationType
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    alert(result.error || 'Stokdan ayirib bo\'lmadi!');
                    return;
                }
                console.log('✅ Tahrirlash: stokdan yangi miqdor ayirildi:', quantity, 'dona');
            } catch (error) {
                console.error('Stok ayirish xatosi:', error);
                alert('Stokni yangilashda xatolik!');
                return;
            }
            
            // Savatdagi elementni yangilash
            cart[window.editingCartIndex].quantity = quantity;
            cart[window.editingCartIndex].priceUSD = priceUSD;
            cart[window.editingCartIndex].priceUZS = priceUZS;
            
            delete window.editingCartIndex;
            updateCart();
            closeModal();
            
            // Avtomatik pending savdo yangilash
            await autoSavePending();
            
            // Mahsulotlar jadvalini yangilash (cache tozalash orqali)
            const activeTab = document.querySelector('.sales-tab.active');
            if (activeTab) {
                const tabId = activeTab.dataset.tabId;
                const locationSelect = document.getElementById(`locationSelect_tab${tabId}`);
                if (locationSelect) {
                    const cacheKey = `${locationSelect.value}_${currentPage}`;
                    productsCache.delete(cacheKey);
                    await loadProducts(currentPage);
                    console.log('🔄 Tahrirlash: mahsulotlar jadvali yangilandi');
                }
            }
            
            console.log('✏️ Savat elementi tahrirlandi');
            return;
        }
        
        // Yangi mahsulot qo'shish - currentProduct tekshiruvi
        if (!currentProduct) {
            alert('Mahsulot ma\'lumotlari topilmadi!');
            console.error('❌ currentProduct null holatda');
            return;
        }
        
        // Mahsulot allaqachon savatda borligini tekshirish
        const existingItem = cart.find(item => item.id === currentProduct.id);
        if (existingItem) {
            alert('⚠️ Bu mahsulot allaqachon savatda mavjud!\n\nAgar miqdorini o\'zgartirmoqchi bo\'lsangiz, savatdagi "✏️ Tahrirlash" tugmasini bosing.');
            closeModal();
            return;
        }
        
        if (quantity <= 0 || quantity > currentProduct.available) {
            alert('Noto\'g\'ri miqdor!');
            return;
        }
        
        if (priceUSD <= 0) {
            alert('Narx kiritilishi shart!');
            return;
        }
        
        // Stokdan darhol ayirish
        try {
            const response = await fetch('/api/reserve-stock', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    product_id: currentProduct.id,
                    quantity: quantity,
                    location_id: selectedLocationId,
                    location_type: selectedLocationType
                })
            });
            
            const result = await response.json();
            if (!result.success) {
                alert(result.error || 'Stokdan ayirib bo\'lmadi!');
                return;
            }
            
            console.log('✅ Stokdan ayirildi:', quantity, 'dona');
        } catch (error) {
            console.error('Stok ayirish xatosi:', error);
            alert('Stokni yangilashda xatolik!');
            return;
        }
        
        // Savatga yangi mahsulot qo'shish (duplicate allaqachon tekshirilgan)
        cart.push({
            id: currentProduct.id,
            name: currentProduct?.name || `Mahsulot #${currentProduct?.id || 'Unknown'}`,
            priceUSD: priceUSD,
            priceUZS: priceUZS,
            quantity: quantity
        });
        console.log(`➕ Yangi mahsulot qo'shildi: ${quantity} dona`);
        
        // Tab state'ni yangilash
        const tabState = getTabState();
        if (tabState) {
            tabState.cart = [...cart]; // Deep copy
            console.log(`💾 Tab cart saqlandi (${cart.length} items)`);
        }
        
        // currentProduct ma'lumotlarini saqlab qo'yish (closeModal() uni null qiladi)
        const addedProduct = {
            name: currentProduct?.name || `Mahsulot #${currentProduct?.id}`,
            id: currentProduct?.id
        };
        
        updateCart();
        closeModal();
        
        // Avtomatik pending savdo yaratish/yangilash
        await autoSavePending();
        
        // Mahsulotlar jadvalida faqat o'sha mahsulotning miqdorini yangilash (tezroq)
        updateProductQuantityInTable(addedProduct.id, quantity);
        
        // Fokusni universal qidiruv maydoniga qaytarish
        setTimeout(() => {
            const activeTab = document.querySelector('.sales-tab.active');
            if (activeTab) {
                const tabId = activeTab.dataset.tabId;
                const universalSearch = document.getElementById(`universalSearch_tab${tabId}`);
                if (universalSearch) {
                    universalSearch.focus();
                    universalSearch.select(); // Matnni belgilash
                }
            }
        }, 200);
        
        console.log('✅ Savatga qo\'shildi:', addedProduct.name, quantity, 'dona, $' + priceUSD);
    }
    
    // Savatni yangilash
    function updateCart() {
        // Faol tabdagi elementlarni topish
        const activeTab = document.querySelector('.sales-tab.active');
        if (!activeTab) return;
        const tabId = activeTab.dataset.tabId;
        
        const cartItemsDiv = document.getElementById(`cartItems_tab${tabId}`);
        const cartTotalDiv = document.getElementById(`cartTotal_tab${tabId}`);
        const cartTotalHeader = document.getElementById(`cartTotalHeader_tab${tabId}`);
        const locationSelect = document.getElementById(`locationSelect_tab${tabId}`);
        const customerSearch = document.getElementById(`customerSearch_tab${tabId}`);
        const selectedCustomerId = document.getElementById(`selectedCustomerId_tab${tabId}`);
        const cartCustomerInfo = document.getElementById(`cartCustomerInfo_tab${tabId}`);
        
        if (!cartItemsDiv || !cartTotalDiv || !cartTotalHeader) return;
        
        // Mijoz ma'lumotlarini ko'rsatish
        if (cartCustomerInfo && customerSearch && selectedCustomerId && selectedCustomerId.value) {
            const customerName = customerSearch.value;
            if (customerName) {
                cartCustomerInfo.innerHTML = `<h3 style="margin: 0; color: #333; font-size: 15px; font-weight: 600;">👤 ${customerName}</h3>`;
                
                // Tab sarlavhasida ham mijoz ko'rsatish
                const tabTitle = activeTab.querySelector('.tab-title');
                if (tabTitle) {
                    tabTitle.textContent = customerName;
                    tabTitle.title = customerName; // Tooltip uchun
                }
            } else {
                cartCustomerInfo.innerHTML = '';
            }
        } else if (cartCustomerInfo) {
            cartCustomerInfo.innerHTML = '';
        }
        
        if (cart.length === 0) {
            cartItemsDiv.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 50px; color: #999;">Savat bo\'sh</td></tr>';
            cartTotalDiv.innerHTML = '';
            cartTotalHeader.innerHTML = '';
            
            // Savat bo'sh bo'lganda joylashuv va mijozni yoqish
            if (locationSelect) {
                locationSelect.disabled = false;
                locationSelect.style.background = 'white';
                locationSelect.style.cursor = 'pointer';
            }
            if (customerSearch) {
                customerSearch.disabled = false;
                customerSearch.style.background = 'white';
                customerSearch.style.cursor = 'text';
            }
            return;
        }
        
        // Savatda mahsulot bor bo'lsa joylashuvni bloklash
        if (locationSelect && cart.length > 0) {
            locationSelect.disabled = true;
            locationSelect.style.background = '#f0f0f0';
            locationSelect.style.cursor = 'not-allowed';
        }
        
        // Mijozni faqat mijoz tanlangan bo'lsa va savatda mahsulot bo'lsa bloklash
        if (customerSearch && cart.length > 0 && selectedCustomerId && selectedCustomerId.value) {
            customerSearch.disabled = true;
            customerSearch.style.background = '#f0f0f0';
            customerSearch.style.cursor = 'not-allowed';
        } else if (customerSearch) {
            customerSearch.disabled = false;
            customerSearch.style.background = 'white';
            customerSearch.style.cursor = 'text';
        }
        
        let html = '';
        let totalUSD = 0;
        let totalUZS = 0;
        
        // Yangi qo'shilgan mahsulotlar tepada ko'rinishi uchun teskari tartibda
        const displayCart = [...cart].reverse();
        
        displayCart.forEach((item, displayIndex) => {
            // Original index (cart massividagi haqiqiy index)
            const index = cart.length - 1 - displayIndex;
            const subtotalUSD = item.priceUSD * item.quantity;
            const subtotalUZS = item.priceUZS * item.quantity;
            totalUSD += subtotalUSD;
            totalUZS += subtotalUZS;
            
            html += `
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 8px 5px; font-size: 16px; color: #333; word-wrap: break-word; width: 312px; max-width: 312px; overflow: hidden;">${item.name}</td>
                    <td style="padding: 8px 5px; text-align: center; font-size: 16px; color: #333; width: 84px;">
                        <input type="number" 
                               value="${item.quantity}" 
                               min="1" 
                               data-cart-index="${index}"
                               data-max-stock="${item.available || 999999}"
                               data-original-quantity="${item.quantity}"
                               oninput="validateCartQuantityInput(this, ${index})"
                               onchange="updateCartQuantity(${index}, this.value)" 
                               style="width: 60px; text-align: center; border: 1px solid #ced4da; border-radius: 4px; padding: 4px; font-size: 15px; font-weight: 500;">
                    </td>
                    <td style="padding: 8px 5px; text-align: right; font-size: 15px; color: #333; width: 90px;">
                        <div style="margin-bottom: 2px; font-weight: 600; color: #333; font-size: 15px;">$${item.priceUSD.toFixed(2)}</div>
                        <div>
                            <span style="background: #0d6efd; color: white; padding: 2px 4px; border-radius: 2px; font-weight: 500; font-size: 14px;">${formatPrice(item.priceUZS)}</span>
                        </div>
                    </td>
                    <td style="padding: 8px 5px; text-align: right; font-size: 15px; color: #333; width: 94px;">
                        <div style="margin-bottom: 2px; font-weight: 600; color: #333; font-size: 15px;">$${subtotalUSD.toFixed(2)}</div>
                        <div>
                            <span style="background: #0d6efd; color: white; padding: 2px 4px; border-radius: 2px; font-weight: 500; font-size: 14px;">${formatPrice(subtotalUZS)}</span>
                        </div>
                    </td>
                    <td style="padding: 8px 5px; text-align: center; width: 40px;">
                        <button onclick="editCartItem(${index})" style="background: transparent; color: #333; border: none; padding: 4px 6px; cursor: pointer; font-size: 14px; margin-right: 2px;">✏️</button>
                        <button onclick="removeFromCart(${index})" style="background: transparent; color: #333; border: none; padding: 4px 6px; cursor: pointer; font-size: 14px; font-weight: bold;">❌</button>
                    </td>
                </tr>
            `;
        });
        
        cartItemsDiv.innerHTML = html;
        cartTotalDiv.innerHTML = '';
        
        // Jami summani sarlavhada ko'rsatish
        cartTotalHeader.innerHTML = `
            <div style="padding: 10px 15px; background: #f8f9fa; border-radius: 6px; border: 2px solid #dee2e6;">
                <div style="font-size: 14px; font-weight: 600; color: #333; display: flex; align-items: center; gap: 10px;">
                    <div style="background: #007bff; color: white; padding: 4px 10px; border-radius: 4px; font-size: 14px; min-width: 40px; text-align: center;">
                        ${cart.length}
                    </div>
                    <div>
                        Jami: <span style="color: #28a745; font-size: 16px;">$${totalUSD.toFixed(2)}</span>
                        <span style="margin-left: 15px; color: #333; font-size: 16px;">${formatPrice(totalUZS)} so'm</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Savatdan o'chirish
    async function removeFromCart(index) {
        // ⚠️ XAVFSIZLIK: Operatsiya boshidagi tabId va ma'lumotlarni saqlash
        const operationTabId = activeTabId;
        const operationLocationId = selectedLocationId;
        const operationLocationType = selectedLocationType;
        
        const item = cart[index];
        
        // Tasdiqlash so'rovi
        const confirmMessage = `"${item.name}" mahsulotini savatdan o'chirmoqchimisiz?\n\nMiqdor: ${item.quantity} dona\nNarx: $${item.priceUSD.toFixed(2)}`;
        if (!confirm(confirmMessage)) {
            console.log('❌ Foydalanuvchi o\'chirishni bekor qildi');
            return;
        }
        
        // ⚠️ XAVFSIZLIK: Tab almashganini tekshirish
        if (operationTabId !== activeTabId) {
            console.warn('⚠️ Tab almashgan, o\'chirish bekor qilindi');
            return;
        }
        
        // Debug: funksiya chaqirilgan vaqtni log qilish
        const timestamp = new Date().toISOString();
        console.log(`\n${'='.repeat(80)}`);
        console.log(`🗑️ removeFromCart() CHAQIRILDI - ${timestamp}`);
        console.log(`   Index: ${index}`);
        console.log(`   Product: ${item.name} (ID: ${item.id})`);
        console.log(`   Quantity: ${item.quantity}`);
        console.log(`   Location: ${operationLocationId} (${operationLocationType})`);
        console.log(`   Stock returned flag: ${item._stockReturned || false}`);
        console.log(`${'='.repeat(80)}\n`);
        
        // FAQAT BIR MARTA stokka qaytarish
        if (!item._stockReturned) {
            console.log('🔄 Stokka qaytarish jarayoni boshlanmoqda...');
            try {
                const requestData = {
                    product_id: item.id,
                    quantity: item.quantity,
                    location_id: selectedLocationId,
                    location_type: selectedLocationType
                };
                console.log('📤 API ga yuborilayotgan ma\'lumot:', JSON.stringify(requestData, null, 2));
                
                const response = await fetch('/api/return-stock', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestData)
                });
                
                console.log('📡 API response status:', response.status);
                
                const result = await response.json();
                console.log('📦 API response:', JSON.stringify(result, null, 2));
                
                if (!result.success) {
                    console.error('❌ Stokka qaytarishda xatolik:', result.error);
                    alert('Stokka qaytarishda xatolik: ' + result.error);
                    console.log(`${'='.repeat(80)}\n`);
                    return; // Xatolik bo'lsa savatdan o'chirmaymiz
                } else {
                    console.log('✅ Stokka qaytarildi:', item.quantity, 'dona');
                    console.log('📊 Yangi stock:', result.new_stock);
                    item._stockReturned = true; // Belgi qo'yamiz
                    console.log('🔒 _stockReturned flag = true');
                }
            } catch (error) {
                console.error('❌ Stok qaytarish xatosi:', error);
                alert('Stok qaytarish xatosi: ' + error.message);
                console.log(`${'='.repeat(80)}\n`);
                return; // Xatolik bo'lsa savatdan o'chirmaymiz
            }
        } else {
            console.log('⚠️ Stock allaqachon qaytarilgan, qayta qaytarmaymiz');
            console.log('🔒 _stockReturned flag allaqachon = true');
        }
        
        cart.splice(index, 1);
        
        // Tab state'ni yangilash
        const tabState = getTabState();
        if (tabState) {
            tabState.cart = [...cart]; // Deep copy
            console.log(`💾 Tab cart saqlandi (${cart.length} items after remove)`);
        }
        
        updateCart();
        
        // Avtomatik pending savdo yangilash
        await autoSavePending();
        
        // Chap tomondagi mahsulotlar jadvalini yangilash (cache tozalash orqali)
        const activeTab = document.querySelector('.sales-tab.active');
        if (activeTab) {
            const tabId = activeTab.dataset.tabId;
            const locationSelect = document.getElementById(`locationSelect_tab${tabId}`);
            if (locationSelect) {
                const cacheKey = `${locationSelect.value}_${currentPage}`;
                productsCache.delete(cacheKey);
                await loadProducts(currentPage);
                console.log('🔄 O\'chirish: mahsulotlar jadvali yangilandi');
            }
        }
        
        console.log('✅ Savatdan o\'chirish tugadi');
    }
    
    // Savat miqdorini yangilash
    async function updateCartQuantity(index, newQuantity) {
        const quantity = parseInt(newQuantity);
        const input = document.querySelector(`input[data-cart-index="${index}"]`);
        
        if (quantity < 1 || isNaN(quantity)) {
            if (input) {
                input.style.borderColor = '#dc3545';
                input.style.backgroundColor = '#ffe6e6';
            }
            alert('Noto\'g\'ri miqdor!');
            updateCart();
            return;
        }
        
        const item = cart[index];
        const oldQuantity = item.quantity;
        const quantityDiff = quantity - oldQuantity;
        
        if (quantityDiff === 0) {
            // Rang to'g'rilash
            if (input) {
                input.style.borderColor = '#ced4da';
                input.style.backgroundColor = '#ffffff';
            }
            return; // O'zgarish yo'q
        }
        
        // Agar miqdor oshsa, stokdan qo'shimcha ayirish
        if (quantityDiff > 0) {
            try {
                const response = await fetch('/api/reserve-stock', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        product_id: item.id,
                        quantity: quantityDiff,
                        location_id: selectedLocationId,
                        location_type: selectedLocationType
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    if (input) {
                        input.style.borderColor = '#dc3545';
                        input.style.backgroundColor = '#ffe6e6';
                    }
                    alert(result.error || 'Stokdan ayirib bo\'lmadi!');
                    updateCart(); // Eski qiymatni qaytarish
                    return;
                }
                console.log('✅ Stokdan qo\'shimcha ayirildi:', quantityDiff, 'dona');
            } catch (error) {
                console.error('Stok ayirish xatosi:', error);
                if (input) {
                    input.style.borderColor = '#dc3545';
                    input.style.backgroundColor = '#ffe6e6';
                }
                alert('Stokni yangilashda xatolik!');
                updateCart();
                return;
            }
        }
        // Agar miqdor kamaysa, stokka qaytarish
        else if (quantityDiff < 0) {
            try {
                const response = await fetch('/api/return-stock', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        product_id: item.id,
                        quantity: Math.abs(quantityDiff),
                        location_id: selectedLocationId,
                        location_type: selectedLocationType
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    if (input) {
                        input.style.borderColor = '#dc3545';
                        input.style.backgroundColor = '#ffe6e6';
                    }
                    alert(result.error || 'Stokka qaytarib bo\'lmadi!');
                    updateCart();
                    return;
                }
                console.log('✅ Stokka qaytarildi:', Math.abs(quantityDiff), 'dona');
            } catch (error) {
                console.error('Stok qaytarish xatosi:', error);
                if (input) {
                    input.style.borderColor = '#dc3545';
                    input.style.backgroundColor = '#ffe6e6';
                }
                alert('Stokni yangilashda xatolik!');
                updateCart();
                return;
            }
        }
        
        cart[index].quantity = quantity;
        updateCart();
        
        // Avtomatik pending savdo yangilash
        await autoSavePending();
        
        // Mahsulotlar jadvalini yangilash (cache tozalash orqali)
        const activeTab = document.querySelector('.sales-tab.active');
        if (activeTab) {
            const tabId = activeTab.dataset.tabId;
            const locationSelect = document.getElementById(`locationSelect_tab${tabId}`);
            if (locationSelect) {
                const cacheKey = `${locationSelect.value}_${currentPage}`;
                productsCache.delete(cacheKey);
                await loadProducts(currentPage);
                console.log('🔄 Miqdor o\'zgartirildi: mahsulotlar jadvali yangilandi');
            }
        }
        
        console.log('📝 Miqdor yangilandi:', quantity);
    }
    
    // Korzinka miqdor inputini real-time validatsiya qilish
    function validateCartQuantityInput(input, index) {
        const value = parseInt(input.value);
        const item = cart[index];
        const maxStock = parseInt(input.getAttribute('data-max-stock')) || 999999;
        const originalQuantity = parseInt(input.getAttribute('data-original-quantity')) || item.quantity;
        
        // Bo'sh yoki noto'g'ri qiymat
        if (input.value === '' || isNaN(value)) {
            input.style.borderColor = '#ced4da';
            input.style.backgroundColor = '#ffffff';
            return;
        }
        
        // 0 yoki manfiy
        if (value <= 0) {
            input.style.borderColor = '#dc3545';
            input.style.backgroundColor = '#ffe6e6';
            input.title = 'Miqdor 0 dan katta bo\'lishi kerak!';
            return;
        }
        
        // Mavjud stokdan ortiq (faqat oshirilganda tekshirish)
        const quantityDiff = value - originalQuantity;
        if (quantityDiff > 0 && value > (maxStock + originalQuantity)) {
            input.style.borderColor = '#dc3545';
            input.style.backgroundColor = '#ffe6e6';
            input.title = `Stokda faqat ${maxStock + originalQuantity} dona mavjud!`;
            return;
        }
        
        // To'g'ri qiymat
        input.style.borderColor = '#28a745';
        input.style.backgroundColor = '#e7f9e7';
        input.title = '';
    }
    
    // Savat elementini tahrirlash
    async function editCartItem(index) {
        const item = cart[index];
        
        // Tasdiqlash so'rovi
        const confirmMessage = `"${item.name}" mahsulotini tahrirlashni xohlaysizmi?\n\nHozirgi miqdor: ${item.quantity} dona\nHozirgi narx: $${item.priceUSD.toFixed(2)}`;
        if (!confirm(confirmMessage)) {
            console.log('❌ Foydalanuvchi tahrirlashni bekor qildi');
            return;
        }
        
        // Avval eski miqdorni stokka qaytarish
        try {
            const response = await fetch('/api/return-stock', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    product_id: item.id,
                    quantity: item.quantity,
                    location_id: selectedLocationId,
                    location_type: selectedLocationType
                })
            });
            
            const result = await response.json();
            if (!result.success) {
                console.error('Stokka qaytarishda xatolik:', result.error);
            } else {
                console.log('✅ Tahrirlash uchun stokka qaytarildi:', item.quantity, 'dona');
            }
        } catch (error) {
            console.error('Stok qaytarish xatosi:', error);
        }
        
        // Chap tomondagi jadvalni yangilash
        await loadProducts();
        
        // Tab-aware modal elementlarini topish
        const quantityModal = getActiveTabElement('quantityModal');
        const modalProductName = getActiveTabElement('modalProductName');
        const locationSelect = getActiveTabElement('locationSelect');
        const modalAvailable = getActiveTabElement('modalAvailable');
        const modalQuantity = getActiveTabElement('modalQuantity');
        const modalPriceUSD = getActiveTabElement('modalPriceUSD');
        const modalPriceUZS = getActiveTabElement('modalPriceUZS');
        
        if (!quantityModal || !modalProductName || !locationSelect) {
            console.error('❌ Modal elementlari topilmadi');
            return;
        }
        
        // Modal oynani ochish
        quantityModal.style.display = 'flex';
        modalProductName.textContent = item.name;
        
        // Mavjud miqdorni olish (stokka qaytarilgandan keyin)
        const locationValue = locationSelect.value;
        const [type, id] = locationValue.split('_');
        try {
            const response = await fetch(`/api/products?location=${locationValue}`);
            const data = await response.json();
            const products = Array.isArray(data) ? data : (data.products || []);
            const product = products.find(p => p.id === item.id);
            
            if (product && product.stocks && product.stocks.length > 0) {
                const locationId = parseInt(id);
                const matchingStock = product.stocks.find(stock => {
                    if (type === 'warehouse') {
                        return stock.warehouse_id === locationId;
                    } else if (type === 'store') {
                        return stock.store_id === locationId;
                    }
                    return false;
                });
                
                if (matchingStock && modalAvailable && modalQuantity) {
                    modalAvailable.value = matchingStock.quantity || 0;
                    modalQuantity.max = matchingStock.quantity || 0;
                }
            }
        } catch (error) {
            console.error('Mavjud miqdorni olishda xatolik:', error);
            if (modalAvailable) modalAvailable.value = 0;
        }
        
        // Korzinada qancha bo'lsa o'sha miqdorni ko'rsatish
        if (modalQuantity) modalQuantity.value = item.quantity;
        if (modalPriceUSD) modalPriceUSD.value = item.priceUSD.toFixed(2);
        if (modalPriceUZS) modalPriceUZS.value = item.priceUZS;
        
        // Miqdor maydonini avtomatik select qilish
        setTimeout(() => {
            const quantityInput = getActiveTabElement('modalQuantity');
            if (quantityInput) {
                quantityInput.focus();
                quantityInput.select(); // Ctrl+A effekti
            }
        }, 100);
        
        // currentProduct ni o'rnatish (costPrice ham qo'shish)
        // Tan narxni mahsulot ma'lumotlaridan olish
        let costPrice = 0;
        try {
            const locationValue = locationSelect.value;
            const response = await fetch(`/api/products?location=${locationValue}`);
            const data = await response.json();
            const products = Array.isArray(data) ? data : (data.products || []);
            const product = products.find(p => p.id === item.id);
            if (product && product.cost_price) {
                costPrice = product.cost_price;
            }
        } catch (error) {
            console.error('Tan narxni olishda xatolik:', error);
        }
        
        // modalAvailable elementini tab-aware usulda olish
        const modalAvailableElement = getActiveTabElement('modalAvailable');
        let availableQuantity = 0;
        if (modalAvailableElement && modalAvailableElement.value) {
            availableQuantity = parseInt(modalAvailableElement.value) || 0;
        }
        
        currentProduct = { 
            id: item.id, 
            name: item.name, 
            available: availableQuantity,
            price: item.priceUSD,
            costPrice: costPrice
        };
        
        console.log('✅ currentProduct o\'rnatildi:', currentProduct);
        
        // Validatsiyalarni o'rnatish
        setupValidation();
        
        // Dastlabki validatsiyalar
        validatePrice();
        validateQuantity();
        
        // Eski confirm funksiyasini yangilash uchun indexni saqlash
        window.editingCartIndex = index;
    }
    
    // Mahsulotni savatga qo'shish (eski)
    /*
    function addToCart(productId, productName, quantity, price) {
        console.log(`➕ Savatga qo'shildi: ${productName} (ID: ${productId})`);
        // Bu yerda savat logikasini qo'shish kerak
    }
    */
    
    // Mahsulot qidirish funksiyasi - serverdan qidirish
    async function filterProducts() {
        // Faol tabdagi elementlarni topish
        const activeTab = document.querySelector('.sales-tab.active');
        if (!activeTab) return;
        const tabId = activeTab.dataset.tabId;
        
        const searchText = document.getElementById(`universalSearch_tab${tabId}`).value.trim();
        const locationSelect = document.getElementById(`locationSelect_tab${tabId}`);
        const tbody = document.getElementById(`productsTable_tab${tabId}`);
        
        if (!locationSelect || !tbody) return;
        
        console.log('🔍 Qidiruv matni:', searchText);
        
        // Bo'sh qidiruv - barcha mahsulotlarni qayta yuklash
        if (!searchText) {
            await loadProducts();
            return;
        }
        
        const locationValue = locationSelect.value;
        if (!locationValue) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px; color: #999;">Joylashuvni tanlang</td></tr>';
            return;
        }
        
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">⏳ Qidirilmoqda...</td></tr>';
        
        try {
            // Serverdan qidiruv so'rovi yuborish
            const response = await fetch(`/api/products?location=${locationValue}&search=${encodeURIComponent(searchText)}`);
            const data = await response.json();
            
            console.log('🔍 Qidiruv natijasi:', data);
            
            const products = Array.isArray(data) ? data : (data.products || []);
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">❌ Hech narsa topilmadi</td></tr>';
                console.log(`❌ "${searchText}" bo'yicha mahsulot topilmadi`);
                return;
            }
            
            // Regex maxsus belgilarini escape qilish
            function escapeRegex(str) {
                return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
            
            // Qidiruv so'zlarini ajratish (highlight uchun)
            const searchWords = searchText.toLowerCase().split(/\s+/).filter(word => word.length > 0);
            
            tbody.innerHTML = '';
            products.forEach(product => {
                // Quantity va selling price ni olish
                let quantity = 0;
                let sellingPrice = product.sell_price || product.price || 0;
                
                // Agar stocks mavjud bo'lsa, locationga mos keladiganini topish
                if (product.stocks && product.stocks.length > 0) {
                    const [type, id] = locationValue.split('_');
                    const locationId = parseInt(id);
                    
                    const matchingStock = product.stocks.find(stock => {
                        if (type === 'warehouse') {
                            return stock.warehouse_id === locationId;
                        } else if (type === 'store') {
                            return stock.store_id === locationId;
                        }
                        return false;
                    });
                    
                    if (matchingStock) {
                        quantity = matchingStock.quantity || 0;
                    }
                }
                
                const productName = product.name || `Mahsulot #${product.id}`;
                const safeProductName = productName.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
                const htmlSafeProductName = escapeHtml(productName);
                const costPrice = product.cost_price || 0;
                
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #f0f0f0';
                row.setAttribute('data-product-id', product.id);
                row.setAttribute('data-cost-price', costPrice || 0);
                
                // Highlight qilish - qidiruv so'zlarini
                let highlightedName = htmlSafeProductName;
                if (searchWords.length > 0) {
                    const escapedWords = searchWords.map(word => escapeRegex(word));
                    const combinedPattern = escapedWords.join('|');
                    const regex = new RegExp(`(${combinedPattern})`, 'gi');
                    highlightedName = highlightedName.replace(regex, '<span style="background-color: #ffeb3b; padding: 2px 4px; border-radius: 2px;">$1</span>');
                }
                
                // Miqdori 0 bo'lsa qizil ranglar
                const quantityBadgeColor = quantity <= 0 ? '#dc3545' : '#28a745';
                const buttonEmoji = quantity <= 0 ? '⛔' : '➡️';
                const buttonDisabled = quantity <= 0 ? 'disabled' : '';
                const cursorStyle = quantity <= 0 ? 'not-allowed' : 'pointer';
                const opacity = quantity <= 0 ? '0.8' : '1';
                
                row.innerHTML = `
                    <td style="padding: 12px 8px; font-size: 16px; color: #333;" data-original-text="${htmlSafeProductName}" title="${htmlSafeProductName}">${highlightedName}</td>
                    <td style="padding: 12px 8px; text-align: left; font-size: 14px;">
                        <span style="background: ${quantityBadgeColor}; color: white; padding: 4px 8px; border-radius: 0; font-weight: 500; display: inline-block; font-size: 12px;">${quantity}</span>
                    </td>
                    <td style="padding: 12px 8px; text-align: left; font-size: 14px;">
                        <span style="background: #ffc107; color: white; padding: 4px 8px; border-radius: 0; font-weight: 500; margin-right: 6px; display: inline-block; font-size: 12px;">$${formatPrice(sellingPrice)}</span>
                        <span style="background: #5cb3ff; color: white; padding: 4px 8px; border-radius: 0; font-weight: 500; display: inline-block; font-size: 12px;">${formatPrice(sellingPrice * exchangeRate)} so'm</span>
                    </td>
                    <td style="padding: 2px; text-align: center; font-size: 14px;">
                        <button class="add-to-cart-btn" data-product-id="${product.id}" data-product-name="${htmlSafeProductName}" data-quantity="${quantity}" data-price="${sellingPrice}" data-cost-price="${costPrice}" ${buttonDisabled} style="background: transparent; color: #333; border: none; padding: 4px 8px; cursor: ${cursorStyle}; font-size: 18px; opacity: ${opacity};">${buttonEmoji}</button>
                    </td>
                `;
                
                // Event listener qo'shmaslik - event delegation ishlatamiz
                
                tbody.appendChild(row);
            });
            
            // Event delegation - tbody uchun bitta listener
            tbody.removeEventListener('click', handleProductClick);
            tbody.addEventListener('click', handleProductClick);
            
            console.log(`✅ Topildi: ${products.length} ta mahsulot`);
            
            // Ko'rinadigan qatorlarni yangilash
            updateVisibleProductRows();
        } catch (error) {
            console.error('Qidirishda xatolik:', error);
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #dc3545;">⚠️ Xatolik yuz berdi</td></tr>';
        }
    }
    
    // Ko'rinadigan mahsulot qatorlarini yangilash
    function updateVisibleProductRows() {
        // Faol tabdagi jadval
        const activeTab = document.querySelector('.sales-tab.active');
        if (!activeTab) return;
        const tabId = activeTab.dataset.tabId;
        const tbody = document.getElementById(`productsTable_tab${tabId}`);
        if (!tbody) return;
        
        const allRows = Array.from(tbody.getElementsByTagName('tr'));
        
        visibleProductRows = allRows.filter(row => {
            const cells = row.getElementsByTagName('td');
            if (cells.length <= 1) return false; // Xabar qatorlarini o'tkazib yuborish
            return row.style.display !== 'none';
        });
    }
    
    // Mahsulotlar jadvalida navigatsiya
    function navigateProductTable(direction) {
        updateVisibleProductRows();
        
        if (visibleProductRows.length === 0) return;
        
        if (direction === 'down') {
            currentSelectedRowIndex = currentSelectedRowIndex < visibleProductRows.length - 1 
                ? currentSelectedRowIndex + 1 
                : 0;
        } else if (direction === 'up') {
            currentSelectedRowIndex = currentSelectedRowIndex > 0 
                ? currentSelectedRowIndex - 1 
                : visibleProductRows.length - 1;
        }
        
        highlightSelectedRow();
    }
    
    // Hozirgi tanlangan mahsulotni savatga qo'shish
    function selectCurrentProduct() {
        if (currentSelectedRowIndex >= 0 && visibleProductRows[currentSelectedRowIndex]) {
            selectProductFromTable(visibleProductRows[currentSelectedRowIndex]);
        }
    }
    
    // Tanlangan qatorni highlight qilish
    function highlightSelectedRow() {
        // Barcha qatorlardan highlight ni olib tashlash
        visibleProductRows.forEach(row => {
            row.style.background = '';
        });
        
        // Tanlangan qatorni highlight qilish
        if (currentSelectedRowIndex >= 0 && visibleProductRows[currentSelectedRowIndex]) {
            const selectedRow = visibleProductRows[currentSelectedRowIndex];
            selectedRow.style.background = '#bbdefb';
            
            // Scrollni tanlangan qatorga olib borish
            selectedRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }
    
    // Tanlangan mahsulotni savatga qo'shish
    function selectProductFromTable(row) {
        const cells = row.getElementsByTagName('td');
        if (cells.length < 4) return;
        
        // Mahsulot ma'lumotlarini olish
        const productName = cells[0].getAttribute('data-original-text') || cells[0].textContent.trim();
        const productId = row.getAttribute('data-product-id');
        const costPrice = parseFloat(row.getAttribute('data-cost-price')) || 0;
        
        // Miqdorni span ichidan olish (cells[1] = Mavjud)
        const quantitySpan = cells[1].querySelector('span');
        const quantity = quantitySpan ? parseInt(quantitySpan.textContent.trim()) : 0;
        
        // Narxni button'ning data-price attributidan olish (formatlanmagan)
        const priceButton = cells[3].querySelector('.add-to-cart-btn');
        const price = priceButton ? parseFloat(priceButton.getAttribute('data-price')) || 0 : 0;
        
        console.log('🔍 Tanlangan mahsulot:', { productId, productName, quantity, price, costPrice });
        
        if (productId && quantity > 0 && price > 0) {
            addToCart(parseInt(productId), productName, quantity, price, costPrice);
            
            // Qidiruvni tozalash
            const universalSearch = getActiveTabElement('universalSearch');
            if (universalSearch) universalSearch.value = '';
            filterProducts();
            clearProductSelection();
        } else if (productId && quantity <= 0) {
            console.log('⛔ Mahsulot miqdori 0:', { productId, productName });
            alert('Bu mahsulot miqdori 0, shuning uchun uni sotib bo\'lmaydi');
        } else {
            console.error('❌ Mahsulot ma\'lumotlari noto\'g\'ri:', { productId, quantity, price });
            alert('Mahsulot ma\'lumotlarini olishda xatolik!');
        }
    }
    
    // Mahsulot tanlanishini tozalash
    function clearProductSelection() {
        currentSelectedRowIndex = -1;
        visibleProductRows.forEach(row => {
            row.style.background = '';
        });
    }
    
    // Narxni formatlash
    function formatPrice(price) {
        if (!price) return '0';
        return Number(price).toLocaleString('uz-UZ');
    }
    
    // URL parametrlarini tekshirish va savdo ma'lumotlarini yuklash
    async function checkURLParametersAndLoadSale() {
        const urlParams = new URLSearchParams(window.location.search);
        const editGroupId = urlParams.get('edit_group');
        const editId = urlParams.get('edit');
        
        if (editGroupId) {
            console.log(`✏️ Savdo guruhi ${editGroupId} yuklanmoqda...`);
            editingSaleId = editGroupId;  // Global o'zgaruvchiga saqlash
            await loadSaleGroup(editGroupId);
        } else if (editId) {
            console.log(`✏️ Savdo ${editId} yuklanmoqda...`);
            editingSaleId = editId;  // Global o'zgaruvchiga saqlash
            await loadSingleSale(editId);
        }
    }
    
    // Savdo guruhini yuklash (bir xil sale_date, customer, location)
    async function loadSaleGroup(saleId) {
        try {
            console.log(`📥 Savdo ${saleId} yuklanmoqda...`);
            
            // Avval korzinani tozalash (agar biror narsa bo'lsa)
            if (cart.length > 0) {
                console.log('🗑️ Korzinani tozalash...');
                cart = [];
                updateCart();
            }
            
            const response = await fetch(`/api/sales/${saleId}`);
            console.log('📡 API response status:', response.status);
            
            if (!response.ok) {
                throw new Error('Savdoni yuklashda xatolik');
            }
            
            const data = await response.json();
            console.log('📦 API javob (to\'liq):', JSON.stringify(data, null, 2));
            console.log('📦 data.success:', data.success);
            console.log('📦 data.sale:', data.sale);
            
            if (data.success && data.sale) {
                const sale = data.sale;
                console.log('📦 Sale obyekti:', sale);
                console.log('📍 location_type:', sale.location_type);
                console.log('📍 location_id:', sale.location_id);
                console.log('👤 customer_name:', sale.customer_name);
                console.log('👤 customer_id:', sale.customer_id);
                console.log('📦 items:', sale.items);
                console.log('📦 items.length:', sale.items?.length);
                
                // 1. JOYLASHUVNI TANLASH
                const locationSelect = getActiveTabElement('locationSelect');
                console.log('📍 locationSelect element:', locationSelect);
                console.log('📍 locationSelect.options.length:', locationSelect?.options?.length);
                
                if (!locationSelect) {
                    console.error('❌ locationSelect elementi topilmadi');
                    alert('Joylashuv tanlash elementi topilmadi');
                    return;
                }
                
                const locationValue = sale.location_type === 'store' ? `store_${sale.location_id}` : `warehouse_${sale.location_id}`;
                console.log(`📍 Joylashuv qiymati o'rnatilmoqda: ${locationValue}`);
                
                // Joylashuvni topish va o'rnatish
                let locationFound = false;
                for (let i = 0; i < locationSelect.options.length; i++) {
                    if (locationSelect.options[i].value === locationValue) {
                        locationSelect.selectedIndex = i;
                        locationFound = true;
                        console.log(`✅ Joylashuv topildi va tanlandi: ${locationSelect.options[i].text}`);
                        break;
                    }
                }
                
                if (!locationFound) {
                    console.error(`❌ Joylashuv topilmadi: ${locationValue}`);
                    alert(`Joylashuv topilmadi: ${locationValue}`);
                    return;
                }
                
                // Global o'zgaruvchilarni yangilash
                selectedLocationType = sale.location_type;
                selectedLocationId = sale.location_id;
                console.log(`📍 Global o'zgaruvchilar o'rnatildi: type=${selectedLocationType}, id=${selectedLocationId}`);
                
                // Location change event'ni trigger qilish
                const changeEvent = new Event('change', { bubbles: true });
                locationSelect.dispatchEvent(changeEvent);
                
                // 2. MAHSULOTLARNI YUKLASH
                console.log('📦 Mahsulotlar yuklanmoqda...');
                await loadProducts();
                console.log('✅ Mahsulotlar yuklandi');
                
                // 3. MIJOZNI TO'LDIRISH
                const customerSearchInput = getActiveTabElement('customerSearch');
                const selectedCustomerIdInput = getActiveTabElement('selectedCustomerId');
                console.log('👤 customerSearch element:', customerSearchInput);
                console.log('👤 selectedCustomerId element:', selectedCustomerIdInput);
                
                // Mijoz ma'lumotlarini o'rnatish
                if (sale.customer_id && sale.customer_name) {
                    const displayText = sale.customer_phone ? `${sale.customer_name} - ${sale.customer_phone}` : sale.customer_name;
                    if (customerSearchInput) customerSearchInput.value = displayText;
                    if (selectedCustomerIdInput) selectedCustomerIdInput.value = sale.customer_id;
                    
                    // Korzina sarlavhasida mijoz ko'rsatish
                    const cartCustomerInfo = getActiveTabElement('cartCustomerInfo');
                    const customerDisplay = sale.customer_phone ? `👤 ${sale.customer_name} ${sale.customer_phone}` : `👤 ${sale.customer_name}`;
                    cartCustomerInfo.innerHTML = `<h3 style="margin: 0; color: #333; font-size: 15px; font-weight: 600;">${customerDisplay}</h3>`;
                    
                    // Tab sarlavhasida mijoz ma'lumotlarini ko'rsatish
                    const activeTab = document.querySelector('.sales-tab.active');
                    if (activeTab) {
                        const tabTitle = activeTab.querySelector('.tab-title');
                        if (tabTitle) {
                            const tabText = sale.customer_phone ? `${sale.customer_name} - ${sale.customer_phone}` : sale.customer_name;
                            tabTitle.textContent = tabText;
                            tabTitle.title = displayText; // Tooltip uchun to'liq ma'lumot
                            console.log(`✅ Tab sarlavhasi yangilandi: ${tabText}`);
                        }
                    }
                    
                    console.log(`✅ Mijoz to'ldirildi: ${sale.customer_name} (ID: ${sale.customer_id})`);
                } else {
                    console.warn('⚠️ Mijoz ma\'lumotlari topilmadi');
                }
                
                // 4. MAHSULOTLARNI KORZINAGA QO'SHISH
                console.log('⏳ 800ms kutilmoqda (DOM yangilanishi uchun)...');
                await new Promise(resolve => setTimeout(resolve, 800));
                
                if (sale.items && sale.items.length > 0) {
                    console.log(`\n🛒 ${sale.items.length} ta mahsulot savatga qo'shilmoqda...`);
                    console.log('==================================================');
                    
                    for (const item of sale.items) {
                        console.log(`\n📦 Mahsulot #${item.product_id}:`);
                        console.log(`   Nomi: ${item.product_name}`);
                        console.log(`   Miqdor: ${item.quantity}`);
                        console.log(`   Narx: $${item.unit_price}`);
                        console.log(`   Jami: $${item.total_price}`);
                        
                        // Modal ochmasdan to'g'ridan-to'g'ri qo'shish
                        addToCartDirectly(
                            item.product_id,
                            item.product_name,
                            item.quantity,
                            item.unit_price
                        );
                    }
                    
                    console.log('==================================================');
                    console.log(`✅ ${sale.items.length} ta mahsulot korzinaga qo'shildi`);
                    console.log(`📊 Korzina holati: ${cart.length} ta element`);
                    
                    // Korzinani ko'rsatish uchun
                    cart.forEach((item, index) => {
                        console.log(`   ${index + 1}. ${item.name} x${item.quantity} = $${(item.priceUSD * item.quantity).toFixed(2)}`);
                    });
                } else {
                    console.warn('⚠️ Savdoda mahsulotlar topilmadi');
                }
            } else {
                console.error('❌ API javobida xatolik:', data);
                alert('Savdo ma\'lumotlari noto\'g\'ri formatda');
            }
        } catch (error) {
            console.error('❌ Savdo guruhini yuklashda xatolik:', error);
            console.error('❌ Error stack:', error.stack);
            alert('Savdo ma\'lumotlarini yuklashda xatolik: ' + error.message);
        }
    }
    
    // Bitta savdoni yuklash
    async function loadSingleSale(saleId) {
        try {
            console.log(`📥 Savdo ${saleId} yuklanmoqda...`);
            
            // Avval korzinani tozalash
            if (cart.length > 0) {
                console.log('🗑️ Korzinani tozalash...');
                cart = [];
                updateCart();
            }
            
            const response = await fetch(`/api/sales/${saleId}`);
            if (!response.ok) {
                throw new Error('Savdoni yuklashda xatolik');
            }
            
            const data = await response.json();
            console.log('📦 Savdo ma\'lumotlari:', data);
            
            if (data.success && data.sale) {
                const sale = data.sale;
                
                // Joylashuvni tanlash
                const locationSelect = document.getElementById('locationSelect');
                const locationValue = sale.location_type === 'store' ? `store_${sale.location_id}` : `warehouse_${sale.location_id}`;
                console.log(`📍 Joylashuv tanlanmoqda: ${locationValue}`);
                locationSelect.value = locationValue;
                
                // Global o'zgaruvchilarni yangilash
                selectedLocationType = sale.location_type;
                selectedLocationId = sale.location_id;
                
                // Mahsulotlarni yuklash
                console.log('📦 Mahsulotlar yuklanmoqda...');
                await loadProducts();
                console.log('✅ Mahsulotlar yuklandi');
                
                // Mijozni to'ldirish (ID bilan)
                if (sale.customer_id && sale.customer_name) {
                    const displayText = sale.customer_phone ? `${sale.customer_name} - ${sale.customer_phone}` : sale.customer_name;
                    const customerSearchInput = getActiveTabElement('customerSearch');
                    const selectedCustomerIdInput = getActiveTabElement('selectedCustomerId');
                    
                    if (customerSearchInput) customerSearchInput.value = displayText;
                    if (selectedCustomerIdInput) selectedCustomerIdInput.value = sale.customer_id;
                    
                    // Korzina sarlavhasida mijoz ko'rsatish
                    const cartCustomerInfo = getActiveTabElement('cartCustomerInfo');
                    if (cartCustomerInfo) {
                        const customerDisplay = sale.customer_phone ? `👤 ${sale.customer_name} ${sale.customer_phone}` : `👤 ${sale.customer_name}`;
                        cartCustomerInfo.innerHTML = `<h3 style="margin: 0; color: #333; font-size: 15px; font-weight: 600;">${customerDisplay}</h3>`;
                    }
                    
                    // Tab sarlavhasida mijoz ma'lumotlarini ko'rsatish
                    const activeTab = document.querySelector('.sales-tab.active');
                    if (activeTab) {
                        const tabTitle = activeTab.querySelector('.tab-title');
                        if (tabTitle) {
                            const tabText = sale.customer_phone ? `${sale.customer_name} - ${sale.customer_phone}` : sale.customer_name;
                            tabTitle.textContent = tabText;
                            tabTitle.title = displayText; // Tooltip uchun to'liq ma'lumot
                            console.log(`✅ Tab sarlavhasi yangilandi: ${tabText}`);
                        }
                    }
                    
                    console.log(`✅ Mijoz to'ldirildi: ${sale.customer_name} (ID: ${sale.customer_id})`);
                } else {
                    console.warn('⚠️ Mijoz ma\'lumotlari topilmadi');
                }
                
                // Kichik kutish - mahsulotlar DOM'ga qo'shilishi uchun
                console.log('⏳ 800ms kutilmoqda...');
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Savdo elementini savatga qo'shish
                if (sale.items && sale.items.length > 0) {
                    console.log(`🛒 ${sale.items.length} ta mahsulot savatga qo'shilmoqda...`);
                    
                    for (const item of sale.items) {
                        console.log(`  📦 ${item.product_name}: ${item.quantity} ta × $${item.unit_price}`);
                        
                        // Modal ochmasdan to'g'ridan-to'g'ri qo'shish
                        addToCartDirectly(
                            item.product_id,
                            item.product_name,
                            item.quantity,
                            item.unit_price
                        );
                    }
                    
                    console.log(`✅ ${sale.items.length} ta mahsulot korzinaga qo'shildi`);
                    console.log(`📊 Korzina holati: ${cart.length} ta element`);
                } else {
                    console.warn('⚠️ Savdoda mahsulotlar topilmadi');
                }
            } else {
                console.error('❌ API javobida xatolik:', data);
                alert('Savdo ma\'lumotlari noto\'g\'ri formatda');
            }
        } catch (error) {
            console.error('❌ Savdoni yuklashda xatolik:', error);
            alert('Savdo ma\'lumotlarini yuklashda xatolik: ' + error.message);
        }
    }
    
    // Sahifa yuklanganda joylashuvlarni yuklash
    document.addEventListener('DOMContentLoaded', async function() {
        // Avval asosiy ma'lumotlarni yuklash
        await loadLocations();
        await loadCustomers();
        await loadExchangeRate();
        
        // Keyin URL parametrlarini tekshirish va savdo ma'lumotlarini yuklash
        await checkURLParametersAndLoadSale();
        
        // Event listener'lar endi har bir tab yaratilganda setupTabEventListeners() da qo'shiladi
        
        // To'lov modal oynasida USD dan UZS ga avtomatik konversiya
        const paymentCashUSD = document.getElementById('paymentCashUSD');
        if (paymentCashUSD) {
            paymentCashUSD.addEventListener('input', function() {
                const usd = parseFloat(this.value) || 0;
                const paymentCashUZS = document.getElementById('paymentCashUZS');
                if (paymentCashUZS) {
                    paymentCashUZS.value = Math.round(usd * exchangeRate);
                }
            });
        }
        
        const paymentClickUSD = document.getElementById('paymentClickUSD');
        if (paymentClickUSD) {
            paymentClickUSD.addEventListener('input', function() {
                const usd = parseFloat(this.value) || 0;
                const paymentClickUZS = document.getElementById('paymentClickUZS');
                if (paymentClickUZS) {
                    paymentClickUZS.value = Math.round(usd * exchangeRate);
                }
            });
        }
        
        const paymentTerminalUSD = document.getElementById('paymentTerminalUSD');
        if (paymentTerminalUSD) {
            paymentTerminalUSD.addEventListener('input', function() {
                const usd = parseFloat(this.value) || 0;
                const paymentTerminalUZS = document.getElementById('paymentTerminalUZS');
                if (paymentTerminalUZS) {
                    paymentTerminalUZS.value = Math.round(usd * exchangeRate);
                }
            });
        }
        
        const paymentDebtUSD = document.getElementById('paymentDebtUSD');
        if (paymentDebtUSD) {
            paymentDebtUSD.addEventListener('input', function() {
                const usd = parseFloat(this.value) || 0;
                const paymentDebtUZS = document.getElementById('paymentDebtUZS');
                if (paymentDebtUZS) {
                    paymentDebtUZS.value = Math.round(usd * exchangeRate);
                }
            });
        }
        
        // To'lov modal oynasida UZS dan USD ga avtomatik konversiya
        const paymentCashUZS = document.getElementById('paymentCashUZS');
        if (paymentCashUZS) {
            paymentCashUZS.addEventListener('input', function() {
                const uzs = parseFloat(this.value) || 0;
                const paymentCashUSD_elem = document.getElementById('paymentCashUSD');
                if (paymentCashUSD_elem) {
                    paymentCashUSD_elem.value = (uzs / exchangeRate).toFixed(2);
                }
            });
        }
        
        const paymentClickUZS = document.getElementById('paymentClickUZS');
        if (paymentClickUZS) {
            paymentClickUZS.addEventListener('input', function() {
                const uzs = parseFloat(this.value) || 0;
                const paymentClickUSD_elem = document.getElementById('paymentClickUSD');
                if (paymentClickUSD_elem) {
                    paymentClickUSD_elem.value = (uzs / exchangeRate).toFixed(2);
                }
            });
        }
        
        const paymentTerminalUZS = document.getElementById('paymentTerminalUZS');
        if (paymentTerminalUZS) {
            paymentTerminalUZS.addEventListener('input', function() {
                const uzs = parseFloat(this.value) || 0;
                const paymentTerminalUSD_elem = document.getElementById('paymentTerminalUSD');
                if (paymentTerminalUSD_elem) {
                    paymentTerminalUSD_elem.value = (uzs / exchangeRate).toFixed(2);
                }
            });
        }
        
        const paymentDebtUZS = document.getElementById('paymentDebtUZS');
        if (paymentDebtUZS) {
            paymentDebtUZS.addEventListener('input', function() {
                const uzs = parseFloat(this.value) || 0;
                const paymentDebtUSD_elem = document.getElementById('paymentDebtUSD');
                if (paymentDebtUSD_elem) {
                    paymentDebtUSD_elem.value = (uzs / exchangeRate).toFixed(2);
                }
            });
        }
        
        // Input focus bo'lganda dropdown'ni ko'rsatish
        const customerSearchInput2 = document.getElementById('customerSearch');
        if (customerSearchInput2) {
            customerSearchInput2.addEventListener('focus', function() {
                if (this.value.length >= 2) {
                    searchCustomers(this.value);
                }
            });
        }
        
        // Modal oynada Enter tugmasi bosilganda savatga qo'shish
        const modalQuantity = document.getElementById('modalQuantity');
        const modalPriceUSD = document.getElementById('modalPriceUSD');
        const modalPriceUZS = document.getElementById('modalPriceUZS');
        
        [modalQuantity, modalPriceUSD, modalPriceUZS].forEach(input => {
            if (input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        confirmAddToCart();
                    }
                });
            }
        });
        
        // Dropdown tashqarisiga bosilganda yopish
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('customerDropdown');
            const input = document.getElementById('customerSearch');
            if (dropdown && input && e.target !== input && e.target !== dropdown && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        // Event listener'lar har bir tab uchun setupTabEventListeners'da o'rnatiladi
        
        // Session ma'lumotlarini tekshirish
        console.log('🔐 Session ma\'lumotlari:', {
            username: '{{ session.get("username", "None") }}',
            user_name: '{{ session.get("user_name", "None") }}',
            user_phone: '{{ session.get("user_phone", "None") }}',
            user_id: '{{ session.get("user_id", "None") }}',
            role: '{{ session.get("role", "None") }}'
        });
        
        console.log('✅ Sales sahifasi tayyor');
    });
    
    // Savatni tozalash
    async function clearCart() {
        if (cart.length === 0) {
            alert('Savat allaqachon bo\'sh!');
            return;
        }
        
        if (!confirm('Savatni tozalashni xohlaysizmi? Barcha mahsulotlar stokga qaytariladi.')) {
            return;
        }
        
        // Barcha mahsulotlarni stokga qaytarish
        console.log('🔄 Barcha mahsulotlarni stokga qaytarish...');
        
        for (const item of cart) {
            try {
                const response = await fetch('/api/return-stock', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        product_id: item.id,
                        quantity: item.quantity,
                        location_id: selectedLocationId,
                        location_type: selectedLocationType
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log(`✅ ${item.name}: ${item.quantity} dona stokga qaytarildi`);
                } else {
                    console.error(`❌ ${item.name}: Stokga qaytarishda xatolik - ${result.error}`);
                }
            } catch (error) {
                console.error(`❌ ${item.name}: Stok qaytarish xatosi:`, error);
            }
        }
        
        // Korzinani tozalash
        cart = [];
        
        // Pending savdoni o'chirish (STOK QAYTARMASDAN - chunki allaqachon clearCart() da qaytarilgan)
        if (currentPendingSaleId) {
            try {
                await fetch(`/api/sales/${currentPendingSaleId}?return_stock=false`, {
                    method: 'DELETE'
                });
                console.log('🗑️ Pending savdo o\'chirildi (stok qaytarilmadi):', currentPendingSaleId);
                currentPendingSaleId = null;
            } catch (error) {
                console.error('❌ Pending savdoni o\'chirishda xatolik:', error);
            }
        }
        
        // Mijoz maydonini tozalash
        const customerSearch = getActiveTabElement('customerSearch');
        const selectedCustomerId = getActiveTabElement('selectedCustomerId');
        if (customerSearch) {
            customerSearch.value = '';
        }
        if (selectedCustomerId) {
            selectedCustomerId.value = '';
        }
        
        updateCart();
        
        // Mahsulotlar jadvalini yangilash
        await loadProducts();
        
        console.log('🗑️ Savat tozalandi va barcha mahsulotlar stokga qaytarildi');
        alert('✅ Savat tozalandi va mahsulotlar stokga qaytarildi');
    }
    
    // Avtomatik pending savdo yaratish/yangilash
    async function autoSavePending() {
        // Agar savat bo'sh bo'lsa, pending savdoni o'chirish (STOK QAYTARMASDAN)
        if (cart.length === 0) {
            if (currentPendingSaleId) {
                try {
                    // ?return_stock=false - chunki stok allaqachon removeFromCart() da qaytarilgan
                    await fetch(`/api/sales/${currentPendingSaleId}?return_stock=false`, {
                        method: 'DELETE'
                    });
                    console.log('🗑️ Bo\'sh pending savdo o\'chirildi (stok qaytarilmadi):', currentPendingSaleId);
                    currentPendingSaleId = null;
                } catch (error) {
                    console.error('❌ Pending savdoni o\'chirishda xatolik:', error);
                }
            }
            return;
        }
        
        // Location tanlanmagan bo'lsa, saqlamaymiz
        if (!selectedLocationId || !selectedLocationType) {
            console.log('⚠️ Location tanlanmagan, pending savdo saqlanmaydi');
            return;
        }
        
        // Savdo ma'lumotlarini tayyorlash
        const selectedCustomerIdElement = getActiveTabElement('selectedCustomerId');
        const customerId = selectedCustomerIdElement ? selectedCustomerIdElement.value || null : null;
        let totalUSD = 0;
        cart.forEach(item => {
            totalUSD += item.priceUSD * item.quantity;
        });
        
        const saleData = {
            customer_id: customerId ? parseInt(customerId) : null,
            location_id: selectedLocationId,
            location_type: selectedLocationType,
            items: cart.map(item => ({
                product_id: item.id || item.productId,
                product_name: item.name || item.productName,
                quantity: item.quantity,
                unit_price: item.priceUSD,
                price: item.priceUSD,
                price_usd: item.priceUSD,
                price_uzs: item.priceUZS,
                location_id: selectedLocationId,
                location_type: selectedLocationType
            })),
            payment: {
                cash_usd: 0,
                cash_uzs: 0,
                click_usd: 0,
                click_uzs: 0,
                terminal_usd: 0,
                terminal_uzs: 0,
                debt_usd: totalUSD,
                debt_uzs: Math.round(totalUSD * exchangeRate)
            },
            total_usd: totalUSD,
            total_uzs: totalUSD * exchangeRate,
            exchange_rate: exchangeRate,
            payment_status: 'pending'
        };
        
        try {
            let response, result;
            
            // Tahrirlash rejimida bo'lsa yoki mavjud pending savdo bo'lsa - yangilash
            if (editingSaleId || currentPendingSaleId) {
                const saleIdToUpdate = editingSaleId || currentPendingSaleId;
                console.log('📝 Pending savdoni yangilash:', saleIdToUpdate, editingSaleId ? '(tahrirlash rejimi)' : '(avtosave)');
                response = await fetch(`/api/sales/${saleIdToUpdate}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(saleData)
                });
                
                // Agar tahrirlash rejimida bo'lsa, currentPendingSaleId ni o'rnatish
                if (editingSaleId && !currentPendingSaleId) {
                    currentPendingSaleId = editingSaleId;
                }
            } else {
                // Yangi pending savdo yaratish
                console.log('➕ Yangi pending savdo yaratish');
                response = await fetch('/api/pending-sales', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(saleData)
                });
            }
            
            result = await response.json();
            
            if (result.success) {
                if (!currentPendingSaleId) {
                    currentPendingSaleId = result.sale_id;
                    console.log('✅ Yangi pending savdo yaratildi, ID:', currentPendingSaleId);
                } else {
                    console.log('✅ Pending savdo yangilandi, ID:', currentPendingSaleId);
                }
            } else {
                console.error('❌ Pending savdoni saqlashda xatolik:', result.error);
            }
        } catch (error) {
            console.error('❌ Pending savdoni saqlashda xatolik:', error);
        }
    }
    
    // Keyinroq tasdiqlash
    async function savePending() {
        if (cart.length === 0) {
            alert('Savat bo\'sh!');
            return;
        }
        
        const selectedCustomerIdElement = getActiveTabElement('selectedCustomerId');
        const customerId = selectedCustomerIdElement ? selectedCustomerIdElement.value || null : null;
        
        if (!selectedLocationId || !selectedLocationType) {
            alert('Joylashuvni tanlang!');
            return;
        }
        
        // Jami summani hisoblash
        let totalUSD = 0;
        cart.forEach(item => {
            totalUSD += item.priceUSD * item.quantity;
        });
        
        // Savdoni pending status bilan saqlash
        const saleData = {
            customer_id: parseInt(customerId),
            location_id: selectedLocationId,
            location_type: selectedLocationType,
            items: cart.map(item => ({
                product_id: item.id || item.productId,
                product_name: item.name || item.productName,
                quantity: item.quantity,
                unit_price: item.priceUSD,
                price: item.priceUSD,
                price_usd: item.priceUSD,
                price_uzs: item.priceUZS
            })),
            payment: {
                cash_usd: 0,
                cash_uzs: 0,
                click_usd: 0,
                click_uzs: 0,
                terminal_usd: 0,
                terminal_uzs: 0,
                debt_usd: totalUSD,
                debt_uzs: Math.round(totalUSD * exchangeRate)
            },
            total_usd: totalUSD,
            total_uzs: totalUSD * exchangeRate,
            exchange_rate: exchangeRate,
            payment_status: 'pending'
        };
        
        console.log('⏸️ Pending savdo ma\'lumotlari:', saleData);
        
        try {
            let response, result;
            
            // Agar tahrirlash rejimida bo'lsa yoki avtomatik yaratilgan pending savdo bo'lsa, yangilash
            if (editingSaleId || currentPendingSaleId) {
                const saleIdToUpdate = editingSaleId || currentPendingSaleId;
                console.log('📝 Mavjud savdoni pending holatga o\'zgartirish, ID:', saleIdToUpdate);
                response = await fetch(`/api/sales/${saleIdToUpdate}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ...saleData,
                        payment_status: 'pending'
                    })
                });
            } else {
                // Yangi savdo yaratish
                console.log('➕ Yangi savdoni pending holatda yaratish');
                response = await fetch('/api/pending-sales', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(saleData)
                });
            }
            
            result = await response.json();
            console.log('API javob:', result);
            
            if (result.success) {
                if (editingSaleId || currentPendingSaleId) {
                    alert('✅ Savdo pending holatga o\'tkazildi! Endi Tasdiqlanmagan savdolar ro\'yxatida ko\'rinadi.');
                } else {
                    alert('✅ Savdo keyinroq tasdiqlash uchun saqlandi!');
                }
                console.log('⏸️ Savdo pending holatga o\'tkazildi, ID:', result.sale_id || editingSaleId || currentPendingSaleId);
                
                // Tahrirlash rejimidan chiqish
                editingSaleId = null;
                currentPendingSaleId = null;  // Pending savdo ID ni ham tozalash
                
                // Savatni tozalash
                cart = [];
                updateCart();
                
                // Mijozni tozalash (elementlar mavjudligini tekshirish)
                const customerIdInput = getActiveTabElement('selectedCustomerId');
                const customerNameDisplay = getActiveTabElement('customerNameDisplay');
                const customerPhoneDisplay = getActiveTabElement('customerPhoneDisplay');
                
                if (customerIdInput) customerIdInput.value = '';
                if (customerNameDisplay) customerNameDisplay.textContent = 'Mijoz tanlanmagan';
                if (customerPhoneDisplay) customerPhoneDisplay.textContent = '';
            } else {
                alert('❌ Xatolik: ' + (result.error || 'Noma\'lum xatolik'));
            }
        } catch (error) {
            console.error('Pending savdo xatosi:', error);
            alert('❌ Tarmoq xatoligi: ' + error.message);
        }
    }
    
    // Savdoni yakunlash
    function completeSale() {
        if (cart.length === 0) {
            alert('Savat bo\'sh!');
            return;
        }
        
        const selectedCustomerIdElement = getActiveTabElement('selectedCustomerId');
        const customerId = selectedCustomerIdElement ? selectedCustomerIdElement.value || null : null;
        
        // Jami summani hisoblash
        let totalUSD = 0;
        cart.forEach(item => {
            totalUSD += item.priceUSD * item.quantity;
        });
        
        const totalUZS = totalUSD * exchangeRate;
        
        // To'lov modal oynasini ochish - GLOBAL modal
        const paymentModalTotalUSD = document.getElementById('paymentModalTotalUSD');
        const paymentModalTotalUZS = document.getElementById('paymentModalTotalUZS');
        const paymentCashUSD = document.getElementById('paymentCashUSD');
        const paymentCashUZS = document.getElementById('paymentCashUZS');
        const paymentClickUSD = document.getElementById('paymentClickUSD');
        const paymentClickUZS = document.getElementById('paymentClickUZS');
        const paymentTerminalUSD = document.getElementById('paymentTerminalUSD');
        const paymentTerminalUZS = document.getElementById('paymentTerminalUZS');
        const paymentDebtUSD = document.getElementById('paymentDebtUSD');
        const paymentDebtUZS = document.getElementById('paymentDebtUZS');
        const paymentModal = document.getElementById('paymentModal');
        const confirmBtn = document.getElementById('confirmPaymentBtn');
        
        // Tugmani to'liq reset qilish
        if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.textContent = '✅ Tasdiqlash';
            confirmBtn.style.opacity = '1';
            confirmBtn.style.cursor = 'pointer';
        }
        
        if (paymentModalTotalUSD) paymentModalTotalUSD.textContent = `$${totalUSD.toFixed(2)}`;
        if (paymentModalTotalUZS) paymentModalTotalUZS.textContent = `${Math.round(totalUZS).toLocaleString('uz-UZ')} so'm`;
        if (paymentCashUSD) paymentCashUSD.value = totalUSD.toFixed(2);
        if (paymentCashUZS) paymentCashUZS.value = Math.round(totalUZS);
        if (paymentClickUSD) paymentClickUSD.value = '';
        if (paymentClickUZS) paymentClickUZS.value = '';
        if (paymentTerminalUSD) paymentTerminalUSD.value = '';
        if (paymentTerminalUZS) paymentTerminalUZS.value = '';
        if (paymentDebtUSD) paymentDebtUSD.value = '';
        if (paymentDebtUZS) paymentDebtUZS.value = '';
        if (paymentModal) paymentModal.style.display = 'flex';
        
        // Event listener'larni o'rnatish (real-time konversiya uchun)
        if (paymentCashUSD && paymentCashUZS) {
            // Eski listener'larni olib tashlash uchun clone qilish
            const newCashUSD = paymentCashUSD.cloneNode(true);
            const newCashUZS = paymentCashUZS.cloneNode(true);
            paymentCashUSD.parentNode.replaceChild(newCashUSD, paymentCashUSD);
            paymentCashUZS.parentNode.replaceChild(newCashUZS, paymentCashUZS);
            
            // Yangi listener'lar
            newCashUSD.addEventListener('input', function() {
                const usdValue = parseFloat(this.value) || 0;
                const cashUZS = document.getElementById('paymentCashUZS');
                if (cashUZS) cashUZS.value = Math.round(usdValue * exchangeRate);
            });
            newCashUZS.addEventListener('input', function() {
                const cashUSD = document.getElementById('paymentCashUSD');
                if (this.value.trim() === '') {
                    if (cashUSD) cashUSD.value = '';
                } else {
                    const uzsValue = parseFloat(this.value) || 0;
                    if (cashUSD) cashUSD.value = (uzsValue / exchangeRate).toFixed(2);
                }
            });
        }
        
        if (paymentClickUSD && paymentClickUZS) {
            const newClickUSD = paymentClickUSD.cloneNode(true);
            const newClickUZS = paymentClickUZS.cloneNode(true);
            paymentClickUSD.parentNode.replaceChild(newClickUSD, paymentClickUSD);
            paymentClickUZS.parentNode.replaceChild(newClickUZS, paymentClickUZS);
            
            newClickUSD.addEventListener('input', function() {
                const usdValue = parseFloat(this.value) || 0;
                const clickUZS = document.getElementById('paymentClickUZS');
                if (clickUZS) clickUZS.value = Math.round(usdValue * exchangeRate);
            });
            newClickUZS.addEventListener('input', function() {
                const clickUSD = document.getElementById('paymentClickUSD');
                if (this.value.trim() === '') {
                    if (clickUSD) clickUSD.value = '';
                } else {
                    const uzsValue = parseFloat(this.value) || 0;
                    if (clickUSD) clickUSD.value = (uzsValue / exchangeRate).toFixed(2);
                }
            });
        }
        
        if (paymentTerminalUSD && paymentTerminalUZS) {
            const newTerminalUSD = paymentTerminalUSD.cloneNode(true);
            const newTerminalUZS = paymentTerminalUZS.cloneNode(true);
            paymentTerminalUSD.parentNode.replaceChild(newTerminalUSD, paymentTerminalUSD);
            paymentTerminalUZS.parentNode.replaceChild(newTerminalUZS, paymentTerminalUZS);
            
            newTerminalUSD.addEventListener('input', function() {
                const usdValue = parseFloat(this.value) || 0;
                const terminalUZS = document.getElementById('paymentTerminalUZS');
                if (terminalUZS) terminalUZS.value = Math.round(usdValue * exchangeRate);
            });
            newTerminalUZS.addEventListener('input', function() {
                const terminalUSD = document.getElementById('paymentTerminalUSD');
                if (this.value.trim() === '') {
                    if (terminalUSD) terminalUSD.value = '';
                } else {
                    const uzsValue = parseFloat(this.value) || 0;
                    if (terminalUSD) terminalUSD.value = (uzsValue / exchangeRate).toFixed(2);
                }
            });
        }
        
        if (paymentDebtUSD && paymentDebtUZS) {
            const newDebtUSD = paymentDebtUSD.cloneNode(true);
            const newDebtUZS = paymentDebtUZS.cloneNode(true);
            paymentDebtUSD.parentNode.replaceChild(newDebtUSD, paymentDebtUSD);
            paymentDebtUZS.parentNode.replaceChild(newDebtUZS, paymentDebtUZS);
            
            newDebtUSD.addEventListener('input', function() {
                const usdValue = parseFloat(this.value) || 0;
                const debtUZS = document.getElementById('paymentDebtUZS');
                if (debtUZS) debtUZS.value = Math.round(usdValue * exchangeRate);
            });
            newDebtUZS.addEventListener('input', function() {
                const debtUSD = document.getElementById('paymentDebtUSD');
                if (this.value.trim() === '') {
                    if (debtUSD) debtUSD.value = '';
                } else {
                    const uzsValue = parseFloat(this.value) || 0;
                    if (debtUSD) debtUSD.value = (uzsValue / exchangeRate).toFixed(2);
                }
            });
        }
        
        // Fokusni Naxt so'm maydoniga berish
        setTimeout(() => {
            const cashUZS = document.getElementById('paymentCashUZS');
            if (cashUZS) {
                cashUZS.focus();
                cashUZS.select();
            }
        }, 100);
        
        // Enter key'ni bloklash - modal ichidagi barcha input'larda
        const paymentInputs = document.querySelectorAll('#paymentModal input[type="number"]');
        paymentInputs.forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation();
                    // Keyingi input'ga o'tish
                    const inputs = Array.from(paymentInputs);
                    const currentIndex = inputs.indexOf(this);
                    if (currentIndex < inputs.length - 1) {
                        inputs[currentIndex + 1].focus();
                    }
                }
            });
        });
        
        console.log('💳 To\'lov modali ochildi');
    }
    
    // To'lov modal oynasini yopish
    function closePaymentModal() {
        const paymentModal = document.getElementById('paymentModal');
        if (paymentModal) paymentModal.style.display = 'none';
        
        // Ogohlantirishni yashirish
        const paymentWarning = document.getElementById('paymentWarning');
        if (paymentWarning) {
            paymentWarning.style.display = 'none';
            paymentWarning.textContent = '';
        }
        
        // Tugmani reset qilish
        const confirmBtn = document.getElementById('confirmPaymentBtn');
        if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.textContent = '✅ Tasdiqlash';
            confirmBtn.style.opacity = '1';
            confirmBtn.style.cursor = 'pointer';
        }
    }
    
    // Qolgan summani maydonga qo'shish
    function addRemainingToField(fieldId) {
        console.log('🔧 addRemainingToField chaqirildi:', fieldId);
        
        // Jami summani hisoblash
        let totalUSD = 0;
        cart.forEach(item => {
            totalUSD += item.priceUSD * item.quantity;
        });
        
        console.log('💰 Jami summa (USD):', totalUSD);
        console.log('💱 Exchange rate:', exchangeRate);
        
        // Hozirgi to'lovlarni hisoblash (faqat USD qiymatlardan, UZS dan emas)
        const paymentCashUSD = document.getElementById('paymentCashUSD');
        const paymentClickUSD = document.getElementById('paymentClickUSD');
        const paymentTerminalUSD = document.getElementById('paymentTerminalUSD');
        const paymentDebtUSD = document.getElementById('paymentDebtUSD');
        
        const cashUSD = paymentCashUSD ? parseFloat(paymentCashUSD.value) || 0 : 0;
        const clickUSD = paymentClickUSD ? parseFloat(paymentClickUSD.value) || 0 : 0;
        const terminalUSD = paymentTerminalUSD ? parseFloat(paymentTerminalUSD.value) || 0 : 0;
        const debtUSD = paymentDebtUSD ? parseFloat(paymentDebtUSD.value) || 0 : 0;
        
        console.log('💵 Hozirgi to\'lovlar (faqat USD):', { cashUSD, clickUSD, terminalUSD, debtUSD });
        
        const currentTotal = cashUSD + clickUSD + terminalUSD + debtUSD;
        const remaining = totalUSD - currentTotal;
        
        console.log('📊 Hozirgi jami:', currentTotal);
        console.log('📊 Qolgan:', remaining);
        
        // Aqlli mantiq: kam to'langan yoki ortiq to'langan bo'lsa ham to'g'ri ishlaydi
        const fieldElement = document.getElementById(fieldId);
        if (!fieldElement) {
            console.error('❌ Field element topilmadi:', fieldId);
            return;
        }
        
        const currentFieldValue = parseFloat(fieldElement.value) || 0;
        let newUSDValue;
        
        if (remaining === 0) {
            console.log('✅ To\'lov to\'liq to\'langan, o\'zgartirish shart emas');
            return;
        } else if (remaining > 0) {
            // Kam to'langan: qolgan summani o'rnatish (replace)
            newUSDValue = remaining;
            console.log(`➕ Kam to'langan: ${fieldId} ga qolgan summa o'rnatildi: ${remaining.toFixed(2)}`);
        } else {
            // Ortiq to'langan: o'sha maydondan ortiqcha summani ayirish
            newUSDValue = Math.max(0, currentFieldValue + remaining); // remaining manfiy, shuning uchun ayiriladi
            console.log(`➖ Ortiq to'langan: ${fieldId} dan ortiqcha summa ayirildi: ${currentFieldValue.toFixed(2)} + (${remaining.toFixed(2)}) = ${newUSDValue.toFixed(2)}`);
        }
        
        // USD maydonini yangilash
        fieldElement.value = newUSDValue.toFixed(2);
        
        // UZS maydonini ham yangilash
        const uzsFieldId = fieldId.replace('USD', 'UZS');
        console.log('🔄 UZS maydon ID:', uzsFieldId);
        
        const uzsFieldElement = document.getElementById(uzsFieldId);
        if (uzsFieldElement) {
            const newUZSValue = Math.round(newUSDValue * exchangeRate);
            uzsFieldElement.value = newUZSValue;
            console.log(`✅ ${fieldId}: $${newUSDValue.toFixed(2)} (${newUZSValue.toLocaleString()} so'm)`);
        } else {
            console.error('❌ UZS maydoni topilmadi:', uzsFieldId);
        }
    }
    
    // Double-click himoyasi uchun o'zgaruvchi
    let isProcessingPayment = false;
    
    // To'lovni tasdiqlash
    async function confirmPayment() {
        // Double-click oldini olish
        if (isProcessingPayment) {
            console.log('⚠️ To\'lov allaqachon jarayonda');
            return;
        }
        
        isProcessingPayment = true;
        
        // Tasdiqlash tugmasini topish va o'chirish - GLOBAL
        const confirmBtn = document.getElementById('confirmPaymentBtn');
        const originalText = confirmBtn ? confirmBtn.textContent : '';
        if (confirmBtn) {
            confirmBtn.disabled = true;
            confirmBtn.textContent = '⏳ Saqlanmoqda...';
            confirmBtn.style.opacity = '0.6';
            confirmBtn.style.cursor = 'not-allowed';
        }
        
        try {
            // Ogohlantirishni yashirish
            const paymentWarning = document.getElementById('paymentWarning');
            if (paymentWarning) {
                paymentWarning.style.display = 'none';
                paymentWarning.textContent = '';
            }
            
            const paymentCashUSD = document.getElementById('paymentCashUSD');
            const paymentClickUSD = document.getElementById('paymentClickUSD');
            const paymentTerminalUSD = document.getElementById('paymentTerminalUSD');
            const paymentDebtUSD = document.getElementById('paymentDebtUSD');
            const paymentCashUZS = document.getElementById('paymentCashUZS');
            const paymentClickUZS = document.getElementById('paymentClickUZS');
            const paymentTerminalUZS = document.getElementById('paymentTerminalUZS');
            const paymentDebtUZS = document.getElementById('paymentDebtUZS');
            
            const cashUSD = paymentCashUSD ? parseFloat(paymentCashUSD.value) || 0 : 0;
            const clickUSD = paymentClickUSD ? parseFloat(paymentClickUSD.value) || 0 : 0;
            const terminalUSD = paymentTerminalUSD ? parseFloat(paymentTerminalUSD.value) || 0 : 0;
            const debtUSD = paymentDebtUSD ? parseFloat(paymentDebtUSD.value) || 0 : 0;
            
            const cashUZS = paymentCashUZS ? parseFloat(paymentCashUZS.value) || 0 : 0;
            const clickUZS = paymentClickUZS ? parseFloat(paymentClickUZS.value) || 0 : 0;
            const terminalUZS = paymentTerminalUZS ? parseFloat(paymentTerminalUZS.value) || 0 : 0;
            const debtUZS = paymentDebtUZS ? parseFloat(paymentDebtUZS.value) || 0 : 0;
            
            // Faqat USD qiymatlardan foydalanish (UZS avtomatik sinxronlashgan)
            const totalPayment = cashUSD + clickUSD + terminalUSD + debtUSD;
            
            // Jami summani hisoblash
            let totalUSD = 0;
            cart.forEach(item => {
                totalUSD += item.priceUSD * item.quantity;
            });
            
            // Mijoz tanlanganligini tekshirish (agar qarz bo'lsa)
            const selectedCustomerIdElement = getActiveTabElement('selectedCustomerId');
            const customerId = selectedCustomerIdElement ? selectedCustomerIdElement.value : null;
            
            console.log('💰 Qarz tekshiruvi:', {debtUSD, customerId, hasCustomer: !!customerId});
            
            if (debtUSD > 0 && !customerId) {
                alert('⚠️ DIQQAT!\n\nQarzga sotish uchun mijoz tanlanishi SHART!\n\n📋 Iltimos:\n1. "Mijoz tanlash" maydonidan mijoz tanlang\n2. Yoki yangi mijoz qo\'shing');
                
                if (paymentWarning) {
                    paymentWarning.textContent = '⚠️ Qarzga sotish uchun mijoz tanlanishi shart!';
                    paymentWarning.style.display = 'block';
                }
                
                // Mijoz input maydoniga focus
                const customerInput = getActiveTabElement('customerSearch');
                if (customerInput) {
                    customerInput.focus();
                    customerInput.style.border = '2px solid #dc3545';
                    setTimeout(() => {
                        customerInput.style.border = '';
                    }, 2000);
                }
                
                // Tugmani qayta faollashtirish
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = originalText;
                    confirmBtn.style.opacity = '1';
                    confirmBtn.style.cursor = 'pointer';
                }
                return;
            }
            
            // To'lov tekshiruvi
            if (Math.abs(totalPayment - totalUSD) > 0.01) {
                if (paymentWarning) {
                    paymentWarning.textContent = `⚠️ Jami to'lov ($${totalPayment.toFixed(2)}) savdo summasiga ($${totalUSD.toFixed(2)}) teng emas!`;
                    paymentWarning.style.display = 'block';
                }
                // Tugmani qayta faollashtirish
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = originalText;
                    confirmBtn.style.opacity = '1';
                    confirmBtn.style.cursor = 'pointer';
                }
                return;
            }
            
            // Idempotency key yaratish
            const idempotencyKey = `sale-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            
            // Savdoni backend'ga yuborish uchun ma'lumotlarni tayyorlash
            const saleData = {
                customer_id: customerId ? parseInt(customerId) : null,
                location_id: selectedLocationId,
                location_type: selectedLocationType,
                items: cart.map(item => ({
                    product_id: item.id || item.productId,  // id yoki productId
                    product_name: item.name || item.productName,  // name yoki productName
                    quantity: item.quantity,
                    unit_price: item.priceUSD,
                    price: item.priceUSD,
                    price_usd: item.priceUSD,
                    price_uzs: item.priceUZS
                })),
                payment: {
                    cash_usd: cashUSD,
                    cash_uzs: cashUZS,
                    click_usd: clickUSD,
                    click_uzs: clickUZS,
                    terminal_usd: terminalUSD,
                    terminal_uzs: terminalUZS,
                    debt_usd: debtUSD,
                    debt_uzs: debtUZS
                },
                total_usd: totalUSD,
                total_uzs: totalUSD * exchangeRate,
                exchange_rate: exchangeRate,
                // Payment status ni avtomatik aniqlash
                payment_status: debtUSD > 0 ? 'partial' : 'paid',
                // Agar tahrirlash rejimida bo'lsa
                original_sale_id: editingSaleId,
                is_edit_mode: editingSaleId !== null,
                idempotency_key: idempotencyKey  // Idempotency key qo'shish
            };
            
            console.log('📤 Savdoni backend ga yuborish:');
            console.log('   - Idempotency Key:', idempotencyKey);
            console.log('   - Tahrirlash rejimi:', editingSaleId !== null);
            console.log('   - Original Sale ID:', editingSaleId);
            console.log('   - Current Pending Sale ID:', currentPendingSaleId);
            console.log('   - Jami mahsulotlar:', saleData.items.length);
            console.log('   - Mijoz ID:', saleData.customer_id);
            console.log('   - Location ID:', saleData.location_id);
            console.log('   - Location Type:', saleData.location_type);
            console.log('   - To\'lov holati:', saleData.payment_status);
            console.log('Full sale data:', JSON.stringify(saleData, null, 2));
            
            let response;
            
            // YANGI MANTIQ: Agar pending savdo mavjud bo'lsa, faqat statusni o'zgartirish
            if (currentPendingSaleId && !editingSaleId) {
                console.log('🔄 Pending savdo statusini o\'zgartirish:', currentPendingSaleId);
                // Pending savdoni yakunlash - faqat status o'zgartirish
                response = await fetch(`/api/finalize-sale/${currentPendingSaleId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Idempotency-Key': idempotencyKey
                    },
                    body: JSON.stringify({
                        payment: saleData.payment,
                        payment_status: saleData.payment_status,
                        customer_id: saleData.customer_id,
                        exchange_rate: saleData.exchange_rate,
                        idempotency_key: idempotencyKey
                    })
                });
            } else {
                // Tahrirlash rejimida yoki pending yo'q bo'lsa - yangi savdo yaratish
                console.log('➕ Yangi savdo yaratish (tahrirlash yoki pending yo\'q)');
                response = await fetch('/api/create-sale', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Idempotency-Key': idempotencyKey
                    },
                    body: JSON.stringify(saleData)
                });
            }
            
            const result = await response.json();
            
            if (!result.success) {
                alert('Savdo yaratishda xatolik: ' + (result.error || 'Noma\'lum xatolik'));
                console.error('❌ Savdo xatosi:', result);
                // Tugmani qayta faollashtirish xatolik bo'lganda
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = originalText;
                    confirmBtn.style.opacity = '1';
                    confirmBtn.style.cursor = 'pointer';
                }
                return;
            }
            
            // Agar bu takroriy so'rov bo'lsa
            if (result.already_processed) {
                console.log('⚠️ Bu savdo allaqachon qayd qilingan');
            }
            
            console.log('✅ Savdo muvaffaqiyatli saqlandi:', result);
            
            // Chek chiqarish ma'lumotlarini global o'zgaruvchida saqlash
            let pendingReceiptData = null;
            
            // Chek chiqarish opsiyalarini tekshirish - GLOBAL
            const printUSD = document.getElementById('printReceiptUSD');
            const printUZS = document.getElementById('printReceiptUZS');
            
            console.log('🖨️ Chek chiqarish tekshiruvi:');
            console.log('   - printUSD element:', printUSD);
            console.log('   - printUSD.checked:', printUSD ? printUSD.checked : 'element topilmadi');
            console.log('   - printUZS element:', printUZS);
            console.log('   - printUZS.checked:', printUZS ? printUZS.checked : 'element topilmadi');
            
            if ((printUSD && printUSD.checked) || (printUZS && printUZS.checked)) {
                console.log('✅ Chek chiqarish belgilangan, modal yopilgandan keyin chiqariladi');
                
                // Mijoz ma'lumotlarini olish
                const customerSearchInput = getActiveTabElement('customerSearch');
                const customerName = customerId && customerSearchInput ? customerSearchInput.value : 'Naqd mijoz';
                
                // Qaysi valyuta tanlangani aniqlash
                const selectedCurrency = (printUSD && printUSD.checked && printUZS && printUZS.checked) ? 'both' 
                                      : (printUZS && printUZS.checked) ? 'uzs' 
                                      : 'usd';
            
                // To'lov turlarini tanlangan valyutada formatlash
                const paymentDetails = [];
                
                // Helper funksiya - takroriy kodni kamaytirish
                function formatPaymentDetail(label, amountUSD, currency) {
                    if (amountUSD <= 0) return;
                    
                    const amountUZS = Math.round(amountUSD * exchangeRate).toLocaleString('uz-UZ');
                    
                    if (currency === 'uzs') {
                        paymentDetails.push(`${label}: ${amountUZS} som`);
                    } else if (currency === 'both') {
                        paymentDetails.push(`${label}: $${amountUSD.toFixed(2)} / ${amountUZS} som`);
                    } else {
                        paymentDetails.push(`${label}: $${amountUSD.toFixed(2)}`);
                    }
                }
                
                // Barcha to'lov turlarini formatlash
                formatPaymentDetail('Naqd', cashUSD, selectedCurrency);
                formatPaymentDetail('Click', clickUSD, selectedCurrency);
                formatPaymentDetail('Terminal', terminalUSD, selectedCurrency);
                formatPaymentDetail('Qarz', debtUSD, selectedCurrency);
                
                // Savdo ma'lumotlarini tayyorlash
                const sellerName = '{{ session.get("user_name", session.get("username", "Sotuvchi")) }}';
                const sellerPhone = '{{ session.get("user_phone", "") }}';
                
                const saleForPrint = {
                    id: result.sale_id || result.id,
                    sale_date: new Date().toISOString(),
                    customer_name: customerName,
                    customer_phone: '',
                    seller_name: sellerName,
                    seller_phone: sellerPhone,
                    store_name: selectedLocationId ? (document.querySelector('#locationSelect option:checked')?.text || 'Do\'kon') : 'Do\'kon',
                    total_amount: totalUSD,
                    payment_details: paymentDetails.join(' / '),
                    items: cart.map(item => ({
                        product_name: item.name || item.productName,
                        quantity: item.quantity,
                        unit_price: item.priceUSD
                    }))
                };
                
                // Chek ma'lumotlarini saqlash - modal yopilganda chiqariladi
                pendingReceiptData = {
                    sale: saleForPrint,
                    currency: selectedCurrency
                };
            } else {
                console.log('ℹ️ Chek chiqarish belgilanmagan');
            }
            
            // Modalni yopish
            closePaymentModal();
            
            // Tahrirlash rejimida eski sahifaga qaytish
            if (editingSaleId) {
                alert('✅ Savdo muvaffaqiyatli tahrirlandi!');
                
                // Chek chiqarish (tahrirlash rejimida ham)
                if (pendingReceiptData) {
                    console.log('🖨️ Chek chiqarish boshlandi (tahrirlash rejimi)...');
                    const receiptWindow = window.open('', '_blank', 'width=400,height=600');
                    
                    if (!receiptWindow) {
                        alert('⚠️ Popup blocker chekni blokladi! Brauzer sozlamalarida popup\'larga ruxsat bering.');
                        console.error('❌ window.open() null qaytardi - popup blocker faol');
                    } else {
                        generatePrintableReceiptToWindow(receiptWindow, pendingReceiptData.sale, pendingReceiptData.currency);
                    }
                }
                
                console.log('🔄 Sales history sahifasiga qaytish...');
                window.location.href = '/sales-history';
                return;
            }
            
            // Pending savdo ID ni tozalash (chunki yakunlandi)
            if (currentPendingSaleId) {
                console.log('✅ Pending savdo yakunlandi va paid/partial statusga o\'tdi:', currentPendingSaleId);
                currentPendingSaleId = null;
            }
            
            // Alert'dan keyin chek chiqarish
            alert('✅ Savdo muvaffaqiyatli yakunlandi!');
            
            // Chek chiqarish (agar belgilangan bo'lsa)
            if (pendingReceiptData) {
                console.log('🖨️ Chek chiqarish boshlandi...');
                const receiptWindow = window.open('', '_blank', 'width=400,height=600');
                
                if (!receiptWindow) {
                    alert('⚠️ Popup blocker chekni blokladi! Brauzer sozlamalarida popup\'larga ruxsat bering.');
                    console.error('❌ window.open() null qaytardi - popup blocker faol');
                } else {
                    generatePrintableReceiptToWindow(receiptWindow, pendingReceiptData.sale, pendingReceiptData.currency);
                }
            }
            
            // Tab strategiyasi: 1 ta tab bo'lsa yangilash, ko'p bo'lsa yopish
            if (salesTabs.length === 1) {
                // Faqat 1 ta tab ochiq - to'liq yangilash
                console.log('🔄 Yagona tab - ma\'lumotlarni tozalash');
                
                // Global o'zgaruvchilarni tozalash
                cart = [];
                currentProduct = null;
                selectedLocationId = null;
                selectedLocationType = null;
                editingSaleId = null;
                currentPendingSaleId = null;
                
                // Tab state'ni tozalash
                const tabState = getTabState();
                if (tabState) {
                    tabState.cart = [];
                    tabState.currentProduct = null;
                    tabState.selectedLocationId = null;
                    tabState.selectedLocationType = null;
                    tabState.editingSaleId = null;
                    tabState.currentPendingSaleId = null;
                }
                
                // UI elementlarni tozalash
                const locationSelect = getActiveTabElement('locationSelect');
                const customerSearch = getActiveTabElement('customerSearch');
                const selectedCustomerId = getActiveTabElement('selectedCustomerId');
                const cartCustomerInfo = getActiveTabElement('cartCustomerInfo');
                const productsTable = getActiveTabElement('productsTable');
                
                if (locationSelect) locationSelect.value = '';
                if (customerSearch) customerSearch.value = '';
                if (selectedCustomerId) selectedCustomerId.value = '';
                if (cartCustomerInfo) cartCustomerInfo.innerHTML = '<h3 style="margin: 0; color: #333;">🛒 Savdo Korzinasi</h3>';
                if (productsTable) productsTable.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">Joylashuvni tanlang</td></tr>';
                
                // Tab sarlavhasini tozalash
                const activeTab = document.querySelector('.sales-tab.active');
                if (activeTab) {
                    const tabTitle = activeTab.querySelector('.tab-title');
                    if (tabTitle) {
                        const tabId = activeTab.dataset.tabId;
                        tabTitle.textContent = `Savdo ${tabId}`;
                        tabTitle.title = `Savdo ${tabId}`;
                    }
                }
                
                // Savatni yangilash
                updateCart();
                
                console.log('✅ Tab to\'liq tozalandi');
                
            } else {
                // Ko'p tab ochiq - hozirgi tabni yopish
                console.log('❌ Ko\'p tab - hozirgi tabni yopish');
                
                // Aktiv tabni yopish (tasdiqlashsiz)
                if (activeTabId) {
                    closeSaleTab(activeTabId, true); // skipConfirmation = true
                }
            }
            
        } catch (error) {
            console.error('❌ Savdoni yuborishda xatolik:', error);
            alert('Savdoni saqlashda xatolik yuz berdi!');
            // Tugmani qayta faollashtirish xatolik bo'lganda
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.textContent = originalText;
                confirmBtn.style.opacity = '1';
                confirmBtn.style.cursor = 'pointer';
            }
        } finally {
            // Flag'ni darhol tozalash
            isProcessingPayment = false;
            console.log('✅ Payment processing flag cleared');
        }
    }
    
    // ============================================
    // TAB SYSTEM INITIALIZATION
    // ============================================
    
    // Sahifa to'liq yuklanganda tab sistemani ishga tushirish
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🎯 DOM yuklandi, tab sistemani ishga tushirish...');
        initializeTabs();
    });
    
    // Sahifa yopilganda yoki refresh qilinganda ma'lumotlarni saqlash
    window.addEventListener('beforeunload', function() {
        if (activeTabId) {
            saveTabData(activeTabId);
        }
    });
    
    // Chek chiqarish funksiyasi
    function generatePrintableReceiptToWindow(receiptWindow, sale, currency = 'uzs') {
        // Global exchangeRate o'zgaruvchisidan foydalanish
        
        const receiptHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Savdo Cheki #${sale.id}</title>
                <meta charset="utf-8">
                <style>
                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                    }
                    
                    body {
                        font-family: 'Courier New', monospace;
                        font-size: 12px;
                        line-height: 1.3;
                        width: 80mm;
                        margin: 0 auto;
                        padding: 5mm;
                        background: white;
                    }
                    
                    .header {
                        text-align: center;
                        border-bottom: 1px dashed #000;
                        padding-bottom: 5mm;
                        margin-bottom: 3mm;
                    }
                    
                    .shop-name {
                        font-size: 16px;
                        font-weight: bold;
                        margin-bottom: 2mm;
                    }
                    
                    .receipt-info {
                        margin-bottom: 3mm;
                        font-size: 10px;
                    }
                    
                    @page {
                        size: 80mm auto;
                        margin: 0;
                    }
                    
                    @media print {
                        body {
                            width: 80mm;
                            font-size: 10px;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="shop-name">${sale.store_name || 'Do\'kon'}</div>
                    <div class="receipt-info">
                        <div>Chek #${sale.id}</div>
                        <div>${new Date(sale.sale_date).toLocaleString('uz-UZ', { timeZone: 'Asia/Tashkent' })}</div>
                        <div><strong>Sotuvchi:</strong> ${sale.seller_name || 'Sotuvchi'}</div>
                        ${sale.seller_phone ? '<div>' + sale.seller_phone + '</div>' : ''}
                        <div style="margin-top: 2mm; border-top: 1px dashed #ccc; padding-top: 2mm;">
                            <div><strong>Mijoz:</strong> ${sale.customer_name || 'Naqd mijoz'}</div>
                            ${sale.customer_phone ? '<div>' + sale.customer_phone + '</div>' : ''}
                        </div>
                    </div>
                </div>
                
                <div class="items">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px; border: 1.5px solid #000;">
                        <thead>
                            <tr style="border-bottom: 1.5px solid #000;">
                                <th style="text-align: left; padding: 2mm 2mm; font-weight: bold; border-right: 1.5px solid #000;">Mahsulot</th>
                                <th style="text-align: center; padding: 2mm 2mm; font-weight: bold; border-right: 1.5px solid #000;">Miqdor</th>
                                <th style="text-align: right; padding: 2mm 2mm; font-weight: bold;">Narx</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sale.items.map(item => {
                                const priceUSD = parseFloat(item.unit_price);
                                const priceUZS = Math.round(priceUSD * exchangeRate);
                                
                                let priceDisplay;
                                if (currency === 'both') {
                                    priceDisplay = '$' + priceUSD.toFixed(2) + '<br><span style="font-size: 10px; color: #666;">' + priceUZS.toLocaleString('uz-UZ') + ' som</span>';
                                } else if (currency === 'uzs') {
                                    priceDisplay = priceUZS.toLocaleString('uz-UZ') + ' som';
                                } else {
                                    priceDisplay = '$' + priceUSD.toFixed(2);
                                }
                                
                                return `
                                <tr style="border-bottom: 1.5px solid #000;">
                                    <td style="padding: 2mm 2mm; word-wrap: break-word; max-width: 25mm; border-right: 1.5px solid #000; font-weight: bold;">${item.product_name}</td>
                                    <td style="padding: 2mm 2mm; text-align: center; border-right: 1.5px solid #000; font-weight: bold;">${item.quantity}</td>
                                    <td style="padding: 2mm 2mm; text-align: right; font-weight: bold;">${priceDisplay}</td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="totals" style="margin-top: 3mm;">
                    <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; border-top: 1px solid #000; padding-top: 2mm;">
                        <span>Jami summa:</span>
                        <span>${(() => {
                            if (currency === 'both') {
                                return '$' + parseFloat(sale.total_amount).toFixed(2) + '<br><span style="font-size: 12px; color: #666;">' + Math.round(parseFloat(sale.total_amount) * exchangeRate).toLocaleString('uz-UZ') + ' som</span>';
                            } else if (currency === 'uzs') {
                                return Math.round(parseFloat(sale.total_amount) * exchangeRate).toLocaleString('uz-UZ') + ' som';
                            } else {
                                return '$' + parseFloat(sale.total_amount).toFixed(2);
                            }
                        })()}</span>
                    </div>
                </div>
                
                ${sale.payment_details ? '<div style="margin-top: 3mm; padding: 2mm; background: #f8f9fa; border-radius: 2mm;"><strong style="font-size: 14px;">To\'lov:</strong><br><div style="margin-top: 2mm; font-size: 14px; font-weight: bold;">' + sale.payment_details.replace(/ \/ /g, '<br>') + '</div></div>' : ''}
                </div>
                
                <div class="footer" style="text-align: center; padding-top: 3mm; font-size: 10px;">
                    <div>Rahmat!</div>
                    <div>Yana tashrif buyuring!</div>
                </div>
            </body>
            </html>
        `;
        
        receiptWindow.document.write(receiptHTML);
        receiptWindow.document.close();
        
        // Window'ga focus qilish va avtomatik print
        setTimeout(() => {
            receiptWindow.focus();
            // Avtomatik chop etish
            receiptWindow.print();
        }, 500);
    }
    
</script>
{% endblock %}

