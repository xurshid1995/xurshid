{% extends "base_with_sidebar.html" %}

{% block title %}{{ customer.name }} - Mijoz ma'lumotlari{% endblock %}

{% block extra_css %}
<style>
    .customer-detail-container {
        padding: 20px;
    }

    .customer-info-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 15px;
        overflow: hidden;
    }

    .customer-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.5rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
        flex-wrap: wrap;
    }

    .customer-header h1 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 700;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .customer-quick-info {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        opacity: 0.9;
        align-items: center;
    }

    .quick-info-item {
        font-size: 0.7rem;
        background: rgba(255, 255, 255, 0.15);
        padding: 1px 4px;
        border-radius: 6px;
        white-space: nowrap;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .back-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .back-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
        text-decoration: none;
        color: white;
    }



    /* Savdo tarixi jadvali */
    .orders-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .orders-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.4rem 1rem;
    }

    .orders-header h2 {
        margin: 0;
        font-size: 1rem;
        font-weight: 700;
    }

    /* Qidiruv va Filtr seksiyasi */
    .search-filter-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-top: 0;
        margin-bottom: 15px;
        overflow: hidden;
    }

    /* Qidiruv va Filtr paneli */
    .search-filter-panel {
        background: #f8f9fa;
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
    }

    .search-filter-row {
        display: flex;
        gap: 1rem;
        align-items: end;
        flex-wrap: wrap;
    }

    .search-input-container {
        position: relative;
        flex: 1;
        min-width: 200px;
        max-width: 450px;
    }

    .search-icon {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        z-index: 2;
    }

    .search-input {
        width: 100%;
        padding: 8px 35px 8px 35px;
        border: 1px solid #ddd;
        border-radius: 25px;
        font-size: 0.9rem;
    }

    .clear-search-btn {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        padding: 2px;
        z-index: 2;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .filter-group label {
        font-size: 0.85rem;
        font-weight: 500;
        color: #495057;
    }

    .filter-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 25px;
        font-size: 0.9rem;
        min-width: 130px;
        transition: border-color 0.3s ease;
    }

    .filter-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    }

    .results-info {
        background: #e9ecef;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        color: #495057;
        border-bottom: 1px solid #dee2e6;
    }

    /* Jadval responsive qilish */
    .table-responsive {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .table-container {
        min-width: 100%;
    }

    /* Mahsulot ustunini qisqartirish */
    .sales-table th:nth-child(4), .sales-table td:nth-child(4) { 
        width: 390px !important; 
        max-width: 390px !important; 
        font-size: 14px !important;
        font-weight: 500 !important;
    }

    /* Barcha jadval qatorlariga bir xil balandlik */
    .sales-table tbody tr {
        vertical-align: middle;
        height: 60px; /* Minimal balandlik */
    }

    .sales-table tbody td {
        vertical-align: middle;
        padding: 12px 8px;
        line-height: 1.5;
    }

    /* Group sale birinchi va qolgan qatorlar uchun bir xil style */
    .sale-group-start td,
    .sale-group-item td {
        padding: 12px 8px !important;
        vertical-align: middle !important;
    }

    /* Rowspan ustunlari uchun maxsus style */
    .group-cell {
        vertical-align: middle !important;
        padding: 12px 8px !important;
    }

    /* Amallar tugmalarini vertikal qilish */
    .group-actions {
        display: flex;
        flex-direction: column;
        gap: 2px;
        align-items: center;
        justify-content: center;
        padding: 4px;
        vertical-align: middle;
    }

    /* Loading va xabarlar */
    .loading-message, .no-data-message {
        text-align: center;
        padding: 40px 20px;
        color: #666;
        font-style: italic;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(3px);
    }

    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 12px 12px 0 0;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
    }

    .modal-body {
        padding: 30px;
    }

    .modal-footer {
        padding: 20px 30px;
        border-top: 1px solid #dee2e6;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .modal-close-btn, .modal-print-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .modal-close-btn {
        background: #6c757d;
        color: white;
    }

    .modal-close-btn:hover {
        background: #5a6268;
    }

    .modal-print-btn {
        background: #28a745;
        color: white;
    }

    .modal-print-btn:hover {
        background: #218838;
    }

    /* Statistika */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 8px;
        padding: 0.5rem 1rem 0.1rem 1rem;
        margin-bottom: 0;
    }

    .stat-card {
        background: #007bff;
        color: white;
        padding: 1rem;
        border-radius: 8px;
        border: none;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        position: relative;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .stat-card:nth-child(2) {
        background: #dc3545;
        box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
    }
    
    .stat-card:nth-child(3) {
        background: #28a745;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    .stat-value {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 0.4rem;
        color: white;
    }

    .stat-label {
        font-size: 1.1rem;
        color: white;
        opacity: 0.9;
        font-weight: 500;
    }

    .stat-icon {
        font-size: 2rem;
        color: white;
        opacity: 0.9;
        flex-shrink: 0;
    }

    .stat-content {
        display: flex;
        flex-direction: column;
        text-align: left;
    }
</style>
{% endblock %}

{% block content %}
<div class="customer-detail-container" data-user-role="{{ session.role }}">
    <!-- Mijoz ma'lumotlari kartasi -->
    <div class="customer-info-card">
        <div class="customer-header">
            <div class="header-left">
                <h1>üë§ {{ customer.name }}</h1>
                <div class="customer-quick-info">
                    <span class="quick-info-item">üìû {{ customer.phone or "Kiritilmagan" }}</span>
                    <span class="quick-info-item">üìß {{ customer.email or "Kiritilmagan" }}</span>
                    <span class="quick-info-item">üìç {{ customer.address or "Kiritilmagan" }}</span>
                </div>
            </div>
            <a href="/customers" class="back-btn">‚Üê Orqaga</a>
        </div>



        <!-- Statistika -->
        <div class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-shopping-cart stat-icon"></i>
                <div class="stat-content">
                    <div class="stat-value" id="totalOrders">-</div>
                    <div class="stat-label">Jami savdolar</div>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-dollar-sign stat-icon"></i>
                <div class="stat-content">
                    <div class="stat-value" id="totalAmount">-</div>
                    <div class="stat-label">Jami summa</div>
                </div>
            </div>
            {% if session.role in ['admin', 'manager'] %}
            <div class="stat-card">
                <i class="fas fa-chart-pie stat-icon"></i>
                <div class="stat-content">
                    <div class="stat-value" id="totalProfit">-</div>
                    <div class="stat-label">Jami foyda</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Qidiruv va Filtr paneli -->
    <div class="search-filter-section">
        <div class="search-filter-panel">
            <div class="search-filter-row">
                <div class="search-input-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="customerSearchInput" placeholder="Qidirish..." class="search-input">
                    <button id="customerClearSearch" class="clear-search-btn" style="display: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="filter-group">
                    <label for="customerDateFromFilter">Sana (dan):</label>
                    <input type="date" id="customerDateFromFilter" class="filter-input">
                </div>
                
                <div class="filter-group">
                    <label for="customerDateToFilter">Sana (gacha):</label>
                    <input type="date" id="customerDateToFilter" class="filter-input">
                </div>
            </div>
        </div>

        <!-- Natijalar matn -->
        <div id="customerResultsInfo" class="results-info" style="display: none;">
            <span id="customerResultsText"></span>
        </div>
    </div>

    <!-- Savdo tarixi -->
    <div class="sales-section">
        <div class="sales-header">
            <h2>üìã Savdo tarixi</h2>
        </div>

        <div id="loadingSales" class="loading-message">
            ‚è≥ Yuklanmoqda...
        </div>

        <div id="noSalesMessage" style="display: none;" class="no-data-message">
            üì≠ Hozircha savdolar mavjud emas
        </div>

        <div class="table-responsive">
            <div class="table-container">
                <table class="sales-table">
                    <thead>
                        <tr>
                            <th>Sana va vaqt</th>
                            <th>Sotuvchi</th>
                            <th>Joylashuv</th>
                            <th>Mahsulot</th>
                            <th class="compact-hide">Miqdor</th>
                            <th class="compact-hide">Narx</th>
                            <th class="compact-hide">Yig'indi</th>
                            <th>Jami yig'indi</th>
                            {% if session.role in ['admin', 'manager'] %}
                            <th>Jami foyda</th>
                            {% endif %}
                            <th>Amal</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody">
                        <tr>
                            <td colspan="10" style="text-align: center; padding: 20px;">
                                <div class="loading-state">Yuklanmoqda...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <div id="paginationContainer" class="pagination-container" style="display: none;">
            <!-- JavaScript orqali to'ldiriladi -->
        </div>
    </div>
</div>

<!-- Savdo tafsilotlari modali -->
<div id="saleDetailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üõçÔ∏è Savdo tafsilotlari</h3>
        </div>
        <div class="modal-body" id="saleDetailsContent">
            <!-- JavaScript orqali to'ldiriladi -->
        </div>
        <div class="modal-footer">
            <button class="modal-print-btn" onclick="printSaleReceipt()" title="Mini X90 printerda chop etish">
                üñ®Ô∏è Chop etish
            </button>
            <button class="modal-close-btn" onclick="closeSaleModal()">Yopish</button>
        </div>
    </div>
</div>

<script>
// Global o'zgaruvchilar
let userRole = '';

// SaleItem dan joylashuv nomini olish funksiyasi
function getLocationName(item) {
    return item.location_name || 'Noma\'lum joylashuv';
}

document.addEventListener('DOMContentLoaded', function() {
    const customerId = {{ customer.id }};
    userRole = document.querySelector('.customer-detail-container').dataset.userRole;
    loadCustomerOrders(customerId);
    
    // Modal event listenerlari
    document.getElementById('saleDetailsModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeSaleModal();
        }
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeSaleModal();
        }
    });
});

function loadCustomerOrders(customerId) {
    console.log('Mijoz savdolarini yuklash: Customer ID =', customerId);
    
    if (!customerId || isNaN(customerId)) {
        console.error('Invalid customer ID:', customerId);
        document.getElementById('loadingSales').innerHTML = 'Noto\'g\'ri mijoz ID';
        displayEmptyTable();
        return;
    }
    
    fetch('/api/customer/' + customerId + '/orders')
        .then(response => {
            console.log('API javobi: Status =', response.status);
            if (!response.ok) {
                throw new Error('HTTP error! status: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('API ma\'lumotlari:', data);
            document.getElementById('loadingSales').style.display = 'none';
            
            if (data.success && data.orders && data.orders.length > 0) {
                displayOrders(data.orders);
                updateStats(data.orders);
                document.getElementById('noSalesMessage').style.display = 'none';
            } else {
                displayEmptyTable();
                updateStats([]);
                document.getElementById('noSalesMessage').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading orders:', error);
            document.getElementById('loadingSales').innerHTML = 'Savdo tarixini yuklashda xatolik: ' + error.message;
            displayEmptyTable();
            updateStats([]);
            document.getElementById('noSalesMessage').style.display = 'block';
        });
}

function displayEmptyTable() {
    const tbody = document.getElementById('salesTableBody');
    const colspan = (userRole === 'admin' || userRole === 'manager') ? 10 : 9;
    tbody.innerHTML = '<tr><td colspan="' + colspan + '" class="no-data-message">Hozircha savdolar mavjud emas</td></tr>';
}

function displayOrders(orders) {
    // Global arrayni yangilash
    allCustomerOrders = [];
    orders.forEach(sale => {
        const items = sale.items || [];
        items.forEach(item => {
            allCustomerOrders.push({
                ...item,
                created_at: sale.sale_date,
                location_name: sale.location_name || 'N/A'
            });
        });
    });
    
    const tbody = document.getElementById('salesTableBody');
    let html = '';
    
    orders.forEach(sale => {
        const items = sale.items || [];
        
        // Agar items bo'sh bo'lsa, default item yaratamiz
        if (items.length === 0) {
            items.push({
                product_name: 'Items mavjud emas',
                quantity: '-',
                unit_price: 0,
                total_price: sale.total_amount || 0,
                location_name: 'Noma\'lum'
            });
        }
        
        const totalAmount = parseFloat(sale.total_amount) || 0;
        const totalProfit = parseFloat(sale.total_profit) || 0;
        const profitClass = totalProfit > 0 ? 'profit-positive' : totalProfit < 0 ? 'profit-negative' : '';
        
        // Sana va vaqtni formatlash
        const saleDate = new Date(sale.sale_date);
        const formattedDate = saleDate.toLocaleDateString('uz-UZ', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
        const formattedTime = saleDate.toLocaleTimeString('uz-UZ', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Birinchi item (grupning boshlanishi)
        const firstItem = items[0];
        const isOnlyItem = items.length === 1;
        
        let firstRowClasses = ['sale-group-start'];
        if (isOnlyItem) firstRowClasses.push('sale-group-end');
        
        html += '<tr class="' + firstRowClasses.join(' ') + '">';
        html += '<td rowspan="' + items.length + '" class="group-cell group-datetime">';
        html += '<div class="datetime-info">';
        html += '<div class="sale-date">' + formattedDate + '</div>';
        html += '<div class="sale-time">' + formattedTime + '</div>';
        html += '</div></td>';
        
        html += '<td rowspan="' + items.length + '" class="group-cell group-seller">';
        html += '<div style="font-size: 14px; font-weight: 600; color: #495057;">' + (sale.seller_name || 'Admin') + '</div>';
        if (sale.seller_phone) {
            html += '<div style="font-size: 12px; color: #6c757d; font-style: italic;">' + sale.seller_phone + '</div>';
        }
        html += '</td>';
        
        html += '<td class="group-cell group-location">' + getLocationName(firstItem) + '</td>';
        html += '<td class="product-cell">' + (firstItem.product_name || 'Noma\'lum') + '</td>';
        html += '<td style="text-align: center; font-weight: 600;">' + firstItem.quantity + '</td>';
        html += '<td>';
        html += '<div style="font-weight: 600; text-align: center;">$' + parseFloat(firstItem.unit_price || 0).toFixed(2) + '</div>';
        if (sale.currency_rate) {
            html += '<div style="margin-top: 3px; text-align: center;"><span style="background-color: #5cb3fd; color: white; font-size: 11px; padding: 2px 6px; border-radius: 0; font-weight: 500;">' + (parseFloat(firstItem.unit_price || 0) * sale.currency_rate).toLocaleString('en-US', {maximumFractionDigits: 0}) + '</span></div>';
        }
        html += '</td>';
        html += '<td>';
        html += '<div style="font-weight: 600; text-align: center;">$' + parseFloat(firstItem.total_price || 0).toFixed(2) + '</div>';
        if (sale.currency_rate) {
            html += '<div style="margin-top: 3px; text-align: center;"><span style="background-color: #5cb3fd; color: white; font-size: 11px; padding: 2px 6px; border-radius: 0; font-weight: 500;">' + (parseFloat(firstItem.total_price || 0) * sale.currency_rate).toLocaleString('en-US', {maximumFractionDigits: 0}) + '</span></div>';
        }
        html += '</td>';
        
        html += '<td rowspan="' + items.length + '" class="group-cell group-total">';
        html += '<div style="font-weight: 600; text-align: center;">$' + totalAmount.toFixed(2) + '</div>';
        if (sale.currency_rate) {
            html += '<div style="margin-top: 3px; text-align: center;"><span style="background-color: #5cb3fd; color: white; font-size: 11px; padding: 2px 6px; border-radius: 0; font-weight: 500;">' + (totalAmount * sale.currency_rate).toLocaleString('en-US', {maximumFractionDigits: 0}) + '</span></div>';
        }
        html += '</td>';
        
        if (userRole === 'admin' || userRole === 'manager') {
            html += '<td rowspan="' + items.length + '" class="group-cell group-profit ' + profitClass + '">';
            html += '<div style="font-weight: 600; text-align: center;">$' + totalProfit.toFixed(2) + '</div>';
            if (sale.currency_rate) {
                html += '<div style="margin-top: 3px; text-align: center;"><span style="background-color: #5cb3fd; color: white; font-size: 11px; padding: 2px 6px; border-radius: 0; font-weight: 500;">' + (totalProfit * sale.currency_rate).toLocaleString('en-US', {maximumFractionDigits: 0}) + '</span></div>';
            }
            html += '</td>';
        }
        
        html += '<td rowspan="' + items.length + '" class="group-cell group-actions">';
        html += '<button class="btn-action btn-view" onclick="viewSaleDetails(' + sale.id + ')" title="Ko\'rish" style="background-color: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 18px;">';
        html += 'üëÅÔ∏è';
        html += '</button>';
        html += '<button class="btn-action btn-edit" onclick="editSaleGroup(' + sale.id + ')" title="Tahrirlash" style="background-color: #ffc107; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 18px;">';
        html += '‚úèÔ∏è';
        html += '</button>';
        html += '<button class="btn-action btn-delete" onclick="deleteSale(' + sale.id + ')" title="O\'chirish" style="background-color: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 18px;">';
        html += 'üóëÔ∏è';
        html += '</button>';
        html += '</td>';
        html += '</tr>';
        
        // Qolgan itemlar
        for (let i = 1; i < items.length; i++) {
            const item = items[i];
            const isLast = i === items.length - 1;
            
            let rowClasses = ['sale-group-item'];
            if (isLast) rowClasses.push('sale-group-end');
            
            html += '<tr class="' + rowClasses.join(' ') + '">';
            html += '<td class="group-cell group-location">' + getLocationName(item) + '</td>';
            html += '<td class="product-cell">' + (item.product_name || 'Noma\'lum') + '</td>';
            html += '<td style="text-align: center; font-weight: 600;">' + item.quantity + '</td>';
            html += '<td>';
            html += '<div style="font-weight: 600; text-align: center;">$' + parseFloat(item.unit_price || 0).toFixed(2) + '</div>';
            if (sale.currency_rate) {
                html += '<div style="margin-top: 3px; text-align: center;"><span style="background-color: #5cb3fd; color: white; font-size: 11px; padding: 2px 6px; border-radius: 0; font-weight: 500;">' + (parseFloat(item.unit_price || 0) * sale.currency_rate).toLocaleString('en-US', {maximumFractionDigits: 0}) + '</span></div>';
            }
            html += '</td>';
            html += '<td>';
            html += '<div style="font-weight: 600; text-align: center;">$' + parseFloat(item.total_price || 0).toFixed(2) + '</div>';
            if (sale.currency_rate) {
                html += '<div style="margin-top: 3px; text-align: center;"><span style="background-color: #5cb3fd; color: white; font-size: 11px; padding: 2px 6px; border-radius: 0; font-weight: 500;">' + (parseFloat(item.total_price || 0) * sale.currency_rate).toLocaleString('en-US', {maximumFractionDigits: 0}) + '</span></div>';
            }
            html += '</td>';
            html += '</tr>';
        }
    });
    
    tbody.innerHTML = html;
}

// Modal functions
function viewSaleDetails(saleId) {
    console.log('viewSaleDetails called with ID:', saleId);
    
    fetch('/api/sales/' + saleId)
        .then(response => {
            if (!response.ok) {
                throw new Error('HTTP error! status: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('Sale details received:', data);
            if (data) {
                showSaleDetailsModal(data);
            } else {
                alert('Savdo ma\'lumotlari topilmadi');
            }
        })
        .catch(error => {
            console.error('Error fetching sale details:', error);
            alert('Savdo ma\'lumotlarini yuklashda xatolik: ' + error.message);
        });
}

function showSaleDetailsModal(sale) {
    const modal = document.getElementById('saleDetailsModal');
    const content = document.getElementById('saleDetailsContent');
    
    const saleDate = new Date(sale.sale_date);
    const formattedDate = saleDate.toLocaleString('uz-UZ', { timeZone: 'Asia/Tashkent' });
    
    let itemsHtml = '';
    if (sale.items && sale.items.length > 0) {
        const exchangeRate = 12700;
        itemsHtml = sale.items.map(item => {
            const unitPriceUSD = parseFloat(item.unit_price || 0);
            const totalPriceUSD = parseFloat(item.total_price || 0);
            const unitPriceUZS = Math.round(unitPriceUSD * exchangeRate);
            const totalPriceUZS = Math.round(totalPriceUSD * exchangeRate);
            
            return '<tr>' +
            '<td>' + (item.product_name || 'Noma\'lum') + '</td>' +
            '<td style="text-align: center;">' + (item.quantity || 0) + '</td>' +
            '<td style="text-align: right;">' +
            '<div>$' + unitPriceUSD.toFixed(2) + '</div>' +
            '<div style="font-size: 11px; color: #666;">' + unitPriceUZS.toLocaleString('uz-UZ') + ' so\'m</div>' +
            '</td>' +
            '<td style="text-align: right; font-weight: bold;">' +
            '<div>$' + totalPriceUSD.toFixed(2) + '</div>' +
            '<div style="font-size: 11px; color: #666;">' + totalPriceUZS.toLocaleString('uz-UZ') + ' so\'m</div>' +
            '</td>' +
            '</tr>'
        }).join('');
    } else {
        itemsHtml = '<tr><td colspan="4" style="text-align: center; color: #666;">Mahsulotlar topilmadi</td></tr>';
    }
    
    content.innerHTML = 
        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">' +
        '<div>' +
        '<strong>üìÖ Sana:</strong> ' + formattedDate + '<br>' +
        '<strong>üë§ Mijoz:</strong> ' + (sale.customer_name || 'Noma\'lum') + '<br>' +
        '<strong>üìû Telefon:</strong> ' + (sale.customer_phone || 'Kiritilmagan') +
        '</div>' +
        '<div>' +
        '<strong>üè™ Joylashuv:</strong> ' + (sale.store_name || sale.warehouse_name || 'Noma\'lum') + '<br>' +
        '<strong>üí≥ To\'lov:</strong> ' + (sale.payment_method === 'cash' ? 'Naqd' : 'Karta') + '<br>' +
        '<strong>üìã Holat:</strong> ' + (sale.payment_status === 'paid' ? 'To\'langan' : 'To\'lanmagan') +
        '</div>' +
        '</div>' +
        
        '<table style="width: 100%; border-collapse: collapse; margin: 20px 0;">' +
        '<thead>' +
        '<tr style="background: #f8f9fa;">' +
        '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Mahsulot</th>' +
        '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">Miqdor</th>' +
        '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: right;">Narx</th>' +
        '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: right;">Jami</th>' +
        '</tr>' +
        '</thead>' +
        '<tbody>' +
        itemsHtml +
        '</tbody>' +
        '</table>' +
        
        '<div style="display: grid; grid-template-columns: ' + (userRole === 'admin' || userRole === 'manager' ? '1fr 1fr 1fr' : '1fr 1fr') + '; gap: 15px; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">' +
        '<div style="text-align: center;">' +
        '<div style="font-size: 1.2rem; font-weight: bold; color: #28a745;">$' + parseFloat(sale.total_amount || 0).toFixed(2) + '</div>' +
        '<div style="font-size: 0.9rem; color: #666;">Jami summa</div>' +
        '</div>' +
        '<div style="text-align: center;">' +
        '<div style="font-size: 1.2rem; font-weight: bold; color: #dc3545;">$' + parseFloat(sale.total_cost || 0).toFixed(2) + '</div>' +
        '<div style="font-size: 0.9rem; color: #666;">Tan narx</div>' +
        '</div>' +
        (userRole === 'admin' || userRole === 'manager' ? 
        '<div style="text-align: center;">' +
        '<div style="font-size: 1.2rem; font-weight: bold; color: ' + (parseFloat(sale.total_profit || 0) >= 0 ? '#28a745' : '#dc3545') + ';">$' + parseFloat(sale.total_profit || 0).toFixed(2) + '</div>' +
        '<div style="font-size: 0.9rem; color: #666;">Foyda</div>' +
        '</div>' : '') +
        '</div>' +
        
        (sale.notes ? '<div style="margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 6px;"><strong>Izoh:</strong> ' + sale.notes + '</div>' : '');
    
    // Global o'zgaruvchiga saqlash (chop etish uchun)
    window.currentSaleForPrint = sale;
    
    modal.style.display = 'block';
}

function closeSaleModal() {
    const modal = document.getElementById('saleDetailsModal');
    modal.style.display = 'none';
    window.currentSaleForPrint = null;
}

function printSaleReceipt() {
    if (!window.currentSaleForPrint) {
        alert('Chop etish uchun savdo ma\'lumotlari topilmadi');
        return;
    }
    
    const sale = window.currentSaleForPrint;
    
    // Mini X90 (58mm) printer uchun format
    let receiptText = '\n';
    receiptText += '================================\n';
    receiptText += '         SAVDO CHEKI\n';
    receiptText += '================================\n';
    receiptText += 'Sana: ' + new Date(sale.sale_date).toLocaleString('uz-UZ', { timeZone: 'Asia/Tashkent' }) + '\n';
    receiptText += 'Mijoz: ' + (sale.customer_name || 'Noma\'lum') + '\n';
    if (sale.customer_phone) {
        receiptText += 'Tel: ' + sale.customer_phone + '\n';
    }
    receiptText += '--------------------------------\n';
    
    if (sale.items && sale.items.length > 0) {
        sale.items.forEach(item => {
            receiptText += (item.product_name || 'Mahsulot').substring(0, 20) + '\n';
            receiptText += item.quantity + ' x $' + parseFloat(item.unit_price || 0).toFixed(2) + 
                          ' = $' + parseFloat(item.total_price || 0).toFixed(2) + '\n';
        });
    }
    
    receiptText += '--------------------------------\n';
    receiptText += 'JAMI: $' + parseFloat(sale.total_amount || 0).toFixed(2) + '\n';
    receiptText += 'To\'lov: ' + (sale.payment_method === 'cash' ? 'Naqd' : 'Karta') + '\n';
    receiptText += '================================\n';
    receiptText += '      Rahmat! Yana keling!\n';
    receiptText += '================================\n\n';
    
    // Demo: Console'ga chiqarish
    console.log('Mini X90 Printer Format:');
    console.log(receiptText);
    
    // Brauzer print dialogini ochish
    const printWindow = window.open('', '_blank');
    printWindow.document.write('<pre style="font-family: monospace; font-size: 12px; line-height: 1.2;">' + receiptText + '</pre>');
    printWindow.document.close();
    printWindow.print();
}

function editSaleGroup(saleId) {
    window.location.href = '/sales?edit_group=' + saleId;
}

function deleteSale(saleId) {
    if (confirm('Ushbu savdoni o\'chirishni xohlaysizmi? Bu amal bekor qilinmaydi.')) {
        fetch('/api/sales/' + saleId, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                alert('Savdo muvaffaqiyatli o\'chirildi');
                location.reload();
            } else {
                alert('Savdoni o\'chirishda xatolik');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Savdoni o\'chirishda xatolik: ' + error.message);
        });
    }
}

function updateStats(orders) {
    const totalOrders = orders.length;
    const totalAmount = orders.reduce((sum, order) => sum + parseFloat(order.total_amount || 0), 0);
    
    document.getElementById('totalOrders').textContent = totalOrders;
    document.getElementById('totalAmount').textContent = totalAmount > 0 ? '$' + totalAmount.toLocaleString('uz-UZ') : '$0';
    
    // Foyda faqat admin va manager uchun
    if (userRole === 'admin' || userRole === 'manager') {
        const totalProfit = orders.reduce((sum, order) => sum + parseFloat(order.total_profit || 0), 0);
        const profitElement = document.getElementById('totalProfit');
        if (profitElement) {
            profitElement.textContent = totalProfit > 0 ? '$' + totalProfit.toLocaleString('uz-UZ') : '$0';
        }
    }
}

// Qidiruv va filtr funksiyalari
let allCustomerOrders = [];

function filterCustomerOrders() {
    const searchTerm = document.getElementById('customerSearchInput').value.toLowerCase();
    const dateFrom = document.getElementById('customerDateFromFilter').value;
    const dateTo = document.getElementById('customerDateToFilter').value;
    
    let filteredOrders = allCustomerOrders.filter(order => {
        // Qidiruv filtri
        const matchesSearch = !searchTerm || 
            order.product_name.toLowerCase().includes(searchTerm) ||
            order.location_name.toLowerCase().includes(searchTerm) ||
            order.created_at.toLowerCase().includes(searchTerm);
        
        // Sana filtri
        const orderDate = new Date(order.created_at).toISOString().split('T')[0];
        const matchesDateFrom = !dateFrom || orderDate >= dateFrom;
        const matchesDateTo = !dateTo || orderDate <= dateTo;
        
        return matchesSearch && matchesDateFrom && matchesDateTo;
    });
    
    displayCustomerOrders(filteredOrders);
    updateCustomerResultsInfo(filteredOrders.length, allCustomerOrders.length);
}

function updateCustomerResultsInfo(filteredCount, totalCount) {
    const resultsInfo = document.getElementById('customerResultsInfo');
    const resultsText = document.getElementById('customerResultsText');
    
    if (filteredCount < totalCount || document.getElementById('customerSearchInput').value || 
        document.getElementById('customerDateFromFilter').value || document.getElementById('customerDateToFilter').value) {
        resultsText.textContent = `${filteredCount} ta natija topildi (jami ${totalCount} tadan)`;
        resultsInfo.style.display = 'block';
    } else {
        resultsInfo.style.display = 'none';
    }
}

function displayCustomerOrders(orders) {
    const tbody = document.querySelector('#ordersTable tbody');
    if (!tbody) return;
    
    if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="no-data">Hech qanday ma\'lumot topilmadi</td></tr>';
        return;
    }
    
    tbody.innerHTML = orders.map(order => `
        <tr>
            <td>${formatDateTime(order.created_at)}</td>
            <td>${order.location_name || 'N/A'}</td>
            <td>${order.product_name}</td>
            <td>${order.quantity}</td>
            <td class="price">$${parseFloat(order.price || 0).toFixed(2)}</td>
            <td class="price">$${parseFloat(order.total || 0).toFixed(2)}</td>
            <td class="price">$${parseFloat(order.total_cost || 0).toFixed(2)}</td>
            <td class="price profit">$${parseFloat(order.total_profit || 0).toFixed(2)}</td>
        </tr>
    `).join('');
}

// Event listenerlar
document.addEventListener('DOMContentLoaded', function() {
    // Qidiruv input
    const searchInput = document.getElementById('customerSearchInput');
    const clearSearchBtn = document.getElementById('customerClearSearch');
    
    if (searchInput && clearSearchBtn) {
        searchInput.addEventListener('input', function() {
            clearSearchBtn.style.display = this.value ? 'block' : 'none';
            filterCustomerOrders();
        });
        
        clearSearchBtn.addEventListener('click', function() {
            searchInput.value = '';
            this.style.display = 'none';
            filterCustomerOrders();
        });
    }
    
    // Sana filtrlari
    const dateFromFilter = document.getElementById('customerDateFromFilter');
    const dateToFilter = document.getElementById('customerDateToFilter');
    
    if (dateFromFilter) {
        dateFromFilter.addEventListener('change', filterCustomerOrders);
    }
    
    if (dateToFilter) {
        dateToFilter.addEventListener('change', filterCustomerOrders);
    }
});
</script>
{% endblock %}