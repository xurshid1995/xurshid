{% extends "base_with_sidebar.html" %}

{% block title %}Savdo Tarixi{% endblock %}

{% block extra_css %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<!-- üîç DEBUG: Session Role = {{ session.role }} -->
{% endblock %}

{% block content %}
<div class="sales-history-page">
    <div class="page-header">
        <h1><i class="fas fa-chart-line"></i> Savdo Tarixi</h1>
        <div class="header-controls">
            <label class="toggle-switch">
                <input type="checkbox" id="compactViewToggle">
                <span class="toggle-slider"></span>
                <span class="toggle-label">Ixcham ko'rinish</span>
            </label>
        </div>
    </div>

    <div class="sales-stats" id="salesStats">
        <div class="stat-card">
            <i class="fas fa-shopping-cart"></i>
            <div>
                <span class="stat-number" id="totalSales">0</span>
                <span class="stat-label">Jami savdolar</span>
            </div>
        </div>
        <div class="stat-card">
            <i class="fas fa-dollar-sign"></i>
            <div>
                <span class="stat-number" id="totalRevenue">$0</span>
                <span class="stat-label">Jami yig'indi</span>
            </div>
        </div>
        {% if session.role != 'sotuvchi' %}
        <div class="stat-card">
            <i class="fas fa-chart-pie"></i>
            <div>
                <span class="stat-number" id="totalProfit">$0</span>
                <span class="stat-label">Jami foyda</span>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Qidiruv va Filtr paneli -->
    <div class="search-filter-panel">
        <div class="search-filter-row">
            <div class="search-input-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" placeholder="Qidirish..." class="search-input">
                <button id="clearSearch" class="clear-search-btn" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="filter-group">
                <label for="dateFromFilter">Sana (dan):</label>
                <input type="date" id="dateFromFilter" class="filter-input" value="">
            </div>
            
            <div class="filter-group">
                <label for="dateToFilter">Sana (gacha):</label>
                <input type="date" id="dateToFilter" class="filter-input" value="">
            </div>
            
            <div class="filter-group">
                <label for="customerFilter">Mijoz:</label>
                <div class="customer-search-container">
                    <input type="text" id="customerFilter" class="filter-input customer-search-input" 
                           placeholder="Mijoz qidirish..." autocomplete="off">
                    <div id="customerDropdown" class="customer-dropdown" style="display: none;">
                        <div class="customer-option" data-value="">Barcha mijozlar</div>
                    </div>
                </div>
            </div>
            
            <div class="filter-group filter-group-location">
                <label for="locationFilter">Joylashuv:</label>
                <select id="locationFilter" class="filter-input">
                    <option value="">Barcha joylashuvlar</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Natijalar matn -->
    <div id="resultsInfo" class="results-info" style="display: none;">
        <span id="resultsText"></span>
    </div>

    <div class="table-responsive">
        <div class="table-container">
            <table class="sales-table">
                <thead>
                    <tr>
                        <th>Sana va vaqt</th>
                        <th>Mijoz</th>
                        <th>Sotuvchi</th>
                        <th>Joylashuv</th>
                        <th>Mahsulot</th>
                        <th>Miqdor</th>
                        <th>Narx</th>
                        <th>Yig'indi</th>
                        <th>Jami yig'indi</th>
                        <th>Jami foyda</th>
                        <th>Amal</th>
                    </tr>
                </thead>
                <tbody id="salesTableBody">
                    <tr>
                        <td colspan="11" class="loading">Ma'lumotlar yuklanmoqda...</td>
                    </tr>
                </tbody>
            </table>

            <!-- Pagination -->
            <div class="pagination" id="pagination" style="display: none;">
                <div id="paginationButtons">
                    <!-- Pagination tugmalari bu yerga yuklanadi -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Oddiy va toza CSS */
.sales-history-page {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin: 0;
    width: 100%;
    max-width: none;
    overflow-x: visible;
}

/* Jadval container yaxshilash */
.sales-history-page .table-responsive {
    width: 100% !important;
    max-width: none !important;
    overflow-x: auto !important;
    margin-bottom: 20px;
}

.sales-history-page .table-container {
    width: 100% !important;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow-x: auto;
    overflow-y: visible;
}

.sales-history-page .sales-table {
    width: 1385px !important;
    min-width: 1385px !important;
    max-width: 1385px !important;
    border-collapse: collapse;
    font-size: 14px;
    table-layout: fixed !important;
}

/* 1385PX JADVAL KENGLIGI */
.sales-history-page .sales-table th:nth-child(1), .sales-history-page .sales-table td:nth-child(1) { width: 100px !important; max-width: 100px !important; text-align: center; font-size: 14px !important; white-space: normal !important; word-wrap: break-word !important; line-height: 1.3 !important; overflow: hidden; text-overflow: ellipsis; }  /* Sana/Vaqt - 100PX */
.sales-history-page .sales-table th:nth-child(2), .sales-history-page .sales-table td:nth-child(2) { width: 150px !important; max-width: 150px !important; text-align: left; font-size: 14px !important; font-weight: 500; white-space: normal !important; word-wrap: break-word !important; line-height: 1.3 !important; overflow: hidden; text-overflow: ellipsis; }      /* Mijoz - 150PX */
.sales-history-page .sales-table th:nth-child(3), .sales-history-page .sales-table td:nth-child(3) { width: 100px !important; max-width: 100px !important; text-align: center; font-size: 14px !important; font-weight: 500; white-space: normal !important; word-wrap: break-word !important; line-height: 1.3 !important; overflow: hidden; text-overflow: ellipsis; }   /* Sotuvchi - 100PX */
.sales-history-page .sales-table th:nth-child(4), .sales-history-page .sales-table td:nth-child(4) { width: 110px !important; max-width: 110px !important; text-align: left; font-size: 14px !important; white-space: normal !important; word-wrap: break-word !important; line-height: 1.3 !important; overflow: hidden; text-overflow: ellipsis; }  /* Joylashuv - 110PX */
.sales-history-page .sales-table th:nth-child(5), .sales-history-page .sales-table td:nth-child(5) { width: 420px !important; max-width: 420px !important; text-align: left; font-size: 14px !important; font-weight: 500; white-space: normal !important; word-wrap: break-word !important; line-height: 1.3 !important; overflow: hidden; text-overflow: ellipsis; }    /* Mahsulot - 420PX */
.sales-history-page .sales-table th:nth-child(6), .sales-history-page .sales-table td:nth-child(6) { width: 60px !important; max-width: 60px !important; text-align: center; font-weight: 600; font-size: 14px !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; }   /* Miqdor - 60PX */
.sales-history-page .sales-table th:nth-child(7), .sales-history-page .sales-table td:nth-child(7) { width: 100px !important; max-width: 100px !important; text-align: right; font-weight: 600; font-size: 14px !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; }   /* Narx - 100PX */
.sales-history-page .sales-table th:nth-child(8), .sales-history-page .sales-table td:nth-child(8) { width: 100px !important; max-width: 100px !important; text-align: right; font-weight: 600; font-size: 14px !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; }   /* Yig'indi - 100PX */
.sales-history-page .sales-table th:nth-child(9), .sales-history-page .sales-table td:nth-child(9) { width: 100px !important; max-width: 100px !important; text-align: right; font-weight: 600; font-size: 14px !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; }  /* Jami Yig'indi - 100PX */
.sales-history-page .sales-table th:nth-child(10), .sales-history-page .sales-table td:nth-child(10) { width: 100px !important; max-width: 100px !important; text-align: right; font-weight: 600; color: #27ae60; font-size: 14px !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; }  /* Jami Foyda - 100PX */
.sales-history-page .sales-table th:nth-child(11), .sales-history-page .sales-table td:nth-child(11) { width: 45px !important; max-width: 45px !important; text-align: center; border-right: none; font-size: 14px !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; }  /* Amallar - 45PX */

.sales-history-page .sales-table td {
    padding: 8px 6px;
    border-bottom: 1px solid #e9ecef;
    font-size: 14px !important;
    line-height: 1.3;
    text-align: center;
    height: auto;
    min-height: 42px;
    vertical-align: middle;
    white-space: normal !important;
    word-wrap: break-word !important;
}

.sales-history-page .sales-table th {
    background: #007bff;
    color: white !important;
    padding: 8px 6px;
    text-align: center;
    font-weight: 600;
    font-size: 14px !important;
    height: 45px;
    vertical-align: middle;
    line-height: 1.4;
}

.sales-history-page .sales-table tr:hover {
    background: #f8f9fa;
}

/* Amallar tugmalarini vertikal joylashtirish */
.sales-history-page .sales-table .col-actions .btn-action {
    display: block;
    margin: 1px auto;
    width: 20px;
    height: 18px;
    padding: 2px;
    font-size: 8px;
}

.sales-history-page .sales-table .col-actions .btn-action i {
    font-size: 8px;
    line-height: 1;
}

/* Mobile uchun yanada compact */
@media (max-width: 480px) {
    .sales-history-page {
        padding: 8px;
        border-radius: 6px;
    }
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e9ecef;
}

.page-header h1 {
    color: #495057;
    font-size: 1.8rem;
    margin: 0;
    font-weight: 600;
}

.page-header h1 i {
    color: #007bff;
    margin-right: 10px;
}

/* Toggle Switch */
.header-controls {
    display: flex;
    align-items: center;
}

.toggle-switch {
    display: flex;
    align-items: center;
    cursor: pointer;
    user-select: none;
}

.toggle-switch input[type="checkbox"] {
    display: none;
}

.toggle-slider {
    position: relative;
    width: 50px;
    height: 26px;
    background-color: #ccc;
    border-radius: 26px;
    transition: background-color 0.3s;
    margin-right: 10px;
}

.toggle-slider:before {
    content: "";
    position: absolute;
    top: 2px;
    left: 2px;
    width: 22px;
    height: 22px;
    background-color: white;
    border-radius: 50%;
    transition: transform 0.3s;
}

.toggle-switch input[type="checkbox"]:checked + .toggle-slider {
    background-color: #007bff;
}

.toggle-switch input[type="checkbox"]:checked + .toggle-slider:before {
    transform: translateX(24px);
}

.toggle-label {
    font-size: 0.9rem;
    color: #495057;
    font-weight: 500;
}

/* Compact view styles */
.compact-mode .compact-hide {
    display: none !important;
}

/* Compact view da mahsulot ustunini ko'rsatish */
.compact-mode .col-product {
    display: table-cell !important;
}

/* Compact mode da BARCHA ustunlar uchun aniq kenglik */
.compact-mode .sales-history-page .sales-table { 
    width: 1385px !important; 
    min-width: 1385px !important;
    max-width: 1385px !important;
    table-layout: fixed !important;
}

.compact-mode .sales-history-page .sales-table th, 
.compact-mode .sales-history-page .sales-table td { 
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}

/* Compact row styling */
.compact-mode .compact-row {
    border-left: 3px solid #007bff;
    background-color: rgba(0, 123, 255, 0.02);
}

.compact-mode .compact-row:hover {
    background-color: rgba(0, 123, 255, 0.08);
}

.sales-stats {
    display: flex;
    gap: 20px;
    margin-bottom: 25px;
}

.stat-card {
    background: #007bff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    display: flex;
    align-items: center;
    gap: 15px;
    flex: 1;
    color: white;
}

.stat-card:nth-child(2) {
    background: #dc3545;
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
}

.stat-card:nth-child(3) {
    background: #28a745;
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
}

.stat-card i {
    font-size: 2rem;
    color: white;
}

.stat-number {
    display: block;
    font-size: 1.5rem;
    font-weight: bold;
    color: white;
    line-height: 1.2;
}

.stat-label {
    display: block;
    font-size: 0.9rem;
    color: white;
    opacity: 0.9;
}

/* Qidiruv va filtr paneli */
.search-filter-panel {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    padding: 20px;
}

.search-filter-row {
    display: flex;
    gap: 20px;
    align-items: end;
    flex-wrap: wrap;
}

.search-input-container {
    position: relative;
    flex: 1.125;
    min-width: 225px;
    max-width: 375px;
}

.search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    font-size: 14px;
}

.search-input {
    width: 100%;
    padding: 10px 12px 10px 35px;
    border: 2px solid #e9ecef;
    border-radius: 25px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.search-input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

.clear-search-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    padding: 4px;
    border-radius: 50%;
    transition: background-color 0.3s ease;
}

.clear-search-btn:hover {
    background-color: #f8f9fa;
    color: #495057;
}

.filter-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
    flex-shrink: 0;
}

.filter-group label {
    font-size: 12px;
    font-weight: 500;
    color: #495057;
    margin-bottom: 5px;
}

.filter-input, .filter-select {
    padding: 8px 15px;
    border: 2px solid #e9ecef;
    border-radius: 20px;
    font-size: 13px;
    transition: border-color 0.3s ease;
}

.filter-input:focus, .filter-select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

/* Mijoz qidiruv dropdown */
.customer-search-container {
    position: relative;
}

.customer-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid #e9ecef;
    border-top: none;
    border-radius: 0 0 15px 15px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.customer-option {
    padding: 10px 15px;
    cursor: pointer;
    font-size: 13px;
    border-bottom: 1px solid #f8f9fa;
    transition: background-color 0.2s ease;
}

.customer-option:hover {
    background-color: #f8f9fa;
}

.customer-option:last-child {
    border-bottom: none;
}

.customer-option.selected {
    background-color: #007bff;
    color: white;
}

.customer-search-input:focus + .customer-dropdown {
    border-color: #007bff;
}



/* Joylashuv filtri uchun maxsus kenglik */
.filter-group-location {
    min-width: 180px;
}

/* Desktop va tablet uchun horizontal scroll */
/* Media query olib tashlandi - pending-sales bilan bir xil qilish uchun */

/* OLIB TASHLANDI - Jadval siqilishiga sabab bo'lgan */

@media (max-width: 768px) {
    .search-filter-panel {
        padding: 15px;
    }
    
    .search-filter-row {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    .search-input-container {
        max-width: 100%;
        min-width: auto;
    }
    
    .filter-group {
        min-width: auto;
    }
}

/* Natijalar ma'lumoti */
.results-info {
    background: #e3f2fd;
    border: 1px solid #90caf9;
    border-radius: 4px;
    padding: 8px 12px;
    margin-bottom: 15px;
    font-size: 14px;
    color: #1565c0;
}

/* Pagination styles */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1.5rem 1rem;
    background: white;
    border-top: 1px solid #e9ecef;
    margin-top: 0;
}

#paginationButtons {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-wrap: wrap;
    justify-content: center;
}

.pagination-btn {
    padding: 0.5rem 0.75rem;
    border: 1px solid #dee2e6;
    background: white;
    color: #495057;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9rem;
    min-width: 40px;
    text-align: center;
}

.pagination-btn:hover:not(.active) {
    background: #f8f9fa;
    border-color: #adb5bd;
}

.pagination-btn.active {
    background: #667eea;
    color: white;
    border-color: #667eea;
    font-weight: 600;
}

.pagination-dots {
    padding: 0.5rem 0.25rem;
    color: #6c757d;
    font-weight: bold;
}

.table-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
}

/* DUBLIKAT QOIDA O'CHIRILDI - YUQORIDAGI 172-QATORDAGI QOIDA ISHLAYDI */

/* th stili yuqorida .sales-table td bilan birgalikda aniqlangan */

/* ESKI QOIDALAR O'CHIRILDI - FAQAT YUQORIDAGI YANGI QOIDALAR ISHLAYDI */

.loading {
    text-align: center;
    color: #6c757d;
    font-style: italic;
}

/* Mahsulot ustuni chap tomonga joylashtiriladi */
.sales-history-page .sales-table th:nth-child(4),
.sales-history-page .sales-table td:nth-child(4) {
    text-align: left;
}

.profit-positive {
    color: #28a745;
    font-weight: bold;
}

.profit-negative {
    color: #dc3545;
    font-weight: bold;
}

.btn-action {
    background: none;
    border: 1px solid #dee2e6;
    padding: 3px 5px;
    border-radius: 3px;
    cursor: pointer;
    margin: 1px;
    font-size: 10px;
    transition: all 0.2s;
    display: block;
    width: 24px;
    height: 20px;
    text-align: center;
    line-height: 12px;
}

.btn-edit {
    color: #007bff;
    border-color: #007bff;
}

.btn-edit:hover {
    background: #007bff;
    color: white;
}

.btn-delete {
    color: #dc3545;
    border-color: #dc3545;
}

.btn-delete:hover {
    background: #dc3545;
    color: white;
}

.btn-view {
    color: #28a745;
    border-color: #28a745;
}

.btn-view:hover {
    background: #28a745;
    color: white;
}



.customer-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    word-wrap: break-word;
    max-width: 150px;
}

.customer-name {
    font-weight: 600;
    color: #495057;
    font-size: 12px !important;
}

.customer-phone {
    font-size: 10px !important;
    color: #6c757d;
    font-style: italic;
    white-space: nowrap;
    overflow: hidden;
}

/* Savdo gruppa uslublari */
.sale-group-start, .sale-group-item {
    background-color: rgba(0, 123, 255, 0.02);
}

/* Savdo guruhlarini ajratish */
.sale-group-start {
    border-top: 1px solid #dee2e6;
}

/* Birinchi savdo guruhida yuqoridagi chegara yo'q */
tbody tr.sale-group-start:first-child {
    border-top: none;
}

/* Savdo guruhlarini vizual jihatdan birlashtirish */
.sale-group-start, .sale-group-item {
    position: relative;
}

/* Savdo guruhi ichidagi barcha qatorlarni bir xil ko'rinishda qilish */
.sale-group-start td, .sale-group-item td {
    border-bottom: 1px solid #e9ecef;
    vertical-align: middle;
    font-size: 14px !important;
    padding: 8px 6px;
    line-height: 1.4;
}

/* Savdo guruhi oxirgi qatori uchun */
.sale-group-end {
    border-bottom: 2px solid #6c757d !important;
}

/* Qidiruv natijalarini highlight qilish - faqat mahsulot nomi */
.product-highlight {
    background-color: #ffc107 !important;
    color: #212529 !important;
    font-weight: 600 !important;
    border-radius: 3px;
    padding: 2px 4px;
    border: 1px solid #ffb300;
}

.group-cell {
    vertical-align: middle !important;
    text-align: center !important;
    background-color: #ffffff !important;
    font-weight: 600;
    font-size: 14px !important;
}

/* Group sale'ning birinchi qatori uchun ustun-ustun text-align */
.group-cell:nth-child(5) { text-align: left !important; }    /* Mahsulot */
.group-cell:nth-child(6) { text-align: center !important; }  /* Miqdor */
.group-cell:nth-child(7) { text-align: right !important; }   /* Narx */
.group-cell:nth-child(8) { text-align: right !important; }   /* Yig'indi */

/* Joylashuv ustuni uchun chap tomonga tekislash */
.group-location {
    text-align: left !important;
}

/* Ombor matnini sariq fon bilan ajratish */
.warehouse-location {
    background-color: #fff3cd !important;
    padding: 2px 6px !important;
    border-radius: 3px !important;
}

.group-datetime {
    background-color: #e3f2fd !important;
}

.datetime-info {
    text-align: center;
}

.sale-date {
    font-weight: 600;
    font-size: 14px;
    color: #2c3e50;
    margin-bottom: 2px;
}

.sale-time {
    font-weight: 500;
    font-size: 17px;
    color: white;
    background: #007bff;
    padding: 2px 8px;
    border-radius: 0;
    display: inline-block;
}

.group-customer {
    background-color: #e8f5e8 !important;
}

.group-location {
    background-color: #f0f8ff !important;
    font-size: 12px;
    color: #495057;
    text-align: center;
}

.group-total {
    background-color: #fff3cd !important;
}

.group-profit {
    background-color: #f8d7da !important;
}

.group-actions {
    background-color: #e2e3e5 !important;
    padding: 8px 4px !important;
}

.group-actions .btn-action {
    display: block;
    width: 100%;
    margin-right: 0;
    margin-bottom: 4px;
    text-align: center;
}

.group-actions .btn-action:last-child {
    margin-bottom: 0;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .sales-history-page {
        padding: 15px;
    }
    
    .page-header {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .page-header h1 {
        font-size: 1.5rem;
        text-align: center;
    }
    
    .sales-stats {
        flex-direction: column;
        gap: 15px;
    }
    
    /* Mobile da table ni scroll bilan ko'rsatish */
    .table-container {
        display: block !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
    }
    
    /* JADVAL QOIDALARI OLIB TASHLANDI - Siqilishiga sabab bo'lgan */
    
    /* Mobile pagination */
    .pagination {
        padding: 1rem 0.5rem;
    }

    #paginationButtons {
        gap: 0.25rem;
    }

    .pagination-btn {
        padding: 0.4rem 0.6rem;
        font-size: 0.8rem;
        min-width: 35px;
    }

    .pagination-dots {
        padding: 0.4rem 0.15rem;
    }
    
    /* Mobile sales cards */
    .mobile-sales-cards {
        display: block;
    }
    
    .mobile-sale-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-left: 5px solid #007bff;
    }
    
    .mobile-sale-card.sale-group-header {
        border-left-color: #28a745;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .mobile-sale-card .sale-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .mobile-sale-card .sale-date {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
    }
    
    .mobile-sale-card .sale-total {
        font-size: 1.2rem;
        font-weight: bold;
        color: #28a745;
    }
    
    .mobile-sale-card .sale-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .mobile-sale-card .info-item {
        display: flex;
        flex-direction: column;
        gap: 3px;
    }
    
    .mobile-sale-card .info-label {
        font-size: 0.9rem;
        font-weight: 500;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .mobile-sale-card .info-value {
        font-size: 1rem;
        font-weight: 600;
        color: #2c3e50;
        word-break: break-word;
    }
    
    .mobile-sale-card .product-details {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    
    .mobile-sale-card .product-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
    }
    
    .mobile-sale-card .product-stats {
        display: flex;
        justify-content: space-between;
        font-size: 0.95rem;
    }
    
    .mobile-sale-card .product-stats .stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
    }
    
    .mobile-sale-card .product-stats .stat-label {
        color: #6c757d;
        font-size: 0.8rem;
    }
    
    .mobile-sale-card .product-stats .stat-value {
        font-weight: 600;
        color: #2c3e50;
    }
    
    .mobile-sale-card .sale-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e9ecef;
    }
    
    .mobile-sale-card .action-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
    }
    
    .mobile-sale-card .edit-btn {
        background: #007bff;
        color: white;
    }
    
    .mobile-sale-card .edit-btn:hover {
        background: #0056b3;
    }
    
    .mobile-sale-card .delete-btn {
        background: #dc3545;
        color: white;
    }
    
    .mobile-sale-card .delete-btn:hover {
        background: #c82333;
    }
    
    .mobile-sale-card .view-btn {
        background: #28a745;
        color: white;
    }
    
    .mobile-sale-card .view-btn:hover {
        background: #218838;
    }
}

/* Desktop da mobile cards ni yashirish */
.mobile-sales-cards {
    display: none;
}

/* Edit Modal CSS */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: 8px;
    width: 95%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* Yangi modal layout stillari */
.sale-main-info {
    display: flex;
    justify-content: center;
    align-items: center;
    background: #f8f9fa;
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #007bff;
    gap: 8px;
    flex-wrap: wrap;
    text-align: center;
}

.customer-label {
    font-weight: 500;
    color: #6c757d;
    font-size: 16px;
}

.customer-name {
    font-size: 16px;
    font-weight: 600;
    color: #2c3e50;
}

.customer-phone {
    font-size: 16px;
    color: #6c757d;
    font-weight: 500;
}

.date-separator {
    font-size: 18px;
    color: #6c757d;
    margin: 0 10px;
}

.date-label {
    font-weight: 500;
    color: #6c757d;
    font-size: 16px;
}

.date-value {
    font-weight: 600;
    color: #007bff;
    font-size: 16px;
}



.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
}

.modal-header h3 {
    margin: 0;
    color: #495057;
    font-size: 1.2rem;
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6c757d;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.close-btn:hover {
    color: #dc3545;
}

.modal-body {
    padding: 20px;
}

.form-group {
    margin-bottom: 15px;
}

.form-row {
    display: flex;
    gap: 15px;
}

.form-row .form-group {
    flex: 1;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #495057;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.readonly-field {
    background-color: #f8f9fa !important;
    color: #6c757d !important;
    cursor: not-allowed !important;
}

.total-display {
    text-align: center;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 4px;
    margin-top: 15px;
    font-size: 16px;
    color: #007bff;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 20px;
    border-top: 1px solid #e9ecef;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    display: inline-block;
    text-align: center;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #545b62;
}

/* Savdo tafsilotlari modal stillari */
.sale-info {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #e9ecef;
}

.info-row:last-child {
    border-bottom: none;
}

.info-label {
    font-weight: 600;
    color: #495057;
    min-width: 120px;
}

.info-value {
    color: #6c757d;
    text-align: right;
}

.payment-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
}

.payment-status.paid {
    background-color: #d4edda;
    color: #155724;
}

.payment-status.pending {
    background-color: #fff3cd;
    color: #856404;
}

.payment-status.cancelled {
    background-color: #f8d7da;
    color: #721c24;
}

.products-table {
    margin: 15px 0;
}

.modal-table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid #dee2e6;
}

.modal-table th,
.modal-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

.modal-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

.modal-table td {
    color: #6c757d;
}

.total-info {
    background: #e9ecef;
    padding: 15px;
    border-radius: 8px;
    margin-top: 20px;
}

.total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
}

.total-label {
    font-weight: 600;
    color: #495057;
}

.total-value {
    font-weight: 700;
    font-size: 16px;
}

.total-value.positive {
    color: #28a745;
}

.total-value.negative {
    color: #dc3545;
}

/* Modal header actions */
.modal-header-actions {
    display: flex;
    align-items: center;
    gap: 10px;
}

.btn-print {
    background: #28a745;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: background 0.2s;
}

.btn-print:hover {
    background: #218838;
}

.btn-print i {
    font-size: 12px;
}

.btn-excel {
    background: #17a2b8;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: background 0.2s;
    margin-left: 8px;
}

.btn-excel:hover {
    background: #138496;
}

.btn-excel i {
    font-size: 12px;
}

/* Savdo tafsilotlari modal - markazda ochish */
.sale-details-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.6);
    display: flex !important;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    padding: 20px;
    box-sizing: border-box;
}

.sale-details-content {
    max-width: 1200px;
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    animation: modalFadeIn 0.3s ease-out;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

/* Mobile da modal responsive */
@media (max-width: 768px) {
    .sale-details-content {
        max-width: 100%;
        width: 95%;
        margin: 10px;
    }
    
    .modal-content {
        max-width: 100%;
        width: 95%;
        margin: 10px;
    }
    
    /* Mobile uchun yangi layout */
    .sale-main-info {
        gap: 6px;
        padding: 12px 15px;
        text-align: center;
    }
    
    .customer-label, .date-label {
        font-size: 14px;
    }
    
    .customer-name {
        font-size: 15px;
    }
    
    .customer-phone {
        font-size: 14px;
    }
    
    .date-separator {
        font-size: 16px;
        margin: 0 8px;
    }
    
    .date-value {
        font-size: 15px;
    }
}

/* Sotuvchi roli uchun foyda ustunini yashirish */
{% if session.role == 'sotuvchi' %}
.col-profit {
    display: none !important;
    visibility: hidden !important;
    width: 0 !important;
    padding: 0 !important;
    margin: 0 !important;
}
{% endif %}
.col-profit.hidden-for-seller {
    display: none !important;  
}
</style>

<script>
// Dinamik valyuta kursi
let USD_TO_UZS_RATE = 12500; // Default qiymat, API dan yuklanadi
const userRole = '{{ session.role }}'; // Foydalanuvchi roli
// Debug logs removed - role system working correctly

// Pagination o'zgaruvchilari
let allSalesData = [];
let filteredSalesData = [];
let currentPage = 1;
const itemsPerPage = 50;
let totalPages = 0;

// Dollar qiymatini so'mga konvert qilish (savdo kursidan foydalanish)
function convertToUZS(usdAmount, saleRate = null) {
    const rate = saleRate || USD_TO_UZS_RATE;
    return (parseFloat(usdAmount) * rate).toFixed(0);
}

// Narxni formatlash (USD va som) - savdo kursidan foydalanish
function formatPrice(usdAmount, saleRate = null) {
    const usdFormatted = parseFloat(usdAmount).toFixed(2);
    const uzsFormatted = convertToUZS(usdAmount, saleRate);
    return `$${usdFormatted}<br><small style="color: #007bff; font-size: 13px;">${parseInt(uzsFormatted).toLocaleString('uz-UZ')}</small>`;
}
// Global o'zgaruvchi - joriy savdo ma'lumotlari
let currentSaleData = null;

document.addEventListener('DOMContentLoaded', function() {
    // Sotuvchi roli uchun foyda ustunlarini yashirish
    if (userRole === 'sotuvchi') {
        const style = document.createElement('style');
        style.textContent = `
            table .col-profit,
            table th.col-profit,  
            table td.col-profit,
            .sales-table .col-profit,
            .sales-table th.col-profit,
            .sales-table td.col-profit,
            #salesTable .col-profit,
            #salesTable th.col-profit,
            #salesTable td.col-profit {
                display: none !important;
                visibility: hidden !important;
                width: 0 !important;
                height: 0 !important;
                padding: 0 !important;
                margin: 0 !important;
                border: none !important;
            }
        `;
        document.head.appendChild(style);
        // CSS backup for profit column hiding (already handled by server-side template)
        
        // Forced DOM hiding - barcha col-profit elementlarni topish va o'chirish
        setTimeout(() => {
            // Role-based profit column hiding (backup - already handled by server-side template)
            const profitElements = document.querySelectorAll('.col-profit, th.col-profit, td.col-profit, [class*="col-profit"]');
            profitElements.forEach((el, index) => {
                console.log(`üîç DEBUG: Element ${index}:`, el.tagName, el.className, el.textContent);
                el.style.display = 'none';
                el.style.visibility = 'hidden';
                el.remove(); // Butunlay o'chirish
            });
        }, 500);
        
        // MutationObserver - yangi elementlar qo'shilganda ham yashirish
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) { // Element node
                        const profitEls = node.querySelectorAll ? node.querySelectorAll('.col-profit, th.col-profit, td.col-profit') : [];
                        profitEls.forEach(el => {
                            console.log('üîç DEBUG: Yangi col-profit element topildi va o\'chirildi');
                            el.remove();
                        });
                        if (node.classList && node.classList.contains('col-profit')) {
                            console.log('üîç DEBUG: col-profit node o\'zi qo\'shildi va o\'chirildi');
                            node.remove();
                        }
                    }
                });
            });
        });
        observer.observe(document.body, { childList: true, subtree: true });
    }
    
    // Valyuta kursini olish
    loadCurrencyRate();
    
    // Jadvalni tozalash
    clearTable();
    // Real ma'lumotlarni yuklash
    loadSalesHistory();
    
    // Qidiruv va filtr funksiyalarini sozlash
    initializeSearchAndFilters();
    
    // Joylashuvlar ro'yxatini yuklash
    loadLocationsForFilter();
    
    // Compact view toggle
    initializeCompactView();
});

function clearTable() {
    // Jadval va statistikalarni tozalash
    const colspan = userRole === 'sotuvchi' ? '10' : '11';
    document.getElementById('salesTableBody').innerHTML = 
        `<tr><td colspan="${colspan}" class="loading">Ma'lumotlar yuklanmoqda...</td></tr>`;
    document.getElementById('totalSales').textContent = '0';
    document.getElementById('totalRevenue').textContent = '$0';
    
    // Foyda elementini faqat mavjud bo'lsa yangilash
    const totalProfitElement = document.getElementById('totalProfit');
    if (totalProfitElement) {
        totalProfitElement.textContent = '$0';
    }
}

function forceRefresh() {
    // Majburiy yangilash - cache'ni tozalash
    console.log('üîÑ Majburiy yangilash...');
    clearTable();
    
    // Browser cache'ni tozalash
    if ('caches' in window) {
        caches.keys().then(function(names) {
            names.forEach(function(name) {
                caches.delete(name);
            });
        });
    }
    
    // Real ma'lumotlarni yuklash
    loadSalesHistory();
}

async function loadSalesHistory(page = 1) {
    try {
        // Avval jadvalni tozalash
        clearTable();
        
        // Cache va localStorage tozalash
        console.log('üßπ Cache va localStorage tozalanmoqda...');
        if ('caches' in window) {
            caches.keys().then(names => {
                names.forEach(name => {
                    caches.delete(name);
                });
            });
        }
        
        console.log('üîÑ Real API ma\'lumotlari yuklanmoqda...');
        
        // Sana filtrlarini olish
        const dateFromInput = document.getElementById('dateFromFilter');
        const dateToInput = document.getElementById('dateToFilter');
        
        console.log('üìÖ DEBUG: dateFromInput:', dateFromInput);
        console.log('üìÖ DEBUG: dateFromInput.value:', dateFromInput?.value);
        console.log('üìÖ DEBUG: dateToInput:', dateToInput);
        console.log('üìÖ DEBUG: dateToInput.value:', dateToInput?.value);
        
        const dateFrom = dateFromInput?.value || '';
        const dateTo = dateToInput?.value || '';
        
        // URL parametrlarini yaratish
        let apiUrl = `/api/sales-history?page=${page}&per_page=${itemsPerPage}`;
        if (dateFrom) apiUrl += `&start_date=${dateFrom}`;
        if (dateTo) apiUrl += `&end_date=${dateTo}`;
        
        // Mijoz filtri qo'shish
        if (selectedCustomerId) {
            apiUrl += `&customer_id=${selectedCustomerId}`;
            console.log('üë§ Mijoz filtri qo\'shildi:', selectedCustomerId);
        }
        
        // Qidiruv filtri qo'shish
        const searchTerm = document.getElementById('searchInput')?.value.trim();
        if (searchTerm) {
            apiUrl += `&search_term=${encodeURIComponent(searchTerm)}`;
            console.log('üîç Qidiruv filtri qo\'shildi:', searchTerm);
        }
        
        // Joylashuv filtri qo'shish
        const locationFilter = document.getElementById('locationFilter')?.value;
        if (locationFilter) {
            apiUrl += `&location_filter=${encodeURIComponent(locationFilter)}`;
            console.log('üìç Joylashuv filtri qo\'shildi:', locationFilter);
        }
        
        apiUrl += `&nocache=` + new Date().getTime();
        
        console.log('üìÖ API URL:', apiUrl);
        console.log('üìÖ Sana filtrlari:', { dateFrom, dateTo });
        
        const response = await fetch(apiUrl, {
            method: 'GET',
            cache: 'no-cache',
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            }
        });
        
        if (!response.ok) {
            throw new Error('API xatolik: ' + response.status);
        }
        
        const data = await response.json();
        console.log('üîç Real API Response:', data);
        console.log('üîç API Success:', data.success);
        console.log('üîç API Data:', data.data);
        
        // Ma'lumotlarni chuqur debug qilish
        if (data.data && data.data.sales) {
            console.log('üìÖ Birinchi 5 ta savdo sanasi:');
            data.data.sales.slice(0, 5).forEach((sale, index) => {
                console.log(`   ${index + 1}. ID: ${sale.id}, Sana: ${sale.sale_date}, Format: ${typeof sale.sale_date}`);
            });
        }
        
        // Faqat real API'dan kelayotgan ma'lumotlarni ko'rsatish
        if (data.success && data.data) {
            console.log('üìä Real Sales Array:', data.data.sales);
            console.log('üìä Real Sales Length:', data.data.sales ? data.data.sales.length : 0);
            
            // Pagination ma'lumotlarini saqlash
            allSalesData = data.data.sales || [];
            filteredSalesData = [...allSalesData];
            currentPage = page;
            
            // Pagination malumotlarini olish
            if (data.data.pagination) {
                totalPages = data.data.pagination.total_pages;
            } else {
                totalPages = Math.ceil(allSalesData.length / itemsPerPage);
            }
            
            displaySalesData(data.data);
            updatePaginationButtons();
        } else {
            console.log('‚ùå API format noto\'g\'ri:', data);
            // Agar format noto'g'ri bo'lsa, bo'sh jadval ko'rsatish
            document.getElementById('salesTableBody').innerHTML = 
                '<tr><td colspan="9" class="loading">Real savdo ma\'lumotlari topilmadi</td></tr>';
        }
        
    } catch (error) {
        console.error('Xatolik:', error);
        document.getElementById('salesTableBody').innerHTML = 
            '<tr><td colspan="9" style="text-align: center; color: red;">Xatolik yuz berdi: ' + error.message + '</td></tr>';
    }
}

function displaySalesData(data) {
    // API response formatini tekshirish va statistikalarni yangilash
    const stats = data.statistics || data;
    const salesData = data.sales || [];
    
    // Agar bu yangi ma'lumotlar bo'lsa (filter qo'llanmagan bo'lsa), allSalesData ni yangilash
    if (arguments.length === 1 && !data.isFiltered) {
        // Yangi savdolar birinchi bo'lishi uchun sortlash
        const sortedSales = [...salesData].sort((a, b) => {
            const dateA = new Date(a.sale_date || a.created_at || a.date);
            const dateB = new Date(b.sale_date || b.created_at || b.date);
            return dateB - dateA; // DESC tartib - yangi savdolar birinchi
        });
        
        allSalesData = sortedSales;
        filteredSalesData = [...sortedSales];
        
        console.log('üîÑ Ma\'lumotlar sortlandi, birinchi 3 ta sana:', 
            sortedSales.slice(0, 3).map(s => s.sale_date));
        
        // Joylashuvlar ro'yxatini yangilash
        loadLocationsForFilter();
    }
    
    console.log('üìà Statistikalar:', stats);
    console.log('üìã Savdolar:', salesData);
    
    // Statistikalarni yangilash (0 ham to'g'ri qiymat, shuning uchun ?? ishlatamiz)
    document.getElementById('totalSales').textContent = stats.total_sales ?? salesData.length;
    
    // Yig'indi va foyda statistikalarini faqat USD da ko'rsatish
    const totalRevenue = stats.total_revenue || 0;
    const totalProfit = stats.total_profit || 0;
    
    // Foyda foizini hisoblash
    const profitPercentage = totalRevenue > 0 ? ((totalProfit / totalRevenue) * 100).toFixed(1) : 0;
    
    document.getElementById('totalRevenue').innerHTML = `$${parseFloat(totalRevenue).toFixed(2)}`;
    
    // Foyda elementini faqat mavjud bo'lsa yangilash
    const totalProfitElement = document.getElementById('totalProfit');
    if (totalProfitElement) {
        totalProfitElement.innerHTML = `$${parseFloat(totalProfit).toFixed(2)} <small style="color: white;">(${profitPercentage}%)</small>`;
    }
    
    // Jadval ma'lumotlarini yangilash
    const tbody = document.getElementById('salesTableBody');
    
    if (!salesData || salesData.length === 0) {
        const colspan = userRole === 'sotuvchi' ? '10' : '11';
        tbody.innerHTML = `<tr><td colspan="${colspan}" class="loading">Savdo ma'lumotlari topilmadi</td></tr>`;
        return;
    }
    
    let html = '';
    salesData.forEach(sale => {
        const items = sale.items || []; // SaleItems array
        
        // DEBUG: Birinchi savdoni tekshirish
        if (salesData.indexOf(sale) === 0) {
            console.log('üîç DEBUG - Birinchi savdo:', sale);
            console.log('üîç DEBUG - Items:', items);
            if (items.length > 0) {
                console.log('üîç DEBUG - Birinchi item unit_price:', items[0].unit_price);
            }
        }
        
        // Agar items bo'sh bo'lsa, default item yaratamiz
        if (items.length === 0) {
            items.push({
                product_name: 'Items mavjud emas',
                quantity: '-',
                unit_price: 0,
                total_price: sale.total_amount || 0,
                location_type: 'store',
                location_id: sale.store_id
            });
        }
        
        const totalProfit = parseFloat(sale.total_profit || 0);
        const totalAmount = parseFloat(sale.total_amount || 0);
        const profitClass = totalProfit > 0 ? 'profit-positive' : totalProfit < 0 ? 'profit-negative' : '';
        
        // Sana va vaqtni formatlash
        const saleDate = new Date(sale.sale_date);
        const formattedDate = saleDate.toLocaleDateString('uz-UZ', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
        const formattedTime = saleDate.toLocaleTimeString('uz-UZ', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Birinchi item (grupning boshlanishi)
        const firstItem = items[0];
        const isOnlyItem = items.length === 1;
        
        let firstRowClasses = ['sale-group-start'];
        if (isOnlyItem) firstRowClasses.push('sale-group-end');
        
        html += `
            <tr class="${firstRowClasses.join(' ')}">
                <td rowspan="${items.length}" class="group-cell group-datetime">
                    <div class="datetime-info">
                        <div class="sale-date">${formattedDate}</div>
                        <div class="sale-time">${formattedTime}</div>
                    </div>
                </td>
                <td rowspan="${items.length}" class="group-cell group-customer">
                    <div class="customer-info">
                        <div class="customer-name">${sale.customer_name || 'ÔøΩ Noma\'lum'}</div>
                        <div class="customer-phone">${sale.customer_phone || '+998 XX XXX XX XX'}</div>
                    </div>
                </td>
                <td rowspan="${items.length}" class="group-cell group-seller">
                    <div style="line-height: 1.4;">
                        <div style="font-size: 14px; font-weight: 600; color: #495057;">${sale.seller_name || 'Admin'}</div>
                        ${sale.seller_phone ? `<div style="font-size: 14px; color: #6c757d; font-style: italic;">${sale.seller_phone}</div>` : ''}
                    </div>
                </td>
                <td class="group-cell group-location">
                    ${getLocationName(firstItem)}
                </td>
                <td>${firstItem.product_name || 'Noma\'lum'}</td>
                <td>${firstItem.quantity}</td>
                <td>${formatPrice(firstItem.unit_price || 0, sale.currency_rate)}</td>
                <td>${formatPrice(firstItem.total_price || 0, sale.currency_rate)}</td>
                <td rowspan="${items.length}" class="group-cell group-total">${formatPrice(totalAmount, sale.currency_rate)}</td>
                ${userRole === 'sotuvchi' ? '' : `<td rowspan="${items.length}" class="group-cell group-profit ${profitClass}">${formatPrice(totalProfit, sale.currency_rate)}</td>`}
                <td rowspan="${items.length}" class="group-cell group-actions">
                    <button class="btn-action btn-view" onclick="viewSaleDetails(${sale.id})" title="Ko'rish">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn-action btn-edit" onclick="editSaleGroup(${sale.id})" title="Guruhni tahrirlash">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-action btn-delete" onclick="deleteGroup(${sale.id})" title="O'chirish">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        
        // Qolgan itemlar
        for (let i = 1; i < items.length; i++) {
            const item = items[i];
            const isLast = i === items.length - 1;
            
            let rowClasses = ['sale-group-item'];
            if (isLast) rowClasses.push('sale-group-end');
            
            html += `
                <tr class="${rowClasses.join(' ')}">
                    <td class="group-cell group-location">
                        ${getLocationName(item)}
                    </td>
                    <td>${item.product_name || 'Noma\'lum'}</td>
                    <td>${item.quantity}</td>
                    <td>${formatPrice(item.unit_price || 0, sale.currency_rate)}</td>
                    <td>${formatPrice(item.total_price || 0, sale.currency_rate)}</td>
                </tr>
            `;
        }
    });
    
    tbody.innerHTML = html;
    
    // Compact mode holatini tekshirish va qo'llash
    const compactToggle = document.getElementById('compactViewToggle');
    if (compactToggle && compactToggle.checked) {
        console.log('üîÑ Ma\'lumotlar yuklangandan keyin compact mode yoqilmoqda');
        updateTableForCompactView();
    }
    
    // Ombor matnlarini sariq fon bilan ajratish
    highlightWarehouseLocations();
    
    // Qidiruv natijalarini highlight qilish
    highlightSearchResults();
}

// SaleItem dan joylashuv nomini olish funksiyasi
function getLocationName(item) {
    // Backend dan location_name maydoni keladi
    return item.location_name || 'Noma\'lum joylashuv';
}

function editSaleGroup(saleId) {
    // Savdo guruhini tahrirlash funksiyasi - Sales sahifasiga yo'naltirish
    console.log(`‚úèÔ∏è Savdo ${saleId} tahrirlash uchun sales sahifasiga yo'naltirmoqda...`);
    
    // Sales sahifasiga edit parametri bilan yo'naltirish
    window.location.href = `/sales?edit_group=${saleId}`;
}

function editSale(saleId) {
    // Bitta savdoni tahrirlash funksiyasi - Sales sahifasiga yo'naltirish
    console.log(`‚úèÔ∏è Savdo ${saleId} tahrirlash uchun sales sahifasiga yo'naltirmoqda...`);
    
    // Sales sahifasiga edit parametri bilan yo'naltirish
    window.location.href = `/sales?edit=${saleId}`;
}

function showEditModal(saleData) {
    // Edit modal ni yaratish va ko'rsatish
    const modalHTML = `
        <div id="editModal" class="modal-overlay" onclick="closeEditModal(event)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3><i class="fas fa-edit"></i> Savdoni Tahrirlash</h3>
                    <button class="close-btn" onclick="closeEditModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="editSaleForm">
                        <input type="hidden" id="editSaleId" value="${saleData.id}">
                        
                        <div class="form-group">
                            <label>Mahsulot:</label>
                            <input type="text" value="${saleData.product_name}" readonly class="readonly-field">
                        </div>
                        
                        <div class="form-group">
                            <label>Mijoz:</label>
                            <input type="text" value="${saleData.customer_name}" readonly class="readonly-field">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editQuantity">Miqdori:</label>
                                <input type="number" id="editQuantity" value="${saleData.quantity}" min="1" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="editUnitPrice">Birlik narxi ($):</label>
                                <input type="number" id="editUnitPrice" value="${saleData.unit_price}" min="0" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editPaymentMethod">To'lov usuli:</label>
                                <select id="editPaymentMethod" required>
                                    <option value="cash" ${saleData.payment_method === 'cash' ? 'selected' : ''}>Naqd</option>
                                    <option value="card" ${saleData.payment_method === 'card' ? 'selected' : ''}>Karta</option>
                                    <option value="credit" ${saleData.payment_method === 'credit' ? 'selected' : ''}>Kredit</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="editPaymentStatus">To'lov holati:</label>
                                <select id="editPaymentStatus" required>
                                    <option value="paid" ${saleData.payment_status === 'paid' ? 'selected' : ''}>To'langan</option>
                                    <option value="pending" ${saleData.payment_status === 'pending' ? 'selected' : ''}>Kutilmoqda</option>
                                    <option value="partial" ${saleData.payment_status === 'partial' ? 'selected' : ''}>Qisman</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editNotes">Izoh:</label>
                            <textarea id="editNotes" rows="3">${saleData.notes || ''}</textarea>
                        </div>
                        
                        <div class="total-display">
                            <strong>Jami summa: $<span id="editTotalAmount">${(saleData.quantity * saleData.unit_price).toFixed(2)}</span></strong>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Bekor qilish</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedSale()">Saqlash</button>
                </div>
            </div>
        </div>
    `;
    
    // Modal ni sahifaga qo'shish
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Total ni real-time yangilash
    const quantityInput = document.getElementById('editQuantity');
    const priceInput = document.getElementById('editUnitPrice');
    const totalSpan = document.getElementById('editTotalAmount');
    
    function updateTotal() {
        const quantity = parseFloat(quantityInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        const total = quantity * price;
        totalSpan.textContent = total.toFixed(2);
    }
    
    quantityInput.addEventListener('input', updateTotal);
    priceInput.addEventListener('input', updateTotal);
}

function closeEditModal(event) {
    const modal = document.getElementById('editModal');
    if (modal) {
        modal.remove();
    }
}

function saveEditedSale() {
    const saleId = document.getElementById('editSaleId').value;
    const quantity = document.getElementById('editQuantity').value;
    const unitPrice = document.getElementById('editUnitPrice').value;
    const paymentMethod = document.getElementById('editPaymentMethod').value;
    const paymentStatus = document.getElementById('editPaymentStatus').value;
    const notes = document.getElementById('editNotes').value;
    
    const updateData = {
        quantity: parseInt(quantity),
        unit_price: parseFloat(unitPrice),
        payment_method: paymentMethod,
        payment_status: paymentStatus,
        notes: notes
    };
    
    // API ga yuborish
    fetch(`/api/sales/${saleId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(updateData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('‚úÖ Savdo muvaffaqiyatli yangilandi!');
            closeEditModal();
            forceRefresh(); // Jadvalni yangilash
        } else {
            alert('‚ùå Savdoni yangilashda xatolik: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Update error:', error);
        alert('‚ùå Tarmoq xatoligi: ' + error.message);
    });
}

function deleteGroup(saleId) {
    // Savdo guruhini o'chirish funksiyasi
    if (confirm(`Bu savdoni to'liq o'chirishni xohlaysizmi?`)) {
        console.log(`üóëÔ∏è Savdo o'chirilmoqda: ${saleId}`);
        
        fetch('/api/sales/' + saleId, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            console.log('Delete result:', result);
            
            if (result.success) {
                alert('‚úÖ Savdo muvaffaqiyatli o\'chirildi');
                forceRefresh(); // Jadvalni majburan yangilash
            } else {
                alert('‚ùå Savdoni o\'chirishda xatolik: ' + result.error);
                forceRefresh(); // Baribir yangilash
            }
        })
        .catch(error => {
            console.error('Delete group error:', error);
            alert('‚ùå Savdo guruhini o\'chirishda xatolik: ' + error.message);
        });
    }
}

function deleteSale(saleId) {
    // Savdoni o'chirish funksiyasi (eski funksiya, hozir ishlatilmaydi)
    if (confirm('Bu savdoni o\'chirishni xohlaysizmi?')) {
        console.log(`üóëÔ∏è Savdo ${saleId} o'chirilmoqda...`);
        
        fetch('/api/sales/' + saleId, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            console.log('Delete response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Delete response:', data);
            
            if (data.success) {
                alert('‚úÖ Savdo muvaffaqiyatli o\'chirildi');
                forceRefresh(); // Jadvalni majburan yangilash
            } else {
                alert('‚ùå Xatolik: ' + (data.error || 'Noma\'lum xatolik'));
            }
        })
        .catch(error => {
            console.error('Delete xatolik:', error);
            alert('‚ùå Tarmoq xatoligi: ' + error.message);
        });
    }
}

// Pagination tugmalarini yangilash
function updatePaginationButtons() {
    const paginationContainer = document.getElementById('paginationButtons');
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
    }
    
    pagination.style.display = 'flex';
    
    let buttonsHtml = '';
    
    // Oldingi sahifa tugmasi
    if (currentPage > 1) {
        buttonsHtml += `<button class="pagination-btn" onclick="goToPage(${currentPage - 1})">‚Üê Oldingi</button>`;
    }
    
    // Sahifa raqamlari
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    // Agar oxirgi sahifalar ko'rsatilayotgan bo'lsa, boshlanish nuqtasini moslashtirish
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // Birinchi sahifani ko'rsatish (agar ko'rinmaydigan bo'lsa)
    if (startPage > 1) {
        buttonsHtml += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
        if (startPage > 2) {
            buttonsHtml += `<span class="pagination-dots">...</span>`;
        }
    }
    
    // Sahifa raqamlari
    for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === currentPage ? 'active' : '';
        buttonsHtml += `<button class="pagination-btn ${activeClass}" onclick="goToPage(${i})">${i}</button>`;
    }
    
    // Oxirgi sahifani ko'rsatish (agar ko'rinmaydigan bo'lsa)
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            buttonsHtml += `<span class="pagination-dots">...</span>`;
        }
        buttonsHtml += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
    }
    
    // Keyingi sahifa tugmasi
    if (currentPage < totalPages) {
        buttonsHtml += `<button class="pagination-btn" onclick="goToPage(${currentPage + 1})">Keyingi ‚Üí</button>`;
    }
    
    paginationContainer.innerHTML = buttonsHtml;
}

// Sahifaga o'tish
async function goToPage(page) {
    if (page >= 1 && page <= totalPages && page !== currentPage) {
        await loadSalesHistory(page);
        
        // Sahifa yuqorisiga scroll qilish
        document.querySelector('.sales-table').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }
}

// Savdo tafsilotlarini ko'rish funksiyasi
function viewSaleDetails(saleId) {
    console.log('Ko\'rish: Savdo ID', saleId);
    
    fetch(`/api/sales/${saleId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.sale) {
                showSaleDetailsModal(data.sale);
            } else {
                alert('‚ùå Savdo tafsilotlarini olishda xatolik: ' + (data.error || 'Noma\'lum xatolik'));
            }
        })
        .catch(error => {
            console.error('Savdo tafsilotlari xatolik:', error);
            alert('‚ùå Tarmoq xatoligi: ' + error.message);
        });
}

// Savdo tafsilotlari modalini ko'rsatish
function showSaleDetailsModal(sale) {
    // Global o'zgaruvchiga saqlash
    currentSaleData = sale;
    
    const modalHtml = `
        <div id="saleDetailsModal" class="modal sale-details-modal">
            <div class="modal-content sale-details-content">
                <div class="modal-header">
                    <h3><i class="fas fa-eye"></i> Savdo Tafsilotlari</h3>
                    <div class="modal-header-actions">
                        <button class="btn-print" onclick="printSaleReceipt()" title="Chop etish">
                            <i class="fas fa-print"></i> Chop etish
                        </button>
                        <button class="btn-excel" onclick="exportSaleToExcel()" title="Excel ga export">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                        <button class="close-btn" onclick="closeSaleDetailsModal()">&times;</button>
                    </div>
                </div>
                <div class="modal-body">
                    <!-- Asosiy ma'lumotlar bir qatorda -->
                    <div class="sale-main-info">
                        <span class="customer-label">Mijoz:</span>
                        <span class="customer-name">${sale.customer_name || 'ÔøΩ Noma\'lum'}</span>
                        ${sale.customer_phone ? `<span class="customer-phone">(${sale.customer_phone})</span>` : ''}
                        <span class="date-separator">‚Ä¢</span>
                        <span class="date-label">Savdo sanasi:</span>
                        <span class="date-value">${new Date(sale.sale_date).toLocaleString('uz-UZ', { 
                            timeZone: 'Asia/Tashkent',
                            year: 'numeric', 
                            month: '2-digit', 
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</span>
                    </div>
                    
                    <h4>Mahsulotlar:</h4>
                    <div class="products-table">
                        <table class="modal-table">
                            <thead>
                                <tr>
                                    <th>Mahsulot</th>
                                    <th>Joylashuv</th>
                                    <th>Miqdori</th>
                                    <th>Narx</th>
                                    <th>Yig'indi</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sale.items.map(item => `
                                    <tr>
                                        <td>${item.product_name}</td>
                                        <td>${item.location_name}</td>
                                        <td>${item.quantity}</td>
                                        <td>$${parseFloat(item.unit_price || 0).toFixed(2)}</td>
                                        <td>$${parseFloat(item.total_price || 0).toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="total-info">
                        ${generatePaymentDetailsHTML(sale)}
                        <div class="total-row" style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #dee2e6; font-weight: bold;">
                            <span class="total-label">Jami summa:</span>
                            <span class="total-value">$${parseFloat(sale.total_amount || 0).toFixed(2)}</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeSaleDetailsModal()">Yopish</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Tafsilotlar modalini yopish
function closeSaleDetailsModal() {
    const modal = document.getElementById('saleDetailsModal');
    if (modal) {
        modal.remove();
    }
}

// To'lov turi matnini olish
function getPaymentMethodText(method) {
    switch (method) {
        case 'cash': return 'üíµ Naqd pul';
        case 'click': return 'üì± Click';
        case 'terminal': return 'üí≥ Terminal';
        case 'debt': return 'üìù Qarz';
        default: return method || 'Naqd pul';
    }
}

// To'lov tafsilotlarini HTML ga aylantirish
function generatePaymentDetailsHTML(sale) {
    const details = sale.payment_details || {};
    const payments = [
        { name: 'üíµ Naqd pul', amount: details.cash || 0 },
        { name: 'üì± Click', amount: details.click || 0 },
        { name: 'üí≥ Terminal', amount: details.terminal || 0 },
        { name: 'üìù Qarz', amount: details.debt || 0 }
    ];
    
    // Faqat 0 dan katta to'lovlarni ko'rsatish
    const activePayments = payments.filter(p => p.amount > 0);
    
    // Agar hech qanday payment_details bo'lmasa, payment_method orqali ko'rsatish
    if (activePayments.length === 0) {
        return `
            <div class="total-row">
                <span class="total-label">To'lov turi:</span>
                <span class="total-value">${getPaymentMethodText(sale.payment_method)}</span>
            </div>
        `;
    }
    
    // To'lov turlarini bir qatorda ko'rsatish
    const paymentsHTML = activePayments
        .map(p => `<span style="display: inline-block; background: #f8f9fa; padding: 5px 12px; margin-right: 10px; border-radius: 4px; border-left: 3px solid #007bff;">${p.name}: <strong>$${parseFloat(p.amount).toFixed(2)}</strong></span>`)
        .join('');
    
    return `
        <div class="total-row">
            <span class="total-label" style="display: inline-block; margin-right: 15px; vertical-align: middle;">To'lovlar:</span>
            <span style="display: inline-block; vertical-align: middle;">${paymentsHTML}</span>
        </div>
    `;
}

// To'lov holati matnini olish
function getPaymentStatusText(status) {
    switch (status) {
        case 'paid': return 'To\'landi';
        case 'pending': return 'Kutilmoqda';
        case 'cancelled': return 'Bekor qilindi';
        default: return status || 'Noma\'lum';
    }
}

// Excel export funksiyasi
function exportSaleToExcel() {
    if (!currentSaleData) {
        alert('‚ùå Savdo ma\'lumotlari topilmadi!');
        return;
    }
    
    // HTML jadval yaratish (Excel to'g'ri import qiladi)
    const htmlData = generateExcelHTML(currentSaleData);
    
    // Excel HTML format
    const blob = new Blob([htmlData], { 
        type: 'application/vnd.ms-excel;charset=utf-8;' 
    });
    
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `savdo_${currentSaleData.id}_${new Date().toISOString().split('T')[0]}.xls`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log('Excel export: Savdo ID', currentSaleData.id);
}

// Excel HTML format yaratish
function generateExcelHTML(sale) {
    let html = `
<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
<head>
    <meta charset="UTF-8">
    <!--[if gte mso 9]>
    <xml>
        <x:ExcelWorkbook>
            <x:ExcelWorksheets>
                <x:ExcelWorksheet>
                    <x:Name>Savdo ${sale.id}</x:Name>
                    <x:WorksheetSource HRef="sheet001.htm"/>
                </x:ExcelWorksheet>
            </x:ExcelWorksheets>
        </x:ExcelWorkbook>
    </xml>
    <![endif]-->
</head>
<body>
    <table border="1">
        <tr style="background-color: #f0f0f0; font-weight: bold;">
            <td>Sana</td>
            <td>Mijoz</td>
            <td>Mijoz telefoni</td>
            <td>Do'kon</td>
            <td>Sotuvchi</td>
        </tr>
        <tr>
            <td>${new Date(sale.sale_date).toLocaleString('uz-UZ', { timeZone: 'Asia/Tashkent' })}</td>
            <td>${sale.customer_name || 'Noma\'lum'}</td>
            <td>${(sale.customer_phone && sale.customer_phone !== '+998 XX XXX XX XX') ? sale.customer_phone : ''}</td>
            <td>${sale.store_name || 'Noma\'lum'}</td>
            <td>${sale.seller_name || 'Admin'}</td>
        </tr>
        
        <tr><td colspan="5">&nbsp;</td></tr>
        
        <tr style="background-color: #f0f0f0; font-weight: bold;">
            <td>Mahsulot nomi</td>
            <td>Miqdor</td>
            <td>Birlik narxi ($)</td>
            <td>Jami narx ($)</td>
            <td>Joylashuv</td>
        </tr>`;
    
    // Mahsulotlar
    sale.items.forEach(item => {
        html += `
        <tr>
            <td>${item.product_name}</td>
            <td>${item.quantity}</td>
            <td>$${parseFloat(item.unit_price).toFixed(2)}</td>
            <td>$${parseFloat(item.total_price).toFixed(2)}</td>
            <td>${item.location_name || 'Noma\'lum'}</td>
        </tr>`;
    });
    
    html += `
        <tr><td colspan="5">&nbsp;</td></tr>
        <tr style="font-weight: bold;">
            <td></td>
            <td></td>
            <td></td>
            <td>Jami summa:</td>
            <td>$${parseFloat(sale.total_amount).toFixed(2)}</td>
        </tr>
    </table>
</body>
</html>`;
    
    return html;
}

// Chop etish funksiyasi - Mini X90 printer uchun
function printSaleReceipt() {
    if (!currentSaleData) {
        alert('‚ùå Savdo ma\'lumotlari topilmadi!');
        return;
    }
    
    console.log('Chop etish: Savdo ID', currentSaleData.id);
    generatePrintableReceipt(currentSaleData);
}

// Mini X90 printer uchun chek yaratish
function generatePrintableReceipt(sale) {
    const receiptWindow = window.open('', '_blank', 'width=400,height=600');
    
    const receiptHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Savdo Cheki #${sale.id}</title>
            <meta charset="utf-8">
            <style>
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                
                body {
                    font-family: 'Courier New', monospace;
                    font-size: 12px;
                    line-height: 1.3;
                    width: 58mm; /* Mini X90 kengligi */
                    margin: 0 auto;
                    padding: 5mm;
                    background: white;
                }
                
                .header {
                    text-align: center;
                    border-bottom: 1px dashed #000;
                    padding-bottom: 5mm;
                    margin-bottom: 3mm;
                }
                
                .shop-name {
                    font-size: 16px;
                    font-weight: bold;
                    margin-bottom: 2mm;
                }
                
                .receipt-info {
                    margin-bottom: 3mm;
                    font-size: 10px;
                }
                
                .items {
                    padding-bottom: 3mm;
                    margin-bottom: 3mm;
                }
                
                .item {
                    margin-bottom: 2mm;
                }
                
                .item-name {
                    font-weight: bold;
                    word-wrap: break-word;
                }
                
                .item-details {
                    display: flex;
                    justify-content: space-between;
                    font-size: 10px;
                }
                
                .totals {
                    margin-bottom: 3mm;
                }
                
                .total-line {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 1mm;
                }
                
                .total-line.main {
                    font-weight: bold;
                    font-size: 14px;
                    border-top: 1px solid #000;
                    padding-top: 2mm;
                }
                
                .footer {
                    text-align: center;
                    padding-top: 3mm;
                    font-size: 10px;
                }
                
                @page {
                    size: 58mm auto;
                    margin: 0;
                }
                
                @media print {
                    body {
                        width: 58mm;
                        font-size: 10px;
                    }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="shop-name">${sale.store_name || 'üö´ O\'chirilgan do\'kon'}</div>
                <div class="receipt-info">
                    <div>Chek #${sale.id}</div>
                    <div>${new Date(sale.sale_date).toLocaleString('uz-UZ', { timeZone: 'Asia/Tashkent' })}</div>
                    <div>Sotuvchi: ${sale.seller_name || 'Admin'}</div>
                    ${sale.seller_phone ? `<div>Tel: ${sale.seller_phone}</div>` : ''}
                    <div style="margin-top: 2mm; border-top: 1px dashed #ccc; padding-top: 2mm;">
                        <div><strong>Mijoz:</strong> ${sale.customer_name || 'ÔøΩ Noma\'lum'}</div>
                        ${sale.customer_phone && sale.customer_phone !== '+998 XX XXX XX XX' ? 
                            `<div><strong>Tel:</strong> ${sale.customer_phone}</div>` : ''}
                    </div>
                </div>
            </div>
            
            <div class="items">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px; border: 1.5px solid #000;">
                    <thead>
                        <tr style="border-bottom: 1.5px solid #000;">
                            <th style="text-align: left; padding: 2mm 2mm; font-weight: bold; border-right: 1.5px solid #000;">Mahsulot</th>
                            <th style="text-align: center; padding: 2mm 2mm; font-weight: bold; border-right: 1.5px solid #000;">Miqdor</th>
                            <th style="text-align: right; padding: 2mm 2mm; font-weight: bold;">Narx</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sale.items.map(item => `
                            <tr style="border-bottom: 1.5px solid #000;">
                                <td style="padding: 2mm 2mm; word-wrap: break-word; max-width: 25mm; border-right: 1.5px solid #000; font-weight: bold;">${item.product_name}</td>
                                <td style="padding: 2mm 2mm; text-align: center; border-right: 1.5px solid #000; font-weight: bold;">${item.quantity}</td>
                                <td style="padding: 2mm 2mm; text-align: right; font-weight: bold;">$${parseFloat(item.unit_price).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            
            <div class="totals">
                <div class="total-line main">
                    <span>Jami summa:</span>
                    <span>$${parseFloat(sale.total_amount).toFixed(2)}</span>
                </div>
            </div>
            
            <div class="footer">
                <div>Rahmat!</div>
                <div>Yana tashrif buyuring!</div>
            </div>
        </body>
        </html>
    `;
    
    receiptWindow.document.write(receiptHTML);
    receiptWindow.document.close();
    
    // Chop etish dialogini ochish
    setTimeout(() => {
        receiptWindow.print();
        // receiptWindow.close(); // Foydalanuvchi o'zi yopadi
    }, 500);
}

// To'lov turi matnini olish
function getPaymentMethodText(method) {
    switch (method) {
        case 'cash': return 'Naqd';
        case 'card': return 'Plastik karta';
        case 'transfer': return 'O\'tkazma';
        default: return method || 'Noma\'lum';
    }
}

// Global o'zgaruvchilar qidiruv va filtr uchun (o'zgaruvchilar yuqorida e'lon qilingan)
let allCustomers = []; // Barcha mijozlar ro'yxati
let selectedCustomerId = ''; // Tanlangan mijoz ID si

// Qidiruv va filtr funksiyalarini sozlash
function initializeSearchAndFilters() {
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearch');
    const dateFromFilter = document.getElementById('dateFromFilter');
    const dateToFilter = document.getElementById('dateToFilter');
    const customerFilter = document.getElementById('customerFilter');
    const locationFilter = document.getElementById('locationFilter');
    
    // Qidiruv input hodisalari
    searchInput.addEventListener('input', function() {
        updateClearButtonVisibility();
        applySearchAndFilters();
    });
    
    // Barcha filtrlarni tozalash
    clearSearchBtn.addEventListener('click', function() {
        searchInput.value = '';
        dateFromFilter.value = '';
        dateToFilter.value = '';
        customerFilter.value = '';
        locationFilter.value = '';
        selectedCustomerId = '';
        this.style.display = 'none';
        // Filtrlar tozalanganda API'dan yangi ma'lumotlar yuklash (bugungi kun statistikasi)
        currentPage = 1;
        loadSalesHistory(currentPage);
    });
    
    // Filtr elementlariga avtomatik hodisalar qo'shish
    dateFromFilter.addEventListener('change', function() {
        updateClearButtonVisibility();
        // Sana filtri o'zgarganda API'dan yangi ma'lumotlar yuklash (statistika yangilansin)
        currentPage = 1;
        loadSalesHistory(currentPage);
    });
    dateToFilter.addEventListener('change', function() {
        updateClearButtonVisibility();
        // Sana filtri o'zgarganda API'dan yangi ma'lumotlar yuklash (statistika yangilansin)
        currentPage = 1;
        loadSalesHistory(currentPage);
    });
    
    // Mijoz qidiruv funksiyasini sozlash
    initializeCustomerSearch();
    
    // Joylashuv filtr change hodisasi
    locationFilter.addEventListener('change', function() {
        updateClearButtonVisibility();
        applySearchAndFilters();
    });
    
    // Mijozlar ro'yxatini yuklash
    loadCustomersForFilter();
    
    // Joylashuvlar ro'yxatini yuklash (agar ma'lumotlar mavjud bo'lsa)
    if (allSalesData && allSalesData.length > 0) {
        loadLocationsForFilter();
    }
}

// Tozalash tugmasining ko'rinishini yangilash
function updateClearButtonVisibility() {
    const searchInput = document.getElementById('searchInput');
    const dateFromFilter = document.getElementById('dateFromFilter');
    const dateToFilter = document.getElementById('dateToFilter');
    const customerFilter = document.getElementById('customerFilter');
    const clearSearchBtn = document.getElementById('clearSearch');
    
    const locationFilter = document.getElementById('locationFilter');
    
    const hasFilters = searchInput.value.trim() || 
                      dateFromFilter.value || 
                      dateToFilter.value || 
                      selectedCustomerId ||
                      locationFilter.value;
    
    clearSearchBtn.style.display = hasFilters ? 'block' : 'none';
}

// Mijozlar ro'yxatini yuklash
async function loadCustomersForFilter() {
    try {
        const response = await fetch('/api/customers');
        const customers = await response.json();
        allCustomers = customers;
        
        // Dropdown ni yangilash
        updateCustomerDropdown();
    } catch (error) {
        console.error('Mijozlarni yuklashda xatolik:', error);
    }
}

// Joylashuvlar ro'yxatini yuklash (barcha do'konlar va omborlar)
async function loadLocationsForFilter() {
    try {
        console.log('üìç ===== JOYLASHUVLAR YUKLASH BOSHLANDI =====');
        
        // Backend'dan foydalanuvchi ruxsatlari bo'yicha joylashuvlarni olish
        console.log('üîÑ API so\'rovlari yuborilmoqda...');
        const [storesResponse, warehousesResponse] = await Promise.all([
            fetch('/api/stores'),  // Foydalanuvchi huquqlari bo'yicha filterlangan
            fetch('/api/warehouses')  // Foydalanuvchi huquqlari bo'yicha filterlangan
        ]);
        
        console.log('‚úÖ API javoblari olindi:', {
            storesStatus: storesResponse.status,
            storesOk: storesResponse.ok,
            warehousesStatus: warehousesResponse.status,
            warehousesOk: warehousesResponse.ok
        });
        
        // Response'larni tekshirish
        if (!storesResponse.ok) {
            console.error('‚ùå Stores API xatosi:', storesResponse.status, storesResponse.statusText);
        }
        if (!warehousesResponse.ok) {
            console.error('‚ùå Warehouses API xatosi:', warehousesResponse.status, warehousesResponse.statusText);
        }
        
        const stores = await storesResponse.json();
        const warehouses = await warehousesResponse.json();
        
        console.log('üè™ Do\'konlar (raw data):', stores);
        console.log('üè™ Do\'konlar soni:', stores?.length || 0);
        console.log('üè≠ Omborlar (raw data):', warehouses);
        console.log('üè≠ Omborlar soni:', warehouses?.length || 0);
        
        // Do'konlar va omborlar ma'lumotlarini global o'zgaruvchilarda saqlash
        window.storesData = stores;
        window.warehousesData = warehouses;
        
        // Select elementini yangilash
        console.log('üîç locationFilter elementini qidirish...');
        const locationSelect = document.getElementById('locationFilter');
        
        if (!locationSelect) {
            console.error('‚ùå locationFilter elementi topilmadi!');
            console.log('üîç Mavjud elementlar:', document.querySelectorAll('select'));
            return;
        }
        
        console.log('‚úÖ locationFilter elementi topildi:', locationSelect);
        console.log('üîç Hozirgi select tarkibi:', locationSelect.innerHTML);
        
        // Avvalgi optionlarni tozalash
        locationSelect.innerHTML = '<option value="">Barcha joylashuvlar</option>';
        console.log('üßπ Select tozalandi, yangi tarkib:', locationSelect.innerHTML);
        
        // Do'konlarni qo'shish
        console.log('üè™ Do\'konlarni qo\'shish jarayoni...');
        if (stores && stores.length > 0) {
            console.log(`‚úÖ ${stores.length} ta do'kon topildi`);
            const storeGroup = document.createElement('optgroup');
            storeGroup.label = 'üè™ Do\'konlar';
            
            stores.forEach((store, index) => {
                console.log(`üè™ Do'kon ${index + 1}:`, {
                    id: store.id,
                    name: store.name,
                    address: store.address,
                    manager_name: store.manager_name
                });
                
                const option = document.createElement('option');
                option.value = `store_${store.id}`;
                option.textContent = `${store.name} (Do'kon)`;
                storeGroup.appendChild(option);
                
                console.log(`   ‚ûï Option yaratildi: "${option.textContent}" = "${option.value}"`);
            });
            
            console.log(`üè™ StoreGroup yaratildi, children: ${storeGroup.children.length}`);
            if (storeGroup.children.length > 0) {
                locationSelect.appendChild(storeGroup);
                console.log('‚úÖ Do\'konlar guruhi select\'ga qo\'shildi');
            } else {
                console.warn('‚ö†Ô∏è StoreGroup bo\'sh, qo\'shilmadi');
            }
        } else {
            console.warn('‚ö†Ô∏è Do\'konlar yo\'q yoki bo\'sh array');
        }
        
        // Omborlarni qo'shish
        console.log('üè≠ Omborlarni qo\'shish jarayoni...');
        if (warehouses && warehouses.length > 0) {
            console.log(`‚úÖ ${warehouses.length} ta ombor topildi`);
            const warehouseGroup = document.createElement('optgroup');
            warehouseGroup.label = 'üè≠ Omborlar';
            
            warehouses.forEach((warehouse, index) => {
                console.log(`üè≠ Ombor ${index + 1}:`, {
                    id: warehouse.id,
                    name: warehouse.name,
                    address: warehouse.address,
                    manager_name: warehouse.manager_name
                });
                
                const option = document.createElement('option');
                option.value = `warehouse_${warehouse.id}`;
                option.textContent = `${warehouse.name} (Ombor)`;
                warehouseGroup.appendChild(option);
                
                console.log(`   ‚ûï Option yaratildi: "${option.textContent}" = "${option.value}"`);
            });
            
            console.log(`üè≠ WarehouseGroup yaratildi, children: ${warehouseGroup.children.length}`);
            locationSelect.appendChild(warehouseGroup);
            console.log('‚úÖ Omborlar guruhi select\'ga qo\'shildi');
        } else {
            console.warn('‚ö†Ô∏è Omborlar yo\'q yoki bo\'sh array');
        }
        
        // Final natija
        console.log('üîç FINAL SELECT TARKIBI:');
        console.log('   innerHTML:', locationSelect.innerHTML);
        console.log('   Children soni:', locationSelect.children.length);
        console.log('   Options soni:', locationSelect.querySelectorAll('option').length);
        console.log('üìç ===== JOYLASHUVLAR YUKLASH TUGADI =====');
        
    } catch (error) {
        console.error('Joylashuvlarni yuklashda xatolik:', error);
        
        // Xato holatida eski mantiqni ishlatish
        console.log('‚ö†Ô∏è Backend xatosi, savdo ma\'lumotlaridan joylashuvlar olinadi...');
        if (allSalesData && allSalesData.length > 0) {
            const uniqueLocations = [...new Set(
                allSalesData.flatMap(sale => 
                    sale.items.map(item => item.location_name)
                ).filter(location => location && location.trim())
            )].sort();
            
            const locationSelect = document.getElementById('locationFilter');
            if (locationSelect) {
                locationSelect.innerHTML = '<option value="">Barcha joylashuvlar</option>';
                uniqueLocations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location;
                    option.textContent = location;
                    locationSelect.appendChild(option);
                });
            }
        }
    }
}

// Mijoz qidiruv funksiyasini sozlash
function initializeCustomerSearch() {
    const customerInput = document.getElementById('customerFilter');
    const customerDropdown = document.getElementById('customerDropdown');
    
    // Input focus hodisasi
    customerInput.addEventListener('focus', function() {
        updateCustomerDropdown();
        customerDropdown.style.display = 'block';
    });
    
    // Input qidiruv hodisasi
    customerInput.addEventListener('input', function() {
        updateCustomerDropdown();
        customerDropdown.style.display = 'block';
        updateClearButtonVisibility();
        applySearchAndFilters();
    });
    
    // Tashqi joyga bosganda yashirish
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.customer-search-container')) {
            customerDropdown.style.display = 'none';
        }
    });
}

// Mijoz dropdown ni yangilash
function updateCustomerDropdown() {
    const customerInput = document.getElementById('customerFilter');
    const customerDropdown = document.getElementById('customerDropdown');
    const searchTerm = customerInput.value.toLowerCase().trim();
    
    // Filtrlangan mijozlar
    const filteredCustomers = allCustomers.filter(customer => {
        const name = (customer.name || '').toLowerCase();
        const phone = (customer.phone || '').toLowerCase();
        return name.includes(searchTerm) || phone.includes(searchTerm);
    });
    
    // Dropdown ni tozalash
    customerDropdown.innerHTML = '';
    
    // "Barcha mijozlar" option
    const allOption = document.createElement('div');
    allOption.className = 'customer-option';
    allOption.dataset.value = '';
    allOption.textContent = 'Barcha mijozlar';
    allOption.addEventListener('click', function() {
        selectCustomer('', 'Barcha mijozlar', '');
    });
    customerDropdown.appendChild(allOption);
    
    // Mijozlar ro'yxati
    filteredCustomers.forEach(customer => {
        const option = document.createElement('div');
        option.className = 'customer-option';
        option.dataset.value = customer.id;
        option.textContent = customer.name + (customer.phone ? ' (' + customer.phone + ')' : '');
        
        if (customer.id == selectedCustomerId) {
            option.classList.add('selected');
        }
        
        option.addEventListener('click', function() {
            selectCustomer(customer.id, customer.name, customer.phone);
        });
        customerDropdown.appendChild(option);
    });
}

// Mijozni tanlash
function selectCustomer(customerId, customerName, customerPhone) {
    const customerInput = document.getElementById('customerFilter');
    const customerDropdown = document.getElementById('customerDropdown');
    
    selectedCustomerId = customerId;
    if (customerId) {
        // Mijoz nomi va telefon raqamini ko'rsatish
        const displayText = customerName + (customerPhone ? ' (' + customerPhone + ')' : '');
        customerInput.value = displayText;
    } else {
        customerInput.value = '';
    }
    customerDropdown.style.display = 'none';
    
    updateClearButtonVisibility();
    applySearchAndFilters();
}



// Qidiruv va filtrlarni qo'llash - serverdan qayta yuklash
function applySearchAndFilters() {
    console.log('üîç Filtrlar qo\'llanmoqda - serverdan ma\'lumot yuklanadi');
    
    // Birinchi sahifadan boshlab serverdan filtrlab olish
    currentPage = 1;
    loadSalesHistory(currentPage);
}

// Filtrlangan ma'lumotlarni ko'rsatish
function displayFilteredData() {
    const data = {
        sales: filteredSalesData,
        statistics: calculateFilteredStatistics(),
        isFiltered: true
    };
    displaySalesData(data);
    
    // Natijalar matnini ko'rsatish
    updateResultsInfo();
}

// Natijalar ma'lumotini yangilash
function updateResultsInfo() {
    const resultsInfo = document.getElementById('resultsInfo');
    const resultsText = document.getElementById('resultsText');
    
    const totalResults = allSalesData.length;
    const filteredResults = filteredSalesData.length;
    
    if (filteredResults < totalResults) {
        resultsText.textContent = `${filteredResults} ta natija topildi`;
        resultsInfo.style.display = 'block';
    } else {
        resultsInfo.style.display = 'none';
    }
}

// Filtrlangan statistikalarni hisoblash
function calculateFilteredStatistics() {
    if (!filteredSalesData.length) {
        return {
            total_sales: 0,
            total_revenue: 0,
            total_profit: 0
        };
    }
    
    const totalSales = filteredSalesData.length;
    const totalRevenue = filteredSalesData.reduce((sum, sale) => sum + parseFloat(sale.total_amount || 0), 0);
    const totalProfit = filteredSalesData.reduce((sum, sale) => sum + parseFloat(sale.total_profit || 0), 0);
    
    return {
        total_sales: totalSales,
        total_revenue: totalRevenue,
        total_profit: totalProfit
    };
}

// Qidiruv natijalarini highlight qilish funksiyasi - faqat mahsulot ustunida
function highlightSearchResults() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    
    // Avval barcha highlight'larni tozalash
    document.querySelectorAll('#salesTableBody tr').forEach(row => {
        // Barcha hujayralardagi highlight'larni tozalash
        const cells = row.querySelectorAll('td');
        cells.forEach(cell => {
            // Agar highlight span'lar bor bo'lsa, ularni oddiy text bilan almashtirish
            const spans = cell.querySelectorAll('.product-highlight');
            spans.forEach(span => {
                span.outerHTML = span.textContent;
            });
        });
    });
    
    if (!searchTerm) {
        return;
    }
    
    // Faqat mahsulot ustunidagi qidiruv so'zini highlight qilish
    document.querySelectorAll('#salesTableBody tr').forEach(row => {
        // Har bir qatorda mahsulot hujayrasini topish
        // Birinchi qator: 5-ustun, qolgan qatorlar: 2-ustun
        let productCell = null;
        
        // Agar qatorda 8+ ustun bo'lsa (to'liq qator), mahsulot 5-ustunda
        const cells = row.querySelectorAll('td');
        if (cells.length >= 8) {
            productCell = row.querySelector('td:nth-child(5)');
        } 
        // Agar qatorda kam ustun bo'lsa (qisqa qator), mahsulot 2-ustunda  
        else if (cells.length >= 2) {
            productCell = row.querySelector('td:nth-child(2)');
        }
        
        if (productCell) {
            highlightTextInCell(productCell, searchTerm);
        }
    });
}

// Hujayradagi matnni highlight qilish yordamchi funksiyasi
function highlightTextInCell(cell, searchTerm) {
    const cellText = cell.textContent.toLowerCase();
    
    if (cellText.includes(searchTerm)) {
        const originalHTML = cell.innerHTML;
        const regex = new RegExp(`(${searchTerm})`, 'gi');
        const highlightedHTML = originalHTML.replace(regex, '<span class="product-highlight">$1</span>');
        cell.innerHTML = highlightedHTML;
    }
}

// Ombor matnlarini sariq fon bilan ajratish funksiyasi
function highlightWarehouseLocations() {
    const locationCells = document.querySelectorAll('.group-location');
    
    locationCells.forEach(cell => {
        const cellText = cell.textContent.toLowerCase();
        
        // Ombor, warehouse va shunga o'xshash so'zlarni tekshirish
        if (cellText.includes('ombor') || cellText.includes('warehouse') || 
            cellText.includes('—Å–∫–ª–∞–¥') || cellText.includes('–æ–º–±–æ—Ä')) {
            cell.classList.add('warehouse-location');
        }
    });
}

// Compact view toggle funksiyasi
function initializeCompactView() {
    console.log('üöÄ initializeCompactView ishga tushdi');
    
    const compactToggle = document.getElementById('compactViewToggle');
    const tableContainer = document.querySelector('.table-container');
    
    console.log('üîç compactToggle element:', compactToggle);
    console.log('üîç tableContainer element:', tableContainer);
    
    if (!compactToggle) {
        console.error('‚ùå compactViewToggle elementi topilmadi!');
        return;
    }
    
    if (!tableContainer) {
        console.error('‚ùå table-container elementi topilmadi!');
        return;
    }

    // Saqlangan holatni yuklash
    const savedCompactState = localStorage.getItem('compactViewEnabled');
    const isCompactEnabled = savedCompactState === 'true';
    
    console.log('üíæ Saqlangan compact holati:', savedCompactState);
    
    // Toggle holatini o'rnatish
    compactToggle.checked = isCompactEnabled;
    
    // Agar compact mode yoqilgan bo'lsa, darhol qo'llash
    if (isCompactEnabled) {
        tableContainer.classList.add('compact-mode');
        console.log('‚úÖ Saqlangan compact mode yoqildi');
    }
    
    compactToggle.addEventListener('change', function() {
        console.log('üîÑ Compact view toggle:', this.checked);
        
        // Holatni localStorage da saqlash
        localStorage.setItem('compactViewEnabled', this.checked.toString());
        console.log('üíæ Compact holati saqlandi:', this.checked);
        
        if (this.checked) {
            tableContainer.classList.add('compact-mode');
            console.log('‚úÖ Compact mode yoqildi');
            // Ma'lumotlarni yangi savdolar birinchi bo'lishi uchun sortlash
            if (filteredSalesData && filteredSalesData.length > 0) {
                filteredSalesData = [...filteredSalesData].sort((a, b) => {
                    const dateA = new Date(a.sale_date || a.created_at || a.date);
                    const dateB = new Date(b.sale_date || b.created_at || b.date);
                    return dateB - dateA; // DESC tartib
                });
                console.log('üîÑ Compact mode uchun ma\'lumotlar sortlandi');
            }
            // Jadval ma'lumotlarini qayta yuklash compact formatda
            updateTableForCompactView();
        } else {
            tableContainer.classList.remove('compact-mode');
            console.log('‚ùå Compact mode o\'chirildi');
            // Oddiy formatda qayta yuklash - hozirgi filtrlangan ma'lumotlarni ishlatish
            if (filteredSalesData && filteredSalesData.length > 0) {
                displaySalesData({
                    sales: filteredSalesData,
                    statistics: getCurrentStats(),
                    isFiltered: true
                });
            } else {
                loadSalesHistory();
            }
        }
    });
}

// Compact view uchun jadval ma'lumotlarini yangilash
function updateTableForCompactView() {
    console.log('üîÑ updateTableForCompactView ishga tushdi');
    console.log('üìä filteredSalesData:', filteredSalesData);
    
    // Hozirgi ma'lumotlardan foydalanib compact formatda ko'rsatish
    if (filteredSalesData && filteredSalesData.length > 0) {
        // Original ma'lumotlarni o'zgartirmaslik uchun nusxa yaratish
        const sortedData = [...filteredSalesData].sort((a, b) => {
            // Sana formatini tekshirish va to'g'ri sort qilish
            const dateA = new Date(a.sale_date || a.created_at || a.date);
            const dateB = new Date(b.sale_date || b.created_at || b.date);
            
            console.log('üîÑ Sortlash:', {
                a_date: a.sale_date, 
                b_date: b.sale_date,
                a_parsed: dateA,
                b_parsed: dateB,
                comparison: dateB - dateA
            });
            
            // Agar sanalar noto'g'ri bo'lsa, ID bo'yicha sort qilish
            if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) {
                console.log('‚ùå Noto\'g\'ri sana, ID bo\'yicha sortlash');
                return (b.id || 0) - (a.id || 0); // Yangi ID'lar birinchi
            }
            
            return dateB - dateA; // Yangi savdolar birinchi (DESC)
        });
        
        console.log('‚úÖ Ma\'lumotlar sortlandi:', sortedData.map(s => s.sale_date).slice(0, 5));
        
        // Sortlangan ma'lumotlardan foydalanish
        filteredSalesData = sortedData;
        const tbody = document.getElementById('salesTableBody');
        tbody.innerHTML = '';
        
        // Har bir savdo uchun bitta qator (savdo ID bo'yicha guruhlash)
        const salesGroups = {};
        
        console.log('üîç filteredSalesData sample:', filteredSalesData[0]);
        
        filteredSalesData.forEach(sale => {
            console.log('üîç Sale obyekti:', {
                id: sale.id,
                items: sale.items,
                items_count: sale.items ? sale.items.length : 'items yo\'q'
            });
            
            const saleId = sale.id;
            if (!salesGroups[saleId]) {
                salesGroups[saleId] = [];
            }
            salesGroups[saleId].push(sale);
        });
        
        // Har bir savdo guruhi uchun bitta qator yaratish
        console.log('üî¢ Savdo guruhlari soni:', Object.values(salesGroups).length);
        
        Object.values(salesGroups).forEach((items, index) => {
            if (items.length > 0) {
                console.log(`üìù ${index + 1}-qator yaratilmoqda:`, items[0]);
                
                const firstItem = items[0];
                console.log('üîç firstItem tafsilotlari:', {
                    sale_date: firstItem.sale_date,
                    location_name: firstItem.location_name,
                    store_name: firstItem.store_name,
                    customer_name: firstItem.customer_name,
                    items: firstItem.items,
                    items_length: firstItem.items ? firstItem.items.length : 'items yo\'q'
                });
                
                const totalAmount = parseFloat(firstItem.total_amount || 0);
                const totalProfit = parseFloat(firstItem.total_profit || 0);
                const profitClass = totalProfit > 0 ? 'profit-positive' : totalProfit < 0 ? 'profit-negative' : 'profit-zero';
                
                console.log('üîç DEBUG: Row yaratilmoqda, userRole =', userRole);
                console.log('üîç DEBUG: userRole type =', typeof userRole);
                console.log('üîç DEBUG: userRole length =', userRole.length);
                console.log('üîç DEBUG: userRole === "sotuvchi"? =', userRole === 'sotuvchi');
                console.log('üîç DEBUG: Profit cell will be created? =', userRole !== 'sotuvchi');
                
                const row = document.createElement('tr');
                row.className = 'compact-row';
                
                // Faqat kerakli ustunlar bilan HTML yaratish
                row.innerHTML = `
                    <td class="col-datetime">
                        <div class="sale-date">${formatDate(firstItem.sale_date)}</div>
                        <div class="sale-time">${formatTime(firstItem.sale_date)}</div>
                    </td>
                    <td class="col-customer">
                        <div class="customer-name">${firstItem.customer_name || 'Noma\'lum'}</div>
                        ${firstItem.customer_phone ? `<div class="customer-phone">${firstItem.customer_phone}</div>` : ''}
                    </td>
                    <td class="col-seller">${firstItem.seller_name || 'Admin'}</td>
                    <td class="col-location">${firstItem.items && firstItem.items.length > 0 ? firstItem.items[0].location_name : (firstItem.store_name || 'üö´ O\'chirilgan do\'kon')}</td>
                    <td class="col-product compact-hide" style="display: none;">${firstItem.items ? firstItem.items.length : 0} ta mahsulot</td>
                    <td class="col-quantity compact-hide" style="display: none;"></td>
                    <td class="col-price compact-hide" style="display: none;"></td>
                    <td class="col-subtotal compact-hide" style="display: none;"></td>
                    <td class="col-total">${formatPrice(totalAmount, firstItem.currency_rate)}</td>
                    ${userRole === 'sotuvchi' ? '' : `<td class="col-profit ${profitClass}">${formatPrice(totalProfit, firstItem.currency_rate)}</td>`}
                    <td class="col-actions">
                        <button class="btn-action btn-view" onclick="viewSaleDetails(${firstItem.id})" title="Ko'rish">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-action btn-edit" onclick="editSaleGroup(${firstItem.id})" title="Tahrirlash">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-action btn-delete" onclick="deleteGroup(${firstItem.id})" title="O'chirish">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
                
                // Sotuvchi roli uchun foyda ustunlarini yashirish
                if (userRole === 'sotuvchi') {
                    const profitCells = row.querySelectorAll('.col-profit');
                    profitCells.forEach(cell => {
                        cell.style.display = 'none';
                    });
                }
            }
        });
        
        // Highlight funksiyalarini qayta ishga tushirish
        highlightSearchResults();
        highlightWarehouseLocations();
    } else {
        // Agar ma'lumotlar yo'q bo'lsa
        const tbody = document.getElementById('salesTableBody');
        tbody.innerHTML = '<tr><td colspan="7" class="loading">Compact view uchun ma\'lumotlar topilmadi</td></tr>';
    }
}

// Hozirgi statistikalarni olish funksiyasi
function getCurrentStats() {
    const totalSales = filteredSalesData.length;
    const totalRevenue = filteredSalesData.reduce((sum, sale) => sum + parseFloat(sale.total_amount || 0), 0);
    const totalProfit = filteredSalesData.reduce((sum, sale) => sum + parseFloat(sale.total_profit || 0), 0);
    
    return {
        total_sales: totalSales,
        total_revenue: totalRevenue,
        total_profit: totalProfit
    };
}

// Sana formatlash funksiyasi
function formatDate(dateString) {
    console.log('üìÖ formatDate chaqirildi:', dateString, typeof dateString);
    if (!dateString) {
        console.log('‚ùå dateString bo\'sh');
        return 'Noma\'lum';
    }
    
    try {
        const date = new Date(dateString);
        console.log('üìÖ Date object yaratildi:', date, 'Valid:', !isNaN(date.getTime()));
        if (isNaN(date.getTime())) {
            console.log('‚ùå Noto\'g\'ri sana');
            return 'Noma\'lum';
        }
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        const result = `${day}.${month}.${year}`;
        console.log('‚úÖ formatDate natijasi:', {
            input: dateString,
            parsed: date,
            day: day,
            month: month,
            year: year,
            result: result
        });
        return result;
    } catch (e) {
        console.log('‚ùå formatDate xatosi:', e);
        return 'Noma\'lum';
    }
}

// Vaqt formatlash funksiyasi
function formatTime(dateString) {
    console.log('üïê formatTime chaqirildi:', dateString);
    if (!dateString) {
        console.log('‚ùå dateString bo\'sh (time)');
        return '';
    }
    
    try {
        const date = new Date(dateString);
        console.log('üïê Date object yaratildi (time):', date);
        if (isNaN(date.getTime())) {
            console.log('‚ùå Noto\'g\'ri sana (time)');
            return '';
        }
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        const result = `${hours}:${minutes}`;
        console.log('‚úÖ formatTime natijasi:', result);
        return result;
    } catch (e) {
        console.log('‚ùå formatTime xatosi:', e);
        return '';
    }
}

// Valyuta kursini olish
async function loadCurrencyRate() {
    try {
        console.log('üîÑ Sales History: valyuta kursini yuklayapman...');
        const response = await fetch('/api/currency-rate');
        const data = await response.json();
        
        console.log('üìä Sales History API javob:', data);
        
        if (data.success && data.rate) {
            const oldRate = USD_TO_UZS_RATE;
            USD_TO_UZS_RATE = data.rate.rate;
            console.log(`‚úÖ Sales History: ${oldRate} ‚Üí ${USD_TO_UZS_RATE} UZS`);
        } else {
            console.error('‚ùå Sales History: API dan xato javob:', data);
        }
    } catch (error) {
        console.error('‚ùå Sales History: valyuta yuklashda xatolik:', error);
    }
}

// Header dan valyuta kursi yangilanganda
window.addEventListener('currencyRateUpdated', function(event) {
    USD_TO_UZS_RATE = event.detail.newRate;
    console.log(`üîÑ Sales History - Valyuta kursi yangilandi: 1 USD = ${USD_TO_UZS_RATE} UZS`);
    
    // Sahifani qayta yuklash (narxlar yangilansin)
    loadSalesHistory();
});

</script>
{% endblock %}
